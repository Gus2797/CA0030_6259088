/* --------------------------------------------------------------------
Fecha    :25/10/04 6:21  ( dd-mm-aa )
Elaboró  :Joel Armando Arana Garcia
Solicitó :Lic. Jos‚ G. Mendoza
Actividad:Captura de Abonos
--------------------------------------------------------------------
// DlgCapturarAbono.cpp: archivo de implementación
//
--------------------------------------------------------------------
Fecha    : Lunes 16/05/2016 5:15 p.m.
Elaboró  : César Felipe Zazueta Quintero.
Peticion : 10918. Se puso encima de la revision 81670.
Actividad: Modificar el metodo checarVigenciaSeguro
--------------------------------------------------------------------
Fecha    : martes, 22 de Mayo 2018
Elaboró  : Arturo Gonzalez Espinoza
Peticion : 19180-Actualizacion del sistema para recibir nuevos productos quebrantados por BanCoppel
Actividad: Utilizar metodo VerificarCuentaBcpl para descripcion de cuenta BCPL.
--------------------------------------------------------------------
Fecha    : martes, 07 de Agosto 2018
Elaboró  : Santos Jonatham Celis Lopez
Peticion : 8590  Actualizacion de bonificaciones diarias para muebles.
Actividad: Se crearon metodos nuevos guardarCertificacionAbonos(int i),
obtenerFechaPrimerAbono(int i);
-------------------------------------------------------------------- */

#include "stdafx.h"
#include "DlgCapturarAbono.h"
#include "CFechaCoppel.hpp"
#include "CDatosConvenio.hpp"
#include "CConsultarGnVigenciaPromocion.hpp"
#include <ugctrl.h>
#include "C_Archiv.hpp"
#include "ConsultarMesAnio.hpp"
#include "DlgCapturarConvenio.h"
#include "CAdiionalc.hpp"
#include "CConsultarSituacionCrCliente.hpp"
#include "CObtenerDatosTdBeneficiariosClub.hpp"
#include "CNombreColoniaCrZonas.hpp"
#include "CCiudadColoniaCrCliente.hpp"
#include "CChecarVigenciaSeguro.hpp"
#include "CChecarCorteCaja.hpp"
#include "CobtenFechaAfiliacion.hpp"

#include "CChecarEncuesta2.hpp"
#include "CConsultarDatosGnDominio3.hpp"
#include "CBuscarClienteEncuestado.hpp"
#include "CObtenerFechaSaldaConCrCropa.hpp"
#include "CConsultarClaveConyugalCrSeguros.hpp"
#include "CConsultarNomPuntFechaCrCliente.hpp"
#include "CConsultarTipoSeguroCrSeguros.hpp"
#include "CObtenerDatosCliente.hpp"
#include "CConsultarCalle.hpp"
#include "CConsultarZonaCliente.hpp"

#include "CTmpCaGrabarAbono.hpp"
#include "CInsertarGnTira.hpp"
#include "CInsertarHoraMensaje.hpp"

//clases de la tablas temporales
#include "CGrabarTmpCaCarmovEtp2.hpp"
#include "CGrabarTmpCaEficienciaCajeras.hpp"
#include "CGrabarTmpCaMovimientos.hpp"
#include "CGrabarAbonoTmpCaCarmov04.hpp"
#include "CGrabarTmpAbonoInteresCaCarmov05.hpp"
#include "CGrabarTmpConvenioCaCarmov03.hpp"
#include "CGrabarTmpBonificacionCaCarmov04.hpp"
#include "CInsertarTmpBeneficiariosCaCarmov01.hpp"
#include "CGrabarTmpSeguroCaCarmov01.hpp"
#include "CGrabarTmpCrCmuebles.hpp"
#include "CGrabarTmpCrCropa.hpp"
#include "CGrabarTmpCrPrestamos.hpp"
#include "CGrabarTmpCrSeguros.hpp"
#include "CObtenerDatosTmpCaCarmovServicio.hpp"
#include "CObtenerClaveNoOfrecer.hpp"
#include "CCrHuellas.hpp"
#include "CConsultarCliente.hpp"
#include "CGrabarCrCarmovX.hpp"

#include "CConsultarCaEncuestaEdoCta.hpp"
//hasta aqui

//joel cambio tablas temporales
#include "CGrabarTmpAbonoCrPrestamosFija.hpp"
#include "CGrabarTmpAbonoCrCropaFija02.hpp"
#include "CGrabarTmpAbonoCrCmueblesFija02.hpp"
#include "CGrabarTmpAbonoCrRevolvente.hpp"
#include "CTmpAbonoCrCmueblesPlanFija.hpp"
#include "CGrabarTmpAbonoCrTaireFija02.hpp"
//hasta aqui
#include "CConsultarCaTotalEncuesta.hpp"
#include "sysCapturarAbono.h"
#include "CGrabarPagoServicio.hpp"
#include "password.hpp"
#include "C_Menu.hpp"
#include "wtienda.hpp"
#include "folios.hpp"
#include "process.h"
#include "CObtenerReciboJapac.hpp"
#include "CConsultarCrSegurosClub.hpp"
#include "flags.hpp"

//Para el Seguro Adicional
#include "CGrabarTmpCaCarmovSeguro.hpp"
#include "CGrabarTmpAbonoCrSegurosFija01.hpp"
#include "CConsultarCrSegurosClubAdicional.hpp"
#include "CConsultarCrSegurosFechaMesDiaVence.hpp"

#include "CObtenerMensajePromocionDirecta.hpp"
#include "CConsultarDatosCliente.hpp"
#include "CConsultarPolizaVigencia.hpp"

//Para el ProgC *Coppel
#include "CConsultarDescripcionClub.hpp"
#include "CConsultarEdadesClub.hpp"
#include "CConsultarPrecioSeguroClub.hpp"
#include "CConsultarDatosSeguroAdicional.hpp"
#include "CConsultarMensajeSeguro.hpp"
#include "CConsultarBeneficiario.hpp"
#include "CConsultarFoliosSeguro.hpp"

////para SMS
#include "CActualizarEmpleadoMovSMS.hpp"
#include "CCEliminarMensajeSMS.hpp"
//#include "CConsultarClienteSMS.hpp"

//SitEsp
#include "CConsultaSituacionCausa.hpp"
#include "uh_ctrl.h"
#include "HTTP_c.h"
#include <include\ArduinoJson.h>

//Encuestas para Afore
#include "CParametros.hpp"
#include "CDescripcion.hpp"

#include "CObtenerSituacionReglaCliente.hpp"

#include "CConsultarWS.hpp"
#include "CConsultarCuentaDomiciliada.hpp"
//clases para Club de Proteccion Familiar
#include "cConsultarPolizasSegurosDesactualizados.hpp"
#include "cEjecutarFuncionPgSQL.hpp"
#include "COrigenSeguro.hpp"

// Tasa 0
#include "CGrabarTmpAbonoCrCropaDetalle.hpp"
#include "CObtenerDetalleAbonoRopa.hpp"

//Clase para prestamos a clientes nuevos
#include "CConsultarCandidatoPrestamoCN.hpp"
// Reestructura de credito
#include "DlgReestructuracion.h"
#include "CReestructuracion.h"
#include "flags.hpp"
#include "Tareas.hpp" //LMAXW.LIB 15750
#include "CConsultarTokenSSO.h" //37569

#include "CObtenerDatosCacarmovTemporal.hpp"
#include "CConsultarBeneficiariosSeguroTemp.hpp"
#include <string>
#include "CargaDllCSharp.h"
#include "CConsultarOrigen.hpp"
#include "CargarDllCS.h"
#include "gnwPlanDeLealtad.h"
#include "CConsultarRegion.hpp" //2161.1
#include "json\src\json.h"


//NUEVA CLASE PARA GUARDAR CLIENTES NO OFRECER CLUB PROTECCION FAMILIAR PET - 15922
#include "CInsertarCteNoOfrecer.hpp"

//29504
#include "CConsultarMensajesCoppelMax.h"

//Seguro de motos 36743
#include "CConsumoAPICuentasSeguros.h"
#include "CCuentasSeguros.h"

//TODO JOHN
#include "CalculoMoras.h"
#include "CConsultaFacturaSesionTemp.hpp"
#include "CConsultatdchequesesion.hpp"


#ifdef _DEBUG
#define new DEBUG_NEW
#endif
struct DatosConvenioCliente
{
	int     iFacturaConv,
		iAbonoVencidoFinal,
		iAbonoFactura,
		iAbonoConVencidoFinal,
		iImporteFinalConv,
		iAbonoBaseCta,
		iAbonoPago,
		iAbonoSegFactura,
		iAbonoSegVencidoFinal,
		iAbonoInteFactura,
		iAbonoInteVencidoFinal;

	short   iGanode,
		iTipoCtaConvenio,
		iEliminarConvenio;
	char    cTipomovimientoConv,
		cClave,
		cPuntualidadcteConv,
		cAbonoClave,
		cAbonoTipoMovi,
		cAbonoPuntualidad,
		CAbonosubtipoconvenio,
		cAbonoSegClave,
		cAbonoSegTipoMovi,
		cAbonoSegPuntualidad,
		cAbonoInteClave,
		cAbonoInteTipoMovi,
		cAbonoIntePuntualidad;
};

DatosConvenioCliente EDatosConvenioCliente[100];

void separarConyuge(char *cNombreConyuge, char *cApPaternoc, char *cApMaternoc, char *cNombrec);
static int PantallaMenuConyugal(void);
static int PantallaMenuBeneficiarios(void);
int ChecarCantidadSeguros(int iTipo, long lCliente, long lFolio);

//Metodo y variables para el consumo del servicio de club de proteccion Mercadotecnia360
static CString ConsultaPuertoMerca360();
CString puertoT ="0";
static CString ConsultaFlagMerca360();
CString iFlag ="0";																						
//Variable Manejo imagenes monedas como indicador
CStatic *monedasAbonosPuntuales[IDC_ABONOSPUNTUALES];

CCuentaWeb *pCuentaClienteAbonosPuntuales;

//Seguro de motos y celulares
CCuentasSeguros cuentasSeguros;
//

// Cuadro de diálogo CAboutDlg utilizado para el comando Acerca de

class CAboutDlg : public CDialog2012
{
public:
	CAboutDlg();

	// Datos del cuadro de diálogo
	enum { IDD = IDD_ABOUTBOX };

protected:
	virtual void DoDataExchange(CDataExchange* pDX);    // Compatibilidad con DDX/DDV

	// Implementación
protected:
	DECLARE_MESSAGE_MAP()
};

CAboutDlg::CAboutDlg() : CDialog2012(CAboutDlg::IDD)
{
}

void CAboutDlg::DoDataExchange(CDataExchange* pDX)
{
	CDialog2012::DoDataExchange(pDX);
}

BEGIN_MESSAGE_MAP(CAboutDlg, CDialog2012)
END_MESSAGE_MAP()

void CDlgCapturarAbono::replaceString(char message [], CString find, CString replace, char* newMessage)
{
	std::string s(message);
	std::string FindWord = find;
	std::string ReplaceWord = replace;

	std::size_t index;
	while ((index = s.find(FindWord)) != std::string::npos)
		s.replace(index, FindWord.length(), ReplaceWord);
	sprintf(newMessage, s.c_str());
}
void CDlgCapturarAbono::validaGanador()
{
	CString sDineroRecompensa;
	CString sNuevoSaldo;
	CString maxAbonosPuntuales;
	char cResultado[1024] = {0};
	getDineroElectMin(); // se obtiene valor minimo de dienero electronico para imprimir ticket de abonos puntuales
	if((iflagGanador == 1 || iflagTicketsCoppelMax == 1) && iFlagTiendaLocal == 0  && esEmpleado(m_grid.lCliente) != 1)
	{
		CString sFechaActual;
		sFechaActual.Format("%04d-%02d-%02d", iAnioActual, iMesActual, iDiaActual);
		char cSql[250] = { 0 };

		sprintf_s(cSql, "SELECT fun_obtenerDineroElectronicoGenerado as DineroElectronico FROM fun_obtenerDineroElectronicoGenerado('%ld','%ld','%d','C','%s')", m_grid.lCliente, lNumeroRecibo, m_grid.iCaja, sFechaActual);
		CMaximo Dineroelectronico(&odbc);

		if (!Dineroelectronico.Exec(cSql))
		{
			AfxMessageBox("Error al ejecutar la función fun_obtenerDineroElectronicoGenerado");
			Dineroelectronico.Error();
		}
		else
		{
			Dineroelectronico.activarCols();
			if (Dineroelectronico.leer())
			{
				ConsultarSaldoDineroElectronicoCliente(true);

				if (Dineroelectronico.Total > 0)
				{
					if(iflagTicketsCoppelMax == 1)
					{
						// Invocar metodo para imprimir ticket ganador.
						ImprimirTicketGanadorCoppelMax(Dineroelectronico.Total);
					}

					if (iflagGanador == 1)
					{
						sDineroRecompensa.Format("%d", Dineroelectronico.Total);
						sNuevoSaldo.Format("%d", iDineroElectronico);
						maxAbonosPuntuales.Format("%d", iValorAbonosPuntuales);

						char message [100];
						char message2 [100];
						char message3 [100];
						char MensajeRecompensa[300];

						memset(message, 0, sizeof(message));
						consultarMensaje(3516, message);
						memset(message2, 0, sizeof(message2));

						sprintf_s(cResultado ,"Corte Actual - %d",iCorteActual);	 
						grabarLog(cResultado);

						sprintf_s(cResultado ,"Valor Abonos Puntuales - %d",iValorAbonosPuntuales);	 
						grabarLog(cResultado);

						if (bMostrarMensajeGenerico)
						{
							consultarMensaje(3519, message2); // Aun no se solicita
						}
						else 
						{
							consultarMensaje(3517, message2);
							replaceString(message2,"XX", maxAbonosPuntuales, message2);
						}

						replaceString(message,"Â", "¡", message);
						replaceString(message2,"#", sDineroRecompensa, message2);

						memset(message3, 0, sizeof(message3));
						consultarMensaje(3518, message3);

						replaceString(message3,"#",sNuevoSaldo, message3);

						sprintf_s(MensajeRecompensa, "%s\n%s\n%s",message,message2,message3);
						MessageBox(MensajeRecompensa, "COPPEL", 0);
					}
				} 
				else
				{
					if (iflagTicketsCoppelMax == 1 && iDineroElecMin != -1 && iDineroElectronico >= iDineroElecMin )
					{
						ConsultaClienteCoppelRecompensaTuPuntualidad();
						iMonedasTicket = iCorteActual;
						ImprimirTicketAbonoCoppelMax();
						iMonedasTicket = 0;
					}
				}
			}
		}
	}
}
void CDlgCapturarAbono::getDineroElectMin()
{
	char cLog[500] = { 0 };
	char cSql[250] = { 0 };
	char cResultado[1024] = {0};
	int iTipoOperacion = 472;
	iDineroElecMin = -1;
	sprintf_s(cLog, "Entra - getDineroElectMin()");
	grabarLog(cLog);

	sprintf_s(cSql, "select idu_valorconfiguracion from ctl_configuracionoperaciones where num_tipooperacion = %d", iTipoOperacion);

	CMaximo dineroElectronico(&odbc, false);
	if (dineroElectronico.Exec(cSql))
	{
		dineroElectronico.activarCols();
		if(dineroElectronico.Leer())
		{
			iDineroElecMin = dineroElectronico.Total;
		}
		sprintf_s(cResultado ,"Dinero minimo para impresión coppel max - %d",iDineroElecMin);	
		grabarLog(cResultado);
	}
	else
	{
		//Se obtiene el error
		dineroElectronico.odbc->GetLastError(dineroElectronico.GetHstmt());
		grabarMensajeError("C", m_grid.iCaja, (LPTSTR)(LPCTSTR)m_grid.sServer, "CapturarAbono", "CDlgCapturarAbono", "getDineroElectMin", cSql, m_grid.lEmpleado, "ERROR EN LA CONSULTA(ConsultarValorDineroElectronicoMinimo)", dineroElectronico.odbc, m_grid.iMuestraMsg);
	}

	sprintf_s(cLog, "Finaliza - getDineroElectMin()");
	grabarLog(cLog);
}

void CDlgCapturarAbono::MostrarAbonosPuntualesCoppelMax()
{
	int controles[1] = { IDC_MSGABONOSPUNTUALES };


	HBITMAP hBmp;

	if(iCorteLogica == 0)
	{
		iCorteLogica = iValorAbonosPuntuales;
	}

	if(iCorteLogica == iCorteActual)
	{
		iCorteActual = 0;
	}

	for (int i = 0; i < iCorteLogica ; i++)
	{
		if(i < iCorteActual)
		{
			hBmp = (HBITMAP)::LoadImage(NULL, "C:/sys/progs/monedaAbonoPuntualRellena.bmp", IMAGE_BITMAP, 17, 17, LR_LOADFROMFILE);
		}
		else
		{
			hBmp = (HBITMAP)::LoadImage(NULL, "C:/sys/progs/monedaAbonoPuntualVacia.bmp", IMAGE_BITMAP, 17, 17, LR_LOADFROMFILE);
		}

		monedasAbonosPuntuales[i] = new CStatic;
		monedasAbonosPuntuales[i]->Create(NULL, 
			WS_CHILD | WS_VISIBLE | SS_BITMAP,
			CRect(880+i*20, 655, 17, 17), 
			this);
		monedasAbonosPuntuales[i]->SetBitmap(hBmp);

		//monedasAbonosPuntuales[i]->RedrawWindow();
		//monedasAbonosPuntuales[i]->UpdateWindow();
	}

	for(int i = 0; i < 1; i++)
	{
		GetDlgItem(controles[i])->ShowWindow(true); 
		GetDlgItem(controles[i])->RedrawWindow();
		GetDlgItem(controles[i])->UpdateWindow();
	}

	bMostrarMensajeGenerico = !(iCorteActual == iValorAbonosPuntuales - 1);

	iCorteActual = 0;

	bMostroMonedas = true;
}

void CDlgCapturarAbono::OcultarAbonosPuntualesCoppelMax()
{
	char cLog[500] = { 0 };
	sprintf_s(cLog, "Entra - OcultarAbonosPuntualesCoppelMax()");
	grabarLog(cLog);
	int controles[3] = { IDC_MSGABONOSPUNTUALES, IDC_MSGDINEROELECTRONICO, IDC_DINEROELECTRONICO };

	if(bMostroDineroElectronico)
	{
		for(int i = 0; i < 3; i++)
		{
			GetDlgItem(controles[i])->ShowWindow(SW_HIDE); 
			GetDlgItem(controles[i])->RedrawWindow();
			GetDlgItem(controles[i])->UpdateWindow();
		}
	}

	if(bMostroMonedas)
	{
		for(int i = 0; i < 4; i++)
		{
			monedasAbonosPuntuales[i]->ShowWindow(SW_HIDE); 
			monedasAbonosPuntuales[i]->RedrawWindow();
			monedasAbonosPuntuales[i]->UpdateWindow();
		}
	}

	sprintf_s(cLog, "Finaliza - OcultarAbonosPuntualesCoppelMax()");
	grabarLog(cLog);
}


// Cuadro de diálogo de CDlgCapturarAbono

CDlgCapturarAbono::CDlgCapturarAbono(CWnd* pParent /*=NULL*/)
	: CDialog2012(CDlgCapturarAbono::IDD, pParent)
{
	char cLog[500] = { 0 };
	sprintf_s(cLog, "FC0200805021520985 - entra - CDlgCapturarAbono - constructor");
	grabarLog(cLog);
	memset(cDomicilioCompleto, 0, sizeof(cDomicilioCompleto));
	memset(cExpedicion, 0, sizeof(cExpedicion));
	memset(cIpServidorCCuentaWeb, 0, sizeof(cIpServidorCCuentaWeb));
	iCausaSituacionEspecial = 0;

	memset(iFoliosSegurosAdicionales, 0, sizeof(iFoliosSegurosAdicionales));
	memset(iFoliosSegurosActual, 0, sizeof(iFoliosSegurosActual));
	memset(iFoliosAfirme, 0, sizeof(iFoliosAfirme));
	//18841-Descuento Moratorio
	iAplicoDescuento = 0;
	iMaxInteresValido = 0;
	prc_descuento = 0;
	imp_totaldescuento = 0;
	mostroMensajeMora = 0;
	idu_huellamora = 0;
	num_gerentemora = 0;
	//18890 PL
	objPlanDeLealtad = NULL;


	iSegurosAfirme = iSistema = iTotalCuentas = iAnioActual = iDiaActual = iMesActual = iTipoSeguro = iEdad = 0;
	iControles = iFlagMovimiento = iSituacionEspecial = iFlagCorte =
		iDiaEncuesta = iMesEncuesta = iAnioEncuesta = iFlagPeriodico = iFlagBanorte =
		iFlagEdoCuenta = iFlag30Dias = iTipoEncuesta =
		iFlagReactivo = iFlagNuevo = iFlagConvenioTerminado = iFlagVolante = iFlagPago =
		iFlagTdaConEstacionamiento =
		iDiaBonificacionRopa = iMesBonificacionRopa = iAnioBonificacionRopa = iFlagGraboAbono =
		iFlagCapturoBeneficiariosClub = iContador = iRegresa =
		iFlagAbonoInteres = iFlagConvenio = iFlagBonificacion = iFlagSeguro = iFlagBeneficiarios =
		iFlagClienteEtp = iFlagAbono = iFlagMovimientos = iFlagEficienciaCajera = iFlagTerminacion =
		iFlagCrPrestamo = iFlagCrRopa = iFlagCrMuebles = iFlagCrSeguro = iFlagSegAfirme = iFlagCrTaire = iFlagCrCRevolvente =
		iFlagServicio = iFlagMesUltimoMovimiento =
		iFlagCapturoServicio = iMarcaSeguroClub = iFlagExisteEncuesta = iFlagMensajeAfore = iFlagCapturaBeneficiario =
		iCasa = iColonia = iCalle = iCiudad = iClub =
		iCtaPerdida = iFlagInvitacionBanco =
		iFoco = iFlagSupervisor = iSituacion = iParentesco1 = iParentesco2 = iParentesco3 = iParentesco4 =
		iPorcentaje1 = iPorcentaje2 = iPorcentaje3 = iCiudadGnDominio = iSiTieneSeguroClub = iPorcentaje4 =
		iFlagComproSeguro = iFlagCapturoBeneficiariosClubNuevo = iNumeroMeses =
		iCuentasAgua = iCuentasSofol = iCuentasTelefono = iMesConvenio = iRegresaDll =
		iCuentasPredial = iCuentasGas = iCuentasMegacable = iCuentasNextel = iFlagMesRegalado =
		iCuentasAlestra = iCuentasCfe = iCuentasAxtel = iFlagCteForaneo = iFlagCapturaSurpervisor = iConyugal = iFlagDespliegaDatosZ =
		iPesosUnidadCredito = iFlagPago60Restructurado = iOpcionSeleccionada =
		iTiendaDlg = iCajaDlg = lEmpleadoDlg = iMuestraMsg = iRespuesta = iFlagDatosSeguro = iFlagMensajeHuella =
		iTeclaAnterior = iFinLinea = iTipoImpresora =
		iFlagAutoGteCargo = iStatusAfore = iStatusAforeNvo = iFlagTiendaLocal = iFlagJapac = iTipoEtpFicha =
		iBuscarCliente = iFlagMsjAfore = iTiempoMensaje = iFlagTieneSeguroAdicional =
		iFlagSeguroAuto = iFlagCapturarTelefonos = iPedirTelefonos = iFlagTdaConCubrebocas = iFlagCertificacionBonidicacion = 
		iMostrarEncuestaCat = iFlagEncuestaCat = iCuentasCablemas = iFlagAsteriscoCoppel = iFlagAbonoTA =
		iFlagPromocionDirecta = iFlagMesRegaladoCPS = iFlagRegistroPL = iFlagCampoInteligentePL = 0;
	iCantidadCuentaMuebles = 0;

	//short
	iSegurosAdicionalesNuevos = iNumMesesAdicional = iFlagCapturoSeguroAdicional = iRespuestaPoliza = iTipoConvenio = iSubTipoConvenio =
		iPlazoConvenio = iSegurosAdicionales = iFlagDescuentoEspecial = iCajaOriginal = iCajaActual = iDiaNacimiento = iEdadCliente =
		iMesNacimiento = iAnioNacimiento = 0;

	lTotal30Dias = lTotalEdosCta = lNumeroGerente = lPagoTotal = lDineroCoppel =
		lPagoCliente = lImporteConvenios = lClienteEtp = lSaldaConAnteriorX = lNumeroRecibo =
		lEmpleadoSupervisor = lTotalSaldaCon = lMargenCredDisponible =
		lMargenCompleto = lNumeroConexion = lTotalEncuestar = lTotalAPagar = lCodigoPostal = lCiudadColoniaCte =
		lClienteDlg = lClienteMaximo = lFolioBeneficiario =
		lAcumulado = lAcumuladoMonetario = lConsultaAcumulado =
		lZonaEncuestado = lTelefonoEncuestado = lBaseCcuenta = lClienteLocalizar = lSaldoTmp = lAbonoTotalTmp =
		lGteHuella = lNumeroConsulta = lPoliza =
		lKeyxEncuesta = lKeyxEdoCtas = lTotalEncPeriodico = lTotalEncEdoCta = lCuotaClub = lCuotaPlan = 0;
	lAbonoRopa = lAbonoTasa0 = lAbonoInteresesRopa = lAbonoInteresesTasa0 = lBonificacionRopa = lBonificacionTasa0 =
		lSaldoRopa = lSaldoTasa0 = lInteresesRopa = lInteresesTasa0 = 0;
	iTipoDeduccionRopa = iTipoDeduccionTasa0 = -1;
	iTotalCuentasDetalle = 0;

	ShiftTab = bBanderaTieneClub = bBanderaSeguroConyugal = bBanderaSeguroVigente = bPagodeServicios = bFlagCuponCajas =
		bTieneSeguroAfirme = bTienePlantel = bClienteCandidato = bCteSeguro = bFlagSalirXCaja = bBanderaTienePlan = bTieneDatosEnTemporales = bTieneVencidoPlan = false;

	memset(cFechaConvenio, 0, sizeof(cFechaConvenio));
	memset(cNombreCiudad, 0, sizeof(cNombreCiudad));
	memset(cTarjeta, 0, sizeof(cTarjeta));

	memset(cIpServidorCredito, 0, sizeof(cIpServidorCredito));
	memset(cNombre, 0, sizeof(cNombre));
	memset(cApellidoMaterno, 0, sizeof(cApellidoMaterno));
	memset(cApellidoPaterno, 0, sizeof(cApellidoPaterno));
	memset(cNombreAsegurado, 0, sizeof(cNombreAsegurado));

	memset(cNombreBeneficiario1, 0, sizeof(cNombreBeneficiario1));
	memset(cApPatBeneficiario1, 0, sizeof(cApPatBeneficiario1));
	memset(cApMatBeneficiario1, 0, sizeof(cApMatBeneficiario1));
	memset(cNombreBeneficiario2, 0, sizeof(cNombreBeneficiario2));
	memset(cApPatBeneficiario2, 0, sizeof(cApPatBeneficiario2));
	memset(cApMatBeneficiario2, 0, sizeof(cApMatBeneficiario2));
	memset(cNombreBeneficiario3, 0, sizeof(cNombreBeneficiario3));
	memset(cApPatBeneficiario3, 0, sizeof(cApPatBeneficiario3));
	memset(cApMatBeneficiario3, 0, sizeof(cApMatBeneficiario3));
	memset(cNombreBeneficiario4, 0, sizeof(cNombreBeneficiario4));
	memset(cApPatBeneficiario4, 0, sizeof(cApPatBeneficiario4));
	memset(cApMatBeneficiario4, 0, sizeof(cApMatBeneficiario4));

	memset(cPuntualidad, 0, sizeof(cPuntualidad));
	memset(cTipoEtp, 0, sizeof(cTipoEtp));
	memset(cClaveA, 0, sizeof(cClaveA));
	memset(cSexoCliente, 0, sizeof(cSexoCliente));
	memset(cFechaMovimiento, 0, sizeof(cFechaMovimiento));
	memset(cLocal, 0, sizeof(cLocal));

	memset(cFechaMovimiento, 0, sizeof(cFechaMovimiento));

	memset(cFechaNacimiento, 0, sizeof(cFechaNacimiento));
	memset(cIpServidorCartera, 0, sizeof(cIpServidorCartera));
	memset(cIpServidorPlanes, 0, sizeof(cIpServidorPlanes));

	memset(cIpServidorCFE, 0, sizeof(cIpServidorCFE));
	memset(cIpServidorTelmex, 0, sizeof(cIpServidorTelmex));
	memset(cIpServidorCentral, 0, sizeof(cIpServidorCentral));
	memset(cIPServidorTiendaNumero, 0, sizeof(cIPServidorTiendaNumero));

	memset(cNombreEncuestado, 0, sizeof(cNombreEncuestado));
	memset(cNombreConyuge, 0, sizeof(cNombreConyuge));
	memset(cApellidoMaternoEncuestado, 0, sizeof(cApellidoMaternoEncuestado));
	memset(cApellidoPaternoEncuestado, 0, sizeof(cApellidoPaternoEncuestado));
	memset(cNomMes, 0, sizeof(cNomMes));
	memset(cNombrec, 0, sizeof(cNombrec));
	memset(cApPaternoc, 0, sizeof(cApPaternoc));
	memset(cApMaternoc, 0, sizeof(cApMaternoc));
	memset(cPermiso, 0, sizeof(cPermiso));
	memset(cSitEsp, 0, sizeof(cSitEsp));
	memset(cTelefonoGnDominio, 0, sizeof(cTelefonoGnDominio));

	cSexo = 0;
	memset(cMonto, 0, sizeof(cMonto));
	memset(cConceptoCta, 0, sizeof(cConceptoCta));
	memset(cNombreSucursal, 0, sizeof(cNombreSucursal));
	memset(cDomicilio, 0, sizeof(cDomicilio));
	memset(cFechaMasActualCte, 0, sizeof(cFechaMasActualCte));
	memset(clv_situacion, 0, sizeof(clv_situacion));
	memset(&EDatosConvenioCliente, 0, sizeof(DatosConvenioCliente) * 100);
	memset(cOcupacion, 0, sizeof(cOcupacion));
	memset(&stDatosCertificacion, 0, sizeof(STDatosCertificacion) * 100);

	i64TelefonoCelular = i64TelefonoCliente = 0;

	lFolioGrabarAbono = 0;

	iEdadMinimaClub = iEdadMaximaClub = iEdadMaximaClubAdicional = iEdadMaximaAbonoClub = iEdadMaximaAbonoClubAdic = iCambioPlanSeguroClub = iEdadMinimaPlan = iEdadMaximaPlan = 0;

	/*Progc *Coppel*/
	memset(cPuntualidadAsterisco, 0, sizeof(cPuntualidadAsterisco));
	memset(cSubPuntualidadAsterisco, 0, sizeof(cSubPuntualidadAsterisco));
	iCausaSituacionEspecialAsterisco = 0;
	lVencidoTiempoAireAsterisco = 0;
	lAbonoBaseTiempoAireAsterisco = 0;
	iPorcentajeUtilizado = 0;
	/*****/

	lTotalGlobalServicios = lDepartamento = lClase = lGrupo = 0;
	iFlagSeguroAdicional = iCiudadCliente = 0;
	iColumnaClub = iColumnaPlan = -1;
	memset(cFechaTienda, 0, sizeof(cFechaTienda));
	iFlagDescuentoEspecial = 0;
	cSituacionEspecialAsterisco = 0;
	memset(cMensajeSeguro, 0, sizeof(cMensajeSeguro));
	memset(cSituacioEspecial, 0, sizeof(cSituacioEspecial));
	memset(cJsonPost, 0, sizeof(cJsonPost));
	memset(cSituacionEspecialesMandar, 0, sizeof(cSituacionEspecialesMandar));
	memset(cEstCivil, 0, sizeof(cEstCivil));
	memset(cPlanSeguroClub, 0, sizeof(cPlanSeguroClub));
	iflg_candconvunico = iNumCandidatoUnico = iAbonoBaseTotalInicial = 0;
	lClienteLocalizar = 0;
	iConConvenio = iTipoCtaConv = 0;
	lVencidoFinalTicket = lSaldoCtaTicket = iContadorRegistros = 0;
	iImporteTotalConv = iAbonoBaseTotalConv = iImporteMinimoConv = 0;
	iImporteMinimoConv = iVencidoTotalConv = iTarjetaConv = iTotalAbonos = iTotalConvenio = imesesparaconvunico = iTotalConv = 0;
	ianio = imes = iTotalAbonoInte = 0;
	iFlagSorteoBoletoPremios = iRegla = iFlagContactoEfectivo = iFlagImpresionCuentasPerdidas = 0;
	iSeguroVigente = 0;
	lImporteAdicionalesNuevos = lSalarioMinimo = 0;

	iFlagTimeOutCCuenta = 0;
	iProceso = iIdSituacion = iTotalAbonoSeg = iIdSituacionEspecial = iPlazoRopa = iCausaSituacion = 0;

	memset(cEncabezado, 0, sizeof(cEncabezado));
	memset(cParrafo1, 0, sizeof(cParrafo1));
	memset(cParrafo2, 0, sizeof(cParrafo2));
	memset(cParrafo3, 0, sizeof(cParrafo3));
	memset(cParrafo4, 0, sizeof(cParrafo4));
	memset(cSituacionEspecial, 0, sizeof(cSituacionEspecial));
	memset(cFechaVigencia, 0, sizeof(cFechaVigencia));
	memset(cPoliza, 0, sizeof(cPoliza));

	lTelefono1 = lTelefono2 = lTelefono3 = 0;
	iMesNacimiento1 = iMesNacimiento2 = iMesNacimiento3 = 0;
	iAnioNacimiento1 = iAnioNacimiento2 = iAnioNacimiento3 = 0;
	iDiaNacimiento1 = iDiaNacimiento2 = iDiaNacimiento3 = 0;
	memset(cMensaje, 0, sizeof(cMensaje));

	iFlagPermiteCancelarSeguros = 0;
	iFlagPermiteSeguroAdicionalBancoppel = 0;
	iFlagApoyoAdicionalPF = 0;
	iFlagDomiciliacionCuentas = iFlagConsultaDomiciliacion = 0;
	iSegurosBancoppel = iSegurosDesactualizadosCoppel = iSegurosDesactualizadosBanCoppel = 0;
	lFolioNuevo = lFolioAnterior = 0;
	iTipoSeguroPF = 0;
	iFlagDomiciliacion = 0;
	memset(CuentasDomiciliadas, 0, sizeof(CuentasDomiciliadas));
	iTestigo = iReciboAux = 0;
	bCandidatoSeguro = bCandidatoPSVenta = bCandidatoPSAbono = bSobrePasaEdadMaxima = bErrorProcesoPS = false;
	iDiaVencimientoCPS = iDiaVencimientoCPF = 1;
	iMesVencimientoCPS = iMesVencimientoCPF = 1;
	iAnioVencimientoCPS = iAnioVencimientoCPF = 1900;
	iFlagPlandeSalud = iFlagMarcadoCandidatosCPF = 0;

	memset(cConexion, 0, sizeof(cConexion));
	memset(cIpServidorControl, 0, sizeof(cIpServidorControl));
	iDiaUltimoPago = iMesUltimoPago = iAnioUltimoPago = 0;
	i64Cliente = 0;
	iFlagConsultaSC3 = 0;
	memset(&i64PolizasPlanActual, 0, sizeof(i64PolizasPlanActual));
	iFlagImpresoraTermica = 0;

	memset(sFechaActivacion, 0, sizeof(sFechaActivacion));
	memset(sFechaVencimiento, 0, sizeof(sFechaVencimiento));
	memset(sFechaVencimientoAnterior, 0, sizeof(sFechaVencimientoAnterior));

	iFlagRegistroPL = 0;
	iFlagCampoInteligentePL = 0;
	memset(cOpcionPL, 0, sizeof(cOpcionPL));

	//21749    
	this->iBiometrizadoCliente = VALIDACION_BIOMETRIZADA_INDEFINIDA;
	this->iBiometrizadoGerente = VALIDACION_BIOMETRIZADA_INDEFINIDA;
	this->iTipoCuestion = RESPUESTA_CUESTION_INDEFINIDA;
	this->iNumeroAdicional = 0;
	lFlagHuella = 0L;
	bCargaDatosSorteo = false;

	stCambioPlanes = nullptr;
	sprintf_s(cLog, "FC0200805021520985 - finalizá - CDlgCapturarAbono - constructor");
	grabarLog(cLog);
}

CDlgCapturarAbono::~CDlgCapturarAbono()
{
	if (objPlanDeLealtad != NULL)
	{
		delete objPlanDeLealtad;
	}
	if (stCambioPlanes != NULL)
	{
		delete[] stCambioPlanes;
	}
	if (monedasAbonosPuntuales != nullptr)
	{
		grabarLog("CDlgCapturarAbono Liberar --> objCargaDllConvenio 751 Cambio Softtek");
		delete[] monedasAbonosPuntuales;
		grabarLog("CDlgCapturarAbono Se libera --> objCargaDllConvenio 751 Cambio Softtek");
	}
}

void CDlgCapturarAbono::DoDataExchange(CDataExchange* pDX)
{
	CDialog2012::DoDataExchange(pDX);
	DDX_Control(pDX, IDC_GRID, m_grid);
	DDX_Control(pDX, IDC_CLIENTE, m_cliente);
	DDX_Control(pDX, IDC_APELLIDOPATERNO, m_apellidoPaterno);
	DDX_Control(pDX, IDC_APELLIDOMATERNO, m_apellidoMaterno);
	DDX_Control(pDX, IDC_NOMBRE, m_nombre);
	DDX_Control(pDX, IDC_PUNTUALIZAD2, m_puntualidad2);
	DDX_Control(pDX, IDC_GRID2, m_grid2);
	DDX_Control(pDX, IDC_MENSAJE, m_mensaje);
	DDX_Control(pDX, IDC_FLECHA, m_flecha);
	DDX_Control(pDX, IDC_EDAD, m_edad);
	DDX_Control(pDX, IDC_MSGMINIMO, m_msgMinimo);
	DDX_Control(pDX, IDC_MSGMINIMO2, m_msgminimo2);
	DDX_Control(pDX, IDC_MSGMINIMO3, m_msgminimo3);
	DDX_Control(pDX, IDC_ASTERISCOCOPPEL, m_asteriscocoppel);
	DDX_Control(pDX, IDC_INTMESUNO, m_intMesUno);
	DDX_Control(pDX, IDC_MSGCANDIDATOREESTRUCTURA, m_msgCandidatoReestructura);
	DDX_Control(pDX, IDC_MENSAJE2, m_mensaje2);
	DDX_Control(pDX, IDC_MENSAJE3, m_mensaje3);
	DDX_Control(pDX, IDC_CORREO, m_correo);
	DDX_Control(pDX, IDC_CELULARCLIENTE, m_celular);
	DDX_Control(pDX, IDC_LBLCORREO, m_lblCorreo);
	DDX_Control(pDX, IDC_LBLCELULAR, m_lblCelular);
	DDX_Control(pDX, IDC_DINEROELECTRONICO, m_dineroElectronico);
	DDX_Control(pDX, IDC_LEYENDA_ACLARACIONSDO, m_leyendaAclaracion);
}

BEGIN_MESSAGE_MAP(CDlgCapturarAbono, CDialog2012)
	ON_WM_SYSCOMMAND()
	ON_WM_PAINT()
	ON_WM_QUERYDRAGICON()
	//}}AFX_MSG_MAP
	//ON_EN_SETFOCUS(IDC_ENTREGO, OnEnSetfocusEntrego)
	ON_EN_SETFOCUS(IDC_CLIENTE, OnEnSetfocusCliente)
	ON_EN_CHANGE(IDC_CLIENTE, &CDlgCapturarAbono::OnEnChangeCliente)
	//	ON_STN_CLICKED(IDC_MENSAJE3, &CDlgCapturarAbono::OnStnClickedMensaje3)
	//	ON_STN_CLICKED(IDC_DINEROELECTRONICO, &CDlgCapturarAbono::OnStnClickedDineroelectronico)
	//	ON_STN_CLICKED(IDC_MSGABONOSPUNTUALES, &CDlgCapturarAbono::OnStnClickedMsgabonospuntuales)
	//	ON_STN_CLICKED(IDC_MSGDINEROELECTRONICO, &CDlgCapturarAbono::OnStnClickedMsgdineroelectronico)
END_MESSAGE_MAP()


// Controladores de mensaje de CDlgCapturarAbono

BOOL CDlgCapturarAbono::OnInitDialog()
{
	CDialog2012::OnInitDialog();
	int iFlagConecto = 0;
	CString sTxt, sFechaTitulo;
	char cFechaTitulo[10] = { 0 }, cBarraOpciones[200] = { 0 }, cTexto[1026] = { 0 };
	bCteSeguro = true;
	bMostrarReestructura = false;
	iFlagReestructuraDisponible = 0;
	bFormalizo = false;
	ShowWindow(SW_SHOWMAXIMIZED);
	inoTienda.Format("%d", m_grid.iTienda);
	grabarLog("CDlgCapturarAbono::OnInitDialog --> Inicia pantalla de abonos");
	// Agregar el elemento de menú "Acerca de..." al menú del sistema.

	// IDM_ABOUTBOX debe estar en el intervalo de comandos del sistema.
	ASSERT((IDM_ABOUTBOX & 0xFFF0) == IDM_ABOUTBOX);
	ASSERT(IDM_ABOUTBOX < 0xF000);


	CMenu* pSysMenu = GetSystemMenu(FALSE);
	if (pSysMenu != NULL)
	{
		CString strAboutMenu;
		strAboutMenu.LoadString(IDS_ABOUTBOX);
		if (!strAboutMenu.IsEmpty())
		{
			pSysMenu->AppendMenu(MF_SEPARATOR);
			pSysMenu->AppendMenu(MF_STRING, IDM_ABOUTBOX, strAboutMenu);
		}
	}
	tituloMostrar();
	crearMensajeNR(this, m_barra, m_mensaje1);

	char cSql[255] = { 0 };

	bTienePlantel = false;
	iFlagConecto = 0;
	iControles = 2;
	iFoco = 0;
	iTotalCuentas = 0;
	m_grid.iFlagConvenioRealizado = 0;
	lZonaEncuestado = 0;
	lTelefonoEncuestado = 0;
	iFlagCrTaire = 0;
	iFlagDatosSeguro = 0;
	lBaseCcuenta = 0;
	iFlagCapturaSurpervisor = 0;
	lCiudadColoniaCte = 0;
	iFlagDespliegaDatosZ = 0;
	bExisteCuentaSolex = false; // TEMPAPSESTRATCOB005
	SecureZeroMemory(cUrlSanaTuDeuda, sizeof(cUrlSanaTuDeuda)); // TEMPAPSESTRATCOB005
	lSaldoTmp = 0;
	lAbonoTotalTmp = 0;
	iFlagTieneSeguroAdicional = 0;
	iFlagTienePlanAdicional = 0;
	iFlagCapturoSeguroAdicional = 0;
	iSegurosAdicionales = 0;
	iPlanAdicionales = 0;
	iSegurosAdicionalesNuevos = 0;
	lCuotaClub = 0;
	lCuotaPlan = 0;
	iNumMesesAdicional = 0;
	iColumnaClub = iColumnaPlan = -1;
	lImporteAdicionalesNuevos = 0;
	iDiasVencidosPS = iSumaAseguradaPlan = iCambiosDePlan = 0;

	memset(cNombreEncuestado, 0, 20);
	memset(cApellidoMaternoEncuestado, 0, 20);
	memset(cApellidoPaternoEncuestado, 0, 20);

	//ShowWindow(SW_SHOWMAXIMIZED);
	iParentesco1 = iParentesco2 = iParentesco3 = iPorcentaje1 = iPorcentaje2 = iPorcentaje3 = iPorcentaje4 = iParentesco4 = 0;
	m_cliente.SetLimitText(9);
	iFlagMesUltimoMovimiento = 0;
	iFlagAbonoInteres = 0;
	iNumeroMeses = 0;
	lTotalAPagar = 0l;
	iFlagConvenio = 0;
	iFlagBonificacion = 0;
	lTotalEncuestar = 0;
	iFlagSeguro = 0;
	iRegresaDll = 0;
	iFlagBeneficiarios = 0;
	iFlagExisteEncuesta = 0;
	iFlagClienteEtp = 0;
	iFlagAbono = 0;
	iMarcaSeguroClub = 0;
	iFlagCapturoServicio = 0;
	iMesConvenio = 0;
	iFlagCapturoBeneficiariosClubNuevo = 0;
	iFlagMovimientos = 0;
	iFlagEficienciaCajera = 0;
	iFlagCrPrestamo = 0;
	iFlagCrRopa = 0;
	iFlagCrTaire = 0;
	iFlagCrMuebles = 0;
	iFlagCrSeguro = 0;
	iFlagCrCRevolvente = 0;
	lTotalSaldaCon = 0L;
	iContador = 0;
	lNumeroConexion = 0L;
	bBanderaTieneClub = false;
	bBanderaTienePlan = false;
	bTieneDatosEnTemporales = false;
	bTieneVencidoPlan = false;
	lAcumuladoMonetario = 0L;
	lFolioBeneficiario = 0L;
	lPagoTotal = 0L;
	lPagoCliente = 0L;
	lAcumulado = 0;
	lConsultaAcumulado = 0L;
	iFlagComproSeguro = 0;
	iTipoSeguro = 0;
	lClienteEtp = 0L;
	lNumeroRecibo = 0L;
	lEmpleadoSupervisor = 0L;
	iFlagEdoCuenta = -1;
	iFlagReactivo = 0;
	iFlagCapturoBeneficiariosClub = 0;
	iFlagConvenioTerminado = 0;
	lImporteConvenios = 0L;
	iFlagNuevo = 0;
	iFlag30Dias = -1;
	iFlagPago = 0;
	iTeclaAnterior = 0;
	iCajaOriginal = 0;
	iFlagMensajeHuella = 0;
	iFlagCorte = 0;
	m_grid.bFlagNegativo = false;
	iClub = 0;
	iFlagAutoGteCargo = 0;
	lTotalGlobalServicios = 0;
	bFlagSalirXCaja = false;
	iCantidadCuentaMuebles = 0;
	bProvieneDatos_OtraArea = false;
	iCorteActual = 0;
	iCorteLogica = 0;
	iDineroElectronico = 0;
	iSaldoDineroElectronicoCuenta = 0;
	iValorAbonosPuntuales = 0;
	bMostroMonedas = false;
	bMostroDineroElectronico = false;
	bMostrarMensajeGenerico = true;


	//en cajaoriginal queda el numero de la caja 
	//y en la caja quedara en
	//muebles 99 ropa 98 para diferenciar los abonos de cajas, ropa y muebles
	if (iSistema == 1 || iSistema == 2)
	{
		if (m_grid.lCliente > 0)   // Agregue esta condicion Marcela 07/jun/2006
		{
			sTxt.Format("%ld", m_grid.lCliente);
			m_cliente.SetWindowText(sTxt);
		}

		iCajaOriginal = m_grid.iCaja;
		if (iSistema == 1)
		{
			iCajaActual = 99;
		}
		else
		{
			iCajaActual = 98;
		}
	}
	else
	{
		iCajaActual = m_grid.iCaja;
	}

	m_grid.iSistema = iSistema;

	memset(cFechaNacimiento, 0, 25);
	memset(cLocal, 0, 3);
	memset(cSexoCliente, 0, sizeof(cSexoCliente));
	memset(cPuntualidad, 0, sizeof(cPuntualidad));
	memset(cTipoEtp, 0, sizeof(cTipoEtp));
	memset(cClaveA, 0, 3);
	memset(cNombre, 0, 20);
	memset(cApellidoMaterno, 0, 20);
	memset(cApellidoPaterno, 0, 20);
	memset(cNombreBeneficiario1, 0, 20);
	memset(cApPatBeneficiario1, 0, 20);
	memset(cApMatBeneficiario1, 0, 20);
	memset(cNombreBeneficiario2, 0, 20);
	memset(cApPatBeneficiario2, 0, 20);
	memset(cApMatBeneficiario2, 0, 20);
	memset(cNombreBeneficiario3, 0, 20);
	memset(cApPatBeneficiario3, 0, 20);
	memset(cApMatBeneficiario3, 0, 20);
	memset(cNombreAsegurado, 0, 35);
	memset(cNombreConyuge, 0, 35);
	memset(cNombreBeneficiario4, 0, 20);
	memset(cApPatBeneficiario4, 0, 20);
	memset(cApMatBeneficiario4, 0, 20);

	memset(cTarjeta, 0, sizeof(cTarjeta));

	iTipoConvenio = iSubTipoConvenio = iPlazoConvenio = 0;
	memset(cFechaConvenio, 0, 10);
	lTotal30Dias = lTotalEdosCta = -3L;
	if (m_grid.lCliente > 0)
	{
		bProvieneDatos_OtraArea = true;
	}
	if (iFlagCampoInteligentePL > 0 && !bProvieneDatos_OtraArea && (iSistema == SISTEMA_CAJAS || iSistema == SISTEMA_MUEBLES || iSistema == SISTEMA_ROPA))// 
	{
		m_cliente.SetLimitText(CARACTERES_CAMPO_INTELIGENTE);
	}
	else
	{
		m_cliente.SetLimitText(16);
	}
	m_msgMinimo.SetWindowText("");
	lClienteDlg = 0L;
	m_grid.AttachGrid(this, IDC_GRID);
	m_grid2.AttachGrid(this, IDC_GRID2);

	m_grid2.lTotalAbonos = 0L;
	m_grid.asociar(&m_grid2);
	m_grid.lCliente = 0L;
	memset(cPuntualidad, 0, sizeof(cPuntualidad));
	memset(m_grid.cSubPuntualidad, 0, 3);
	iTipoConvenio = 0;
	iSubTipoConvenio = 0;
	iFlagSupervisor = -1;
	m_cliente.SetFocus();
	memset(cNombre, 0, 20);
	memset(cApellidoPaterno, 0, 20);
	memset(cApellidoMaterno, 0, 20);
	iDiaNacimiento = iMesNacimiento = iAnioNacimiento = 0;
	iConyugal = 1;
	memset(cEstCivil, 0, 3);
	cerrarConexionBD(&odbc_1);

	iCiudadCliente = 0;
	lDepartamento = lClase = lGrupo = 0;
	bTieneSeguroAuto = false;
	iCausaSituacionEspecial = 0;

	iDiaVencimientoCPS = iDiaVencimientoCPF = 1;
	iMesVencimientoCPS = iMesVencimientoCPF = 1;
	iAnioVencimientoCPS = iAnioVencimientoCPF = 1900;

	iFlagTimeOutCCuenta = 0;

	bCandidatoSeguro = bCandidatoPSVenta = bCandidatoPSAbono = bSobrePasaEdadMaxima = bErrorProcesoPS = bCandidatoCPVenta = false;

	memset(cConexion, 0, sizeof(cConexion));
	obtenerIduConexion();

	sFechaHoraInicioOperacion.Empty();

	if (iFlagCampoInteligentePL > 0 || iFlagRegistroPL > 0)
	{//si sistema es cajas 
		if (iSistema == SISTEMA_CAJAS || iSistema == SISTEMA_MUEBLES || iSistema == SISTEMA_ROPA)
		{
			objPlanDeLealtad = new CPlanDeLealtad((LPTSTR)(LPCTSTR)m_grid.sServer, m_grid.iTienda, m_grid.lEmpleado, m_grid.iCaja, (short)SISTEMA_CAJAS);
		}
		ConsultarCatalogoMensajeTienda(TITULO_OPCION_REGISTRAR, cTexto);
		sprintf_s(cOpcionPL, "%.50s", cTexto);
	}

	if (iSistema == SISTEMA_CLIENTES_NUEVOS || iSistema == SISTEMA_CAJAS)
	{
		if (iFlagRegistroPL > 0 && iFlagCampoInteligentePL > 0 && iSistema == SISTEMA_CAJAS)
		{
			sprintf_s(cBarraOpciones, " [F11] DESLIZAR TARJETA    [ESC] CANCELAR    [CTRL+F9] %.50s", cOpcionPL);
		}
		else
		{
			sprintf_s(cBarraOpciones, " [F11] DESLIZAR TARJETA    [ESC] CANCELAR");
		}
	}
	else if (iSistema == SISTEMA_MUEBLES || iSistema == SISTEMA_ROPA)
	{
		if (iFlagRegistroPL > 0 && iFlagCampoInteligentePL > 0 && !bProvieneDatos_OtraArea)
		{
			sprintf_s(cBarraOpciones, " [F7] BUSQUEDA POR NOMBRE    [F11] DESLIZAR TARJETA      [CTRL+F9] %.50s  [ESC] CANCELAR", cOpcionPL);
		}
		else
		{
			sprintf_s(cBarraOpciones, " [F7] BUSQUEDA POR NOMBRE    [F11] DESLIZAR TARJETA    [ESC] CANCELAR");
		}
	}
	if (iSistema != SISTEMA_CAJERA_CAPTURISTA /*&& iFlagTiendaLocal == 0*/ && iFlagMovimiento == 1)
	{
		if (iSistema == SISTEMA_CAJAS)
		{
			obtenerFlag('C', FLAGC_REESTRUCTURA, iFlagReestructuraDisponible);
		}
		else
		{
			obtenerFlag('0', FLAG_REESTRUCTRA_MUEBLES_ROPA, iFlagReestructuraDisponible);
		}
	}
	ponerMensajeNR(this, m_barra, m_mensaje1, cBarraOpciones);
	grabarLog("CDlgCapturarAbono::OnInitDialog --> Finalizá pantalla de abonos");
	return TRUE;  // Devuelve TRUE  a menos que establezca el foco en un control
}

void CDlgCapturarAbono::OnSysCommand(UINT nID, LPARAM lParam)
{
	if ((nID & 0xFFF0) == IDM_ABOUTBOX)
	{
		CAboutDlg dlgAbout;
		dlgAbout.DoModal();
	}
	else
	{
		CDialog2012::OnSysCommand(nID, lParam);
	}
}

// Si agrega un botón Minimizar al cuadro de diálogo, necesitará el siguiente código
//  para dibujar el icono. Para aplicaciones MFC que utilicen el modelo de documentos y vistas,
//  esta operación la realiza automáticamente el marco de trabajo.

void CDlgCapturarAbono::OnPaint()
{
	{
		CDialog2012::OnPaint();
	}
}

BOOL CDlgCapturarAbono::PreTranslateMessage(MSG* pMsg)
{
	//tituloMostrar();
	// TODO: Add your specialized code here and/or call the base class
	bool bValorRegresa = true;
	char cPaso[255] = { 0 }, cTexto[20] = { 0 }, cTxt[20] = { 0 }, cSqlTxt[255] = { 0 }, cBarraOpciones[255] = { 0 }, cLog[500] = { 0 };
	int iColumna = 0, iColX = 0, iOpcionTecleada = 0, iFlagClub = 0;
	CString sDato, sTexto, sVencidoX, sConcepto;
	char cMsgBloqueo[1026] = { 0 };

	lGteHuella = 0;
	iOpcionTecleada = (int)pMsg->wParam;

	if (pMsg->message == WM_LBUTTONDOWN || pMsg->message == WM_LBUTTONDBLCLK ||
		pMsg->message == WM_RBUTTONDOWN || pMsg->message == WM_RBUTTONDBLCLK)
	{
		pMsg->wParam = VK_SHIFT;
		return TRUE;
	}

	iBuscarCliente = 0;

	m_grid.QuickGetText(-1, 21, &sDato);
	sDato.Trim();
	sprintf_s(cTxt, "%s", (LPCTSTR)sDato);

	if (memcmp(cTxt, "SU PAGO", 7) != 0)
	{
		m_grid.QuickSetText(-1, 21, "SU PAGO");
		m_grid.QuickSetAlignment(-1, 21, UG_ALIGNLEFT);
		m_grid.RedrawAll();
	}


	if (pMsg->message == WM_SYSKEYUP) // Teclas virtuales 
	{
		if (GetKeyState(VK_MENU) & 0x8000 || pMsg->wParam == VK_F10) //ELIMINO  ALT  
			pMsg->wParam = VK_SHIFT;
	}

	if (pMsg->message == WM_KEYDOWN && (pMsg->wParam == VK_END || pMsg->wParam == 107)) //FIN || +
	{
		if (iFoco == 0 && iFlagCampoInteligentePL > 0 && !bProvieneDatos_OtraArea && (iSistema == SISTEMA_CAJAS || iSistema == SISTEMA_MUEBLES || iSistema == SISTEMA_ROPA))
		{
			CString sTextoCliente = "";
			m_cliente.GetWindowTextA(sTextoCliente);
			if (sTextoCliente.GetLength() < CARACTERES_CAMPO_INTELIGENTE)
			{
				m_cliente.ReplaceSel("@");
			}
		}
		return TRUE;
	}

	if (m_grid.lCliente > 0L)
	{
		iFlagServicio = 1;

		if (pMsg->message == WM_KEYDOWN)
		{
			if (pMsg->wParam == VK_F1)
			{
				if (iFoco == 1)
				{
					if (iTeclaAnterior != VK_CONTROL)
					{
						iOpcionTecleada = menuAyudaAbonos();
						m_grid.RedrawAll();
						if (iOpcionTecleada != 0)
						{
							pMsg->wParam = iOpcionTecleada;
							iTeclaAnterior = iOpcionTecleada;
							if (pMsg->wParam == VK_ESCAPE)
							{
								pMsg->wParam = NULL;
							}
						}

					}
				}
			}
			else
			{
				if (iFoco == 1)
				{
					if ((GetKeyState(VK_LCONTROL) & 0x8000) || (GetKeyState(VK_RCONTROL) & 0x8000)) // Ctrl presionado ...
					{
						switch (pMsg->wParam)
						{
						case VK_F6:
							{
								CString sNomCliente, sApellidoPaterno, sApellidoMaterno;
								char cSistema[3] = { 0 }, cCaja[5] = { 0 }, cCliente[12] = { 0 }, cTienda[5] = { 0 }, cEmpleado[10] = { 0 }, cUsuarioPT[25] = { 0 }, cPasswordPT[40] = { 0 };
								sNomCliente.Format("%s", cNombre);
								sNomCliente.Trim();
								sNomCliente.Replace(" ", "_");
								sApellidoPaterno.Format("%s", cApellidoPaterno);
								sApellidoPaterno.Trim();
								sApellidoPaterno.Replace(" ", "_");
								sApellidoMaterno.Format("%s", cApellidoMaterno);
								sApellidoMaterno.Trim();
								sApellidoMaterno.Replace(" ", "_");
								sprintf_s(cSistema, "%d", iSistema);
								sprintf_s(cCaja, "%d", m_grid.iCaja);
								sprintf_s(cCliente, "%ld", m_grid.lCliente);
								sprintf_s(cTienda, "%d", m_grid.iTienda);
								sprintf_s(cEmpleado, "%d", m_grid.lEmpleado);

								if (sNomCliente.IsEmpty())
								{
									sNomCliente = "_";
								}

								if (sApellidoPaterno.IsEmpty())
								{
									sApellidoPaterno = "_";
								}

								if (sApellidoMaterno.IsEmpty())
								{
									sApellidoMaterno = "_";
								}

								if (consultarIpServidor(&odbc, cIpServidorCentral, SERV_PROCERSOS_TIENDAS, cSqlTxt) == true)
								{
									C_ODBC odbc_His_Conv_Cliente; //Historias Convenio Cliente( Procesos_Tienda)

									if (abrirConexionBD(&odbc_His_Conv_Cliente, cIpServidorCentral, cIpServidorCentral, CONECTA_PROCESOSTIENDA_MULTISERVICIOS, m_grid.iTienda))
									{
										sprintf_s(cUsuarioPT, odbc_His_Conv_Cliente.m_strUsrName);
										sprintf_s(cPasswordPT, odbc_His_Conv_Cliente.m_strUsrPwd);
									}
									odbc_His_Conv_Cliente.Close();
								}

								//Manda llamar la dll para el historia del convenio por cliente 
								_spawnl(P_WAIT, "C:\\SYS\\PROGS\\PuenteToCSharp.EXE", "C:\\SYS\\PROGS\\PuenteToCSharp.exe.EXE", cIPServidorTiendaNumero, cTienda,
									"C:\\SYS\\PROGX\\CA\\CA0176.dll", "HistorialConvenioCliente.Form1", cEmpleado, cCaja, cCliente, sApellidoPaterno,
									sApellidoMaterno, sNomCliente, cSistema, cIpServidorCentral, "Procesos_Tienda", cUsuarioPT, cPasswordPT, NULL);
								return TRUE;
							}
							break;
						case VK_F3:
							//if( iSistema != SISTEMA_MUEBLES && iSistema != SISTEMA_ROPA )
							mostrarMovtosCliente();
							return TRUE;
							break;
						case VK_F4:
							MostrarSituacionesEnOpcion();
							return TRUE;
							break;
						case VK_F9:
							if (iFlagRegistroPL > 0
								&& iFlagCampoInteligentePL > 0
								&& !bProvieneDatos_OtraArea
								&& (iSistema == SISTEMA_CAJAS || iSistema == SISTEMA_MUEBLES || iSistema == SISTEMA_ROPA))
							{

								objPlanDeLealtad->capturarDatosCte(OPCION_FINALIZAR_NO_LIMPIAR_PL);
								//logica para que actualice los campos si actualizo
								sClientePL = objPlanDeLealtad->obtenerDatosCliente();
								if (sClientePL.iNumCliente > 0 && sClientePL.iNumCliente != 90001)
								{
									sDato.Format("%d", sClientePL.iNumCliente);
									m_cliente.SetWindowTextA(sDato);
								}
								sDato.Format("%s", sClientePL.cCorreo);
								if (!sDato.IsEmpty() && sDato != "@.")
								{
									m_correo.SetWindowTextA(objPlanDeLealtad->enmascararCorreo(sDato));
								}
								sDato.Format("%s", sClientePL.cCelular);
								if (!sDato.IsEmpty() && sDato != "0")
								{
									m_celular.SetWindowTextA(objPlanDeLealtad->enmascararCelular(sDato));
								}

								if (sClientePL.i64IduPlanLealtad > 0 && sClientePL.i16IduSubstatus != IDU_SUBESTATUS_BAJA)
								{
									char cTituloOpcion[1026] = { 0 };
									ConsultarCatalogoMensajeTienda(TITULO_OPCION_ACTUALIZAR, cTituloOpcion);
									sprintf_s(cOpcionPL, "%.50s", cTituloOpcion);
								}

								pMsg->wParam = NULL;
								return TRUE;
							}
							break;
						default:break;
						}
					}
				}
			}
		}


		if (iContador == 1)
		{
			{
				if (!bMostrarReestructura && desplegarDatosCliente() == 0)
				{
					inicializar();
					inicializarCaptura();
				}
				else
				{
					if (iSistema == SISTEMA_CAJAS /*&& iFlagTiendaLocal == 0*/ && iFlagMovimiento == 1)
					{
						obtenerFlag('C', FLAGC_REESTRUCTURA, iFlagReestructuraDisponible);
					}

					if (!bMostrarReestructura)
					{
						MensajeReestructuraDescuentoMora();
					}
					if (!bFormalizo)
					{
						m_cliente.SetReadOnly(true);
						m_grid.GotoCell(0, 21);
						iContador++;
					}
					else
					{
						bFormalizo = false;
						bMostrarReestructura = false;
						return true;
					}
				}

				if (m_grid.cArea == 'C')
				{
					if (fObtenerParametrosEncuesta())
					{
						fun_obtenerdescripcionestatus();
					}
				}
			}
		}
		else
		{
			m_grid.obtenerTotalAbono();
		}
	}
	else
	{
		iFlagServicio = 0;
		iContador = 0;

		if (pMsg->message == WM_SYSKEYDOWN) // Teclas virtuales
		{
			if (pMsg->wParam == VK_F10)
			{
				if (GetKeyState(VK_MENU) & 0x8000 || pMsg->wParam == VK_F10) //ELIMINO  ALT
					pMsg->wParam = VK_SHIFT;
				menuCajas(10);
				pMsg->wParam = NULL;
			}
		}
		if (iSistema == 4 || iSistema == 3 || iSistema == 2 || iSistema == 1)
		{
			if (pMsg->wParam == VK_F11 && iFoco == 0
				&& pMsg->message == 256) // para diferenciar 'z' con VK_F11
			{
				if (LeerTarjeta(0, cPaso))
				{
					pMsg->wParam = NULL;
					PostMessage(WM_KEYDOWN, VK_RETURN);

					iniciarMovimientoOperacion();//PET-20275
				}
				else
				{
					if (lClienteDlg <= 0 && strlen(cPaso) > 0)
					{
						AfxMessageBox(cPaso);
					}
				}
				return TRUE;
			}
		}
		if (pMsg->message == WM_KEYDOWN)
		{
			if (iFoco == 0)
			{
				if ((GetKeyState(VK_LCONTROL) & 0x8000) || (GetKeyState(VK_RCONTROL) & 0x8000))
				{
					switch (pMsg->wParam)
					{
					case VK_F1:
						menuCajas(11);
						pMsg->wParam = NULL;
						break;
					case VK_F2:
						menuCajas(12);
						pMsg->wParam = NULL;
						break;
					case VK_F3:
						menuCajas(13);
						pMsg->wParam = NULL;
						break;
					case VK_F4:
						menuCajas(14);
						pMsg->wParam = NULL;
						break;
					case VK_F5:
						menuCajas(15);
						pMsg->wParam = NULL;
						return TRUE;
						break;
					case VK_F7:
						if (iFlagContactoEfectivo == 1)
						{
							menuCajas(17);
							pMsg->wParam = NULL;
						}
						break;
					case VK_RIGHT:
						if (iFlagCampoInteligentePL == 1)
						{
							m_grid.MoveCurrentCol(0);
							pMsg->wParam = NULL;
						}
						break;
					case VK_F9:
						if (iFlagRegistroPL > 0 && iFlagCampoInteligentePL > 0 && iSistema == SISTEMA_CAJAS)
						{
							objPlanDeLealtad->capturarDatosCte(OPCION_FINALIZAR_NO_LIMPIAR_PL);
							//logica para que actualice los campos si actualizo
							sClientePL = objPlanDeLealtad->obtenerDatosCliente();
							if (sClientePL.iNumCliente > 0 && sClientePL.iNumCliente != 90001)
							{
								sDato.Format("%d", sClientePL.iNumCliente);
								m_cliente.SetWindowTextA(sDato);
							}
							sDato.Format("%s", sClientePL.cCorreo);
							if (!sDato.IsEmpty() && sDato != "@.")
							{
								m_correo.SetWindowTextA(objPlanDeLealtad->enmascararCorreo(sDato));
							}
							sDato.Format("%s", sClientePL.cCelular);
							if (!sDato.IsEmpty() && sDato != "0")
							{
								m_celular.SetWindowTextA(objPlanDeLealtad->enmascararCelular(sDato));
							}
							pMsg->wParam = NULL;
						}
						else if (iFlagRegistroPL > 0 && iFlagCampoInteligentePL > 0
							&& !bProvieneDatos_OtraArea && (iSistema == SISTEMA_ROPA || iSistema == SISTEMA_MUEBLES))
						{
							objPlanDeLealtad->capturarDatosCte(OPCION_FINALIZAR_NO_LIMPIAR_PL);
							//logica para que actualice los campos si actualizo
							sClientePL = objPlanDeLealtad->obtenerDatosCliente();
							if (sClientePL.iNumCliente > 0 && sClientePL.iNumCliente != 90001)
							{
								sDato.Format("%d", sClientePL.iNumCliente);
								m_cliente.SetWindowTextA(sDato);
							}
							sDato.Format("%s", sClientePL.cCorreo);
							if (!sDato.IsEmpty() && sDato != "@.")
							{
								m_correo.SetWindowTextA(objPlanDeLealtad->enmascararCorreo(sDato));
							}
							sDato.Format("%s", sClientePL.cCelular);
							if (!sDato.IsEmpty() && sDato != "0")
							{
								m_celular.SetWindowTextA(objPlanDeLealtad->enmascararCelular(sDato));
							}
							pMsg->wParam = NULL;
						}
						break;
					default:
						break;
					}
				}
				else
				{
					{
						switch (pMsg->wParam)
						{
						case F1:
						case F2:
						case F3:
						case F4:
						case F5:
						case F6:
							menuCajas((int)pMsg->wParam);
							pMsg->wParam = NULL;
							break;
						case F7:
							m_cliente.GetWindowText(sDato);
							sDato.Trim();
							if (atol(sDato) > 0)
							{
								PostMessage(WM_KEYDOWN, VK_RETURN);
								if (iSistema != SISTEMA_MUEBLES && iSistema != SISTEMA_ROPA)
									PostMessage(WM_KEYDOWN, VK_F7);
								return TRUE;
							}
							else
							{
								menuCajas((int)pMsg->wParam);
								pMsg->wParam = NULL;
							}
							break;
						case F8:
						case F9:

							menuCajas((int)pMsg->wParam);
							pMsg->wParam = NULL;
							break;
						default:
							break;
						}
					}
				}
			}
		}
	}
	if (m_grid.lCliente > 0L)
	{
		iColumna = m_grid.GetCurrentCol();
		if (iColumna + 1 == iTotalCuentas)
		{
			sDato.Format("          <-- ");
			m_flecha.SetWindowText(sDato);
		}
		else
		{
			if (iColumna + 1 <= 8)
			{
				sDato.Format(" + Cuentas --> ");
				m_flecha.SetWindowText(sDato);
			}
			else
			{
				sDato.Format("          --> ");
				m_flecha.SetWindowText(sDato);
			}
		}

		if (iTotalCuentas > 0)
		{
			sDato.Format("%d de %d", iColumna + 1, iTotalCuentas);
		}
		else
		{
			sDato = "0 de 0";
		}
		m_grid2.QuickSetText(0, 1, sDato);
		m_grid2.QuickSetAlignment(0, 1, UG_ALIGNCENTER);
		m_grid2.RedrawAll();

		if (iFoco == 1) //este en el grid
		{
			iColX = m_grid.GetCurrentCol(); //obtener la columna donde esta posicionado
			m_grid.QuickGetText(iColX, -1, &sConcepto);
			sConcepto.Trim();
			sprintf_s(cTxt, "%s", (LPCTSTR)sConcepto);

			if (memcmp(cTxt, "PLAN MOVISTAR", 13) == 0)
			{
				if (iCandidatoAprobado == 1)
				{
					sprintf_s(cBarraOpciones, " [CTRL+F3]  PANTALLA DE MOVIMIENTOS [F9] ABONO PLAN TARIFARIO [F12] PLAN PONTE AL DÍA");
				}
				else {
					sprintf_s(cBarraOpciones, " [CTRL+F3]  PANTALLA DE MOVIMIENTOS [F9] ABONO PLAN TARIFARIO");
				}
			}
			else
			{
				if (bFlagSituacionesInformativas)
				{
					if (iFlagReestructuraDisponible == 1 && (bClienteReestructurado || bMostrarReestructura))
					{
						cFechaNacimientoCliente.Format("%d-%d-%d", iAnioNacimiento, iMesNacimiento, iDiaNacimiento);
						cJsonConfiguracion.Format("{'ServidorCartera':'%s','Tienda':{'ServidorTienda':'%s','Numero':%d},'OrigenLlamada':%d,'Cajero':%ld,'Ciudad':%d,'Caja':%d, 'CajaOriginal':%d, 'Area':'%c' }", cIpServidorCartera, m_grid.sServer, m_grid.iTienda, 3, m_grid.lEmpleado, iCiudadGnDominio, iCajaActual, iCajaOriginal, m_grid.cArea);
						cJsonReestructura.Format("{'Producto':{'NumeroProducto':%d},'Cliente':{'IduCliente':%d,'Nombre':'%s','ApellidoPaterno':'%s','ApellidoMaterno':'%s','FechaNacimiento':'%s'}}", -1, m_grid.lCliente, cNombre, cApellidoPaterno, cApellidoMaterno, cFechaNacimientoCliente);
						cJsonConfiguracion.Replace(' ', '_');
						cJsonReestructura.Replace(' ', '_');
						cJsonParams.Format("%s %s", cJsonConfiguracion, cJsonReestructura);

						if (iCandidatoAprobado == 1)
						{
							sprintf_s(cBarraOpciones, "[CTRL+F3] PANTALLA DE MOVIMIENTOS [CTRL+F4] MOSTRAR INFORMATIVAS [CTRL+F8] PLAN PAGA MÁS FÁCIL [F12] PLAN PONTE AL DÍA");
						}
						else
						{
							sprintf_s(cBarraOpciones, "[CTRL+F3]  PANTALLA DE MOVIMIENTOS    [CTRL+F4]  MOSTRAR INFORMATIVAS    [CTRL+F8] PLAN PAGA MÁS FÁCIL ");
						}

						if (GetKeyState(VK_CONTROL) & 0x8000 && pMsg->wParam == VK_F8)
						{
							iLevantoReestructura++;
							if (iLevantoReestructura == 1)
							{
								cJsonParams.Replace("'OrigenLlamada':1", "'OrigenLlamada':3");
								_spawnl(P_WAIT, PATH_PUENTETOCS, PATH_PUENTETOCS, m_grid.sServer, inoTienda, PATH_REESTTRUCTURA_DLL, NOMBRE_FUNCION_INICIAL, cJsonParams, NULL);
							}
							else
							{
								iLevantoReestructura = 0;
							}

							return true;
						}
					}
					else
					{
						if (iFlagRegistroPL > 0 && iFlagCampoInteligentePL > 0 && !bProvieneDatos_OtraArea
							&& (iSistema == SISTEMA_CAJAS || iSistema == SISTEMA_MUEBLES || iSistema == SISTEMA_ROPA))
						{
							if (iCandidatoAprobado == 1)
							{
								sprintf_s(cBarraOpciones, " [CTRL+F3]  PANTALLA DE MOVIMIENTOS      [CTRL+F4]  MOSTRAR INFORMATIVAS [CTRL+F9] %.50s  [F12] PLAN PONTE AL DÍA", cOpcionPL);
							}
							else
							{
								sprintf_s(cBarraOpciones, " [CTRL+F3]  PANTALLA DE MOVIMIENTOS      [CTRL+F4]  MOSTRAR INFORMATIVAS [CTRL+F9] %.50s  [F12] PLAN PONTE AL DÍA", cOpcionPL);
							}


						}
						else
						{
							if (iCandidatoAprobado == 1)
							{
								sprintf_s(cBarraOpciones, " [CTRL+F3]  PANTALLA DE MOVIMIENTOS      [CTRL+F4]  MOSTRAR INFORMATIVAS  [F12] PLAN PONTE AL DÍA");
							}
							else
							{
								sprintf_s(cBarraOpciones, " [CTRL+F3]  PANTALLA DE MOVIMIENTOS      [CTRL+F4]  MOSTRAR INFORMATIVAS");
							}
						}

					}
				}
				else
				{
					if (bMostrarReestructura && iFlagReestructuraDisponible == 1)
					{

						if (iCandidatoAprobado == 1)
						{
							sprintf_s(cBarraOpciones, "[CTRL+F6] CONSULTAR HISTORIAL DE CONV [CTRL+F3] PANTALLA DE MOVIMIENTOS [CTRL+F8] PLAN PAGA MÁS FÁCIL [F12] PLAN PONTE AL DÍA");
						}
						else
						{
							sprintf_s(cBarraOpciones, "[CTRL+F6] CONSULTAR HISTORIAL DE CONV.  [CTRL+F3]  PANTALLA DE MOVIMIENTOS.  [CTRL+F8] PLAN PAGA MÁS FÁCIL ");
						}
						if (GetKeyState(VK_CONTROL) & 0x8000 && pMsg->wParam == VK_F8)
						{
							iLevantoReestructura++;
							if (iLevantoReestructura == 1)
							{
								cJsonParams.Replace("'OrigenLlamada':1", "'OrigenLlamada':3");
								_spawnl(P_WAIT, PATH_PUENTETOCS, PATH_PUENTETOCS, m_grid.sServer, inoTienda, PATH_REESTTRUCTURA_DLL, NOMBRE_FUNCION_INICIAL, cJsonParams, NULL);
								CReestructuracion oRestructura(m_grid.lCliente);
								if (oRestructura.ValidaFormalizoReestructura() == 1)
								{
									bFormalizo = true;
									inicializar();
									inicializarCaptura();
								}
							}
							else
							{
								iLevantoReestructura = 0;
							}
							return true;
						}
					}
					else if (bClienteReestructurado && iFlagReestructuraDisponible == 1)
					{
						cFechaNacimientoCliente.Format("%d-%d-%d", iAnioNacimiento, iMesNacimiento, iDiaNacimiento);
						cJsonConfiguracion.Format("{'ServidorCartera':'%s','Tienda':{'ServidorTienda':'%s','Numero':%d},'OrigenLlamada':%d,'Cajero':%ld,'Ciudad':%d,'Caja':%d,'CajaOriginal':%d,'Area':'%c'}", cIpServidorCartera, m_grid.sServer, m_grid.iTienda, 3, m_grid.lEmpleado, iCiudadGnDominio, iCajaActual, iCajaOriginal, m_grid.cArea);
						cJsonReestructura.Format("{'Producto':{'NumeroProducto':%d},'Cliente':{'IduCliente':%d,'Nombre':'%s','ApellidoPaterno':'%s','ApellidoMaterno':'%s','FechaNacimiento':'%s'}}", -1, m_grid.lCliente, cNombre, cApellidoPaterno, cApellidoMaterno, cFechaNacimientoCliente);
						cJsonConfiguracion.Replace(' ', '_');
						cJsonReestructura.Replace(' ', '_');
						cJsonParams.Format("%s %s", cJsonConfiguracion, cJsonReestructura);

						if (iCandidatoAprobado == 1)
						{
							sprintf_s(cBarraOpciones, "[CTRL+F6] CONSULTAR HISTORIAL DE CONV [CTRL+F3] PANTALLA DE MOVIMIENTOS [CTRL+F8] PLAN PAGA MÁS FÁCIL [F12] PLAN PONTE AL DÍA ");
						}
						else
						{
							sprintf_s(cBarraOpciones, "[CTRL+F6] CONSULTAR HISTORIAL DE CONV.  [CTRL+F3]  PANTALLA DE MOVIMIENTOS.  [CTRL+F8] PLAN PAGA MÁS FÁCIL ");
						}

						if (GetKeyState(VK_CONTROL) & 0x8000 && pMsg->wParam == VK_F8)
						{
							iLevantoReestructura++;
							if (iLevantoReestructura == 1)
							{
								cJsonParams.Replace("'OrigenLlamada':1", "'OrigenLlamada':3");
								_spawnl(P_WAIT, PATH_PUENTETOCS, PATH_PUENTETOCS, m_grid.sServer, inoTienda, PATH_REESTTRUCTURA_DLL, NOMBRE_FUNCION_INICIAL, cJsonParams, NULL);
							}
							else
							{
								iLevantoReestructura = 0;
							}

							return true;
						}
					}
					else
					{
						if (iFlagRegistroPL > 0 && iFlagCampoInteligentePL > 0 && !bProvieneDatos_OtraArea
							&& (iSistema == SISTEMA_MUEBLES || iSistema == SISTEMA_ROPA || iSistema == SISTEMA_CAJAS))
						{
							if (iCandidatoAprobado == 1)
							{
								sprintf_s(cBarraOpciones, "[CTRL+F6] CONSULTAR HISTORIAL DE CONV.   [CTRL+F3]  PANTALLA DE MOVIMIENTOS   [CTRL+F9] %.50s  [F12] PLAN PONTE AL DÍA", cOpcionPL);
								//ponerMensajeNR( this, m_barra, m_mensaje1,cBarraOpciones);
							}
							else
							{
								sprintf_s(cBarraOpciones, "[CTRL+F6] CONSULTAR HISTORIAL DE CONV.   [CTRL+F3]  PANTALLA DE MOVIMIENTOS   [CTRL+F9] %.50s", cOpcionPL);
								//ponerMensajeNR( this, m_barra, m_mensaje1,cBarraOpciones);
							}
						}
						else
						{
							if (iCandidatoAprobado == 1)
							{
								sprintf_s(cBarraOpciones, "[CTRL+F6] CONSULTAR HISTORIAL DE CONV.   [CTRL+F3]  PANTALLA DE MOVIMIENTOS  [F12] PLAN PONTE AL DÍA");
							}
							else
							{
								sprintf_s(cBarraOpciones, "[CTRL+F6] CONSULTAR HISTORIAL DE CONV.   [CTRL+F3]  PANTALLA DE MOVIMIENTOS");
							}
						}
					}
				}
			}
			ponerMensajeNR(this, m_barra, m_mensaje1, cBarraOpciones);

			if (pMsg->wParam == VK_F12)
			{
				CargarCA0230();
			}
		}
	}
	ShiftTab = false;

	if (m_grid.lCliente == 0L && (pMsg->message == WM_KEYDOWN || pMsg->message == WM_SYSKEYDOWN))
	{
		//if ( iFoco != 0 )
		if (!funVerificarFoco(IDC_CLIENTE))
		{
			iFoco = 0;
			asignarFoco();
		}
	}

	if (m_grid.bFocoGrid == true && m_grid.bLlenarGrid == false)
	{
		iFoco = 0;
		asignarFoco();
	}

	if (pMsg->message == WM_SYSKEYDOWN) // Teclas virtuales
	{
		if (GetKeyState(VK_MENU) & 0x8000 || pMsg->wParam == VK_F10) //ELIMINO  ALT
			pMsg->wParam = VK_SHIFT;
	}

	if (m_grid.bFocoGrid == false)
	{
		if (pMsg->message == WM_KEYDOWN)
		{
			if (pMsg->wParam == VK_LEFT || pMsg->wParam == VK_UP)
			{
				iFoco--;
				if (iFoco < 0)
				{
					iFoco = 0;
				}
				if (m_grid.lCliente > 0L)
				{
					iFoco = 1;
				}
				asignarFoco();
			}

			if (iFlagCampoInteligentePL == 1 && pMsg->wParam == VK_RIGHT)
			{
				m_grid.MoveCurrentCol(0);
			}
			else
			{
				if (pMsg->wParam == VK_RETURN || pMsg->wParam == VK_TAB || pMsg->wParam == VK_DOWN || pMsg->wParam == VK_RIGHT)
				{
					{
						if (pMsg->wParam == VK_RETURN)
						{
							m_grid.MoveCurrentCol(1);
						}


						if (iFoco <= iControles) //numero de controles
						{
							if (validarCaja())
							{
								if (validarControl(cPaso))
								{
									iFoco++;
									if (iFoco > 1) iFoco = 1;
									asignarFoco();
								}
								else
								{
									if (iFlagMensajeHuella == 0)
									{
										if (!ShiftTab)
										{
											if (strcmp(cPaso, "") != 0)
											{
												AfxMessageBox(cPaso);
											}
										}
									}
								}
							}

							else
							{
								bFlagSalirXCaja = true;
								CDialog2012::OnCancel();
							}
							return TRUE;
						}
						else
						{
							if (pMsg->wParam != VK_RETURN)
							{
								iFoco++;
								if (iFoco > 1) iFoco = 1;
								asignarFoco();
							}
							else
							{
								asignarFoco();
							}
							return TRUE;
						}
					}
				}
				else
				{
					if (pMsg->wParam == VK_TAB && GetKeyState(VK_SHIFT) & 0x8000)
					{
						ShiftTab = true;
					}
					else
					{
						switch (pMsg->wParam)
						{
						case VK_PRIOR:
							m_grid.MoveCurrentCol(0);
							break;
						case VK_NEXT:
							m_grid.MoveCurrentCol(1);
							break;
						case VK_UP:
							m_grid.MoveCurrentCol(0);
							break;
						case VK_DOWN:
							m_grid.MoveCurrentCol(1);
							break;
						case VK_LEFT:
							m_grid.MoveCurrentCol(0);
							break;
						case VK_RIGHT:
							m_grid.MoveCurrentCol(0);
							break;
						case VK_F3:
							if (iFoco == 1 && iSistema == 3) //esta en el grid
							{

								ValidarExisteConvenio();//
								iColX = m_grid.GetCurrentCol(); //obtener la columna donde esta posicionado

								if (iTotalConvenio == 0 && cPuntualidad[0] != 'Z' && bCliente_Abogado_Externo != true)
								{
									if (iSistema != 3 && iSistema != 2 && iSistema != 1)
									{
										AfxMessageBox("SOLO SE PUEDEN REALIZAR CONVENIOS DESDE EL AREA DE MUEBLES , ROPA Y CAJAS DE ABONOS");//modifico

									}
									else
									{
										iColX = m_grid.GetCurrentCol(); //obtener la columna donde esta posicionado
										m_grid.QuickGetText(iColX, 15, &sVencidoX);
										sVencidoX.Remove('.');
										sVencidoX.Remove(',');
										sprintf_s(cTexto, "%s", (LPCTSTR)sVencidoX);

										m_grid.QuickGetText(iColX, -1, &sConcepto);
										sConcepto.Trim();
										sprintf_s(cTxt, "%s", (LPCTSTR)sConcepto);

										if (atol(cTexto) > 0L && (memcmp(cTxt, "SEGURO", 6) != 0 && memcmp(cTxt, "P.FAMILIAR", 10) != 0 && memcmp(cTxt, "CREDITO Y CASA", 14) != 0 && memcmp(cTxt, "PLAN MOVISTAR", 13) != 0)
											&& memcmp(cTxt, "SEG. MOTOS", 10) != 0 && memcmp(cTxt, "P. CELULAR", 10) != 0)
										{
											capturarConvenio();
											m_grid.RedrawAll();
											pMsg->wParam = NULL;
											iTotalConv++;
										}
										else
										{
											if (memcmp(cTxt, "SEGURO", 6) == 0 || memcmp(cTxt, "P.FAMILIAR", 10) == 0)
											{
												AfxMessageBox(" NO PROCEDE EL CONVENIO EN SEGUROS DE VIDA ");
											}

											if (memcmp(cTxt, "CREDITO Y CASA", 14) == 0)
											{
												AfxMessageBox(" NO PROCEDE EL CONVENIO EN CREDITO Y CASA ");
											}

											if (memcmp(cTxt, "PLAN MOVISTAR", 13) == 0)
											{
												AfxMessageBox(" NO PROCEDE EL CONVENIO EN PLANES MOVISTAR ");
											}

											if (memcmp(cTxt, "SEG. MOTOS", 10) == 0 )
											{
												AfxMessageBox(" NO PROCEDE EL CONVENIO EN SEGURO MOTO ");
											}

											if (memcmp(cTxt, "P. CELULAR", 10) == 0 )
											{
												AfxMessageBox(" NO PROCEDE EL CONVENIO EN SEGURO CELULAR ");
											}
										}
									}
								}
								else
								{
									if ((memcmp(cTxt, "SEGURO", 6) != 0 && memcmp(cTxt, "P.FAMILIAR", 10) != 0 && memcmp(cTxt, "CREDITO Y CASA", 14) != 0 && memcmp(cTxt, "PLAN MOVISTAR", 13) != 0)
										&& memcmp(cTxt, "SEG. MOTOS", 10) != 0 && memcmp(cTxt, "P. CELULAR", 10) != 0)
									{
										if (iTotalConvenio > 0)
										{
											AfxMessageBox(" EL DIA DE HOY USTED YA REALIZÓ UN CONVENIO A ESTE CLIENTE ");
										}
										else
										{
											if (cPuntualidad[0] == 'Z')
											{
												AfxMessageBox(" NO ES POSIBLE REALIZAR CONVENIO A CLIENTES EN CUENTAS PERDIDAS ");
											}
											else
											{
												AfxMessageBox(" CLIENTE SOLO PUEDE REALIZAR CONVENIO CON ABOGADO EXTERNO ");
											}
										}
									}
									else
									{
										if (memcmp(cTxt, "SEGURO", 6) == 0 || memcmp(cTxt, "P.FAMILIAR", 10) == 0)
										{
											AfxMessageBox(" NO PROCEDE EL CONVENIO EN SEGUROS DE VIDA ");
										}

										if (memcmp(cTxt, "CREDITO Y CASA", 14) == 0)
										{
											AfxMessageBox(" NO PROCEDE EL CONVENIO EN CREDITO Y CASA ");
										}

										if (memcmp(cTxt, "PLAN MOVISTAR", 13) == 0)
										{
											AfxMessageBox(" NO PROCEDE EL CONVENIO EN PLANES MOVISTAR ");
										}

										if (memcmp(cTxt, "SEG. MOTOS", 10) == 0 )
										{
											AfxMessageBox(" NO PROCEDE EL CONVENIO EN SEGURO MOTO ");
										}

										if (memcmp(cTxt, "P. CELULAR", 10) == 0 )
										{
											AfxMessageBox(" NO PROCEDE EL CONVENIO EN SEGURO CELULAR ");
										}
									}
								}
							}
							break;
						case VK_F5:
							{
								iColX = m_grid.GetCurrentCol(); //obtener la columna donde esta posicionado
								m_grid.QuickGetText(iColX, -1, &sConcepto);
								sConcepto.Trim();
								sprintf_s(cTxt, "%s", (LPCTSTR)sConcepto);

								if (memcmp(cTxt, "SEGURO", 6) == 0 || memcmp(cTxt, "P.FAMILIAR", 10) == 0)
								{
									if (memcmp(cTxt, "SEGURO", 6) == 0)
									{
										iFlagClub = 0;
									}
									else
									{
										iFlagClub = 1;
									}
									m_grid.QuickGetText(iColX, 1, &sTexto);
									sTexto.Trim();
									sprintf_s(cTxt, "%s", (LPCTSTR)sTexto);

									if (cTxt > 0L) //numero de factura
									{
										if (iFlagMovimiento == 0)
										{
											//Se trata de un Cargo
											AfxMessageBox(" DEBE ESTAR EN LA OPCION DE ABONOS ");
										}
										else
										{
											menuSegurosDeVida();
										}
									}
								}
								if (pMsg->wParam == VK_ESCAPE || pMsg->wParam == VK_F10)
								{
									pMsg->wParam = NULL;
								}
							}
							m_grid.RedrawAll();
							break;
						case VK_F2:
							if (m_grid.bEdicion == true)
							{
								PostMessage(WM_KEYDOWN, VK_RETURN);
								PostMessage(WM_KEYDOWN, VK_F2);
								return TRUE;
							}

							m_grid.obtenerTotalAbono();
							pedirPago();

							pMsg->wParam = NULL;
							break;
						case VK_F8:
							if (iFoco == 1 && iSistema != 3) //esta en el grid
							{

								ValidarExisteConvenio();//
								iColX = m_grid.GetCurrentCol(); //obtener la columna donde esta posicionado

								if (iTotalConvenio == 0 && cPuntualidad[0] != 'Z' && bCliente_Abogado_Externo != true)
								{
									if (iSistema != 3 && iSistema != 2 && iSistema != 1)
									{
										AfxMessageBox("SOLO SE PUEDEN REALIZAR CONVENIOS DESDE EL AREA DE MUEBLES , ROPA Y CAJAS DE ABONOS");//modifico

									}
									else
									{
										iColX = m_grid.GetCurrentCol(); //obtener la columna donde esta posicionado
										m_grid.QuickGetText(iColX, 15, &sVencidoX);
										sVencidoX.Remove('.');
										sVencidoX.Remove(',');
										sprintf_s(cTexto, "%s", (LPCTSTR)sVencidoX);

										m_grid.QuickGetText(iColX, -1, &sConcepto);
										sConcepto.Trim();
										sprintf_s(cTxt, "%s", (LPCTSTR)sConcepto);

										if (atol(cTexto) > 0L && (memcmp(cTxt, "SEGURO", 6) != 0 && memcmp(cTxt, "P.FAMILIAR", 10) != 0 && memcmp(cTxt, "CREDITO Y CASA", 14) != 0 && memcmp(cTxt, "PLAN MOVISTAR", 13) != 0))
										{
											capturarConvenio();
											m_grid.RedrawAll();
											pMsg->wParam = NULL;
											iTotalConv++;

										}
										else
										{
											if (memcmp(cTxt, "SEGURO", 6) == 0 || memcmp(cTxt, "P.FAMILIAR", 10) == 0)
											{
												AfxMessageBox(" NO PROCEDE EL CONVENIO EN SEGUROS DE VIDA ");
											}

											if (memcmp(cTxt, "CREDITO Y CASA", 14) == 0)
											{
												AfxMessageBox(" NO PROCEDE EL CONVENIO EN CREDITO Y CASA ");
											}

											if (memcmp(cTxt, "PLAN MOVISTAR", 13) == 0)
											{
												AfxMessageBox(" NO PROCEDE EL CONVENIO EN PLANES MOVISTAR ");
											}
										}
									}
								}
								else
								{
									if ((memcmp(cTxt, "SEGURO", 6) != 0 && memcmp(cTxt, "P.FAMILIAR", 10) != 0 && memcmp(cTxt, "CREDITO Y CASA", 14) != 0 && memcmp(cTxt, "PLAN MOVISTAR", 13) != 0))
									{
										if (iTotalConvenio > 0)
										{
											AfxMessageBox(" EL DIA DE HOY USTED YA REALIZÓ UN CONVENIO A ESTE CLIENTE ");
										}
										else
										{
											if (cPuntualidad[0] == 'Z')
											{
												AfxMessageBox(" NO ES POSIBLE REALIZAR CONVENIO A CLIENTES EN CUENTAS PERDIDAS ");
											}
											else
											{
												AfxMessageBox(" CLIENTE SOLO PUEDE REALIZAR CONVENIO CON ABOGADO EXTERNO ");
											}
										}
									}
									else
									{
										if (memcmp(cTxt, "SEGURO", 6) == 0 || memcmp(cTxt, "P.FAMILIAR", 10) == 0)
										{
											AfxMessageBox(" NO PROCEDE EL CONVENIO EN SEGUROS DE VIDA ");
										}

										if (memcmp(cTxt, "CREDITO Y CASA", 14) == 0)
										{
											AfxMessageBox(" NO PROCEDE EL CONVENIO EN CREDITO Y CASA ");
										}

										if (memcmp(cTxt, "PLAN MOVISTAR", 13) == 0)
										{
											AfxMessageBox(" NO PROCEDE EL CONVENIO EN PLANES MOVISTAR ");
										}
									}
								}
							}
							break;
						case VK_F9:
							{
								if (iFoco == 1) //este en el grid
								{
									iColX = m_grid.GetCurrentCol(); //obtener la columna donde esta posicionado
									m_grid.QuickGetText(iColX, -1, &sConcepto);
									sConcepto.Trim();
									sprintf_s(cTxt, "%s", (LPCTSTR)sConcepto);

									if (memcmp(cTxt, "PLAN MOVISTAR", 13) == 0)
									{
										if (m_grid.cArea == 'C')
										{
											pagoAbonosPlanMovistar();
										}
										else
										{
											AfxMessageBox("SOLO SE PUEDE ABONAR A PLANES MOVISTAR EN EL AREA DE CAJAS DE ABONOS");
										}
									}
								}
							}
							break;
						case VK_ESCAPE:
							GuardaHit(0);
							if (m_grid.lCliente <= 0)
							{
								grabarLog("CDlgCapturarAbono:: Sale de la pantalla de abonos");
								CDialog2012::OnCancel();
							}

							inicializar();
							inicializarCaptura();
							break;
						default:
							break;
						}
					}
				}
			}
		}
	}
	else
	{
		if (pMsg->message == WM_KEYDOWN)
		{
			CString sFlagServicio, sCuentasTelefono, sCuentasCFE, sCantidadRecibo, sCiudad, sCuentasGasNatural;

			sFlagServicio.Format("%d", iFlagServicio);
			sCuentasTelefono.Format("0");
			sCuentasCFE.Format("0");
			sCuentasGasNatural.Format("0");
			sCantidadRecibo.Format("0");
			sCiudad.Format("%d", iCiudadGnDominio);

			if (iOpcionTecleada == 0)
			{
				iOpcionTecleada = (int)pMsg->wParam;
			}

			else if ((iSistema == SISTEMA_MUEBLES || iSistema == SISTEMA_ROPA))
			{
				switch (iOpcionTecleada)
				{
				case F3:
					iOpcionTecleada = VK_F6;//VK_F6;
					break;

				case F4:
					iOpcionTecleada = VK_F7;
					break;

				case F5:
					iOpcionTecleada = VK_F8;
					break;

				case F6:
					iOpcionTecleada = VK_F9;
					break;

				case F7:
					if (iTeclaAnterior == VK_CONTROL)
					{
						if (m_grid.lCliente == 0L)
						{
							iOpcionTecleada = 0;
							pMsg->wParam = NULL;
						}
						else
						{
							{
								if ((iSistema == SISTEMA_ROPA && iFlagMenuDomiciliacionDeRopa == 1) || (iSistema == SISTEMA_MUEBLES && iFlagMenuDomiciliacionDeMuebles == 1))
								{
									if (iFlagTiendaLocal == 0)
									{
										CargarMenuDomiciliacion();
									}
									else
									{
										AfxMessageBox("LA TIENDA SE ENCUENTRA EN MODO LOCAL");
									}

								}
							}
						}
					}
					else
					{
						if (iBuscarCliente == 0)
							calculadora();
						//iOpcionTecleada = 0;
						//pMsg->wParam = NULL;
					}
					iOpcionTecleada = 0;
					pMsg->wParam = NULL;
					break;

				case ESC:
					iOpcionTecleada = VK_ESCAPE;
					break;
				case F8:
					iOpcionTecleada = VK_F3;
					break;
				case F1:
				case F9:
				case F10:
				case CTRL_F1:
					iOpcionTecleada = 0;
					pMsg->wParam = NULL;
					break;
				case CTRL_F3:
					mostrarMovtosCliente();
					iOpcionTecleada = 0;
					pMsg->wParam = NULL;
					break;
				default:
					break;
				}
			}

			switch (iOpcionTecleada)
			{
			case VK_F2: //imprimir y grabar abono
				if (m_grid.bEdicion == true)
				{
					PostMessage(WM_KEYDOWN, VK_RETURN);
					PostMessage(WM_KEYDOWN, VK_F2);
					return TRUE;
				}

				m_grid.obtenerTotalAbono();
				pedirPago();

				pMsg->wParam = NULL;
				break;
			case VK_F3:
				if (iFoco == 1) //esta en el grid
				{
					ValidarExisteConvenio();//
					iColX = m_grid.GetCurrentCol(); //obtener la columna donde esta posicionado

					if (iTotalConvenio == 0 && cPuntualidad[0] != 'Z' && bCliente_Abogado_Externo != true)
					{
						if (iSistema != 3 && iSistema != 2 && iSistema != 1)
						{
							AfxMessageBox("SOLO SE PUEDEN REALIZAR CONVENIOS DESDE EL AREA DE MUEBLES , ROPA Y CAJAS DE ABONOS");//modifico
						}
						else
						{
							iColX = m_grid.GetCurrentCol(); //obtener la columna donde esta posicionado
							m_grid.QuickGetText(iColX, 15, &sVencidoX);
							sVencidoX.Remove('.');
							sVencidoX.Remove(',');
							sprintf_s(cTexto, "%s", (LPCTSTR)sVencidoX);

							m_grid.QuickGetText(iColX, -1, &sConcepto);
							sConcepto.Trim();
							sprintf_s(cTxt, "%s", (LPCTSTR)sConcepto);

							if (atol(cTexto) > 0L && (memcmp(cTxt, "SEGURO", 6) != 0 && memcmp(cTxt, "P.FAMILIAR", 10) != 0 && memcmp(cTxt, "CREDITO Y CASA", 14) != 0 && memcmp(cTxt, "PLAN MOVISTAR", 13) != 0))
							{								
								capturarConvenio();
								m_grid.RedrawAll();
								pMsg->wParam = NULL;
								iTotalConv++;
							}
							else
							{
								if (memcmp(cTxt, "SEGURO", 6) == 0 || memcmp(cTxt, "P.FAMILIAR", 10) == 0)
								{
									AfxMessageBox(" NO PROCEDE EL CONVENIO EN SEGUROS DE VIDA ");
								}

								if (memcmp(cTxt, "CREDITO Y CASA", 14) == 0)
								{
									AfxMessageBox(" NO PROCEDE EL CONVENIO EN CREDITO Y CASA ");
								}

								if (memcmp(cTxt, "PLAN MOVISTAR", 13) == 0)
								{
									AfxMessageBox(" NO PROCEDE EL CONVENIO EN PLANES MOVISTAR ");
								}
							}
						}
					}
					else
					{
						if ((memcmp(cTxt, "SEGURO", 6) != 0 && memcmp(cTxt, "P.FAMILIAR", 10) != 0 && memcmp(cTxt, "CREDITO Y CASA", 14) != 0 && memcmp(cTxt, "PLAN MOVISTAR", 13) != 0))
						{
							if (iTotalConvenio > 0)
							{
								AfxMessageBox(" EL DIA DE HOY USTED YA REALIZÓ UN CONVENIO A ESTE CLIENTE ");
							}
							else
							{
								if (cPuntualidad[0] == 'Z')
								{
									AfxMessageBox(" NO ES POSIBLE REALIZAR CONVENIO A CLIENTES EN CUENTAS PERDIDAS ");
								}
								else
								{
									AfxMessageBox(" CLIENTE SOLO PUEDE REALIZAR CONVENIO CON ABOGADO EXTERNO ");
								}
							}
						}
						else
						{
							if (memcmp(cTxt, "SEGURO", 6) == 0 || memcmp(cTxt, "P.FAMILIAR", 10) == 0)
							{
								AfxMessageBox(" NO PROCEDE EL CONVENIO EN SEGUROS DE VIDA ");
							}

							if (memcmp(cTxt, "CREDITO Y CASA", 14) == 0)
							{
								AfxMessageBox(" NO PROCEDE EL CONVENIO EN CREDITO Y CASA ");
							}

							if (memcmp(cTxt, "PLAN MOVISTAR", 13) == 0)
							{
								AfxMessageBox(" NO PROCEDE EL CONVENIO EN PLANES MOVISTAR ");
							}
						}
					}
				}
				break;

			case VK_F4:
				if (iSistema == 3)
				{
					if (esEmpleado(m_grid.lCliente) != 1)
					{
						char cNombreProyecto[100] = { 0 }, cNombreFuncionDLL[10] = { 0 }, cInputParam1[1024] = { 0 }, cInputParam2[1024] = { 0 };
						SParametros parametros;

						memset(&parametros, 0, sizeof(SParametros));
						parametros.iLink = generarLink();
						sprintf_s(parametros.sServer, "%s", (LPCTSTR)m_grid.sServer);
						parametros.iTienda = m_grid.iTienda;
						parametros.lEmpleado = m_grid.lEmpleado;
						parametros.iCajaActual = m_grid.iCaja;
						parametros.iMuestraMsg = m_grid.iMuestraMsg;

						parametros.lCliente = m_grid.lCliente;
						parametros.iCiudad = atoi(sCiudad);
						parametros.sFlagServicio = sFlagServicio[0];
						parametros.iFlagGeneral = atoi(sCuentasTelefono);
						parametros.iBodega = atoi(sCantidadRecibo);
						parametros.iTipoCoordenada = atoi(sCuentasCFE);
						memcpy(parametros.sCuentasGasNat, sCuentasGasNatural, 10);

						memcpy(cInputParam1, &parametros, sizeof(SParametros));

						// Ruta del archivo DLL a ejecutar
						nombreArchivo("CA0056.DLL", cNombreProyecto, DIRECTORIO_CA);

						// Nombre de la función principal en el DLL
						sprintf_s(cNombreFuncionDLL, "CA0056");

						CargarDLL cargarDll(cNombreProyecto, cNombreFuncionDLL, cInputParam1, cInputParam2);

						iRegresaDll = cargarDll.getResultado();

						if (iRegresaDll < 0)
						{
							AfxMessageBox("Error al cargar el programa CA0056.DLL", MB_ICONERROR);
						}
						if (iRegresaDll > 0)
						{
							iFlagCapturoServicio = 1;
						}
					}
				}
				else
				{
					AfxMessageBox("FAVOR DE PASAR A CAJAS DE ABONOS PARA REALIZAR PAGOS DE SERVICIOS");

				}

				m_grid.RedrawAll();
				pMsg->wParam = NULL;
				break;
			case VK_F5:
				menuSegurosDeVida();
				if (pMsg->wParam == VK_ESCAPE || pMsg->wParam == VK_F10)
				{
					pMsg->wParam = NULL;
				}
				m_grid.RedrawAll();
				break;

			case VK_F6: //F6 Saldar Cuenta
				desplegarSaldarCuenta();
				break;

			case VK_F7: //F7 Pago Minimo //cargo abono supervisor
				if (iTeclaAnterior == VK_CONTROL || iTeclaAnterior == CTRL_F7)
				{
					switch (iSistema)
					{
					case SISTEMA_CAJAS:
						{
							if (iFlagDomiciliacionCuentas == 1)
							{
								//if (iFlagTiendaLocal == 0)
								//{
								CargarMenuDomiciliacion();
								//}
								//else
								//{
								//AfxMessageBox("LA TIENDA SE ENCUENTRA EN MODO LOCAL");
								//}
							}
							else
							{
								AfxMessageBox("OPCION NO DISPONIBLE PARA ESTA TIENDA");
							}
						}
						break;
					case SISTEMA_ROPA:
						{
							if (iFlagMenuDomiciliacionDeRopa == 1)
							{
								//if (iFlagTiendaLocal == 0)
								//{
								CargarMenuDomiciliacion();
								//}
								//else
								//{
								//AfxMessageBox("LA TIENDA SE ENCUENTRA EN MODO LOCAL");
								//}
							}
							else
							{
								AfxMessageBox("OPCION NO DISPONIBLE PARA ESTA TIENDA");
							}
						}
						break;
					case SISTEMA_MUEBLES:
						{
							if (iFlagMenuDomiciliacionDeMuebles == 1)
							{
								//if (iFlagTiendaLocal == 0)
								//{
								CargarMenuDomiciliacion();
								//}
								//else
								//{
								//AfxMessageBox("LA TIENDA SE ENCUENTRA EN MODO LOCAL");
								//}
							}
							else
							{
								AfxMessageBox("OPCION NO DISPONIBLE PARA ESTA TIENDA");
							}
						}
						break;
					default:
						break;
					}
					m_grid.RedrawAll();
					{
						pMsg->wParam = NULL;
					}
				}
				else
				{
					if (iFlagMovimiento == 0 || iFlagMovimiento == 2)
					{
						if (iFlagMovimiento == 2)
						{
							if (esEmpleado(m_grid.lCliente) != 1)
							{
								if (iFlagSupervisor == -1)
								{
									iFlagSupervisor = 0;
									if (iFlagMovimiento == 2)
									{
										iFlagMovimiento = 1;
										iFlagSupervisor = 1;
									}
								}
							}
							if (esEmpleado(m_grid.lCliente) != 1)
							{
								if (iFlagSupervisor == 1 && iFlagCapturaSurpervisor == 0)
								{
									CDlgCapturarNumEmpleSupervisor dlgEmpleadoSupervisor;
									dlgEmpleadoSupervisor.lEmpleado = m_grid.lEmpleado;
									dlgEmpleadoSupervisor.iCaja = m_grid.iCaja;
									dlgEmpleadoSupervisor.DoModal();

									if (dlgEmpleadoSupervisor.lEmpleadoSupervisor <= 0L)
									{
										lEmpleadoSupervisor = 0L;
										inicializarCaptura();
									}
									else
									{
										lEmpleadoSupervisor = dlgEmpleadoSupervisor.lEmpleadoSupervisor;
										iFlagCapturaSurpervisor = 1;
									}
								}
							}
						}
						else   //se trata de un cargo
						{
							validarHuellaEmpleadoGte01(&odbc, lGteHuella, 2, 0, 0L, m_grid.iTienda, 3, iCajaDlg, "CA0030");//gnwSuplirHuellaGerente.cpp
							if (lGteHuella >= 0 && lGteHuella != -1)
							{
								if (lGteHuella < 90000000)
								{
									pintarMensajesErrorPasstda(lGteHuella);
									lGteHuella = 0;
									inicializar();
									inicializarCaptura();
								}
								else
								{
									desplegarPagoMinimoCuenta();
								}

							}
							else
							{
								AfxMessageBox("LA HUELLA CAPTURADA NO ES DE GERENTE ");
								lGteHuella = 0;
								inicializar();
								inicializarCaptura();
							}
						}
					}
					else
					{
						desplegarPagoMinimoCuenta();
					}
				}
				break;

			case VK_F8: //Saldar Todo
				desplegarSaldarTodasCuentas();
				break;

			case VK_F9: //Pago Minimo Total
				if (iFoco == 1) //este en el grid
				{
					iColX = m_grid.GetCurrentCol(); //obtener la columna donde esta posicionado
					m_grid.QuickGetText(iColX, -1, &sConcepto);
					sConcepto.Trim();
					sprintf_s(cTxt, "%s", (LPCTSTR)sConcepto);

					if (memcmp(cTxt, "PLAN MOVISTAR", 13) == 0)
					{
						if (m_grid.cArea == 'C')
						{
							pagoAbonosPlanMovistar();
						}
						else
						{
							AfxMessageBox("SOLO SE PUEDE ABONAR A PLANES MOVISTAR EN EL AREA DE CAJAS DE ABONOS");
						}
					}
					else
					{
						desplegarPagoMinimoCuentas();
					}
				}
				break;

			default:
				switch (pMsg->wParam)
				{
				case VK_F1:
				case CTRL_F1:
					if (iTeclaAnterior == VK_CONTROL || iTeclaAnterior == CTRL_F1)
					{
						if (iSistema == SISTEMA_CAJAS)
						{
							menuSegurosCoppel();
							m_grid.RedrawAll();
							pMsg->wParam = NULL;
						}
						else
						{
							memset(cMsgBloqueo, 0, sizeof(cMsgBloqueo));
							ConsultarCatalogoMensajeTienda(MSG_AREAMENUCLUB, cMsgBloqueo);
							sTexto.Format("%s", cMsgBloqueo);
							if (sTexto.Trim() != "")
							{
								AfxMessageBox(sTexto.Trim());
							}
						}
					}
					break;
				case CTRL_F7:
					switch (iSistema)
					{
					case SISTEMA_CAJAS:
						{
							if (iTeclaAnterior == VK_CONTROL || iTeclaAnterior == CTRL_F7)
							{
								if (iFlagDomiciliacionCuentas == 1)
								{
									//if (iFlagTiendaLocal == 0)
									//{
									CargarMenuDomiciliacion();
									//}
									//else
									//{
									//AfxMessageBox("LA TIENDA SE ENCUENTRA EN MODO LOCAL");
									//}
								}
								else
								{
									AfxMessageBox("OPCION NO DISPONIBLE PARA ESTA TIENDA");
								}
								m_grid.RedrawAll();
								{
									pMsg->wParam = NULL;
								}
							}
						}
						break;
					case SISTEMA_ROPA:
						{
							if (iTeclaAnterior == VK_CONTROL || iTeclaAnterior == CTRL_F7)
							{
								if (iFlagMenuDomiciliacionDeRopa == 1)
								{
									//if (iFlagTiendaLocal == 0)
									//{
									CargarMenuDomiciliacion();
									//}
									//else
									//{
									//AfxMessageBox("LA TIENDA SE ENCUENTRA EN MODO LOCAL");
									//}
								}
								else
								{
									AfxMessageBox("OPCION NO DISPONIBLE PARA ESTA TIENDA");
								}
								m_grid.RedrawAll();
								{
									pMsg->wParam = NULL;
								}
							}
						}
						break;
					case SISTEMA_MUEBLES:
						{
							if (iTeclaAnterior == VK_CONTROL || iTeclaAnterior == CTRL_F7)
							{
								if (iFlagMenuDomiciliacionDeMuebles == 1)
								{
									//if (iFlagTiendaLocal == 0)
									//{
									CargarMenuDomiciliacion();
									//}
									//else
									//{
									//AfxMessageBox("LA TIENDA SE ENCUENTRA EN MODO LOCAL");
									//}
								}
								else
								{
									AfxMessageBox("OPCION NO DISPONIBLE PARA ESTA TIENDA");
								}
								m_grid.RedrawAll();
								{
									pMsg->wParam = NULL;
								}
							}
						}
						break;
					default:
						break;
					}

					break;
				case VK_TAB:
					m_grid.bFocoGrid = false;
					iFoco++;
					if (iFoco > 1) iFoco = 1;
					asignarFoco();
					return TRUE;
					break;

				case VK_RETURN:
					m_grid.MoveCurrentCol(1);
					break;

				case VK_ESCAPE:
					GuardaHit(0);
					inicializar();
					inicializarCaptura();
					return TRUE;
					break;

				case VK_UP:
					iColX = m_grid.GetCurrentCol(); //obtener la columna donde esta posicionado

					m_grid.QuickGetText(iColX, -1, &sConcepto);
					sConcepto.Trim();
					sprintf_s(cTxt, "%s", (LPCTSTR)sConcepto);

					if (memcmp(cTxt, "SEGURO", 6) == 0 || memcmp(cTxt, "P.FAMILIAR", 10) == 0)
					{
						grabarLog("PreTranslateMessage: VK_UP ---> P.FAMILIAR");
						if (memcmp(cTxt, "SEGURO", 6) == 0)
						{
							iFlagClub = 1;
						}
						else
						{
							iFlagClub = 0;
						}
						m_grid.QuickGetText(iColX, 2, &sConcepto);
						sConcepto.Trim();
						sprintf_s(cTxt, "%s", (LPCTSTR)sConcepto);
						if (memcmp(cTxt, "AFILIAR", 7) == 0 && iSistema != 3)
						{
							AfxMessageBox(" SOLO SE PUEDE RECIBIR ABONOS ");
						}
						else
						{
							if (iFlagMovimiento == 0)
							{
								//Se trata de un Cargo
								AfxMessageBox(" DEBE ESTAR EN LA OPCION DE ABONOS ");
							}
							else
							{
								capturarDatosSeguro();
							}
						}
						pMsg->wParam = NULL;
					}
					else if (memcmp(cTxt, "AUTO PROT.", 10) == 0)
					{
						if (iSistema == 3)
						{
							grabarLog("PreTranslateMessage: VK_UP ---> AUTO PROT.");
							if (iFlagMovimiento == 0)
							{
								//Se trata de un Cargo
								AfxMessageBox(" DEBE ESTAR EN LA OPCION DE ABONOS ");
							}
							else
							{
								m_grid.QuickGetText(iColX, 2, &sTexto);
								sTexto.Trim();
								m_grid.QuickGetText(iColX, 3, &sDato);
								sDato.Trim();

								if (bCandidatoCPVenta && sTexto == "AFILIAR" && sDato == "P. VIAL")
								{
									capturarVentaSeguroAuto();
								}
								else
								{
									capturarAbonoSeguroAuto(autoSeguro.lPoliza);
								}
							}
						}
						else
						{
							AfxMessageBox(" SOLO SE PUEDE ABONAR AL SEGURO  DE AUTO PROTECCIÓN  EN EL AREA DE CAJAS ");
						}
					}
					else if (memcmp(cTxt, "SEG. MOTOS", 10) == 0) {
						//Llamado de funcionalidad para capturar el abono del CPM
						if(iSistema == 3){
							grabarLog("PreTranslatemMessage: VK_UP ---> SEG. MOTOS");
							if (iFlagMovimiento == 0)
							{
								//Se trata de un Cargo 
								AfxMessageBox( " DEBE ESTAR EN LA OPCION DE ABONOS");
							} else
							{
								capturarDatosSeguroMotos(iColX);                                
							} 
						} else {
							AfxMessageBox(" SOLO SE PUEDE ABONAR AL SEGURO DE MOTO PROTECCIÓN EN EL AREA DE CAJAS ");
						}
						grabarLog("SEG. Motos Finalizá");
					}
					else if (memcmp(cTxt, "P. CELULAR", 10) == 0) {
						pMsg->wParam = NULL;
						//Llamado de funcionalidad para capturar el abono del CPM
						if(iSistema == 3){
							grabarLog("PreTranslatemMessage: VK_UP ---> SEG. CELULARES");
							if (iFlagMovimiento == 0)
							{
								//Se trata de un Cargo 
								AfxMessageBox( " DEBE ESTAR EN LA OPCION DE ABONOS");
							} else
							{
								capturarDatosSeguroCelulares(iColX);
							}
						} else {
							AfxMessageBox(" SOLO SE PUEDE ABONAR AL SEGURO DE CELULARES EN EL AREA DE CAJAS ");
						}
						grabarLog("SEG. CELULARES Fnalizá");
					}
					else if (memcmp(cTxt, "P.SALUD", 7) == 0)
					{
						if (!bErrorProcesoPS)
						{
							grabarLog("PreTranslateMessage: VK_UP ---> P.SALUD");
							m_grid.QuickGetText(iColX, 2, &sConcepto);
							sConcepto.Trim();
							sprintf_s(cTxt, "%s", (LPCTSTR)sConcepto);
							if (memcmp(cTxt, "AFILIAR", 7) == 0 && iSistema != 3)
							{
								AfxMessageBox(" SOLO SE PUEDE RECIBIR ABONOS ");
							}
							else
							{
								if (iFlagMovimiento == 0)
								{
									//Se trata de un Cargo
									AfxMessageBox(" DEBE ESTAR EN LA OPCION DE ABONOS ");
								}
								else
								{
									if (bTieneDatosEnTemporales)
									{
										memset(cMensaje, 0, sizeof(cMensaje));
										consultarMensaje(859, cMensaje); // "EXISTEN CAMBIOS PENDIENTES DE APLICAR, SI DESEA CONTINUAR CON LA ACTUALIZACIÓN SE DEBERÁ ELIMINAR EL RECIBO ANTERIOR"
										AfxMessageBox(cMensaje, MB_ICONINFORMATION);
										memset(cMensaje, 0, sizeof(cMensaje));
									}
									else
									{
										if (bBanderaTienePlan)
										{
											if (bSobrePasaEdadMaxima) // Edad de Cliente > Edad Maxima Plan
											{
												memset(cMensaje, 0, sizeof(cMensaje));
												consultarMensaje(860, cMensaje); // "EL CLIENTE YA NO PUEDE ABONAR A SU SEGURO, DEBIDO A QUE SOBREPASARÁ LA EDAD MÁXIMA"
												AfxMessageBox(cMensaje, MB_ICONINFORMATION);
												memset(cMensaje, 0, sizeof(cMensaje));
											}
											else
											{
												verificarUltimoRecibo(); // obtiene numero de recibo

												if (iPlanAdicionales < iMaxAdicionales)
												{
													if (iSistema == SISTEMA_CAJAS)
													{
														int iOpcion = IDNO;

														if (iFlagPlandeSalud == 1)
														{

															if (iPlanAdicionales == 0)
															{
																iOpcion = AfxMessageBox("¿DESEA ADQUIRIR EL CLUB ADICIONAL?", MB_YESNO | MB_ICONQUESTION);
															}
															else
															{
																iOpcion = AfxMessageBox("¿DESEA ADQUIRIR OTRO CLUB ADICIONAL?", MB_YESNO | MB_ICONQUESTION);
															}
														}

														if (iOpcion == IDYES)
														{
															// cargar componente para afiliar adicional
															cargarVentaSegurosGenerales(2);
														}
														else
														{
															// cargar componente de capturar de meses y cambio de plan
															cargarAbonosCambiosDePlanSegurosGenerales();
														}
													}
													else
													{
														// cargar componente de capturar de meses y cambio de plan
														cargarAbonosCambiosDePlanSegurosGenerales();
													}
												}
												else
												{
													// cargar componente de capturar de meses y cambio de plan
													cargarAbonosCambiosDePlanSegurosGenerales();
												}
											}
										}
										else
										{
											// ir a venta CPS
											cargarVentaSegurosGenerales(1);
										}
									}
								}
							}
							pMsg->wParam = NULL;
						}
						else
						{
							AfxMessageBox("Ocurrio un error el proceso de Club de Protección Salud.\n Favor de comunicarse con Mesa de Ayuda.", MB_ICONERROR);
						}
					}
					if (pMsg->wParam == VK_ESCAPE || pMsg->wParam == VK_F10)
					{
						pMsg->wParam = NULL;
					}
					iFoco = 1;
					asignarFoco();
					break;
				default:
					break;
				}
				break;
			}

			iTeclaAnterior = (int)pMsg->wParam;
		}
		else if (pMsg->message == WM_SYSKEYDOWN)
		{
			switch (iOpcionTecleada)
			{
			case VK_F10:
				if ((iSistema != SISTEMA_MUEBLES && iSistema != SISTEMA_ROPA))
					calculadora();
				break;

			default:
				break;
			}
		}
	}

	return CDialog2012::PreTranslateMessage(pMsg);
}

bool CDlgCapturarAbono::validarClick(int nTmpFocus)
{
	char cLog[500] = { 0 };
	CString msg;
	int nElementoTmp, i;
	bool regresa = true;
	char cPaso[255] = { 0 };

	sprintf_s(cLog, "FC0200805021521007 - entra - validarClick");
	grabarLog(cLog);

	if (iFoco < nTmpFocus)
	{
		// validar control anterior
		if (!validarControl(cPaso))
		{
			asignarFoco();
			if (iFoco != iControles)//numero de controles para los que se quieren se vea el mebsaje de error
			{
				if (!ShiftTab)
				{
					AfxMessageBox(cPaso);
				}
			}
			regresa = false;
		}
		else
		{
			nElementoTmp = iFoco;
			iFoco = nTmpFocus;
			for (i = 0; i <= nTmpFocus; i++)
			{
				iFoco = i;
				//valida hacia abajo los controles
				if (!validarControl(cPaso))
				{
					break;
				}
			}
			asignarFoco();
		}
	}
	else
	{
		iFoco = nTmpFocus;
	}
	sprintf_s(cLog, "FC0200805021521007 - Finalizá - validarClick");
	grabarLog(cLog);
	return regresa;
}

void CDlgCapturarAbono::asignarFoco()
{
	char cLog[500] = { 0 };
	int iTmpFoco = iFoco;
	m_grid.bFocoGrid = false;

	sprintf_s(cLog, "FC0200805021521010 - entra - asignarFoco");
	grabarLog(cLog);

	switch (iFoco)
	{
	case 0:
		m_cliente.SetFocus();
		break;
	case 1:
		m_grid.bFocoGrid = true;
		m_grid.SetFocus();
		if (iTmpFoco == 1)
		{
			iFoco = 1;
		}
		m_grid.RedrawAll();
		break;
	default:
		break;
	}
	sprintf_s(cLog, "FC0200805021521010 - Finalizá - asignarFoco");
	grabarLog(cLog);
}

bool CDlgCapturarAbono::buscarClientePlanLealtad(char * cCadena)
{
	char cLog[500] = { 0 };
	bool bRespuesta = true, bClienteCoppel = false, bNumeroTarjeta = false;;
	char cMensajeSinResultados[120] = { 0 }, cTituloOpcion[60] = { 0 };
	CString sDato = "";
	long lNumCliente = 0;

	sprintf_s(cLog, "FC0200805021521014 - entra - buscarClientePlanLealtad");
	grabarLog(cLog);

	m_cliente.GetWindowTextA(sDato);
	if (sDato != "" && !sDato.IsEmpty())
	{
		if (validarNumeroPL(sDato))//Es numerico 
		{
			if (sDato.GetLength() == 16)//es tarjeta
			{
				bNumeroTarjeta = true;
			}
			else if (sDato.GetLength() != 10)//no es un celular
			{
				if (sDato.GetLength() != 16) //Tarjeta pasa directo a la busqueda
				{
					lNumCliente = atol(sDato);
					if (((lNumCliente > lClienteMaximo || lNumCliente < 100000) && lNumCliente != 1708) || esEmpleado(lNumCliente) == 1)
					{
						sprintf(cCadena, " CLIENTE FUERA DE RANGO ");
						bRespuesta = false;
					}
					else
					{
						if (checar_digito(lNumCliente))
						{
							sprintf(cCadena, " !! DIGITO VERIFICADOR INVALIDO !! ");
							bRespuesta = false;
						}
						else
						{
							if ( lNumCliente == 1708 && iFlagETP == 1 )
							{
								sprintf(cCadena, " CLIENTE INVALIDO ");
								bRespuesta = false;
							}
							else
							{
								bClienteCoppel = true;
							}
						}
					}
				}
			}
		}
	}
	else
	{
		sprintf(cCadena, "El número de cliente no puede ser nulo...");
		bRespuesta = false;
	}

	if (bRespuesta && !bNumeroTarjeta) //Lanzar busqueda en PL cuando no es tarjeta
	{
		sClientePL = objPlanDeLealtad->obtenerDatosCliente();
		if (sClientePL.iNumCliente <= 0)
		{
			sClientePL = objPlanDeLealtad->buscarInvitarCliente(sDato.Trim());
		}
		if (sClientePL.iResultadoBusqueda == 0) //No se cargo el componente
		{
			grabarMensajeError("C", m_grid.iCaja, (LPTSTR)(LPCTSTR)m_grid.sServer, "CA0030.DLL", "CDlgCapturarAbono", "buscarClientePlanLealtad",
				objPlanDeLealtad->cMensajeError, m_grid.lEmpleado, "Error al consultar Plan De Lealtad, favor de comunicarse con Mesa de Ayuda.", &odbc, m_grid.iMuestraMsg);
		}

		if (sClientePL.iNumCliente > 0 && sClientePL.iNumCliente != 90001)
		{
			sDato.Format("%d", sClientePL.iNumCliente);
			m_cliente.SetWindowTextA(sDato);
			sDato.Format("%s", sClientePL.cCorreo);
			if (!sDato.IsEmpty() && sDato != "@.")
			{
				m_correo.SetWindowTextA(objPlanDeLealtad->enmascararCorreo(sDato));
			}
			sDato.Format("%s", sClientePL.cCelular);
			if (!sDato.IsEmpty() && sDato != "0")
			{
				m_celular.SetWindowTextA(objPlanDeLealtad->enmascararCelular(sDato));
			}

			if (sClientePL.i64IduPlanLealtad > 0 && sClientePL.i16IduSubstatus != IDU_SUBESTATUS_BAJA) //Cuando esta dado de baja se ofrece registro
			{
				ConsultarCatalogoMensajeTienda(TITULO_OPCION_ACTUALIZAR, cTituloOpcion);
				sprintf_s(cOpcionPL, "%.50s", cTituloOpcion);
			}
		}
		else if (sClientePL.iNumCliente == 90001)//cuando busqueda PL regrese un cliente 90001
		{
			sprintf(cCadena, " CLIENTE FUERA DE RANGO ");
		}
		else if (!bClienteCoppel)
		{
			bRespuesta = false;
		}
	}

	if (!bRespuesta)
	{

		inicializarCaptura();

	}
	sprintf_s(cLog, "FC0200805021521014 - Finalizá - buscarClientePlanLealtad");
	grabarLog(cLog);
	return bRespuesta;
}

bool CDlgCapturarAbono::validarControl(char * cCadena)
{
	char cLog[500] = { 0 };
	bool bValorRegresa = true;
	CString sDato = "";
	CString sTexto = "";
	char cBarraOpciones[255] = { 0 };

	sprintf_s(cLog, "FC0200805021521018 - entra - validarControl");
	grabarLog(cLog);

	switch (iFoco)
	{
	case 0:
		// Se busca siempre y cuando el area sea cajas o ropa y muebles siempre y cuando  sea bajo demanda
		if (iFlagCampoInteligentePL > 0 && !bProvieneDatos_OtraArea
			&& (iSistema == SISTEMA_CAJAS || iSistema == SISTEMA_MUEBLES || iSistema == SISTEMA_ROPA))
		{
			bValorRegresa = buscarClientePlanLealtad(cCadena);
		}
		else
		{
			bValorRegresa = true;
		}

		if (bValorRegresa)
		{
			bValorRegresa = validarNumeroCliente(cCadena);
		}

		if (bValorRegresa)
		{
			iniciarMovimientoOperacion();//PET-20275

			m_barra.ShowWindow(TRUE);
			if (bFlagSituacionesInformativas)
			{
				if (iFlagRegistroPL > 0 && iFlagCampoInteligentePL > 0 && !bProvieneDatos_OtraArea
					&& (iSistema == SISTEMA_CAJAS || iSistema == SISTEMA_MUEBLES
					|| iSistema == SISTEMA_ROPA))
				{
					sprintf_s(cBarraOpciones, " [CTRL+F3]  PANTALLA DE MOVIMIENTOS      [CTRL+F4]  MOSTRAR INFORMATIVAS  [CTRL+F9] %.50s", cOpcionPL);
				}
				else
				{
					sprintf_s(cBarraOpciones, " [CTRL+F3]  PANTALLA DE MOVIMIENTOS      [CTRL+F4]  MOSTRAR INFORMATIVAS");
				}
			}
			else
			{
				if (iFlagRegistroPL > 0 && iFlagCampoInteligentePL > 0 && !bProvieneDatos_OtraArea
					&& (iSistema == SISTEMA_CAJAS || iSistema == SISTEMA_MUEBLES
					|| iSistema == SISTEMA_ROPA))
				{
					sprintf_s(cBarraOpciones, "[CTRL+F6] CONSULTAR HISTORIAL DE CONV.  [CTRL+F3]  PANTALLA DE MOVIMIENTOS  [CTRL+F9] %.50s", cOpcionPL);
				}
				else
				{
					sprintf_s(cBarraOpciones, "[CTRL+F6] CONSULTAR HISTORIAL DE CONV.  [CTRL+F3]  PANTALLA DE MOVIMIENTOS ");
				}

			}

			ponerMensajeNR(this, m_barra, m_mensaje1, cBarraOpciones);
			m_barra.ShowWindow(true);
		}
		break;
	default:
		break;
	}
	sprintf_s(cLog, "FC0200805021521018 - Finalizá - validarControl");
	grabarLog(cLog);
	return bValorRegresa;
}

bool CDlgCapturarAbono::validarControles()
{
	char cLog[500] = { 0 };
	bool bValorRegresa = false;
	int i = 0, iFocoAnt = 0;
	bool bandera = true;
	char cPaso[255] = { 0 };

	sprintf_s(cLog, "FC0200805021521022 - entra - validarControles");
	grabarLog(cLog);

	iFocoAnt = iFoco;

	for (i = 0; i < iControles; i++)
	{
		iFoco = i;
		bandera = validarControl(cPaso);
		if (!bandera)
		{
			AfxMessageBox(cPaso);
			asignarFoco();
			break;
		}
	}

	if (bandera)
	{
		bValorRegresa = true;
	}

	iFoco = iFocoAnt;
	asignarFoco();

	sprintf_s(cLog, "FC0200805021521022 - Finalizá - validarControles");
	grabarLog(cLog);
	return bValorRegresa;
}

int CDlgCapturarAbono::desplegarDatosCliente()
{
	CString sDato, sFechaTienda, snomcuenta;
	int i = 0, iColumna = 0, k = 0, iFlagConsulta = 0, fontID = 0,
		iFlagIncrementa = 1, iDiaV = 0, iMesV = 0, iAnioV = 0, iFlagOk = 1, iCantidadSegurosClub = 0, iCantidadSegurosPS = 0, iRestarCuentas = 0, icuenta = 0, iMesesVencidos = 0;
	char cFecha1[11] = { 0 }, cFecha2[11] = { 0 }, cRespuesta[30] = { 0 }, cTexto[80] = { 0 }, cMensajeSeguimiento[1024] = { 0 }, cSqlTxt[255] = { 0 }, cJsonPostDescuentoMoratorio[300] = { 0 };
	long lImporteTotal = 0L, lImporteConvenioTotal = 0L, lFecha1 = 0L, lFecha2 = 0L, lCuotaSeguroVial = 0L,
		lCuota = 0, lCuotaPS = 0L, lCuotaTemporal = 0L, lCuotaTemporalPS = 0L, lCuotaAdicionalesPS = 0L, lFolioSeguroi = 0L, lFolioSeguroc = 0L;
	bool  bConsulta = true, bIndividual = false, bConyugal = false, bBorrarTemporalesPS = true, bConsultarSeguro = true;
	char cStatusSeguro = 0, cTipoCan = 0, cClaveNoOfrecer = 0, cTxt[20] = { 0 };
	long lFechaMasActual = 0L, lDias = 0L;
	short iSegurosInvalidos = 0, iSeguroCancelado = 0, iPlanesInvalidos = 0, iPlanCancelado = 0;
	int iPlazos = 0;
	char cDias[5] = { 0 }, cInteresprestamo[100] = { 0 }, cIplazo[5] = { 0 }, cFechaPrestamo[10] = { 0 }, cCuentaP[2] = { 0 };
	string sJsonPostDescuentoMoratorio, sJsonPostDescmora;
	CConsumoAPICuentasSeguros *pCuentasSeguros = new CConsumoAPICuentasSeguros();

	sprintf_s(cMensajeSeguimiento, "CDlgCapturarAbono::desplegarDatosCliente--> Inicia busqueda del cliente[%ld]", m_grid.lCliente);
	grabarLog(cMensajeSeguimiento);

	datosCliente = "";
	bClienteReestructurado = false;
	memset(&iFoliosSegurosAdicionales, 0, sizeof(iFoliosSegurosAdicionales));
	memset(&iFoliosSegurosActual, 0, sizeof(iFoliosSegurosActual));
	memset(&iFoliosAfirme, 0, sizeof(iFoliosAfirme));
	memset(&EDatosConvenioCliente, 0, sizeof(DatosConvenioCliente) * 100);
	memset(&stDatosCertificacion, 0, sizeof(STDatosCertificacion) * 100);

	iSegurosAfirme = 0;
	iCambioPlanSeguroClub = 0;
	iCantidadCuentaMuebles = 0;

	iPlanVigente = 0;
	iFlagTieneSeguroAdicional = 0;
	iFlagTienePlanAdicional = 0;
	iFlagCapturoSeguroAdicional = 0;
	iSegurosAdicionales = 0;
	iPlanAdicionales = 0;
	iSegurosAdicionalesNuevos = 0;
	lCuotaClub = 0;
	lCuotaPlan = 0;
	iNumMesesAdicional = 0;
	iFlagDescuentoEspecial = 0;
	iColumnaClub = iColumnaPlan = -1;
	iFlagMesRegalado = 0;
	iFlagImpresionCuentasPerdidas = 0;
	iDiasVencidosPS = iSumaAseguradaPlan = iCambiosDePlan = 0;
	iFlagMesRegaladoCPS = 0;


	iFlagMoras = 0;
	long lMoras = 0;

	/*Progc *Coppel*/
	memset(cPuntualidadAsterisco, 0, sizeof(cPuntualidadAsterisco));
	memset(cSubPuntualidadAsterisco, 0, sizeof(cSubPuntualidadAsterisco));
	memset(cJsonPostDescuentos, 0, sizeof(cJsonPostDescuentos));

	iCausaSituacionEspecialAsterisco = 0;
	lVencidoTiempoAireAsterisco = 0;
	lAbonoBaseTiempoAireAsterisco = 0;
	iPorcentajeUtilizado = 0;
	/***/
	lSaldoRopa = lSaldoTasa0 = lInteresesRopa = lInteresesTasa0 = iTotalCuentasDetalle = 0;
	iTipoDeduccionRopa = iTipoDeduccionTasa0 = -1;
	iFlagMoratorioCaja = iFlagMoratorioRopa = iFlagMoratorioMuebles = iFlagMoratorioGeneral = iCandidatoAprobado = iSumaInteresMoratorio = iCandidatoConvenioMora = 0;

	//CUGCell m_cell;
	bClienteCandidato = false;

	bTieneSeguroAuto = false;
	iCausaSituacionEspecial = 0;

	iFlagTimeOutCCuenta = 0;

	iPlazoRopa = 0;

	sJsonPostDescuentoMoratorio = "";
	flagCuentasSeguros = 0;

	//if ( obtenerDatosGnDominio())
	{
		if (obtenerFlag('C', FLAGC_SEGUROBANORTE, iFlagBanorte) == true &&
			obtenerFlag('C', FLAGC_VOLANTE, iFlagVolante) == true &&
			obtenerFlag('C', FLAGC_SEGUROS, iFlagSegAfirme) == true &&
			obtenerFlag('0', FLAG_TDAESTACIONAMIENTO, iFlagTdaConEstacionamiento) == true &&
			obtenerFlag('C', FLAGC_CLAVETERMINACION, iFlagTerminacion) == true &&
			obtenerFlag('0', FLAG_INVITACIONBANCOPPEL, iFlagInvitacionBanco) == true &&
			obtenerFlag('0', FLAG_TIENDALOCAL, iFlagTiendaLocal) == true &&
			obtenerFlag('C', FLAGC_CAPTURARECIBOJAPAC, iFlagJapac) == true &&
			obtenerFlag('C', FLAGC_CAPTURABENEFICIARIO, iFlagCapturaBeneficiario) == true &&
			obtenerFlag('C', FLAGC_ENCUESTA_CAT, iFlagEncuestaCat) == true &&
			obtenerFlag('0', FLAG_VENTA_SEGS_ADICIONALES, iFlagSeguroAdicional) == true &&
			obtenerFlag('0', FLAG_CANDIDATOASTERISCOCOPPEL, iFlagAsteriscoCoppel) == true &&
			obtenerFlag('0', FLAG_TIMEOUTCCUENTAWEB, iFlagTimeOutCCuenta) == true &&
			obtenerFlag('0', FLAG_CONTACTO_EFECTIVO, iFlagContactoEfectivo) == true &&
			obtenerFlag('C', FLAGC_DOMICILIACION_CUENTAS, iFlagDomiciliacionCuentas) == true &&
			obtenerFlag('C', FLAGC_CONSULTA_DOMICILIACION, iFlagConsultaDomiciliacion) == true &&
			obtenerFlag('C', FLAGC_IMPLESION_CUENTAS_PERDIDAS, iFlagImpresionCuentasPerdidas) &&
			obtenerFlag('R', FLAGR_MENUDOMICILIACIONDESDEROPA, iFlagMenuDomiciliacionDeRopa) &&     //20960
			obtenerFlag('M', FLAGM_MENUDOMICILIACIONDESDEMUEBLES, iFlagMenuDomiciliacionDeMuebles) && //20960
			obtenerFlag( 'C',FLAGC_CERTIFICACIONBONIFICACION, iFlagCertificacionBonidicacion) && 
			obtenerFlag( 'C',FLAGC_MOSTRAR_LEYENDA_CUBREBOCAS, iFlagTdaConCubrebocas) &&
			obtenerFlag( 'C',FLAGC_CONSULTA_CUENTAS_SEGUROS, flagCuentasSeguros) &&
			obtenerFlag('C', FLAGC_MENSAJE_MORAS,iFlagMoras) && //CAMBIOS PARA NUEVO LOGICA DE MORAS -- EDUALF (4)
			obtenerFlag('C', FLAGC_SANATUDEUDA, iFlagSanaTuDeuda) // TEMPAPSESTRATCOB005
			) 

		{
			//if (iFlagTiendaLocal == 0)
			//{
			obtenerFlag('C', FLAGC_DESCUENTO_INTERESMORATORIO, iFlagMoratorioCaja);
			obtenerFlag('R', FLAGR_DESCUENTOMORATORIO_ROPA, iFlagMoratorioRopa);
			obtenerFlag('M', FLAGM_DESCUENTOMORATORIO_MUEBLES, iFlagMoratorioMuebles);
			obtenerFlag('C', FLAGC_DESCUENTO_INTERESMORATORIO, iFlagMoratorioGeneral);
			//}

			//Se obtiene el flag capturo beneficiario.
			if (consultarIpServidor(&odbc, cIpServidorCFE, SERV_PSCFE, cSqlTxt) == true)
			{
				if (consultarIpServidor(&odbc, cIpServidorTelmex, SERV_PSTELMEX, cSqlTxt) == true)
				{
					if (consultarIpServidor(&odbc, cIpServidorCentral, SERV_CENTRALEMPS, cSqlTxt) == true)
					{
						if (consultarIpServidor(&odbc, cIpServidorCartera, SERV_CARTERA, cSqlTxt) == true)
						{
							if (consultarIpServidor(&odbc, cIpServidorCredito, SERV_CREDITO, cSqlTxt) == true)
							{
								if (consultarIpServidor(&odbc, cIpServidorPlanes, SERV_PLANES_TA, cSqlTxt) == true)
								{
									if (!consultarIpServidor(&odbc, cIpServidorCCuentaWeb, SERV_CCUENTAWEB, cSqlTxt))
									{
										return 0;
									}

									ObtenerMesAnio();//Obtener Mes Y Año Actual para consultar Datos

									if (!consultarEdadesSeguroClub(1) || !consultarEdadesSeguroClub(2) || !consultarEdadesPlanSalud(4))
									{
										CDialog2012::OnCancel();
									}

									sprintf_s(cTexto, "c:\\sys\\mem\\Ctas.txt");

									if (_access(cTexto, 0) == 0)
										_unlink(cTexto);

									if (_access("c:\\sys\\mem\\tarjeto.ta", 0) == 0)
									{
										_unlink("c:\\sys\\mem\\tarjeto.ta");
									}

									odbc_1.Close();
									if (!abrirConexionBD(&odbc_1, cIpServidorCartera, cIpServidorCartera, CONECTA_CARTERA, m_grid.iTienda))
									{
										AfxMessageBox(" Error al abrir conexión BD CARTERA");
										iFlagOk = 0;
									}

									m_cliente.GetWindowText(sDato);
									m_grid.lCliente = atol(sDato);
									if (m_grid.lCliente == 1708)
									{
										desplegarDatosClienteEtp();
										iFoco = 1;
										asignarFoco();
										m_grid.GotoCell(0, 21);
										m_grid.bLlenarGrid = true;
										iTotalCuentas = 1;
										m_grid.iTotalCuentas = iTotalCuentas;
									}
									else
									{
										sprintf_s(cIPServidorTiendaNumero, "%s", (LPCTSTR)m_grid.sServer);
										cIPServidorTiendaNumero[15] = 0;

										if (iFlagTimeOutCCuenta < 0)
										{
											iFlagTimeOutCCuenta = 0;
										}

										sprintf_s(cMensajeSeguimiento, "CDlgCapturarAbono::desplegarDatosCliente--> Inicia CCuentaWeb");
										grabarLog(cMensajeSeguimiento);

										CCuentaWeb *pCuentaCliente = new CCuentaWeb();
										pCuentaCliente->iniciarCCuenta(m_grid.lCliente, cFechaTienda, (short)m_grid.iTienda, (short)iCiudadGnDominio, cIpServidorCartera, cIpServidorCCuentaWeb, (short)iFlagTimeOutCCuenta);
										pCuentaCliente->leerCliente();

										sprintf_s(cMensajeSeguimiento, "CDlgCapturarAbono::desplegarDatosCliente--> bClienteValido = %d", pCuentaCliente->bClienteValido);
										grabarLog(cMensajeSeguimiento);
										{
											// se encontro al cliente en la cartera
											if (pCuentaCliente->bClienteValido || m_grid.lCliente == 1708)
											{
												memset(&candidatoReestructura, 0, sizeof(SCandidatoReestructura));
												pCuentaCliente->leerTienda01();

												pCuentaCliente->leerConvenios01();
												pCuentaCliente->leerLineaCredito();


												if(flagCuentasSeguros == 1) {
													//Consumo de Dll para consultar las cuentas de seguros
													pCuentasSeguros->consultaCuentaSeguros(cIpServidorCartera, cFechaTienda, m_grid.lCliente, m_grid.sServer, m_grid.iTienda);
												}


												if (pCuentaCliente->pCuenta[i].iTipoDeCuenta == 0)
												{
													iPlazoRopa = pCuentaCliente->pCuenta[i].iPlazo;
												}

												for (int j = 0; j < pCuentaCliente->iCuentas; j++)
												{

													if (pCuentaCliente->pCuenta[j].iTipoDeCuenta == CUENTA_SEGURO)
													{
														sprintf_s(cMensajeSeguimiento, "desplegarDatosCliente: Consulta ccuentaweb tipo cuenta:%d, Folio:%ld", pCuentaCliente->pCuenta[j].iTipoDeCuenta, pCuentaCliente->pCuenta[j].lFolio);
														grabarLog(cMensajeSeguimiento);
													}
												}

												iStatusAfore = pCuentaCliente->iStatusAfore;
												checarHoraInvitacion(); // Checa hora y cambia status afore...

												sNombreCliente.Format("%s", pCuentaCliente->cNombre);
												sNombreCliente.Trim();
												sApellidoPaterno.Format("%s", pCuentaCliente->cApellidoPaterno);
												sApellidoPaterno.Trim();
												sApellidoMaterno.Format("%s", pCuentaCliente->cApellidoMaterno);
												sApellidoMaterno.Trim();

												iPedirTelefonos = pCuentaCliente->iPedirTelefono;
												iCiudadCliente = pCuentaCliente->iCiudad;
												sprintf_s(cEstCivil, "%c", pCuentaCliente->cEstadoCivil);
												sprintf_s(cNombre, "%s", (LPCTSTR)sNombreCliente);
												sprintf_s(cApellidoPaterno, "%s", (LPCTSTR)sApellidoPaterno);
												sprintf_s(cApellidoMaterno, "%s", (LPCTSTR)sApellidoMaterno);
												cSexo = pCuentaCliente->cSexo;
												sprintf_s(cOcupacion, "%s", CString(pCuentaCliente->cLugarDeTrabajo).Trim());

												iDiaNacimiento = (short)pCuentaCliente->tFechaNacimiento.dia();
												iMesNacimiento = (short)pCuentaCliente->tFechaNacimiento.mes();
												iAnioNacimiento = (short)pCuentaCliente->tFechaNacimiento.ano();

												cFechaNacimientoCliente.Format("%.04d-%.02d-%.02d", iAnioNacimiento, static_cast<int>(iMesNacimiento), iDiaNacimiento);

												m_grid.cPuntualidad[0] = pCuentaCliente->cPuntualidad;
												m_grid.cSubPuntualidad[0] = pCuentaCliente->cSubPuntualidad;

												sprintf_s(cSituacionEspecial, "%c", pCuentaCliente->cSituacionEspecial);
												iCausaSituacionEspecial = pCuentaCliente->iCausaSituacionEspecial;
												iIdSituacionEspecial = pCuentaCliente->iIdSituacion;
												//Almacena nombre para consumo del servicio de club de proteccion mercadotecnia 360
												cNombreCliente360.Format("nomcte=%s",pCuentaCliente->cNombre );
												//llenar datosCliente
												datosCliente.Format("{\"numCliente\":%ld, \"nombre\":\"%s\", \"apellidoPaterno\":\"%s\", \"apellidoMaterno\":\"%s\", "
													"\"sexo\":\"%c\", \"fechaNacimiento\":\"%04d-%02d-%02d\", \"telefonoCliente\":\"%I64d\", \"puntualidad\":\"%c\", \"situacionEspecial\":\"%c\", "
													"\"causasitesp\":\"%d\", \"fechaAlta\":\"%04d-%02d-%02d\", \"ciudad\":%d, \"numTienda\":%d", m_grid.lCliente, pCuentaCliente->cNombre,
													pCuentaCliente->cApellidoPaterno, pCuentaCliente->cApellidoMaterno, cSexo, iAnioNacimiento, iMesNacimiento, iDiaNacimiento,
													pCuentaCliente->i64TelefonoCliente, pCuentaCliente->cPuntualidad, pCuentaCliente->cSituacionEspecial, iCausaSituacionEspecial,
													pCuentaCliente->tFechaAlta.ano(), pCuentaCliente->tFechaAlta.mes(), pCuentaCliente->tFechaAlta.dia(), pCuentaCliente->iCiudad, m_grid.iTienda);


												if (iMesActual >= iMesNacimiento)
												{
													if (iMesActual == iMesNacimiento)
													{
														if (iDiaActual >= iDiaNacimiento)
														{
															iEdadCliente = iAnioActual - iAnioNacimiento;
														}
														else
														{
															iEdadCliente = (iAnioActual - iAnioNacimiento) - 1;
														}
													}
													else
													{
														iEdadCliente = iAnioActual - iAnioNacimiento;
													}
												}
												else
												{
													iEdadCliente = (iAnioActual - iAnioNacimiento) - 1;
												}

												cPuntualidad[0] = pCuentaCliente->cPuntualidad;

												if (cPuntualidad[0] == ' ') cPuntualidad[0] = 0;
												cPuntualidad[1] = 0;
													
												//Validando situaciones I49 / I50 
												char cAclaracion[1065];
												if (ValidarSituacionEspecial(m_grid.lCliente, CLIENTE_SDO_ACLARACION, CAPTURA_ABONO, 3))
												{	
													SecureZeroMemory(cAclaracion, sizeof(cAclaracion));
													consultarMensaje(3555, cAclaracion);	
													sLeyenda = cAclaracion;
													m_leyendaAclaracion.SetWindowTextA(sLeyenda);
													iFlagMoras = 0; // EDUALF
												}

												iProceso = CAPTURA_ABONO;
												iRegla = CLIENTE_ILOCALIZABLE;
												if (ValidarSituacionEspecial(m_grid.lCliente, iRegla, iProceso, 3))
												{
													cSitEsp[0] = pCuentaCliente->cSituacionEspecial;
													iSituacion = pCuentaCliente->iCausaSituacionEspecial;
													iSituacionEspecial = 1;
												}
												else
												{
													iSituacionEspecial = 0;
												}
												//validar la regla 20(CLIENTES L y M).
												iProceso = CAPTURA_ABONO;
												iRegla = CLIENTES_LOCALIZAR_Y_M;
												if (ValidarSituacionEspecial(m_grid.lCliente, iRegla, iProceso, 3))
												{
													clv_situacion[0] = 'L';
												}
												else
												{
													clv_situacion[0] = ' ';
												}
												//validar la regla 19(CLIENTE_ABOGADO_EXTERNO).
												iProceso = CAPTURA_ABONO;
												iRegla = CLIENTE_ABOGADO_EXTERNO;
												if (ValidarSituacionEspecial(m_grid.lCliente, iRegla, iProceso, 3))
												{
													bCliente_Abogado_Externo = true;
													clv_situacion[0] = 'V';
												}
												else
												{
													bCliente_Abogado_Externo = false;
												}

												iProceso = CAPTURA_ABONO;
												iRegla = MOSTRAR_SITUACION_ESPECIAL;
												obtenerSituacionEspecialRegla(3, iRegla, iProceso, m_grid.lCliente);

												checarSituacionEspecial(iSituacion, pCuentaCliente->iCausaSituacionEspecial);

												if (pCuentaCliente->cPuntualidad == 'Z')
												{
													iFlagDespliegaDatosZ = 1;

												}
												else
												{
													iFlagDespliegaDatosZ = 0;
												}
												//else
												{
													iFlagDescuentoEspecial = pCuentaCliente->iFlagDescuentoEspecial;

													if (iFlagOk == 1)
													{
														if (iFlagBanorte == 4)
														{
															validarComplementoCliente(1, iFlagMesRegalado);//Validar si se regala un mes al cliente cuando compra seguro
														}

														sDato.Format("%c", pCuentaCliente->cPuntualidad);
														m_puntualidad2.SetWindowText(sDato);
														cSexoCliente[0] = pCuentaCliente->cSexo;
														cSexoCliente[1] = 0;

														i64TelefonoCelular = pCuentaCliente->i64TelefonoCelular;

														sDato.Format("%s", pCuentaCliente->cApellidoPaterno);
														m_apellidoPaterno.SetWindowText(sDato);
														sDato.Format("%s", pCuentaCliente->cApellidoMaterno);
														m_apellidoMaterno.SetWindowText(sDato);

														sDato.Format("%s", pCuentaCliente->cNombre);
														m_nombre.SetWindowText(sDato);

														if (iEdadCliente > 59 && m_grid.lCliente != 1708L)
														{
															sDato.Format("EDAD: %02d", iEdadCliente);
															m_edad.SetWindowText(sDato);
														}																					

														iTotalCuentas = pCuentaCliente->iCuentas;

														if (iFlagMoratorioGeneral == 1)
														{
															if (iSistema == SISTEMA_CAJERA_CAPTURISTA)
															{
																iCandidatoAprobado = 0;
															}
															else
															{
																if ((m_grid.cArea == 'C' && iFlagMoratorioCaja == 1) || (m_grid.cArea == 'R' && iFlagMoratorioRopa == 1) || (m_grid.cArea == 'M' && iFlagMoratorioMuebles == 1) /*&& iFlagTiendaLocal == 0*/)
																{
																	iCandidatoAprobado = pCuentaCliente->totalesCuenta.lCienteCandidato;
																	if (iCandidatoAprobado == 1)
																	{
																		sToken="";// 37569 se limpia variable antes de consultar
																		CConsultarTokenSSO cTokenSSO = CConsultarTokenSSO();
																		sToken= cTokenSSO.consultarTokenSSO(3,10,3,"SSO",cIPServidorTiendaNumero,m_grid.iTienda,m_grid.iCaja); //37569 consultar token NOTA: cambiar el segundo parametro  debe el idu_servicio de la tabla ctl_configuracionllavesservicios 
																		// 37569 validar que se obtuvo token
																		if(sToken!=""){

																			sprintf_s(cJsonPostDescuentoMoratorio, "{\"numCliente\":%ld,\"area\":\"%c\",\"caja\":%d,\"ciudad\":%d" ",\"numEmpleado\":%ld,\"situacionEspecial\":\"%s\",\"causaSituacionEspecial\":%d,\"sexo\":\"%c\""
																				",\"nombreCliente\":\"%s\",\"apellidoPaterno\":\"%s\",\"apellidoMaterno\":\"%s\",\"cuenta\":[{", m_grid.lCliente, m_grid.cArea, m_grid.iCaja, iCiudadGnDominio, m_grid.lEmpleado, cSituacionEspecial, iCausaSituacion, cSexo, (LPCTSTR)sNombreCliente, (LPCTSTR)sApellidoPaterno, (LPCTSTR)sApellidoMaterno);

																			sJsonPostDescuentoMoratorio.append(cJsonPostDescuentoMoratorio);
																		}
																		//37569 error al obtener token agregar mensaje
																		else{
																			AfxMessageBox("Advertencia:\nError al generar token de autenticación. Favor\nde comunicarse a mesa de servicio.");
																			sprintf_s(cMensajeSeguimiento, "CDlgCapturarAbono::desplegarDatosCliente--> Error al consultar un token de autenticacion");
																			grabarLog(cMensajeSeguimiento);
																			iCandidatoAprobado = 0;
																		}
																	}
																	//iSumaIntereiCandidatoAprobadosMoratorio = pCuentaCliente->lSumaInteresMoratorio;
																}
															}
														}
														for (i = 0; i < pCuentaCliente->iCuentas; i++)
														{
															if (pCuentaCliente->pCuenta[i].iTipoDeCuenta == CUENTA_SEGUROAUTO)
															{
																bTieneSeguroAuto = true;
																break;
															}
														}

														m_grid.iTotalCuentas = iTotalCuentas;
														iSiTieneSeguroClub = 0;
														bTieneSeguroAfirme = false;

														for (i = 0; i < pCuentaCliente->iCuentas; i++)
														{
															if (pCuentaCliente->pCuenta[i].iTipoDeCuenta == CUENTA_SEGURO) //Cuenta de Seguros
															{
																sprintf_s(cMensajeSeguimiento, "desplegarDatosCliente: cuenta de seguro tipo cuenta:%d, Folio:%ld", pCuentaCliente->pCuenta[i].iTipoDeCuenta, pCuentaCliente->pCuenta[i].lFolio);
																grabarLog(cMensajeSeguimiento);
																if (pCuentaCliente->pCuenta[i].cClaveSeguro != 'C' && pCuentaCliente->pCuenta[i].cClaveSeguro != 'Q')
																{
																	bTieneSeguroAfirme = true;
																	iSegurosAfirme++;
																}
															}
														}

														sprintf_s(cMensajeSeguimiento, "CDlgCapturarAbono::desplegarDatosCliente--> validando si el cliente tiene seguros");
														grabarLog(cMensajeSeguimiento);

														for (i = 0; i < pCuentaCliente->iCuentas; i++)
														{
															if (pCuentaCliente->pCuenta[i].iTipoDeCuenta == CUENTA_SEGURO) //Cuenta de Seguros
															{
																sprintf_s(cMensajeSeguimiento, "CDlgCapturarAbono::desplegarDatosCliente--> Cliente tiene plan familiar");
																grabarLog(cMensajeSeguimiento);
																if (pCuentaCliente->pCuenta[i].cClaveSeguro == 'C')
																{
																	bBanderaTieneClub = true;
																	iFlagMesRegalado = 0;
																	iSiTieneSeguroClub = 1;  //si tiene seguro club

																	//3858.2
																	iDiaVencimientoCPF = (short)pCuentaCliente->pCuenta[i].tFechaVencimiento.dia();
																	iMesVencimientoCPF = (short)pCuentaCliente->pCuenta[i].tFechaVencimiento.mes();
																	iAnioVencimientoCPF = (short)pCuentaCliente->pCuenta[i].tFechaVencimiento.ano();

																	if (pCuentaCliente->pCuenta[i].cStatusSeguro == 'C' || pCuentaCliente->pCuenta[i].cClaveNoOfrecer == 'S') //si es seguro club
																	{
																		if (pCuentaCliente->pCuenta[i].iCantidadSeguros == 0 && iFlagSeguroAuto == 1 && !bTieneSeguroAuto && !bTieneSeguroAfirme)
																		{
																			sprintf_s(pCuentaCliente->pCuenta[i].cDescripcion, "AUTO PROT.");
																			pCuentaCliente->pCuenta[i].cStatusSeguro = 'S';
																			pCuentaCliente->pCuenta[i].cClaveSeguro = 'Q';
																			pCuentaCliente->pCuenta[i].lFolio = 0;
																			pCuentaCliente->pCuenta[i].iCantidadSeguros = 0;
																		}
																	}
																	//break;
																}

															}
															else if (pCuentaCliente->pCuenta[i].iTipoDeCuenta == CUENTA_PLANSALUD)//3858 Cuenta de Plan de salud
															{
																sprintf_s(cMensajeSeguimiento, "CDlgCapturarAbono::desplegarDatosCliente--> Cliente tiene plan de salud");
																grabarLog(cMensajeSeguimiento);
																bBanderaTienePlan = true;
															}
														}


														if ((iEdadCliente >= iEdadMinimaClub && iEdadCliente <= iEdadMaximaClub) && !bBanderaTieneClub)
														{
															sprintf_s(cMensajeSeguimiento, "CDlgCapturarAbono::desplegarDatosCliente--> Cliente candidato a plan familiar");
															grabarLog(cMensajeSeguimiento);
															bCandidatoSeguro = true;
															if (pCuentaCliente->iCuentas > 0)
															{
																for (i = pCuentaCliente->iCuentas + 1; i > 0; i--)
																{
																	if ((pCuentaCliente->pCuenta[i - 1].iTipoDeCuenta != CUENTA_ROPA || (pCuentaCliente->pCuenta[i - 1].iTipoDeCuenta == CUENTA_ROPA && pCuentaCliente->pCuenta[i - 1].bCuentaZ)) && pCuentaCliente->pCuenta[i - 1].iTipoDeCuenta != CUENTA_SEGURO)
																	{
																		pCuentaCliente->pCuenta[i] = pCuentaCliente->pCuenta[i - 1];
																	}
																	else
																	{
																		break;
																	}
																}
															}

															//Inicializa la posicion donde estara la cuenta de seguro club.
															CCuentaClienteWeb pCuenta;
															pCuentaCliente->pCuenta[i] = pCuenta;

															//Se agrega la cuenta de seguro club
															pCuentaCliente->pCuenta[i].iTipoDeCuenta = CUENTA_SEGURO;
															pCuentaCliente->pCuenta[i].cStatusSeguro = 'S';
															pCuentaCliente->pCuenta[i].iTienda = (short)iTiendaDlg;
															pCuentaCliente->pCuenta[i].lFolio = 0;
															pCuentaCliente->pCuenta[i].iCantidadSeguros = 1;
															pCuentaCliente->pCuenta[i].cClaveSeguro = 'C';
															sprintf_s(pCuentaCliente->pCuenta[i].cDescripcion, "P.FAMILIAR");
															pCuentaCliente->pCuenta[i].tFechaVencimiento.ponerFecha(iDiaActual, iMesActual, iAnioActual);

															iTotalCuentas++;
															pCuentaCliente->iCuentas++;
														}

														//3858
														if (iFlagPlandeSalud == 1) // si la tienda esta configurada para ofrecer CPS
														{
															if ((iEdadCliente >= iEdadMinimaPlan && iEdadCliente <= iEdadMaximaPlan) && !bBanderaTienePlan) // cliente es candidato al CPS
															{
																sprintf_s(cMensajeSeguimiento, "CDlgCapturarAbono::desplegarDatosCliente--> Cliente candidato a plan de salud");
																grabarLog(cMensajeSeguimiento);
																bCandidatoPSVenta = true;
																if (pCuentaCliente->iCuentas > 1 || bBanderaTieneClub || !bCandidatoSeguro)
																{
																	for (i = pCuentaCliente->iCuentas + 1; i > 0; i--)
																	{
																		if ((pCuentaCliente->pCuenta[i - 1].iTipoDeCuenta != CUENTA_ROPA || (pCuentaCliente->pCuenta[i - 1].iTipoDeCuenta == CUENTA_ROPA && pCuentaCliente->pCuenta[i - 1].bCuentaZ)) && pCuentaCliente->pCuenta[i - 1].iTipoDeCuenta != CUENTA_SEGURO && pCuentaCliente->pCuenta[i - 1].iTipoDeCuenta != CUENTA_PLANSALUD)
																		{
																			pCuentaCliente->pCuenta[i] = pCuentaCliente->pCuenta[i - 1];
																		}
																		else
																		{
																			break;
																		}
																	}
																}
																else
																{
																	i++;
																}

																//Inicializa la posicion donde estara la cuenta de plan de salud
																CCuentaClienteWeb pCuenta;
																pCuentaCliente->pCuenta[i] = pCuenta;

																//Se agrega la cuenta de de plan de salud
																pCuentaCliente->pCuenta[i].iTipoDeCuenta = CUENTA_PLANSALUD;
																pCuentaCliente->pCuenta[i].cStatusSeguro = 'S';
																pCuentaCliente->pCuenta[i].iTienda = (short)iTiendaDlg;
																pCuentaCliente->pCuenta[i].lFolio = 0;
																pCuentaCliente->pCuenta[i].iCantidadSeguros = 1;
																pCuentaCliente->pCuenta[i].cClaveSeguro = 'C';
																sprintf_s(pCuentaCliente->pCuenta[i].cDescripcion, "P.SALUD");
																pCuentaCliente->pCuenta[i].tFechaVencimiento.ponerFecha(iDiaActual, iMesActual, iAnioActual);

																iTotalCuentas++;
																pCuentaCliente->iCuentas++;
															}
														}

														//23632: Se agrega la cuenta de candidato al CPV para definir columna de invitacin:
														if (!bTieneSeguroAuto) {
															bCandidatoCPVenta = true;
															if (pCuentaCliente->iCuentas > 1) {
																for (i = (pCuentaCliente->iCuentas + 1); i > 0; i--) {
																	if (pCuentaCliente->pCuenta[i - 1].iTipoDeCuenta != CUENTA_SEGURO && pCuentaCliente->pCuenta[i - 1].iTipoDeCuenta != CUENTA_PLANSALUD && pCuentaCliente->pCuenta[i - 1].iTipoDeCuenta != CUENTA_SEGUROAUTO) {
																		pCuentaCliente->pCuenta[i] = pCuentaCliente->pCuenta[i - 1];
																	}
																	else {
																		break;
																	}
																}
															}

															//Inicializa la posicin donde estar la cuenta de seguro CPV:
															memset(&pCuentaCliente->pCuenta[i], 0, sizeof(CCuentaClienteWeb) - (sizeof(SMaestroDetalle)*NUM_CTAS_DETALLE) - (sizeof(SCuentaPerdidaDetalle)*NUM_CTAS_DETALLE) - (sizeof(SqlTimeStamp) * 16));
															pCuentaCliente->pCuenta[i].tFechaVenta.ponerFecha(1, 1, 1900);
															pCuentaCliente->pCuenta[i].tFechaPrestamo.ponerFecha(1, 1, 1900);
															pCuentaCliente->pCuenta[i].tFechaSaldaCon.ponerFecha(1, 1, 1900);
															pCuentaCliente->pCuenta[i].tFechaVencimiento.ponerFecha(1, 1, 1900);
															pCuentaCliente->pCuenta[i].tFechaUltimaCompra.ponerFecha(1, 1, 1900);
															pCuentaCliente->pCuenta[i].tFechaUltimoMovimiento.ponerFecha(1, 1, 1900);
															pCuentaCliente->pCuenta[i].tFechaCancelacion.ponerFecha(1, 1, 1900);
															pCuentaCliente->pCuenta[i].tFechaNoOfrecer.ponerFecha(1, 1, 1900);
															pCuentaCliente->pCuenta[i].tFechaAfiliacion.ponerFecha(1, 1, 1900);
															pCuentaCliente->pCuenta[i].tFechaCambioBeneficiario.ponerFecha(1, 1, 1900);
															pCuentaCliente->pCuenta[i].tFechaUltimoPago.ponerFecha(1, 1, 1900);
															pCuentaCliente->pCuenta[i].tFechaNacimientoAdicional.ponerFecha(1, 1, 1900);
															pCuentaCliente->pCuenta[i].tFechaActivacion.ponerFecha(1, 1, 1900);
															pCuentaCliente->pCuenta[i].tFechaInicioVigencia.ponerFecha(1, 1, 1900);
															pCuentaCliente->pCuenta[i].tFechaFinVigencia.ponerFecha(1, 1, 1900);
															pCuentaCliente->pCuenta[i].tFechaSaldaConCorte.ponerFecha(1, 1, 1900);
															for (int l = 0; l < NUM_CTAS_DETALLE; l++) {
																pCuentaCliente->pCuenta[i].stCuentaPerdidaDetalle[l].cFechaDificilCobro.ponerFecha(1, 1, 1900);
																pCuentaCliente->pCuenta[i].stCuentaPerdidaDetalle[l].cFechaUltimaCompra.ponerFecha(1, 1, 1900);
																pCuentaCliente->pCuenta[i].stMaestroDetalle[l].cFechaUltimaCompra.ponerFecha(1, 1, 1900);
															}
															//Se agrega la cuenta de de CPV:
															pCuentaCliente->pCuenta[i].iTipoDeCuenta = CUENTA_SEGUROAUTO;
															pCuentaCliente->pCuenta[i].cStatusSeguro = 'S';
															pCuentaCliente->pCuenta[i].iTienda = (short)iTiendaDlg;
															pCuentaCliente->pCuenta[i].lFolio = 0;
															pCuentaCliente->pCuenta[i].iCantidadSeguros = 1;
															pCuentaCliente->pCuenta[i].cClaveSeguro = 'Q';
															sprintf_s(pCuentaCliente->pCuenta[i].cDescripcion, "AUTO PROT.");
															pCuentaCliente->pCuenta[i].tFechaVencimiento.ponerFecha(iDiaActual, iMesActual, iAnioActual);
															iTotalCuentas++;
															pCuentaCliente->iCuentas++;
														}

														if (iTotalCuentas == 0) cClaveA[0] = 'A';
														if (iTotalCuentas > 8) m_flecha.ShowWindow(true);
														m_grid.iTotalCuentas = iTotalCuentas;
														iColumna = m_grid.GetCurrentCol();

														sDato.Format("%d de %d", iColumna + 1, iTotalCuentas);
														m_grid2.QuickSetText(0, 1, sDato);
														m_grid2.QuickSetAlignment(0, 1, UG_ALIGNCENTER);
														m_grid2.RedrawAll();

														sDato.Format("%d", iTotalCuentas);
														m_grid2.QuickSetText(0, 0, sDato);
														m_grid2.QuickSetAlignment(0, 0, UG_ALIGNCENTER);

														iColumna = m_grid.GetCurrentCol();

														sDato.Format("%d de %d", iColumna + 1, iTotalCuentas);
														m_grid2.QuickSetText(0, 1, sDato);
														m_grid2.QuickSetAlignment(0, 1, UG_ALIGNCENTER);

														usingx("#,###,###", cRespuesta, (double)(pCuentaCliente->totalesCuenta.lBaseTotal + pCuentasSeguros->lBaseTotal ));
														cRespuesta[9] = 0;
														sDato.Format("%s", cRespuesta);
														m_grid2.QuickSetText(0, 14, sDato);
														m_grid2.QuickSetAlignment(0, 14, UG_ALIGNRIGHT);
														iAbonoBaseTotalInicial = pCuentaCliente->totalesCuenta.lBaseTotal;
														iAbonoBaseTotalConv = pCuentaCliente->totalesCuenta.lBaseTotal;

														m_grid2.RedrawAll();

														m_grid.bLlenarGrid = true;

														if (iFlagConsultaDomiciliacion == 1)
														{
															m_grid.QuickSetText(-1, 4, "DOMICILIADA");

															if (iFlagDomiciliacionCuentas == 1 || (m_grid.cArea == 'R' && iFlagMenuDomiciliacionDeRopa == 1) || (m_grid.cArea == 'M' && iFlagMenuDomiciliacionDeMuebles == 1))//OBTIENE EL ESTATUS DE LA DOMICILIACION DE LAS CUENTAS
															{
																//if (iFlagTiendaLocal == 0)
																//{
																	ObtenerEstatusDomiciliacionCuenta(pCuentaCliente);
																//}
															}
														}

														//ciclo para saber si tiene seguro club el cliente
														sprintf_s(cMensajeSeguimiento, "CDlgCapturarAbono::desplegarDatosCliente--> leyendo cuentas del cliente");
														grabarLog(cMensajeSeguimiento);

														for (i = 0; i < iTotalCuentas; i++)
														{
															if (i == 0)
															{
																for (int j = 22; j < 34; j++) //ciclo para blanquear las columnas ocultas de la 22 a la 32
																{
																	sDato.Format("%d", 0);
																	m_grid.QuickSetText(k, j, sDato);
																	m_grid.RedrawCell(k, j);
																}
															}

															if (i >= m_grid.GetNumberCols() - 1)
															{
																m_grid.AppendCol();

																for (int j = 0; j < m_grid.GetNumberCols(); j++)
																{
																	fontID = m_grid.AddFont("Lucida Console Bold", 14, 200);
																	m_grid.QuickSetFont(j, -1, fontID);

																	m_grid.SetColWidth(j, 83);

																	m_grid.m_cell.SetBackColor(RGB(236, 233, 216));
																	m_grid.SetCell(j, 11, &m_grid.m_cell);
																	m_grid.RedrawCell(j, 11);
																	m_grid.m_cell.SetBackColor(RGB(236, 233, 216));
																	m_grid.SetCell(j, 17, &m_grid.m_cell);
																	m_grid.RedrawCell(j, 17);
																	m_grid.m_cell.SetBackColor(RGB(236, 233, 216));
																	m_grid.SetCell(j, 20, &m_grid.m_cell);
																	m_grid.RedrawCell(j, 20);
																}
															}

															sDato.Format("%d", 1); //Status
															m_grid.QuickSetText(k, 30, sDato);
															m_grid.RedrawCell(k, 30);

															//AQUI SE HACE VALIDACION PARA PODER ESCONDER COLUMNA DE CLUB DE PROTECCION FAMILIAR peticion 15922
															char cSql[150] = { 0 };
															int iTotal = 0, iFlagNoOfrecer = 0;

															obtenerFlag('C', FLAGC_NOOFRECERCLUB, iFlagNoOfrecer);
															if (iFlagNoOfrecer == 1)
															{

																CMaximo consultaclientecolumna(&odbc_1);

																sprintf_s(cSql, "select count(1) from mae_crcomplementoclientes mcc WHERE mcc.num_cliente = %ld and mcc.opc_complemento= 5", m_grid.lCliente);

																if (consultaclientecolumna.Exec(cSql))
																{

																	consultaclientecolumna.activarCols();
																	if (consultaclientecolumna.leer())
																	{
																		iTotal = consultaclientecolumna.Total;
																	}
																	if (iTotal >= 1)
																	{
																		if (pCuentaCliente->pCuenta[i].cClaveSeguro == 'C' && pCuentaCliente->pCuenta[i].iTipoDeCuenta == CUENTA_SEGURO)
																		{
																			cClaveNoOfrecer = 'S';
																			iFlagOk = 1;
																			bConsultarSeguro = false;
																			iRestarCuentas = 1;

																		}
																		else
																		{
																			iFlagOk = -1;
																			bConsultarSeguro = true;
																		}

																	}
																	else
																	{
																		iFlagOk = -1;
																		bConsultarSeguro = true;
																	}
																}
																else
																{
																	iFlagOk = -1;
																	bConsultarSeguro = true;
																}
															}
															else
															{
																iFlagOk = -1;
																bConsultarSeguro = true;
															}
															//termina para peticion 15922

															if (pCuentaCliente->pCuenta[i].iTipoDeCuenta == CUENTA_SEGURO) //Cuenta de Seguros
															{
																sprintf_s(cMensajeSeguimiento, "CDlgCapturarAbono::desplegarDatosCliente--> leyendo cuenta de seguros");
																grabarLog(cMensajeSeguimiento);
																//SE VALIDA EL iFlagOk !=1 para poder mostrar o no columna P.FAMILIAR PET.15922
																if (bConsultarSeguro)
																{
																	//SE VALIDA EL iFlagOk !=1 para poder mostrar o no columna P.FAMILIAR PET.15922
																	if (iFlagOk != 1)
																	{
																		if (iFlagTieneSeguroAdicional == 0 && !borrarTemporalesSeguroAdicional())
																		{
																			iFlagOk = 0;
																		}
																		if (pCuentaCliente->pCuenta[i].cClaveSeguro != 'Q')
																		{
																			if (pCuentaCliente->pCuenta[i].iTipoSeguro == 2 && pCuentaCliente->pCuenta[i].cClaveSeguro == 'C')
																			{
																				if (iFlagTieneSeguroAdicional == 0)
																				{
																					if (iSeguroVigente == 0)
																					{
																						sprintf(cFecha1, "%04d%02d%02d", iAnioActual, iMesActual, iDiaActual);
																						sprintf(cFecha2, "%04d%02d%02d", pCuentaCliente->pCuenta[i].tFechaVencimiento.ano(), pCuentaCliente->pCuenta[i].tFechaVencimiento.mes(), pCuentaCliente->pCuenta[i].tFechaVencimiento.dia());

																						if (atol(cFecha1) <= atol(cFecha2))
																						{
																							iSeguroVigente = 1;
																						}
																					}

																					if (!grabarTmpCacarMovSeguros())
																					{
																						AfxMessageBox("ERROR AL GRABAR SEGUROS ADICIONALES EN LA TABLA TMPCACARMOVSEGUROS");
																						iFlagOk = 0;
																					}

																					if (iSegurosAdicionales == 0)
																					{
																						iSegurosInvalidos++;
																						continue;
																					}

																					lCuota += consultarCuotaAdicionales(false); //Se suma la cuota de los seguros adicionales del cliente
																				}

																				lCuotaClub = lCuota;

																				iFlagTieneSeguroAdicional = 1; //Tiene Seguro Adicional

																				if (iColumnaClub == -1)
																				{
																					iColumnaClub = i;
																				}

																				sDato.Format("ADIC %d", iSegurosAdicionales);
																				m_grid.QuickSetText(iColumnaClub, 5, sDato);
																				m_grid.QuickSetAlignment(iColumnaClub, 5, UG_ALIGNCENTER);

																				usingx("###,###", cTexto, (double)lCuota);
																				m_grid.QuickSetText(iColumnaClub, 16, cTexto);
																				m_grid.QuickSetAlignment(iColumnaClub, 16, UG_ALIGNCENTER);

																				continue;
																			}

																			if (pCuentaCliente->pCuenta[i].cClaveSeguro == 'C' && (pCuentaCliente->pCuenta[i].cStatusSeguro == 'C' || pCuentaCliente->pCuenta[i].cClaveNoOfrecer == 'S'))
																			{
																				iSeguroCancelado++;
																				continue;
																			}

																			lBaseCcuenta = pCuentaCliente->pCuenta[i].lBase;
																			sDato.Format("%06ld", pCuentaCliente->pCuenta[i].lFolio);
																			m_grid.QuickSetText(k, 1, sDato);
																			m_grid.QuickSetAlignment(k, 1, UG_ALIGNRIGHT);

																			sprintf_s(cMensajeSeguimiento, "desplegarDatosCliente: Folio: %ld", pCuentaCliente->pCuenta[i].lFolio);
																			grabarLog(cMensajeSeguimiento);

																			if (pCuentaCliente->pCuenta[i].cClaveSeguro != 'C')
																			{
																				m_grid.QuickSetText(k, -1, "SEGURO");
																				sDato.Format("%04d", pCuentaCliente->pCuenta[i].iTienda);
																				m_grid.QuickSetText(k, 0, sDato);
																				m_grid.QuickSetAlignment(k, 0, UG_ALIGNRIGHT);
																				snomcuenta.Format("SEGURO");
																				snomcuenta.Trim();


																			}
																			else
																			{
																				iFoliosSegurosActual[0] = pCuentaCliente->pCuenta[i].lFolio;
																				m_grid.QuickSetText(k, -1, "P.FAMILIAR");
																				if (iColumnaClub == -1)
																				{
																					iColumnaClub = i;
																				}
																				snomcuenta.Format("P.FAMILIAR");
																				snomcuenta.Trim();
																			}

																			m_grid.QuickSetText(k, 15, "CUOTA");
																			m_grid.QuickSetAlignment(k, 15, UG_ALIGNCENTER);

																			sprintf_s(cMensajeSeguimiento, "Metodo TieneSeguroClub 1");
																			grabarLog(cMensajeSeguimiento);

																			bIndividual = tieneSeguroClub(cStatusSeguro, cTipoCan, cClaveNoOfrecer, lFolioSeguroi, bCteSeguro);
																			if (bIndividual && pCuentaCliente->pCuenta[i].lFactura == lFolioSeguroi)
																			{
																				iConyugal = 1;
																			}
																			sprintf_s(cMensajeSeguimiento, "Metodo TieneSeguroClubConyugal 1");
																			grabarLog(cMensajeSeguimiento);
																			bConyugal = tieneSeguroClubConyugal(cStatusSeguro, cTipoCan, cClaveNoOfrecer, lFolioSeguroc);

																			lFecha1 = (long)iAnioActual*(long)12 + (long)iMesActual;
																			if (iFlagBanorte != 0 && pCuentaCliente->pCuenta[i].cClaveSeguro == 'C')
																			{
																				if (iConyugal == 1)
																				{
																					grabarLog("Consulta Precio seguro 3");
																					if (!consultarPrecioSeguroClub(lCuota, (short)pCuentaCliente->pCuenta[i].iCantidadSeguros, 1))
																					{
																						bConsulta = false;
																						iFlagConsulta = 0;
																					}
																				}
																				else
																				{
																					lCuota = obtenerCuotaClub(m_grid.lCliente, pCuentaCliente->pCuenta[i].iCantidadSeguros, iNumeroMeses, iFlagBanorte, &odbc, &odbc_1, cSqlTxt, bConsulta, iFlagConsulta, iConyugal); //cawcuota.cpp
																				}

																				if (iFlagTieneSeguroAdicional == 1)
																				{
																					lCuota += consultarCuotaAdicionales(false); //Se suma la cuota de los seguros adicionales del cliente
																				}

																				if (bConsulta != true && iFlagConsulta != 1)
																				{
																					grabarMensajeError("C", m_grid.iCaja, (LPTSTR)(LPCTSTR)m_grid.sServer, "CA0030", "CDlgCapturarAbono", "desplegarDatosCliente 1", (LPTSTR)(LPCTSTR)cSqlTxt, m_grid.lEmpleado, "ERROR EN LA CONSULTA(desplegarDatosCliente 1)", &odbc, m_grid.iMuestraMsg);
																					lCuota = 0;
																				}
																				lCuotaTemporal = lCuota;
																			}
																			else
																			{
																				lCuota = obtenerCuotaSeguro(iAnioNacimiento, iMesNacimiento, &odbc, cSqlTxt, bConsulta, iFlagConsulta); //cawcuota.cpp
																				if (!bConsulta && iFlagConsulta != 1)
																				{
																					grabarMensajeError("C", m_grid.iCaja, (LPTSTR)(LPCTSTR)m_grid.sServer, "CA0030", "CDlgCapturarAbono", "desplegarDatosCliente 2", (LPTSTR)(LPCTSTR)cSqlTxt, m_grid.lEmpleado, "ERROR EN LA CONSULTA(desplegarDatosCliente 2)", &odbc, m_grid.iMuestraMsg);
																					lCuota = 0;
																				}
																			}
																			usingx("###,###", cTexto, (double)lCuota);
																			m_grid.QuickSetText(k, 16, cTexto);
																			m_grid.QuickSetAlignment(k, 16, UG_ALIGNCENTER);

																			{
																				if (pCuentaCliente->pCuenta[i].iCantidadSeguros == 0)
																				{
																					//sDato.Format( " SEGS   %d", pCuentaCliente->pCuenta[i].iCantidadSeguros+1 );
																					sDato.Format("%s", cPlanSeguroClub);
																					iCantidadSegurosClub = pCuentaCliente->pCuenta[i].iCantidadSeguros + 1;
																				}
																				else
																				{
																					//sDato.Format( " SEGS   %d", pCuentaCliente->pCuenta[i].iCantidadSeguros );
																					sDato.Format("%s", cPlanSeguroClub);
																					iCantidadSegurosClub = pCuentaCliente->pCuenta[i].iCantidadSeguros;
																				}
																				m_grid.QuickSetText(k, 12, sDato);
																				m_grid.QuickSetAlignment(k, 12, UG_ALIGNCENTER);
																			}

																			if (pCuentaCliente->pCuenta[i].cClaveSeguro == 'C')
																			{
																				if (((int)pCuentaCliente->pCuenta[i].tFechaVencimiento.dia() == 01 && (int)pCuentaCliente->pCuenta[i].tFechaVencimiento.ano() == 1900) || !bBanderaTieneClub)
																				{
																					if (iConyugal == 1)
																					{
																						grabarLog("Consulta Precio seguro 4");
																						consultarPrecioSeguroClub(lCuota, (short)pCuentaCliente->pCuenta[i].iCantidadSeguros, 1);
																						m_grid.QuickSetText(k, 2, " AFILIAR  ");
																						m_grid.QuickSetAlignment(k, 2, UG_ALIGNCENTER);

																						//9923 --> cambiar tamaño de letra
																						fontID = m_grid.AddFont("Lucida Console Bold", 14, 600);
																						m_grid.QuickSetFont(k, 3, fontID);
																						m_grid.QuickSetText(k, 3, " P. FAMILIAR ");

																						m_grid.QuickSetAlignment(k, 3, UG_ALIGNCENTER);

																						m_grid.QuickSetText(k, 1, "         ");
																						m_grid.QuickSetAlignment(k, 1, UG_ALIGNRIGHT);
																					}
																					else
																					{
																						lCuota = obtenerCuotaClub(m_grid.lCliente, pCuentaCliente->pCuenta[i].iCantidadSeguros, iNumeroMeses, iFlagBanorte, &odbc, &odbc_1, cSqlTxt, bConsulta, iFlagConsulta, iConyugal); //cawcuota.cpp

																						m_grid.QuickSetText(k, 1, " AFILIAR  ");
																						m_grid.QuickSetAlignment(k, 1, UG_ALIGNCENTER);

																						m_grid.QuickSetText(k, 2, " AL CLUB ");
																						m_grid.QuickSetAlignment(k, 2, UG_ALIGNCENTER);

																						m_grid.QuickSetText(k, 3, " CONYUGAL");
																						m_grid.QuickSetAlignment(k, 3, UG_ALIGNCENTER);
																					}
																				}
																				else
																				{
																					sprintf_s(cMensajeSeguimiento, "Metodo TieneSeguroClub 2");
																					grabarLog(cMensajeSeguimiento);
																					bIndividual = tieneSeguroClub(cStatusSeguro, cTipoCan, cClaveNoOfrecer, lFolioSeguroi, bCteSeguro);
																					if (bIndividual && pCuentaCliente->pCuenta[i].lFolio == lFolioSeguroi)
																					{
																						m_grid.QuickSetText(k, 2, " AFILIADO  ");
																						m_grid.QuickSetAlignment(k, 2, UG_ALIGNCENTER);

																						//9923 --> CAMBIAR TAMAÑO LETRA
																						fontID = m_grid.AddFont("Lucida Console Bold", 14, 600);
																						m_grid.QuickSetFont(k, 3, fontID);
																						m_grid.QuickSetText(k, 3, " P. FAMILIAR ");
																						m_grid.QuickSetAlignment(k, 2, UG_ALIGNCENTER);
																					}
																					sprintf_s(cMensajeSeguimiento, "Metodo TieneSeguroClubConyugal 2");
																					grabarLog(cMensajeSeguimiento);
																					bConyugal = tieneSeguroClubConyugal(cStatusSeguro, cTipoCan, cClaveNoOfrecer, lFolioSeguroc);
																					if (bConyugal && pCuentaCliente->pCuenta[i].lFolio == lFolioSeguroc)
																					{
																						m_grid.QuickSetText(k, 2, "AFIL CLUB");
																						m_grid.QuickSetAlignment(k, 2, UG_ALIGNCENTER);

																						m_grid.QuickSetText(k, 3, "CONYUGAL");
																						m_grid.QuickSetAlignment(k, 2, UG_ALIGNCENTER);
																					}
																				}
																			}
																			else
																			{
																				m_grid.QuickSetText(k, 3, "  VENCE    ");
																				m_grid.QuickSetAlignment(k, 3, UG_ALIGNCENTER);
																			}

																			//Seguro Adicional
																			lCuotaClub = lCuota;

																			if (iFlagReactivo == 1 && iFlagIncrementa == 1 && pCuentaCliente->pCuenta[i].cClaveSeguro == 'C') iNumeroMeses = 1;

																			if (bBanderaTieneClub || pCuentaCliente->pCuenta[i].cClaveSeguro != 'C') //no tiene seguro club su fecha venc. es la fecha actual
																			{
																				iDiaV = pCuentaCliente->pCuenta[i].tFechaVencimiento.dia();
																				iMesV = pCuentaCliente->pCuenta[i].tFechaVencimiento.mes();
																				iAnioV = pCuentaCliente->pCuenta[i].tFechaVencimiento.ano();
																			}
																			else
																			{
																				iDiaV = iDiaActual;
																				iMesV = iMesActual;
																				iAnioV = iAnioActual;
																			}

																			if (iNumeroMeses != 0)
																			{
																				if (iFlagBanorte != 0 && pCuentaCliente->pCuenta[i].cClaveSeguro == 'C')
																				{
																					//ca_vense.cpp
																					calcularVencimientoClub(iDiaV, iMesV, iAnioV, iNumeroMeses, iDiaActual, iMesActual, iAnioActual);
																				}
																				else
																				{
																					//ca_vense.cpp
																					calcularFechaVencimientoSeguroAfirme(iNumeroMeses, iDiaV, iMesV, iAnioV, iDiaActual, iMesActual, iAnioActual);
																				}

																				sDato.Format(" # MESES %d ", iNumeroMeses);
																				m_grid.QuickSetText(k, 13, sDato);
																				m_grid.QuickSetAlignment(k, 13, UG_ALIGNCENTER);

																				if (pCuentaCliente->pCuenta[i].cClaveSeguro != 'C')
																				{
																					if (pCuentaCliente->pCuenta[i].iCantidadSeguros == 0)
																					{
																						sDato.Format(" SEGS   %d", pCuentaCliente->pCuenta[i].iCantidadSeguros + 1);
																					}
																					else
																					{
																						sDato.Format(" SEGS   %d", pCuentaCliente->pCuenta[i].iCantidadSeguros);
																					}
																					m_grid.QuickSetText(k, 12, sDato);
																					m_grid.QuickSetAlignment(k, 12, UG_ALIGNCENTER);
																				}

																				if (iFlagMesRegalado == 1 && pCuentaCliente->pCuenta[i].cClaveSeguro == 'C')  //se le va regalar 1 mes de seguro mas
																				{
																					if (iMesV + 1 > 12)
																					{
																						miniFecha(cTexto, iDiaV, 1, iAnioV + 1);
																					}
																					else
																					{
																						if (iDiaV == 31)
																						{
																							if (iMesV + 1 == 4 || iMesV + 1 == 6 || iMesV + 1 == 9 || iMesV + 1 == 11) iDiaV = 30;
																						}

																						if (iDiaV >= 28 && (iMesV + 1) == 2)
																						{
																							iDiaV = 28;
																							if (checar_bisiesto(iAnioV) == 1)
																								iDiaV = 29;
																						}

																						miniFecha(cTexto, iDiaV, iMesV + 1, iAnioV);
																					}
																				}
																				else
																				{
																					miniFecha(cTexto, pCuentaCliente->pCuenta[i].tFechaVencimiento.dia(), pCuentaCliente->pCuenta[i].tFechaVencimiento.mes(), pCuentaCliente->pCuenta[i].tFechaVencimiento.ano());
																				}
																				if (bBanderaTieneClub || pCuentaCliente->pCuenta[i].cClaveSeguro != 'C') //si tiene seguro club
																				{
																					m_grid.QuickSetText(k, 4, cTexto);
																					m_grid.QuickSetAlignment(k, 4, UG_ALIGNCENTER);
																				}
																				m_grid.QuickSetText(k, 33, cTexto);
																				m_grid.QuickSetAlignment(k, 33, UG_ALIGNCENTER);

																			}
																			else
																			{
																				//para cuando cartera procese a¤o >= 2000 con nulos
																				if (iAnioV < 50) iAnioV += 100;

																				lFecha1 = (long)iAnioActual * 372L +
																					(long)iMesActual * 31L +
																					(long)iDiaActual;

																				lFecha2 = (long)iAnioV * 372L +
																					(long)pCuentaCliente->pCuenta[i].tFechaVencimiento.mes() * 31L +
																					(long)pCuentaCliente->pCuenta[i].tFechaVencimiento.dia();

																				miniFecha(cTexto, (int)pCuentaCliente->pCuenta[i].tFechaVencimiento.dia(),
																					(int)pCuentaCliente->pCuenta[i].tFechaVencimiento.mes(),
																					(int)iAnioV);

																				if (lFecha1 > lFecha2)
																				{
																					if ((int)pCuentaCliente->pCuenta[i].tFechaVencimiento.ano() != 1900)
																					{
																						m_grid.QuickSetText(k, 2, "          ");
																						m_grid.QuickSetAlignment(k, 2, UG_ALIGNCENTER);

																						m_grid.QuickSetText(k, 3, "VENCIO EL");
																						m_grid.QuickSetAlignment(k, 3, UG_ALIGNCENTER);

																						if (bBanderaTieneClub || pCuentaCliente->pCuenta[i].cClaveSeguro != 'C') //si tiene seguro club
																						{
																							m_grid.QuickSetText(k, 4, cTexto);
																							m_grid.QuickSetAlignment(k, 4, UG_ALIGNCENTER);

																							sprintf_s(cTxt, "%02d%02d%04d", (int)pCuentaCliente->pCuenta[i].tFechaVencimiento.dia(), (int)pCuentaCliente->pCuenta[i].tFechaVencimiento.mes(), (int)iAnioV);

																							m_grid.QuickSetText(k, 33, cTxt);
																							m_grid.QuickSetAlignment(k, 33, UG_ALIGNCENTER);
																						}
																					}
																				}
																				else
																				{
																					if (bBanderaTieneClub || pCuentaCliente->pCuenta[i].cClaveSeguro != 'C') //si tiene seguro club o seguro afirme
																					{
																						m_grid.QuickSetText(k, 4, cTexto);
																						m_grid.QuickSetAlignment(k, 4, UG_ALIGNCENTER);

																						sprintf_s(cTxt, "%02d%02d%04d", (int)pCuentaCliente->pCuenta[i].tFechaVencimiento.dia(), (int)pCuentaCliente->pCuenta[i].tFechaVencimiento.mes(), (int)iAnioV);

																						m_grid.QuickSetText(k, 33, cTxt);
																						m_grid.QuickSetAlignment(k, 33, UG_ALIGNCENTER);
																					}
																					else
																					{
																						if (iFlagBanorte != 0 && pCuentaCliente->pCuenta[i].cClaveSeguro == 'C')
																						{
																							//ca_vense.cpp
																							calcularVencimientoClub(iDiaV, iMesV, iAnioV, iNumeroMeses, iDiaActual, iMesActual, iAnioActual);
																						}
																						else
																						{
																							//ca_vense.cpp
																							calcularFechaVencimientoSeguroAfirme(iNumeroMeses, iDiaV, iMesV, iAnioV, iDiaActual, iMesActual, iAnioActual);
																						}

																						if (iFlagMesRegalado == 1 && pCuentaCliente->pCuenta[i].cClaveSeguro == 'C')  //se le va regalar 1 mes de seguro mas
																						{
																							iMesV++;
																							if (iMesV + 1 > 12)
																							{
																								miniFecha(cTexto, iDiaV, 1, iAnioV + 1);
																								sprintf_s(cTxt, "%02d%02d%04d", iDiaV, 1, iAnioV + 1);

																							}
																							else
																							{
																								if (iDiaV == 31)
																								{
																									if (iMesV + 1 == 4 || iMesV + 1 == 6 || iMesV + 1 == 9 || iMesV + 1 == 11) iDiaV = 30;
																								}

																								if (iDiaV >= 28 && (iMesV + 1) == 2)
																								{
																									iDiaV = 28;
																									if (checar_bisiesto(iAnioV) == 1)
																										iDiaV = 29;
																								}

																								miniFecha(cTexto, iDiaV, iMesV + 1, iAnioV);
																								sprintf_s(cTxt, "%02d%02d%04d", iDiaV, iMesV + 1, iAnioV);
																							}
																						}
																						else
																						{
																							miniFecha(cTexto, pCuentaCliente->pCuenta[i].tFechaVencimiento.dia(), pCuentaCliente->pCuenta[i].tFechaVencimiento.mes(), pCuentaCliente->pCuenta[i].tFechaVencimiento.ano());
																							sprintf_s(cTxt, "%02d%02d%04d", pCuentaCliente->pCuenta[i].tFechaVencimiento.dia(), pCuentaCliente->pCuenta[i].tFechaVencimiento.mes(), pCuentaCliente->pCuenta[i].tFechaVencimiento.ano());
																						}
																						m_grid.QuickSetText(k, 33, cTxt);
																						m_grid.QuickSetAlignment(k, 33, UG_ALIGNCENTER);
																					}
																				}
																			}
																		}
																		if (pCuentaCliente->pCuenta[i].cClaveSeguro != 'C')  //seguro afirme
																		{

																			m_grid.QuickSetText(k, 24, "0");
																			m_grid.QuickSetAlignment(k, 24, UG_ALIGNCENTER);
																		}
																		else
																		{
																			sDato.Format("%d", -1);
																			m_grid.QuickSetText(k, 24, sDato);
																			m_grid.QuickSetAlignment(k, 24, UG_ALIGNCENTER);

																		}
																		sDato.Format("%d", pCuentaCliente->pCuenta[i].iCantidadSeguros);
																		m_grid.QuickSetText(k, 22, sDato);
																		m_grid.QuickSetAlignment(k, 22, UG_ALIGNCENTER);

																		sDato.Format("%d", 0);
																		m_grid.QuickSetText(k, 23, sDato);
																		m_grid.QuickSetAlignment(k, 23, UG_ALIGNCENTER);

																		sDato.Format("%d", pCuentaCliente->pCuenta[i].iCantidadSeguros);
																		m_grid.QuickSetText(k, 31, sDato);
																		m_grid.QuickSetAlignment(k, 31, UG_ALIGNCENTER);

																		sDato.Format("%02d%02d%04d", pCuentaCliente->pCuenta[i].tFechaVencimiento.dia(), pCuentaCliente->pCuenta[i].tFechaVencimiento.mes(), pCuentaCliente->pCuenta[i].tFechaVencimiento.ano());
																		sDato.Trim();
																		m_grid.QuickSetText(k, 25, sDato);
																		m_grid.QuickSetAlignment(k, 25, UG_ALIGNCENTER);

																		lFecha1 = (long)iAnioActual * 372L +
																			(long)iMesActual * 31L +
																			(long)iDiaActual;

																		lFecha2 = (long)iAnioV * 372L +
																			(long)pCuentaCliente->pCuenta[i].tFechaVencimiento.mes() * 31L +
																			(long)pCuentaCliente->pCuenta[i].tFechaVencimiento.dia();

																		if (lFecha1 <= lFecha2)
																		{
																			sDato.Format("%d", 1); //seguro vigente
																			m_grid.QuickSetText(k, 29, sDato);
																			m_grid.QuickSetAlignment(k, 29, UG_ALIGNRIGHT);
																			iSeguroVigente = 1;
																		}
																		else
																		{
																			sDato.Format("%d", 0); //seguro vencido
																			m_grid.QuickSetText(k, 29, sDato);
																			m_grid.QuickSetAlignment(k, 29, UG_ALIGNRIGHT);
																		}

																		sDato.Format("%ld", pCuentaCliente->pCuenta[i].iTipoProducto);
																		m_grid.QuickSetText(k, 36, sDato);
																		m_grid.RedrawCell(k, 36);
																	}
																	else
																	{
																		if (iFlagSeguroAuto == 1)
																		{
																			sDato.Format("%s", pCuentaCliente->pCuenta[i].cDescripcion);
																			m_grid.QuickSetText(k, -1, sDato);
																		}
																		else
																		{
																			continue;
																		}
																	}
																	//23632: Se elimina la columna CPV (candidato) dentro de la columna de CPF:
																	//Mensaje de Seguro de auto
																	/*if ( iFlagSeguroAuto == 1 && iFlagSupervisor != 1)
																	{
																	if( !buscarSegurosAuto() )
																	{
																	m_grid.QuickSetText(k,6," AFILIAR  ");
																	m_grid.QuickSetAlignment(k,6, UG_ALIGNCENTER );

																	m_grid.QuickSetText(k,7,"AL AUTO" );
																	m_grid.QuickSetAlignment(k,7, UG_ALIGNCENTER );

																	fontID = m_grid.AddFont("Lucida Console Bold", 14, 600);
																	m_grid.QuickSetFont(k,8, fontID);
																	m_grid.QuickSetText(k,8,"PROTECCIÓN" );
																	m_grid.QuickSetAlignment(k,8, UG_ALIGNCENTER );
																	}
																	}*/
																}
																if (iCandidatoAprobado == 1)
																{
																	sprintf_s(cJsonPostDescuentos, "\"tipoCuenta\":%d,\"saldoSinInteres\":%ld,\"interes\":%ld,\"vencidoSinInteres\":%ld"
																		",\"mesesVencidos\":%d,\"abonoBase\":%ld,\"facturaCuenta\":%ld,\"descripcionCuenta\":\"%s\",\"identificadorConvenio\":%d,""\"cuentaCandidata\":%d}"
																		, CUENTA_SEGURO, pCuentaCliente->pCuenta[i].lSaldo, pCuentaCliente->pCuenta[i].lInteresAdicional, pCuentaCliente->pCuenta[i].lVencido, 0, pCuentaCliente->pCuenta[i].lBase, pCuentaCliente->pCuenta[i].lFactura, (LPCTSTR)snomcuenta, 0, 0);

																	if (icuenta == 1)
																	{
																		sJsonPostDescuentoMoratorio.append(",{");
																	}

																	sJsonPostDescuentoMoratorio.append(cJsonPostDescuentos);
																	icuenta = 1;
																}
															}
															else if (pCuentaCliente->pCuenta[i].iTipoDeCuenta == CUENTA_SEGUROAUTO) {
																//23632: Se agrega valiacin para mostrar la columna CPV (candidato):
																if (!bTieneSeguroAuto && bCandidatoCPVenta) {
																	sDato.Format("%s", pCuentaCliente->pCuenta[i].cDescripcion);
																	m_grid.QuickSetText(k, -1, sDato);
																	m_grid.QuickSetText(k, 2, "AFILIAR");
																	m_grid.QuickSetAlignment(k, 2, UG_ALIGNCENTER);
																	fontID = m_grid.AddFont("Lucida Console Bold", 14, 600);
																	m_grid.QuickSetFont(k, 3, fontID);
																	sDato.Format("P. VIAL");
																	m_grid.QuickSetText(k, 3, sDato);
																	m_grid.QuickSetAlignment(k, 3, UG_ALIGNCENTER);
																	sDato.Format(obtenerPlanSeguroAuto(4));
																	m_grid.QuickSetText(k, 12, sDato);
																	m_grid.QuickSetAlignment(k, 12, UG_ALIGNCENTER);
																	sDato.Format("CUOTA");
																	m_grid.QuickSetText(k, 15, sDato);
																	m_grid.QuickSetAlignment(k, 15, UG_ALIGNCENTER);
																	lCuotaSeguroVial = obtenerCostoSeguroAuto(4, 1, 1);
																	usingx("###,###", cTexto, (double)lCuotaSeguroVial);
																	m_grid.QuickSetText(k, 16, cTexto);
																	m_grid.QuickSetAlignment(k, 16, UG_ALIGNCENTER);
																	m_grid.QuickSetText(k, 24, "0");
																	m_grid.QuickSetAlignment(k, 24, UG_ALIGNCENTER);
																}
																else { //Muestra la columna de venta de CPV (reactivacion):
																	sDato.Format("%s", pCuentaCliente->pCuenta[i].cDescripcion);
																	m_grid.QuickSetText(k, -1, sDato);
																	fontID = m_grid.AddFont("Lucida Console Bold", 14, 200);
																	m_grid.QuickSetFont(k, 1, fontID);
																	sprintf_s(cRespuesta, "%I64d", obtenerPolizaXML(pCuentaCliente->pCuenta[i].lPoliza));
																	m_grid.QuickSetText(k, 1, cRespuesta);
																	autoSeguro.lPoliza = pCuentaCliente->pCuenta[i].lPoliza;
																	if (pCuentaCliente->pCuenta[i].iSeguroVigente) {
																		sDato.Format("AFILIADO");
																	}
																	else {
																		sDato.Format("VENCIDO EL");
																	}
																	m_grid.QuickSetText(k, 2, sDato);
																	m_grid.QuickSetAlignment(k, 2, UG_ALIGNCENTER);
																	miniFecha(cFecha1, pCuentaCliente->pCuenta[i].tFechaVencimiento.dia(), pCuentaCliente->pCuenta[i].tFechaVencimiento.mes(), pCuentaCliente->pCuenta[i].tFechaVencimiento.ano());
																	sDato.Format("%s", cFecha1);
																	m_grid.QuickSetText(k, 3, sDato);
																	m_grid.QuickSetAlignment(k, 3, UG_ALIGNCENTER);
																	sDato.Format("SEG");
																	m_grid.QuickSetText(k, 12, sDato);
																	m_grid.QuickSetAlignment(k, 12, UG_ALIGNCENTER);
																	sDato.Format("CUOTA");
																	m_grid.QuickSetText(k, 15, sDato);
																	m_grid.QuickSetAlignment(k, 15, UG_ALIGNCENTER);
																	//Prima mensual del seguro:
																	sDato.Format("%ld", pCuentaCliente->pCuenta[i].lPrecioSeguro);
																	m_grid.QuickSetText(k, 16, sDato);
																	m_grid.QuickSetAlignment(k, 16, UG_ALIGNCENTER);
																	//Tipo cobertura:
																	sDato.Format("%hd", pCuentaCliente->pCuenta[i].iTipoCobertura);
																	m_grid.QuickSetText(k, 22, sDato);
																	//Meses pagados:
																	sDato.Format("%hd", pCuentaCliente->pCuenta[i].iMesesPagados);
																	m_grid.QuickSetText(k, 24, sDato);
																	//Fecha de Vencimiento:
																	sDato.Format("%02d%02d%04d", pCuentaCliente->pCuenta[i].tFechaVencimiento.dia(), pCuentaCliente->pCuenta[i].tFechaVencimiento.mes(), pCuentaCliente->pCuenta[i].tFechaVencimiento.ano());
																	m_grid.QuickSetText(k, 25, sDato);
																	//Modelo del carro:
																	sDato.Format("%hd", pCuentaCliente->pCuenta[i].iModelo);
																	m_grid.QuickSetText(k, 26, sDato);
																	//Fecha de activacin:
																	sDato.Format("%02d%02d%04d", pCuentaCliente->pCuenta[i].tFechaActivacion.dia(), pCuentaCliente->pCuenta[i].tFechaActivacion.mes(), pCuentaCliente->pCuenta[i].tFechaActivacion.ano());
																	m_grid.QuickSetText(k, 35, sDato);
																	//Tipo vehiculo:
																	sDato.Format("%hd", pCuentaCliente->pCuenta[i].iTipoVehiculo);
																	m_grid.QuickSetText(k, 34, sDato);
																	//Pliza Anterior Anterior:
																	sDato.Format("%ld", pCuentaCliente->pCuenta[i].lPolizaAnterior);
																	m_grid.QuickSetText(k, 29, sDato);
																	//Importe de venta:
																	sDato.Format("%ld", pCuentaCliente->pCuenta[i].lImporteVenta);
																	m_grid.QuickSetText(k, 30, sDato);
																	//Fecha Venta:
																	sDato.Format("%02d%02d%04d", pCuentaCliente->pCuenta[i].tFechaVenta.dia(), pCuentaCliente->pCuenta[i].tFechaVenta.mes(), pCuentaCliente->pCuenta[i].tFechaVenta.ano());
																	m_grid.QuickSetText(k, 31, sDato);
																}
																if (iCandidatoAprobado == 1)
																{
																	sprintf_s(cJsonPostDescuentos, "\"tipoCuenta\":%d,\"saldoSinInteres\":%ld,\"interes\":%ld,\"vencidoSinInteres\":%ld"
																		",\"mesesVencidos\":%d,\"abonoBase\":%ld,\"facturaCuenta\":%ld,\"descripcionCuenta\":\"%s\",\"identificadorConvenio\":%d,""\"cuentaCandidata\":%d}"
																		, CUENTA_SEGUROAUTO, pCuentaCliente->pCuenta[i].lSaldo, pCuentaCliente->pCuenta[i].lInteresAdicional, pCuentaCliente->pCuenta[i].lVencido, 0, pCuentaCliente->pCuenta[i].lBase, pCuentaCliente->pCuenta[i].lFactura, pCuentaCliente->pCuenta[i].cDescripcion, 0, 0);

																	if (icuenta == 1)
																	{
																		sJsonPostDescuentoMoratorio.append(",{");
																	}

																	sJsonPostDescuentoMoratorio.append(cJsonPostDescuentos);
																	icuenta = 1;
																}

															}

															else if (pCuentaCliente->pCuenta[i].iTipoDeCuenta == CUENTA_DINEROELECTRONICO)
															{
																continue;
															}//3858
															else if (pCuentaCliente->pCuenta[i].iTipoDeCuenta == CUENTA_PLANSALUD) //Cuenta de Plan de Salud
															{
																sprintf_s(cMensajeSeguimiento, "CDlgCapturarAbono::desplegarDatosCliente--> leyendo cuenta de plan de salud");
																grabarLog(cMensajeSeguimiento);
																if (bBorrarTemporalesPS)
																{
																	iColumnaPlan = (short)k;
																	borrarTemporalesPlan(); // borrar tablas temporales de plan de salud
																	bBorrarTemporalesPS = false;
																}

																if (pCuentaCliente->pCuenta[i].cStatusSeguro == 'C') // poliza cancelada
																{
																	iPlanCancelado++;
																	continue;
																}

																if (pCuentaCliente->pCuenta[i].i64IduAdicional > 0)
																{
																	iPlanAdicionales++;

																	iFlagTienePlanAdicional = 1; //Tiene Plan Adicional

																	// obtener importe de acuerdo al plan del adicional
																	lCuotaTemporalPS = 0;
																	consultarPrecioPlanSalud(lCuotaTemporalPS, lCuotaTemporalPS, lCuotaTemporalPS, pCuentaCliente->pCuenta[i].iCantidadSeguros, 4);
																	lCuotaAdicionalesPS += lCuotaTemporalPS;
																	lCuotaPS += lCuotaTemporalPS;

																	sDato.Format("ADIC %hd", iPlanAdicionales);
																	m_grid.QuickSetText(k - 1, 5, sDato);
																	m_grid.QuickSetAlignment(k - 1, 5, UG_ALIGNCENTER);

																	usingx("###,###", cTexto, (double)lCuotaPS);
																	m_grid.QuickSetText(k - 1, 16, cTexto);
																	m_grid.QuickSetAlignment(k - 1, 16, UG_ALIGNCENTER);

																	continue;
																}

																// titulo columna
																m_grid.QuickSetText(k, -1, "P.SALUD");

																lBaseCcuenta = pCuentaCliente->pCuenta[i].lBase; // este dato no se para que es

																// poliza
																sDato.Format("%I64d", pCuentaCliente->pCuenta[i].i64Poliza);
																m_grid.QuickSetText(k, 1, sDato);
																m_grid.QuickSetAlignment(k, 1, UG_ALIGNRIGHT);

																sprintf_s(cTexto, "%04d%02d%02d", iAnioActual, iMesActual, iDiaActual);
																if (pCuentaCliente->pCuenta[i].tFechaFinVigencia.ano() != 1900)
																{
																	iDiasVencidosPS = diasTranscurridos(cTexto, (short)pCuentaCliente->pCuenta[i].tFechaFinVigencia.dia(), (short)pCuentaCliente->pCuenta[i].tFechaFinVigencia.mes(), (short)pCuentaCliente->pCuenta[i].tFechaFinVigencia.ano());
																}
																else
																{
																	iDiasVencidosPS = 0;
																}

																if ((pCuentaCliente->pCuenta[i].tFechaFinVigencia.ano() == 1900 && (bCandidatoPSVenta || bCandidatoPSAbono)) /*|| (bBanderaTienePlan && iDiasVencidosPS > 90)*/)
																{
																	// leyenda AFILIAR para cliente candidato o con mas de 90 dias de vencido
																	m_grid.QuickSetText(k, 2, " AFILIAR  "); // renglon FECHA COMPRA
																	m_grid.QuickSetAlignment(k, 2, UG_ALIGNCENTER);

																	// limpiar celda de la poliza pues no tiene plan o tiene mas de 90 dias de vencido
																	m_grid.QuickSetText(k, 1, "         ");
																	m_grid.QuickSetAlignment(k, 1, UG_ALIGNRIGHT);
																}
																else
																{
																	// leyenda AFILIADO para cliente con plan activo o con menos de 90 dias de vencido
																	m_grid.QuickSetText(k, 2, " AFILIADO  "); // renglon FECHA COMPRA
																	m_grid.QuickSetAlignment(k, 2, UG_ALIGNCENTER);

																	// fecha vencimiento
																	miniFecha(cTexto, pCuentaCliente->pCuenta[i].tFechaFinVigencia.dia(), pCuentaCliente->pCuenta[i].tFechaFinVigencia.mes(), pCuentaCliente->pCuenta[i].tFechaFinVigencia.ano());
																	m_grid.QuickSetText(k, 4, cTexto);
																	m_grid.QuickSetAlignment(k, 4, UG_ALIGNCENTER);

																	iDiaVencimientoCPS = (short)pCuentaCliente->pCuenta[i].tFechaFinVigencia.dia();
																	iMesVencimientoCPS = (short)pCuentaCliente->pCuenta[i].tFechaFinVigencia.mes();
																	iAnioVencimientoCPS = (short)pCuentaCliente->pCuenta[i].tFechaFinVigencia.ano();
																}
																// leyenda P. SALUD
																fontID = m_grid.AddFont("Lucida Console Bold", 14, 600);
																m_grid.QuickSetFont(k, 3, fontID);
																m_grid.QuickSetText(k, 3, " P. SALUD ");
																m_grid.QuickSetAlignment(k, 3, UG_ALIGNCENTER);

																// nombre del plan
																consultarNombrePlan(cTexto, pCuentaCliente->pCuenta[i].iCantidadSeguros, 4); // 4 plan salud
																m_grid.QuickSetText(k, 12, cTexto);
																m_grid.QuickSetAlignment(k, 12, UG_ALIGNCENTER);

																// cuota
																m_grid.QuickSetText(k, 15, "CUOTA");
																m_grid.QuickSetAlignment(k, 15, UG_ALIGNCENTER);

																// importe cuota titular
																consultarPrecioPlanSalud(lCuotaTemporalPS, lCuotaTemporalPS, lCuotaTemporalPS, pCuentaCliente->pCuenta[i].iCantidadSeguros, 4);
																lCuotaPS += lCuotaTemporalPS;
																usingx("###,###", cTexto, (double)lCuotaPS);
																m_grid.QuickSetText(k, 16, cTexto);
																m_grid.QuickSetAlignment(k, 16, UG_ALIGNCENTER);

																iSumaAseguradaPlan = consultarSumaAseguradaPlanSalud(pCuentaCliente->pCuenta[i].iCantidadSeguros, 4); // 4 Tipo seguro plan salud
																consultarMaxAdicionales(4); // 4 Tipo seguro plan salud
																compararEdadCliente();

																sDato.Format("%02d%02d%02d", pCuentaCliente->pCuenta[i].tFechaFinVigencia.dia(), pCuentaCliente->pCuenta[i].tFechaFinVigencia.mes(), (pCuentaCliente->pCuenta[i].tFechaFinVigencia.ano() - 2000));
																m_grid.QuickSetText(iColumnaPlan, 25, sDato); // renglon no visible para obtener la fecha vigencia despues

																if (iDiasVencidosPS > 0)//&& iDiasVencidosPS <= 90) // tiene vencido
																{
																	bTieneVencidoPlan = true;
																	bCandidatoPSAbono = true;
																	m_grid.QuickSetText(k, 2, " P. SALUD "); // renglon FECHA COMPRA
																	m_grid.QuickSetAlignment(k, 2, UG_ALIGNCENTER);

																	m_grid.QuickSetText(k, 3, "VENCIO EL");
																	m_grid.QuickSetAlignment(k, 3, UG_ALIGNCENTER);
																}
																if (iCandidatoAprobado == 1)
																{
																	sprintf_s(cJsonPostDescuentos, "\"tipoCuenta\":%d,\"saldoSinInteres\":%ld,\"interes\":%ld,\"vencidoSinInteres\":%ld"
																		",\"mesesVencidos\":%d,\"abonoBase\":%ld,\"facturaCuenta\":%ld,\"descripcionCuenta\":\"%s\",\"identificadorConvenio\":%d,""\"cuentaCandidata\":%d}"
																		, CUENTA_PLANSALUD, pCuentaCliente->pCuenta[i].lSaldo, pCuentaCliente->pCuenta[i].lInteresAdicional, pCuentaCliente->pCuenta[i].lVencido, 0, pCuentaCliente->pCuenta[i].lBase, pCuentaCliente->pCuenta[i].lFactura, pCuentaCliente->pCuenta[i].cDescripcion, 0, 0);

																	if (icuenta == 1)
																	{
																		sJsonPostDescuentoMoratorio.append(",{");
																	}

																	sJsonPostDescuentoMoratorio.append(cJsonPostDescuentos);
																	icuenta = 1;
																}
															}
															else
															{
																sDato.Format("%s", pCuentaCliente->pCuenta[i].cDescripcion);
																m_grid.QuickSetText(k, -1, sDato);

																if (pCuentaCliente->pCuenta[i].lSaldo > 0)
																{
																	miniFecha(cFecha2, pCuentaCliente->pCuenta[i].tFechaUltimoMovimiento.dia(), pCuentaCliente->pCuenta[i].tFechaUltimoMovimiento.mes(), pCuentaCliente->pCuenta[i].tFechaUltimoMovimiento.ano());
																	memcpy(cFecha1, cFecha2, 7);
																}
																else
																{
																	memset(cFecha1, ' ', 7);
																}
																cFecha1[7] = 0;

																sDato.Format("%s", cFecha1);
																m_grid.QuickSetText(k, 5, sDato);
																m_grid.QuickSetAlignment(k, 5, UG_ALIGNCENTER);




																if (pCuentaCliente->pCuenta[i].iTipoDeCuenta == CUENTA_ROPA) //Cuenta de Ropa
																{
																	sprintf_s(cMensajeSeguimiento, "CDlgCapturarAbono::desplegarDatosCliente--> leyendo cuenta de ropa");
																	grabarLog(cMensajeSeguimiento);
																	if (pCuentaCliente->pCuenta[i].lSaldo > 0 && !pCuentaCliente->pCuenta[i].bCuentaZ)
																	{
																		miniFecha(cFecha1, pCuentaCliente->pCuenta[i].tFechaSaldaCon.dia(), pCuentaCliente->pCuenta[i].tFechaSaldaCon.mes(), pCuentaCliente->pCuenta[i].tFechaSaldaCon.ano());
																		sDato.Format("%s", cFecha1);
																		m_grid.QuickSetText(k, 6, sDato);
																		m_grid.QuickSetAlignment(k, 6, UG_ALIGNCENTER);

																		sDato.Format("%ld", pCuentaCliente->pCuenta[i].lCuentaCandidato);
																		m_grid.QuickSetText(k, 37, sDato);
																		m_grid.QuickSetAlignment(k, 37, UG_ALIGNCENTER);

																		if (iCandidatoAprobado == 1)
																		{
																			iSumaInteresMoratorio += pCuentaCliente->pCuenta[i].lInteresAdicional;
																			iMesesVencidos = (pCuentaCliente->pCuenta[i].lVencido - pCuentaCliente->pCuenta[i].lInteresAdicional) / pCuentaCliente->pCuenta[i].lBase;

																			sprintf_s(cJsonPostDescuentos, "\"tipoCuenta\":%d,\"saldoSinInteres\":%ld,\"interes\":%ld,\"vencidoSinInteres\":%ld"
																				",\"mesesVencidos\":%d,\"abonoBase\":%ld,\"facturaCuenta\":%ld,\"descripcionCuenta\":\"%s\","
																				, CUENTA_ROPA, pCuentaCliente->pCuenta[i].lSaldo, pCuentaCliente->pCuenta[i].lInteresAdicional, pCuentaCliente->pCuenta[i].lVencido, iMesesVencidos, pCuentaCliente->pCuenta[i].lBase, pCuentaCliente->pCuenta[i].lFactura, pCuentaCliente->pCuenta[i].cDescripcion);

																			if (icuenta == 1)
																			{
																				sJsonPostDescuentoMoratorio.append(",{");
																			}
																			sprintf_s(cMensajeSeguimiento, "CDlgCapturarAbono::Datos Saldos del cliente para descuento Ropa-->Cliente:%ld, Saldo:%ld, interes:%ld, vencido:%ld",m_grid.lCliente, pCuentaCliente->pCuenta[i].lSaldo, pCuentaCliente->pCuenta[i].lInteresAdicional, pCuentaCliente->pCuenta[i].lVencido);
																			grabarLog(cMensajeSeguimiento);
																			sJsonPostDescuentoMoratorio.append(cJsonPostDescuentos);
																			icuenta = 1;


																		}

																		//obtenerdetallado
																		for (int iTotalCuentasTasa0 = 0; iTotalCuentasTasa0 < pCuentaCliente->iCuentasDetalle; iTotalCuentasTasa0++)
																		{
																			if (pCuentaCliente->pCuenta[i].stMaestroDetalle[iTotalCuentasTasa0].iTipoDeduccion == 0)
																			{
																				iTipoDeduccionRopa = pCuentaCliente->pCuenta[i].stMaestroDetalle[iTotalCuentasTasa0].iTipoDeduccion;
																				lSaldoRopa = pCuentaCliente->pCuenta[i].stMaestroDetalle[iTotalCuentasTasa0].lSaldo;
																				lInteresesRopa = pCuentaCliente->pCuenta[i].stMaestroDetalle[iTotalCuentasTasa0].lInteresAdicional;
																				iTotalCuentasDetalle++;
																			}
																			else if (pCuentaCliente->pCuenta[i].stMaestroDetalle[iTotalCuentasTasa0].iTipoDeduccion == 2)
																			{
																				iTipoDeduccionTasa0 = pCuentaCliente->pCuenta[i].stMaestroDetalle[iTotalCuentasTasa0].iTipoDeduccion;
																				lSaldoTasa0 = pCuentaCliente->pCuenta[i].stMaestroDetalle[iTotalCuentasTasa0].lSaldo;
																				lInteresesTasa0 = pCuentaCliente->pCuenta[i].stMaestroDetalle[iTotalCuentasTasa0].lInteresAdicional;
																				iTotalCuentasDetalle++;
																			}
																		}
																	}

																	if (pCuentaCliente->pCuenta[i].bCuentaZ)
																	{
																		lSaldoTmp += pCuentaCliente->pCuenta[i].lSaldo;
																		m_grid.QuickSetText(k, 2, "CP ROPA");
																		m_grid.QuickSetAlignment(k, 2, UG_ALIGNCENTER);
																		sDato.Format("%06ld", pCuentaCliente->pCuenta[i].lFactura);
																		m_grid.QuickSetText(k, 1, sDato);
																		m_grid.QuickSetAlignment(k, 1, UG_ALIGNRIGHT);
																		//obtenerdetallado Cuentas perdidas

																		for (int iTotalCuentasTasa0 = 0; iTotalCuentasTasa0 < pCuentaCliente->iCuentasDetalle; iTotalCuentasTasa0++)
																		{
																			if (pCuentaCliente->pCuenta[i].stCuentaPerdidaDetalle[iTotalCuentasTasa0].iTipoDeduccion == 0)
																			{
																				iTipoDeduccionRopa = pCuentaCliente->pCuenta[i].stCuentaPerdidaDetalle[iTotalCuentasTasa0].iTipoDeduccion;
																				lSaldoRopa = pCuentaCliente->pCuenta[i].stCuentaPerdidaDetalle[iTotalCuentasTasa0].lSaldo;
																				iTotalCuentasDetalle++;
																			}
																			else if (pCuentaCliente->pCuenta[i].stCuentaPerdidaDetalle[iTotalCuentasTasa0].iTipoDeduccion == 2)
																			{
																				iTipoDeduccionTasa0 = pCuentaCliente->pCuenta[i].stCuentaPerdidaDetalle[iTotalCuentasTasa0].iTipoDeduccion;
																				lSaldoTasa0 = pCuentaCliente->pCuenta[i].stCuentaPerdidaDetalle[iTotalCuentasTasa0].lSaldo;
																				//lInteresesTasa0 = pCuentaCliente->pCuenta[i].stCuentaPerdidaDetalle[iTotalCuentasTasa0].lInteresAdicional;
																				iTotalCuentasDetalle++;
																			}
																		}
																	}
																}
																else if (pCuentaCliente->pCuenta[i].iTipoDeCuenta == CUENTA_MUEBLES) //Tipo de Cuenta 1=Muebles,
																{
																	sprintf_s(cMensajeSeguimiento, "CDlgCapturarAbono::desplegarDatosCliente--> leyendo cuenta de muebles[%06ld]", pCuentaCliente->pCuenta[i].lFactura);
																	grabarLog(cMensajeSeguimiento);
																	sDato.Format("%d", pCuentaCliente->pCuenta[i].iTipoDeCuenta);
																	stDatosCertificacion[iCantidadCuentaMuebles].iTipoCuenta = atoi(sDato);

																	sDato.Format("%ld", m_grid.lCliente);
																	stDatosCertificacion[iCantidadCuentaMuebles].iCliente = (atoi(sDato) / 10);

																	sDato.Format("%d", m_grid.iCaja);
																	stDatosCertificacion[iCantidadCuentaMuebles].iCaja = atoi(sDato);

																	sDato.Format("%d", m_grid.iTienda);
																	stDatosCertificacion[iCantidadCuentaMuebles].iTienda = atoi(sDato);
																	sDato.Format("%04hd", pCuentaCliente->pCuenta[i].iTienda);

																	m_grid.QuickSetText(k, 0, sDato);
																	m_grid.QuickSetAlignment(k, 0, UG_ALIGNRIGHT);
																	sDato.Format("%06ld", pCuentaCliente->pCuenta[i].lFactura);
																	m_grid.QuickSetText(k, 1, sDato);
																	m_grid.QuickSetAlignment(k, 1, UG_ALIGNRIGHT);

																	stDatosCertificacion[iCantidadCuentaMuebles].iFactura = atoi(sDato);
																	sDato.Format("%ld", pCuentaCliente->pCuenta[i].lSaldaCon);
																	m_grid.QuickSetText(k, 26, sDato);
																	m_grid.QuickSetAlignment(k, 26, UG_ALIGNCENTER);

																	stDatosCertificacion[iCantidadCuentaMuebles].iSaldaCon = atoi(sDato);
																	sDato.Format("%hd", pCuentaCliente->pCuenta[i].iTipoProducto);
																	m_grid.QuickSetText(k, 36, sDato);
																	m_grid.RedrawCell(k, 36);

																	if(pCuentaCliente->pCuenta[i].iTipoProducto  > 0)
																	{
																		if(pCuentaCliente->pCuenta[i].cDescripcion[0] == 'M' && pCuentaCliente->pCuenta[i].cDescripcion[1] == 'P')
																		{
																			stDatosCertificacion[iCantidadCuentaMuebles].iTipoCuenta = 12;
																		}else{
																			stDatosCertificacion[iCantidadCuentaMuebles].iTipoCuenta = 10;
																		}
																	}else{
																		stDatosCertificacion[iCantidadCuentaMuebles].iTipoCuenta = pCuentaCliente->pCuenta[i].iTipoDeCuenta;
																	}

																	sDato.Format("%d", pCuentaCliente->pCuenta[i].lCuentaCandidato);
																	m_grid.QuickSetText(k, 37, sDato);
																	m_grid.QuickSetAlignment(k, 37, UG_ALIGNCENTER);

																	if (pCuentaCliente->pCuenta[i].bCuentaZ)
																	{
																		lSaldoTmp += pCuentaCliente->pCuenta[i].lSaldo;
																		m_grid.QuickSetText(k, 2, "CP MUEB");
																		m_grid.QuickSetAlignment(k, 2, UG_ALIGNCENTER);
																	}
																	else
																	{
																		miniFecha(cFecha1, pCuentaCliente->pCuenta[i].tFechaVenta.dia(), pCuentaCliente->pCuenta[i].tFechaVenta.mes(), pCuentaCliente->pCuenta[i].tFechaVenta.ano());
																		sDato.Format("%s", cFecha1);
																		m_grid.QuickSetText(k, 2, sDato);
																		m_grid.QuickSetAlignment(k, 2, UG_ALIGNCENTER);
																		usingx("#,###,###", cRespuesta, (double)pCuentaCliente->pCuenta[i].lImporteVenta);
																		cRespuesta[9] = 0;
																		sDato.Format("%s", cRespuesta);
																		m_grid.QuickSetText(k, 3, sDato);
																		m_grid.QuickSetAlignment(k, 3, UG_ALIGNRIGHT);
																	}

																	lImporteTotal += pCuentaCliente->pCuenta[i].lImporteVenta;

																	sprintf_s(cTexto, "%04d%02d%02d", iAnioActual, iMesActual, iDiaActual);
																	sprintf_s(stDatosCertificacion[iCantidadCuentaMuebles].cFechaCompra, "%04d%02d%02d", pCuentaCliente->pCuenta[i].tFechaVenta.ano(), pCuentaCliente->pCuenta[i].tFechaVenta.mes(), pCuentaCliente->pCuenta[i].tFechaVenta.dia());

																	sDato.Format("%hd", pCuentaCliente->pCuenta[i].iDiasTranscurridos);
																	stDatosCertificacion[iCantidadCuentaMuebles].iDiasTranscurridos = atoi(sDato);

																	sDato.Format("%hd", pCuentaCliente->pCuenta[i].iPlazo);
																	stDatosCertificacion[iCantidadCuentaMuebles].iPlazo = atoi(sDato);

																	sDato.Format("%ld", (pCuentaCliente->pCuenta[i].lImporteVenta - pCuentaCliente->pCuenta[i].lInteresSobreCompra));
																	stDatosCertificacion[iCantidadCuentaMuebles].iContado = atoi(sDato);

																	sDato.Format("%ld", pCuentaCliente->pCuenta[i].lSaldo);
																	stDatosCertificacion[iCantidadCuentaMuebles].iSaldoAnterior = atoi(sDato);

																	sDato.Format("%ld", pCuentaCliente->pCuenta[i].lInteresAdicional);
																	stDatosCertificacion[iCantidadCuentaMuebles].iInteresAdicional = atoi(sDato);

																	sDato.Format("%ld", pCuentaCliente->pCuenta[i].lBase);
																	stDatosCertificacion[iCantidadCuentaMuebles].iAbonoBase = atoi(sDato);

																	sDato.Format("%ld", pCuentaCliente->pCuenta[i].lVencido);
																	stDatosCertificacion[iCantidadCuentaMuebles].iSaldoVencido = atoi(sDato);

																	sDato.Format("%ld", pCuentaCliente->pCuenta[i].lBonificacion);
																	stDatosCertificacion[iCantidadCuentaMuebles].iBonificacion = atoi(sDato);

																	sDato.Format("%ld", (pCuentaCliente->pCuenta[i].lImporteVenta));
																	stDatosCertificacion[iCantidadCuentaMuebles].iCredito = atoi(sDato);

																	sDato.Format("%hd", pCuentaCliente->pCuenta[i].iPorcentajeBonificacion);
																	stDatosCertificacion[iCantidadCuentaMuebles].iPorcBonificacion = atoi(sDato);

																	m_grid.QuickSetText(k, 38, sDato);
																	m_grid.QuickSetAlignment(k, 38, UG_ALIGNRIGHT);

																	sDato.Format("%ld", pCuentaCliente->pCuenta[i].lInteresSobreCompra);
																	stDatosCertificacion[iCantidadCuentaMuebles].iIsc = atoi(sDato);

																	sDato.Format("%ld", pCuentaCliente->pCuenta[i].lSaldaConCorte);
																	stDatosCertificacion[iCantidadCuentaMuebles].iSaldaConCorte = atoi(sDato);

																	sDato.Format("%ld", pCuentaCliente->pCuenta[i].lInteresAdicionalPrimerMes);
																	stDatosCertificacion[iCantidadCuentaMuebles].iInteresadicionalPrimerMesc = atoi(sDato);

																	sprintf_s(stDatosCertificacion[iCantidadCuentaMuebles].cFechaSaldaConCorte, "%04d%02d%02d", pCuentaCliente->pCuenta[i].tFechaSaldaConCorte.ano(), pCuentaCliente->pCuenta[i].tFechaSaldaConCorte.mes(), pCuentaCliente->pCuenta[i].tFechaSaldaConCorte.dia());

																	sprintf_s(stDatosCertificacion[iCantidadCuentaMuebles].cFechaMovto, "%04d%02d%02d", iAnioActual, iMesActual, iDiaActual);

																	if (iCandidatoAprobado == 1)
																	{
																		iSumaInteresMoratorio += pCuentaCliente->pCuenta[i].lInteresAdicional;
																		iMesesVencidos = (pCuentaCliente->pCuenta[i].lVencido - pCuentaCliente->pCuenta[i].lInteresAdicional) / pCuentaCliente->pCuenta[i].lBase;
																		sprintf_s(cJsonPostDescuentos, "\"tipoCuenta\":%d,\"saldoSinInteres\":%ld,\"interes\":%ld,\"vencidoSinInteres\":%ld"
																			",\"mesesVencidos\":%d,\"abonoBase\":%ld,\"facturaCuenta\":%ld,\"descripcionCuenta\":\"%s\","
																			, CUENTA_MUEBLES, pCuentaCliente->pCuenta[i].lSaldo, pCuentaCliente->pCuenta[i].lInteresAdicional, pCuentaCliente->pCuenta[i].lVencido, iMesesVencidos, pCuentaCliente->pCuenta[i].lBase, pCuentaCliente->pCuenta[i].lFactura, pCuentaCliente->pCuenta[i].cDescripcion);

																		if (icuenta == 1)
																		{
																			sJsonPostDescuentoMoratorio.append(",{");
																		}
																		sprintf_s(cMensajeSeguimiento, "CDlgCapturarAbono::Datos Saldos del cliente para descuento Muebles-->Cliente:%ld, Saldo:%ld, interes:%ld, vencido:%ld",m_grid.lCliente, pCuentaCliente->pCuenta[i].lSaldo, pCuentaCliente->pCuenta[i].lInteresAdicional, pCuentaCliente->pCuenta[i].lVencido);
																		grabarLog(cMensajeSeguimiento);
																		sJsonPostDescuentoMoratorio.append(cJsonPostDescuentos);
																		icuenta = 1;

																	}
																	iCantidadCuentaMuebles++;
																}
																else if (pCuentaCliente->pCuenta[i].iTipoDeCuenta == CUENTA_PRESTAMOS) //Tipo de Cuenta 3=Prestamo,
																{
																	sprintf_s(cMensajeSeguimiento, "CDlgCapturarAbono::desplegarDatosCliente--> leyendo cuenta de Prestamo");
																	grabarLog(cMensajeSeguimiento);

																	sDato.Format("%d", pCuentaCliente->pCuenta[i].iTipoDeCuenta);
																	stDatosCertificacion[iCantidadCuentaMuebles].iTipoCuenta = atoi(sDato);
																	sprintf_s(cCuentaP, "%d", pCuentaCliente->pCuenta[i].iTipoDeCuenta);


																	sprintf_s(cTexto, "%04d%02d%02d", pCuentaCliente->pCuenta[i].tFechaPrestamo.ano(), pCuentaCliente->pCuenta[i].tFechaPrestamo.mes(), pCuentaCliente->pCuenta[i].tFechaPrestamo.dia());
																	sDato.Format("%hd", pCuentaCliente->pCuenta[i].iPlazo);
																	iPlazos = atoi(sDato);
																	sprintf_s(cIplazo, "%d", iPlazos);
																	sprintf_s(cInteresprestamo, "%ld", pCuentaCliente->pCuenta[i].lInteresSobreCompra);
																	sDato.Format("%ld", pCuentaCliente->pCuenta[i].iDiasTranscurridos);
																	lDias = (short)atoi(sDato);
																	sprintf_s(cDias, "%ld", lDias);

																	pCuentaCliente->leerBonificacionPrestamos(cDias, cInteresprestamo, cIplazo, cTexto);

																	sDato.Format("%ld", m_grid.lCliente);
																	stDatosCertificacion[iCantidadCuentaMuebles].iCliente = (atoi(sDato) / 10);

																	sDato.Format("%04hd", pCuentaCliente->pCuenta[i].iTienda);
																	m_grid.QuickSetText(k, 0, sDato);
																	m_grid.QuickSetAlignment(k, 0, UG_ALIGNRIGHT);
																	sDato.Format("%06ld", pCuentaCliente->pCuenta[i].lFactura);
																	m_grid.QuickSetText(k, 1, sDato);
																	m_grid.QuickSetAlignment(k, 1, UG_ALIGNRIGHT);

																	stDatosCertificacion[iCantidadCuentaMuebles].iFactura = atoi(sDato);
																	sDato.Format("%ld", pCuentaCliente->pCuenta[i].lSaldaCon);
																	m_grid.QuickSetText(k, 26, sDato);
																	m_grid.QuickSetAlignment(k, 26, UG_ALIGNCENTER);

																	stDatosCertificacion[iCantidadCuentaMuebles].iSaldaCon = atoi(sDato);
																	sDato.Format("%hd", pCuentaCliente->pCuenta[i].iTipoProducto);
																	m_grid.QuickSetText(k, 36, sDato);
																	m_grid.RedrawCell(k, 36);

																	sDato.Format("%d", m_grid.iTienda);
																	stDatosCertificacion[iCantidadCuentaMuebles].iTienda = atoi(sDato);
																	sDato.Format("%04hd", pCuentaCliente->pCuenta[i].iTienda);

																	sDato.Format("%d", m_grid.iCaja);
																	stDatosCertificacion[iCantidadCuentaMuebles].iCaja = atoi(sDato);

																	sprintf_s(cTexto, "%04d%02d%02d", iAnioActual, iMesActual, iDiaActual);
																	sprintf_s(stDatosCertificacion[iCantidadCuentaMuebles].cFechaCompra, "%04d%02d%02d", pCuentaCliente->pCuenta[i].tFechaPrestamo.ano(), pCuentaCliente->pCuenta[i].tFechaPrestamo.mes(), pCuentaCliente->pCuenta[i].tFechaPrestamo.dia());

																	sDato.Format("%hd", pCuentaCliente->pCuenta[i].iPlazo);
																	stDatosCertificacion[iCantidadCuentaMuebles].iPlazo = atoi(sDato);

																	sDato.Format("%ld", (pCuentaCliente->pCuenta[i].lImporteVenta - pCuentaCliente->pCuenta[i].lInteresSobreCompra));
																	stDatosCertificacion[iCantidadCuentaMuebles].iContado = atoi(sDato);

																	sDato.Format("%ld", pCuentaCliente->pCuenta[i].lInteresSobreCompra);
																	stDatosCertificacion[iCantidadCuentaMuebles].iIsc = atoi(sDato);

																	sDato.Format("%ld", pCuentaCliente->pCuenta[i].lImporteVenta);
																	stDatosCertificacion[iCantidadCuentaMuebles].iCredito = atoi(sDato);

																	sDato.Format("%ld", pCuentaCliente->pCuenta[i].lBase);
																	stDatosCertificacion[iCantidadCuentaMuebles].iAbonoBase = atoi(sDato);

																	sprintf_s(stDatosCertificacion[iCantidadCuentaMuebles].cFechaMovto, "%04d%02d%02d", iAnioActual, iMesActual, iDiaActual);

																	sDato.Format("%ld", pCuentaCliente->pCuenta[i].lSaldaCon);
																	m_grid.QuickSetText(k, 26, sDato);
																	m_grid.QuickSetAlignment(k, 26, UG_ALIGNCENTER);
																	stDatosCertificacion[iCantidadCuentaMuebles].iSaldaCon = atoi(sDato);

																	sDato.Format("%hd", pCuentaCliente->pCuenta[i].iDiasTranscurridos);
																	stDatosCertificacion[iCantidadCuentaMuebles].iDiasTranscurridos = atoi(sDato);

																	sDato.Format("%ld", pCuentaCliente->pCuenta[i].lBonificacion);
																	stDatosCertificacion[iCantidadCuentaMuebles].iBonificacion = atoi(sDato);

																	sDato.Format("%ld", pCuentaCliente->CBonificacionPrestamo.llPorcentaje);
																	stDatosCertificacion[iCantidadCuentaMuebles].iPorcBonificacion = atoi(sDato);

																	sDato.Format("%ld", pCuentaCliente->pCuenta[i].lVencido);
																	stDatosCertificacion[iCantidadCuentaMuebles].iSaldoVencido = atoi(sDato);

																	sDato.Format("%ld", pCuentaCliente->pCuenta[i].lInteresAdicional);
																	stDatosCertificacion[iCantidadCuentaMuebles].iInteresAdicional = atoi(sDato);

																	sDato.Format("%ld", pCuentaCliente->pCuenta[i].lSaldo);
																	stDatosCertificacion[iCantidadCuentaMuebles].iSaldoAnterior = atoi(sDato);

																	if (pCuentaCliente->pCuenta[i].bCuentaZ)
																	{
																		lSaldoTmp += pCuentaCliente->pCuenta[i].lSaldo;
																		m_grid.QuickSetText(k, 2, "CP PRES");
																		m_grid.QuickSetAlignment(k, 2, UG_ALIGNCENTER);
																	}
																	else
																	{
																		miniFecha(cFecha1, pCuentaCliente->pCuenta[i].tFechaPrestamo.dia(), pCuentaCliente->pCuenta[i].tFechaPrestamo.mes(), pCuentaCliente->pCuenta[i].tFechaPrestamo.ano());
																		sDato.Format("%s", cFecha1);
																		m_grid.QuickSetText(k, 2, sDato);
																		m_grid.QuickSetAlignment(k, 2, UG_ALIGNCENTER);
																		usingx("#,###,###", cRespuesta, (double)pCuentaCliente->pCuenta[i].lImporteVenta);
																		cRespuesta[9] = 0;
																		sDato.Format("%s", cRespuesta);
																		m_grid.QuickSetText(k, 3, sDato);
																		m_grid.QuickSetAlignment(k, 3, UG_ALIGNRIGHT);
																	}

																	iCantidadCuentaMuebles++;
																	sDato.Format("%ld", pCuentaCliente->pCuenta[i].lCuentaCandidato);
																	m_grid.QuickSetText(k, 37, sDato);
																	m_grid.QuickSetAlignment(k, 37, UG_ALIGNCENTER);

																	if (iCandidatoAprobado == 1)
																	{
																		iSumaInteresMoratorio += pCuentaCliente->pCuenta[i].lInteresAdicional;
																		iMesesVencidos = (pCuentaCliente->pCuenta[i].lVencido - pCuentaCliente->pCuenta[i].lInteresAdicional) / pCuentaCliente->pCuenta[i].lBase;
																		sprintf_s(cJsonPostDescuentos, "\"tipoCuenta\":%d,\"saldoSinInteres\":%ld,\"interes\":%ld,\"vencidoSinInteres\":%ld"
																			",\"mesesVencidos\":%d,\"abonoBase\":%ld,\"facturaCuenta\":%ld,\"descripcionCuenta\":\"%s\","
																			, CUENTA_PRESTAMOS, pCuentaCliente->pCuenta[i].lSaldo, pCuentaCliente->pCuenta[i].lInteresAdicional, pCuentaCliente->pCuenta[i].lVencido, iMesesVencidos, pCuentaCliente->pCuenta[i].lBase, pCuentaCliente->pCuenta[i].lFactura, pCuentaCliente->pCuenta[i].cDescripcion);

																		if (icuenta == 1)
																		{
																			sJsonPostDescuentoMoratorio.append(",{");
																		}
																		sprintf_s(cMensajeSeguimiento, "CDlgCapturarAbono::Datos Saldos del cliente para descuento Prestamos-->Cliente: %ld, Saldo:%ld, interes:%ld, vencido:%ld",m_grid.lCliente,pCuentaCliente->pCuenta[i].lSaldo, pCuentaCliente->pCuenta[i].lInteresAdicional, pCuentaCliente->pCuenta[i].lVencido);
																		grabarLog(cMensajeSeguimiento);
																		sJsonPostDescuentoMoratorio.append(cJsonPostDescuentos);
																		icuenta = 1;
																	}
																}
																else if (pCuentaCliente->pCuenta[i].iTipoDeCuenta == CUENTA_TAIRE)   //Cuenta de Tiempo Aire
																{
																	sprintf_s(cMensajeSeguimiento, "CDlgCapturarAbono::desplegarDatosCliente--> leyendo cuenta de Tiempo Aire");
																	grabarLog(cMensajeSeguimiento);
																	if (pCuentaCliente->pCuenta[i].lSaldo > 0 && !pCuentaCliente->pCuenta[i].bCuentaZ)
																	{
																		miniFecha(cFecha1, pCuentaCliente->pCuenta[i].tFechaSaldaCon.dia(), pCuentaCliente->pCuenta[i].tFechaSaldaCon.mes(), pCuentaCliente->pCuenta[i].tFechaSaldaCon.ano());
																		sDato.Format("%s", cFecha1);
																		m_grid.QuickSetText(k, 6, sDato);
																		m_grid.QuickSetAlignment(k, 6, UG_ALIGNCENTER);
																	}

																	if (pCuentaCliente->pCuenta[i].bCuentaZ)
																	{
																		lSaldoTmp += pCuentaCliente->pCuenta[i].lSaldo;
																		m_grid.QuickSetText(k, 2, "CP T.AIRE");
																		m_grid.QuickSetAlignment(k, 2, UG_ALIGNCENTER);
																		sDato.Format("%06ld", pCuentaCliente->pCuenta[i].lFactura);
																		m_grid.QuickSetText(k, 1, sDato);
																		m_grid.QuickSetAlignment(k, 1, UG_ALIGNRIGHT);
																	}

																	sDato.Format("%hd", pCuentaCliente->pCuenta[i].iTipoProducto);
																	m_grid.QuickSetText(k, 36, sDato);
																	m_grid.RedrawCell(k, 36);

																	sDato.Format("%ld", pCuentaCliente->pCuenta[i].lCuentaCandidato);
																	m_grid.QuickSetText(k, 37, sDato);
																	m_grid.QuickSetAlignment(k, 37, UG_ALIGNCENTER);

																	if (iCandidatoAprobado == 1)
																	{
																		iSumaInteresMoratorio += pCuentaCliente->pCuenta[i].lInteresAdicional;
																		iMesesVencidos = (pCuentaCliente->pCuenta[i].lVencido - pCuentaCliente->pCuenta[i].lInteresAdicional) / pCuentaCliente->pCuenta[i].lBase;
																		sprintf_s(cJsonPostDescuentos, "\"tipoCuenta\":%d,\"saldoSinInteres\":%ld,\"interes\":%ld,\"vencidoSinInteres\":%ld"
																			",\"mesesVencidos\":%d,\"abonoBase\":%ld,\"facturaCuenta\":%ld,\"descripcionCuenta\":\"%s\","
																			, CUENTA_TAIRE, pCuentaCliente->pCuenta[i].lSaldo, pCuentaCliente->pCuenta[i].lInteresAdicional, pCuentaCliente->pCuenta[i].lVencido, iMesesVencidos, pCuentaCliente->pCuenta[i].lBase, pCuentaCliente->pCuenta[i].lFactura, pCuentaCliente->pCuenta[i].cDescripcion);

																		if (icuenta == 1)
																		{
																			sJsonPostDescuentoMoratorio.append(",{");
																		}
																		sprintf_s(cMensajeSeguimiento, "CDlgCapturarAbono::Datos Saldos del cliente para descuento Tiempo Aire-->cliente:%ld,Saldo:%ld, interes:%ld, vencido:%ld",m_grid.lCliente,pCuentaCliente->pCuenta[i].lSaldo, pCuentaCliente->pCuenta[i].lInteresAdicional, pCuentaCliente->pCuenta[i].lVencido);
																		grabarLog(cMensajeSeguimiento);
																		sJsonPostDescuentoMoratorio.append(cJsonPostDescuentos);
																		icuenta = 1;
																	}
																}
																else if (pCuentaCliente->pCuenta[i].iTipoDeCuenta == CUENTA_BANCOPPEL)//Tipo de Cuenta 5=Deuda Bancoppel,
																{
																	// TEMPAPSESTRATCOB005
																	if (VerificarCuentaBcpl(pCuentaCliente->pCuenta[i].cDescripcion, "SOLEX") == 1)
																	{
																		grabarLog("Hay cuenta SOLEX");
																		bExisteCuentaSolex = true;
																	}
																	else
																	{
																		grabarLog("No hay cuenta SOLEX");
																	}

																	sprintf_s(cMensajeSeguimiento, "CDlgCapturarAbono::desplegarDatosCliente--> leyendo cuenta de Deuda Bancoppel[%06ld]", pCuentaCliente->pCuenta[i].lFactura);
																	grabarLog(cMensajeSeguimiento);
																	sDato.Format("%04hd", pCuentaCliente->pCuenta[i].iTienda);
																	m_grid.QuickSetText(k, 0, sDato);
																	m_grid.QuickSetAlignment(k, 0, UG_ALIGNRIGHT);
																	sDato.Format("%06ld", pCuentaCliente->pCuenta[i].lFactura);
																	m_grid.QuickSetText(k, 1, sDato);
																	m_grid.QuickSetAlignment(k, 1, UG_ALIGNRIGHT);

																	if (pCuentaCliente->pCuenta[i].bCuentaZ)
																	{
																		lSaldoTmp += pCuentaCliente->pCuenta[i].lSaldo;
																		m_grid.QuickSetText(k, 2, "CP BANC");
																		m_grid.QuickSetAlignment(k, 2, UG_ALIGNCENTER);
																	}
																	else
																	{
																		miniFecha(cFecha1, pCuentaCliente->pCuenta[i].tFechaPrestamo.dia(), pCuentaCliente->pCuenta[i].tFechaPrestamo.mes(), pCuentaCliente->pCuenta[i].tFechaPrestamo.ano());
																		sDato.Format("%s", cFecha1);
																		m_grid.QuickSetText(k, 2, sDato);
																		m_grid.QuickSetAlignment(k, 2, UG_ALIGNCENTER);
																		usingx("#,###,###", cRespuesta, (double)pCuentaCliente->pCuenta[i].lImporteVenta);
																		cRespuesta[9] = 0;
																		sDato.Format("%s", cRespuesta);
																		m_grid.QuickSetText(k, 3, sDato);
																		m_grid.QuickSetAlignment(k, 3, UG_ALIGNRIGHT);
																	}

																	sDato.Format("%ld", pCuentaCliente->pCuenta[i].lSaldaCon);
																	m_grid.QuickSetText(k, 26, sDato);
																	m_grid.QuickSetAlignment(k, 26, UG_ALIGNCENTER);

																	sDato.Format("%hd", pCuentaCliente->pCuenta[i].iTipoProducto);
																	m_grid.QuickSetText(k, 36, sDato);
																	m_grid.RedrawCell(k, 36);

																	lImporteTotal += pCuentaCliente->pCuenta[i].lImporteVenta;

																	if (iCandidatoAprobado == 1)
																	{
																		iMesesVencidos = (pCuentaCliente->pCuenta[i].lVencido - pCuentaCliente->pCuenta[i].lInteresAdicional) / pCuentaCliente->pCuenta[i].lBase;
																		sprintf_s(cJsonPostDescuentos, "\"tipoCuenta\":%d,\"saldoSinInteres\":%ld,\"interes\":%ld,\"vencidoSinInteres\":%ld"
																			",\"mesesVencidos\":%d,\"abonoBase\":%ld,\"facturaCuenta\":%ld,\"descripcionCuenta\":\"%s\","
																			, CUENTA_BANCOPPEL, pCuentaCliente->pCuenta[i].lSaldo, pCuentaCliente->pCuenta[i].lInteresAdicional, pCuentaCliente->pCuenta[i].lVencido, iMesesVencidos, pCuentaCliente->pCuenta[i].lBase, pCuentaCliente->pCuenta[i].lFactura, pCuentaCliente->pCuenta[i].cDescripcion);

																		if (icuenta == 1)
																		{
																			sJsonPostDescuentoMoratorio.append(",{");
																		}

																		sJsonPostDescuentoMoratorio.append(cJsonPostDescuentos);
																		icuenta = 1;
																	}
																}
																else if (pCuentaCliente->pCuenta[i].iTipoDeCuenta == CUENTA_REVOLVENTE) //Tipo de Cuenta Revolvente
																{
																	sprintf_s(cMensajeSeguimiento, "CDlgCapturarAbono::desplegarDatosCliente--> leyendo cuenta Revolvente");
																	grabarLog(cMensajeSeguimiento);
																	m_grid.QuickSetText(k, -1, "COMP ADC");

																	if (pCuentaCliente->pCuenta[i].lSaldo > 0 && !pCuentaCliente->pCuenta[i].bCuentaZ)
																	{
																		miniFecha(cFecha1, pCuentaCliente->pCuenta[i].tFechaSaldaCon.dia(), pCuentaCliente->pCuenta[i].tFechaSaldaCon.mes(), pCuentaCliente->pCuenta[i].tFechaSaldaCon.ano());
																		sDato.Format("%s", cFecha1);
																		m_grid.QuickSetText(k, 6, sDato);
																		m_grid.QuickSetAlignment(k, 6, UG_ALIGNCENTER);
																	}
																	sDato.Format("%hd", pCuentaCliente->pCuenta[i].iTipoProducto);
																	m_grid.QuickSetText(k, 36, sDato);
																	m_grid.RedrawCell(k, 36);

																	if (pCuentaCliente->pCuenta[i].bCuentaZ)
																	{
																		lSaldoTmp += pCuentaCliente->pCuenta[i].lSaldo;
																		m_grid.QuickSetText(k, 2, "CP COMP ADC");
																		m_grid.QuickSetAlignment(k, 2, UG_ALIGNCENTER);
																		sDato.Format("%06ld", pCuentaCliente->pCuenta[i].lFactura);
																		m_grid.QuickSetText(k, 1, sDato);
																		m_grid.QuickSetAlignment(k, 1, UG_ALIGNRIGHT);
																	}
																	sDato.Format("%ld", pCuentaCliente->pCuenta[i].lCuentaCandidato);
																	m_grid.QuickSetText(k, 37, sDato);
																	m_grid.QuickSetAlignment(k, 37, UG_ALIGNCENTER);

																	if (iCandidatoAprobado == 1)
																	{
																		iSumaInteresMoratorio += pCuentaCliente->pCuenta[i].lInteresAdicional;
																		iMesesVencidos = (pCuentaCliente->pCuenta[i].lVencido - pCuentaCliente->pCuenta[i].lInteresAdicional) / pCuentaCliente->pCuenta[i].lBase;
																		sprintf_s(cJsonPostDescuentos, "\"tipoCuenta\":%d,\"saldoSinInteres\":%ld,\"interes\":%ld,\"vencidoSinInteres\":%ld"
																			",\"mesesVencidos\":%d,\"abonoBase\":%ld,\"facturaCuenta\":%ld,\"descripcionCuenta\":\"%s\","
																			, CUENTA_REVOLVENTE, pCuentaCliente->pCuenta[i].lSaldo, pCuentaCliente->pCuenta[i].lInteresAdicional, pCuentaCliente->pCuenta[i].lVencido, iMesesVencidos, pCuentaCliente->pCuenta[i].lBase, pCuentaCliente->pCuenta[i].lFactura, pCuentaCliente->pCuenta[i].cDescripcion);

																		if (icuenta == 1)
																		{
																			sJsonPostDescuentoMoratorio.append(",{");
																		}
																		sprintf_s(cMensajeSeguimiento, "CDlgCapturarAbono::Datos Saldos del cliente para descuento Revolvente-->cliente: %ld,Saldo:%ld, interes:%ld, vencido:%ld",m_grid.lCliente,pCuentaCliente->pCuenta[i].lSaldo, pCuentaCliente->pCuenta[i].lInteresAdicional, pCuentaCliente->pCuenta[i].lVencido);
																		grabarLog(cMensajeSeguimiento);
																		sJsonPostDescuentoMoratorio.append(cJsonPostDescuentos);
																		icuenta = 1;
																	}
																}
																else if (pCuentaCliente->pCuenta[i].iTipoDeCuenta == CUENTA_REESTRUCTURADA) //Tipo de Cuenta 9=Restructurada Coppel,
																{
																	sprintf_s(cMensajeSeguimiento, "CDlgCapturarAbono::desplegarDatosCliente--> leyendo cuenta de Reestructura");
																	grabarLog(cMensajeSeguimiento);
																	bClienteReestructurado = true;
																	sDato.Format("%04hd", pCuentaCliente->pCuenta[i].iTienda);
																	m_grid.QuickSetText(k, 0, sDato);
																	m_grid.QuickSetAlignment(k, 0, UG_ALIGNRIGHT);
																	sDato.Format("%06ld", pCuentaCliente->pCuenta[i].lFactura);
																	m_grid.QuickSetText(k, 1, sDato);
																	m_grid.QuickSetAlignment(k, 1, UG_ALIGNRIGHT);

																	sDato.Format("%ld", pCuentaCliente->pCuenta[i].lSaldaCon);
																	m_grid.QuickSetText(k, 26, sDato);
																	m_grid.QuickSetAlignment(k, 26, UG_ALIGNCENTER);

																	sDato.Format("%hd", pCuentaCliente->pCuenta[i].iTipoProducto);
																	m_grid.QuickSetText(k, 36, sDato);
																	m_grid.RedrawCell(k, 36);

																	if (pCuentaCliente->pCuenta[i].bCuentaZ)
																	{
																		lSaldoTmp += pCuentaCliente->pCuenta[i].lSaldo;
																		m_grid.QuickSetText(k, 2, "CP MUEB");
																		m_grid.QuickSetAlignment(k, 2, UG_ALIGNCENTER);
																	}
																	else
																	{
																		miniFecha(cFecha1, pCuentaCliente->pCuenta[i].tFechaVenta.dia(), pCuentaCliente->pCuenta[i].tFechaVenta.mes(), pCuentaCliente->pCuenta[i].tFechaVenta.ano());
																		sDato.Format("%s", cFecha1);
																		m_grid.QuickSetText(k, 2, sDato);
																		m_grid.QuickSetAlignment(k, 2, UG_ALIGNCENTER);
																		usingx("#,###,###", cRespuesta, (double)pCuentaCliente->pCuenta[i].lImporteVenta);
																		cRespuesta[9] = 0;
																		sDato.Format("%s", cRespuesta);
																		m_grid.QuickSetText(k, 3, sDato);
																		m_grid.QuickSetAlignment(k, 3, UG_ALIGNRIGHT);
																	}

																	lImporteTotal += pCuentaCliente->pCuenta[i].lImporteVenta;

																	if (iCandidatoAprobado == 1)
																	{
																		iMesesVencidos = (pCuentaCliente->pCuenta[i].lVencido - pCuentaCliente->pCuenta[i].lInteresAdicional) / pCuentaCliente->pCuenta[i].lBase;
																		sprintf_s(cJsonPostDescuentos, "\"tipoCuenta\":%d,\"saldoSinInteres\":%ld,\"interes\":%ld,\"vencidoSinInteres\":%ld"
																			",\"mesesVencidos\":%d,\"abonoBase\":%ld,\"facturaCuenta\":%ld,\"descripcionCuenta\":\"%s\","
																			, CUENTA_REESTRUCTURADA, pCuentaCliente->pCuenta[i].lSaldo, pCuentaCliente->pCuenta[i].lInteresAdicional, pCuentaCliente->pCuenta[i].lVencido, iMesesVencidos, pCuentaCliente->pCuenta[i].lBase, pCuentaCliente->pCuenta[i].lFactura, pCuentaCliente->pCuenta[i].cDescripcion);

																		if (icuenta == 1)
																		{
																			sJsonPostDescuentoMoratorio.append(",{");
																		}

																		sJsonPostDescuentoMoratorio.append(cJsonPostDescuentos);
																		icuenta = 1;
																	}
																}
																else if (pCuentaCliente->pCuenta[i].iTipoDeCuenta == CUENTA_PLANMOVISTAR) //Tipo de Cuenta PLAN_MOVISTAR,
																{
																	sprintf_s(cMensajeSeguimiento, "CDlgCapturarAbono::desplegarDatosCliente--> leyendo cuenta de Plan Movistar");
																	grabarLog(cMensajeSeguimiento);
																	sDato.Format("%04hd", pCuentaCliente->pCuenta[i].iTienda);
																	m_grid.QuickSetText(k, 0, sDato);
																	m_grid.QuickSetAlignment(k, 0, UG_ALIGNRIGHT);
																	sDato.Format("%06ld", pCuentaCliente->pCuenta[i].lFactura);
																	m_grid.QuickSetText(k, 1, sDato);
																	m_grid.QuickSetAlignment(k, 1, UG_ALIGNRIGHT);
																	miniFecha(cFecha1, pCuentaCliente->pCuenta[i].tFechaVenta.dia(), pCuentaCliente->pCuenta[i].tFechaVenta.mes(), pCuentaCliente->pCuenta[i].tFechaVenta.ano());
																	sDato.Format("%s", cFecha1);
																	m_grid.QuickSetText(k, 2, sDato);
																	m_grid.QuickSetAlignment(k, 2, UG_ALIGNCENTER);
																	usingx("#,###,###", cRespuesta, (double)pCuentaCliente->pCuenta[i].lImporteVenta);

																	cRespuesta[9] = 0;
																	sDato.Format("%s", cRespuesta);
																	m_grid.QuickSetText(k, 3, sDato);
																	m_grid.QuickSetAlignment(k, 3, UG_ALIGNRIGHT);

																	sDato.Format("PLAN MOVISTAR");
																	fontID = m_grid.AddFont("Lucida Console Bold", 11, 200);
																	m_grid.QuickSetFont(k, -1, fontID);
																	m_grid.QuickSetText(k, -1, sDato);

																	sDato.Format("%hd", pCuentaCliente->pCuenta[i].iPlazo);
																	m_grid.QuickSetText(k, 9, sDato);
																	m_grid.QuickSetAlignment(k, 9, UG_ALIGNRIGHT);

																	sDato.Format("%hd", pCuentaCliente->pCuenta[i].iTipoProducto);
																	m_grid.QuickSetText(k, 36, sDato);
																	m_grid.RedrawCell(k, 36);

																	if (iCandidatoAprobado == 1)
																	{
																		iMesesVencidos = (pCuentaCliente->pCuenta[i].lVencido - pCuentaCliente->pCuenta[i].lInteresAdicional) / pCuentaCliente->pCuenta[i].lBase;
																		sprintf_s(cJsonPostDescuentos, "\"tipoCuenta\":%d,\"saldoSinInteres\":%ld,\"interes\":%ld,\"vencidoSinInteres\":%ld"
																			",\"mesesVencidos\":%d,\"abonoBase\":%ld,\"facturaCuenta\":%ld,\"descripcionCuenta\":\"%s\","
																			, CUENTA_PLANMOVISTAR, pCuentaCliente->pCuenta[i].lSaldo, pCuentaCliente->pCuenta[i].lInteresAdicional, pCuentaCliente->pCuenta[i].lVencido, iMesesVencidos, pCuentaCliente->pCuenta[i].lBase, pCuentaCliente->pCuenta[i].lFactura, pCuentaCliente->pCuenta[i].cDescripcion);

																		if (icuenta == 1)
																		{
																			sJsonPostDescuentoMoratorio.append(",{");
																		}

																		sJsonPostDescuentoMoratorio.append(cJsonPostDescuentos);
																		icuenta = 1;
																	}
																}

																if (pCuentaCliente->iConvenios > 0 && pCuentaCliente->pCuenta[i].iTipoDeCuenta != CUENTA_SEGURO && pCuentaCliente->pCuenta[i].iTipoDeCuenta != CUENTA_SEGUROAUTO && pCuentaCliente->pCuenta[i].iTipoDeCuenta != CUENTA_PLANMOVISTAR)
																{
																	for (int l = 0; l < pCuentaCliente->iConvenios; l++)
																	{
																		if (pCuentaCliente->convenios[l].lFactura == pCuentaCliente->pCuenta[i].lFactura && pCuentaCliente->convenios[l].iTipoCuenta == pCuentaCliente->pCuenta[i].iTipoDeCuenta)
																		{
																			miniFecha(cFecha1, pCuentaCliente->convenios[l].tFechaConvenio.dia(), pCuentaCliente->convenios[l].tFechaConvenio.mes(), pCuentaCliente->convenios[l].tFechaConvenio.ano());
																			cFecha1[7] = 0;

																			if (iCandidatoAprobado == 1)
																			{
																				if ((pCuentaCliente->convenios[l].iTipoConvenio == 3 && pCuentaCliente->convenios[l].iSubTipoConvenio == 3)||(pCuentaCliente->convenios[l].iTipoConvenio == 2 && pCuentaCliente->convenios[l].iSubTipoConvenio == 6)) //32626
																				{
																					sprintf_s(cJsonPostDescuentos, "\"identificadorConvenio\":%d,", 1);
																					sJsonPostDescuentoMoratorio.append(cJsonPostDescuentos);
																					iCandidatoConvenioMora = 1;

																					sDato.Format("%s", cFecha1);
																					m_grid.QuickSetText(k, 7, sDato);
																					m_grid.QuickSetAlignment(k, 7, UG_ALIGNCENTER);
																					m_grid.QuickSetAlignment(k, 2, UG_ALIGNCENTER);

																					sDato.Format("%08ld", pCuentaCliente->convenios[l].lEfectuoConvenio);
																					m_grid.QuickSetText(k, 8, sDato);
																					m_grid.QuickSetAlignment(k, 8, UG_ALIGNCENTER);
																					m_grid.QuickSetAlignment(k, 3, UG_ALIGNRIGHT);

																					sDato.Format("%4hd", pCuentaCliente->convenios[l].iPlazoConvenio);
																					m_grid.QuickSetText(k, 9, sDato);
																					m_grid.QuickSetAlignment(k, 9, UG_ALIGNRIGHT);

																					m_grid.QuickSetText(k, 10, "DESC MOR");
																					m_grid.QuickSetAlignment(k, 10, UG_ALIGNRIGHT);

																					//GrabarTmpParametrosMoratorio(iCandidatoConvenioMora);*

																				}
																				else
																				{
																					sprintf_s(cJsonPostDescuentos, "\"identificadorConvenio\":%d,", 0);
																					sJsonPostDescuentoMoratorio.append(cJsonPostDescuentos);
																					m_grid.QuickSetText(k, 10, " ");
																					m_grid.QuickSetAlignment(k, 10, UG_ALIGNRIGHT);

																					miniFecha(cFecha1, pCuentaCliente->convenios[l].tFechaConvenio.dia(), pCuentaCliente->convenios[l].tFechaConvenio.mes(), pCuentaCliente->convenios[l].tFechaConvenio.ano());
																					cFecha1[7] = 0;

																					sDato.Format("%s", cFecha1);
																					m_grid.QuickSetText(k, 7, sDato);
																					m_grid.QuickSetAlignment(k, 7, UG_ALIGNCENTER);
																					m_grid.QuickSetAlignment(k, 2, UG_ALIGNCENTER);

																					sDato.Format("%08ld", pCuentaCliente->convenios[l].lEfectuoConvenio);
																					m_grid.QuickSetText(k, 8, sDato);
																					m_grid.QuickSetAlignment(k, 8, UG_ALIGNCENTER);
																					m_grid.QuickSetAlignment(k, 3, UG_ALIGNRIGHT);

																					sDato.Format("%4hd", pCuentaCliente->convenios[l].iPlazoConvenio);
																					m_grid.QuickSetText(k, 9, sDato);
																					m_grid.QuickSetAlignment(k, 9, UG_ALIGNRIGHT);

																					usingx("#,###,###", cRespuesta, (double)pCuentaCliente->convenios[l].lImporteConvenio);
																					cRespuesta[9] = 0;
																					lImporteConvenioTotal += pCuentaCliente->convenios[l].lImporteConvenio;
																					sDato.Format("%s", cRespuesta);
																					m_grid.QuickSetText(k, 10, sDato);
																					m_grid.QuickSetAlignment(k, 10, UG_ALIGNRIGHT);
																					break;
																				}

																			}
																			else
																			{
																				sprintf_s(cJsonPostDescuentos, "\"identificadorConvenio\":%d,", 0);
																				sJsonPostDescuentoMoratorio.append(cJsonPostDescuentos);
																				m_grid.QuickSetText(k, 10, " ");
																				m_grid.QuickSetAlignment(k, 10, UG_ALIGNRIGHT);

																				miniFecha(cFecha1, pCuentaCliente->convenios[l].tFechaConvenio.dia(), pCuentaCliente->convenios[l].tFechaConvenio.mes(), pCuentaCliente->convenios[l].tFechaConvenio.ano());
																				cFecha1[7] = 0;

																				sDato.Format("%s", cFecha1);
																				m_grid.QuickSetText(k, 7, sDato);
																				m_grid.QuickSetAlignment(k, 7, UG_ALIGNCENTER);
																				m_grid.QuickSetAlignment(k, 2, UG_ALIGNCENTER);

																				sDato.Format("%08ld", pCuentaCliente->convenios[l].lEfectuoConvenio);
																				m_grid.QuickSetText(k, 8, sDato);
																				m_grid.QuickSetAlignment(k, 8, UG_ALIGNCENTER);
																				m_grid.QuickSetAlignment(k, 3, UG_ALIGNRIGHT);

																				sDato.Format("%4hd", pCuentaCliente->convenios[l].iPlazoConvenio);
																				m_grid.QuickSetText(k, 9, sDato);
																				m_grid.QuickSetAlignment(k, 9, UG_ALIGNRIGHT);

																				usingx("#,###,###", cRespuesta, (double)pCuentaCliente->convenios[l].lImporteConvenio);
																				cRespuesta[9] = 0;
																				lImporteConvenioTotal += pCuentaCliente->convenios[l].lImporteConvenio;
																				sDato.Format("%s", cRespuesta);
																				m_grid.QuickSetText(k, 10, sDato);
																				m_grid.QuickSetAlignment(k, 10, UG_ALIGNRIGHT);
																				break;
																			}
																		}
																		else
																		{
																			sprintf_s(cJsonPostDescuentos, "\"identificadorConvenio\":%d,", 0);
																			sJsonPostDescuentoMoratorio.append(cJsonPostDescuentos);
																		}
																	}
																}
																else
																{
																	sprintf_s(cJsonPostDescuentos, "\"identificadorConvenio\":%d,", 0);
																	sJsonPostDescuentoMoratorio.append(cJsonPostDescuentos);
																}
																//Calcular Mese Vencidoas para int primer mes
																if (iCandidatoAprobado == 1 && (pCuentaCliente->pCuenta[i].iTipoDeCuenta == CUENTA_REVOLVENTE || pCuentaCliente->pCuenta[i].iTipoDeCuenta == CUENTA_MUEBLES || pCuentaCliente->pCuenta[i].iTipoDeCuenta == CUENTA_PRESTAMOS || pCuentaCliente->pCuenta[i].iTipoDeCuenta == CUENTA_ROPA || pCuentaCliente->pCuenta[i].iTipoDeCuenta == CUENTA_TAIRE))
																{
																	sprintf_s(cJsonPostDescuentos, "\"cuentaCandidata\":%ld}", pCuentaCliente->pCuenta[i].lCuentaCandidato);
																	sJsonPostDescuentoMoratorio.append(cJsonPostDescuentos);
																}
																else
																{
																	sprintf_s(cJsonPostDescuentos, "\"cuentaCandidata\":%d}", 0);
																	sJsonPostDescuentoMoratorio.append(cJsonPostDescuentos);
																}
																//Calcular Mese Vencidoas para int primer mes

																sDato.Format("%ld", pCuentaCliente->pCuenta[i].lInteresAdicionalPrimerMes);
																m_grid.QuickSetText(k, 35, sDato);

																usingx("#,###,###", cRespuesta, (double)pCuentaCliente->pCuenta[i].lSaldo);

																cRespuesta[9] = 0;
																sDato.Format("%s", cRespuesta);
																m_grid.QuickSetText(k, 12, sDato);
																m_grid.QuickSetAlignment(k, 12, UG_ALIGNRIGHT);

																usingx("#,###,###", cRespuesta, (double)pCuentaCliente->pCuenta[i].lInteresAdicional);

																cRespuesta[9] = 0;
																sDato.Format("%s", cRespuesta);
																m_grid.QuickSetText(k, 13, sDato);
																m_grid.QuickSetAlignment(k, 13, UG_ALIGNRIGHT);

																usingx("#,###,###", cRespuesta, (double)pCuentaCliente->pCuenta[i].lBase);
																cRespuesta[9] = 0;
																sDato.Format("%s", cRespuesta);
																m_grid.QuickSetText(k, 14, sDato);
																m_grid.QuickSetAlignment(k, 14, UG_ALIGNRIGHT);

																usingx("#,###,###", cRespuesta, (double)pCuentaCliente->pCuenta[i].lVencido);
																cRespuesta[9] = 0;
																sDato.Format("%s", cRespuesta);
																m_grid.QuickSetText(k, 15, sDato);
																m_grid.QuickSetAlignment(k, 15, UG_ALIGNRIGHT);

																usingx("#,###,###", cRespuesta, (double)pCuentaCliente->pCuenta[i].lMinimo);
																cRespuesta[9] = 0;
																sDato.Format("%s", cRespuesta);
																m_grid.QuickSetText(k, 16, sDato);
																m_grid.QuickSetAlignment(k, 16, UG_ALIGNRIGHT);



																usingx("#,###,###", cRespuesta, (double)pCuentaCliente->pCuenta[i].lSaldaCon);

																cRespuesta[9] = 0;
																sDato.Format("%s", cRespuesta);
																m_grid.QuickSetText(k, 18, sDato);
																m_grid.QuickSetAlignment(k, 18, UG_ALIGNRIGHT);





																usingx("#,###,###", cRespuesta, (double)pCuentaCliente->pCuenta[i].lBonificacion);

																cRespuesta[9] = 0;
																sDato.Format("%s", cRespuesta);
																m_grid.QuickSetText(k, 19, sDato);
																m_grid.QuickSetAlignment(k, 19, UG_ALIGNRIGHT);

															}

															sDato.Format("%ld", pCuentaCliente->pCuenta[i].iTipoDeCuenta);
															m_grid.QuickSetText(k, 37, sDato);
															m_grid.QuickSetAlignment(k, 37, UG_ALIGNRIGHT);

															sDato.Format("%04d-%02d-%02d", pCuentaCliente->pCuenta[i].tFechaUltimaCompra.ano(),
																pCuentaCliente->pCuenta[i].tFechaUltimaCompra.mes(), pCuentaCliente->pCuenta[i].tFechaUltimaCompra.dia());

															m_grid.QuickSetText(k, 39, sDato);
															m_grid.QuickSetAlignment(k, 39, UG_ALIGNRIGHT);

															m_grid.QuickGetText(k, 21, &sDato);

															if (atol(sDato) <= 0L)
															{
																sDato.Format("%ld", 0L);
																m_grid.QuickSetText(k, 21, sDato);
															}

															m_grid.QuickSetAlignment(k, 21, UG_ALIGNRIGHT);
															m_grid.obtenerTotalAbono();
															m_grid.RedrawCell(k, 21);

															sDato.Format("%d", 0); //para saber si se le capturo convenio a la cuenta
															m_grid.QuickSetText(k, 28, sDato);
															m_grid.QuickSetAlignment(k, 28, UG_ALIGNRIGHT);

															if (iFlagConsultaDomiciliacion == 1)
															{
																if (iFlagDomiciliacionCuentas == 1 || (m_grid.cArea == 'R' && iFlagMenuDomiciliacionDeRopa == 1) || (m_grid.cArea == 'M' && iFlagMenuDomiciliacionDeMuebles == 1))//imprime el estatus de la domiciliacion de la cuenta
																{
																	//if (iFlagTiendaLocal == 0)
																	//{
																		ImprimirEstatusDomiciliacion(k, i);
																	//}
																}
															}

															if (bConsultarSeguro)
															{
																k++;

															}
														}
														//Seccion para mostrar las cuentas de seguros motos y celulares.
														if( flagCuentasSeguros == 1 && pCuentasSeguros->iCuentasActivas > 0 ) {
															grabarLog("DlgCapturarAbono -> Entró a leer cuentas de seguros");
															cuentasSeguros.m_grid = &m_grid;															
															cuentasSeguros.pCuentasSeguros = pCuentasSeguros;	
															k = cuentasSeguros.cargarCuentasSeguros(k, &pCuentasSeguros->pCuentas);
															grabarLog("DlgCapturarAbono -> Finalizó lcetura de cuentas de seguros");
														}

														for (i = 0; i < iTotalCuentas; i++)
														{
															if (pCuentaCliente->pCuenta[i].iTipoDeCuenta == CUENTA_DINEROELECTRONICO)
															{
																iTotalCuentas--;
																m_grid.iTotalCuentas = iTotalCuentas;
																iSaldoDineroElectronicoCuenta = pCuentaCliente->pCuenta[i].lDineroElectronico ;
																pCuentaClienteAbonosPuntuales = pCuentaCliente;
																break;
															}
														}

														if (iRestarCuentas == 1) {

															iTotalCuentas = iTotalCuentas - 1;
															m_grid.iTotalCuentas = iTotalCuentas;
														}

														if (iFlagSeguroAdicional == 1)
														{
															iTotalCuentas = iTotalCuentas - iSegurosAdicionales;
															m_grid.iTotalCuentas = iTotalCuentas;
														}

														if (iFlagPlandeSalud == 1)
														{
															iTotalCuentas = iTotalCuentas - iPlanAdicionales;
															m_grid.iTotalCuentas = iTotalCuentas;
														}

														if (iSegurosInvalidos > 0)
														{
															iTotalCuentas = iTotalCuentas - iSegurosInvalidos;
															m_grid.iTotalCuentas = iTotalCuentas;
														}

														if (iPlanesInvalidos > 0)
														{
															iTotalCuentas = iTotalCuentas - iPlanesInvalidos;
															m_grid.iTotalCuentas = iTotalCuentas;
														}

														if (iSeguroCancelado > 0)
														{
															iTotalCuentas = iTotalCuentas - iSeguroCancelado;
															m_grid.iTotalCuentas = iTotalCuentas;
														}

														if (iPlanCancelado > 0)
														{
															iTotalCuentas = iTotalCuentas - iPlanCancelado;
															m_grid.iTotalCuentas = iTotalCuentas;
														}

														//Consideracion de las cuentas activas que se deben mostrar de seguros.
														if (flagCuentasSeguros == 1 && pCuentasSeguros->iCuentasActivas > 0){ 
															iTotalCuentas = iTotalCuentas + pCuentasSeguros->iCuentasActivas;
															m_grid.iTotalCuentas = m_grid.iTotalCuentas + pCuentasSeguros->iCuentasActivas;
														}

														sDato.Format("%d", iTotalCuentas);
														m_grid2.QuickSetText(0, 0, sDato);

														if (iTotalCuentas <= 8)
														{
															m_flecha.ShowWindow(false);
														}

														sDato.Format("$%ld (1M)", pCuentaCliente->totalesCuenta.lInteresAdicionalPrimerMes);
														m_intMesUno.SetWindowText(sDato);

														lpreImporte = pCuentaCliente->totalesCuenta.lSaldoTotal + pCuentasSeguros->lSaldo;
														usingx("#,###,###", cRespuesta, (double)lpreImporte);
														cRespuesta[9] = 0;

														sDato.Format("%s", cRespuesta);
														m_grid2.QuickSetText(0, 12, sDato);//Saldo
														m_grid2.QuickSetAlignment(0, 12, UG_ALIGNRIGHT);

														//CAMBIOS PARA NUEVO LOGICA DE MORAS -- EDUALF (1)
														lpreImporte = pCuentaCliente->totalesCuenta.lVencidoTotal + pCuentasSeguros->lVencido;
														usingx("#,###,###", cRespuesta, (double)lpreImporte);
														cRespuesta[9] = 0;
														sDato.Format("%s", cRespuesta);//Vencido

														m_grid2.QuickSetText(0, 15, sDato);//Vencido
														m_grid2.QuickSetAlignment(0, 15, UG_ALIGNRIGHT);

														//CAMBIOS PARA NUEVO LOGICA DE MORAS -- EDUALF (2)
														usingx("#,###,###", cRespuesta, (double)pCuentaCliente->totalesCuenta.lIntAdicTotal);
														cRespuesta[9] = 0;
														sDato.Format("%s", cRespuesta);

														m_grid2.QuickSetText(0, 13, sDato);
														m_grid2.QuickSetAlignment(0, 13, UG_ALIGNRIGHT);
														
														pCuentaCliente->totalesCuenta.lSaldaConTotal += cuentasSeguros.lSaldaCon;
														usingx("#,###,###", cRespuesta, (double)pCuentaCliente->totalesCuenta.lSaldaConTotal);
														cRespuesta[9] = 0;
														sDato.Format("%s", cRespuesta);
														m_grid2.QuickSetText(0, 18, sDato);//Minimo
														m_grid2.QuickSetAlignment(0, 18, UG_ALIGNRIGHT);

														usingx("#,###,###", cRespuesta, (double)lImporteConvenioTotal);
														cRespuesta[9] = 0;
														sDato.Format("%s", cRespuesta);
														m_grid2.QuickSetText(0, 10, sDato);
														m_grid2.QuickSetAlignment(0, 10, UG_ALIGNRIGHT);

														usingx("#,###,###", cRespuesta, (double)lImporteTotal);
														cRespuesta[9] = 0;
														sDato.Format("%s", cRespuesta); //Importe

														m_grid2.QuickSetText(0, 3, sDato);
														m_grid2.QuickSetAlignment(0, 3, UG_ALIGNRIGHT);

														usingx("#,###,###", cRespuesta, (double)pCuentaCliente->totalesCuenta.lBonificacionTotal);
														cRespuesta[9] = 0;
														sDato.Format("%s", cRespuesta);
														m_grid2.QuickSetText(0, 19, sDato);
														m_grid2.QuickSetAlignment(0, 19, UG_ALIGNRIGHT);

														usingx("#,###,###", cRespuesta, pCuentaCliente->totalesCuenta.lMinimoTotal + pCuentasSeguros->lMinimoTotal);
														cRespuesta[9] = 0;
														sDato.Format("%s", cRespuesta); //Minimo
														m_grid2.QuickSetText(0, 16, sDato);
														m_grid2.QuickSetAlignment(0, 16, UG_ALIGNRIGHT);

														//CAMBIO DE MORAS
														if(iFlagMoras == 1)
														{
															CCalculoMoras moras;
															lMoras = moras.CalcularMoras(
																(float)pCuentaCliente->totalesCuenta.lVencidoTotal + pCuentasSeguros->lVencido,
																(float)pCuentaCliente->totalesCuenta.lIntAdicTotal,
																(float)pCuentaCliente->totalesCuenta.lBaseTotal
															);
															//delete(&moras);

															sDato.Format("%c", pCuentaCliente->cPuntualidad);
															m_puntualidad2.SetWindowText(sDato);

															if(sDato.Trim() == "Z")
															{
																sLeyenda ="CLIENTE Z";
																m_leyendaAclaracion.SetWindowTextA(sLeyenda);
															}
															else if(lMoras != 0)
															{
																sprintf_s(cMensaje,"ABONOS VENCIDOS: %ld", lMoras);
																m_leyendaAclaracion.SetWindowTextA(cMensaje);
															}
															else
															{
																sLeyenda ="CLIENTE AL CORRIENTE";
																m_leyendaAclaracion.SetWindowTextA(sLeyenda);
															}
														}


														m_grid2.RedrawAll();

														m_grid.RedrawAll();

														if ((iFlagBanorte != 0 && m_grid.lCliente != 1708L) || iFlagPlandeSalud == 1)
														{

															lCuota = checarVigenciaSeguro(iCantidadSegurosClub, pCuentaCliente->totalesCuenta.lMinimoTotal, lCuotaTemporal, lCuotaPS, pCuentasSeguros->lMinimoTotal);
														}

														if(iSistema == SISTEMA_CAJAS /*&& iFlagTiendaLocal == 0*/)
														{
															//Mostrar indicador de abonos puntuales
															if(iflagCoppelRecompensaTuPuntualidad == 1)
															{
																if(ConsultaClienteCoppelRecompensaTuPuntualidad())
																{
																	MostrarAbonosPuntualesCoppelMax();
																}
															}
															//Mostrar indicador de saldo de dinero electronico
															if(iflagDineroElectronico == 1)
															{
																if(ConsultarSaldoDineroElectronicoCliente(true))
																{
																	bMostroDineroElectronico = true;
																}
															}
														}
														m_grid2.RedrawAll();

														m_grid.RedrawAll();
													}
												}


												if (iFlagTiendaLocal >= 1) // Fecha mas cercana a la fecha del gndominio, sin pasarse, de las FUM de las ctas del cte...
												{
													sFechaTienda.Format("%04d%02d%02d", iAnioActual, iMesActual, iDiaActual);
													sFechaTienda.Trim();
													memset(cFechaMasActualCte, 0, sizeof(cFechaMasActualCte));
													for (int i = 0; i < pCuentaCliente->iCuentas; i++)
													{
														if (pCuentaCliente->pCuenta[i].iTipoDeCuenta != 8)
														{
															sDato.Format("%04d%02d%02d", pCuentaCliente->pCuenta[i].tFechaUltimoMovimiento.ano(), pCuentaCliente->pCuenta[i].tFechaUltimoMovimiento.mes(), pCuentaCliente->pCuenta[i].tFechaUltimoMovimiento.dia());
															sDato.Trim();
															if (!sDato.IsEmpty())
															{
																lFechaMasActual = atol(sDato);
																if (lFechaMasActual > atol(cFechaMasActualCte) && lFechaMasActual <= atol(sFechaTienda))
																{
																	sprintf_s(cFechaMasActualCte, "%ld", lFechaMasActual);
																	cFechaMasActualCte[8] = 0;
																}
															}
														}
													}
												}

												if (_access("c:\\sys\\mem\\tarjeto.ta", 0) == 0)
												{
													AfxMessageBox("Cliente cuenta con un Plan Tarifario, para abonar a la cuenta debe hacerlo en el menú de tiempo aire 1.");
												}

												if (iFlagTiendaLocal == 0 && iFlagAsteriscoCoppel == 1) // Fecha mas cercana a la fecha del gndominio, sin pasarse, de las FUM de las ctas del cte...
												{
													if ((m_grid.lCliente != CLIENTE_PROMOTOR && m_grid.lCliente != CLIENTE_CFE) && (pCuentaCliente->cPuntualidad == 'A' || (pCuentaCliente->cPuntualidad == 'N' && pCuentaCliente->cSubPuntualidad == 'A')))
													{
														cPuntualidadAsterisco[0] = pCuentaCliente->cPuntualidad;
														cPuntualidadAsterisco[1] = 0;
														cSubPuntualidadAsterisco[0] = pCuentaCliente->cSubPuntualidad;
														cSubPuntualidadAsterisco[1] = 0;
														cSituacionEspecialAsterisco = pCuentaCliente->cSituacionEspecial;
														iCausaSituacionEspecialAsterisco = (int)pCuentaCliente->iCausaSituacionEspecial;
														lVencidoTiempoAireAsterisco = (long)pCuentaCliente->totalesCuenta.lVencidoTotal;
														lAbonoBaseTiempoAireAsterisco = (long)pCuentaCliente->totalesCuenta.lBaseTotal;

														memset(cMensajeSeguimiento, 0, sizeof(cMensajeSeguimiento));
														sprintf_s(cMensajeSeguimiento, "Cliente: [%ld]", m_grid.lCliente);
														grabarLog(cMensajeSeguimiento);

														iPorcentajeUtilizado = (int)(pCuentaCliente->lineaCredito.lSaldoCliente / (float)pCuentaCliente->lineaCredito.lLineadeCreditoReal) * 100;

														/// CAMBIO PARA ASTERISCO COPPEL
														bTieneSitEsp = validarTieneSitEspCliente();
														iRegla = 1;//INCLUIR CLIENTES REGISTRAR TELEFONOS SERVICIO ASTERISCO COPPEL
														iProceso = 1; // VENTA ASTERISCO COPPEL
														bAplicaAsteriscoSitEsp = ValidarSituacionEspecial(m_grid.lCliente, iRegla, iProceso, 7);
														//////
														if (candidatoAsteriscoCoppel04(&odbc, m_grid.lCliente, 1, cPuntualidadAsterisco, cSubPuntualidadAsterisco,
															cSituacionEspecialAsterisco, iCausaSituacionEspecialAsterisco, lVencidoTiempoAireAsterisco, bClienteCandidato, lAbonoBaseTiempoAireAsterisco,
															lSalarioMinimo, iPorcentajeUtilizado, 3, 0, 1, m_grid.iTienda, 'C', m_grid.iCaja, bTieneSitEsp, bAplicaAsteriscoSitEsp))
														{
															m_grid.cPuntualidad[0] = pCuentaCliente->cPuntualidad;
															m_grid.cSubPuntualidad[0] = pCuentaCliente->cSubPuntualidad;
															m_asteriscocoppel.SetWindowText("Ofrecer a cte *Coppel");
														}
													}
												}
												else
												{
													bClienteCandidato = false;
												}

												candidatoReestructura.lInteresAdicional = pCuentaCliente->totalesCuenta.lIntAdicTotal;
												candidatoReestructura.lVencidoTotal = pCuentaCliente->totalesCuenta.lVencidoTotal;
												candidatoReestructura.lBaseTotal = pCuentaCliente->totalesCuenta.lBaseTotal;
												candidatoReestructura.lSaldoTotal = pCuentaCliente->totalesCuenta.lSaldoTotal;
												candidatoReestructura.lSaldaConTotal = pCuentaCliente->totalesCuenta.lSaldaConTotal;
												sprintf_s(candidatoReestructura.cPuntualidad, "%c", pCuentaCliente->cPuntualidad);
												sprintf_s(candidatoReestructura.cSituacionEspecial, "%c", pCuentaCliente->cSituacionEspecial);
												sprintf_s(candidatoReestructura.cSexo, "%c", pCuentaCliente->cSexo);
												candidatoReestructura.iCiudadCliente = pCuentaCliente->iCiudad;
												candidatoReestructura.iCiudad = iCiudadGnDominio;
											}
											else
											{
												AfxMessageBox(" NO SE ENCONTRO AL CLIENTE ");
												inicializar();
												inicializarCaptura();
												iFlagOk = 0;
											}
										}
										delete pCuentasSeguros;
										delete pCuentaCliente;
									}
								}
							}
						}
					}
				}
			}
		}
	}

	if (iCandidatoAprobado == 1)
	{
		memset(cApellidoMaterno, 0, sizeof(cApellidoMaterno));

		sprintf_s(cJsonPostDescuentos, "],\"numTienda\":%d,\"ipTienda\":\"%s\",\"ipCartera\":\"%s\"}", m_grid.iTienda, (LPCTSTR)m_grid.sServer, cIpServidorCartera);
		sJsonPostDescuentoMoratorio.append(cJsonPostDescuentos);

		if (!grabartmpClienteCandidatomoratorio((char*)sJsonPostDescuentoMoratorio.c_str(), 1, "grabadoDeCuentas"))
		{
			if(ErrorToken==false){// 37569 valida que no exista error
				AfxMessageBox(cMensaje);
			}
		}
	}

	// TEMPAPSESTRATCOB005 - Valida si es candidato a sana tu deuda y muestra el mensaje.
	if ((bExisteCuentaSolex && iFlagDespliegaDatosZ != 1) || iFlagDespliegaDatosZ == 1)
	{
		ValidarClienteSanaTuDeuda();
	}

	sprintf_s(cMensajeSeguimiento, "CDlgCapturarAbono::desplegarDatosCliente--> Fin busqueda del cliente[%ld]", m_grid.lCliente);
	grabarLog(cMensajeSeguimiento);

	return iFlagOk;
}
void CDlgCapturarAbono::actualizarPuntualidad()
{
	char cLog[500] = { 0 };
	int iLiquidoCtaPerdida = 0;

	sprintf_s(cLog, "FC0200805021521051 - entra - actualizarPuntualidad");
	grabarLog(cLog);

	if (lAbonoTotalTmp >= lSaldoTmp)
	{
		if (iFlagDespliegaDatosZ == 1) //si es cuenta perdida
		{
			if (iLiquidoCtaPerdida != 1)
			{
				iLiquidoCtaPerdida = 2;
			}
		}
	}
	else
	{
		if (iFlagDespliegaDatosZ == 1) //si es cuenta perdida
		{
			iLiquidoCtaPerdida = 1;
		}
	}

	if (iLiquidoCtaPerdida == 2)
	{
		CMaximo actualizaPuntualidad(&odbc_1);
		char cSql[120] = { 0 }, cMensaje[512] = { 0 };

		sprintf_s(cSql, "SELECT cractualizapuntualidad('0', '%ld', 'D', '', '%c', '%ld', '%ld', '%ld' );", m_grid.lCliente, m_grid.cArea, m_grid.iCaja, m_grid.iTienda, m_grid.lEmpleado);

		if (!actualizaPuntualidad.Exec(cSql))
		{
			actualizaPuntualidad.odbc->GetLastError(actualizaPuntualidad.GetHstmt());
			grabarMensajeError("C", m_grid.iCaja, (LPTSTR)(LPCTSTR)m_grid.sServer, "CapturarAbono", "CDlgCapturarAbono", "actualizarPuntualidad", cSql, m_grid.lEmpleado, "Error al Actualizar la Puntualidad", actualizaPuntualidad.odbc, m_grid.iMuestraMsg);
		}
		else
		{
			actualizaPuntualidad.Commit();
			//Aqui desmarcar S3
			iProceso = CAPTURA_ABONO;
			iRegla = MARCAR_CLIENTE_LIQUIDO_CUENTA_PERDIDA;
			if (ConsultaMarcarSituacionEspecial(iRegla, iProceso, cSituacioEspecial, iIdSituacion))
			{
				char cNombreCliente[60] = { 0 };
				sprintf_s(cNombreCliente, "%s %s %s", sNombreCliente, sApellidoPaterno, sApellidoMaterno);
				sprintf_s(cJsonPost, "{\"ClaveEstatus\":\"M\",\"NumeroCliente\":%d,\"NumeroFolioSolicitante\":0,\"NombreCliente\":\"%s\""
					",\"IdSituacionEspecialSolicitado\":%d,\"NumEmpleadoAutoriza\":%ld,\"Tienda\":%d,\"Caja\":%d"
					",\"Area\":\"C\"}", m_grid.lCliente, cNombreCliente, iIdSituacion, m_grid.lEmpleado, m_grid.iTienda, m_grid.iCaja);

				if (!grabarCrearSituacionEspecialArray(cJsonPost, cMensaje))
				{
					AfxMessageBox(cMensaje);
				}
			}
		}
	}
}

void CDlgCapturarAbono::inicializarCaptura()
{
	char cLog[500] = { 0 };
	char cBarraOpciones[255] = { 0 }, cTexto[1026] = { 0 };
	int i = 0, j = 0;
	int fontID = m_grid.AddFont("Lucida Console Bold", 14, 200);

	sprintf_s(cLog, "FC0200805021521055 - entra - inicializarCaptura");
	grabarLog(cLog);

	iLevantoReestructura = 0;
	iTestigo = 0;
	bMostrarMensajeReestructura = true;
	m_msgCandidatoReestructura.SetWindowText("");

	if (iSistema == SISTEMA_CAJAS)
	{
		OcultarAbonosPuntualesCoppelMax();
	}

	m_cliente.SetWindowText("");
	m_msgMinimo.SetWindowText("");
	m_msgminimo2.SetWindowText("");
	m_msgminimo3.SetWindowText("");
	m_cliente.SetReadOnly(false);
	m_apellidoPaterno.SetWindowText("");
	m_apellidoMaterno.SetWindowText("");
	m_nombre.SetWindowText("");
	m_puntualidad2.SetWindowText("");
	m_edad.SetWindowText("");
	m_edad.SetWindowText("");
	m_leyendaAclaracion.SetWindowText("");
	sLeyenda = "";
	lBaseCcuenta = 0;
	while (m_grid.GetNumberCols() > 8)
	{
		m_grid.DeleteCol(m_grid.GetCurrentCol());
	};
	for (i = 0; i < m_grid.GetNumberRows(); i++)
	{
		for (j = 0; j < m_grid.GetNumberCols(); j++)
		{
			m_grid.QuickSetText(j, i, "");
			m_grid2.QuickSetText(0, i, "");
		}
	}

	m_grid.SetSH_Width(145);
	m_grid.SetHS_Height(0);

	for (i = -1; i < 8; i++)
	{
		//******* Set the font 
		m_grid.QuickSetFont(i, -1, fontID);

		m_grid.m_cell.SetBackColor(RGB(236, 233, 216));
		m_grid.SetCell(i, 11, &m_grid.m_cell);
		m_grid.RedrawCell(i, 11);
		m_grid.m_cell.SetBackColor(RGB(236, 233, 216));
		m_grid.SetCell(i, 17, &m_grid.m_cell);
		m_grid.RedrawCell(i, 17);
		m_grid.m_cell.SetBackColor(RGB(236, 233, 216));
		m_grid.SetCell(i, 20, &m_grid.m_cell);
		m_grid.RedrawCell(i, 20);
	}
	m_grid.QuickSetText(0, -1, "ROPA");
	m_grid.QuickSetText(1, -1, "ARTÍCULO 1");
	m_grid.QuickSetText(2, -1, "ARTÍCULO 2");
	m_grid.QuickSetText(3, -1, "ARTÍCULO 3");
	m_grid.QuickSetText(4, -1, "ARTÍCULO 4");
	m_grid.QuickSetText(5, -1, "ARTÍCULO 5");
	m_grid.QuickSetText(6, -1, "ARTÍCULO 6");
	m_grid.QuickSetText(7, -1, "ARTÍCULO 7");

	m_grid.SetColWidth(-1, 120);
	m_grid.SetColWidth(0, 83);
	m_grid.SetColWidth(1, 83);
	m_grid.SetColWidth(2, 83);
	m_grid.SetColWidth(3, 83);
	m_grid.SetColWidth(4, 83);
	m_grid.SetColWidth(5, 83);
	m_grid.SetColWidth(6, 83);
	m_grid.SetColWidth(7, 83);
	m_grid2.QuickSetText(0, -1, "TOTAL");
	m_grid2.QuickSetAlignment(0, -1, UG_ALIGNCENTER);
	m_grid2.SetColWidth(0, 95);
	bTienePlantel = false;
	m_grid.lCliente = 0L;
	memset(cPuntualidad, 0, sizeof(cPuntualidad));
	memset(m_grid.cSubPuntualidad, '0', 3);
	m_intMesUno.SetWindowText("");
	iTotalCuentas = 0L;
	m_grid.iFlagConvenioRealizado = 0;
	lConsultaAcumulado = 0L;
	lAcumuladoMonetario = 0L;
	iFlagDatosSeguro = 0;
	m_mensaje.SetWindowText("");
	m_mensaje2.SetWindowText("");
	m_mensaje3.SetWindowText("");
	iFlagDatosSeguro = 0;
	lFolioGrabarAbono = 0;

	iControles = 2;
	iFoco = 0;
	iTotalCuentas = 0;
	m_grid.iFlagConvenioRealizado = 0;
	lZonaEncuestado = 0;
	lTelefonoEncuestado = 0;
	iFlagMensajeHuella = 0;
	bExisteCuentaSolex = false; // TEMPAPSESTRATCOB005
	iFlagSanaTuDeuda = 0; // TEMPAPSESTRATCOB005
	iFlagDespliegaDatosZ = 0;
	lSaldoTmp = 0;
	lAbonoTotalTmp = 0;
	iFlagAutoGteCargo = 0;

	lTotalGlobalServicios = 0;
	iStatusAfore = 0;
	bCambioStatusAfore = false;
	iFlagMsjAfore = 0;
	iStatusAforeNvo = 0;

	iParentesco1 = iParentesco2 = iParentesco3 = iPorcentaje1 = iPorcentaje2 = iPorcentaje3 = iPorcentaje4 = iParentesco4 = 0;
	if (iFlagCampoInteligentePL > 0 && !bProvieneDatos_OtraArea
		&& (iSistema == SISTEMA_CAJAS || iSistema == SISTEMA_MUEBLES || iSistema == SISTEMA_ROPA))
	{
		m_cliente.SetLimitText(CARACTERES_CAMPO_INTELIGENTE);
	}
	else
	{
		m_cliente.SetLimitText(16);
	}
	iFlagMesUltimoMovimiento = 0;
	iFlagAbonoInteres = 0;
	iNumeroMeses = 0;
	lTotalAPagar = 0l;
	iFlagConvenio = 0;
	iFlagBonificacion = 0;
	lTotalEncuestar = 0;
	iFlagSeguro = 0;
	iRegresaDll = 0;
	iFlagBeneficiarios = 0;
	iFlagExisteEncuesta = 0;
	iFlagClienteEtp = 0;
	iFlagAbono = 0;
	iMarcaSeguroClub = 0;
	iFlagCapturoServicio = 0;
	iMesConvenio = 0;
	iFlagCapturoBeneficiariosClubNuevo = 0;
	iFlagMovimientos = 0;
	iFlagEficienciaCajera = 0;
	iFlagCrPrestamo = 0;
	iFlagCrRopa = 0;
	iFlagCrTaire = 0;
	iFlagCrMuebles = 0;
	iFlagCrSeguro = 0;
	iFlagCrCRevolvente = 0;
	lTotalSaldaCon = 0L;
	iContador = 0;
	lNumeroConexion = 0L;
	bBanderaTieneClub = false;
	lAcumuladoMonetario = 0L;
	lFolioBeneficiario = 0L;
	lPagoTotal = 0L;
	lPagoCliente = 0L;
	lAcumulado = 0;
	lConsultaAcumulado = 0L;
	iFlagComproSeguro = 0;
	iTipoSeguro = 0;
	lClienteEtp = 0L;
	lNumeroRecibo = 0L;
	iFlagEdoCuenta = -1;
	iFlagReactivo = 0;
	iFlagCapturoBeneficiariosClub = 0;
	iFlagConvenioTerminado = 0;
	lImporteConvenios = 0L;
	iFlagNuevo = 0;
	iFlag30Dias = -1;
	iFlagPago = 0;
	iTeclaAnterior = 0;
	m_grid.bFlagNegativo = false;
	iIdSituacion = 0;
	iCantidadCuentaMuebles = 0;
	//Descuento Moratorio
	iAplicoDescuento = 0;
	iMaxInteresValido = 0;
	prc_descuento = 0;
	imp_totaldescuento = 0;
	mostroMensajeMora = 0;
	idu_huellamora = 0;
	num_gerentemora = 0;

	memset(cFechaNacimiento, 0, 25);
	memset(cLocal, 0, 3);
	memset(cSexoCliente, 0, sizeof(cSexoCliente));
	memset(cPuntualidad, 0, sizeof(cPuntualidad));
	memset(cTipoEtp, 0, sizeof(cTipoEtp));
	memset(cClaveA, 0, 3);
	memset(cNombre, 0, 20);
	memset(cApellidoMaterno, 0, 20);
	memset(cApellidoPaterno, 0, 20);
	memset(cNombreBeneficiario1, 0, 20);
	memset(cApPatBeneficiario1, 0, 20);
	memset(cApMatBeneficiario1, 0, 20);
	memset(cNombreBeneficiario2, 0, 20);
	memset(cApPatBeneficiario2, 0, 20);
	memset(cApMatBeneficiario2, 0, 20);
	memset(cNombreBeneficiario3, 0, 20);
	memset(cApPatBeneficiario3, 0, 20);
	memset(cApMatBeneficiario3, 0, 20);
	memset(cNombreAsegurado, 0, 35);
	memset(cNombreConyuge, 0, 35);
	memset(cNombreBeneficiario4, 0, 20);
	memset(cApPatBeneficiario4, 0, 20);
	memset(cApMatBeneficiario4, 0, 20);
	memset(cTarjeta, 0, sizeof(cTarjeta));

	iTipoConvenio = iSubTipoConvenio = iPlazoConvenio = 0;
	memset(cFechaConvenio, 0, 10);
	lTotal30Dias = lTotalEdosCta = -3L;
	lClienteDlg = 0L;
	iIdSituacion = 0;
	iRegla = 0;
	iProceso = 0;
	memset(cSituacionEspecial, 0, sizeof(cSituacionEspecial));
	bTieneSitEsp = false;
	bAplicaAsteriscoSitEsp = false;

	memset(cEncabezado, 0, sizeof(cEncabezado));
	memset(cParrafo1, 0, sizeof(cParrafo1));
	memset(cParrafo2, 0, sizeof(cParrafo2));
	memset(cParrafo3, 0, sizeof(cParrafo3));
	memset(cParrafo4, 0, sizeof(cParrafo4));

	memset(cSituacioEspecial, 0, sizeof(cSituacioEspecial));
	memset(cJsonPost, 0, sizeof(cJsonPost));
	memset(cSituacionEspecialesMandar, 0, sizeof(cSituacionEspecialesMandar));
	memset(cEstCivil, 0, sizeof(cEstCivil));
	memset(cPlanSeguroClub, 0, sizeof(cPlanSeguroClub));
	iflg_candconvunico = iNumCandidatoUnico = iAbonoBaseTotalInicial = 0;
	lClienteLocalizar = 0;
	iConConvenio = iTipoCtaConv = 0;
	lVencidoFinalTicket = lSaldoCtaTicket = iContadorRegistros = 0;
	iImporteTotalConv = iAbonoBaseTotalConv = iImporteMinimoConv = 0;
	iImporteMinimoConv = iVencidoTotalConv = iTarjetaConv = iTotalAbonos = iTotalConvenio = imesesparaconvunico = iTotalConv = 0;
	ianio = imes = iTotalAbonoInte = 0;
	iFlagSorteoBoletoPremios = iRegla = iFlagContactoEfectivo = iFlagImpresionCuentasPerdidas = 0;
	iSeguroVigente = 0;
	lImporteAdicionalesNuevos = 0;
	iTestigo = 0;

	m_grid2.lTotalAbonos = 0L;
	iTipoConvenio = 0;
	iSubTipoConvenio = 0;
	m_cliente.SetFocus();
	memset(cNombre, 0, 20);
	memset(cApellidoPaterno, 0, 20);
	memset(cApellidoMaterno, 0, 20);
	iDiaNacimiento = iMesNacimiento = iAnioNacimiento = 0;
	iConyugal = 1;
	iFlagPago60Restructurado = 0;
	iRespuestaPoliza = 0;
	iSeguroVigente = 0;
	lImporteAdicionalesNuevos = 0;
	memset(cPlanSeguroClub, 0, sizeof(cPlanSeguroClub));
	iTotalCuentas = 0;
	m_grid.iTotalCuentas = 0;
	m_grid.iFlagConvenioRealizado = 0;

	memset(cConexion, 0, sizeof(cConexion));
	obtenerIduConexion();
	bTieneDatosEnTemporales = bBanderaTienePlan = bTieneVencidoPlan = bCandidatoSeguro = bCandidatoPSVenta = bCandidatoPSAbono = bSobrePasaEdadMaxima = bErrorProcesoPS = false;
	iDiasVencidosPS = iSumaAseguradaPlan = iCambiosDePlan = 0;

	m_grid2.RedrawAll();
	m_grid.RedrawAll();
	m_flecha.ShowWindow(false);
	m_grid.RedrawAll();
	iFoco = 0;
	asignarFoco();

	sFechaHoraInicioOperacion.Empty();

	//Se añade borrarPagoServicio.
	bPagodeServicios = false;
	if (iSistema == SISTEMA_CAJAS)
	{
		borrarPagoServicio();
	}

	m_asteriscocoppel.SetWindowText("");

	iCajaOriginal = 0;

	if (iSistema == SISTEMA_CLIENTES_NUEVOS || iSistema == SISTEMA_CAJAS)
	{
		if (iFlagRegistroPL > 0 && iFlagCampoInteligentePL > 0 && iSistema == SISTEMA_CAJAS)
		{
			ConsultarCatalogoMensajeTienda(TITULO_OPCION_REGISTRAR, cTexto);
			sprintf_s(cOpcionPL, "%.50s", cTexto);
			sprintf_s(cBarraOpciones, " [F11] DESLIZAR TARJETA    [ESC] CANCELAR    [CTRL+F9] %.50s", cOpcionPL);
		}
		else
		{
			sprintf_s(cBarraOpciones, " [F11] DESLIZAR TARJETA    [ESC] CANCELAR");
		}

		ponerMensajeNR(this, m_barra, m_mensaje1, cBarraOpciones);
		m_barra.ShowWindow(true);
	}
	else if (iSistema == SISTEMA_MUEBLES || iSistema == SISTEMA_ROPA)
	{
		iCajaOriginal = m_grid.iCaja;
		if (iSistema == SISTEMA_MUEBLES)
		{
			iCajaActual = 99;
		}
		else
		{
			iCajaActual = 98;
		}
		if (iFlagRegistroPL > 0 && iFlagCampoInteligentePL > 0
			&& !bProvieneDatos_OtraArea
			&& (iSistema == SISTEMA_MUEBLES || iSistema == SISTEMA_ROPA))
		{
			ConsultarCatalogoMensajeTienda(TITULO_OPCION_REGISTRAR, cTexto);
			sprintf_s(cOpcionPL, "%.50s", cTexto);
			sprintf_s(cBarraOpciones, " [F7] BUSQUEDA POR NOMBRE    [F11] DESLIZAR TARJETA    [CTRL+F9] %.50s    [ESC] CANCELAR", cOpcionPL);
		}
		else
		{
			sprintf_s(cBarraOpciones, " [F7] BUSQUEDA POR NOMBRE    [F11] DESLIZAR TARJETA    [ESC] CANCELAR");
		}
		ponerMensajeNR(this, m_barra, m_mensaje1, cBarraOpciones);
		m_barra.ShowWindow(true);
	}
	else
	{
		ponerMensajeNR(this, m_barra, m_mensaje1, "");
		m_barra.ShowWindow(false);
	}

	bFlagSalirXCaja = false;
	iFlagAbonoTA = 0;
	cerrarConexionBD(&odbc_1);

	iDiaUltimoPago = iDiaVencimientoCPS = iDiaVencimientoCPF = 1;
	iMesUltimoPago = iMesVencimientoCPS = iMesVencimientoCPF = 1;
	iAnioUltimoPago = iAnioVencimientoCPS = iAnioVencimientoCPF = 1900;

	memset(sFechaActivacion, 0, sizeof(sFechaActivacion));
	memset(sFechaVencimiento, 0, sizeof(sFechaVencimiento));
	memset(sFechaVencimientoAnterior, 0, sizeof(sFechaVencimientoAnterior));

	m_correo.SetWindowTextA("");
	m_correo.ShowWindow(false);
	m_lblCorreo.ShowWindow(false);
	m_celular.SetWindowTextA("");
	m_celular.ShowWindow(false);
	m_lblCelular.ShowWindow(false);
	memset(&sClientePL, 0, sizeof(CPlanDeLealtad::SDatosCliente));
	//valida si entra desde ropa o muebles para regresar con los datos del cliente PL en la venta.
	if ((iFlagCampoInteligentePL > 0 || iFlagRegistroPL > 0) &&
		(iSistema == SISTEMA_CAJAS || iSistema == SISTEMA_MUEBLES
		|| iSistema == SISTEMA_ROPA) && !bProvieneDatos_OtraArea)
	{
		objPlanDeLealtad->limpiarMovimiento();
	}

	//21749    
	this->iBiometrizadoCliente = VALIDACION_BIOMETRIZADA_INDEFINIDA;
	this->iBiometrizadoGerente = VALIDACION_BIOMETRIZADA_INDEFINIDA;
	this->iTipoCuestion = RESPUESTA_CUESTION_INDEFINIDA;
	this->iNumeroAdicional = 0;
	lFlagHuella = 0L;
	bCargaDatosSorteo = false;

	stCambioPlanes = nullptr;
}

int CDlgCapturarAbono::checarSituacionEspecial(int &iSituacion, short iCausaSituacion)
{
	char cLog[500] = { 0 };
	int iFlag = 0, iOpcion = -1;
	char cSql[110] = { 0 };

	sprintf_s(cLog, "FC0200805021521061 - entra - checarSituacionEspecial");
	grabarLog(cLog);

	sprintf_s(cSql, "SELECT cliente,situacionespecial,causasitesp,puntualidad FROM crcliente WHERE cliente = %09ld", m_grid.lCliente);
	lClienteLocalizar = m_grid.lCliente;
	CConsultarSituacionCrCliente consultarSituacionCrCliente(&odbc_1);

	iSituacion = 0;
	if (!consultarSituacionCrCliente.Exec(cSql))
	{
		//Se obtiene el error
		consultarSituacionCrCliente.odbc->GetLastError(consultarSituacionCrCliente.GetHstmt());
		grabarMensajeError("C", m_grid.iCaja, (LPTSTR)(LPCTSTR)m_grid.sServer, "CapturarAbono", "CDlgCapturarAbono", "checarSituacionEspecial", cSql, m_grid.lEmpleado, "ERROR EN LA CONSULTA (checarsituacionespecial)", consultarSituacionCrCliente.odbc, m_grid.iMuestraMsg);
		iFlag = 1;
	}
	else
	{
		consultarSituacionCrCliente.activarCols();
		if (consultarSituacionCrCliente.Leer())
		{
			if (strcmp(consultarSituacionCrCliente.puntualidad, "Z") == 0)
			{
				m_msgminimo3.SetWindowText("DIF. COBRO");
			}

			iProceso = CAPTURA_ABONO;
			iRegla = CLIENTE_ILOCALIZABLE;
			if (ValidarSituacionEspecial(m_grid.lCliente, iRegla, iProceso, 3))
			{
				iSituacion = iCausaSituacion;
			}
		}
	}
	sprintf_s(cLog, "FC0200805021521063 - fin - checarSituacionEspecial iFlag=%d", iFlag);
	grabarLog(cLog);
	return(iFlag);
}

int CDlgCapturarAbono::tiposDeEtp()
{
	int iTipoEtp = 0;
	bool bSalir = true;

	while (bSalir)
	{
		char * opciones[] = {
			"       F3      B   Futuras Cuentas Ropa                      ",
			"       F4      C   Cuentas No Localizadas Ropa               ",
			"       F5      D   Pagos Iniciales No Devueltos Ropa         ",
			"       F6      E   Efectivo Por Recuperación de Robo Ropa    ",
			"       F8      G   Futuras Compras Muebles                   ",
			"       F9      H   Cuentas No Localizadas Muebles            ",
			"       F10     I   Pagos Iniciales No Devueltos Muebles      ",
			"       CTRL_F1 J   Efectivo Por Recuperación de Robo muebles ",
			"       CTRL_F2 K   Estacionamiento                           ",
			"       Esc  Salir                                            ",
			"" };

		int respuesta[] = { F3,F4,F5,F6,F8,F9,F10,CTRL_F1,CTRL_F2,ESC,0 };

		C_Menu menu(" TIPOS DE ETP ", opciones, respuesta);

		switch (menu.OpcionSeleccionada())
		{
		case F3:
			{
				m_mensaje.SetWindowText("B   Futuras Cuentas Ropa                     ");
				iTipoEtp = 1;
				cTipoEtp[0] = 'B';
				bSalir = false;
			}
			break;
		case F4:
			{
				m_mensaje.SetWindowText("C   Cuentas No Localizadas Ropa              ");
				iTipoEtp = 2;
				cTipoEtp[0] = 'C';
				bSalir = false;
			}
			break;
		case F5:
			{
				m_mensaje.SetWindowText("D   Pagos Iniciales No Devueltos Ropa                     ");
				iTipoEtp = 3;
				cTipoEtp[0] = 'D';
				bSalir = false;
			}
			break;
		case F6:
			{
				m_mensaje.SetWindowText("E   Efectivo Por Recuperación de Robo Ropa                     ");
				iTipoEtp = 4;
				cTipoEtp[0] = 'E';
				bSalir = false;
			}
			break;
		case F8:
			{
				m_mensaje.SetWindowText("G   Futuras Compras Muebles                     ");
				iTipoEtp = 5;
				cTipoEtp[0] = 'G';
				bSalir = false;
			}
			break;
		case F9:
			{
				m_mensaje.SetWindowText("H   Cuentas No Localizadas Muebles                    ");
				iTipoEtp = 6;
				cTipoEtp[0] = 'H';
				bSalir = false;
			}
			break;
		case F10:
			{
				m_mensaje.SetWindowText("I   Pagos Iniciales No Devueltos Muebles                     ");
				iTipoEtp = 7;
				cTipoEtp[0] = 'I';
				bSalir = false;
			}
			break;
		case CTRL_F1:
			{
				m_mensaje.SetWindowText("J   Efectivo Por Recuperación de Robo Muebles                     ");
				iTipoEtp = 8;
				cTipoEtp[0] = 'J';
				bSalir = false;
			}
			break;
		case CTRL_F2:
			{
				m_mensaje.SetWindowText("K   Estacionamiento                     ");
				iTipoEtp = 9;
				cTipoEtp[0] = 'K';
				bSalir = false;
			}
			break;
		case ESC:
			bSalir = false;
			break;
		default:
			break;
		}
		cTipoEtp[1] = 0;
	}
	return iTipoEtp;
}
int CDlgCapturarAbono::calcularMorasCliente()
{
	char cLog[500] = { 0 };
	int i = 0, moraCliente = 0;
	CString sSaldaConX, sTexto, sFactura;
	char cTexto[30] = { 0 };
	char cFactura[15] = { 0 };
	long lBaseX = 0, lPagoX = 0, lVencidoX=0, lVencidoSI = 0,intAdicX = 0, vencidoTotal = 0, pagoTotal = 0, intAdicional = 0, baseTotal = 0, vencidoTotalCI = 0;
	double tempMora = 0;
	sprintf_s(cLog, "FC0200805648291409 - entra - calcularMorasCliente");
	grabarLog(cLog);
	char cMsg[1024] = { 0 };

	Json::Value obj(Json::objectValue);
	Json::Value cuentas(Json::arrayValue);
	Json::Value mensajes(Json::arrayValue);
	Json::Value msg;

	consultarMensaje(3547, cMsg);
	msg["mensaje"] = cMsg;
	msg["id"] = 3547;
	mensajes.append(msg);

	consultarMensaje(3548, cMsg);
	msg["mensaje"] = cMsg;
	msg["id"] = 3548;
	mensajes.append(msg);

	for (i = 0; i < iTotalCuentas; i++)
	{
		m_grid.QuickGetText(i, -1, &sTexto);
		sTexto.Trim();
		sprintf_s(cTexto, "%s", sTexto);

		if (memcmp(cTexto, "SEGURO", 6) != 0 && memcmp(cTexto, "P.FAMILIAR", 10) != 0 && memcmp(cTexto, "P.SALUD", 7) != 0 && memcmp(cTexto, "AUTO PROT.", 10) != 0)
		{
			m_grid.QuickGetText(i, 15, &sTexto);
			sTexto.Remove('.');
			sTexto.Remove(',');
			lVencidoX = atol(sTexto);

			if (lVencidoX > 0) 
			{
				CString sColumnNameFormat = "";
				sColumnNameFormat.Format("-%s-", cTexto);
				m_grid.sNoCuentaAConveniar += sColumnNameFormat; // Guardamos la cuenta detectada como vencida para desabilitar que se edite al cerrar pantalla de convenio

				m_grid.QuickGetText(i, 13, &sTexto);
				sTexto.Remove('.');
				sTexto.Remove(',');
				intAdicX = atol(sTexto);
				m_grid.QuickGetText(i, 21, &sTexto);
				sTexto.Remove('.');
				sTexto.Remove(',');
				lPagoX = atol(sTexto);
				m_grid.QuickGetText(i, 14, &sTexto);
				sTexto.Remove('.');
				sTexto.Remove(',');
				lBaseX = atol(sTexto);
				m_grid.QuickGetText(i, 1, &sTexto);
				sprintf_s(cFactura, "%s", (LPCTSTR)sTexto);

				intAdicX = lPagoX > intAdicX ? 0 : intAdicX - lPagoX; // Si PAGO > INTERÉS ADICIONAL INICIAL entonces INTERÉS ADICIONAL FINAL = 0 Si no INTERÉS ADICIONAL FINAL = INTERÉS ADICIONAL INICIAL - PAGO
				lVencidoSI = lVencidoX - lPagoX - intAdicX < 0 ? 0 : lVencidoX - lPagoX - intAdicX; //Si VENCIDO INICIAL - PAGO - INTERÉS ADICIONAL FINAL < 0 entonces VENCIDO SIN INTERÉS = 0 ----- Si no VENCIDO SIN INTERÉS = VENCIDO INICIAL - PAGO -INTERÉS ADICIONAL FINAL

				//sprintf_s(cLog, "subirDatosTablaTemporal - Descuento Interes cliente:%d, interes:%d, saldo:%d, vencido:%d,concepto:%s", m_grid.lCliente,lInteresAdicionalX,lSaldoX,lVencidoX,tmpCaGrabarAbono.conceptocuenta);
				//grabarLog(cLog);

				if (lVencidoSI > 0)
				{
					Json::Value cuenta;

					pagoTotal += lPagoX;
					intAdicional += intAdicX;
					vencidoTotal += lVencidoSI;
					baseTotal += lBaseX;
					vencidoTotalCI += lVencidoX-lPagoX;
					tempMora = static_cast<double>(lVencidoSI) / lBaseX;
					moraCliente = ceil(tempMora);

					cuenta["montoMax"] = lVencidoX-lPagoX;
					cuenta["mora"] = moraCliente;
					cuenta["cuenta"] = cTexto;
					cuenta["factura"] = cFactura;

					cuentas.append(cuenta);

					sprintf_s(cLog, "calcularMorasCliente - Cuenta: %s, Mora: %d, Vencido: %d, Base: %d, Interes: %d, Pago: %d", cTexto, moraCliente, lVencidoSI, lBaseX, intAdicX, lPagoX);
					grabarLog(cLog);
				}
			}
		}
	}
	baseTotal = baseTotal == 0 ? 1 : baseTotal;
	tempMora = static_cast<double>(vencidoTotal) / baseTotal;
	moraCliente = ceil(tempMora);

	sprintf_s(cLog, "calcularMorasCliente - MoraTotal: %d, VencidoTotal: %d, BaseTotal: %d", moraCliente, vencidoTotal, baseTotal);
	grabarLog(cLog);

	obj["vencido"] = vencidoTotalCI;
	obj["abonoBase"] = baseTotal;
	obj["plazoMaximo"] = getPlazoMaximo();
	obj["totalesCuenta"] = cuentas;
	obj["mensajes"] = mensajes;

	Json::StreamWriterBuilder writerBuilder;
	jsonConvenios = Json::writeString(writerBuilder, obj);

	return moraCliente;
}
int CDlgCapturarAbono::getTipoCuenta(char *cCuenta)
{
	int iTipo = 0;
	if (memcmp(cCuenta, "ROPA", 4) == 0 || memcmp(cCuenta, "T.AIRE", 6) == 0 || memcmp(cCuenta, "COMP ADC", 8) == 0)
	{
		if (memcmp(cCuenta, "T.AIRE", 6) == 0)
		{
			iTipo = 4;
		}
		else if (memcmp(cCuenta, "COMP ADC", 8) == 0)
		{
			iTipo = 6;
		}
		else
		{
			iTipo = 1;
		}
	}
	else
	{
		if (memcmp(cCuenta, "PRESTAMO", 8) == 0)
		{
			iTipo = 2;
		}
		else if (memcmp(cCuenta, "BANCOPPEL", 8) == 0 || VerificarCuentaBcpl(cCuenta, "SOLEX") == 1)
		{
			iTipo = 5;
		}
		else
		{
			iTipo = 3;
		}
	}
	return iTipo;
}
void CDlgCapturarAbono::registraConvenio()
{

}
void CDlgCapturarAbono::limpiarConvenios()
{
	char cLog[500] = { 0 };
	int i = 0, iFlag = 0, iTipoConvenio = 0, iDiaConvenio = 0, iMesConvenio = 0, iAnioVencCrSeguros = 0, iSubTipoConvenio = 0;
	CString sTexto, sAuxiliar;
	char cFechaConvenio[10] = { 0 };

	sprintf_s(cLog, "FC0200808739473628 - entra - limpiarConvenios");
	grabarLog(cLog);

	for (i = 0; i < iTotalCuentas; i++)
	{
		m_grid.QuickGetText(i, 7, &sTexto);
		sTexto.Trim();
		sprintf_s(cFechaConvenio, "%s", (LPCTSTR)sTexto);
		iMesConvenio = obtenerMes(cFechaConvenio);
		iDiaConvenio = valor_campo(&cFechaConvenio[0], 2);

		if (iDiaActual == iDiaConvenio && iMesActual == iMesConvenio)  
		{
			m_grid.QuickSetText(i, 7, "");
			m_grid.QuickSetAlignment(i, 7, UG_ALIGNCENTER);

			m_grid.QuickSetText(i, 8, "");
			m_grid.QuickSetAlignment(i, 8, UG_ALIGNRIGHT);

			m_grid.QuickSetText(i, 9, "");
			m_grid.QuickSetAlignment(i, 9, UG_ALIGNRIGHT);

			m_grid.QuickSetText(i, 10, "");
			m_grid.QuickSetAlignment(i, 10, UG_ALIGNRIGHT);

			m_grid.QuickSetText(i, 27, "");
			m_grid.QuickSetAlignment(i, 27, UG_ALIGNRIGHT);

			m_grid.QuickSetText(i, 28, "");
			m_grid.QuickSetAlignment(i, 28, UG_ALIGNRIGHT);

			m_grid.QuickSetText(i, 34, "");
			m_grid.QuickSetAlignment(i, 34, UG_ALIGNRIGHT);
		}
	}
}

void CDlgCapturarAbono::setJsonConvenios(std::string jsonString)
{
	char cLog[500] = { 0 };
	char cTexto[30] = { 0 };
	char cNom[30] = { 0 };
	char cFactura[15] = { 0 };
	int i = 0, j = 0, monto = 0, comNom = -1, comFac = -1, vencidoX = 0, vencido = 0, pagoX = 0;
	CString sTexto, sAux, sFecha, sFactura;
	string nom = "", factura = "";
	Json::Value obj;
	Json::Value cuentas;
	Json::Reader reader;
	CDlgCapturarConvenio dlgCapturarConvenio;
	sprintf_s(cLog, "FC020080567153809 - entra - setJsonConvenios");
	grabarLog(cLog);
	miniFecha(cTexto, iDiaActual, iMesActual, iAnioActual);
	sFecha.Format("%s", cTexto);

	limpiarConvenios();

	bool parsingSuccessful = reader.parse(jsonString, obj);
	cuentas = obj["totalesCuenta"];
	if (parsingSuccessful) {
		for (i = 0; i < iTotalCuentas; i++)
		{
			m_grid.QuickGetText(i, -1, &sTexto);
			sTexto.Trim();
			sprintf_s(cTexto, "%s", (LPCTSTR)sTexto);

			if (memcmp(cTexto, "SEGURO", 6) != 0 && memcmp(cTexto, "P.FAMILIAR", 10) != 0 && memcmp(cTexto, "P.SALUD", 7) != 0 && memcmp(cTexto, "AUTO PROT.", 10) != 0)
			{
				m_grid.QuickGetText(i, 1, &sFactura);
				sprintf_s(cFactura, "%s", (LPCTSTR)sFactura);
				m_grid.QuickGetText(i, 15, &sTexto);
				sTexto.Remove('.');
				sTexto.Remove(',');
				vencidoX = atol(sTexto);

				m_grid.QuickGetText(i, 21, &sTexto);
				sTexto.Remove('.');
				sTexto.Remove(',');
				pagoX = atol(sTexto);

				vencidoX = vencidoX - pagoX;

				int longi = cuentas.size();
				for (j = 0; j < longi; j++)
				{
					monto = cuentas[j]["monto"].asInt();
					factura = cuentas[j]["factura"].asString();
					nom = cuentas[j]["cuenta"].asString();
					sprintf_s(cNom, "%s", nom.c_str());
					vencido = cuentas[j]["montoMax"].asInt();

					comNom = nom.compare(cTexto);
					comFac = factura.compare(cFactura);

					if (monto == 0 || vencido != vencidoX)
					{
						continue;
					}
					if (comFac == 0 && factura != "")
					{
						m_grid.QuickSetText(i, 7, sFecha);
						m_grid.QuickSetAlignment(i, 7, UG_ALIGNCENTER);

						sAux.Format("%08ld", m_grid.lEmpleado);
						m_grid.QuickSetText(i, 8, sAux);
						m_grid.QuickSetAlignment(i, 8, UG_ALIGNRIGHT);

						sAux.Format("%d", obj["plazo"].asInt());
						m_grid.QuickSetText(i, 9, sAux);
						m_grid.QuickSetAlignment(i, 9, UG_ALIGNRIGHT);

						sAux.Format("%ld", cuentas[j]["monto"].asInt());
						m_grid.QuickSetText(i, 10, sAux);
						m_grid.QuickSetAlignment(i, 10, UG_ALIGNRIGHT);
						iFlagConvenioTerminado = 1;

						sAux.Format("%ld", 1);
						m_grid.QuickSetText(i, 27, sAux);
						m_grid.QuickSetAlignment(i, 27, UG_ALIGNRIGHT);

						sAux.Format("%d", 1);
						m_grid.QuickSetText(i, 28, sAux);
						m_grid.QuickSetAlignment(i, 28, UG_ALIGNRIGHT);

						sAux.Format("%ld", obj["subtipoConvenio"].asInt());
						m_grid.QuickSetText(i, 34, sAux);
						m_grid.QuickSetAlignment(i, 34, UG_ALIGNRIGHT);

						dlgCapturarConvenio.iTipo = getTipoCuenta(cTexto);
						dlgCapturarConvenio.iFlagCapturo = 1;
						dlgCapturarConvenio.lSaldoCuenta = atol(cTexto);
						dlgCapturarConvenio.lFactura = atol(sFactura);
						dlgCapturarConvenio.iDiaActual = iDiaActual;
						dlgCapturarConvenio.iMesActual = iMesActual;
						dlgCapturarConvenio.iAnioActual = iAnioActual;
						dlgCapturarConvenio.lCliente = m_grid.lCliente;
						dlgCapturarConvenio.iCaja = m_grid.iCaja;
						dlgCapturarConvenio.lEmpleado = m_grid.lEmpleado;
						dlgCapturarConvenio.iMuestraMsg = m_grid.iMuestraMsg;
						dlgCapturarConvenio.iTotalVencido = vencidoX;
						dlgCapturarConvenio.iTipoConvenio = 1;
						dlgCapturarConvenio.iSubTipoConvenio = obj["subtipoConvenio"].asInt();
						dlgCapturarConvenio.iPlazo = obj["plazo"].asInt();
						dlgCapturarConvenio.grabarConvenio();

						break;

					} else if (comNom == 0 && comFac == 0)
					{
						m_grid.QuickSetText(i, 7, sFecha);
						m_grid.QuickSetAlignment(i, 7, UG_ALIGNCENTER);

						sAux.Format("%08ld", m_grid.lEmpleado);
						m_grid.QuickSetText(i, 8, sAux);
						m_grid.QuickSetAlignment(i, 8, UG_ALIGNRIGHT);

						sAux.Format("%d", obj["plazo"].asInt());
						m_grid.QuickSetText(i, 9, sAux);
						m_grid.QuickSetAlignment(i, 9, UG_ALIGNRIGHT);

						sAux.Format("%ld", cuentas[j]["monto"].asInt() );
						m_grid.QuickSetText(i, 10, sAux);
						m_grid.QuickSetAlignment(i, 10, UG_ALIGNRIGHT);

						sAux.Format("%ld", 1);
						m_grid.QuickSetText(i, 27, sAux);
						m_grid.QuickSetAlignment(i, 27, UG_ALIGNRIGHT);

						sAux.Format("%d", 1);
						m_grid.QuickSetText(i, 28, sAux);
						m_grid.QuickSetAlignment(i, 28, UG_ALIGNRIGHT);

						sAux.Format("%ld", obj["subtipoConvenio"].asInt());
						m_grid.QuickSetText(i, 34, sAux);
						m_grid.QuickSetAlignment(i, 34, UG_ALIGNRIGHT);
						iFlagConvenioTerminado = 1;

						dlgCapturarConvenio.iTipo = getTipoCuenta(cTexto);
						dlgCapturarConvenio.iFlagCapturo = 1;
						dlgCapturarConvenio.lSaldoCuenta = atol(cTexto);
						dlgCapturarConvenio.lFactura = atol(sFactura);
						dlgCapturarConvenio.iDiaActual = iDiaActual;
						dlgCapturarConvenio.iMesActual = iMesActual;
						dlgCapturarConvenio.iAnioActual = iAnioActual;
						dlgCapturarConvenio.lCliente = m_grid.lCliente;
						dlgCapturarConvenio.iCaja = m_grid.iCaja;
						dlgCapturarConvenio.lEmpleado = m_grid.lEmpleado;
						dlgCapturarConvenio.iMuestraMsg = m_grid.iMuestraMsg;
						dlgCapturarConvenio.iTotalVencido = vencidoX;
						dlgCapturarConvenio.iTipoConvenio = 1;
						dlgCapturarConvenio.iSubTipoConvenio = obj["subtipoConvenio"].asInt();
						dlgCapturarConvenio.iPlazo = obj["plazo"].asInt();
						dlgCapturarConvenio.grabarConvenio();
						break;
					}
				}
			}
		}
		m_grid.RedrawAll();
		lImporteConvenios = obtenerTotalImporteConvenios();

		sAux.Format("%ld", lImporteConvenios);
		m_grid2.QuickSetText(0, 10, sAux);
		m_grid2.QuickSetAlignment(0, 10, UG_ALIGNRIGHT);
		m_grid2.RedrawAll();
	}
	sprintf_s(cLog, "FC020080567253809 - fin - setJsonConvenios");
	grabarLog(cLog);
}
void CDlgCapturarAbono::iniciarCapturaConvenio(std::string jsonString)
{
	char cLog[500] = { 0 };
	CString sRuta = "", sClaseConstructor = "", sMetodo = "", jsonRespuesta ="", json = "";
	CStringArray sArgsConstructor, sArgsMetodo;
	bool bFound = false;
	CFileFind finder;
	sRuta = "C:\\SYS\\PROGX\\CA\\CA0234.dll"; //Modulo
	sClaseConstructor = "CapturarConvenio.Views.FormCapturarConvenio"; //Clase con el constructor
	sMetodo = "LlamarPantallaCapturarConvenio"; //Metodo a invocar
	sArgsConstructor.Add("");
	json = jsonString.c_str();
	sArgsMetodo.Add(json);

	bFound = finder.FindFile(sRuta);

	if(bFound == true)
	{
		if( jsonRespuesta.IsEmpty() )
		{
			::CoInitialize(NULL);
			CCargaDllCSharp *objCargaDllConvenio = new CCargaDllCSharp();
			objCargaDllConvenio->CargarDllCSharp( sRuta, sClaseConstructor, METODO_STRING, sMetodo, sArgsConstructor, sArgsMetodo );
			objCargaDllConvenio->getRespuesta( jsonRespuesta );
			grabarLog("CDlgCapturarAbono Liberar --> objCargaDllConvenio 7069 Cambio Softtek");
			delete objCargaDllConvenio;
			grabarLog("CDlgCapturarAbono Se libera --> objCargaDllConvenio 7069 Cambio Softtek");
			::CoUninitialize();
			//sprintf_s(cLog, "JSON convenios %s", jsonRespuesta);
			//grabarLog(cLog);

			if (!jsonRespuesta.IsEmpty() && jsonRespuesta != "null" )
			{
				setJsonConvenios(static_cast<const char*>(CStringA(jsonRespuesta)));
				m_grid.iFlagConvenioRealizado = 1;
			}
		}
	}
}
int CDlgCapturarAbono::getPlazoMaximo() {
	int iPlazoMaximo = 0;
	CMaximo Cons(&odbc, false);
	char cSql[100] = { 0 };
	ObtenerMesAnio();
	if(sprintf_s(cSql, "SELECT num_plazomaximo FROM ctl_variablesparaconvenios WHERE anio=%d AND mes =%d LIMIT 1", ianio, imes) < 0){;}
	if (Cons.Exec(cSql))
	{
		Cons.activarCols();
		if (Cons.Leer())
		{
			iPlazoMaximo = (int)Cons.Total;
		}
	}
	return iPlazoMaximo;
}
int CDlgCapturarAbono::capturarConvenio()
{
	char cLog[500] = { 0 };
	int iColX = 0, iDiaConvenio = 0, iMesConvenio = 0, iAnioConvenio = 0, iPlazoConvenio = 0, iConvenioUnico = 0, iMesesVencidos = 0, moraCliente = 0, iVencido = 0, iPago = 0;
	int iFlagConvenios = 0;
	long lBaseX = 0L, lSaldoX = 0L, lVencidoX = 0L, lInteresesAdicionalesX = 0L;
	CString sVencidoX, sBaseX, sInteresAdicionalX;
	bool bSalir = true;	
	CString sSaldoX, sFactura, sConcepto, sDato, sVencido, sPago;
	char cTexto[20] = { 0 }, cDescripcion[20] = { 0 };
	CUGCell m_cell;
	CDlgCapturarConvenio dlgCapturarConvenio;
	bConvenioUnicoCandidato = false;
	iConvenioUnico = 0;
	sprintf_s(cLog, "FC0200805021521069 - entra - capturarConvenio");
	grabarLog(cLog);

	iColX = m_grid.GetCurrentCol(); //obtener la columna donde esta posicionado

	m_grid.QuickGetText(iColX, 15, &sVencido);
	sVencido.Remove('.');
	sVencido.Remove(',');
	iVencido = atol(sVencido);

	m_grid.QuickGetText(iColX, 21, &sPago);
	sPago.Remove('.');
	sPago.Remove(',');
	iPago = atol(sPago);
	obtenerFlag('C', FLAGC_NUEVA_PANTALLA_CONVENIOS_LEGADO, iFlagConvenios);

	if (iFlagConvenios == 1)
	{
		if (iPago >= iVencido)
		{
			return 0;
		}

		char cMensajeConvenio[1024];
		consultarMensaje(3543, cMensajeConvenio);
		int iRes = MessageBox(cMensajeConvenio, "COPPEL", MB_YESNO);
		if (iRes == IDYES)
		{
			moraCliente = calcularMorasCliente();
		} else if (iRes == IDNO)
		{
			bSalir = false;
		}
	}

	m_grid.QuickGetText(iColX, 12, &sSaldoX);
	sSaldoX.Remove('.');
	sSaldoX.Remove(',');
	sprintf_s(cTexto, "%s", (LPCTSTR)sSaldoX);
	m_grid.QuickGetText(iColX, 1, &sFactura);

	/*
	if (memcmp(cDescripcion, "ROPA", 4) == 0 || memcmp(cDescripcion, "T.AIRE", 6) == 0 || memcmp(cDescripcion, "COMP ADC", 8) == 0)
	{
	if (memcmp(cDescripcion, "T.AIRE", 6) == 0)
	{
	dlgCapturarConvenio.iTipo = 4;
	}
	else if (memcmp(cDescripcion, "COMP ADC", 8) == 0)
	{
	dlgCapturarConvenio.iTipo = 6;
	}
	else
	{
	dlgCapturarConvenio.iTipo = 1;
	}
	}
	else
	{
	if (memcmp(cDescripcion, "PRESTAMO", 8) == 0)
	{
	dlgCapturarConvenio.iTipo = 2;
	}
	else if (memcmp(cDescripcion, "BANCOPPEL", 8) == 0 || VerificarCuentaBcpl(cDescripcion, "SOLEX") == 1)
	{
	dlgCapturarConvenio.iTipo = 5;
	}
	else
	{
	dlgCapturarConvenio.iTipo = 3;
	}
	} 
	*/
	m_grid.QuickGetText(iColX, -1, &sConcepto);
	sConcepto.Trim();
	sprintf_s(cDescripcion, "%s", (LPCTSTR)sConcepto);
	dlgCapturarConvenio.iTipo = getTipoCuenta(cDescripcion);

	dlgCapturarConvenio.iFlagCapturo = 0;
	dlgCapturarConvenio.lSaldoCuenta = atol(cTexto);
	dlgCapturarConvenio.lFactura = atol(sFactura);
	dlgCapturarConvenio.iDiaActual = iDiaActual;
	dlgCapturarConvenio.iMesActual = iMesActual;
	dlgCapturarConvenio.iAnioActual = iAnioActual;
	dlgCapturarConvenio.lCliente = m_grid.lCliente;
	dlgCapturarConvenio.iCaja = m_grid.iCaja;
	dlgCapturarConvenio.lEmpleado = m_grid.lEmpleado;
	dlgCapturarConvenio.iMuestraMsg = m_grid.iMuestraMsg;

	m_grid.QuickGetText(iColX, 13, &sInteresAdicionalX);
	sInteresAdicionalX.Remove('.');
	sInteresAdicionalX.Remove(',');
	lInteresesAdicionalesX = atoi(sInteresAdicionalX);
	m_grid.QuickGetText(iColX, 14, &sBaseX);
	sBaseX.Remove('.');
	sBaseX.Remove(',');
	lBaseX = atoi(sBaseX);
	m_grid.QuickGetText(iColX, 15, &sVencidoX);
	sVencidoX.Remove('.');
	sVencidoX.Remove(',');
	lVencidoX = atoi(sVencidoX);
	dlgCapturarConvenio.iTotalVencido = lVencidoX;
	iMesesVencidos = (lVencidoX - lInteresesAdicionalesX) / lBaseX;


	if (iFlagConvenios == 1) 
	{
		if (moraCliente > 2) {
			while (bSalir)
			{
				char * opciones[] = {
					"       F2      Convenio Unico             ",
					"       Esc     Salir                      ",
					"" };

				int respuesta[] = { F2,ESC,0 };

				C_Menu menu(" CAPTURA DE CONVENIO ", opciones, respuesta);

				switch (menu.OpcionSeleccionada())
				{
				case F2:
					{
						iTipoConvenio = 1;
						iSubTipoConvenio = 2;
						bSalir = false;
						jsonConvenios.insert(1,"subtipoConvenio:2,");
						iniciarCapturaConvenio(jsonConvenios);
					}
					break;
				case ESC:
					bSalir = false;
					break;
				default:
					break;
				}
			}
		} else
		{
			while (bSalir)
			{
				char * opciones[] = {
					"       F1      Compromiso de pago         ",
					"       F2      Convenio Unico             ",
					"       Esc     Salir                      ",
					"" };

				int respuesta[] = { F1,F2,ESC,0 };

				C_Menu menu(" CAPTURA DE CONVENIO ", opciones, respuesta);

				switch (menu.OpcionSeleccionada())
				{
				case F1:
					{
						iTipoConvenio = 1;
						iSubTipoConvenio = 1;
						jsonConvenios.insert(1,"subtipoConvenio:1,");
						iniciarCapturaConvenio(jsonConvenios);
						bSalir = false;
					}
					break;
				case F2:
					{
						iTipoConvenio = 1;
						iSubTipoConvenio = 2;
						jsonConvenios.insert(1,"subtipoConvenio:2,");
						iniciarCapturaConvenio(jsonConvenios);
						bSalir = false;
					}
					break;
				case ESC:
					bSalir = false;
					break;
				default:
					break;
				}
			}
		}
	} else
	{
		while (bSalir)
		{
			char * opciones[] = {
				"       F1      Compromiso de pago         ",
				"       F2      Convenio Unico             ",
				"       Esc     Salir                      ",
				"" };

			int respuesta[] = { F1,F2,ESC,0 };

			C_Menu menu(" CAPTURA DE CONVENIO ", opciones, respuesta);

			switch (menu.OpcionSeleccionada())
			{
			case F1:
				{
					iTipoConvenio = 1;
					iSubTipoConvenio = 1;
					dlgCapturarConvenio.iTipoConvenio = iTipoConvenio;
					dlgCapturarConvenio.iSubTipoConvenio = iSubTipoConvenio;
					dlgCapturarConvenio.DoModal();
					bSalir = false;
				}
				break;
			case F2:
				{
					iTipoConvenio = 1;
					iSubTipoConvenio = 2;
					dlgCapturarConvenio.iTipoConvenio = iTipoConvenio;
					dlgCapturarConvenio.iSubTipoConvenio = iSubTipoConvenio;
					dlgCapturarConvenio.DoModal();
					bSalir = false;
				}
				break;
			case ESC:
				bSalir = false;
				break;
			default:
				break;
			}
		}
	}
	if (dlgCapturarConvenio.iFlagCapturo == 1) //si capturaron convenio a la cuenta
	{
		miniFecha(cTexto, iDiaActual, iMesActual, iAnioActual);
		sDato.Format("%s", cTexto);
		m_grid.QuickSetText(iColX, 7, sDato);
		m_grid.QuickSetAlignment(iColX, 7, UG_ALIGNCENTER);

		sDato.Format("%08ld", dlgCapturarConvenio.lEmpleado);
		m_grid.QuickSetText(iColX, 8, sDato);
		m_grid.QuickSetAlignment(iColX, 8, UG_ALIGNRIGHT);

		sDato.Format("%d", dlgCapturarConvenio.iPlazo);
		m_grid.QuickSetText(iColX, 9, sDato);
		m_grid.QuickSetAlignment(iColX, 9, UG_ALIGNRIGHT);

		sDato.Format("%ld", dlgCapturarConvenio.lImporte);
		m_grid.QuickSetText(iColX, 10, sDato);
		m_grid.QuickSetAlignment(iColX, 10, UG_ALIGNRIGHT);
		iFlagConvenioTerminado = 1;


		sDato.Format("%ld", dlgCapturarConvenio.iTipoConvenio);
		m_grid.QuickSetText(iColX, 27, sDato);
		m_grid.QuickSetAlignment(iColX, 27, UG_ALIGNRIGHT);

		sDato.Format("%d", 1);
		m_grid.QuickSetText(iColX, 28, sDato);
		m_grid.QuickSetAlignment(iColX, 28, UG_ALIGNRIGHT);

		sDato.Format("%ld", dlgCapturarConvenio.iSubTipoConvenio);
		m_grid.QuickSetText(iColX, 34, sDato);
		m_grid.QuickSetAlignment(iColX, 34, UG_ALIGNRIGHT);


		m_grid.RedrawAll();
		lImporteConvenios = obtenerTotalImporteConvenios();

		sDato.Format("%ld", lImporteConvenios);
		m_grid2.QuickSetText(0, 10, sDato);
		m_grid2.QuickSetAlignment(0, 10, UG_ALIGNRIGHT);
		m_grid2.RedrawAll();
	}
	asignarFoco();
	return iTipoConvenio;
}
bool CDlgCapturarAbono::ObtenerMesAnio()
{

	char cSql[100] = { 0 };
	ConsultarMesAnio DatosFecha(&odbc);
	bool bconti = true;
	ianio = imes = 0;

	sprintf_s(cSql, "SELECT num_anio,num_mes FROM fun_regresadatosretailestadisticas((SELECT fecha FROM gndominio))");

	if (DatosFecha.Exec(cSql))
	{
		DatosFecha.activarCols();
		while (DatosFecha.Leer())
		{
			ianio = (int)DatosFecha.anio;//anio
			imes = (int)DatosFecha.mes;//anio
		}
	}
	else
	{
		DatosFecha.odbc->GetLastError(DatosFecha.GetHstmt());
		grabarMensajeError("C", m_grid.iCaja, (LPTSTR)(LPCTSTR)m_grid.sServer, "CapturarAbono", "CDlgCapturarAbono", "ObtenerMesAnio", cSql, m_grid.lEmpleado, "ERROR EN LA CONSULTA", DatosFecha.odbc, m_grid.iMuestraMsg);
	}
	return bconti;
}

void CDlgCapturarAbono::capturarDatosSeguro()
{
	char cLog[500] = { 0 };
	bool bIndividual = false, bConyugal = false;
	CString sTexto;
	long lFolioSeguroi = 0L, lFolioSeguroc = 0;
	int iColX = 0, iAnioVencimiento = 0;
	char cFechaVencimiento[10] = { 0 }, cDescripcion[20] = { 0 }, cTipo[12] = { 0 }, cPrecio[5] = { 0 }, cMensajeSeguimiento[50] = { 0 };
	char cStatusSeguro = ' ', cTipoCan = ' ', cClaveNoOfrecer = ' ';
	CDlgCapturarDatosSeguro dlgCapturarDatosSeguro;

	sprintf_s(cLog, "FC0200805021521077 - entra - capturarDatosSeguro");
	grabarLog(cLog);

	dlgCapturarDatosSeguro.iOrigenSeguro = obtenerOrigenSeguro();
	dlgCapturarDatosSeguro.iEdadMaximaClub = iEdadMaximaClub;
	dlgCapturarDatosSeguro.iEdadMaximaClubAdicional = iEdadMaximaClubAdicional;
	dlgCapturarDatosSeguro.iEdadMinimaClub = iEdadMinimaClub;
	dlgCapturarDatosSeguro.iEdadMaximaAbonoClub = iEdadMaximaAbonoClub;
	dlgCapturarDatosSeguro.iEdadMaximaAbonoClubAdic = iEdadMaximaAbonoClubAdic;
	dlgCapturarDatosSeguro.iFlagCapturaBeneficiario = iFlagCapturaBeneficiario;
	dlgCapturarDatosSeguro.iFlagSeguroAdicional = iFlagSeguroAdicional;
	dlgCapturarDatosSeguro.iEdadCliente = iEdadCliente;
	dlgCapturarDatosSeguro.iSegurosAdicionales = iSegurosAdicionales + iSegurosAdicionalesNuevos;
	m_puntualidad2.GetWindowText(sTexto);
	grabarLog("capturarDatosSeguro: cargar seguro");
	if (sTexto.Trim() == "Z")
		dlgCapturarDatosSeguro.iPuntualidad = 1;

	iColX = m_grid.GetCurrentCol(); //obtener la columna donde esta posicionado
	/*m_grid.QuickGetText(iColX,1, &sTexto);
	lFactura = atol( sTexto );*/
	sprintf_s(cMensajeSeguimiento, "Metodo TieneSeguroClub 3");
	grabarLog(cMensajeSeguimiento);

	bIndividual = tieneSeguroClub(cStatusSeguro, cTipoCan, cClaveNoOfrecer, lFolioSeguroi, bCteSeguro);
	if (bIndividual && iFoliosSegurosActual[0] == lFolioSeguroi)
	{
		bBanderaSeguroVigente = true;
		iConyugal = 1;
	}

	if (cStatusSeguro == 'P')
	{
		AfxMessageBox(cMensajeSeguro);
		return;
	}

	m_grid.QuickGetText(iColX, 29, &sTexto);
	if (atoi(sTexto) == 1)
	{
		bBanderaSeguroVigente = true;
	}
	else
	{
		bBanderaSeguroVigente = false;
	}
	sprintf_s(cMensajeSeguimiento, "Metodo TieneSeguroClubConyugal 3");
	grabarLog(cMensajeSeguimiento);
	bConyugal = tieneSeguroClubConyugal(cStatusSeguro, cTipoCan, cClaveNoOfrecer, lFolioSeguroc);

	m_grid.QuickGetText(iColX, 3, &sTexto);
	sTexto.Trim();
	sprintf_s(cTipo, "%s", (LPCTSTR)sTexto);
	if (memcmp(cTipo, "AL CLUB", 7) == 0)
	{
		iConyugal = 1;
	}

	m_grid.QuickGetText(iColX, 25, &sTexto);
	sTexto.Trim();
	sprintf_s(cFechaVencimiento, "%s", (LPCTSTR)sTexto);
	iAnioVencimiento = valor_campo(&cFechaVencimiento[4], 4);
	dlgCapturarDatosSeguro.bBanderaTieneClub = bBanderaTieneClub;
	dlgCapturarDatosSeguro.iMesVencimiento = valor_campo(&cFechaVencimiento[2], 2);
	dlgCapturarDatosSeguro.iAnioVencimiento = iAnioVencimiento;
	dlgCapturarDatosSeguro.iDiaVencimiento = valor_campo(&cFechaVencimiento[0], 2);
	dlgCapturarDatosSeguro.lCliente = m_grid.lCliente;
	m_grid.QuickGetText(iColX, -1, &sTexto);
	sTexto.Trim();
	sprintf_s(cDescripcion, "%s", (LPCTSTR)sTexto);

	dlgCapturarDatosSeguro.iDiaNacimiento = iDiaNacimiento;
	dlgCapturarDatosSeguro.iMesNacimiento = iMesNacimiento;
	dlgCapturarDatosSeguro.iAnioNacimiento = iAnioNacimiento;
	dlgCapturarDatosSeguro.iAnioActual = iAnioActual;
	dlgCapturarDatosSeguro.iMesActual = iMesActual;
	dlgCapturarDatosSeguro.iDiaActual = iDiaActual;
	dlgCapturarDatosSeguro.iFlagBanorte = iFlagBanorte;
	if (memcmp(cDescripcion, "P.FAMILIAR", 10) == 0) // para saber si es seguro club
	{
		dlgCapturarDatosSeguro.iEsSeguroClub = iConyugal;
	}
	else
	{
		dlgCapturarDatosSeguro.iEsSeguroClub = 0;
	}
	m_grid.QuickGetText(iColX, 22, &sTexto);
	sTexto.Trim();
	dlgCapturarDatosSeguro.iNumSeguros = atol(sTexto);

	m_grid.QuickGetText(iColX, 12, &sTexto);
	sTexto.Replace("SEGS", "");
	sTexto.Trim();
	dlgCapturarDatosSeguro.iNumSegurosNuevo = atol(sTexto);


	m_grid.QuickGetText(iColX, 31, &sTexto);
	sTexto.Trim();
	dlgCapturarDatosSeguro.iNumeroSegurosAnterior = atol(sTexto);
	if (dlgCapturarDatosSeguro.iNumeroSegurosAnterior == 0)
	{
		dlgCapturarDatosSeguro.iNumeroSegurosAnterior = 1;
	}
	m_grid.QuickGetText(iColX, 23, &sTexto);
	sTexto.Trim();
	dlgCapturarDatosSeguro.iNumeroMeses = atol(sTexto);
	sprintf_s(dlgCapturarDatosSeguro.cIPServidorTiendaNumero, (LPCTSTR)m_grid.sServer);
	dlgCapturarDatosSeguro.iTienda = m_grid.iTienda;
	dlgCapturarDatosSeguro.iCaja = m_grid.iCaja;
	dlgCapturarDatosSeguro.lEmpleado = m_grid.lEmpleado;
	dlgCapturarDatosSeguro.iMuestraMsg = m_grid.iMuestraMsg;
	dlgCapturarDatosSeguro.iFlagBanorte = iFlagBanorte;
	dlgCapturarDatosSeguro.bBanderaSeguroVigente = bBanderaSeguroVigente;

	dlgCapturarDatosSeguro.iFlagCancelo = iFlagDatosSeguro;
	dlgCapturarDatosSeguro.iCiudad = iCiudadGnDominio;
	dlgCapturarDatosSeguro.iSistema = iSistema;
	if (iConyugal == 1 && memcmp(cTipo, "AL CLUB", 7) == 0 && iFlagCapturoBeneficiariosClubNuevo != 0)
	{
		m_grid.QuickGetText(iColX + 1, 21, &sTexto);
		sTexto.Trim();
		sprintf_s(cPrecio, "%s", (LPCTSTR)sTexto);
	}
	{
		dlgCapturarDatosSeguro.iColumnaClub = iColumnaClub;
		dlgCapturarDatosSeguro.iColumnaClubActual = iColX;
		sprintf_s(dlgCapturarDatosSeguro.cNombreCliente, "%s %s %s", (LPCTSTR)sNombreCliente.Trim(), (LPCTSTR)sApellidoPaterno.Trim(), (LPCTSTR)sApellidoMaterno.Trim());
		dlgCapturarDatosSeguro.cSexo[0] = cSexo;
		dlgCapturarDatosSeguro.lFolioSeguro = iFoliosSegurosActual[0];
		dlgCapturarDatosSeguro.DoModal();

		iFlagDatosSeguro = dlgCapturarDatosSeguro.iFlagCancelo;

		if (iFlagDatosSeguro == 1 && dlgCapturarDatosSeguro.bAutorizado)
		{
			//if (dlgCapturarDatosSeguro.iProcesoBeneficiariosAdicionales == 1)
			{
				if (memcmp(cDescripcion, "P.FAMILIAR", 10) == 0) //9923 --> pasar datos de cambio de folio
				{
					iFlagCapturoBeneficiariosClubNuevo = dlgCapturarDatosSeguro.iFlagCapturoBeneficiariosClubNuevo;
				}

				//sTexto.Format("%d", iFoliosSegurosActual[0] );
				if (dlgCapturarDatosSeguro.iNumSeguros > 0 && dlgCapturarDatosSeguro.iNumeroSegurosAnterior > 0 && dlgCapturarDatosSeguro.iNumSeguros != dlgCapturarDatosSeguro.iNumeroSegurosAnterior)//Realizó un cambio de plan
				{
					if (dlgCapturarDatosSeguro.lFolioSeguroNuevo != 0)
					{
						sTexto.Format("%ld", dlgCapturarDatosSeguro.lFolioSeguroNuevo);
						m_grid.QuickSetText(iColumnaClub, 1, sTexto);
						m_grid.QuickSetAlignment(iColumnaClub, 1, UG_ALIGNRIGHT);

						sTexto.Format("%d", 1); //seguro vigente
						m_grid.QuickSetText(iColumnaClub, 29, sTexto);
						m_grid.QuickSetAlignment(iColumnaClub, 29, UG_ALIGNRIGHT);
						iSeguroVigente = 1;
					}
				}
				else if (dlgCapturarDatosSeguro.lFolioSeguroNuevo == 0 && iFlagCapturoBeneficiariosClubNuevo == 0)
				{
					sTexto.Format("%ld", iFoliosSegurosActual[0]);
					m_grid.QuickSetText(iColumnaClub, 1, sTexto);
					m_grid.QuickSetAlignment(iColumnaClub, 1, UG_ALIGNRIGHT);
				}

				//sTexto.Format(" SEGS   %ld", dlgCapturarDatosSeguro.iNumSeguros );
				sTexto.Format("%s", cPlanSeguroClub);
				m_grid.QuickSetText(iColX, 12, sTexto);
				m_grid.QuickSetAlignment(iColX, 12, UG_ALIGNCENTER);

				sTexto.Format("# MESES %d", dlgCapturarDatosSeguro.iNumeroMeses);
				m_grid.QuickSetText(iColX, 13, sTexto);
				m_grid.QuickSetAlignment(iColX, 13, UG_ALIGNCENTER);

				sTexto.Format("%d", dlgCapturarDatosSeguro.iNumSeguros);
				m_grid.QuickSetText(iColX, 22, sTexto);
				m_grid.QuickSetAlignment(iColX, 22, UG_ALIGNCENTER);

				sTexto.Format("%d", dlgCapturarDatosSeguro.iNumeroMeses);
				m_grid.QuickSetText(iColX, 23, sTexto);
				m_grid.QuickSetAlignment(iColX, 23, UG_ALIGNCENTER);

				m_grid.RedrawAll();

				desplegarPaginaSeguros(0, 0, iColX, dlgCapturarDatosSeguro, 0);

				if (dlgCapturarDatosSeguro.iRespondio == 1)
				{
					ventaClubProteccionAdicional();
				}
			}
		}
		else
		{
			if ((iFlagTieneSeguroAdicional == 1 || iFlagCapturoSeguroAdicional == 1) && dlgCapturarDatosSeguro.iNumeroMeses != 0)
			{
				iFlagDatosSeguro = 1;
				desplegarPaginaSeguros(0, 0, iColX, dlgCapturarDatosSeguro, 0);
				iFlagDatosSeguro = 0;
			}
		}
	}
	iRespuestaPoliza = dlgCapturarDatosSeguro.iRespuesta;
}

void CDlgCapturarAbono::capturarDatosSeguroMotos(int iColX){
	cuentasSeguros.m_grid = &m_grid;
	cuentasSeguros.iCol = iColX;
	cuentasSeguros.iCiudad = iCiudadGnDominio;
	cuentasSeguros.sNombreCliente = sNombreCliente;
	cuentasSeguros.sApellidoPaterno = sApellidoPaterno;
	cuentasSeguros.sApellidoMaterno = sApellidoMaterno;
	memcpy(cuentasSeguros.cIpServidorCartera, cIpServidorCartera, 20);
	cuentasSeguros.cSexo = cSexo;

	cuentasSeguros.capturarAbonoSeguroMoto();
	grabarLog("capturarDatosSeguroMotos");
}

void CDlgCapturarAbono::capturarDatosSeguroCelulares(int iColX){
	grabarLog("CDlgCapturarAbono::capturarDatosSeguroCelulares -> Inicia captura meses");
	cuentasSeguros.m_grid = &m_grid;
	cuentasSeguros.iCol = iColX;
	cuentasSeguros.iCiudad = iCiudadGnDominio;
	cuentasSeguros.sNombreCliente = sNombreCliente;
	cuentasSeguros.sApellidoPaterno = sApellidoPaterno;
	cuentasSeguros.sApellidoMaterno = sApellidoMaterno;
	memcpy(cuentasSeguros.cIpServidorCartera, cIpServidorCartera, 20);
	cuentasSeguros.cSexo = cSexo;
	cuentasSeguros.capturarAbonoSeguroCelulares();
	grabarLog("CDlgCapturarAbono::capturarDatosSeguroCelulares -> Finaliza captura meses");
}

bool CDlgCapturarAbono::grabarAbonoSegurosCacarmov(){
	bool regresa = false;
	if( flagCuentasSeguros ==  1 )
	{
		cuentasSeguros.lNumeroRecibo = lNumeroRecibo;
		grabarLog("grabarAbonoSegurosCacarmov()");
		regresa = cuentasSeguros.grabarSegurosCacarmov();
	} else {
		regresa = true;
	}
	return regresa;
}

bool CDlgCapturarAbono::grabarAbonoSegurosCarmovX(){
	bool regresa = false;
	if( flagCuentasSeguros ==  1 )
	{
		cuentasSeguros.lNumeroRecibo = lNumeroRecibo;
		grabarLog("grabarAbonoSegurosCarmovX()");
		regresa = cuentasSeguros.grabarSegurosCarmovX();
	}
	else 
	{
		regresa = true;
	}
	return regresa;
}

bool CDlgCapturarAbono::imprimirPolizaSeguroClub(int iCont, int iConyugal)
{
	char cLog[500] = { 0 };
	char cNombreCompleto[48] = { 0 }, cTexto[80] = { 0 }, cValorParentesco[5] = { 0 };
	int iInicio = 0, iCantidadSeguros = 0, iCol = 1, iRen = 0, iEdad = 0, iNumSeguros = 0;
	long lMontoClub = 0L;
	bool valorRegresa = false, bContinuar = true;

	char cTextoOut[256] = { 0 }, cDirectorio[80] = { 0 }, cConsulta[600] = { 0 }, cNombreCalle[35], cNombreZona[35];
	CString sDato = "";

	sprintf_s(cLog, "FC0200805021521082 - entra - imprimirPolizaSeguroClub");
	grabarLog(cLog);

	memset(cNombre, 0, 20);
	memset(cApellidoMaterno, 0, 20);
	memset(cApellidoPaterno, 0, 20);

	memset(cNombrec, 0, 20);
	memset(cApMaternoc, 0, 20);
	memset(cApPaternoc, 0, 20);

	//Activar
	sprintf_s(cDirectorio, "c:\\sys\\mem\\PolizaClub.PRN");
	_unlink(cDirectorio);
	C_FormasPCL hoja(22, 270, cDirectorio, iFinLinea, iTipoImpresora, 1);

	if (imprimirClausulaClub(hoja, iConyugal, iRespuestaPoliza))
	{
		if (obtenerNombreFechaNacimientoCliente())
		{
			unionNombrex(cApellidoPaterno, cNombreCompleto, iInicio, 15);
			cNombreCompleto[iInicio] = ' ';
			iInicio++;
			unionNombrex(cApellidoMaterno, cNombreCompleto, iInicio, 15);
			cNombreCompleto[iInicio] = ' ';
			iInicio++;
			unionNombrex(cNombre, cNombreCompleto, iInicio, 15);
			cNombreCompleto[40] = 0;
		}

		obtenerDatosBeneficiarios(iConyugal);        //Funcion Local se obtienen los beneficiarios.

		iCantidadSeguros = obtenerNumeroSeguros(); //se obtienen seguros en caso de que tenga seguro!!

		iniciarHoja(hoja);
		iRen = 3;
		memset(cTexto, 0, 80);
		hoja.poner("Nombre del contratante: COPPEL S.A. DE C.V.", iRen, iCol);
		iRen++;
		sprintf_s(cTexto, "Núm.de póliza: %s %s", cPoliza, cFechaVigencia);
		hoja.poner(cTexto, iRen, iCol);
		iRen++;

		miniFecha(cTexto, iDiaActual, iMesActual, iAnioActual);

		memset(cTexto, 0, 80);
		obtenerMes(iMesActual, cNomMes);

		sprintf_s(cTexto, "Vigencia:%02d/%s/%02d al     /   /     ", iDiaActual, cNomMes, iAnioActual);
		hoja.poner(cTexto, iRen, iCol);
		iRen++;
		memset(cConsulta, 0, sizeof(cConsulta));
		sprintf_s(cConsulta, "SELECT catMod.idu_modulopolizaclub, catMsg.idu_mensajepolizaclub, catMsg.desc_mensaje"
			" FROM cat_modulospolizaclub catMod"
			" INNER JOIN cat_mensajespolizaclub catMsg ON catMod.idu_modulopolizaclub = catMsg.idu_modulopolizaclub"
			" AND catMod.idu_tipoImpresion = catMsg.idu_tipoImpresion AND catMod.nom_area = catMsg.nom_area"
			" WHERE catMod.idu_modulopolizaclub IN (%d) AND catMod.idu_tipoImpresion = %d AND catMod.nom_area = 'C'"
			" ORDER BY catMod.idu_modulopolizaclub ASC, catMsg.idu_mensajepolizaclub ASC;", SECCION_6, MATRICIAL);

		CConsultarDescripcionClub ConsultaDescImpresion(&odbc);

		if (ConsultaDescImpresion.Exec(cConsulta))
		{
			ConsultaDescImpresion.activarCols();
			while (ConsultaDescImpresion.leer())
			{
				memset(cTextoOut, 0, sizeof(cTextoOut));
				sDato.Format("%s", ConsultaDescImpresion.desc_mensaje);
				sDato.Trim();
				sDato.Replace('¿', '¨');
				sprintf_s(cTextoOut, "%s", (LPCTSTR)sDato);
				ponerAcento(cTextoOut);
				hoja.poner(cTextoOut, iRen, iCol);
				iRen++;
				bContinuar = true;
			}
		}
		else
		{
			ConsultaDescImpresion.odbc->GetLastError(ConsultaDescImpresion.GetHstmt());
			grabarMensajeError("C", m_grid.iCaja, (LPTSTR)(LPCTSTR)m_grid.sServer, "CA0030", "CDlgCapturarAbono", "imprimirNotaImportante", cConsulta, m_grid.lEmpleado, "ERROR AL OBTENER IMPRESION", ConsultaDescImpresion.odbc, m_grid.iMuestraMsg);
			bContinuar = false;
		}
		if (bContinuar)
		{
			if (iConyugal == 1)
			{
				hoja.poner("Datos del asegurado:", iRen, iCol);
				iRen = iRen + 2;

				hoja.poner("Ap.Pat.       Ap.Mat.       Nombre(s)", 8, iCol);
				sprintf_s(cTexto, "%s", cApellidoPaterno);
				cTexto[16] = 0;
				hoja.poner(cTexto, 15, iRen, iCol);

				sprintf_s(cTexto, "%s", cApellidoMaterno);
				cTexto[16] = 0;
				hoja.poner(cTexto, 15, iRen, iCol + 15);

				sprintf_s(cTexto, "%s", cNombre);
				cTexto[16] = 0;
				hoja.poner(cTexto, 15, iRen, iCol + 30);

				memset(cTexto, 0, 80);        //cliente-folio
				sprintf_s(cTexto, "%08ld%1d-%06ld", m_grid.lCliente / 10L, (int)calcular_digito(m_grid.lCliente / 10L), lFolioBeneficiario);
				hoja.poner(cTexto, iRen, 55 + iCol);
				iRen = iRen + 3;
			}
			else
			{
				hoja.poner("Datos de los asegurados:", iRen, iCol);
				iRen++;
				hoja.poner("(Titular)", iRen, iCol);
				iRen++;
				hoja.poner("Ap.Pat.        Ap.Mat.        Nombre(s)", 8, iCol + 10);
				sprintf_s(cTexto, "%s", cApellidoPaterno);
				cTexto[16] = 0;
				hoja.poner(cTexto, 15, iRen, iCol + 10);

				sprintf_s(cTexto, "%s", cApellidoMaterno);
				cTexto[16] = 0;
				hoja.poner(cTexto, 15, iRen, iCol + 25);

				sprintf_s(cTexto, "%s", cNombre);
				cTexto[16] = 0;
				hoja.poner(cTexto, 15, iRen, iCol + 40);

				memset(cTexto, 0, 80);        //cliente-folio
				sprintf_s(cTexto, "%08ld%1d-%06ld", m_grid.lCliente / 10L, (int)calcular_digito(m_grid.lCliente / 10L), lFolioBeneficiario);
				hoja.poner(cTexto, iRen, 55 + iCol);
				iRen++;

				hoja.poner("(Cónyuge)", iRen, iCol);
				iRen++;
				hoja.poner("Ap.Pat.        Ap.Mat.        Nombre(s)", 10, iCol + 10);

				separarConyuge(cNombreConyuge, cApPaternoc, cApMaternoc, cNombrec);
				sprintf_s(cTexto, "%s", cApPaternoc);
				cTexto[16] = 0;
				hoja.poner(cTexto, iRen, iCol + 10);

				sprintf_s(cTexto, "%s", cApMaternoc);
				cTexto[16] = 0;
				hoja.poner(cTexto, iRen, iCol + 25);

				sprintf_s(cTexto, "%s", cNombrec);
				cTexto[16] = 0;
				hoja.poner(cTexto, iRen, iCol + 40);
				iRen++;
			}

			hoja.poner("Domicilio:(calle, número, col, dlg ó mpio, estado, cp.)", iRen, iCol);
			iRen++;
			datosDeCliente(iCasa, iColonia, iCalle, iCiudad, lCodigoPostal, cNombreCalle, cNombreZona, cNombreCiudad);
			memset(cTexto, 0, 80);
			sprintf_s(cTexto, "%s", cNombreCalle);
			cTexto[12] = 0;
			hoja.poner(cTexto, 12, iRen, iCol);
			hoja.poner(", ", iRen, iCol + 13);

			memset(cTexto, 0, 80);
			sprintf_s(cTexto, "%06ld", iCasa);
			hoja.poner(cTexto, iRen, iCol + 15);
			hoja.poner(", ", iRen, iCol + 21);

			memset(cTexto, 0, 80);
			sprintf_s(cTexto, "%s", cNombreZona);
			cTexto[12] = 0;
			hoja.poner(cTexto, 12, iRen, iCol + 23);
			hoja.poner(", ", iRen, iCol + 35);

			memset(cTexto, 0, 80);
			sprintf_s(cTexto, "%s", cNombreCiudad);
			cTexto[12] = 0;
			hoja.poner(cTexto, 12, iRen, iCol + 37);
			hoja.poner(", ", iRen, iCol + 49);

			memset(cTexto, 0, 80);
			sprintf_s(cTexto, "%06ld", lCodigoPostal);
			hoja.poner(cTexto, iRen, iCol + 52);
			iRen++;

			obtenerMes(iMesNacimiento, cNomMes);
			sprintf_s(cTexto, "Fecha de Nacimiento:%02d/%s/%04d. Sexo: %c  Nacionalidad: M", iDiaNacimiento, cNomMes, iAnioNacimiento, cSexo);
			hoja.poner(cTexto, iRen, iCol);

			finHoja(hoja);
			iniciarHoja(hoja);

			memset(cTexto, 0, 80);
			cOcupacion[20] = 0;
			sprintf_s(cTexto, "Ocupación: %s  Curp:  ", cOcupacion);
			hoja.poner(cTexto, 3, iCol);

			//se pinta e imprime monto asegurado.
			{
				if (iConyugal == 1)
				{
					if (iCantidadSeguros > 0)
					{
						consultarMontoSeguroClub(lMontoClub, (short)iCantidadSeguros, 1);
					}
				}
				else
				{

					switch (iCantidadSeguros)
					{
					case 1:
						lMontoClub = obtenerMontoSeguroClub(1);
						break;
					case 2:
						lMontoClub = obtenerMontoSeguroClub(2);
						break;
					case 3:
						lMontoClub = obtenerMontoSeguroClub(3);
						break;
					default:
						break;
					}
					switch (iNumSeguros)
					{
					case 1:
						lMontoClub = obtenerMontoSeguroClub(1);
						break;
					case 2:
						lMontoClub = obtenerMontoSeguroClub(2);
						break;
					case 3:
						lMontoClub = obtenerMontoSeguroClub(3);
						break;
					default:
						break;
					}

				}
			}

			usingx("###,###", cMonto, (double)lMontoClub);
			sprintf_s(cTexto, "Cobertura contratada: Fallecimiento. Suma Asegurada:  $%s", cMonto);
			hoja.poner(cTexto, 4, iCol);

			hoja.poner("Designación de Beneficiarios:", 5, iCol);
			hoja.poner("Ap.Pat.        Ap.Mat.        Nombre(s)         PARENT:   PORC.", 6, iCol);

			hoja.poner(cApPatBeneficiario1, 15, 7, iCol);
			hoja.poner(cApMatBeneficiario1, 15, 7, iCol + 15);
			hoja.poner(cNombreBeneficiario1, 15, 7, iCol + 30);

			if (iPorcentaje1 > 0)
			{
				checarParentesco(cValorParentesco, iParentesco1);
				cValorParentesco[4] = 0;
				hoja.poner(cValorParentesco, 4, 7, 51);

				memset(cTexto, 0, 80);
				usingx("###", cTexto, (double)iPorcentaje1);
				cTexto[3] = 0;
				hoja.poner(cTexto, 3, 7, 60);
				hoja.poner("%", 1, 7, 63);
			}

			hoja.poner(cApPatBeneficiario2, 15, 8, iCol);
			hoja.poner(cApMatBeneficiario2, 15, 8, iCol + 15);
			hoja.poner(cNombreBeneficiario2, 15, 8, iCol + 30);

			if (iPorcentaje2 > 0)
			{
				checarParentesco(cValorParentesco, iParentesco2);
				cValorParentesco[4] = 0;
				hoja.poner(cValorParentesco, 4, 8, 51);

				memset(cTexto, 0, 80);
				usingx("###", cTexto, (double)iPorcentaje2);
				cTexto[3] = 0;
				hoja.poner(cTexto, 3, 8, 60);
				hoja.poner("%", 1, 8, 63);
			}

			hoja.poner(cApPatBeneficiario3, 15, 9, iCol);
			hoja.poner(cApMatBeneficiario3, 15, 9, iCol + 15);
			hoja.poner(cNombreBeneficiario3, 15, 9, iCol + 30);

			if (iPorcentaje3 > 0)
			{
				checarParentesco(cValorParentesco, iParentesco3);
				cValorParentesco[4] = 0;
				hoja.poner(cValorParentesco, 4, 9, 51);

				memset(cTexto, 0, 80);
				usingx("###", cTexto, (double)iPorcentaje3);
				cTexto[3] = 0;
				hoja.poner(cTexto, 3, 9, 60);
				hoja.poner("%", 1, 9, 63);
			}

			hoja.poner(cApPatBeneficiario4, 15, 10, iCol);
			hoja.poner(cApMatBeneficiario4, 15, 10, iCol + 15);
			hoja.poner(cNombreBeneficiario4, 15, 10, iCol + 30);

			if (iPorcentaje4 > 0)
			{
				checarParentesco(cValorParentesco, iParentesco4);
				cValorParentesco[4] = 0;
				hoja.poner(cValorParentesco, 4, 10, 51);
				memset(cTexto, 0, 80);
				usingx("###", cTexto, (double)iPorcentaje4);
				cTexto[3] = 0;
				hoja.poner(cTexto, 3, 10, 60);
				hoja.poner("%", 1, 10, 63);
			}

			hoja.poner("FECHA:", 11, iCol);
			memset(cTexto, 0, 80);
			miniFecha(cTexto, iDiaActual, iMesActual, iAnioActual);

			hoja.poner(cTexto, 7, 11, 8 + iCol);

			hoja.poner("_________________________________________", 12, 26 + iCol);
			hoja.poner("           Firma del Asegurado           ", 13, 26 + iCol);

			finHoja(hoja);

			if (imprimirNotaImportante(hoja, iCont))
			{
				impresionArchivo.imprimirArchivo(cDirectorio);
				if (iCont == 0)
				{
					procesoGrabarGnTira(iTipoImpresora);
				}
			}
		}
	}
	valorRegresa = true;
	sprintf_s(cLog, "FC0200805021521086 - fin - imprimirPolizaSeguroClub");
	grabarLog(cLog);
	return valorRegresa;
}

void CDlgCapturarAbono::iniciarHoja(C_FormasPCL &hoja)
{
	hoja.poner(OCTAVOS, 0, 0);
	hoja.poner(COMPACTAR, 0, 3);
}

void CDlgCapturarAbono::finHoja(C_FormasPCL &hoja)
{
	hoja.poner(SEXTOS, 19, 0);
	hoja.poner(OCTAVOS, 21, 0);
	hoja.poner(COMPACTAR, 21, 3);
	hoja.imprimir();
}

void CDlgCapturarAbono::checarParentesco(char *cValorParent, int iParentesco)
{
	memset(cValorParent, ' ', 5);
	switch (iParentesco)
	{
	case 1:
		memcpy(cValorParent, "1-ES", 4);
		break;
	case 2:
		memcpy(cValorParent, "2-HI", 4);
		break;
	case 3:
		memcpy(cValorParent, "3-PA", 4);
		break;
	case 4:
		memcpy(cValorParent, "4-HE", 4);
		break;
	case 5:
		memcpy(cValorParent, "5-OT", 4);
		break;
	default:
		break;
	}
}

void CDlgCapturarAbono::unionNombrex(char *cCampo, char *cTexto, int &iInicio, int iTotal)
{
	int i, iFlag = 0;

	for (i = 0; i < iTotal; i++)
	{
		if (cCampo[i] == 0 || cCampo[i] == ' ')
			iFlag++;
		else
			iFlag = 0;

		if (iFlag == 2) break;

		if (iFlag < 2)
		{
			cTexto[iInicio] = cCampo[i];
			iInicio++;
		}
	}
}

bool CDlgCapturarAbono::obtenerNombreFechaNacimientoCliente()
{
	char cLog[500] = { 0 };
	bool valorRegresa = true;
	char cSql[165] = { 0 }, cMensaje[512] = { 0 };

	sprintf_s(cLog, "FC0200805021521103 - entra - obtenerNombreFechaNacimientoCliente");
	grabarLog(cLog);

	CConsultarNomPuntFechaCrCliente consultarNombreFechaCliente(&odbc_1);
	sprintf_s(cSql, "SELECT cliente,nombre,apellidopaterno,apellidomaterno,sexo,lugartrabajo,situacionespecial,fechanacimiento,puntualidad FROM crcliente WHERE cliente = %ld", m_grid.lCliente);

	if (!consultarNombreFechaCliente.Exec(cSql))
	{
		//Se obtiene el error
		consultarNombreFechaCliente.odbc->GetLastError(consultarNombreFechaCliente.GetHstmt());
		grabarMensajeError("C", m_grid.iCaja, (LPTSTR)(LPCTSTR)m_grid.sServer, "CapturarAbono", "CDlgCapturarAbono", "obtenerNombreFechaNacimientoCliente", cSql, m_grid.lEmpleado, "ERROR EN LA CONSULTA (obtenernombrefechanacimientocliente)", consultarNombreFechaCliente.odbc, m_grid.iMuestraMsg);
		valorRegresa = false;
	}
	else
	{
		consultarNombreFechaCliente.activarCols();
		if (consultarNombreFechaCliente.Leer())
		{
			memcpy(cNombre, consultarNombreFechaCliente.nombre, 15);
			cNombre[15] = 0;

			memcpy(cApellidoPaterno, consultarNombreFechaCliente.apellidopaterno, 15);
			cApellidoPaterno[15] = 0;

			memcpy(cApellidoMaterno, consultarNombreFechaCliente.apellidomaterno, 15);
			cApellidoMaterno[15] = 0;

			memcpy(&cSexo, &consultarNombreFechaCliente.sexo, 1);

			memcpy(cOcupacion, consultarNombreFechaCliente.lugartrabajo, 20);

			iDiaNacimiento = (short)consultarNombreFechaCliente.fechanacimiento.dia();
			iMesNacimiento = (short)consultarNombreFechaCliente.fechanacimiento.mes();
			iAnioNacimiento = (short)consultarNombreFechaCliente.fechanacimiento.ano();

			if (iMesActual >= iMesNacimiento)
			{
				if (iMesActual == iMesNacimiento)
				{
					if (iDiaActual >= iDiaNacimiento)
					{
						iEdadCliente = iAnioActual - iAnioNacimiento;
					}
					else
					{
						iEdadCliente = (iAnioActual - iAnioNacimiento) - 1;
					}
				}
				else
				{
					iEdadCliente = iAnioActual - iAnioNacimiento;
				}
			}
			else
			{
				iEdadCliente = (iAnioActual - iAnioNacimiento) - 1;
			}

			cPuntualidad[0] = consultarNombreFechaCliente.puntualidad[0];

			if (cPuntualidad[0] == ' ') cPuntualidad[0] = 0;
			cPuntualidad[1] = 0;

			iProceso = CAPTURA_ABONO;
			iRegla = CLIENTE_ILOCALIZABLE;

			if (ValidarSituacionEspecial(m_grid.lCliente, iRegla, iProceso, 3))
			{
				iSituacionEspecial = 1;
			}
			else
			{
				iSituacionEspecial = 0;
			}
			valorRegresa = true;
		}
	}
	return valorRegresa;
}

long CDlgCapturarAbono::obtenerMontoSeguroClub(int iCantSeguros)
{
	char cLog[500] = { 0 };
	long lImporte = 0L;
	char cSql[90] = { 0 }, cMensajeseguro[150] = { 0 };

	sprintf_s(cLog, "FC0200805021521107 - entra - obtenerMontoSeguroClub");
	grabarLog(cLog);

	CMaximo obtenerMontoSeguroClub(&odbc);
	sprintf_s(cSql, "SELECT monto FROM casegurossys WHERE compania = 2 AND cantidad = %d AND tiposeguro=1", iCantSeguros);

	if (!obtenerMontoSeguroClub.Exec(cSql))
	{
		//Se obtiene el error
		obtenerMontoSeguroClub.odbc->GetLastError(obtenerMontoSeguroClub.GetHstmt());
		grabarMensajeError("C", m_grid.iCaja, (LPTSTR)(LPCTSTR)m_grid.sServer, "CapturarAbono", "CDlgCapturarAbono", "obtenerMontoSeguroClub", cSql, m_grid.lEmpleado, "ERROR EN LA CONSULTA(obtenermontoseguroclub)", obtenerMontoSeguroClub.odbc, m_grid.iMuestraMsg);
	}
	else
	{
		obtenerMontoSeguroClub.activarCols();
		while (obtenerMontoSeguroClub.Leer())
		{
			lImporte = obtenerMontoSeguroClub.Total;
			sprintf_s(cMensajeseguro, "Importe seguro :%ld", lImporte);
			grabarLog(cMensajeseguro);
		}
	}
	return lImporte;
}

//9923 --> consultar beneficiarios
bool CDlgCapturarAbono::obtenerDatosBeneficiarios(int iConyugal)
{
	CString sSqlTxt;
	bool valorRegresa = false;
	char cTextoAux[2048] = { 0 };

	sprintf_s(cTextoAux, "%s", "Entro obtenerDatosBeneficiarios");
	grabarLog(cTextoAux);
	CObtenerDatosTdBeneficiariosClub obtenerDatosBeneficiarios(&odbc);

	sSqlTxt.Format("SELECT folio, cliente,nombreasegurado,nombreconyuge,"
		"nombre1,apellidopaterno1,apellidomaterno1,porcentaje1,parentesco1,fec_nacimiento1,num_telefono1,"
		"nombre2,apellidopaterno2,apellidomaterno2,porcentaje2,parentesco2,fec_nacimiento2,num_telefono2,"
		"nombre3,apellidopaterno3,apellidomaterno3,porcentaje3,parentesco3,fec_nacimiento3,num_telefono3,"
		"nombre4,apellidopaterno4,apellidomaterno4,porcentaje4,parentesco4, '1900-01-01' as fec_nacimiento4,0 as num_telefono4 "
		"FROM fun_consultartdbeneficiarios(%ld,0,'%d','.',0,'','%d');", m_grid.lCliente, m_grid.iCaja, iAnioActual, iMesActual, iDiaActual, iConyugal);


	sprintf_s(cTextoAux, "%s", (LPCTSTR)sSqlTxt);
	grabarLog(cTextoAux);

	if (!obtenerDatosBeneficiarios.Exec(sSqlTxt))
	{
		//Se obtiene el error
		obtenerDatosBeneficiarios.odbc->GetLastError(obtenerDatosBeneficiarios.GetHstmt());
		grabarMensajeError("C", m_grid.iCaja, (LPTSTR)(LPCTSTR)m_grid.sServer, "CapturarAbono", "CDlgCapturarAbono", "obtenerMontoSeguroClub", (LPTSTR)(LPCTSTR)sSqlTxt, m_grid.lEmpleado, "ERROR EN LA CONSULTA(obtenerdatosbeneficiarios)", obtenerDatosBeneficiarios.odbc, m_grid.iMuestraMsg);
	}
	else
	{
		obtenerDatosBeneficiarios.activarCols();
		while (obtenerDatosBeneficiarios.Leer())
		{
			lFolioBeneficiario = obtenerDatosBeneficiarios.folio;
			memcpy(cNombreAsegurado, obtenerDatosBeneficiarios.nombreasegurado, 32);
			cNombreAsegurado[32] = 0;
			memcpy(cNombreBeneficiario1, obtenerDatosBeneficiarios.nombre1, 15);
			cNombreBeneficiario1[15] = 0;

			memcpy(cApPatBeneficiario1, obtenerDatosBeneficiarios.apellidopaterno1, 15);
			cApPatBeneficiario1[15] = 0;

			memcpy(cApMatBeneficiario1, obtenerDatosBeneficiarios.apellidomaterno1, 15);
			cApMatBeneficiario1[15] = 0;

			memcpy(cNombreBeneficiario2, obtenerDatosBeneficiarios.nombre2, 15);
			cNombreBeneficiario2[15] = 0;

			memcpy(cApPatBeneficiario2, obtenerDatosBeneficiarios.apellidopaterno2, 15);
			cApPatBeneficiario2[15] = 0;

			memcpy(cApMatBeneficiario2, obtenerDatosBeneficiarios.apellidomaterno2, 15);
			cApMatBeneficiario2[15] = 0;

			memcpy(cNombreBeneficiario3, obtenerDatosBeneficiarios.nombre3, 15);
			cNombreBeneficiario3[15] = 0;

			memcpy(cApPatBeneficiario3, obtenerDatosBeneficiarios.apellidopaterno3, 15);
			cApPatBeneficiario3[15] = 0;

			memcpy(cApMatBeneficiario3, obtenerDatosBeneficiarios.apellidomaterno3, 15);
			cApMatBeneficiario3[15] = 0;

			memcpy(cNombreConyuge, obtenerDatosBeneficiarios.nombreconyuge, 32);
			cNombreConyuge[32] = 0;

			memcpy(cNombreBeneficiario4, obtenerDatosBeneficiarios.nombre4, 15);
			cNombreBeneficiario4[15] = 0;

			memcpy(cApPatBeneficiario4, obtenerDatosBeneficiarios.apellidopaterno4, 15);
			cApPatBeneficiario4[15] = 0;

			memcpy(cApMatBeneficiario4, obtenerDatosBeneficiarios.apellidomaterno4, 15);
			cApMatBeneficiario4[15] = 0;

			iPorcentaje1 = obtenerDatosBeneficiarios.porcentaje1;
			iPorcentaje2 = obtenerDatosBeneficiarios.porcentaje2;
			iPorcentaje3 = obtenerDatosBeneficiarios.porcentaje3;
			iPorcentaje4 = obtenerDatosBeneficiarios.porcentaje4;
			iParentesco1 = obtenerDatosBeneficiarios.parentesco1;
			iParentesco2 = obtenerDatosBeneficiarios.parentesco2;
			iParentesco3 = obtenerDatosBeneficiarios.parentesco3;
			iParentesco4 = obtenerDatosBeneficiarios.parentesco4;

			lTelefono1 = obtenerDatosBeneficiarios.telefono1;
			lTelefono2 = obtenerDatosBeneficiarios.telefono2;
			lTelefono3 = obtenerDatosBeneficiarios.telefono3;

			iMesNacimiento1 = obtenerDatosBeneficiarios.fechanacimiento1.mes();
			iMesNacimiento2 = obtenerDatosBeneficiarios.fechanacimiento2.mes();
			iMesNacimiento3 = obtenerDatosBeneficiarios.fechanacimiento3.mes();

			iAnioNacimiento1 = obtenerDatosBeneficiarios.fechanacimiento1.ano();
			iAnioNacimiento2 = obtenerDatosBeneficiarios.fechanacimiento2.ano();
			iAnioNacimiento3 = obtenerDatosBeneficiarios.fechanacimiento3.ano();

			iDiaNacimiento1 = obtenerDatosBeneficiarios.fechanacimiento1.dia();
			iDiaNacimiento2 = obtenerDatosBeneficiarios.fechanacimiento2.dia();
			iDiaNacimiento3 = obtenerDatosBeneficiarios.fechanacimiento3.dia();
			valorRegresa = true;
		}
	}
	sprintf_s(cTextoAux, "FC0200805021521114 - fin - obtenerDatosBeneficiarios");
	grabarLog(cTextoAux);
	return valorRegresa;
}

int CDlgCapturarAbono::obtenerNumeroSeguros()
{
	char cLog[500] = { 0 };
	int iNumeroSeguros = 0;
	char cSql[110] = { 0 };

	sprintf_s(cLog, "FC0200805021521116 - entra - obtenerNumeroSeguros");
	grabarLog(cLog);

	CMaximo consultarNumeroSegCrSeguros(&odbc_1);
	sprintf_s(cSql, "SELECT cantidadseguros FROM crseguros WHERE cliente = %ld AND claveseguro='C' AND tiposeguro IN (0,1)", m_grid.lCliente);

	if (!consultarNumeroSegCrSeguros.Exec(cSql))
	{
		//Se obtiene el error
		consultarNumeroSegCrSeguros.odbc->GetLastError(consultarNumeroSegCrSeguros.GetHstmt());
		grabarMensajeError("C", m_grid.iCaja, (LPTSTR)(LPCTSTR)m_grid.sServer, "CapturarAbono", "CDlgCapturarAbono", "obtenerNumeroSeguros", cSql, m_grid.lEmpleado, "ERROR EN LA CONSULTA(obtenernumeroseguros)", consultarNumeroSegCrSeguros.odbc, m_grid.iMuestraMsg);
	}
	else
	{
		consultarNumeroSegCrSeguros.activarCols();
		if (consultarNumeroSegCrSeguros.Leer())
		{
			iNumeroSeguros = consultarNumeroSegCrSeguros.Total;
		}
	}
	sprintf_s(cLog, "FC0200805021521117 - fin - obtenerNumeroSeguros");
	grabarLog(cLog);
	return iNumeroSeguros;
}

void CDlgCapturarAbono::seguroReactivado()
{
	char cLog[500] = { 0 };
	int  iEncontro = 0;
	char cSql[65] = { 0 };

	sprintf_s(cLog, "FC0200805021521119 - entra - seguroReactivado");
	grabarLog(cLog);

	CMaximo clienteTdBeneficiarios(&odbc);
	sprintf_s(cSql, "SELECT cliente FROM tdBeneficiarios WHERE cliente = %ld", m_grid.lCliente);

	if (!clienteTdBeneficiarios.Exec(cSql))
	{
		//Se obtiene el error
		clienteTdBeneficiarios.odbc->GetLastError(clienteTdBeneficiarios.GetHstmt());
		grabarMensajeError("C", m_grid.iCaja, (LPTSTR)(LPCTSTR)m_grid.sServer, "CapturarAbono", "CDlgCapturarAbono", "seguroReactivado", cSql, m_grid.lEmpleado, "ERROR EN LA CONSULTA(seguroreactivado)", clienteTdBeneficiarios.odbc, m_grid.iMuestraMsg);
	}
	else
	{
		clienteTdBeneficiarios.activarCols();
		while (clienteTdBeneficiarios.Leer())
		{
			if (clienteTdBeneficiarios.Total == m_grid.lCliente / 10)
			{
				iEncontro = 1;
				break;
			}
		}
		if (iEncontro != 1)
		{
			memset(cNombreBeneficiario1, 0, 20);
			memset(cApPatBeneficiario1, 0, 20);
			memset(cApMatBeneficiario1, 0, 20);
			memset(cNombreBeneficiario2, 0, 20);
			memset(cApPatBeneficiario2, 0, 20);
			memset(cApMatBeneficiario2, 0, 20);
			memset(cNombreBeneficiario3, 0, 20);
			memset(cApPatBeneficiario3, 0, 20);
			memset(cApMatBeneficiario3, 0, 20);
			memset(cNombreAsegurado, 0, 35);
			memset(cNombreConyuge, 0, 35);
			memset(cNombreBeneficiario4, 0, 20);
			memset(cApPatBeneficiario4, 0, 20);
			memset(cApMatBeneficiario4, 0, 20);
			iParentesco1 = iParentesco2 = iParentesco3 = iPorcentaje1 = iPorcentaje2 = iPorcentaje3 = 0;
			lFolioBeneficiario = 0L;
		}
	}
}

bool CDlgCapturarAbono::grabarAbonoInteCacarmov()//Se agrego para actualizar la puntualidad del cliente al relalizar AbonoIntereses**
{
	char cLog[500] = { 0 };
	bool bResultado = true;
	char cSqlInte[330] = { 0 };

	sprintf_s(cLog, "FC0200805021521123 - entra - grabarAbonoInteCacarmov");
	grabarLog(cLog);

	for (int i = 0; i < iTotalAbonoInte; i++)
	{
		sprintf_s(cSqlInte, "UPDATE cacarmov SET clv_situacion='%c', importeclub=%ld, vencidofinal= %ld ,puntualidadcte= '%c',num_candconvunico=%d,imp_abonobasetotalfinal=%d WHERE recibo=%ld AND clave ='%c' AND tipomovimiento ='%c' AND cliente='%d' AND factura= %d AND fecha ='%04d-%02d-%02d'", clv_situacion[0], iAbonoBaseTotalInicial, EDatosConvenioCliente[i].iAbonoInteVencidoFinal, EDatosConvenioCliente[i].cAbonoIntePuntualidad, iNumCandidatoUnico, iAbonoBaseTotalConv, lNumeroRecibo, EDatosConvenioCliente[i].cAbonoInteClave, EDatosConvenioCliente[i].cAbonoInteTipoMovi, m_grid.lCliente, EDatosConvenioCliente[i].iAbonoInteFactura, iAnioActual, iMesActual, iDiaActual);
		CMaximo flagCoppel(&odbc, false);
		if (flagCoppel.Exec(cSqlInte))
		{
			flagCoppel.activarCols();
			if (flagCoppel.Leer())
			{
				bResultado = true;
			}
		}
		else
		{
			//Se obtiene el error
			bResultado = false;
			flagCoppel.odbc->GetLastError(flagCoppel.GetHstmt());
			grabarMensajeError("C", m_grid.iCaja, (LPTSTR)(LPCTSTR)m_grid.sServer, "CapturarAbono", "CDlgCapturarAbono",
				"grabarAbonoInteCacarmov", cSqlInte, m_grid.lEmpleado, "ERROR EN LA CONSULTA(grabarAbonoInteCacarmov)",
				flagCoppel.odbc, m_grid.iMuestraMsg);
			sprintf_s(cLog, "ERROR EN LA CONSULTA(grabarAbonoInteCacarmov) Area: C ,NumeroCaja: %d , Servidor: %s ,Empleado: %ld ,Metodo::grabarAbonoInteCacarmov ,ERROR: column clv_situacion,vencidofinal,num_candconvunico,imp_abonobasetotalfinal  of relation cacarmov does not exist.", m_grid.iCaja, m_grid.sServer, m_grid.lEmpleado);
			grabarLog(cLog);
			break;
		}
	}
	return bResultado;
}

bool CDlgCapturarAbono::grabarAbonoCacarmov()//Se agrego para actualizar la puntualidad del cliente al relalizar Abono**
{
	char cLog[500] = { 0 };
	bool bResultado = true;
	char sSqlGrabarAbo[360] = { 0 };

	sprintf_s(cLog, "FC0200805021521127 - entra - grabarAbonoCacarmov");
	grabarLog(cLog);

	for (int i = 0; i < iTotalAbonos; i++)
	{
		sprintf_s(sSqlGrabarAbo, "UPDATE cacarmov SET clv_situacion='%c', importeclub = %ld, vencidofinal= %ld ,puntualidadcte= '%c',num_candconvunico=%d,imp_abonobasetotalfinal=%d WHERE recibo=%ld AND clave ='%c' AND tipomovimiento ='%c' AND cliente='%d' AND factura= %d and fecha = '%04d-%02d-%02d'", clv_situacion[0], iAbonoBaseTotalInicial, EDatosConvenioCliente[i].iAbonoVencidoFinal, EDatosConvenioCliente[i].cAbonoPuntualidad, iNumCandidatoUnico, iAbonoBaseTotalConv, lNumeroRecibo, EDatosConvenioCliente[i].cAbonoClave, EDatosConvenioCliente[i].cAbonoTipoMovi, m_grid.lCliente, EDatosConvenioCliente[i].iAbonoFactura, iAnioActual, iMesActual, iDiaActual);
		CMaximo flagCoppel(&odbc, false);
		if (flagCoppel.Exec(sSqlGrabarAbo))
		{
			flagCoppel.activarCols();
			if (flagCoppel.Leer())
			{
				bResultado = true;
			}
		}
		else
		{
			//Se obtiene el error
			bResultado = false;
			flagCoppel.odbc->GetLastError(flagCoppel.GetHstmt());
			grabarMensajeError("C", m_grid.iCaja, (LPTSTR)(LPCTSTR)m_grid.sServer, "CapturarAbono", "CDlgCapturarAbono",
				"grabarAbonoCacarmov", sSqlGrabarAbo, m_grid.lEmpleado, "ERROR EN LA CONSULTA(grabarAbonoCacarmov)",
				flagCoppel.odbc, m_grid.iMuestraMsg);
			sprintf_s(cLog, "ERROR EN LA CONSULTA(grabarAbonoCacarmov) Area: C ,NumeroCaja: %d , Servidor: %s ,Empleado:%ld ,Metodo::grabarAbonoCacarmov ,ERROR: column clv_situacion,vencidofinal,num_candconvunico,imp_abonobasetotalfinal  of relation cacarmov does not exist.", m_grid.iCaja, m_grid.sServer, m_grid.lEmpleado);
			grabarLog(cLog);
			break;
		}
	}
	return bResultado;
}

bool CDlgCapturarAbono::grabarAbonoSegCacarmov()//Se agrego para actualizar la puntualidad del cliente al relalizar AbonoSeguros**
{
	char cLog[500] = { 0 };
	bool bResultado = true;
	char sSqlTxtSeg[270] = { 0 };

	sprintf_s(cLog, "FC0200805021521131 - entra - grabarAbonoSegCacarmov");
	grabarLog(cLog);

	for (int i = 0; i < iTotalAbonoSeg; i++)
	{
		sprintf_s(sSqlTxtSeg, "UPDATE cacarmov SET clv_situacion='%c', importeclub=%ld,puntualidadcte= '%c',num_candconvunico=%d,imp_abonobasetotalfinal=%d WHERE recibo=%ld AND clave ='%c' and tipomovimiento ='%c' AND cliente='%d' AND fecha ='%04d-%02d-%02d'", clv_situacion[0], iAbonoBaseTotalInicial, EDatosConvenioCliente[i].cAbonoSegPuntualidad, iNumCandidatoUnico, iAbonoBaseTotalConv, lNumeroRecibo, EDatosConvenioCliente[i].cAbonoSegClave, EDatosConvenioCliente[i].cAbonoSegTipoMovi, m_grid.lCliente, iAnioActual, iMesActual, iDiaActual);
		CMaximo flagCoppel(&odbc, false);
		if (flagCoppel.Exec(sSqlTxtSeg))
		{
			flagCoppel.activarCols();
			if (flagCoppel.Leer())
			{
				bResultado = true;
			}
		}
		else
		{
			//Se obtiene el error
			bResultado = false;
			flagCoppel.odbc->GetLastError(flagCoppel.GetHstmt());
			grabarMensajeError("C", m_grid.iCaja, (LPTSTR)(LPCTSTR)m_grid.sServer, "CapturarAbono", "CDlgCapturarAbono",
				"grabarAbonoSegCacarmov", sSqlTxtSeg, m_grid.lEmpleado, "ERROR EN LA CONSULTA(grabarAbonoSegCacarmov)",
				flagCoppel.odbc, m_grid.iMuestraMsg);
			sprintf_s(cLog, "ERROR EN LA CONSULTA(grabarAbonoSegCacarmov) Area: C ,NumeroCaja: %d ,Servidor: %s ,Empleado: %ld ,Metodo::grabarAbonoSegCacarmov ,ERROR: column clv_situacion,vencidofinal,num_candconvunico,imp_abonobasetotalfinal  of relation cacarmov does not exist.", m_grid.iCaja, m_grid.sServer, m_grid.lEmpleado);
			grabarLog(cLog);
			break;
		}
	}
	return bResultado;
}

bool CDlgCapturarAbono::grabarConvenioCacarmov()//Se agrego para actualizar la puntualidad del cliente al realizar convenios**
{
	char cLog[500] = { 0 };
	/* Validar si es convenio valido/invalido Valido con las logicas sig*/
	/* iTarjetaConv=1 ---> Convenio Valido */
	/* iTarjetaConv=0 ---> Convenio Invalido */
	bool bResultado = true;
	CMaximo Tablax(&odbc, false);
	char cSql[410] = { 0 };
	int iporc_paraconveniovalido = 0;

	sprintf_s(cLog, "FC0200805021521135 - entra - grabarConvenioCacarmov");
	grabarLog(cLog);

	sprintf_s(cSql, "SELECT porc_paraconveniovalido FROM ctl_variablesparaconvenios WHERE anio=%d AND mes =%d LIMIT 1", ianio, imes);
	if (Tablax.Exec(cSql))
	{
		Tablax.activarCols();
		if (Tablax.Leer())
		{
			iporc_paraconveniovalido = (int)Tablax.Total;
			bResultado = true;
		}
	}
	if (iConConvenio > 0)//valida que existe convenio realizado
	{
		/* 3- Si saldo vencido total <= a 1 abono base total
		La suma total de todos los convenios debe ser >= al saldo total vencido*/
		iImporteMinimoConv = ((iVencidoTotalConv * iporc_paraconveniovalido) / (100));//Sacar el importe minimo a conveniar
		if (iVencidoTotalConv <= iAbonoBaseTotalConv && iImporteTotalConv >= iVencidoTotalConv)
		{
			iTarjetaConv = 1;
		}
		/* 2-• Si Importe mínimo a conveniar del saldo vencido total < 1 abono base total
		La suma total de los convenios debe ser >= a 1 abono base total*/
		else if (iImporteMinimoConv <= iAbonoBaseTotalConv && iImporteTotalConv >= iAbonoBaseTotalConv)
		{
			iTarjetaConv = 1;
		}
		/* 1- Si Importe mínimo a conveniar del saldo vencido total >= 1 abono base total, la suma total
		de los convenios debe ser >= al importe mínimo a conveniar del saldo vencido total.*/
		else if (iImporteMinimoConv >= iAbonoBaseTotalConv && iImporteTotalConv >= iImporteMinimoConv)
		{
			iTarjetaConv = 1;
		}
		else
		{
			iTarjetaConv = 0;
		}
	}
	/* Se agrego para actualizar la clv_situacion , importeclub , vencidofinal , puntualidad , ganode ,
	tarjeta    , num_candconvunico , flg_candconvunico , imp_abonobasetotalfinal del cliente al relalizar convenios **/
	for (int i = 0; i < iConConvenio; i++)
	{
		//ganode = Guarda el Area de donde se realizo el Convenio
		//tarjeta= Guarda si el convenio valido/invalido
		//puntualidadcte = Guarda la puntualidad del cte al realizar convenio
		iflg_candconvunico = 0;//Inicializa el flg_candconvunico
		if (EDatosConvenioCliente[i].CAbonosubtipoconvenio == '2')//Si el Convenio Fue Unico
		{
			ValidarConvenioUnico(EDatosConvenioCliente[i].iAbonoBaseCta, EDatosConvenioCliente[i].iAbonoConVencidoFinal, EDatosConvenioCliente[i].iAbonoPago, true);
			if (iflg_candconvunico != 1)//Verificar que era Tipo Unico(si iflg_candconvunico es != 1 no era unico y se marca el flag=0)
			{
				iflg_candconvunico = 0;//Convenio Unico Incorrecto
			}
		}
		sprintf_s(cSql, "UPDATE cacarmov SET clv_situacion='%c', importeclub=%ld, vencidofinal=%ld, ganode= %ld ,puntualidadcte= '%c',tarjeta=%ld,num_candconvunico=%d,flg_candconvunico=%d,imp_abonobasetotalfinal=%d where recibo=%ld and clave ='%c' and tipomovimiento ='%c' and cliente='%d' and factura= %d and fecha ='%04d-%02d-%02d'", clv_situacion[0], iAbonoBaseTotalInicial, EDatosConvenioCliente[i].iAbonoConVencidoFinal, EDatosConvenioCliente[i].iGanode, EDatosConvenioCliente[i].cPuntualidadcteConv, iTarjetaConv, iNumCandidatoUnico, iflg_candconvunico, iAbonoBaseTotalConv, lNumeroRecibo, EDatosConvenioCliente[i].cClave, EDatosConvenioCliente[i].cTipomovimientoConv, m_grid.lCliente, EDatosConvenioCliente[i].iFacturaConv, iAnioActual, iMesActual, iDiaActual);
		CMaximo flagCoppel(&odbc, false);
		if (flagCoppel.Exec(cSql))
		{
			flagCoppel.activarCols();
			if (flagCoppel.Leer())
			{
				bResultado = true;
			}
		}
		else
		{
			//Se obtiene el error.
			bResultado = false;
			flagCoppel.odbc->GetLastError(flagCoppel.GetHstmt());
			grabarMensajeError("C", m_grid.iCaja, (LPTSTR)(LPCTSTR)m_grid.sServer, "CapturarAbono", "CDlgCapturarAbono", "grabarConvenioCacarmov", (LPTSTR)(LPCTSTR)cSql, m_grid.lEmpleado, "ERROR EN LA CONSULTA(grabarConvenioCacarmov)", flagCoppel.odbc, m_grid.iMuestraMsg);
			sprintf_s(cLog, "ERROR EN LA CONSULTA(grabarConvenioCacarmov) Area: C ,NumeroCaja: %d ,Servidor: %s Empleado: %ld ,Metodo::grabarConvenioCacarmov ,ERROR: column clv_situacion,vencidofinal,num_candconvunico,flg_candconvunico,imp_abonobasetotalfinal  of relation cacarmov does not exist.", m_grid.iCaja, m_grid.sServer, m_grid.lEmpleado);
			grabarLog(cLog);
			break;
		}
		if (bResultado == true)//Si  bResultado = true  guarda el convenio en la cartera.. 
		{
			CDlgCapturarConvenio cdlgconvenio;
			cdlgconvenio.grabarConvenioTablaCorrespondienteValidado(EDatosConvenioCliente[i].iFacturaConv, EDatosConvenioCliente[i].iImporteFinalConv, EDatosConvenioCliente[i].iTipoCtaConvenio);
			//Si es el ultimo convenio se inicializa
			if (i + 1 == iConConvenio)
			{
				cdlgconvenio.asignarValor(0);
			}
		}
	}
	return bResultado;
}

bool CDlgCapturarAbono::pedirEncuesta()
{
	char cLog[500] = { 0 };
	bool valorRegresa = false;
	int iSiNoNose = 0, iCiudadCliente = 0;
	long lZonaCliente = 0l;
	char cNombreColonia[40] = { 0 };
	CString sTemp, sEncuestado;

	sprintf_s(cLog, "FC0200805021521140 - entra - pedirEncuesta");
	grabarLog(cLog);

	if (iFlagEdoCuenta == 1)
	{
		if (m_grid.lCliente > 0L && m_grid.lCliente != 90001L)
		{
			if (buscarClienteCrCliente(iCiudadCliente, lZonaCliente))
			{
				buscarNombreColonia(iCiudadCliente, lZonaCliente, cNombreColonia);
				if (iFlagEdoCuenta == 1 && iCiudadGnDominio == iCiudadCliente)
				{
					if (GetSetTipoBiometrizado(VALIDACION_HUELLA_ENCUESTAS) == VALIDACION_BIOMETRIZADA_TITULAR)
					{
						sprintf_s(cNombreEncuestado, "%s", cNombre);
						sprintf_s(cApellidoPaternoEncuestado, "%s", cApellidoPaterno);
						sprintf_s(cApellidoMaternoEncuestado, "%s", cApellidoMaterno);
					}
					else
					{
						CDlgEncuesta dlgEncuesta;
						dlgEncuesta.iTienda = (short)m_grid.iTienda;
						dlgEncuesta.lEmpleado = m_grid.lEmpleado;
						dlgEncuesta.iCaja = m_grid.iCaja;
						dlgEncuesta.iMuestraMsg = m_grid.iMuestraMsg;
						dlgEncuesta.iCiudad = (short)iCiudadGnDominio;
						dlgEncuesta.iCiudadCliente = iCiudadCliente;
						dlgEncuesta.lZonaCliente = lZonaCliente;
						sTemp.Format("%s", cNombreColonia);
						sTemp.Trim();
						sprintf_s(dlgEncuesta.cNombreColonia, "%s", (LPCTSTR)sTemp);
						dlgEncuesta.DoModal();

						sEncuestado.Format("%s", dlgEncuesta.cNombre);
						sEncuestado.Trim();
						sprintf_s(cNombreEncuestado, "%s", (LPCTSTR)sEncuestado);

						sEncuestado.Format("%s", dlgEncuesta.cApellidoMaterno);
						sEncuestado.Trim();
						sprintf_s(cApellidoMaternoEncuestado, "%s", (LPCTSTR)sEncuestado);

						sEncuestado.Format("%s", dlgEncuesta.cApellidoPaterno);
						sEncuestado.Trim();
						sprintf_s(cApellidoPaternoEncuestado, "%s", (LPCTSTR)sEncuestado);

						lZonaEncuestado = dlgEncuesta.lZonaCliente;
						lTelefonoEncuestado = dlgEncuesta.lTelefono;
					}

					iTipoEncuesta = 0;
					iSiNoNose = menuSiNoNose();
				}
				valorRegresa = true;
			}
		}
	}

	if (iFlag30Dias == 1)
	{
		int iFlagEncuestaPC = 0;
		obtenerFlag('0', FLAG_ACTIVARENCUESTAPERIODICOCOPPEL, iFlagEncuestaPC);
		if (iFlagEncuestaPC == 1)
		{
			valorRegresa = desplegarEncuestaPC();
		}
	}
	return valorRegresa;
}

bool CDlgCapturarAbono::desplegarEncuestaPC()
{
	char cLog[500] = { 0 };
	bool bRetorna = true;
	char cInput1[1024] = { 0 }, cInput2[1024] = { 0 }, cOutputParam1[1024] = { 0 }, cOutputParam2[1024] = { 0 }, cFecha[12] = { 0 };
	char cNombreProyecto[100] = { 0 };
	char cNombreFuncionDLL[10] = { 0 };
	SParametros argvDll;

	sprintf_s(cLog, "FC0200805021521145 - entra - desplegarEncuestaPC");
	grabarLog(cLog);

	memset(&argvDll, 0, sizeof(argvDll));
	sprintf_s(argvDll.sArea, "%s", "C");
	argvDll.iTienda = m_grid.iTienda;
	argvDll.iCiudad = iCiudadGnDominio;
	argvDll.iCajaActual = m_grid.iCaja;
	argvDll.lCliente = m_grid.lCliente;
	argvDll.lEmpleado = m_grid.lEmpleado;
	argvDll.iGerente = lNumeroGerente;
	sprintf_s(argvDll.cNombre, "%s", cNombre);
	sprintf_s(argvDll.cApellidoPaterno, "%s", cApellidoPaterno);
	sprintf_s(argvDll.cApellidoMaterno, "%s", cApellidoMaterno);
	sprintf_s(cFecha, "%02d/%02d/%04d", iDiaActual, iMesActual, iAnioActual);
	memcpy_s(argvDll.sFecha, 10, cFecha, 10);
	sprintf_s(argvDll.sServer, "%s", odbc.m_strServer);
	sprintf_s(argvDll.sIpCartera1, "%.15s", odbc_1.m_strServer);

	nombreArchivo("GN0222.DLL", cNombreProyecto, DIRECTORIO_GN);
	sprintf_s(cNombreFuncionDLL, "GN0222");

	memcpy(cInput1, &argvDll, sizeof(SParametros));
	CargarDLL cargarDll(cNombreProyecto, cNombreFuncionDLL, cInput1, cInput2, cOutputParam1, cOutputParam2);

	iRegresaDll = cargarDll.getResultado();
	if (iRegresaDll <= 0)
	{
		AfxMessageBox("Ocurrio un error del modulo GN0222.DLL", MB_ICONERROR);
		bRetorna = false;
	}
	return bRetorna;
}

int CDlgCapturarAbono::menuSiNoNose()
{
	char cLog[500] = { 0 };
	int iOpcion = 0, iFlag = 0, iRegresa = 0;
	bool bSalir = true;
	CString sDato;

	sprintf_s(cLog, "FC0200805021521149 - entra - menuSiNoNose");
	grabarLog(cLog);

	if (m_grid.lCliente > 0L && m_grid.lCliente != 90001L)
	{
		if (iTipoEncuesta == 0)
		{
			bSalir = true;
			while (bSalir)
			{
				char * opciones[] = {
					"¿RECIBIÓ SU ESTADO DE CUENTA A FINALES DEL MES PASADO O INICIOS DE ESTE MES?",
					"       F1   SI                                ",
					"       F2   NO                                ",
					"       F3   NO SE                             ",
					"                                              ",
					"" };

				int respuesta[] = { F1,F2,F3,0 };

				C_Menu menu("ESTADO DE CUENTA", opciones, respuesta);

				switch (menu.OpcionSeleccionada())
				{
				case F1:
					bSalir = false;
					iFlag = 1;
					break;
				case F2:
					bSalir = false;
					iFlag = 2;
					break;
				case F3:
					bSalir = false;
					iFlag = 3;
					break;
				case ESC:
					bSalir = true;
					break;
				default:
					break;
				}
			}
		}

		iRegresa = buscarClienteEncuestado(iTipoEncuesta);

		if (iRegresa == 0)  //no esta encuestado el cte
		{
			if (m_grid.lCliente > 0)
			{
				grabarEncuesta(iFlag);
				actualizarTablaCaEncuestaCliente();
				incrementarTablaCaEncuesta();
			}
		}
	}
	return iFlag;
}

bool CDlgCapturarAbono::obtenerDatosGnDominio()
{
	char cLog[500] = { 0 };
	char cSql[302] = { 0 };
	bool bRetorno = false;

	sprintf_s(cLog, "FC0200805021521152 - entra - obtenerDatosGnDominio");
	grabarLog(cLog);

	CConsultarDatosGnDominio3 consultarDatosGnDominio(&odbc);

	sprintf_s(cSql, "SELECT nombresucursal,domicilio,numempgerentecajas,fecha,clientemaximo,ciudad,nombreciudad,telefono,permisogobernacion, salariominimo, TRIM(SUBSTRING(domiciliocompleto FROM 1 FOR 200)) AS domiciliocompleto, SUBSTRING(expedicion FROM 1 for 44) AS expedicion, foliopoliza, fechavigencia FROM gndominio");

	if (!consultarDatosGnDominio.Exec(cSql))
	{
		//Se obtiene el error
		consultarDatosGnDominio.odbc->GetLastError(consultarDatosGnDominio.GetHstmt());
		grabarMensajeError("C", m_grid.iCaja, (LPTSTR)(LPCTSTR)m_grid.sServer, "CapturarAbono", "CDlgCapturarAbono", "obtenerCiudadGnDominio", cSql, m_grid.lEmpleado, "ERROR EN LA CONSULTA(obtenerdatosgndominio)", consultarDatosGnDominio.odbc, m_grid.iMuestraMsg);
	}
	else
	{
		consultarDatosGnDominio.activarCols();
		if (consultarDatosGnDominio.leer())
		{
			sprintf_s(cNombreSucursal, "%s", consultarDatosGnDominio.nombresucursal);
			sprintf_s(cDomicilio, "%s", consultarDatosGnDominio.domicilio);
			sprintf_s(cPermiso, "%s", consultarDatosGnDominio.permisogobernacion);
			iCiudadGnDominio = consultarDatosGnDominio.ciudad;
			lNumeroGerente = consultarDatosGnDominio.numempgerentecajas;
			lClienteMaximo = consultarDatosGnDominio.clientemaximo;
			iDiaActual = (short)consultarDatosGnDominio.fecha.dia();
			iMesActual = (short)consultarDatosGnDominio.fecha.mes();
			iAnioActual = (short)consultarDatosGnDominio.fecha.ano();
			//cFechadominio=consultarDatosGnDominio.fecha;
			sprintf_s(cNombreCiudad, "%s", consultarDatosGnDominio.nombreciudad);
			sprintf_s(cTelefonoGnDominio, "%s", consultarDatosGnDominio.telefono);
			sprintf_s(cFechaTienda, "%04d-%02d-%02d", iAnioActual, iMesActual, iDiaActual);
			sprintf_s(cDomicilioCompleto, "%s", consultarDatosGnDominio.domiciliocompleto);
			cDomicilioCompleto[201] = 0;
			sprintf_s(cExpedicion, "%s", consultarDatosGnDominio.expedicion);
			lSalarioMinimo = consultarDatosGnDominio.salariominimo;
			sprintf_s(cExpedicion, "%s", consultarDatosGnDominio.expedicion);
			sprintf_s(cFechaVigencia, "%s", consultarDatosGnDominio.fechavigencia);
			sprintf_s(cPoliza, "%s", consultarDatosGnDominio.foliopoliza);
			bRetorno = true;
		}
	}
	return bRetorno;
}

void CDlgCapturarAbono::checarTipoEncuesta()
{
	char cLog[500] = { 0 };
	char cSql[85] = { 0 };

	sprintf_s(cLog, "FC0200805021521156 - entra - checarTipoEncuesta");
	grabarLog(cLog);

	CChecarEncuesta2 checarEncuesta(&odbc);
	lKeyxEncuesta = 0;
	grabarLog("CDlgCapturarAbono::checarTipoEncuesta");

	sprintf_s(cSql, "SELECT fecha,total30dias,totaledoscta,status,totalencuestar,keyx FROM caencuesta");

	if (!checarEncuesta.Exec(cSql))
	{
		//Se obtiene el error
		checarEncuesta.odbc->GetLastError(checarEncuesta.GetHstmt());
		grabarMensajeError("C", m_grid.iCaja, (LPTSTR)(LPCTSTR)m_grid.sServer, "CapturarAbono", "CDlgCapturarAbono", "obtenerCiudadGnDominio", cSql, m_grid.lEmpleado, "ERROR EN LA CONSULTA(checartipoencuesta)", checarEncuesta.odbc, m_grid.iMuestraMsg);
	}
	else
	{
		checarEncuesta.activarCols();
		while (checarEncuesta.leer())
		{
			if (checarEncuesta.status == 1)
			{
				if (iDiaActual >= checarEncuesta.fecha.dia() && iMesActual == checarEncuesta.fecha.mes() && iAnioActual == checarEncuesta.fecha.ano())
				{
					lTotal30Dias = checarEncuesta.total30dias;
					lTotalEdosCta = checarEncuesta.totaledoscta;
					iDiaEncuesta = checarEncuesta.fecha.dia();
					iMesEncuesta = checarEncuesta.fecha.mes();
					iAnioEncuesta = checarEncuesta.fecha.ano();
					iFlagExisteEncuesta = (int)checarEncuesta.status;
					lKeyxEncuesta = checarEncuesta.keyx;
					break;
				}
			}
		}
	}
}

long CDlgCapturarAbono::totalEncuestar()
{
	char cLog[500] = { 0 };
	char cSql[100] = { 0 };
	lTotalEncPeriodico = 0L;
	lTotalEncEdoCta = 0L;

	sprintf_s(cLog, "FC0200805021521160 - entra - totalEncuestar");
	grabarLog(cLog);

	CConsultarCaTotalEncuesta totalEncuestar(&odbc);
	sprintf_s(cSql, "SELECT totalencuestarperiodico, totalencuestaredocta FROM catotalencuestar WHERE ciudad = %d", iCiudadGnDominio);
	if (!totalEncuestar.Exec(cSql))
	{
		//Se obtiene el error
		totalEncuestar.odbc->GetLastError(totalEncuestar.GetHstmt());
		grabarMensajeError("C", m_grid.iCaja, (LPTSTR)(LPCTSTR)m_grid.sServer, "CapturarAbono", "CDlgCapturarAbono", "obtenerCiudadGnDominio", cSql, m_grid.lEmpleado, "ERROR EN LA CONSULTA(checartipoencuesta)", totalEncuestar.odbc, m_grid.iMuestraMsg);
	}
	else
	{
		totalEncuestar.activarCols();
		if (totalEncuestar.leer())
		{
			lTotalEncPeriodico = totalEncuestar.totalencuestarperiodico;
			lTotalEncEdoCta = totalEncuestar.totalencuestaredocta;
		}
	}
	return 1;
}

void CDlgCapturarAbono::checarEncuestas()
{
	char cLog[500] = { 0 };
	int iActualizar30Dias = 0, iActualizarEdos = 0;

	sprintf_s(cLog, "FC0200805021521164 - entra - checarEncuestas");
	grabarLog(cLog);

	if (iDiaActual >= 21)
	{
		if (lTotalEdosCta >= lTotalEncEdoCta)
		{
			lTotalEdosCta = -3L;
			iActualizarEdos = 1;
		}
	}
	if (iActualizarEdos == 1)
		actualizarTablaCaEncuestaEdosCtas();
}

void CDlgCapturarAbono::actualizarTablaCaEncuestaEdosCtas()
{
	char cLog[500] = { 0 };
	char cSql[100] = { 0 };

	sprintf_s(cLog, "FC0200805021521168 - entra - actualizarTablaCaEncuestaEdosCtas");
	grabarLog(cLog);

	sprintf_s(cSql, "UPDATE caencuestaedocta SET totaledoscta = %ld, status = 0 WHERE keyx = %ld", lTotalEdosCta, lKeyxEdoCtas);

	CMaximo actualizarTdBeneficiarios(&odbc);
	if (!actualizarTdBeneficiarios.Exec(cSql))
	{
		//Se obtiene el error
		actualizarTdBeneficiarios.odbc->GetLastError(actualizarTdBeneficiarios.GetHstmt());
		grabarMensajeError("C", m_grid.iCaja, (LPTSTR)(LPCTSTR)m_grid.sServer, "CapturarAbono", "CDlgCapturarAbono", "actualizarTablaTdBeneficiario", cSql, m_grid.lEmpleado, "ERROR EN LA CONSULTA(actualizartablacaencuesta)", actualizarTdBeneficiarios.odbc, m_grid.iMuestraMsg);
	}
}

bool CDlgCapturarAbono::buscarClienteCrCliente(int &iCiudadCliente, long &lColoniaCliente)
{
	char cLog[500] = { 0 };
	bool valorRegresa = false;
	CString sDato;
	char cSql[65] = { 0 };

	sprintf_s(cLog, "FC0200805021521172 - entra - buscarClienteCrCliente");
	grabarLog(cLog);

	sprintf_s(cSql, "SELECT ciudad,colonia FROM crcliente WHERE cliente = %ld", m_grid.lCliente);
	CCiudadColoniaCrCliente ciudadColoniaCrCliente(&odbc_1);

	if (!ciudadColoniaCrCliente.Exec(cSql))
	{
		//Se obtiene el error
		ciudadColoniaCrCliente.odbc->GetLastError(ciudadColoniaCrCliente.GetHstmt());
		grabarMensajeError("C", m_grid.iCaja, (LPTSTR)(LPCTSTR)m_grid.sServer, "CapturarAbono", "CDlgCapturarAbono", "buscarClienteCrcliente", cSql, m_grid.lEmpleado, "ERROR EN LA CONSULTA(buscarclientecrcliente)", ciudadColoniaCrCliente.odbc, m_grid.iMuestraMsg);
	}
	else
	{
		ciudadColoniaCrCliente.activarCols();
		if (ciudadColoniaCrCliente.Leer())
		{
			iCiudadCliente = ciudadColoniaCrCliente.ciudad;
			lColoniaCliente = ciudadColoniaCrCliente.colonia;
			sDato.Format("%03d%04d", ciudadColoniaCrCliente.ciudad, ciudadColoniaCrCliente.colonia);
			sDato.Trim();
			lCiudadColoniaCte = atol(sDato);
			valorRegresa = true;
		}
	}
	return valorRegresa;
}

bool CDlgCapturarAbono::buscarNombreColonia(int &iCiudadCliente, long &lColoniaCliente, char *cNombreColonia)
{
	char cLog[500] = { 0 };
	bool valorRegresa = false;
	char cSql[80] = { 0 };

	sprintf_s(cLog, "FC0200805021521176 - entra - buscarNombreColonia");
	grabarLog(cLog);

	sprintf_s(cSql, "SELECT nombrezona FROM crzonas WHERE ciudad=%d AND colonia = %ld", iCiudadCliente, lColoniaCliente);

	CNombreColoniaCrZonas nombreColoniaCrZonas(&odbc_1);

	if (!nombreColoniaCrZonas.Exec(cSql))
	{
		//Se obtiene el error
		nombreColoniaCrZonas.odbc->GetLastError(nombreColoniaCrZonas.GetHstmt());
		grabarMensajeError("C", m_grid.iCaja, (LPTSTR)(LPCTSTR)m_grid.sServer, "CapturarAbono", "CDlgCapturarAbono", "buscarNombreColonia", cSql, m_grid.lEmpleado, "ERROR EN LA CONSULTA(buscarclientecrcliente)", nombreColoniaCrZonas.odbc, m_grid.iMuestraMsg);
	}
	else
	{
		nombreColoniaCrZonas.activarCols();
		if (nombreColoniaCrZonas.Leer())
		{
			sprintf(cNombreColonia, "%s", nombreColoniaCrZonas.nombrezona);
			valorRegresa = true;
		}
	}
	return valorRegresa;
}

bool CDlgCapturarAbono::grabarEncuesta(int iFlag)
{
	char cLog[500] = { 0 };
	bool valorRegresa = false;
	char cSql[200] = { 0 }, cCasaPropia[3] = { 0 }, cClave[3] = { 0 }, cNipTitular[5] = { 0 }, cZona[10] = { 0 };

	sprintf_s(cLog, "FC0200805021521180 - entra - grabarEncuesta");
	grabarLog(cLog);

	switch (iFlag)
	{
	case 1:
		cCasaPropia[0] = 'S'; // Si
		break;
	case 2:
		cCasaPropia[0] = 'N'; // No
		break;
	case 3:
		cCasaPropia[0] = 'X'; // No se
		break;
	default:
		break;
	}
	cCasaPropia[1] = 0;

	if (GetSetTipoBiometrizado(VALIDACION_HUELLA_ENCUESTAS) == VALIDACION_BIOMETRIZADA_TITULAR)
	{
		cNipTitular[0] = 'S';
	}
	else
	{
		if (iFlagEdoCuenta != 1) // No hizo encuesta de Edo Cta.
			cNipTitular[0] = 'S';   // Periodico Coppel por default se pone como titular.
		else
			cNipTitular[0] = 'N'; //Si si hizo de Edo Cta, se le hace caso al iTitular...
	}
	cNipTitular[1] = ' ';

	if (iTipoEncuesta == 1) // Periodico
	{
		cClave[0] = 'P';
		cClave[1] = 0;

		if (iFlagPeriodico == 1)
		{
			cNipTitular[2] = 'S'; //si conoce el periodico coppel
		}
		else
		{
			cNipTitular[2] = 'N'; //no conoce el periodico coppel
		}
		cNipTitular[3] = 0;
	}
	else
	{
		cClave[0] = 'U';
		cClave[1] = 0;
		cNipTitular[2] = 0;
	}

	if (lZonaEncuestado > 0)
	{
		sprintf_s(cZona, "%07ld", lZonaEncuestado);
	}
	else
	{
		sprintf_s(cZona, "%07ld", lCiudadColoniaCte);
	}

	sprintf_s(cSql, "SELECT cagrabarencuesta( '%c','%c','%ld','%s','%s','%s','%ld','%ld','%d','%d','%ld','%s' )",
		cClave[0],
		cCasaPropia[0],
		m_grid.lCliente,
		cNombreEncuestado,
		cApellidoPaternoEncuestado,
		cApellidoMaternoEncuestado,
		m_grid.lEmpleado,
		lTelefonoEncuestado,
		(short)valor_campo(cZona, 3),  //ciudad
		(short)valor_campo(&cZona[3], 4), //zona
		lNumeroGerente,
		cNipTitular);

	CMaximo FlagCoppel(&odbc);
	if (FlagCoppel.Exec(cSql))
	{
		FlagCoppel.activarCols();
		if (FlagCoppel.Leer())
		{
			iFlag = (int)FlagCoppel.Total;
			valorRegresa = true;
		}
	}
	else
	{
		//Se obtiene el error
		FlagCoppel.odbc->GetLastError(FlagCoppel.GetHstmt());
		grabarMensajeError("C", m_grid.iCaja, (LPTSTR)(LPCTSTR)m_grid.sServer, "CapturarAbono", "CDlgCapturarAbono", "grabarEncuesta", cSql, m_grid.lEmpleado, "ERROR EN LA CONSULTA(grabarEncuesta)", FlagCoppel.odbc, m_grid.iMuestraMsg);
	}
	return valorRegresa;
}

int CDlgCapturarAbono::buscarClienteEncuestado(int iTipo)
{
	char cLog[500] = { 0 };
	char cSql[100] = { 0 };
	int iFlag = 0;

	sprintf_s(cLog, "FC0200805021521184 - entra - buscarClienteEncuestado");
	grabarLog(cLog);

	CBuscarClienteEncuestado buscarClienteEncuestado(&odbc);
	if (iTipo == 0)  //encuestas edo de cuenta
	{
		sprintf_s(cSql, "SELECT tipo,cliente,fecha from caencuestacliente WHERE cliente = %ld and tipo = '1' ", m_grid.lCliente);
	}
	else
	{
		//encuestas periodico 30 dias
		sprintf_s(cSql, "SELECT tipo,cliente,fecha from caencuestacliente WHERE cliente = %ld and tipo = '2' ", m_grid.lCliente);
	}

	if (!buscarClienteEncuestado.Exec(cSql))
	{
		//Se obtiene el error
		buscarClienteEncuestado.odbc->GetLastError(buscarClienteEncuestado.GetHstmt());
		grabarMensajeError("C", m_grid.iCaja, (LPTSTR)(LPCTSTR)m_grid.sServer, "CapturarAbono", "CDlgCapturarAbono", "buscarClienteEncuestado", cSql, m_grid.lEmpleado, "ERROR EN LA CONSULTA(buscarclienteencuestado)", buscarClienteEncuestado.odbc, m_grid.iMuestraMsg);
	}
	else
	{
		buscarClienteEncuestado.activarCols();
		if (buscarClienteEncuestado.leer())
		{
			iFlag = 1;
		}
	}
	return iFlag;
}

int CDlgCapturarAbono::actualizarTablaCaEncuestaCliente()
{
	char cLog[500] = { 0 };
	int iFlag = 0;

	sprintf_s(cLog, "FC0200805021521188 - entra - actualizarTablaCaEncuestaCliente");
	grabarLog(cLog);

	CBuscarClienteEncuestado buscarClienteEncuestado(&odbc);

	buscarClienteEncuestado.activarCols();
	buscarClienteEncuestado.prepararInsert();

	if (iTipoEncuesta == 0)
	{
		buscarClienteEncuestado.tipo[0] = '1';
	}
	else
	{
		buscarClienteEncuestado.tipo[0] = '2';
	}
	buscarClienteEncuestado.tipo[1] = 0;

	buscarClienteEncuestado.cliente = m_grid.lCliente;

	buscarClienteEncuestado.fecha.ponerFecha(iDiaActual, iMesActual, iAnioActual);

	if (!buscarClienteEncuestado.Insert())
	{
		AfxMessageBox("Error al insertar en la tabla CaEncuestaCliente( actualizarTablaCaEncuestaCliente )");
	}
	else
	{
		buscarClienteEncuestado.Commit();
		iFlag = 1;
	}
	return iFlag;
}

bool CDlgCapturarAbono::incrementarTablaCaEncuesta()
{
	char cLog[500] = { 0 };
	bool valorRegresa = false;
	char cSql[80] = { 0 };

	sprintf_s(cLog, "FC0200805021521192 - entra - incrementarTablaCaEncuesta");
	grabarLog(cLog);

	if (iTipoEncuesta == 0)
	{
		if (lTotalEdosCta == 0)
			sprintf_s(cSql, "UPDATE caencuestaedocta SET totaledoscta = 1 WHERE keyx = %d", lKeyxEdoCtas);
		else
			sprintf_s(cSql, "UPDATE caencuestaedocta SET totaledoscta = totaledoscta+1 WHERE keyx = %d", lKeyxEdoCtas);
	}
	else
	{
		sprintf_s(cSql, "UPDATE caencuesta SET total30dias = total30dias+1 WHERE keyx = %d", lKeyxEncuesta);
	}

	CMaximo actualizarTdBeneficiarios(&odbc);
	if (!actualizarTdBeneficiarios.Exec(cSql))
	{
		//Se obtiene el error
		actualizarTdBeneficiarios.odbc->GetLastError(actualizarTdBeneficiarios.GetHstmt());
		grabarMensajeError("C", m_grid.iCaja, (LPTSTR)(LPCTSTR)m_grid.sServer, "CapturarAbono", "CDlgCapturarAbono", "actualizarTablaTdBeneficiario", cSql, m_grid.lEmpleado, "ERROR EN LA CONSULTA(incrementartablacaencuesta)", actualizarTdBeneficiarios.odbc, m_grid.iMuestraMsg);
	}
	else
	{
		valorRegresa = true;
	}
	return valorRegresa;
}

void CDlgCapturarAbono::OnEnSetfocusCliente()
{
	char cLog[500] = { 0 };

	sprintf_s(cLog, "FC0200805021521196 - entra - OnEnSetfocusCliente");
	grabarLog(cLog);
	// TODO: Add your control notification handler code here
	validarClick(0);
}

bool CDlgCapturarAbono::checarPagos(int iCuentas)
{
	char cLog[500] = { 0 };
	//  Checa los pagos cuando son cargos a ctes.!
	long lPago = 0;
	int i = 0;
	bool bRegresa = true;
	CString sDato;

	sprintf_s(cLog, "FC0200805021521200 - entra - checarPagos");
	grabarLog(cLog);

	for (i = 0; i < iCuentas; i++)
	{
		m_grid.QuickGetText(i, 21, &sDato);
		lPago = atol(sDato);
		if (lPago > 0)
			bRegresa = false;
	}

	return bRegresa;
}

void CDlgCapturarAbono::pedirPago()
{
	char cLog[500] = { 0 };
	long lPagoCte = 0;
	int iRecibePago = 0, iColumna = 0;
	CUGCell m_cell;
	CString sPagoCte;
	char cIpTiendaNumero[20] = { 0 };
	long lClienteAux = m_grid.lCliente;

	sprintf_s(cLog, "FC0200805021521204 - entra - pedirPago");
	grabarLog(cLog);

	sprintf_s(cLog, "pedirPago::Empieza grabado del abono Cliente = %ld", lClienteAux);
	grabarLog(cLog);

	iRecibePago = 0;
	asignarFoco();
	iColumna = m_grid.GetCurrentCol(); //obtener la columna donde esta posicionado

	if (m_grid.lCliente == 1708L)
	{
		m_grid.QuickGetText(0, 21, &sPagoCte);
	}
	else
	{
		m_grid.QuickGetText(iColumna, 21, &sPagoCte);
	}
	lPagoCte = atol(sPagoCte);

	if (lPagoCte == 0L && m_grid.lCliente == 1708L) iRecibePago = 1;
	if (iFlagMovimiento == 0 && !checarPagos(iTotalCuentas))
		iRecibePago = 1;

	if (iRecibePago == 0)
	{
		if (recibirPagoCa())
		{
			sprintf_s(cLog, "pedirPago::Inicializando captura");
			grabarLog(cLog);

			if ((iFlagReactivo == 1 || iFlagNuevo == 1) && iFlagPago == 1)
			{
				seguroReactivado();

				if (iFlagImpresoraTermica == 1)
				{
					imprimirPolizaSeguroClubTermica(0, 0, 1, iRespuestaPoliza, 0, 0);
				}
				else
				{
					imprimirPolizaSeguroClub(0, iConyugal);
					imprimirPolizaSeguroClub(1, iConyugal);
				}
			}

			inicializarCaptura();
		}

		odbc.Close();

		if (!abrirConexionBD(&odbc, (LPTSTR)(LPCTSTR)m_grid.sServer, (LPTSTR)(LPCTSTR)m_grid.sServer, CONECTA_TIENDANUMERO, m_grid.iTienda))
		{
			AfxMessageBox(" NO SE PUDO ESTABLECER CONEXIÓN BD TIENDA.#### ");
			OnCancel();
			inicializar();
			inicializarCaptura();
		}
	}
	sprintf_s(cLog, "FC0200805021521206 - fin - pedirPago - Termina grabado del abono cliente = %ld", lClienteAux);
	grabarLog(cLog);
}

long CDlgCapturarAbono::obtenerTotalImporteConvenios()
{
	char cLog[500] = { 0 };
	int i = 0;
	long lImporte = 0L, lImporteConvenio = 0L;
	CString sImporteConvenio;
	CUGCell m_cell;

	sprintf_s(cLog, "FC0200805021521208 - entra - obtenerTotalImporteConvenios");
	grabarLog(cLog);

	for (i = 0; i < iTotalCuentas; i++)
	{
		m_grid.QuickGetText(i, 10, &sImporteConvenio);
		lImporteConvenio = atol(sImporteConvenio);
		lImporte += lImporteConvenio;
	}
	return lImporte;
}

void CDlgCapturarAbono::desplegarPaginaSeguros(int iFlagReactivo, int iFlagIncrementa, int iColumna, CDlgCapturarDatosSeguro &dlgCapturarDatosSeguro, int iFlagAfiliar)
{
	char cLog[500] = { 0 };
	long lFecha1 = 0L, lFecha2 = 0L, lCuota = 0L, lCuotaAdicional = 0L, lCuotaAdicionalNuevos = 0L, lCuotaTotal = 0L;
	char cTexto[40] = { 0 }, cTxt[20] = { 0 };
	int iDia = 0, iMes = 0, iAnio = 0, iFlagConyugal = 0, iNumSegs = 0, j = 0, iFlagConsulta = 0, iNoDesplegar = 0, iFlagEsClub = 0,
		iDiaVencimientoAnterior = 0, iMesVencimientoAnterior = 0, iAnioVencimientoAnterior = 0;
	CString sDato, sFechaVencimientoAnterior;
	short iNumMeses = 0;
	char cSqlTxt[255] = { 0 }, cFechaVen[10] = { 0 }, cStatusCuenta[10] = { 0 }, cDescripcion[20] = { 0 };
	bool bConsulta = false;

	sprintf_s(cLog, "FC0200805021521212 - entra - desplegarPaginaSeguros");
	grabarLog(cLog);

	if (iFlagAfiliar == 1) //desplegar cuenta para afiliar al seguro club
	{
		for (j = 0; j < 35; j++) //ciclo para blanquear toda la cuenta
		{
			sDato.Format("");
			m_grid.QuickSetText(iColumna, j, sDato);
			m_grid.RedrawCell(iColumna, j);
		}
		m_grid.QuickSetText(iColumna, -1, "P.FAMILIAR");
		iDiaVencimientoAnterior = 0;
		iMesVencimientoAnterior = 0;
		iAnioVencimientoAnterior = 0;
		dlgCapturarDatosSeguro.iEsSeguroClub = iConyugal;
		dlgCapturarDatosSeguro.iNumSeguros = 1;
		dlgCapturarDatosSeguro.iDiaVencimiento = 0;
		dlgCapturarDatosSeguro.iMesVencimiento = 0;
		dlgCapturarDatosSeguro.iAnioVencimiento = 0;
		dlgCapturarDatosSeguro.iEdad = (int)iAnioActual - iAnioNacimiento;
		if ((int)iMesNacimiento > iMesActual)
		{
			dlgCapturarDatosSeguro.iEdad--;
		}
		iFlagConyugal = -1;
		iNumSegs = 1;
		iNumMeses = 1;
		iFlagDatosSeguro = 1;
		iNoDesplegar = 1;
	}
	else
	{
		m_grid.QuickGetText(iColumna, 24, &sDato);
		iFlagConyugal = atol(sDato);

		m_grid.QuickGetText(iColumna, 22, &sDato);
		iNumSegs = atol(sDato);

		m_grid.QuickGetText(iColumna, 23, &sDato);
		iNumMeses = (short)atol(sDato);

		m_grid.QuickGetText(iColumna, 33, &sFechaVencimientoAnterior);

		m_grid.QuickGetText(iColumna, -1, &sDato);
		sDato.Trim();
		sprintf_s(cDescripcion, "%s", (LPCTSTR)sDato);

		if (memcmp(cDescripcion, "P.FAMILIAR", 10) == 0) // para saber si es seguro club
		{
			iFlagEsClub = 1;
		}
		else
		{
			iFlagEsClub = 0;
		}

		memcpy(cFechaVen, sFechaVencimientoAnterior, 8);
		cFechaVen[8] = 0;
		if (bBanderaTieneClub == false && iFlagEsClub == 1)
		{
			iDiaVencimientoAnterior = iDiaActual;
			iMesVencimientoAnterior = iMesActual;
			iAnioVencimientoAnterior = iAnioActual;
			sFechaVencimientoAnterior.Format("%02d%02d%04d", iDiaActual, iMesActual, iAnioActual);
			m_grid.QuickSetText(iColumna, 33, sFechaVencimientoAnterior);
		}
		else
		{
			iDiaVencimientoAnterior = valor_campo(&cFechaVen[0], 2);
			iMesVencimientoAnterior = valor_campo(&cFechaVen[2], 2);
			iAnioVencimientoAnterior = valor_campo(&cFechaVen[4], 4);
		}
	}

	if (iFlagConyugal == 1 && dlgCapturarDatosSeguro.iEsSeguroClub != 1 && dlgCapturarDatosSeguro.iEsSeguroClub != 2)
	{
		m_grid.QuickSetText(iColumna, 15, "CUOTA CONYUG");
		m_grid.QuickSetAlignment(iColumna, 15, UG_ALIGNCENTER);
	}
	else
	{
		m_grid.QuickSetText(iColumna, 15, "CUOTA");
		m_grid.QuickSetAlignment(iColumna, 15, UG_ALIGNCENTER);
	}
	lFecha1 = (long)iAnioActual*(long)12 + (long)iMesActual;
	lFecha2 = (long)iAnioNacimiento*(long)12 + (long)iMesNacimiento;
	if (iFlagDatosSeguro == 1)
	{
		if (iFlagBanorte != 0 && (dlgCapturarDatosSeguro.iEsSeguroClub == 1 || dlgCapturarDatosSeguro.iEsSeguroClub == 2))
		{
			if (iConyugal == 1)
			{
				grabarLog("Consulta Precio seguro 5");
				if (consultarPrecioSeguroClub(lCuota, (short)iNumSegs, 1))
				{
					bConsulta = true;
					iFlagConsulta = 1;
				}
			}
			else
			{
				lCuota = obtenerCuotaClub(m_grid.lCliente, iNumSegs, iNumMeses, iFlagBanorte, &odbc, &odbc_1, cSqlTxt, bConsulta, iFlagConsulta, iConyugal); //cawcuota.cpp            
			}

			if (bConsulta != true && iFlagConsulta != 1)
			{
				grabarMensajeError("C", m_grid.iCaja, (LPTSTR)(LPCTSTR)m_grid.sServer, "CA0030", "CDlgCapturarAbono", "desplegarPaginaSeguros", (LPTSTR)(LPCTSTR)cSqlTxt, m_grid.lEmpleado, "ERROR EN LA CONSULTA(desplegarpaginaseguros)", &odbc, m_grid.iMuestraMsg);
				lCuota = 0;
			}
		}
		else
		{
			lCuota = obtenerCuotaSeguro(iAnioNacimiento, iMesNacimiento, &odbc, cSqlTxt, bConsulta, iFlagConsulta);
			if (bConsulta != true && iFlagConsulta != 1)
			{
				grabarMensajeError("C", m_grid.iCaja, (LPTSTR)(LPCTSTR)m_grid.sServer, "CA0030", "CDlgCapturarAbono", "desplegarPaginaSeguros", (LPTSTR)(LPCTSTR)cSqlTxt, m_grid.lEmpleado, "ERROR EN LA CONSULTA(desplegarpaginaseguros 2)", &odbc, m_grid.iMuestraMsg);
				lCuota = 0;
			}
			if (iFlagCapturoBeneficiariosClubNuevo == 0 && dlgCapturarDatosSeguro.iEsSeguroClub > 0)
			{
				lCuota = 0L;
				iNumMeses = 0;
			}
		}

		lCuotaClub = lCuota;

		if ((iFlagTieneSeguroAdicional == 1 || iFlagCapturoSeguroAdicional == 1) && iFlagEsClub == 1 && iColumna == iColumnaClub)
		{
			iNumMesesAdicional = iNumMeses;

			m_grid.QuickGetText(iColumna, 29, &sDato);
			if (atoi(sDato) == 1) //Si no esta vencido
			{
				consultarCrSegurosFechaMesVence();
			}

			obtenerPreciosSegurosAdicionales(lCuotaAdicionalNuevos);
			lCuotaAdicional = consultarCuotaAdicionales(false); //Obtiene la cuota de los seguros adicionales que ya tenia el cliente
			lImporteAdicionalesNuevos = (lCuotaAdicionalNuevos * iNumMesesAdicional); //Importe Adicionales Nuevos
			lCuotaTotal = (lCuotaClub + lCuotaAdicional) * iNumMeses + lImporteAdicionalesNuevos; //Para saber el total a pagar de los seguros del cliente
			lCuota = lCuotaClub + lCuotaAdicionalNuevos + lCuotaAdicional;  //Obtiene la cuota total de los seguros del cliente por mes
		}

		usingx("###,###", cTexto, (double)lCuota);
		m_grid.QuickSetText(iColumna, 16, cTexto);
		m_grid.QuickSetAlignment(iColumna, 16, UG_ALIGNRIGHT);
	}
	{
		//sDato.Format(" SEGS   %ld", dlgCapturarDatosSeguro.iNumSeguros );
		sDato.Format("%s", cPlanSeguroClub);
		m_grid.QuickSetText(iColumna, 12, sDato);
		m_grid.QuickSetAlignment(iColumna, 12, UG_ALIGNRIGHT);
		sprintf_s(cStatusCuenta, "%s", (LPCTSTR)sDato);
	}

	m_grid.QuickGetText(iColumna, 30, &sDato);   //status para saber si es nuevo el seguro        
	if (dlgCapturarDatosSeguro.iEsSeguroClub == 1 || dlgCapturarDatosSeguro.iEsSeguroClub == 2)
	{
		if (((int)dlgCapturarDatosSeguro.iDiaVencimiento == 0 && (int)dlgCapturarDatosSeguro.iMesVencimiento == 0) ||
			cStatusCuenta[0] == 0 || bBanderaTieneClub == false)
		{
			if (iConyugal == 1)
			{
				m_grid.QuickSetText(iColumna, 1, "       ");
				m_grid.QuickSetAlignment(iColumna, 1, UG_ALIGNCENTER);
				m_grid.QuickSetText(iColumna, 2, "AFILIAR");
				m_grid.QuickSetAlignment(iColumna, 2, UG_ALIGNCENTER);

				//9923 --> CAMBIAR TAMAÑO DE LETRA
				int fontID = m_grid.AddFont("Lucida Console Bold", 14, 600);
				m_grid.QuickSetFont(iColumna, 3, fontID);
				m_grid.QuickSetText(iColumna, 3, " P.FAMILIAR ");
				m_grid.QuickSetAlignment(iColumna, 3, UG_ALIGNCENTER);
			}
			else
			{
				m_grid.QuickSetText(iColumna, 1, "AFILIAR");
				m_grid.QuickSetAlignment(iColumna, 1, UG_ALIGNCENTER);
				m_grid.QuickSetText(iColumna, 2, "AL CLUB");
				m_grid.QuickSetAlignment(iColumna, 2, UG_ALIGNCENTER);
				m_grid.QuickSetText(iColumna, 3, "CONYUGAL");
				m_grid.QuickSetAlignment(iColumna, 3, UG_ALIGNCENTER);
			}
		}
		else
		{
			m_grid.QuickSetText(iColumna, 2, "AFILIADO");
			m_grid.QuickSetAlignment(iColumna, 2, UG_ALIGNCENTER);

			int fontID = m_grid.AddFont("Lucida Console Bold", 14, 600);
			m_grid.QuickSetFont(iColumna, 3, fontID);
			m_grid.QuickSetText(iColumna, 3, " P.FAMILIAR ");
			m_grid.QuickSetAlignment(iColumna, 3, UG_ALIGNCENTER);
		}
	}
	else
	{
		m_grid.QuickSetText(iColumna, 3, "VENCE");
		m_grid.QuickSetAlignment(iColumna, 3, UG_ALIGNCENTER);
	}
	if (iFlagReactivo == 1 && iFlagIncrementa == 1 && (dlgCapturarDatosSeguro.iEsSeguroClub == 1 || dlgCapturarDatosSeguro.iEsSeguroClub == 2)) iNumMeses = 1;
	if (iNumMeses != 0)
	{
		iDia = (int)dlgCapturarDatosSeguro.iDiaVencimiento;
		iMes = (int)dlgCapturarDatosSeguro.iMesVencimiento;
		iAnio = (int)dlgCapturarDatosSeguro.iAnioVencimiento;
		if (iFlagBanorte != 0 && (dlgCapturarDatosSeguro.iEsSeguroClub == 1 || dlgCapturarDatosSeguro.iEsSeguroClub == 2))
		{
			//gnwvense.cpp
			iDia = iDiaVencimientoAnterior;
			iMes = iMesVencimientoAnterior;
			iAnio = iAnioVencimientoAnterior;
			calcularVencimientoClub(iDia, iMes, iAnio, iNumMeses, iDiaActual, iMesActual, iAnioActual);
		}
		else
		{
			//cawvense.cpp         
			iDia = iDiaVencimientoAnterior;
			iMes = iMesVencimientoAnterior;
			iAnio = iAnioVencimientoAnterior;
			calcularFechaVencimientoSeguroAfirme(iNumMeses, iDia, iMes, iAnio, iDiaActual, iMesActual, iAnioActual);
		}
		sDato.Format("# MESES  %d", iNumMeses);
		m_grid.QuickSetText(iColumna, 13, sDato);
		m_grid.QuickSetAlignment(iColumna, 13, UG_ALIGNCENTER);

		if (dlgCapturarDatosSeguro.iEsSeguroClub != 1 || dlgCapturarDatosSeguro.iEsSeguroClub != 2)
		{
			//sDato.Format(" SEGS   %ld", dlgCapturarDatosSeguro.iNumSeguros );
			sDato.Format("%s", cPlanSeguroClub);
			m_grid.QuickSetText(iColumna, 12, sDato);
			m_grid.QuickSetAlignment(iColumna, 12, UG_ALIGNCENTER);
		}

		if (!bBanderaTieneClub && iFlagBanorte == 4 && iFlagEsClub == 1 && iFlagMesRegalado == 1) //si no tiene seguro club
		{
			if (iDia == 31)
			{
				if (iMes + 1 == 4 || iMes + 1 == 6 || iMes + 1 == 9 || iMes + 1 == 11)
				{
					iDia = 30;
				}
			}

			if ((iMes + 1) == 2 && iDia >= 28)
			{
				iDia = 28;
				if (checar_bisiesto(ano_2000_2dig(iAnio)) == 1) iDia = 29;
			}

			if ((iMes + 1) > 12)
			{
				miniFecha(cTexto, (int)iDia, (int)1, (int)(iAnio + 1));
				sprintf_s(cTxt, "%02d%02d%04d", (int)iDia, (int)1, (int)(iAnio + 1));
			}
			else
			{
				miniFecha(cTexto, (int)iDia, (int)(iMes + 1), (int)iAnio);
				sprintf_s(cTxt, "%02d%02d%04d", (int)iDia, (int)(iMes + 1), (int)iAnio);
			}
		}
		else
		{
			miniFecha(cTexto, (int)iDia, (int)iMes, (int)iAnio);
			sprintf_s(cTxt, "%02d%02d%04d", iDia, iMes, iAnio);
		}
		if ((cStatusCuenta[0] == '1' && bBanderaTieneClub == true) || dlgCapturarDatosSeguro.iEsSeguroClub != 1 || dlgCapturarDatosSeguro.iEsSeguroClub != 2)
		{
			if (iNoDesplegar == 0)
			{
				m_grid.QuickSetText(iColumna, 4, cTexto);
				m_grid.QuickSetAlignment(iColumna, 4, UG_ALIGNCENTER);
			}
		}
		m_grid.QuickSetText(iColumna, 25, cTxt);
		m_grid.QuickSetAlignment(iColumna, 25, UG_ALIGNCENTER);
	}
	else
	{
		//para cuando cartera procese a¤o >= 2000 con nulos
		if (iAnio < 50) iAnio += 100;
		lFecha1 = (long)iAnioActual * 372L +
			(long)iMesActual * 31L +
			(long)iDiaActual;
		lFecha2 = (long)ano_2000_4dig(iAnio, iAnioActual) * 372L +
			(long)iMes * 31L +
			(long)iDia;
		miniFecha(cTexto, (int)iDia,
			(int)iMes,
			(int)iAnio);
		if (lFecha1 > lFecha2)
		{
			if ((int)iDia > 0 && (int)iMes > 0)
			{
				m_grid.QuickSetText(iColumna, 3, "VENCIO EL");
				m_grid.QuickSetAlignment(iColumna, 3, UG_ALIGNCENTER);

				if (cStatusCuenta[0] == '1'  && bBanderaTieneClub == true)
				{
					m_grid.QuickSetText(iColumna, 8, cTexto);
					m_grid.QuickSetAlignment(iColumna, 8, UG_ALIGNCENTER);
				}
			}
		}
		else
		{
			if (cStatusCuenta[0] == '1'  && bBanderaTieneClub == true)
			{
				m_grid.QuickSetText(iColumna, 8, cTexto);
				m_grid.QuickSetAlignment(iColumna, 8, UG_ALIGNCENTER);
			}
		}
	}

	if (dlgCapturarDatosSeguro.iEsSeguroClub == 1 || dlgCapturarDatosSeguro.iEsSeguroClub == 2)
	{
		if ((iFlagTieneSeguroAdicional == 0 && iFlagCapturoSeguroAdicional == 0) || iColumna != iColumnaClub)
		{
			usingx("#####", cTexto, (double)lCuota * iNumMeses);
		}
		else
		{
			usingx("#####", cTexto, (double)lCuotaTotal);
		}
	}
	else
	{
		usingx("#####", cTexto, (double)lCuota * (iNumMeses * iNumSegs));
	}
	if (iFlagAfiliar == 1)
	{
		usingx("#", cTexto, (double)0);
	}
	m_grid.QuickSetText(iColumna, 21, cTexto);
	m_grid.QuickSetAlignment(iColumna, 21, UG_ALIGNRIGHT);
	m_grid.RedrawAll();
	m_grid.obtenerTotalAbono();
}

long CDlgCapturarAbono::obtenerMontoSeguro()
{
	char cLog[500] = { 0 };
	char cSql[50] = { 0 };
	long lMonto = 0L;

	sprintf_s(cLog, "FC0200805021521221 - entra - obtenerMontoSeguro");
	grabarLog(cLog);

	sprintf_s(cSql, "SELECT monto FROM caSegurosSys WHERE compania=1");

	CMaximo obtenerMontoSeguro(&odbc);

	if (!obtenerMontoSeguro.Exec(cSql))
	{
		//Se obtiene el error
		obtenerMontoSeguro.odbc->GetLastError(obtenerMontoSeguro.GetHstmt());
		grabarMensajeError("C", m_grid.iCaja, (LPTSTR)(LPCTSTR)m_grid.sServer, "CapturarAbono", "CDlgCapturarAbono", "obtenerMontoSeguro", cSql, m_grid.lEmpleado, "ERROR EN LA CONSULTA(obtenermontoseguro)", obtenerMontoSeguro.odbc, m_grid.iMuestraMsg);
	}
	else
	{
		obtenerMontoSeguro.activarCols();
		while (obtenerMontoSeguro.Leer())
		{
			lMonto = obtenerMontoSeguro.Total;
			break;
		}
	}
	return lMonto;
}

bool CDlgCapturarAbono::obtenerFlag(char cArea, int iTipo, int &iFlag)
{
	bool bRetorna = false;
	char cSql[40] = { 0 };

	sprintf_s(cSql, "SELECT gnconsultarflag('%c','%d')", cArea, iTipo);

	CMaximo FlagCoppel(&odbc);
	if (FlagCoppel.Exec(cSql))
	{
		FlagCoppel.activarCols();
		if (FlagCoppel.Leer())
		{
			iFlag = (int)FlagCoppel.Total;
			bRetorna = true;
		}
	}
	else
	{
		//Se obtiene el error
		FlagCoppel.odbc->GetLastError(FlagCoppel.GetHstmt());
		grabarMensajeError("C", m_grid.iCaja, (LPTSTR)(LPCTSTR)m_grid.sServer, "capturarabono", "CDlgCapturarAbono", "obtenerFlag", cSql, m_grid.lEmpleado, "ERROR EN LA CONSULTA(obtenerflag)", FlagCoppel.odbc, m_grid.iMuestraMsg);
	}

	return bRetorna;
}

bool CDlgCapturarAbono::consultarFolioCajas()
{
	char cLog[500] = { 0 };
	bool bResultado = false;
	char cSql[55] = { 0 };
	lNumeroConsulta = 0;

	sprintf_s(cLog, "FC0200805021521229 - entra - consultarFolioCajas");
	grabarLog(cLog);

	if (iSistema == 1)
	{
		sprintf_s(cSql, "SELECT gnincrementarfolio('M', '99', '7', '0' )");
	}
	else if (iSistema == 2)
	{
		sprintf_s(cSql, "SELECT gnincrementarfolio('R', '98', '7', '0' )");
	}
	else if (iSistema == 3 || iSistema == 7)
	{
		sprintf_s(cSql, "SELECT gnincrementarfolio('C', '%d', '7', '0' )", m_grid.iCaja);
	}

	CMaximo folioCoppel(&odbc, false);
	if (folioCoppel.Exec(cSql))
	{
		folioCoppel.activarCols();
		if (folioCoppel.Leer())
		{
			lNumeroConsulta = (long)folioCoppel.Total;
			bResultado = true;
		}
	}
	else
	{
		//Se obtiene el error
		folioCoppel.odbc->GetLastError(folioCoppel.GetHstmt());
		grabarMensajeError("C", m_grid.iCaja, (LPTSTR)(LPCTSTR)m_grid.sServer, "CapturarAbono", "CDlgCapturarAbono", "consultarFolioCajas", cSql, m_grid.lEmpleado, "ERROR EN LA CONSULTA(incrementarfoliocajas)", folioCoppel.odbc, m_grid.iMuestraMsg);
	}
	return  bResultado;
}

bool CDlgCapturarAbono::recibirPagoCa(void)
{
	char cLog[500] = { 0 };
	bool valorRegresa = false, bContinuar = false, bRespuestaGral = false;
	int iFlag = 0, iHora = 0, iMinutos = 0, iSegundos = 0, iModulo = 0, iFlagTelefonos = 0;
	char cSqlTxt[255] = { 0 }, cSer[20] = { 0 };
	char cArchivo[80] = { 0 }, cMensaje[200] = { 0 };

	sprintf_s(cLog, "FC0200805021521233 - entra - recibirPagoCa");
	grabarLog(cLog);

	consultarFolioCajas();

	sprintf_s(cMensaje, "recibirPagoCa::Recibo = %ld", lNumeroConsulta);
	grabarLog(cMensaje);

	obtenerTotalAbonoCuentasPagoServicio(m_grid2.lTotalAbonos);
	lTotalAPagar = m_grid2.lTotalAbonos;

	if ((m_grid.lCliente == 1708L) || (lTotalAPagar != 0L) || (iFlagConvenioTerminado == 1))
	{
		//poner flag si es uno o dos entra a esta logica
		if (iFlagVolante == 1 || iFlagVolante == 2)
		{
			darVolanteRopa();
			darVolanteMuebles();
		}

		char cNombreProyecto[100] = { 0 }, cNombreFuncionDLL[10] = { 0 }, cInputParam1[1024] = { 0 }, cInputParam2[1024] = { 0 }, cOutputParam1[1024] = { 0 }, cOutputParam2[1024] = { 0 };

		SParametros parametros;
		memset(&parametros, 0, sizeof(SParametros));

		parametros.iLink = generarLink();
		sprintf_s(parametros.sServer, "%s", m_grid.sServer);
		parametros.iTienda = m_grid.iTienda;
		parametros.lEmpleado = m_grid.lEmpleado;
		parametros.iCajaActual = m_grid.iCaja;
		parametros.iMuestraMsg = m_grid.iMuestraMsg;
		sprintf_s(parametros.sFecha, "%02d%02d%04d", iDiaActual, iMesActual, iAnioActual);

		parametros.iNumSistema = iSistema;
		parametros.lCantidad = lTotalAPagar;
		parametros.iTipoServicio = 100;

		CString sCte;

		m_cliente.GetWindowText(sCte);
		parametros.lCliente = atol(sCte);

		parametros.lFolioSeguro = lNumeroConsulta;

		memcpy(cInputParam1, &parametros, sizeof(SParametros));

		// Ruta del archivo DLL a ejecutar
		nombreArchivo("CA0029.DLL", cNombreProyecto, DIRECTORIO_CA);

		// Nombre de la función principal en el DLL
		sprintf_s(cNombreFuncionDLL, "CA0029");

		sprintf_s(cMensaje, "recibirPagoCa::Cargando modulo CA0029");
		grabarLog(cMensaje);

		lPagoCliente = 0;
		CargarDLL cargarDll(cNombreProyecto, cNombreFuncionDLL, cInputParam1, cInputParam2, cOutputParam1, cOutputParam2);
		iRegresaDll = cargarDll.getResultado();

		lPagoCliente = atol(cOutputParam1);
		if (lPagoCliente > 0) iFlagPago = 1;

		sprintf_s(cMensaje, "recibirPagoCa::Pago Cliente = %ld", lPagoCliente);
		grabarLog(cMensaje);

		if (iRegresaDll <= 0)
		{
			AfxMessageBox("Ocurrio un error al llamado del modulo CA0029.DLL", MB_ICONERROR);
		}
		else
		{
			if (lPagoCliente != 0L || lTotalAPagar == 0L)
			{
				sprintf_s(cFechaMovimiento, "%02d-%02d-%04d %02d:%02d:%02d", iMesActual, iDiaActual, iAnioActual, iHora, iMinutos, iSegundos);
				cFechaMovimiento[19] = 0;

				if (m_grid.lCliente != 1708)
				{
					sprintf_s(cFechaNacimiento, "%02d-%02d-%04d %02d:%02d:%02d", iMesNacimiento, iDiaNacimiento, iAnioNacimiento, iHora, iMinutos, iSegundos);
					cFechaNacimiento[19] = 0;
				}

				bContinuar = crearTablaTemporal();
				if (bContinuar == true)
				{
					bContinuar = subirDatosTablaTemporal();
					if (bContinuar == true)
					{
						buscarSeguroClub();
						consultarEncuesta();

						if (grabarAbono())
						{
							iFlagGraboAbono = 1;
						}

						sprintf_s(cArchivo, "c:\\sys\\mem\\Ctas.txt");

						if (_access(cArchivo, 0) == 0)
							_unlink(cArchivo);
					}
				}

				if (iSistema != SISTEMA_CAJERA_CAPTURISTA)
				{
					if (iFlagGraboAbono == 1)
					{
						valorRegresa = true;
						iFlag = 1;
						//Se a¤ade para las encuestas de Coppel
						if (m_grid.lCliente > 0 && m_grid.lCliente != 1708)
						{
							if (esEmpleado(m_grid.lCliente) != 1)
							{
								checarTipoEncuesta(); //obtener lTotal30Dias, lTotalEdosCta;
								checarEncuestaEdosCtas();

								if (iFlagExisteEncuesta == 1)
								{
									lTotalEncuestar = totalEncuestar();
									checarEncuestas();
									if (lTotalEdosCta >= 0L)
									{
										iFlagEdoCuenta = 1;
									}
									if (lTotal30Dias >= 0L)
									{
										iFlag30Dias = 1;
									}
									if (iFlagEdoCuenta == 1 || iFlag30Dias == 1)
									{
										memset(cNombreEncuestado, 0, 20);
										memset(cApellidoMaternoEncuestado, 0, 20);
										memset(cApellidoPaternoEncuestado, 0, 20);
										pedirEncuesta();
									}
								}
							}
						}
					}

					sprintf_s(cSer, "%.17s", (LPCTSTR)m_grid.sServer);
					if (_access("c:\\sys\\progs\\ConsIVR.exe", 0) == 0)
					{
						//se pide la autorizacion de mandar msg por celular
						checarAutorizacionMensajeCelular(cSer, parametros.iTienda, parametros.lEmpleado, parametros.iCajaActual, parametros.iNumSistema, m_grid.lCliente); //gnwMecel.cpp
					}
					//Validar la puntualidad A o N
					if(cPuntualidad[0] == 'A' || cPuntualidad[0] == 'N')
					{
						obtenerFlag('C', FLAGC_POP_UP, iFlagPopUp);

						sprintf_s(cLog, "CDlgCapturarAbono::recibirPagoCa. Flag Pop Up: %d", iFlagPopUp);
						grabarLog(cLog);

						//JECE 28Jun24
						if (/*iFlagTiendaLocal == 0 &&*/ iFlagPopUp == 1)
						{
							validarPopUpPrestamoPersonal();
						}
					}

					if (iFlagInvitacionBanco == 1 && m_grid.lCliente != 1708)
					{
						mostrarMensajeTarjetaBanco();
					}

					if (iFlagCapturarTelefonos == 1 && iPedirTelefonos == 1)
					{
						grabarLog("CDlgCapturarAbono::recibirPagoCa --> Cargando modulo GN0118");

						memset(&parametros, 0, sizeof(SParametros));
						memset(cNombreProyecto, 0, sizeof(cNombreProyecto));
						memset(cNombreFuncionDLL, 0, sizeof(cNombreFuncionDLL));
						memset(cInputParam1, 0, sizeof(cInputParam1));
						memset(cInputParam2, 0, sizeof(cInputParam2));

						nombreArchivo("GN0118.DLL", cNombreProyecto, DIRECTORIO_GN);
						sprintf_s(cNombreFuncionDLL, "GN0118");

						parametros.iLink = generarLink();
						sprintf_s(parametros.sServer, "%s", (LPCTSTR)m_grid.sServer);
						parametros.iTienda = m_grid.iTienda;
						parametros.lEmpleado = m_grid.lEmpleado;
						parametros.iCajaActual = m_grid.iCaja;
						parametros.iMuestraMsg = m_grid.iMuestraMsg;
						parametros.iNumSistema = iSistema;
						parametros.lCliente = m_grid.lCliente;
						parametros.iFlagGeneral = 2;//0 = Venta, 1 = Prestamos, 2 = Abonos
						parametros.iFlagServicio = 0; //0 = Pantalla Captura Telefonos, 1 = Pantalla de Poblaciones

						memcpy(cInputParam1, &parametros, sizeof(SParametros));
						CargarDLL cargarDll(cNombreProyecto, cNombreFuncionDLL, cInputParam1, cInputParam2);
						if (cargarDll.getResultado() != 1)
						{
							AfxMessageBox("OCURRIÓ UN ERROR AL CARGAR EL GN0118.DLL", MB_ICONERROR);
						}
					}

					if (iFlagAsteriscoCoppel == 1)
					{
						if ((cPuntualidad[0] == 'A' || (cPuntualidad[0] == 'N' && m_grid.cSubPuntualidad[0] == 'A')))
						{
							fnLlamarCcuenta();

							cerrarConexionBD(&odbc_1);
							bRespuestaGral = candidatoAsteriscoCoppel04(&odbc, m_grid.lCliente, 1, cPuntualidadAsterisco, cSubPuntualidadAsterisco,
								cSituacionEspecialAsterisco, iCausaSituacionEspecialAsterisco, lVencidoTiempoAireAsterisco, bClienteCandidato,
								lAbonoBaseTiempoAireAsterisco, lSalarioMinimo, iPorcentajeUtilizado, 0, 0, 1, m_grid.iTienda, 'C', m_grid.iCaja, bTieneSitEsp, bAplicaAsteriscoSitEsp);
							if (bRespuestaGral)
							{
								grabarLog("CDlgCapturarAbono::recibirPagoCa --> Cargando modulo GN0106");
								memset(&parametros, 0, sizeof(SParametros));
								memset(cNombreProyecto, 0, sizeof(cNombreProyecto));
								memset(cNombreFuncionDLL, 0, sizeof(cNombreFuncionDLL));
								memset(cInputParam1, 0, sizeof(cInputParam1));
								memset(cInputParam2, 0, sizeof(cInputParam2));

								nombreArchivo("GN0106.DLL", cNombreProyecto, DIRECTORIO_GN);
								sprintf_s(cNombreFuncionDLL, "GN0106");

								parametros.iLink = generarLink();
								sprintf_s(parametros.sServer, "%s", (LPCTSTR)m_grid.sServer);
								parametros.iTienda = m_grid.iTienda;
								parametros.lEmpleado = m_grid.lEmpleado;
								parametros.iCajaActual = m_grid.iCaja;
								parametros.iNumSistema = iSistema;
								parametros.lCliente = m_grid.lCliente;

								memcpy(cInputParam1, &parametros, sizeof(SParametros));
								CargarDLL cargarDll(cNombreProyecto, cNombreFuncionDLL, cInputParam1, cInputParam2);
							}
							if (bClienteCandidato)
							{
								if (!gnCandidatoCoppel(&odbc, SISTEMA_CAJAS, m_grid.iCaja, lNumeroRecibo, m_grid.lCliente, cSqlTxt, false))
								{
									grabarMensajeError("C", m_grid.iCaja, (LPTSTR)(LPCTSTR)m_grid.sServer, "CapturarAbono", "CDlgCapturarAbono",
										"recibirPagoCa", cSqlTxt, m_grid.lEmpleado, "Error al actualizar candidato",
										&odbc, m_grid.iMuestraMsg);

								}
							}
						}
					}
					pedirEncuestaCat();

					//9923 -- monstrar mensaje invitacion migracion seguro
					CargarMensajesInvitacion();

					inviteMensajeAfore();
				}
				else if (iFlagGraboAbono == 1)
				{
					valorRegresa = true;
				}
			}
		}

		//6267707 Cajas/Legado no hay registro en tdcheques ni en SOA
		limpiarFolioRezagado(true);
		eliminarRegistroTemporalSesionTarjetaIniciarProcesoFacturacion();
		//6267707 Cajas/Legado no hay registro en tdcheques ni en SOA	

	}
	else
	{
		AfxMessageBox("NO ES POSIBLE RECIBIR PAGO, NO SE HA EFECTUADO NINGUN ABONO");
	}

	sprintf_s(cLog, "FC0200805021521238 - fin - recibirPagoCa - valorRegresa = %s", valorRegresa ? "VERDADERO" : "FALSO");
	grabarLog(cLog);

	return valorRegresa;
}

void CDlgCapturarAbono::darVolanteRopa(void)
{
	char cLog[500] = { 0 };
	long lTotal = 0L, lVencidoX = 0L, lSaldoX = 0L, lBaseX = 0L;
	CUGCell m_cell;
	CString sTexto;

	sprintf_s(cLog, "FC0200805021521240 - entra - darVolanteRopa");
	grabarLog(cLog);

	m_grid.QuickGetText(0, 12, &sTexto);
	lSaldoX = atol(sTexto);

	m_grid.QuickGetText(0, 14, &sTexto);
	lBaseX = atol(sTexto);

	m_grid.QuickGetText(0, 15, &sTexto);
	lVencidoX = atol(sTexto);

	if (lVencidoX < 1)
	{
		if (lSaldoX > 0)
		{
			if (lBaseX != 0)
			{
				lTotal = lSaldoX / lBaseX;
			}

			if (lTotal > 1)
			{
				iFlagPago = 1;
			}
			else
			{
				iFlagPago = 2;
			}
		}
		else
		{
			iFlagPago = 2;
		}
	}
	else
	{
		iFlagPago = 2;
	}
}

void CDlgCapturarAbono::darVolanteMuebles(void)
{
	char cLog[500] = { 0 };
	int iBand = 0, i = 0, iFlag = 0;
	long lTotal = 0L, lBaseX = 0L, lSaldoX = 0L, lVencidoX = 0L;
	CUGCell m_cell;
	CString sVencidoX, sSaldoX, sBaseX;

	sprintf_s(cLog, "FC0200805021521244 - entra - darVolanteMuebles");
	grabarLog(cLog);

	iFlag = iFlagPago;

	for (i = 1; i < iTotalCuentas; i++)
	{
		m_grid.QuickGetText(i, 15, &sVencidoX);
		lVencidoX = atol(sVencidoX);

		if (lVencidoX > 0L)
		{
			iBand = 1;
			iFlagPago = 2;
			break;
		}
	}
	if (iBand == 0)
	{
		m_grid.QuickGetText(iTotalCuentas - 1, 12, &sSaldoX);
		lSaldoX = atol(sSaldoX);

		m_grid.QuickGetText(iTotalCuentas - 1, 14, &sBaseX);
		lBaseX = atol(sBaseX);

		if (lBaseX > 0)
		{
			lTotal = lSaldoX / lBaseX;
		}
		if (lTotal > 4)
		{
			iFlagPago = 1;
		}
	}

	//si se cumplieron los 2 no se ofrece volante
	if (iFlagPago == 1 && iFlag == 1)
	{
		iFlagPago = 2;
	}

	//si se cumplio en ropa y en muebles no
	if (iFlag == 1 && iFlagPago == 2)
	{
		iFlagPago = 1;
	}
}

bool CDlgCapturarAbono::imprimirReciboCajas(char *cImagen, long &lImporteServicio)
{
	char cLog[500] = { 0 };
	int  i = 0, iPagina = 0, iLinea = 0, iRen = 0, iCol = 0, iEsSeguro = 0, iEsClub = 0, iFlagNoDebe = 0, iFlag = 0, iCuenta1 = 0, iCuenta2 = 0,
		iCuenta3 = 0, iContadorSeguros = 0, iFlagAnexo = 1, iDiaVencimientoX = 0, iMesVencimientoX = 0, iAnioVencimientoX = 0,
		iNumeroMeses = 0, iNumeroSegurosX = 0, iNumeroMesesX = 0, iMesVencActual = 0, iMesVencCar = 0, iTotalMeses = 0, iAnio = 0,
		iFlagConyugalX = 0, iIndicadorSeguro = 0, iDias = 0, iDiaVenta = 0, iMesVenta = 0, iAnioVenta = 0, iPlazoConvenioX = 0,
		iFlagCapturoConvenioX = 0, iEsSeguroSiguiente = 0, iAnioSumar = 0, iMesSumar = 0, iDiaSumar = 0,
		iMesesVencidos = 0, iPolizaNva = 0;
	CString sTexto;
	char cTxt[80] = { 0 }, cConstante[100] = { 0 }, cRespuesta[100] = { 0 }, cMensaje[140] = { 0 }, cRespuesta2[50] = { 0 },
		cSexoTmp[5] = { 0 }, cClave[3] = { 0 }, cSql[256] = { 0 }, cFechaVigencia[25] = { 0 };

	long lSuPagoX = 0L, lUstedDebia = 0L, lBonificacionX = 0L, lMontoRedondeadoX = 0L, lValorCuponCajas = 0, lSaldoX = 0L,
		lImporteConvenioX = 0L, lSaldaConX = 0L, lAhoraDebe = 0L, lSuAbono = 0L, lVencidoX = 0L, lInteresesAdicionalesX = 0L,
		lSuPago = 0L, lAcumuladoRecibo = 0L, lAbonoTotal = 0L, lInteresTotal = 0L, lDebeTotal = 0L,
		lVencidoTotal = 0L, lSaldaConTotal = 0L, lImporte = 0L, lMontoClub = 0L, lFolioSeguroc = 0L, lImporteTotalServicio = 0L,
		lCambio = 0L, lFolioSeguroi = 0L, lInteresMesUnoX = 0L, lBaseX = 0L;
	bool bResultado = false, bIndividual = false, bConyugal = false, bImprimioSeguro = false;
	char cStatusSeguro = 0, cTipoCan = 0, cClaveNoOfrecer = 0, cFechaNacimientoX[12] = { 0 },
		cDescripcion[60] = { 0 }, cFechaGnDominio[25] = { 0 };
	__int64 lFacturaX = 0;

	char cFechaSalda[10] = { 0 };

	sprintf_s(cLog, "FC0200805021521248 - entra - imprimirReciboCajas");
	grabarLog(cLog);

	memset(cConceptoCta, 0, sizeof(cConceptoCta));

	iCuentasAgua = 0, iCuentasSofol = 0, iCuentasTelefono = 0,
		iCuentasPredial = 0, iCuentasGas = 0, iCuentasMegacable = 0, iCuentasNextel = 0,
		iCuentasAlestra = 0, iCuentasCfe = 0, iCuentasAxtel = 0, iCuentasCablemas = 0;

	C_FormasPCL hoja(22, 270, cImagen, iFinLinea, iTipoImpresora, 1);

	compactarImpresion(hoja);
	m_mensaje.SetWindowText("IMPRIMIENDO RECIBO POR FAVOR ESPERE");

	iPagina = 2; iLinea = 2;

	cClave[0] = 'A';
	cClave[1] = 0;
	consultarCuentasPagoServicio(cClave, iCuentasAgua, "");

	cClave[0] = 'B';
	cClave[1] = 0;
	consultarCuentasPagoServicio(cClave, iCuentasSofol, "");

	cClave[0] = 'F';
	cClave[1] = 0;
	consultarCuentasPagoServicio(cClave, iCuentasTelefono, "");

	cClave[0] = 'V';
	cClave[1] = 0;
	consultarCuentasPagoServicio(cClave, iCuentasPredial, "");

	cClave[0] = 'G';
	cClave[1] = 0;
	consultarCuentasPagoServicio(cClave, iCuentasGas, "");

	cClave[0] = 'M';
	cClave[1] = 0;
	consultarCuentasPagoServicio(cClave, iCuentasMegacable, "");

	cClave[0] = 'K';
	cClave[1] = 0;
	consultarCuentasPagoServicio(cClave, iCuentasNextel, "");

	cClave[0] = 'Q';
	cClave[1] = 0;
	consultarCuentasPagoServicio(cClave, iCuentasAlestra, "");

	cClave[0] = 'W';
	cClave[1] = 0;
	consultarCuentasPagoServicio(cClave, iCuentasCfe, "");

	cClave[0] = 'U';
	cClave[1] = 0;
	consultarCuentasPagoServicio(cClave, iCuentasAxtel, "");

	cClave[0] = 'Q';
	cClave[1] = 0;
	consultarCuentasPagoServicio(cClave, iCuentasCablemas, "1"); //Pago Cablemas tiene tipomovimiento= '1'

	for (i = 0; i < iTotalCuentas; i++)
	{
		m_grid.QuickGetText(i, 25, &sTexto);
		sTexto.Trim();
		sprintf_s(cTxt, "%s", (LPCTSTR)sTexto);
		iMesVencimientoX = obtenerMes(cTxt);
		iAnioVencimientoX = ano_2000_4dig((int)valor_campo(&cTxt[5], 2), iAnioActual);
		iDiaVencimientoX = valor_campo(&cTxt[0], 2);

		m_grid.QuickGetText(i, 23, &sTexto);
		iNumeroMeses = atol(sTexto);

		m_grid.QuickGetText(i, -1, &sTexto);
		sTexto.Trim();
		sprintf_s(cTxt, "%s", (LPCTSTR)sTexto);

		if (memcmp(cTxt, "SEGURO", 6) == 0 || memcmp(cTxt, "P.FAMILIAR", 10) == 0)
		{
			iEsSeguro = 1;
			if (memcmp(cTxt, "P.FAMILIAR", 10) == 0)
			{
				iEsClub = 1;
			}
			else
			{
				iEsClub = 0;
			}
		}
		else
		{
			iEsSeguro = 0;
		}

		if (iEsSeguro == 1)
		{
			++iContadorSeguros;
			if (iCuenta1 == 0)
			{
				iCuenta1 = i;
			}
			else
			{
				if (iCuenta2 == 0)
				{
					iCuenta2 = i;
				}
				else
				{
					iCuenta3 = i;
				}
			}

			if (iEsClub != 1)
			{
				if (iNumeroMeses != 0)
				{
					//cawvense.cpp
					calcularFechaVencimientoSeguroAfirme(iNumeroMeses, iDiaVencimientoX, iMesVencimientoX, iAnioVencimientoX, iDiaActual, iMesActual, iAnioActual);
					bBanderaSeguroVigente = true;

				}
			}
		}
	}
	compactarImpresion(hoja);

	consultarImporteTotalPagoServicio(lImporteTotalServicio);
	lImporteServicio = lTotalGlobalServicios;
	lImporteTotalServicio = lTotalGlobalServicios;

	memset(cConstante, 0, sizeof(cConstante));
	cConstante[60] = 0;
	lMontoRedondeadoX = obtenerMontoSeguro();

	for (i = 0; i < iTotalCuentas; i++)
	{
		memset(cRespuesta, 0, sizeof(cRespuesta));
		m_grid.QuickGetText(i, 10, &sTexto);
		sTexto.Remove('.');
		sTexto.Remove(',');
		sprintf_s(cRespuesta, "%s", (LPCTSTR)sTexto);
		lImporteConvenioX = atol(cRespuesta);

		memset(cRespuesta, 0, sizeof(cRespuesta));
		m_grid.QuickGetText(i, 12, &sTexto);
		sTexto.Remove('.');
		sTexto.Remove(',');
		sprintf_s(cRespuesta, "%s", (LPCTSTR)sTexto);
		lSaldoX = atol(cRespuesta);

		memset(cRespuesta, 0, sizeof(cRespuesta));
		m_grid.QuickGetText(i, 13, &sTexto);
		sTexto.Trim();
		sTexto.Remove('.');
		sTexto.Remove(',');
		lInteresesAdicionalesX = atol(sTexto);

		memset(cRespuesta, 0, sizeof(cRespuesta));
		m_grid.QuickGetText(i, 35, &sTexto);
		sTexto.Trim();
		sTexto.Remove('.');
		sTexto.Remove(',');
		lInteresMesUnoX = atol(sTexto);

		m_grid.QuickGetText(i, 36, &sTexto);
		sTexto.Trim();
		iPolizaNva = atoi(sTexto);

		memset(cRespuesta, 0, sizeof(cRespuesta));
		m_grid.QuickGetText(i, 14, &sTexto);
		sTexto.Trim();
		sTexto.Remove('.');
		sTexto.Remove(',');
		lBaseX = atol(sTexto);

		memset(cRespuesta, 0, sizeof(cRespuesta));
		m_grid.QuickGetText(i, 18, &sTexto);
		sTexto.Trim();
		sTexto.Remove(',');
		sTexto.Remove('.');
		lSaldaConX = atol(sTexto);

		memset(cRespuesta, 0, sizeof(cRespuesta));
		m_grid.QuickGetText(i, 21, &sTexto);
		sTexto.Remove(',');
		sTexto.Remove('.');
		sprintf_s(cRespuesta, "%s", (LPCTSTR)sTexto);
		lSuPagoX = atol(cRespuesta);

		memset(cRespuesta, 0, sizeof(cRespuesta));
		m_grid.QuickGetText(i, 15, &sTexto);
		sTexto.Remove(',');
		sTexto.Remove('.');
		sprintf_s(cRespuesta, "%s", (LPCTSTR)sTexto);
		lVencidoX = atol(cRespuesta);

		if (lVencidoX > 0 && lBaseX > 0)
		{
			iMesesVencidos = (lVencidoX - lInteresesAdicionalesX) / lBaseX;
			//Si es el primer mes vencido se le quita le intere primer mes al interes adicionl
			if (iMesesVencidos == 1)
			{
				lInteresesAdicionalesX = lInteresesAdicionalesX - lInteresMesUnoX;
			}
			else if (iMesesVencidos > 1)
			{
				lInteresMesUnoX = 0;
			}
		}

		memset(cRespuesta, 0, sizeof(cRespuesta));
		m_grid.QuickGetText(i, 19, &sTexto);
		sTexto.Remove(',');
		sTexto.Remove('.');
		sprintf_s(cRespuesta, "%s", (LPCTSTR)sTexto);
		lBonificacionX = atol(cRespuesta);

		m_grid.QuickGetText(i, 9, &sTexto);
		iPlazoConvenioX = atol(sTexto);

		m_grid.QuickGetText(i, 22, &sTexto);
		iNumeroSegurosX = atoi(sTexto);

		m_grid.QuickGetText(i, 23, &sTexto);
		iNumeroMesesX = atoi(sTexto);

		m_grid.QuickGetText(i, 24, &sTexto);
		iFlagConyugalX = atoi(sTexto);

		iFlagCapturoConvenioX = 0;
		m_grid.QuickGetText(i, 28, &sTexto);
		iFlagCapturoConvenioX = atoi(sTexto);

		m_grid.QuickGetText(i, 25, &sTexto);
		sTexto.Trim();

		sprintf_s(cTxt, "%s", (LPCTSTR)sTexto);
		iMesVencimientoX = valor_campo(&cTxt[2], 2);
		iAnioVencimientoX = valor_campo(&cTxt[4], 4);
		iDiaVencimientoX = valor_campo(&cTxt[0], 2);

		m_grid.QuickGetText(i, -1, &sTexto);
		sTexto.Trim();
		sprintf_s(cTxt, "%s", (LPCTSTR)sTexto);

		m_grid.QuickGetText(i, 1, &sTexto);
		lFacturaX = _atoi64(sTexto);

		m_grid.QuickGetText(i, 2, &sTexto);
		sTexto.Trim();
		sprintf_s(cConceptoCta, "%s", (LPCTSTR)sTexto);

		if (memcmp(cTxt, "P.FAMILIAR", 10) == 0)
		{
			if (bBanderaTieneClub == false) //no tenia seguro club se asigna su folio asignado
			{
				lFacturaX = iFoliosSegurosAdicionales[0]; //El folio del seguro titular esta en la posicion 0
			}
		}

		m_grid.QuickGetText(i + 1, -1, &sTexto);
		sTexto.Trim();
		sprintf_s(cTxt, "%s", sTexto);


		if (memcmp(cTxt, "SEGURO", 6) == 0 || memcmp(cTxt, "P.FAMILIAR", 10) == 0)
		{
			iEsSeguroSiguiente = 1;
			if (memcmp(cTxt, "P.FAMILIAR", 10) == 0)
			{
				iEsSeguroSiguiente = 2;
			}
		}
		else
		{
			iEsSeguroSiguiente = 0;
		}

		m_grid.QuickGetText(i, -1, &sTexto);
		sTexto.Trim();
		sprintf_s(cDescripcion, "%s", (LPCTSTR)sTexto);

		if (memcmp(cDescripcion, "SEGURO", 6) != 0 && memcmp(cDescripcion, "P.FAMILIAR", 10) != 0 && memcmp(cDescripcion, "ROPA", 4) != 0 && memcmp(cDescripcion, "T.AIRE", 6) != 0 && memcmp(cDescripcion, "COMP ADC", 8) != 0 && memcmp(cDescripcion, "CP COMP ADC", 11) != 0 && memcmp(cDescripcion, "AUTO PROT.", 10) != 0)
		{
			// ES DE MUEBLES LA CUENTA.
			memset(cRespuesta, 0, sizeof(cRespuesta));
			m_grid.QuickGetText(i, 26, &sTexto);
			sTexto.Remove(',');
			sTexto.Remove('.');
			sprintf_s(cRespuesta, "%s", (LPCTSTR)sTexto);
			lSaldaConAnteriorX = atol(cRespuesta);

			m_grid.QuickGetText(i, 2, &sTexto);
			sTexto.Trim();
			sprintf_s(cTxt, "%s", (LPCTSTR)sTexto);
			iMesVenta = obtenerMes(cTxt);
			iAnioVenta = ano_2000_4dig((int)valor_campo(&cTxt[5], 2), iAnioActual);
			iDiaVenta = valor_campo(&cTxt[0], 2);
		}

		if (memcmp(cDescripcion, "SEGURO", 6) == 0 || memcmp(cDescripcion, "P.FAMILIAR", 10) == 0)
		{
			iEsSeguro = 1;
			if (memcmp(cDescripcion, "P.FAMILIAR", 10) == 0)
			{
				iEsClub = 1;
			}
			else
			{
				iEsClub = 0;
			}
		}
		else
		{
			iEsSeguro = 0;
		}

		if (iEsSeguro == 1 && lSuPagoX == 0) iLinea--;


		if (iLinea > 5)
		{

			hoja.poner(ENFATIZAR, 13, 15);
			hoja.poner(cConstante, 13, 20);
			hoja.poner(NO_ENFATIZAR, 13, 83);


			imprimirTotales(hoja, lUstedDebia, iContadorSeguros, iFlagAnexo);

			encabezadoTalonCajas(hoja, iPagina - 1, iContadorSeguros);

			encabezadoReciboCajas(hoja);

			hoja.poner(SEXTOS, 19, 0);

			hoja.imprimir();
			compactarImpresion(hoja);
			iPagina++;
			iLinea = 2;
		}
		if (iTotalCuentas > 50 && lSuPagoX <= 0) continue;
		if (iEsSeguro == 1)
		{
			if (lSuPagoX != 0)
			{
				bImprimioSeguro = true;
				if (iEsClub == 1)  //seguro club
				{
					grabarLog("Metodo TieneSeguroClub 4");
					bIndividual = tieneSeguroClub(cStatusSeguro, cTipoCan, cClaveNoOfrecer, lFolioSeguroi, bCteSeguro);
					grabarLog("Metodo TieneSeguroClubConyugal 4");
					bConyugal = tieneSeguroClubConyugal(cStatusSeguro, cTipoCan, cClaveNoOfrecer, lFolioSeguroc);
					if (bIndividual && lFacturaX == lFolioSeguroi)
					{
						hoja.poner("CLUB", iLinea, 0);
						hoja.poner("CLUB", iLinea, 104);
					}

					if (iFlagTieneSeguroAdicional == 0 && iFlagCapturoSeguroAdicional == 0) //Para que no confunda el seguro adicional con el conyugal
					{
						if (bConyugal && lFacturaX == lFolioSeguroc)
						{
							hoja.poner("CLUB CONYUGAL", iLinea, 0);
							hoja.poner("CLUB CONYUGAL", iLinea, 102);
						}
					}
				}
				else
				{
					hoja.poner("SEGURO", iLinea, 0);
					hoja.poner("SEGURO", iLinea, 102);
				}
				lImporte = lSuPagoX;

				if (lBonificacionX > 0)
					lImporte += lBonificacionX;

				memset(cRespuesta, 0, sizeof(cRespuesta));
				usingx("###,###", cRespuesta, (double)lImporte);
				hoja.poner(cRespuesta, iLinea, 34);
				hoja.poner(cRespuesta, iLinea, 43);
				hoja.poner(cRespuesta, iLinea, 117);

				lImporte = lSuPagoX;

				if (lBonificacionX > 0L)
				{
					if (iLinea > 5)
					{

						hoja.poner(ENFATIZAR, 13, 15);
						hoja.poner(cConstante, 13, 20);
						hoja.poner(NO_ENFATIZAR, 13, 83);

						imprimirTotales(hoja, lUstedDebia, iContadorSeguros, iFlagAnexo);

						encabezadoTalonCajas(hoja, iPagina - 1, iContadorSeguros);

						encabezadoReciboCajas(hoja);

						hoja.poner(SEXTOS, 19, 0);
						hoja.imprimir();
						compactarImpresion(hoja);
						iPagina++;
						iLinea = 2;
					}

					hoja.poner("BONIFICACION", iLinea, 0);
					memset(cRespuesta, 0, sizeof(cRespuesta));
					usingx("###,###", cRespuesta, lBonificacionX);
					hoja.poner(cRespuesta, iLinea, 32);
					hoja.poner("BONIF", iLinea, 104);
					hoja.poner(cRespuesta, iLinea, 117);
					if (lFacturaX != 0)
					{
						memset(cRespuesta, 0, sizeof(cRespuesta));
						sprintf_s(cRespuesta, "%I64d", lFacturaX);
						hoja.poner(cRespuesta, iLinea, 23);
					}
					iFlagNoDebe = 0;
				}
				memset(cRespuesta2, 0, sizeof(cRespuesta2));
				miniFecha(cRespuesta2, (int)iDiaVencimientoX, (int)iMesVencimientoX, (int)iAnioVencimientoX);
				//IMPRIME SOLO PARA A¥O >= 2000
				if ((int)iAnioVencimientoX > 99)
				{
					memcpy(cTxt, &cRespuesta2[0], 5);
					memcpy(&cTxt[5], &cRespuesta2[5], 2);
					cTxt[7] = 0;
					memcpy(&cRespuesta2[0], &cTxt[0], 7);
					cRespuesta2[7] = 0;
				}

				lMontoRedondeadoX = obtenerMontoSeguro();
				lMontoRedondeadoX = redondear1000(lMontoRedondeadoX * iNumeroSegurosX);

				memset(cRespuesta, 0, sizeof(cRespuesta));
				sprintf_s(cRespuesta, "%04d%02d", iAnioActual, iMesActual);
				iMesVencActual = valor_campo(cRespuesta, 6);
				memset(cRespuesta, 0, sizeof(cRespuesta));
				sprintf_s(cRespuesta, "%04d%02d", (int)iAnioVencimientoX, (int)iMesVencimientoX);
				iTotalMeses = iMesVencCar - iMesVencActual;
				iAnio = iAnioVencimientoX - iAnioActual;
				if (iTotalMeses < 0) iTotalMeses = 0;
				if (iTotalMeses > 80) iTotalMeses = (iTotalMeses - (90 * iAnio)) + (2 * iAnio);
				if (iEsClub != 1)  //no es seguro club
				{
					iFlagConyugalX = obtenerClaveConyugalCrSegurosAf(m_grid.lCliente);
				}
				if (iFlagConyugalX == 1)
				{
					if (iNumeroMesesX > 5)
						lMontoRedondeadoX = long(lMontoRedondeadoX*1.75);
					else
						lMontoRedondeadoX = long(lMontoRedondeadoX*1.50);
				}
				else
				{
					if (iNumeroMesesX > 5)
						lMontoRedondeadoX = long(lMontoRedondeadoX*1.50);
				}
				memset(cRespuesta, 0, sizeof(cRespuesta));
				usingx("###,###", cRespuesta, lMontoRedondeadoX);
				// pone el mensaje SEGURO DE VIDA POR  $ 99,999 VENCE xx xxx xx
				if (iEsClub != 1)  //no es seguro club
				{
					if (lSuPagoX != 0)
					{
						sprintf_s(cMensaje, "%I64d %02ld %s $%s %s %s", lFacturaX, iNumeroSegurosX, "SEGURO DE", cRespuesta, "VENCE", cRespuesta2);
					}
					else
					{
						sprintf_s(cMensaje, "%I64d %s $%s %s %s", lFacturaX, "SEGURO DE", cRespuesta, "VENCE", cRespuesta2);
					}
				}
				else
				{

					iEdad = iAnioActual - iAnioNacimiento;
					{
						miniFecha(cRespuesta2, (int)iDiaVencimientoX, (int)iMesVencimientoX, (int)iAnioVencimientoX);
					}
					cRespuesta2[7] = 0;
					if (bIndividual && lFacturaX == lFolioSeguroi)
					{
						if (iFlagTieneSeguroAdicional == 0 && iFlagCapturoSeguroAdicional == 0)
						{
							iNumeroSegurosX = ChecarCantidadSeguros(0, m_grid.lCliente, (long)lFacturaX); //Si no tiene seguro adicional busca el numero de seguros con claveconyugal=0
						}
						else
						{
							iNumeroSegurosX = ChecarCantidadSeguros(1, m_grid.lCliente, (long)lFacturaX); //Si tiene seguro adicional busca el numero de seguros con claveconyugal=1
						}
						lMontoClub = obtenerMontoSeguroClub(iNumeroSegurosX);
						usingx("###,###", cRespuesta, lMontoClub);
						cRespuesta[7] = 0;
						sprintf_s(cMensaje, "FOLIO:  %I64d AFILIADO AL CLUB CON %d SEGUROS : $ %s VENCE %s ", lFacturaX, iNumeroSegurosX, cRespuesta, cRespuesta2);
					}
					if (iFlagTieneSeguroAdicional == 0 && iFlagCapturoSeguroAdicional == 0) //Para que no confunda el seguro adicional con el conyugal
					{
						if (bConyugal && lFacturaX == lFolioSeguroc)
						{
							iNumeroSegurosX = ChecarCantidadSeguros(1, m_grid.lCliente, (long)lFacturaX);
							lMontoClub = obtenerMontoSeguroClub(iNumeroSegurosX);
							usingx("###,###", cRespuesta, lMontoClub);
							cRespuesta[7] = 0;
							sprintf_s(cMensaje, "FOLIO:  %I64d AFILIADO AL CLUB CONYUGAL CON %d SEGUROS : $ %s VENCE %s ", lFacturaX, iNumeroSegurosX, cRespuesta, cRespuesta2);
						}
					}
				}
				cMensaje[80] = 0; // AQUI
				if (iEsSeguroSiguiente == 1 || iEsSeguroSiguiente == 2)
				{
					if (iEsSeguroSiguiente == 1) //seguro afirme
					{
						hoja.poner(cMensaje, 6, 0);
					}
					else
					{
						if (iContadorSeguros < 3)
						{
							hoja.poner(cMensaje, 6, 0);
						}
						else
						{
							hoja.poner(cMensaje, 7, 0);
						}
					}

				}
				else
				{
					if (iContadorSeguros == 1)
					{
						hoja.poner(cMensaje, 6, 0);
						if ((iFlagTieneSeguroAdicional == 1 || iFlagCapturoSeguroAdicional == 1) && iEsClub == 1)
						{
							imprimirReciboSeguroClubAdicional(hoja, cRespuesta2, 6, iContadorSeguros, iFlagAnexo, iPagina, iLinea);
						}
					}
					else
					{
						if (iContadorSeguros == 2)
						{
							hoja.poner(cMensaje, 7, 0);
							if ((iFlagTieneSeguroAdicional == 1 || iFlagCapturoSeguroAdicional == 1) && iEsClub == 1)
							{
								imprimirReciboSeguroClubAdicional(hoja, cRespuesta2, 7, iContadorSeguros, iFlagAnexo, iPagina, iLinea);
							}
						}
						else
						{
							hoja.poner(cMensaje, 8, 0);
							if ((iFlagTieneSeguroAdicional == 1 || iFlagCapturoSeguroAdicional == 1) && iEsClub == 1)
							{
								imprimirReciboSeguroClubAdicional(hoja, cRespuesta2, 8, iContadorSeguros, iFlagAnexo, iPagina, iLinea);
							}
						}
					}
				}
				if (iFlagBanorte != 0)
				{
					if (iIndicadorSeguro == 0)
					{
						iCol = 83;
						iIndicadorSeguro = 1;
					}
					else
					{
						iCol = 93;
					}
					//
					if (iEsSeguroSiguiente == 1 || iEsSeguroSiguiente == 2)
					{
						iCol = 83;
					}
					else
					{
						iCol = 93;
					}
				}
				else
				{
					if (iIndicadorSeguro == 0)
					{
						iCol = 93;
						iIndicadorSeguro = 1;
					}
					else
					{
						iCol = 103;
					}
					//
					if (iEsSeguroSiguiente == 1 || iEsSeguroSiguiente == 2)
					{
						iCol = 93;
					}
					else
					{
						iCol = 103;
					}
				}
				if (cSexoCliente[0] != ' ')
				{
					if (iEsClub == 1)
					{
						if (cSexoCliente[0] == 'F')
						{
							cSexoTmp[0] = '1';
							cSexoTmp[3] = 'F';
							cSexoTmp[4] = 0;
						}
						if (cSexoCliente[0] == 'M')
						{
							cSexoTmp[0] = '2';
							cSexoTmp[3] = 'M';
							cSexoTmp[4] = 0;
						}
						cSexoTmp[4] = 0;
						memset(cMensaje, 0, 140);
						sprintf_s(cMensaje, "%s", cSexoTmp);
						if (iContadorSeguros < 3)
						{
							hoja.poner(cMensaje, 8, iCol + 9);
						}
						else
						{
							hoja.poner(cMensaje, 9, iCol + 9);
						}
					}

				}
				else
				{
					if (iCol == 100)
					{
						if (iEsClub == 1)
						{
							if (cSexoCliente[0] == 'F')
							{
								cSexoTmp[0] = '1';
								cSexoTmp[3] = 'F';
								cSexoTmp[4] = 0;
							}
							if (cSexoCliente[0] == 'M')
							{
								cSexoTmp[0] = '2';
								cSexoTmp[3] = 'M';
								cSexoTmp[4] = 0;
							}
							cSexoTmp[4] = 0;
							memset(cMensaje, 0, 140);
							sprintf_s(cMensaje, "%s", cSexoTmp);
							if (iContadorSeguros < 3)
							{
								hoja.poner(cMensaje, 8, iCol + 9);
							}
							else
							{
								hoja.poner(cMensaje, 9, iCol + 9);
							}
						}
						else
						{
							hoja.poner("SEGURO", 8, iCol);
							memset(cMensaje, 0, 140);
							sprintf_s(cMensaje, "%I64d", lFacturaX);
							if (lFacturaX > 0) hoja.poner(cMensaje, 8, iCol + 9);
						}
					}
					else
					{
						if (iEsClub == 1)
						{
							if (cSexoCliente[0] == 'M')
							{
								cSexoTmp[0] = '2';
								cSexoTmp[3] = 'M';
								cSexoTmp[4] = 0;
							}
							if (cSexoCliente[0] == 'F')
							{
								cSexoTmp[0] = '1';
								cSexoTmp[3] = 'F';
								cSexoTmp[4] = 0;
							}
							cSexoTmp[4] = 0;
							memset(cMensaje, 0, 140);
							sprintf_s(cMensaje, "%s", cSexoTmp);
							if (iContadorSeguros < 3)
							{
								hoja.poner(cMensaje, 8, iCol + 9);
							}
							else
							{
								hoja.poner(cMensaje, 9, iCol + 9);
							}
						}
						else
						{
							memset(cMensaje, 0, 140);
							sprintf_s(cMensaje, "%I64d", lFacturaX);
							if (lFacturaX > 0)
								hoja.poner(cMensaje, 8, iCol + 9);
						}
					}
				}

				if (iEsClub == 1)
				{
					sprintf_s(cMensaje, "%02d-%02d %02ld %s", (int)iMesNacimiento, (int)iAnioNacimiento, iNumeroSegurosX, cRespuesta2);
				}
				else
				{
					if (cSexoCliente[0] != ' ')
					{
						if (iEsClub != 1)
						{
							sprintf_s(cMensaje, "%02d-%02d %02ld %s", (int)iMesNacimiento, (int)iAnioNacimiento, iNumeroSegurosX, cRespuesta2);
						}
					}
					else
					{
						memset(cMensaje, 0, 140);
						cMensaje[139] = 0;
						if (lSuPagoX != 0)
						{
							sprintf_s(cMensaje, "%02ld %s", iNumeroSegurosX, cRespuesta2);
						}
						else
						{
							sprintf_s(cMensaje, "%s", " ");
						}
					}

				}

				// Imprime la parte del talon...
				cMensaje[50] = 0;
				//seguro afirme                 seguro club
				if (iEsSeguroSiguiente == 1 || iEsSeguroSiguiente == 2)
				{
					if (iContadorSeguros < 3)
					{
						hoja.poner(cMensaje, 6, 102);
					}
					else
					{
						hoja.poner(cMensaje, 7, 102);
					}
				}
				else
				{
					if (iContadorSeguros == 3)
					{
						hoja.poner(cMensaje, 8, 102);
					}
					else
					{
						hoja.poner(cMensaje, 7, 102);
					}
				}
			}
		}
		else if (memcmp(cDescripcion, "AUTO PROT.", 10) == 0)
		{
			if (bImprimioSeguro == true)
			{
				hoja.poner(ENFATIZAR, 13, 15);
				hoja.poner(cConstante, 13, 20);
				hoja.poner(NO_ENFATIZAR, 13, 83);

				imprimirTotales(hoja, lUstedDebia, iContadorSeguros, iFlagAnexo);

				encabezadoTalonCajas(hoja, iPagina - 1, iContadorSeguros);

				encabezadoReciboCajas(hoja);

				hoja.poner(SEXTOS, 19, 0);

				hoja.imprimir();
				compactarImpresion(hoja);
				iPagina++;
				iLinea = 2;
				bImprimioSeguro = false;
			}

			if (lSuPagoX > 0 || memcmp(cConceptoCta, "AFILIADO", 8) == 0)
			{
				if (lSuPagoX > 0)
				{
					hoja.poner("AUTO PROT.", iLinea, 0);
					hoja.poner("AUTO PROT.", iLinea, 108);

					usingx("###,###", cRespuesta, (double)lSuPagoX);
					hoja.poner(cRespuesta, iLinea, 34);
					hoja.poner(cRespuesta, iLinea, 43);
					hoja.poner(cRespuesta, iLinea, 117);
					iLinea++;
				}

				iLinea++;
				m_grid.QuickGetText(i, 22, &sTexto);
				sTexto.Trim();

				memset(cRespuesta2, 0, sizeof(cRespuesta2));
				if (atoi(sTexto) == 2 || atoi(sTexto) == 5)
				{
					sprintf_s(cRespuesta2, "BASICA PLUS ( RC, GM y AL )");
				}
				else
				{
					sprintf_s(cRespuesta2, "BASICA (RC)");
				}

				memset(cRespuesta, 0, sizeof(cRespuesta));
				if (iPolizaNva == 1)
				{
					lFacturaX = buscarFolionuevo(lFacturaX, m_grid.lCliente, lNumeroRecibo);
				}
				sprintf_s(cRespuesta, "POLIZA: %I64d AFILIADO AL AUTO PROTECCION COBERTURA", lFacturaX);
				sprintf_s(cRespuesta, "%s %s", cRespuesta, cRespuesta2);

				hoja.poner(cRespuesta, iLinea, 0);

				iLinea++;

				if (lSuPagoX > 0)
				{
					if (iPolizaNva != 1)
					{
						m_grid.QuickGetText(i, 25, &sTexto);
						sTexto.Trim();
						sprintf_s(cTxt, "%s", (LPCTSTR)sTexto);
						iMesVencimientoX = valor_campo(&cTxt[2], 2);
						iAnioVencimientoX = valor_campo(&cTxt[4], 4);
						iDiaVencimientoX = valor_campo(&cTxt[0], 2);

						memset(cRespuesta2, 0, sizeof(cRespuesta2));
						miniFecha(cRespuesta2, (int)iDiaVencimientoX, (int)iMesVencimientoX, (int)iAnioVencimientoX);
					}
					else
					{
						iDiaVencimientoX = iDiaActual;
						iMesVencimientoX = iMesActual;
						iAnioVencimientoX = iAnioActual;
						sumarDia(1, iDiaVencimientoX, iMesVencimientoX, iAnioVencimientoX);
						miniFecha(cRespuesta2, (int)iDiaVencimientoX, (int)iMesVencimientoX, (int)iAnioVencimientoX);
					}
					memset(cRespuesta, 0, sizeof(cRespuesta));
					sprintf_s(cRespuesta, "VIGENCIA: DESDE LAS 12:00 HR (MEDIO DIA) DEL %s", cRespuesta2);
					hoja.poner(cRespuesta, iLinea, 0);
					iLinea++;
				}

				m_grid.QuickGetText(i, 3, &sTexto);
				sTexto.Trim();
				memset(cRespuesta, 0, sizeof(cRespuesta));
				sprintf_s(cRespuesta, "HASTA LAS 12:00 HR (MEDIO DIA) DEL %s", (LPCTSTR)sTexto);
				hoja.poner(cRespuesta, iLinea, 12);
				iLinea += 2;
				if (iLinea > 5)
				{
					hoja.poner(ENFATIZAR, 13, 15);
					hoja.poner(cConstante, 13, 20);
					hoja.poner(NO_ENFATIZAR, 13, 83);

					imprimirTotales(hoja, lUstedDebia, iContadorSeguros, iFlagAnexo);

					encabezadoTalonCajas(hoja, iPagina - 1, iContadorSeguros);

					encabezadoReciboCajas(hoja);

					hoja.poner(SEXTOS, 19, 0);

					hoja.imprimir();
					compactarImpresion(hoja);
					iPagina++;
					iLinea = 2;
				}
			}
			else
			{
				if (memcmp(cConceptoCta, "AFILIADO", 8) != 0)
				{
					m_grid.QuickGetText(i, 3, &sTexto);
					sTexto.Trim();
					sprintf_s(cRespuesta2, "%s", (LPCTSTR)sTexto);
					sprintf_s(cRespuesta, "POLIZA %I64d NO TIENE AUTO PROTECCION, VENCIO EL %s", lFacturaX, cRespuesta2);
					hoja.poner(cRespuesta, iLinea, 0);
				}
			}

		}
		else
		{
			if (m_grid.lCliente == 1708) continue;
			if (memcmp(cDescripcion, "PLAN MOVISTAR", 13) == 0) continue;
			if ((lFacturaX > 999999 || lFacturaX < 0) && memcmp(cDescripcion, "CREDITO Y CASA", 6) != 0) continue;
			if (lSaldoX == 0 && (lSuPagoX == 0 && lImporteConvenioX == 0)) continue;

			if (lSuPagoX > 0 && memcmp(cDescripcion, "T.AIRE", 6) == 0)
				iFlagAbonoTA = 1;

			if ((lFacturaX == 0 || lFacturaX == 999999 || memcmp(cDescripcion, "T.AIRE", 6) == 0 || memcmp(cDescripcion, "COMP ADC", 8) == 0 || memcmp(cDescripcion, "CP COMP ADC", 11) == 0) /*|| iFlagDespliegaDatosZ == 1*/)
			{
				if (memcmp(cDescripcion, "ROPA", 4) == 0 || memcmp(cDescripcion, "T.AIRE", 6) == 0 || memcmp(cDescripcion, "COMP ADC", 8) == 0 || memcmp(cDescripcion, "CP COMP ADC", 11) == 0)
				{
					if (memcmp(cDescripcion, "T.AIRE", 6) == 0)
					{
						hoja.poner("T.AIRE", iLinea, 0);
						hoja.poner("T.AIRE", iLinea, 108);
					}
					else if (memcmp(cDescripcion, "COMP ADC", 8) == 0)
					{
						hoja.poner("COMP ADC", iLinea, 0);
						hoja.poner("COMP ADC", iLinea, 106);
					}
					else if (memcmp(cDescripcion, "CP COMP ADC", 11) == 0)
					{
						hoja.poner("CP ADC", iLinea, 0);
						hoja.poner("CP ADC", iLinea, 106);
					}
					else
					{
						hoja.poner("ROPA", iLinea, 0);
						hoja.poner("ROPA", iLinea, 108);
					}
					iFlagAnexo = 1;
				}
				else
				{
					if (memcmp(cConceptoCta, "CP PRES", 7) == 0 && iFlagDespliegaDatosZ == 1)
					{
						hoja.poner("PRESTAMO", iLinea, 0);

						if (lSaldoX == lSuPagoX)
						{
							hoja.poner("PAGADO", iLinea, 87);
						}
						else
						{
							hoja.poner("*", iLinea, 92);
						}
						hoja.poner("PRESTAMO", iLinea, 106);
						iFlagAnexo = 1;
						iCtaPerdida = 0;
					}
				}
			}

			imprimirImportesRecibo(hoja, iLinea, lUstedDebia, lSuAbono, lAhoraDebe,
				lAbonoTotal, lInteresTotal, lDebeTotal, lVencidoTotal, lSaldaConTotal,
				lFacturaX, cDescripcion, iDiaVenta, iMesVenta, iAnioVenta, lSaldoX,
				lSuPagoX, lInteresesAdicionalesX, lVencidoX, lSaldaConX, lInteresesAdicionalesX, lInteresMesUnoX);

			if (lVencidoFinalTicket <= lImporteConvenioX)//En Caso que el vencido sea menor al conv, se topara al vencido de la cuenta..
			{
				lImporteConvenioX = lVencidoFinalTicket;
			}
			if (iFlagCapturoConvenioX == 1 && lSaldoCtaTicket > 0)  //se capturo convenio a la cuenta
			{
				iLinea++;
				if (iLinea > 5)
				{

					hoja.poner(ENFATIZAR, 13, 15);
					hoja.poner(cConstante, 13, 20);
					hoja.poner(NO_ENFATIZAR, 13, 83);

					imprimirTotales(hoja, lUstedDebia, iContadorSeguros, iFlagAnexo);

					encabezadoTalonCajas(hoja, iPagina - 1, iContadorSeguros);

					encabezadoReciboCajas(hoja);

					hoja.poner(SEXTOS, 19, 0);

					hoja.imprimir();
					compactarImpresion(hoja);
					iPagina++;
					iLinea = 2;
				}
				iDias = (int)iPlazoConvenioX * 7;
				usingx("###,###", cRespuesta, lImporteConvenioX);

				sprintf_s(cMensaje, "USTED PROMETE PAGAR $ %s DENTRO DE %02d DIAS", cRespuesta, iDias);

				hoja.poner(cMensaje, iLinea, 17);
				sprintf_s(cMensaje, "%s    %s  %d", "CONVENIO", cRespuesta, iDias);
				hoja.poner(cMensaje, iLinea, 102);
			}

			if (lBonificacionX > 0 && lSuPagoX >= lSaldaConX)
			{
				if (lSaldoX > 0)
				{
					if ((lSuPagoX > lSaldaConX) && (lSuPagoX < lSaldoX))
					{
						lBonificacionX = lSaldoX - lSuPagoX;
						if (lBonificacionX < 0) lBonificacionX = 0;
					}
				}
				lAhoraDebe -= lBonificacionX;

				if (lBonificacionX > 0)
				{
					iLinea++;
					if (iLinea > 5)
					{

						hoja.poner(ENFATIZAR, 13, 15);
						hoja.poner(cConstante, 13, 20);
						hoja.poner(NO_ENFATIZAR, 13, 83);

						imprimirTotales(hoja, lUstedDebia, iContadorSeguros, iFlagAnexo);

						encabezadoTalonCajas(hoja, iPagina - 1, iContadorSeguros);

						encabezadoReciboCajas(hoja);

						hoja.poner(SEXTOS, 19, 0);
						hoja.imprimir();
						compactarImpresion(hoja);
						iPagina++;
						iLinea = 2;
					}

					hoja.poner("BONIFICACION", iLinea, 0);
					usingx("###,###", cRespuesta, lBonificacionX);
					hoja.poner(cRespuesta, iLinea, 34);
					hoja.poner("BONIF", iLinea, 104);
					hoja.poner(cRespuesta, iLinea, 117);
					if (lFacturaX != 0)
					{
						sprintf_s(cRespuesta, "%I64d", lFacturaX);
						if (lFacturaX != 999999)//Aki ta
							hoja.poner(cRespuesta, iLinea, 25);
					}
					lSuAbono += lBonificacionX;
					iFlagNoDebe = 0;
				}
			}
		}
		iLinea++;
	}  //fin ciclo for

	if (m_grid.lCliente > 0)
	{
		determinaMensajeRecibo(cConstante, iFlagNoDebe);
	}
	else
	{
		memset(cConstante, ' ', 60);
		cConstante[60] = 0;
	}
	if (iLinea > 0)
	{

		if (iContadorSeguros != 0)
		{
			verificarVigenciaSeguros(iCuenta1, iCuenta2, iCuenta3, iContadorSeguros, hoja, iIndicadorSeguro, iFlag);
		}

		imprimirTotales(hoja, lUstedDebia, iContadorSeguros, iFlagAnexo);

		if (iContadorSeguros == 3)
		{
			hoja.poner(ENFATIZAR, 14, 15);
			hoja.poner(cConstante, 14, 20);
			hoja.poner(NO_ENFATIZAR, 14, 83);
		}
		else
		{
			hoja.poner(ENFATIZAR, 13, 15);
			hoja.poner(cConstante, 13, 20);
			hoja.poner(NO_ENFATIZAR, 13, 83);
		}

		encabezadoTalonCajas(hoja, iPagina - 1, iContadorSeguros);
	}

	/*  IMPRIME LOS TOTALES EN EL RECIBO DE CAJAS  */
	if (iContadorSeguros == 0) iRen = 8; else iRen = 8 + iContadorSeguros;
	hoja.poner("TOTALES  :", iRen - 1, 0);
	usingx("###,###", cRespuesta, lUstedDebia);
	hoja.poner(cRespuesta, iRen - 1, 33);
	usingx("###,###", cRespuesta, lAbonoTotal);
	hoja.poner(cRespuesta, iRen - 1, 42);
	usingx("###,###", cRespuesta, lInteresTotal);
	hoja.poner(cRespuesta, iRen - 1, 51);
	usingx("###,###", cRespuesta, lDebeTotal);
	hoja.poner(cRespuesta, iRen - 1, 59);
	usingx("###,###", cRespuesta, lVencidoTotal);
	hoja.poner(cRespuesta, iRen - 1, 68);
	if (iFlagTiendaLocal == 0)
	{
		usingx("###,###", cRespuesta, lSaldaConTotal);
		hoja.poner(ENFATIZAR, iRen - 1, 79);
		hoja.poner(cRespuesta, iRen - 1, 79);

		miniFecha(cFechaSalda, iDiaActual, iMesActual, iAnioActual);
		strncpy_s(cRespuesta, cFechaSalda, 5);
		cRespuesta[5] = 0;
		hoja.poner(cRespuesta, iRen - 1, 88);
	}

	hoja.poner("ENTREGO  :", iRen, 0);
	usingx("###,###.##", cRespuesta, lPagoCliente);
	hoja.poner(cRespuesta, iRen, 13);
	hoja.poner("SU PAGO :", iRen, 33);

	lSuPago = lTotalAPagar - lTotalGlobalServicios;

	usingx("###,###.##", cRespuesta, (double)lSuPago);

	hoja.poner(cRespuesta, iRen, 43);

	lCambio = (lPagoCliente - lSuPago);

	hoja.poner("SU CAMBIO :", iRen, 59);
	usingx("###,###.##", cRespuesta, lCambio);
	hoja.poner(cRespuesta, iRen, 78);

	if (m_grid.lCliente == 1708L)
	{
		if (iContadorSeguros != 0) hoja.poner("TOTALES  :", 10, 104);
		else hoja.poner("TOTALES  :", iRen + 2, 104);
	}
	else
	{
		if (iContadorSeguros != 0) hoja.poner("TOTALES  :", 10, 106);
		else hoja.poner("TOTALES  :", iRen + 2, 106);
	}

	usingx("###,###.##", cRespuesta, lSuPago);
	if (iContadorSeguros != 0) hoja.poner(cRespuesta, 10, 116);
	else hoja.poner(cRespuesta, iRen + 2, 116);

	consultarAcumuladoMonetarioCajas(); //obtener el acumulado total de la caja
	lAcumuladoRecibo = lConsultaAcumulado - lImporteTotalServicio;
	usingx("###,###.##", cRespuesta, lAcumuladoRecibo);

	if (iFlagConyugalX == 1)
	{
		imprimirDescuentoConyugal();
	}

	compactarImpresion(hoja);
	encabezadoReciboCajas(hoja);

	hoja.poner(SEXTOS, 19, 0);

	if (bFlagCuponCajas)
	{
		C_ODBC odbcCuponCajas;
		char cIpServidorCupones[22] = { 0 }, cSql[255] = { 0 };

		if (consultarIpServidor(&odbc, cIpServidorCupones, SERV_ALTAHUEEMPRE, cSql))
		{
			if (abrirConexionBD(&odbcCuponCajas, cIpServidorCupones, cIpServidorCupones, CONECTA_GLOBALTIENDAS, 0))
			{
				sprintf_s(cFechaNacimientoX, "%04ld-%02ld-%02ld", iAnioNacimiento, iMesNacimiento, iDiaNacimiento);
				sprintf_s(cFechaGnDominio, "%04ld%02ld%02ld", iAnioActual, iMesActual, iDiaActual);

				lValorCuponCajas = altaCuponDineroElectronico(&odbc, &odbcCuponCajas, m_grid.iTienda, 3, m_grid.iCaja, lNumeroRecibo,
					m_grid.lCliente, cSexo, cFechaNacimientoX, cPuntualidad[0], cNombre,
					cApellidoPaterno, cApellidoMaterno, cNombreCiudad, lDineroCoppel, cSql, cFechaGnDominio);
				if (lValorCuponCajas > 0)
				{
					sprintf_s(cTxt, "USTED OBTUVO $%d EN DINERO ELECTRONICO, VERIFIQUE EL SIGUIENTE CUPON", lValorCuponCajas);
					hoja.poner(cTxt, 15, 12);
				}
				else
				{
					if (lValorCuponCajas == -10)
					{
						grabarMensajeError("C", m_grid.iCaja, (LPTSTR)(LPCTSTR)m_grid.sServer, "CapturarAbono", "CDlgCapturarAbono",
							"imprimirReciboCajas", cSql, m_grid.lEmpleado, "ERROR EN LA CONSULTA", &odbc, m_grid.iMuestraMsg);
					}

					bFlagCuponCajas = false;
					lDineroCoppel = 0L;
				}

				odbcCuponCajas.Close();
			}
			else
			{
				bFlagCuponCajas = false;
				lDineroCoppel = 0L;
			}
		}
	}

	if (iFlagTiendaLocal >= 1)
	{
		obtenerFechaCartera();
		sprintf_s(cRespuesta, "SUS MOVIMIENTOS ESTAN ACTUALIZADOS AL: %s", cFechaMasActualCte);
		hoja.poner(cRespuesta, 15, 23);
	}
	else
	{
		if (iFlagTdaConCubrebocas == 1)
		{
			hoja.poner("RECUERDA USAR CUBREBOCAS", 15, 26);
		}
		else if (iFlagTdaConEstacionamiento == 1 && !bFlagCuponCajas)
		{
			hoja.poner("ESTACIONAMIENTO EXCLUSIVO PARA CLIENTES", 15, 26);
		}
	}

	sprintf_s(cRespuesta, " TEL: %s ", cTelefonoGnDominio);
	hoja.poner(cRespuesta, 12, 83);

	hoja.imprimir();

	if (checarSiTieneConvenioUnico() == 1)
	{
		imprimirReciboConvenioUnico(hoja);
	}

	if (bFlagCuponCajas)
	{
		iAnioSumar = iAnioActual;
		iMesSumar = iMesActual;
		iDiaSumar = iDiaActual;

		sumarDiaG(60, iDiaSumar, iMesSumar, iAnioSumar, iAnioActual);

		fechaLargaDMA(cFechaVigencia, iDiaSumar, iMesSumar, iAnioSumar, iAnioActual);

		imprimirCuponDineroElectronico(hoja, m_grid.lCliente, lValorCuponCajas, cNombre, cApellidoPaterno, cApellidoMaterno, cFechaVigencia);
	}

	revizarImprimirPolizaSeguroAuto(IMPRMIR_POLIZA_NUEVA);

	if (bPromocion)
	{
		imprimirMensajePromoDirectaCajas(hoja);
	}

	bResultado = true;

	sprintf_s(cLog, "FC0200805021521265 - fin - imprimirReciboCajas bResultado=%s", bResultado ? "VERDADERO" : "FALSO");
	grabarLog(cLog);

	return  bResultado;
}

void CDlgCapturarAbono::calculaAbonoInteres(long lInteresesAdicionales, long lSuPago, long &lAbonoCuenta, long &lAbonoInteres)
{
	char cLog[500] = { 0 };

	sprintf_s(cLog, "FC0200805021521267 - entra - calculaAbonoInteres");
	grabarLog(cLog);

	if (lInteresesAdicionales > lSuPago)
	{
		lAbonoInteres = lSuPago;
	}
	else
	{
		lAbonoInteres = lInteresesAdicionales;
		lAbonoCuenta = lSuPago - lInteresesAdicionales;
	}
}

void CDlgCapturarAbono::encabezadoReciboCajas(C_FormasPCL &hoja)
{
	char cLog[500] = { 0 };

	sprintf_s(cLog, "FC0200805021521271 - entra - encabezadoReciboCajas");
	grabarLog(cLog);

	hoja.poner(OCTAVOS, 21, 0);
	hoja.poner(COMPACTAR, 21, 5);
}

void CDlgCapturarAbono::compactarImpresion(C_FormasPCL &hoja)
{
	char cLog[500] = { 0 };

	sprintf_s(cLog, "FC0200805021521273 - entra - compactarImpresion");
	grabarLog(cLog);

	hoja.poner(OCTAVOS, 0, 0);
	hoja.poner(COMPACTAR, 0, 5);
}

void CDlgCapturarAbono::encabezadoTalonCajas(C_FormasPCL &hoja, int iPagina, int iContadorSeguros)
{
	char cLog[500] = { 0 };
	int iRen = 0;
	char cRespuesta[15] = { 0 };
	sprintf_s(cLog, "FC0200805021521277 - entra - encabezadoTalonCajas");
	grabarLog(cLog);
	if (iContadorSeguros < 3)
	{
		iRen = 14;
	}
	else
	{
		iRen = 15;
	}
	miniFecha(cRespuesta, (int)iDiaActual, (int)iMesActual, (int)iAnioActual);

	if (m_grid.lCliente == 1708L)
	{
		hoja.poner(cRespuesta, iRen + 1, 106);
	}
	else
	{
		hoja.poner(cRespuesta, iRen, 106);
	}

	sprintf_s(cRespuesta, "%04d", m_grid.iTienda);
	hoja.poner(cRespuesta, iRen, 125);

	sprintf_s(cRespuesta, "%02d", m_grid.iCaja);
	hoja.poner(cRespuesta, iRen, 130);

	if (bPagodeServicios)
	{
		consultarFolioCajas();
		lNumeroRecibo = lNumeroConsulta;
		bPagodeServicios = false;
	}
	sprintf_s(cRespuesta, "%06ld-%02d", lNumeroRecibo, iPagina);
	hoja.poner(cRespuesta, iRen, 114);
	if (iContadorSeguros != 0)
	{
		hoja.poner(cRespuesta, iRen - 2, 83);
	}
	else
	{
		hoja.poner(cRespuesta, iRen - 3, 83);
	}
}

void CDlgCapturarAbono::imprimirTotales(C_FormasPCL &hoja, long &lUstedDebia, int iContadorSeguros,
										int iFlagAnexo)
{
	char cLog[500] = { 0 };
	int iRen = 0;
	char cRespuesta[20] = { 0 };
	CString sTexto;

	sprintf_s(cLog, "FC0200805021521281 - entra - imprimirTotales");
	grabarLog(cLog);

	if (m_grid.lCliente == 1708)        //ETP
	{
		sprintf_s(cRespuesta, "%09ld %c", m_grid.lCliente, cTipoEtp[0]);
	}
	else
	{
		sprintf_s(cRespuesta, "%09ld %c", m_grid.lCliente, cPuntualidad[0]);
	}

	if (iFlagAnexo == 0)
	{
		sprintf_s(cRespuesta, "%09ld %c", m_grid.lCliente, cPuntualidad[0]);
	}

	if (iContadorSeguros == 0)
		iRen = 12;
	else
		if (iContadorSeguros == 1)
			iRen = 13 + iContadorSeguros - 1;
		else
			iRen = 13 + iContadorSeguros;
	if (iContadorSeguros != 0) iRen = 12;

	hoja.poner(cRespuesta, iRen, 105);

	if (iContadorSeguros == 0) iRen = 10; else iRen = 11 + iContadorSeguros - 1;
	if (iContadorSeguros != 0) iRen = 11;

	sprintf_s(cRespuesta, "%09ld", m_grid.lCliente);
	hoja.poner("CTE", iRen, 0);
	hoja.poner(cRespuesta, iRen, 4);

	miniFecha(cRespuesta, (int)iDiaActual, (int)iMesActual, (int)iAnioActual);
	hoja.poner(cRespuesta, iRen, 64);

	sprintf_s(cRespuesta, "%04d", m_grid.iTienda);
	hoja.poner(cRespuesta, iRen, 74);

	sprintf_s(cRespuesta, "%02d", m_grid.iCaja);
	hoja.poner(cRespuesta, iRen, 79);

	if (lUstedDebia > 0 || iContadorSeguros > 0)
	{
		{
			m_nombre.GetWindowText(sTexto);
			sprintf_s(cRespuesta, "%s", (LPCTSTR)sTexto);
			hoja.poner(cRespuesta, iRen, 14);

			m_apellidoPaterno.GetWindowText(sTexto);
			sprintf_s(cRespuesta, "%s", (LPCTSTR)sTexto);
			hoja.poner(cRespuesta, iRen, 30);

			m_apellidoMaterno.GetWindowText(sTexto);
			sprintf_s(cRespuesta, "%s", (LPCTSTR)sTexto);
			hoja.poner(cRespuesta, iRen, 47);

		}
	}
}

void CDlgCapturarAbono::imprimirImportesRecibo(C_FormasPCL &hoja, int iLinea, long &lUstedDebia, long &lSuAbono, long &lAhoraDebe,
											   long &lAbonoTotal, long &lInteresTotal, long &lDebeTotal, long &lVencidoTotal, long &lSaldaConTotal,
											   __int64 lFactura, char *cDescripcion, int iDiaVenta, int iMesVenta, int iAnioVenta, long lSaldo,
											   long lSuPago, long lInteresesAdicionales, long lVencidoGrid, long lSaldaConGrid, long lInteresAdiconalGrid, long lInteresMesUno)
{
	char cLog[500] = { 0 };
	char cFechaSalda[12] = { 0 }, cFechaPago[12] = { 0 }, cRespuestaAux[25] = { 0 }, cRespuesta[25] = { 0 }, cTexto[20] = { 0 };
	long lVencido = 0, lSaldaCon = 0, lDebe = 0L, lVencidoNuevo = 0L, lSaldaConNuevo = 0L, lAbonoCuenta = 0L, lAbonoInteres = 0L, lSaldaConNuevoRopa = 0L;
	int iDiaS = 0, iMesS, iAnioS, iPagado, k = 0, iMesRopa = 0,
		iAnioRopa = 0, iFlagSaldaConRopa = 0;
	short iTipoCtaBuscar = 0;

	SqlTimeStamp tFechaCorteRopa;

	sprintf_s(cLog, "FC0200805021521285 - entra - imprimirImportesRecibo");
	grabarLog(cLog);

	sprintf_s(cTexto, "%04d%02d%02d", iAnioActual, iMesActual, iDiaActual);

	lDebe = 0;
	lVencidoNuevo = 0;

	if (lFactura == 0) // ROPA, T.AIRE o REVOLVENTE
	{
		if (strncmp(cDescripcion, "T.AIRE", 6) == 0)
			iTipoCtaBuscar = 4;

		if (strncmp(cDescripcion, "COMP ADC  ", 8) == 0)
			iTipoCtaBuscar = 6;

		if (iDiaActual > 20 && iDiaActual <= 31)
		{
			//RECALCULAR EL IMPORTE DEL SALDACON DE ROPA
			iMesRopa = iMesActual + 1;
			iAnioRopa = iAnioActual;
			if (iMesRopa > 12)
			{
				iAnioRopa++;
				iMesRopa = 1;
			}
		}
		else
		{
			iMesRopa = iMesActual;
			iAnioRopa = iAnioActual;
		}

		sprintf_s(cTexto, "%04d-%02d-20", iAnioRopa, iMesRopa);

		CCuentaWeb *pCuentaRopa = new CCuentaWeb(m_grid.lCliente, cTexto, (short)m_grid.iTienda, (short)iCiudadGnDominio, cIpServidorCartera, cIpServidorCCuentaWeb, (short)iFlagTimeOutCCuenta);
		pCuentaRopa->leerCliente();

		if (pCuentaRopa->bClienteValido)
		{
			pCuentaRopa->leerCliente();

			switch (iTipoCtaBuscar)
			{
			case 4:
				pCuentaRopa->leerCuenta01("4");
				break;
			case 6:
				pCuentaRopa->leerCuenta01("6");
				break;
			default:
				pCuentaRopa->leerCuenta01("0");
				break;
			}

			for (k = 0; k < pCuentaRopa->iCuentas; k++)
			{
				if (pCuentaRopa->pCuenta[k].iTipoDeCuenta == iTipoCtaBuscar)
				{
					if (pCuentaRopa->pCuenta[k].lSaldo > 0)
					{
						lSaldaConNuevoRopa = pCuentaRopa->pCuenta[k].lSaldaCon;

						miniFecha(cFechaSalda, pCuentaRopa->pCuenta[k].tFechaSaldaCon.dia(), pCuentaRopa->pCuenta[k].tFechaSaldaCon.mes(), pCuentaRopa->pCuenta[k].tFechaSaldaCon.ano());
						strncpy_s(cFechaPago, cFechaSalda, 5);
						cFechaPago[5] = 0;
						iFlagSaldaConRopa = 1;
						break;
					}
				}
			}
		}

		delete pCuentaRopa;
	}
	if (lFactura != 0)
	{
		sprintf_s(cRespuesta, "%I64d", lFactura);
		hoja.poner(cRespuesta, iLinea, 25);

		if (cClaveA[0] == 'A')
		{
			hoja.poner("*", iLinea, 107);

			if (strncmp(cDescripcion, "PRESTAMO", 8) == 0)
			{
				hoja.poner("PRESTAMO", iLinea, 106);
			}
			else
			{
				hoja.poner(cRespuesta, iLinea, 108);
			}
		}
		else
		{
			if (strncmp(cDescripcion, "PRESTAMO", 8) == 0)
			{
				hoja.poner("PRESTAMO", iLinea, 106);
			}
			else if (strncmp(cDescripcion, "BANCOPPEL", 8) == 0)
			{
				hoja.poner("BANCOPPEL", iLinea, 106);
			}
			else if (strncmp(cDescripcion, "CREDITO Y CASA", 14) == 0)
			{
				hoja.poner(cRespuesta, iLinea, 105);
			}
			else
			{
				if (lFactura != 999999L)
					hoja.poner(cRespuesta, iLinea, 107);
			}
		}

		if (cClaveA[0] == 'A')
		{
			if (strncmp(cDescripcion, "PRESTAMO", 8) == 0)//Diana 21042006
			{
				hoja.poner("PRESTAMO", iLinea, 0);
			}
			else if (strncmp(cDescripcion, "BANCOPPEL", 8) == 0)//Diana 21042006
			{
				hoja.poner("BANCOPPEL", iLinea, 0);
			}
			else
			{
				hoja.poner("*MUEBLES  ", iLinea, 0);
			}
		}
		else
		{
			hoja.poner(cDescripcion, iLinea, 0);
		}
		memset(cRespuesta, 0, sizeof(cRespuesta));
		miniFecha(cRespuesta, (int)iDiaVenta, (int)iMesVenta, (int)iAnioVenta);

		if ((int)iAnioVenta > 99)
		{
			memcpy(cRespuestaAux, &cRespuesta[0], 5);
			memcpy(&cRespuestaAux[5], &cRespuesta[5], 2);
			cRespuestaAux[7] = 0;

			memcpy(&cRespuesta[0], &cRespuestaAux[0], 7);
			cRespuesta[7] = 0;
		}

		if (((memcmp(cConceptoCta, "CP ROPA", 7) != 0) && (memcmp(cConceptoCta, "CP MUEB", 7) != 0) && (memcmp(cConceptoCta, "CP PRES", 7) != 0) && (memcmp(cConceptoCta, "CP BANC", 7) != 0) && (memcmp(cConceptoCta, "CP T.AIRE", 9) != 0) && (memcmp(cConceptoCta, "CP COMP ADC", 11) != 0)))
			hoja.poner(cRespuesta, iLinea, 16);

		iDiaS = (int)iDiaVenta;
		iMesS = (int)iMesVenta;
		iAnioS = (int)iAnioVenta;

		if (memcmp(cConceptoCta, "CP ROPA", 7) == 0 || memcmp(cConceptoCta, "CP MUEB", 7) == 0 || memcmp(cConceptoCta, "CP T.AIRE", 9) == 0 || memcmp(cConceptoCta, "CP BANC", 7) == 0 || memcmp(cConceptoCta, "CP PRES", 7) == 0 || memcmp(cConceptoCta, "CP COMP ADC", 11) == 0)
		{
			iAnioS = iAnioActual;
			iMesS = iMesActual;
			iDiaS = 1;

			if (iDiaActual > iDiaS)
			{
				iMesS = iMesS + 1;
			}

			if (iMesS > 12)
			{
				iMesS = 1;
				iAnioS = iAnioS + 1;
			}
		}
		else
		{
			obtenerFechaSaldaCon(iAnioS, iMesS, iDiaS);
		}

		memset(cFechaSalda, 0, sizeof(cFechaSalda));
		miniFecha(cFechaSalda, iDiaS, iMesS, iAnioS);
		memset(cFechaPago, 0, sizeof(cFechaPago));
		strncpy_s(cFechaPago, cFechaSalda, 5);
		cFechaPago[5] = 0;
	}
	//calculo para quitar el interes primer mes cuando se abona pero no se paga el abono base
	if (lAbonoInteres == 0 && lInteresMesUno > 0)
	{
		lSaldo = lSaldo - lInteresMesUno;
		lVencidoGrid = lVencidoGrid - lInteresMesUno;
	}
	//hasta aqui
	memset(cRespuesta, 0, sizeof(cRespuesta));
	if (lSaldo < 0)
	{
		usingx("###,###", cRespuesta, 0L);
	}
	else
	{
		usingx("###,###", cRespuesta, lSaldo);
	}

	if (strncmp(cDescripcion, "CREDITO Y CASA", 14) != 0)
	{
		hoja.poner(cRespuesta, iLinea, 34);
	}

	if (lSaldo > 0)
		lUstedDebia += lSaldo;

	if ((lSuPago > 0 && lSaldo > 0 && lInteresesAdicionales > 0) ||
		(lSuPago > 0 && lInteresesAdicionales > 0) ||
		(lSuPago > 0 && lInteresMesUno > 0))
	{
		lAbonoCuenta = 0; lDebe = 0;
		lAbonoInteres = 0; lVencidoNuevo = 0;
		if (lInteresAdiconalGrid > lSuPago)
		{
			lAbonoInteres = lSuPago;
		}
		else
		{
			lAbonoInteres = lInteresAdiconalGrid;
			lAbonoCuenta = lSuPago - lInteresAdiconalGrid;
		}

		memset(cRespuesta, 0, sizeof(cRespuesta));
		usingx("###,###", cRespuesta, lAbonoCuenta);
		hoja.poner(cRespuesta, iLinea, 43);
		hoja.poner(cRespuesta, iLinea, 114);

		if (lAbonoInteres == 0 && lInteresMesUno > 0 && lSuPago >= (lVencidoGrid - lInteresMesUno))
		{
			memset(cRespuesta, 0, sizeof(cRespuesta));
			usingx("### B", cRespuesta, lInteresMesUno);
			hoja.poner(cRespuesta, iLinea, 53);
			hoja.poner(cRespuesta, iLinea, 124);
		}
		else
		{
			memset(cRespuesta, 0, sizeof(cRespuesta));
			usingx("###,###", cRespuesta, lAbonoInteres);
			hoja.poner(cRespuesta, iLinea, 52);
			hoja.poner(cRespuesta, iLinea, 123);
		}

		lAbonoTotal += lAbonoCuenta;
		lInteresTotal += lAbonoInteres;
	}
	else
	{
		memset(cRespuesta, 0, sizeof(cRespuesta));
		usingx("###,###", cRespuesta, 0L);
		if (strncmp(cDescripcion, "CREDITO Y CASA", 14) != 0)
		{
			hoja.poner(cRespuesta, iLinea, 52);
		}
		memset(cRespuesta, 0, sizeof(cRespuesta));
		usingx("###,###", cRespuesta, lSuPago);
		hoja.poner(cRespuesta, iLinea, 121);
		hoja.poner(cRespuesta, iLinea, 43);
		lSuAbono += lSuPago;
		lAbonoTotal += lSuPago;
	}
	lDebe = (lSaldo - lSuPago);
	if (lDebe < 0)
	{
		if ((lDebe * -1) > lSuPago)
		{
			lDebe = lSuPago * -1;
		}
	}

	if (lDebe > 0 && lSuPago < lSaldaConGrid)
	{
		iPagado = 1;
		memset(cRespuesta, 0, sizeof(cRespuesta));
		usingx("###,###", cRespuesta, lDebe);
		lDebeTotal += lDebe;
	}
	else
	{
		iPagado = 0;
		memset(cRespuesta, 0, sizeof(cRespuesta));
		usingx("###,###", cRespuesta, 0L);
	}

	if (strncmp(cDescripcion, "CREDITO Y CASA", 14) != 0)
	{
		hoja.poner(cRespuesta, iLinea, 60);        // USTED DEBE HOY...
	}
	if (lDebe > 0) lAhoraDebe += lDebe;

	if (lSuPago >= lSaldaConGrid)
	{
		lVencidoNuevo = 0L;
		lSaldoCtaTicket = 0;
	}
	else
	{
		lVencidoNuevo = lVencidoGrid - lSuPago;
		lVencidoFinalTicket = lVencidoNuevo;
		lSaldoCtaTicket = lVencidoNuevo;
	}

	if (lVencidoNuevo < 0)lVencidoNuevo = 0;
	memset(cRespuesta, 0, sizeof(cRespuesta));
	usingx("###,###", cRespuesta, lVencidoNuevo);                // ATRASADO...
	if (strncmp(cDescripcion, "CREDITO Y CASA", 14) != 0)
	{
		hoja.poner(cRespuesta, 6, iLinea, 69);
	}
	lVencido += lVencidoNuevo;
	lVencidoTotal += lVencidoNuevo;

	if (strncmp(cDescripcion, "PRESTAMO", 8) != 0 && strncmp(cDescripcion, "BANCOPPEL", 8) != 0 && iFlagTiendaLocal == 0 && strncmp(cDescripcion, "CREDITO Y CASA", 14) != 0 && VerificarCuentaBcpl(cDescripcion, "SOLEX") == 0)//Si no es cuenta de prestamos y tda no esta en modo local ...
	{                                                // SI LA TIENDA ESTA COMO LOCAL... NO IMPRIME EL IMPORTE NI LA FECHA DEL SALDA CON...
		lSaldaConNuevo = lSaldaConGrid - lSuPago;

		if (lSaldaConNuevo < 0) lSaldaConNuevo = 0;
		hoja.poner(ENFATIZAR, iLinea, 77);

		//Modif. 25May01
		memset(cRespuesta, 0, sizeof(cRespuesta));
		if (iPagado == 0)
		{
			usingx("###,###", cRespuesta, 0L);
			hoja.poner(cRespuesta, iLinea, 80);
		}
		else
		{
			usingx("###,###", cRespuesta, lSaldaConNuevo);
			hoja.poner(cRespuesta, iLinea, 80);
		}

		//entro a recalcular el saldacon de ropa o tiempo aire
		if (lFactura == 0 && iFlagSaldaConRopa == 1/* && strncmp(cDescripcion,"T.AIRE",8) != 0*/)
		{
			if (iPagado == 0)
			{
				usingx("###,###", cRespuesta, 0L);
				hoja.poner(cRespuesta, iLinea, 80);
			}
			else
			{
				usingx("###,###", cRespuesta, lSaldaConNuevoRopa);
				hoja.poner(cRespuesta, iLinea, 80);
			}
		}

		if (iPagado == 1)
		{
			if (memcmp(cConceptoCta, "CP ROPA", 7) == 0 || memcmp(cConceptoCta, "CP MUEB", 7) == 0 || memcmp(cConceptoCta, "CP T.AIRE", 9) == 0 || memcmp(cConceptoCta, "CP COMP ADC", 11) == 0)
			{
				hoja.poner("*", iLinea, 90);
			}
			else
			{
				hoja.poner(cFechaPago, iLinea, 88);
			}
		}
		else
		{
			if (cClaveA[0] != 'A')
			{
				hoja.poner("PAGADO", iLinea, 88);
			}
		}
	}
	if (strncmp(cDescripcion, "PRESTAMO", 8) == 0 || strncmp(cDescripcion, "BANCOPPEL", 8) == 0 || VerificarCuentaBcpl(cDescripcion, "SOLEX") == 1)//Cambio Diana 21042006
	{
		if (iPagado == 0)
		{
			hoja.poner("PAGADO", iLinea, 88);
		}
	}

	hoja.poner(NO_ENFATIZAR, iLinea, 94);

	if (strncmp(cDescripcion, "PRESTAMO", 8) != 0 && strncmp(cDescripcion, "BANCOPPEL", 8) != 0 && VerificarCuentaBcpl(cDescripcion, "SOLEX") == 0)//Cambio Diana 21042006
	{
		if (iPagado == 1)
		{
			lSaldaCon += lSaldaConNuevo;
			lSaldaConTotal += lSaldaConNuevo;
		}
		else
		{
			lSaldaCon += 0;
			lSaldaConTotal += 0;
		}
	}
	sprintf_s(cLog, "FC0200805021521289 - fin - imprimirImportesRecibo");
	grabarLog(cLog);
}

void CDlgCapturarAbono::fechaSaldaCon(int &iDiaS, int &iMesS, int &iAnioS)
{
	char cLog[500] = { 0 };
	int iDb1 = 0, iDb2 = 0, iDb3 = 0, iDb4 = 0, iDb5 = 0, iDb6 = 0, iDb7 = 0, iMm, iDit = 0, iMs = 0, iXflag = 0, iInts = 0,
		iDb2Tmp = 0, iDb3Tmp = 0, iDb4Tmp = 0, iDb5Tmp = 0,
		iDif1 = 0, iDif2 = 0, iDif3 = 0, iDif4 = 0, iDif5 = 0, iDif7 = 0, iFlagDiaOk = 0, iDif1Ori = 0, iDif2Ori = 0, iDif3Ori = 0, iDif4Ori = 0, iDif5Ori = 0, iDif7Ori = 0,
		iFlagD1 = 0, iFlagD2 = 0, iFlagD3 = 0, iFlagD4 = 0, iFlagD5 = 0, iFlagD7 = 0, iFlagPosicionNega = 0, iFlagx = 0, iFlagx1 = 0, iFlagx2 = 0, iFlagx3 = 0, iFlagx4 = 0, iFlagx5 = 0, iFlagx6 = 0, iFlagx7 = 0;
	char cTexto[15] = { 0 };

	sprintf_s(cLog, "FC0200805021521291 - entra - fechaSaldaCon");
	grabarLog(cLog);

	obtenerDatosCrCropa(iDb1, iDb2, iDb3, iDb4, iDb5, cTexto, iInts);
	iDb6 = (int)valor_campo(&cTexto[6], 2);
	iMs = (int)valor_campo(&cTexto[4], 2);
	iDb2Tmp = iDb2;
	iDb3Tmp = iDb3;
	iDb4Tmp = iDb4;
	iDb5Tmp = iDb5;
	iDb7 = 20;


	iMm = (int)iMesActual;

	switch (iMm)
	{
	case 1:
		iDit = 31;
		break;
	case 2:
		iDit = 28;
		break;
	case 3:
		iDit = 31;
		break;
	case 4:
		iDit = 30;
		break;
	case 5:
		iDit = 31;
		break;
	case 6:
		iDit = 30;
		break;
	case 7:
		iDit = 31;
		break;
	case 8:
		iDit = 31;
		break;
	case 9:
		iDit = 30;
		break;
	case 10:
		iDit = 31;
		break;
	case 11:
		iDit = 30;
		break;
	case 12:
		iDit = 31;
		break;
	default:
		break;
	}

	if (iDiaBonificacionRopa != 0 && iMesBonificacionRopa != 0 && iAnioBonificacionRopa != 1900)
	{
		if (iDb1 == 0)
		{
			iDb1 = iDb6;
		}

		iXflag = 1;

		if (iDb1 > 0)
		{
			iDb1 += 5;
			if (iDb1 > iDit)
			{
				iDb1 = iDb1 - iDit;
			}
		}
	}

	if (iDb1 == 0)
	{
		iDb1 = 1000;
		iFlagx = 1;
		iFlagx1 = 1;

	}
	if (iDb2 == 0)
	{
		iDb2 = 1000;
		iFlagx = 1;
		iFlagx2 = 1;
	}
	if (iDb3 == 0)
	{
		iDb3 = 1000;
		iFlagx = 1;
		iFlagx3 = 1;
	}
	if (iDb4 == 0)
	{
		iDb4 = 1000;
		iFlagx = 1;
		iFlagx4 = 1;
	}
	if (iDb5 == 0)
	{
		iDb5 = 1000;
		iFlagx = 1;
		iFlagx5 = 1;
	}
	if (iDb6 == 0)
	{
		iDb6 = 1000;
		iFlagx6 = 1;
		iFlagx = 1;
	}

	if (iDb7 == 0)
	{
		iDb7 = 1000;
		iFlagx7 = 1;
		iFlagx = 1;
	}
	if (iDb1 == 1000 && iDb2 == 1000 && iDb3 == 1000 && iDb4 == 1000
		&& iDb5 == 1000 && iDb7 == 20 && iXflag == 0 && iInts > 0)
	{
		iDiaS = iDb6;
		iFlagDiaOk = 9;
	}

	if (iDb1 == 1000 && iDb2 == 1000 && iDb3 == 1000 && iDb4 == 1000
		&& iDb5 == 1000 && iDb6 == 1000 && iDb7 == 20)
	{
		iDiaS = iDiaActual;
		iFlagDiaOk = 1;
	}
	else
	{
		iDif1 = iDb1 - iDiaActual;
		iDif2 = iDb2 - iDiaActual;
		iDif3 = iDb3 - iDiaActual;
		iDif4 = iDb4 - iDiaActual;
		iDif5 = iDb5 - iDiaActual;
		iDif7 = iDb7 - iDiaActual;

		iDif1Ori = iDb1 - iDiaActual;
		iDif2Ori = iDb2 - iDiaActual;
		iDif3Ori = iDb3 - iDiaActual;
		iDif4Ori = iDb4 - iDiaActual;
		iDif5Ori = iDb5 - iDiaActual;
		iDif7Ori = iDb7 - iDiaActual;
	}
	if (iDb1 == 1000 && iDb2 == 1000 && iDb3 == 1000 && iDb4 == 1000
		&& iDb5 == 1000 && iDb7 == 1000 && iFlagx6 == 0)
	{
		iDiaS = iDb6;
		if (iDb6 < iDiaActual)
		{
			iFlagD1 = 2;
		}
	}

	if (iDiaS == 0)
	{

		if (iDif1 >= 0 && iFlagx1 == 0) iFlagD1 = 1;
		if (iDif2 >= 0 && iFlagx2 == 0) iFlagD2 = 1;
		if (iDif3 >= 0 && iFlagx3 == 0) iFlagD3 = 1;
		if (iDif4 >= 0 && iFlagx4 == 0) iFlagD4 = 1;
		if (iDif5 >= 0 && iFlagx5 == 0) iFlagD5 = 1;
		if (iDif7 >= 0 && iFlagx7 == 0) iFlagD7 = 1;



		if ((iFlagD1 == 1 && iFlagD2 == 1 && iFlagD3 == 1 && iFlagD4 == 1 && iFlagD5 == 1 && iFlagD7 == 1) ||
			(iFlagD1 == 0 && iFlagD2 == 0 && iFlagD3 == 0 && iFlagD4 == 0 && iFlagD5 == 0 && iFlagD7 == 0))
		{
			iFlagPosicionNega = 1;
		}

		if (iFlagx == 1 && iFlagD1 == 0 && iFlagD2 == 0 && iFlagD3 == 0 && iFlagD4 == 0 && iFlagD5 == 0 && iFlagD7 == 0)
		{
			iFlagPosicionNega = 1;
		}

		if (iFlagPosicionNega == 0)
		{
			if (iDif1 < 0) iDif1 = 999;
			if (iDif2 < 0) iDif2 = 999;
			if (iDif3 < 0) iDif3 = 999;
			if (iDif4 < 0) iDif4 = 999;
			if (iDif5 < 0) iDif5 = 999;
			if (iDif7 < 0) iDif7 = 999;
		}
		if (iDif1 <= iDif2 && iDif1 <= iDif3 && iDif1 <= iDif4 && iDif1 <= iDif5 && iDif1 <= iDif7)
		{
			iDiaS = iDb1;
			if (iDif1Ori < 0)
			{
				iFlagD1 = 2;
			}
		}
		if (iDif2 <= iDif1 && iDif2 <= iDif3 && iDif2 <= iDif4 && iDif2 <= iDif5 && iDif2 <= iDif7)
		{
			iDiaS = (int)iDb2Tmp;
			if (iDif2Ori < 0)
			{
				iFlagD1 = 2;
			}
		}
		if (iDif3 <= iDif1 && iDif3 <= iDif2 && iDif3 <= iDif4 && iDif3 <= iDif5 && iDif3 <= iDif7)
		{
			iDiaS = (int)iDb3Tmp;
			if (iDif3Ori < 0)
			{
				iFlagD1 = 2;
			}
		}
		if (iDif4 <= iDif1 && iDif4 <= iDif2 && iDif4 <= iDif3 && iDif4 <= iDif5 && iDif4 <= iDif7)
		{
			iDiaS = (int)iDb4Tmp;
			if (iDif4Ori < 0)
			{
				iFlagD1 = 2;
			}
		}
		if (iDif5 <= iDif1 && iDif5 <= iDif2 && iDif5 <= iDif3 && iDif5 <= iDif4 && iDif5 <= iDif7)
		{
			iDiaS = (int)iDb5Tmp;
			if (iDif5Ori < 0)
			{
				iFlagD1 = 2;
			}
		}

		if (iDif7 <= iDif1 && iDif7 <= iDif2 && iDif7 <= iDif3 && iDif7 <= iDif4 && iDif7 <= iDif5)
		{
			iDiaS = 20;
			if (iDif7Ori < 0)
			{
				iFlagD1 = 2;
			}
		}
	}
	if (iFlagDiaOk == 9)
	{
		iMesS = iMs;
	}
	else
	{
		iMesS = (int)iMesActual;
	}
	iAnioS = (int)iAnioActual;

	if ((iFlagD1 == 2 && iFlagDiaOk == 0) || iFlagDiaOk == 9)
	{

		iMesS = iMesS + 1;


		if (iMesS > 12)
		{
			iMesS = 1;
			iAnioS = iAnioS + 1;
		}
	}

	if (iDiaS == 29 && iMesS == 2)
	{
		iDiaS = 1;
		iMesS = 3;
	}
	if (iDiaS == 30 && iMesS == 2)
	{
		iDiaS = 1;
		iMesS = 3;
	}
	if (iDiaS == 31 && iMesS == 2)
	{
		iDiaS = 1;
		iMesS = 3;
	}
	if (iDiaS == 31 && (iMesS == 4 || iMesS == 6 || iMesS == 9 || iMesS == 11))
	{
		iDiaS = 30;
	}
}

void CDlgCapturarAbono::obtenerDatosCrCropa(int &iDb1, int &iDb2, int &iDb3, int &iDb4, int &iDb5, char *cTexto, int &iInts)
{
	char cLog[500] = { 0 };
	char cSql[205] = { 0 };

	sprintf_s(cLog, "FC0200805021521296 - entra - obtenerDatosCrCropa");
	grabarLog(cLog);

	sprintf_s(cSql, "SELECT cliente,fechaultcompra,fechaultimacomprames1,fechaultimacomprames2,fechaultimacomprames3,fechaultimacomprames4,fechaultimacomprames5,interessobrecompra FROM crcropa WHERE cliente = %09ld", m_grid.lCliente);
	CObtenerFechaSaldaConCrCropa obtenerFechaSaldaConCrCropa(&odbc_1);

	if (!obtenerFechaSaldaConCrCropa.Exec(cSql))
	{
		//Se obtiene el error
		obtenerFechaSaldaConCrCropa.odbc->GetLastError(obtenerFechaSaldaConCrCropa.GetHstmt());
		grabarMensajeError("C", m_grid.iCaja, (LPTSTR)(LPCTSTR)m_grid.sServer, "CapturarAbono", "CDlgCapturarAbono", "obtenerDatosCrCropa", cSql, m_grid.lEmpleado, "ERROR EN LA CONSULTA(obtenerdatoscrcropa)", obtenerFechaSaldaConCrCropa.odbc, m_grid.iMuestraMsg);
	}
	else
	{
		obtenerFechaSaldaConCrCropa.activarCols();
		while (obtenerFechaSaldaConCrCropa.Leer())
		{
			sprintf(cTexto, "%04d%02d%02d", obtenerFechaSaldaConCrCropa.fechaultcompra.ano(), obtenerFechaSaldaConCrCropa.fechaultcompra.mes(), obtenerFechaSaldaConCrCropa.fechaultcompra.dia());
			if (obtenerFechaSaldaConCrCropa.fechaultimacomprames1.ano() != 1900)
				iDb1 = obtenerFechaSaldaConCrCropa.fechaultimacomprames1.dia();
			if (obtenerFechaSaldaConCrCropa.fechaultimacomprames2.ano() != 1900)
				iDb2 = obtenerFechaSaldaConCrCropa.fechaultimacomprames2.dia();
			if (obtenerFechaSaldaConCrCropa.fechaultimacomprames3.ano() != 1900)
				iDb3 = obtenerFechaSaldaConCrCropa.fechaultimacomprames3.dia();
			if (obtenerFechaSaldaConCrCropa.fechaultimacomprames4.ano() != 1900)
				iDb4 = obtenerFechaSaldaConCrCropa.fechaultimacomprames4.dia();
			if (obtenerFechaSaldaConCrCropa.fechaultimacomprames5.ano() != 1900)
				iDb5 = obtenerFechaSaldaConCrCropa.fechaultimacomprames5.dia();
			iInts = obtenerFechaSaldaConCrCropa.interessobrecompra;
		}
	}
}

void CDlgCapturarAbono::determinaMensajeRecibo(char *cMensaje, int iFlagNoDebe)
{
	char cLog[500] = { 0 };
	int  i, iFlagVencido = 0, iEdad = 0;
	long lTotalVencido = 0L, lVencido = 0L, lVencidoGrid = 0L, lSuPagoGrid = 0;
	char cRespuesta[60] = { 0 }, cTexto[10] = { 0 }, cTexto2[10] = { 0 };
	CUGCell m_cell;
	CString sTexto;

	sprintf_s(cLog, "FC0200805021521300 - entra - determinaMensajeRecibo");
	grabarLog(cLog);

	sprintf_s(cTexto, "%04d%02d", iAnioActual, iMesActual);
	sprintf_s(cTexto2, "%04d%02d", iAnioNacimiento, iMesNacimiento);
	iEdad = (valor_campo(cTexto, 6) - valor_campo(cTexto2, 6)) / 100L;

	memset(cMensaje, 0, sizeof(cMensaje));
	for (i = 0; i < iTotalCuentas; i++)
	{
		m_grid.QuickGetText(i, 15, &sTexto);
		sTexto.Remove(',');
		sTexto.Remove('.');
		sprintf_s(cRespuesta, "%s", (LPCTSTR)sTexto);
		lVencidoGrid = atol(cRespuesta);

		m_grid.QuickGetText(i, 21, &sTexto);
		sTexto.Remove(',');
		sTexto.Remove('.');
		sprintf_s(cRespuesta, "%s", (LPCTSTR)sTexto);
		lSuPagoGrid = atol(cRespuesta);

		if (iCandidatoAprobado == 1 && iAplicoDescuento == 1)
		{
			m_grid.QuickGetText(i, 32, &sTexto);
			sTexto.Trim(); sTexto.Remove(','); sTexto.Remove('.');
			sprintf_s(cRespuesta, "%s", (LPCTSTR)sTexto);
			lSuPagoGrid += atol(cRespuesta);
		}
		if (lVencidoGrid > 0)
		{
			if (lSuPagoGrid > 0)
			{
				lVencido = lVencidoGrid - lSuPagoGrid;
				if (lVencido < 0) lVencido = 0;
				if (lVencido > 0) iFlagVencido = 1;
			}
			else
			{
				lVencido = lVencidoGrid;
				iFlagVencido = 1;
			}
			lTotalVencido += lVencido;
		}
	}

	if (m_grid.lCliente > 0L)
	{
		switch (cPuntualidad[0])
		{
		case 'A':
			if (iFlagVencido == 1)
			{
				strcpy(cMensaje, "CONTINUE PAGANDO PUNTUALMENTE. NO DEJE PAGOS VENCIDOS");
			}
			else
			{
				if (iFlagNoDebe == 0)
				{
					strcpy(cMensaje, "       SEA PUNTUAL Y APROVECHE SU CREDITO");
				}
				else
				{
					strcpy(cMensaje, "           GRACIAS POR ABONAR PUNTUALMENTE           ");
				}
			}
			break;
		case 'B':
			if (iFlagVencido == 1)
			{
				strcpy(cMensaje, "PAGANDO OPORTUNAMENTE SE EVITA INTERESES ADICIONALES ");
			}
			else
			{
				strcpy(cMensaje, "         CONTINUE PAGANDO PUNTUALMENTE               ");
			}
			break;
		case 'C':
			if (iFlagVencido == 1)
			{
				usingx("###,###,###", cRespuesta, lTotalVencido);
				sprintf(cMensaje, "EVITE INTERESES ADICIONALES PAGUE  $%s VENCIDOS", cRespuesta);
			}
			else
			{
				strcpy(cMensaje, "         CONTINUE PAGANDO PUNTUALMENTE               ");
			}
			break;
		case 'D':
			if (iFlagVencido == 1)
			{
				usingx("###,###,###", cRespuesta, lTotalVencido);
				sprintf(cMensaje, "EVITE INTERESES ADICIONALES PAGUE  $%s VENCIDOS", cRespuesta);
			}
			else
			{
				strcpy(cMensaje, "PAGANDO OPORTUNAMENTE SE EVITA INTERESES ADICIONALES ");
			}
			break;
		case 'N':
			if (iFlagVencido != 1)
			{
				strcpy(cMensaje, "CONTINUE PAGANDO PUNTUALMENTE. NO DEJE PAGOS VENCIDOS");
			}
			else
			{
				strcpy(cMensaje, "PAGANDO OPORTUNAMENTE SE EVITA INTERESES ADICIONALES ");
			}
			break;
		case 'Z':
			if (iFlagVencido == 1)
			{
				usingx("###,###,###", cRespuesta, lTotalVencido);
				sprintf(cMensaje, "EVITE INTERESES ADICIONALES PAGUE  $%s VENCIDOS", cRespuesta);
			}
			else
			{
				strcpy(cMensaje, "PAGANDO OPORTUNAMENTE SE EVITA INTERESES ADICIONALES ");
			}
			break;
		default:
			if (iFlagVencido == 1)
			{
				strcpy(cMensaje, "PAGANDO OPORTUNAMENTE SE EVITA INTERESES ADICIONALES ");
			}
			else
			{
				strcpy(cMensaje, "CONTINUE PAGANDO PUNTUALMENTE. NO DEJE PAGOS VENCIDOS");
			}
			break;
		}
	}
}

void CDlgCapturarAbono::verificarVigenciaSeguros(int iCuenta1, int iCuenta2, int iCuenta3, int iContadorSeguros, C_FormasPCL &hoja, int iIndicadorSeguro, int iFlag)
{
	char cLog[500] = { 0 };
	int iCuenta, k = 0, iSeguroClub = 0, iSeguroVigente = 0, iStatusCuenta = -1;
	CUGCell m_cell;
	CString sTexto;
	char cRespuesta[20] = { 0 };
	long lSuPagoGrid = 0L;

	sprintf_s(cLog, "FC0200805021521306 - entra - verificarVigenciaSeguros");
	grabarLog(cLog);

	iCuenta = iCuenta1;
	for (k = 0; k < iContadorSeguros; k++)
	{
		m_grid.QuickGetText(iCuenta, 21, &sTexto);
		sTexto.Remove(',');
		sTexto.Remove('.');
		sprintf_s(cRespuesta, "%s", (LPCTSTR)sTexto);
		lSuPagoGrid = atol(cRespuesta);

		m_grid.QuickGetText(iCuenta, 29, &sTexto);
		sprintf_s(cRespuesta, "%s", (LPCTSTR)sTexto);
		iSeguroVigente = atoi(cRespuesta);

		m_grid.QuickGetText(iCuenta, 30, &sTexto);
		sprintf_s(cRespuesta, "%s", (LPCTSTR)sTexto);
		iStatusCuenta = atoi(cRespuesta);

		m_grid.QuickGetText(iCuenta, -1, &sTexto);
		sTexto.Trim();
		sprintf_s(cRespuesta, "%s", (LPCTSTR)sTexto);
		iSeguroClub = 0;
		if (memcmp(cRespuesta, "P.FAMILIAR", 10) == 0) iSeguroClub = 1;
		if (lSuPagoGrid == 0 || (iSeguroClub == 1 && iContadorSeguros > 1))
		{
			//seguro nuevo
			if (iSeguroVigente == 1 || iStatusCuenta == 0)  //seguro vigente
			{
				imprimirSeguroVigente(iCuenta1, iCuenta2, iCuenta3, hoja, iIndicadorSeguro, k, iFlag, iContadorSeguros);
			}
			else
			{
				if (iSeguroVigente == 0)   //seguro vencido
				{
					imprimirSeguroVencido(iCuenta1, iCuenta2, iCuenta3, hoja, iIndicadorSeguro, k);
				}
			}
		}
		if (iCuenta == iCuenta2)
		{
			iCuenta2 = iCuenta3;
		}
		iCuenta = iCuenta2;
	}
}

void CDlgCapturarAbono::imprimirSeguroVencido(int iCuenta1, int iCuenta2, int iCuenta3, C_FormasPCL &hoja, int &iIndicadorSeguro, int k)
{
	char cLog[500] = { 0 };
	int iRen = 0, iCuenta = 0, iCol, iDiaVenc = 0, iMesVenc = 0, iAnioVenc = 0, iSeguroClub = 0, iAnioVencCrSeguros = 0;
	char cMensaje[140] = { 0 }, cRespuestaAux[20] = { 0 }, cRespuesta[20] = { 0 }, cConcepto[15] = { 0 }, cRespuesta2[20] = { 0 }, cMensajeSeguimiento[50] = { 0 };
	long lFactura = 0L;
	CUGCell m_cell;
	CString sTexto;
	char cStatusSeguro = ' ', cTipoCan = ' ', cClaveNoOfrecer = ' ';
	bool bIndividual = false;

	sprintf_s(cLog, "FC0200805021521310 - entra - imprimirSeguroVencido");
	grabarLog(cLog);

	if (k == 0)
	{
		iRen = 6;
		iCuenta = iCuenta1;
	}
	else
	{
		if (k == 1)
		{
			iRen = 7;
			iCuenta = iCuenta2;
		}
		else
		{
			if (k == 2)
			{
				iRen = 8;
				iCuenta = iCuenta3;
			}
		}
	}

	m_grid.QuickGetText(iCuenta, 4, &sTexto);
	sTexto.Trim();
	sprintf_s(cRespuesta, "%s", (LPCTSTR)sTexto);
	iMesVenc = obtenerMes(cRespuesta);
	iAnioVenc = ano_2000_4dig((int)valor_campo(&cRespuesta[5], 2), iAnioActual);
	iDiaVenc = valor_campo(&cRespuesta[0], 2);

	m_grid.QuickGetText(iCuenta, 1, &sTexto);
	sTexto.Trim();
	lFactura = atol(sTexto);

	m_grid.QuickGetText(iCuenta, -1, &sTexto);
	sTexto.Trim();
	sprintf_s(cConcepto, "%s", (LPCTSTR)sTexto);
	iSeguroClub = 0;
	if (memcmp(cConcepto, "P.FAMILIAR", 10) == 0) iSeguroClub = 1;


	miniFecha(cRespuesta2, (int)iDiaVenc, (int)iMesVenc, (int)iAnioVenc);

	//IMPRIME SOLO PARA A¥O >= 2000
	if ((int)iAnioVenc > 99)
	{
		memcpy(cRespuestaAux, &cRespuesta[0], 5);
		memcpy(&cRespuestaAux[5], &cRespuesta[5], 2);
		cRespuestaAux[7] = 0;

		memcpy(&cRespuesta[0], &cRespuestaAux[0], 7);
		cRespuesta[7] = 0;
	}
	if (iSeguroClub != 1)
	{
		sprintf_s(cMensaje, "%06ld %s %s", lFactura, "NO TIENE SEGURO DE VIDA, VENCIO EL", cRespuesta);
		hoja.poner(cMensaje, iRen, 0);
		sprintf_s(cMensaje, "%06ld", lFactura);
	}
	else
	{
		sprintf_s(cMensajeSeguimiento, "Metodo TieneSeguroClub 5");
		grabarLog(cMensajeSeguimiento);
		bIndividual = tieneSeguroClub(cStatusSeguro, cTipoCan, cClaveNoOfrecer, lFactura, bCteSeguro);
		if (cStatusSeguro != 'P')
		{
			sprintf_s(cMensaje, "%06ld NO TIENE CLUB DE PROTECCIÓN FAMILIAR VENCIÓ EL %s", lFactura, cRespuesta);
			hoja.poner(cMensaje, iRen, 0);
			memset(cMensaje, 0, 140);
		}
	}
	if (iFlagBanorte != 0)
	{
		if (iIndicadorSeguro == 0)
		{
			iCol = 83;
		}
		else
		{
			iCol = 93;
		}
		//
		if (iRen == 6)
		{
			iCol = 83;
		}
		else
		{
			if (iRen == 6)
			{
				iCol = 93;
			}
			else
			{
				iCol = 103;
			}
		}
	}
	else
	{
		if (iIndicadorSeguro == 0)
		{
			iCol = 100;
		}
		else
		{
			iCol = 110;
		}
		//
		if (iRen == 6)
		{
			iCol = 100;
		}
		else
		{
			iCol = 110;
		}
	}

	hoja.poner(cMensaje, 8, iCol + 2);
	sprintf_s(cMensaje, "%s %s", "VENCIO EL", cRespuesta);
	hoja.poner(cMensaje, iRen, 102);
	iCuenta = iCuenta2;
}

void CDlgCapturarAbono::imprimirSeguroVigente(int iCuenta1, int iCuenta2, int iCuenta3, C_FormasPCL &hoja, int &iIndicadorSeguro, int k, int iFlag, int iContadorSeguros)
{
	char cLog[500] = { 0 };
	int  iRen = 8, iCuenta = -1, iCol, iNumeroSeguros, iDiaVenc = 0, iMesVenc = 0, iAnioVenc = 0,
		iSeguroClub = 0, iAnioVencCrSeguros = 0;
	char cMensaje[140] = { 0 }, cRespuesta2[20] = { 0 }, cRespuestaAux[20] = { 0 }, cRespuesta[50] = { 0 }, cConcepto[15] = { 0 };
	long lMontoRedondeo = 0, lMontoClub = 0L, lMontoSeguro = 0L, lMonto = 0L, lFactura = 0L, lSuPago = 0L,
		lFolioSeguroi = 0L, lFolioSeguroc = 0L;
	char cStatusSeguro = ' ', cTipoCan = ' ', cClaveNoOfrecer = ' ';
	CUGCell m_cell;
	CString sTexto;
	bool bIndividual = false, bConyugal = false;

	sprintf_s(cLog, "FC0200805021521314 - entra - imprimirSeguroVigente");
	grabarLog(cLog);

	if (k == 0)
	{
		iRen = 6;
		iCuenta = iCuenta1;
	}
	else
	{
		if (k == 1)
		{
			iRen = 7;
			iCuenta = iCuenta2;
		}
		else
		{
			if (k == 2)
			{
				iRen = 8;
				iCuenta = iCuenta3;
			}
		}
	}

	sTexto.Format("");
	m_grid.QuickGetText(iCuenta, 22, &sTexto);
	sTexto.Trim();
	iNumeroSeguros = atoi(sTexto);

	sTexto.Format("");
	m_grid.QuickGetText(iCuenta, 32, &sTexto);
	sTexto.Trim();
	iFlagMesUltimoMovimiento = atoi(sTexto);

	sTexto.Format("");
	m_grid.QuickGetText(iCuenta, 1, &sTexto);
	sTexto.Trim();
	lFactura = atol(sTexto);

	sTexto.Format("");
	m_grid.QuickGetText(iCuenta, -1, &sTexto);
	sTexto.Trim();
	sprintf_s(cConcepto, "%s", (LPCTSTR)sTexto);
	iSeguroClub = 0;
	if (memcmp(cConcepto, "P.FAMILIAR", 10) == 0) iSeguroClub = 1;

	sTexto.Format("");
	m_grid.QuickGetText(iCuenta, 21, &sTexto);
	sTexto.Remove(',');
	sTexto.Remove('.');
	sprintf_s(cRespuesta, "%s", (LPCTSTR)sTexto);
	lSuPago = atol(cRespuesta);

	sTexto.Format("");
	m_grid.QuickGetText(iCuenta, 4, &sTexto);
	sTexto.Trim();
	sprintf_s(cRespuesta, "%s", (LPCTSTR)sTexto);
	iMesVenc = obtenerMes(cRespuesta);
	iAnioVenc = ano_2000_4dig((int)valor_campo(&cRespuesta[5], 2), iAnioActual);
	iDiaVenc = valor_campo(&cRespuesta[0], 2);

	lMontoSeguro = obtenerMontoSeguro();
	lMonto = (long)(lMontoSeguro * iNumeroSeguros);
	lMontoRedondeo = redondear1000(lMonto);

	usingx("###,###", cRespuesta, lMontoRedondeo);
	miniFecha(cRespuesta2, (int)iDiaVenc, (int)iMesVenc, (int)iAnioVenc);

	//IMPRIME SOLO PARA A¥O >= 2000
	if ((int)iAnioVenc > 99)
	{
		memcpy(cRespuestaAux, &cRespuesta2[0], 5);
		memcpy(&cRespuestaAux[5], &cRespuesta2[5], 2);
		cRespuestaAux[7] = 0;

		memcpy(&cRespuesta2[0], &cRespuestaAux[0], 7);
		cRespuesta2[7] = 0;
	}
	// pone el mensaje SEGURO DE VIDA POR  $ 99,999 VENCE xx xxx xx
	memset(cMensaje, 0, 140);
	if (lFactura > 0L)
	{
		if (iSeguroClub != 1)
		{
			if (lSuPago != 0)
			{
				if (iFlag == 1)
					sprintf_s(cMensaje, "%05ld %02ld %s $%s %s %s", lFactura, iNumeroSeguros, "SEGURO DE", cRespuesta, "VENCE", cRespuesta2);
				else
					sprintf_s(cMensaje, "%05ld %02ld %s %s %s", lFactura, iNumeroSeguros, "SEGURO DE VIDA", "VENCE", cRespuesta2);
			}
			else
			{
				if (iFlag == 1)
					sprintf_s(cMensaje, "%05ld %s $%s %s %s", lFactura, "SEGURO DE", cRespuesta, "VENCE", cRespuesta2);
				else
					sprintf_s(cMensaje, "%05ld %s %s %s", lFactura, "SEGURO DE VIDA", "VENCE", cRespuesta2);
			}
		}
		else
		{
			{
				if (bBanderaTieneClub == false && iFlagBanorte == 4) //si no tiene seguro club
				{
					if ((iMesVenc + 1) > 12)
					{
						miniFecha(cRespuesta2, (int)iDiaVenc, (int)1, (int)(iAnioVenc + 1));
					}
					else
					{
						miniFecha(cRespuesta2, (int)iDiaVenc, (int)(iMesVenc + 1), (int)iAnioVenc);
					}
				}
				else
				{
					miniFecha(cRespuesta2, (int)iDiaVenc, (int)iMesVenc, (int)iAnioVenc);
				}
				cRespuesta2[7] = 0;
				grabarLog("Metodo TieneSeguroClub 6");
				bIndividual = tieneSeguroClub(cStatusSeguro, cTipoCan, cClaveNoOfrecer, lFolioSeguroi, bCteSeguro);

				if (cStatusSeguro != 'P')
				{
					consultarMontoSeguroClub(lMontoClub, (short)iNumeroSeguros, 1);

					usingx("###,###", cRespuesta, lMontoClub);
					cRespuesta[7] = 0;
					grabarLog("Metodo TieneSeguroClubConyugal 5");
					bConyugal = tieneSeguroClubConyugal(cStatusSeguro, cTipoCan, cClaveNoOfrecer, lFolioSeguroc);

					if (bIndividual && lFactura == lFolioSeguroi)
					{
						sprintf_s(cMensaje, "FOLIO:  %06ld AFILIADO AL CLUB CON %d SEGUROS : $ %s VENCE %s ", lFactura, iNumeroSeguros, cRespuesta, cRespuesta2);
					}
				}
			}
		}
		hoja.poner(cMensaje, iRen, 0);

		if (iFlagBanorte != 0)
		{
			if (iIndicadorSeguro == 0)
			{
				iCol = 83;
				iIndicadorSeguro = 1;
			}
			else
			{
				iCol = 93;
			}
			//
			if (iRen == 6)
			{
				iCol = 83;
			}
			else
			{
				if (iRen == 7)
				{
					iCol = 93;
				}
				else
				{
					iCol = 103;
				}
			}
		}
		else
		{
			if (iIndicadorSeguro == 0)
			{
				iCol = 93;
				iIndicadorSeguro = 1;
			}
			else
			{
				iCol = 103;
			}
			//
			if (iRen == 6)
			{
				iCol = 93;
			}
			else
			{
				iCol = 103;
			}
		}
		//
		memset(cMensaje, 0, 140);
		if (cSexoCliente[0] != ' ')
		{
			if (iSeguroClub != 1)
			{
				sprintf_s(cMensaje, "%05ld %c %c", lFactura, iFlagMesUltimoMovimiento, cSexoCliente[0]); //iFlagMesUltimoMovimiento el cambio de folio lo hace 1.
				if (iContadorSeguros == 3)
				{
					hoja.poner(cMensaje, 9, iCol + 9);
				}
				else
				{
					hoja.poner(cMensaje, 8, iCol + 9);
				}
			}
		}
		else
		{
			if (iCol == 100)
			{
				hoja.poner("SEGURO", 8, iCol);
				memset(cMensaje, 0, 140);
				sprintf_s(cMensaje, "%05ld", lFactura);
				if (lFactura > 0)
					hoja.poner(cMensaje, 8, iCol + 9);
			}
			else
			{
				memset(cMensaje, 0, 140);
				sprintf_s(cMensaje, "%05ld", lFactura);
				if (lFactura > 0)
					hoja.poner(cMensaje, 8, iCol + 9);
			}
		}
		memset(cMensaje, 0, 140);
		if (cSexoCliente[0] != ' ')
		{
			if (iSeguroClub != 1)
			{
				sprintf_s(cMensaje, "%02d-%02d %02ld %s", (int)iMesNacimiento, (int)iAnioNacimiento, iNumeroSeguros, cRespuesta2);
			}
		}
		else
		{
			memset(cMensaje, ' ', 140);
			if (lSuPago != 0)
			{
				sprintf_s(cMensaje, "%02ld %s", iNumeroSeguros, cRespuesta2);
			}
			else
			{
				sprintf_s(cMensaje, "%s", " ");
			}
		}
		// Imprime la parte del talon...
		hoja.poner(cMensaje, iRen, 102);
		iCuenta = iCuenta2;
	}
}

void CDlgCapturarAbono::imprimirDescuentoConyugal()
{
	char cLog[500] = { 0 };
	long lCuota = 0L, lCuotaConyugal = 0, lSuPagoGrid = 0L, lFolioGrid = 0L;
	int i, iDescuento = 0, iDescuentoMaximo = 0, iSeguro = 0, iEsClub = 0,
		iFlagConyugal = 0, iFlagConsulta = 0;
	char cRespuesta[80] = { 0 }, cSqlTxt[255] = { 0 }, cTexto[40] = { 0 };
	CString sTexto;
	bool bConsulta = false;
	CUGCell m_cell;

	sprintf_s(cLog, "FC0200805021521319 - entra - imprimirDescuentoConyugal");
	grabarLog(cLog);

	for (i = 0; i < iTotalCuentas; i++)
	{
		m_grid.QuickGetText(i, 21, &sTexto);
		sTexto.Remove(',');
		sTexto.Remove('.');
		sprintf_s(cRespuesta, "%s", (LPCTSTR)sTexto);
		lSuPagoGrid = atol(cTexto);

		m_grid.QuickGetText(i, 1, &sTexto);
		lFolioGrid = atol(sTexto);

		m_grid.QuickGetText(i, -1, &sTexto);
		sTexto.Trim();
		sprintf_s(cRespuesta, "%s", (LPCTSTR)sTexto);

		if (memcmp(cRespuesta, "SEGURO", 6) == 0 || memcmp(cRespuesta, "P.FAMILIAR", 10) == 0)
		{
			iSeguro = 1;
			if (memcmp(cRespuesta, "P.FAMILIAR", 10) == 0)
			{
				iEsClub = 1;
			}
			else
			{
				iEsClub = 0;
			}
		}
		else
		{
			iSeguro = 0;
		}
		if (iSeguro == 1 && lSuPagoGrid > 0L)
		{

			if (iEsClub == 0) //no es seguro club
			{
				iFlagConyugal = obtenerClaveConyugalCrSeguros(lFolioGrid);
				if (iFlagConyugal == 1)
				{
					//cawcuota.cpp
					lCuota = obtenerCuotaSeguro(iAnioNacimiento, iMesNacimiento, &odbc, cSqlTxt, bConsulta, iFlagConsulta);

					//cawcuota.cpp
					lCuotaConyugal = obtenerCuotaSeguro(iAnioNacimiento, iMesNacimiento, &odbc, cSqlTxt, bConsulta, iFlagConsulta);

					iDescuento = (lCuotaConyugal * 100L) / lCuota;
					iDescuento = 100 - iDescuento;

					if (iDescuento > iDescuentoMaximo) iDescuentoMaximo = iDescuento;
				}
			}
		}
	}
}

int CDlgCapturarAbono::obtenerClaveConyugalCrSeguros(long lFolio)
{
	char cLog[500] = { 0 };
	char cSql[90] = { 0 };
	int iClaveConyugal = 0;

	sprintf_s(cLog, "FC0200805021521323 - entra - obtenerClaveConyugalCrSeguros");
	grabarLog(cLog);

	sprintf_s(cSql, "SELECT claveconyugal FROM crseguros WHERE cliente = %09ld AND folio = %ld", m_grid.lCliente, lFolio);
	CConsultarClaveConyugalCrSeguros claveConyugalCrSeguros(&odbc_1);

	if (!claveConyugalCrSeguros.Exec(cSql))
	{
		//Se obtiene el error
		claveConyugalCrSeguros.odbc->GetLastError(claveConyugalCrSeguros.GetHstmt());
		grabarMensajeError("C", m_grid.iCaja, (LPTSTR)(LPCTSTR)m_grid.sServer, "CapturarAbono", "CDlgCapturarAbono", "obtenerClaveConyugalCrSeguros", cSql, m_grid.lEmpleado, "ERROR EN LA CONSULTA(obtenerClaveConyugaCrSeguros)", claveConyugalCrSeguros.odbc, m_grid.iMuestraMsg);
	}
	else
	{
		claveConyugalCrSeguros.activarCols();
		while (claveConyugalCrSeguros.Leer())
		{
			iClaveConyugal = claveConyugalCrSeguros.claveconyugal;
		}
	}
	return(iClaveConyugal);
}

int CDlgCapturarAbono::checarSiTieneConvenioUnico(void)
{
	char cLog[500] = { 0 };
	int i = 0, iFlag = 0, iTipoConvenio = 0, iDiaConvenio = 0, iMesConvenio = 0, iAnioVencCrSeguros = 0, iSubTipoConvenio = 0;
	CUGCell m_cell;
	CString sTexto, sAuxiliar;
	char cFechaConvenio[10] = { 0 };

	sprintf_s(cLog, "FC0200805021521327 - entra - checarSiTieneConvenioUnico");
	grabarLog(cLog);

	for (i = 0; i < iTotalCuentas; i++)
	{
		m_grid.QuickGetText(i, 7, &sTexto);
		sTexto.Trim();
		sprintf_s(cFechaConvenio, "%s", (LPCTSTR)sTexto);
		iMesConvenio = obtenerMes(cFechaConvenio);
		iDiaConvenio = valor_campo(&cFechaConvenio[0], 2);

		m_grid.QuickGetText(i, 27, &sTexto);
		iTipoConvenio = 0;
		iTipoConvenio = atoi(sTexto);

		m_grid.QuickGetText(i, 34, &sTexto);
		iSubTipoConvenio = 0;
		iSubTipoConvenio = atoi(sTexto);

		sAuxiliar.Format("%d%d", iTipoConvenio, iSubTipoConvenio);
		iTipoConvenio = atoi(sAuxiliar);

		if (iTipoConvenio == 12 && iDiaActual == iDiaConvenio && iMesActual == iMesConvenio)  //convenio unico
		{
			iFlag = 1;
		}
	}
	return iFlag;
}

void CDlgCapturarAbono::imprimirReciboConvenioUnico(C_FormasPCL &hoja)
{
	char cLog[500] = { 0 };
	int  i = 0, r = 0, iDia1 = 0, iDia2 = 0, iAnio = 0, iMes = 0, iDia = 0, iNConv = 0, iMesConvenio = 0,
		iDiaConvenio = 0, iTipoConvenio = 0, iSubTipoConvenio = 0, iPlazoConvenio = 0, iAnioVencCrSeguros = 0;
	int iTipoConvenioX = 0;
	long lConvenioTotal = 0L, lDeuda = 0L, lEfectuoConvenio = 0L, lImporteConvenio = 0L,
		lSaldoGrid = 0L, lSuPagoGrid = 0L, lFactura = 0L;
	char cRespuesta[80] = { 0 }, cFechaConvenio[10] = { 0 }, cDesc[20] = { 0 };
	CString sTexto;
	CUGCell m_cell;

	sprintf_s(cLog, "FC0200805021521331 - entra - imprimirReciboConvenioUnico");
	grabarLog(cLog);

	for (i = 0; i < iTotalCuentas; i++)
	{
		m_grid.QuickGetText(i, 7, &sTexto);
		sTexto.Trim();
		sprintf_s(cFechaConvenio, "%s", (LPCTSTR)sTexto);
		iMesConvenio = obtenerMes(cFechaConvenio);
		iDiaConvenio = valor_campo(&cFechaConvenio[0], 2);

		m_grid.QuickGetText(i, 9, &sTexto);
		sTexto.Trim();
		iPlazoConvenio = atoi(sTexto);

		m_grid.QuickGetText(i, 27, &sTexto);
		iTipoConvenio = 0;
		iTipoConvenio = atoi(sTexto);

		m_grid.QuickGetText(i, 34, &sTexto);
		iSubTipoConvenio = 0;
		iSubTipoConvenio = atoi(sTexto);

		sTexto.Format("%d%d", iTipoConvenio, iSubTipoConvenio);
		iTipoConvenioX = atoi(sTexto);

		m_grid.QuickGetText(i, 10, &sTexto);
		sTexto.Remove(',');
		sTexto.Remove('.');
		sprintf_s(cRespuesta, "%s", (LPCTSTR)sTexto);
		lImporteConvenio = atol(cRespuesta);

		m_grid.QuickGetText(i, 12, &sTexto);
		sTexto.Trim();
		sTexto.Remove(',');
		sTexto.Remove('.');
		lSaldoGrid = atol(sTexto);

		m_grid.QuickGetText(i, 21, &sTexto);
		sTexto.Remove(',');
		sTexto.Remove('.');
		sTexto.Trim();
		lSuPagoGrid = atol(sTexto);

		lDeuda += (lSaldoGrid - lSuPagoGrid);

		if (iTipoConvenioX == 12 && iDiaActual == iDiaConvenio && iMesActual == iMesConvenio)  //convenio unico
		{
			lConvenioTotal += lImporteConvenio;
			iDia2 = (int)iPlazoConvenio * 7;
			if (iDia2 > iDia1) iDia1 = iDia2;
		}
	}
	r = 12;
	iAnio = iAnioActual; iMes = iMesActual; iDia = iDiaActual;
	sumarDia(iDia1, iDia, iMes, iAnio); //gn_dia.cpp
	for (i = 0; i < iTotalCuentas; i++)
	{
		m_grid.QuickGetText(i, 7, &sTexto);
		sTexto.Trim();
		sprintf_s(cFechaConvenio, "%s", (LPCTSTR)sTexto);
		iMesConvenio = obtenerMes(cFechaConvenio);
		iDiaConvenio = valor_campo(&cFechaConvenio[0], 2);

		m_grid.QuickGetText(i, 27, &sTexto);
		iTipoConvenio = 0;
		iTipoConvenio = atoi(sTexto);

		m_grid.QuickGetText(i, 34, &sTexto);
		iSubTipoConvenio = 0;
		iSubTipoConvenio = atoi(sTexto);

		sTexto.Format("%d%d", iTipoConvenio, iSubTipoConvenio);
		iTipoConvenioX = atoi(sTexto);

		m_grid.QuickGetText(i, 8, &sTexto);
		sTexto.Trim();
		lEfectuoConvenio = atol(sTexto);
		lFactura = 0L;
		if (i > 0)
		{
			m_grid.QuickGetText(i, 1, &sTexto);
			sTexto.Trim();
			lFactura = atol(sTexto);
		}

		m_grid.QuickGetText(i, 10, &sTexto);
		sTexto.Remove(',');
		sTexto.Remove('.');
		sprintf_s(cRespuesta, "%s", (LPCTSTR)sTexto);
		lImporteConvenio = atol(cRespuesta);

		m_grid.QuickGetText(i, -1, &sTexto);
		sTexto.Remove(',');
		sprintf_s(cDesc, "%s", (LPCTSTR)sTexto);

		if (iTipoConvenioX == 12 && iDiaActual == iDiaConvenio && iMesActual == iMesConvenio)  //convenio unico
		{
			if (iNConv == 3 || iNConv == 6 || iNConv == 9)
			{
				usingx("###,###", cRespuesta, lDeuda);
				hoja.poner(cRespuesta, 3, 35);
				usingx("###,###", cRespuesta, lConvenioTotal);
				hoja.poner(cRespuesta, 5, 76);
				miniFecha(cRespuesta, (int)iDia, (int)iMes, (int)iAnio);
				hoja.poner(cRespuesta, 6, 6);
				hoja.poner(NORMAL, 20, 1);
				hoja.imprimir();
				r = 12;
			}
			iNConv++;
			if (iNConv == 1 || iNConv == 4 || iNConv == 7)
			{
				imprimirReciboConvenioUnicoxx(hoja, lEfectuoConvenio);
				usingx("###,###", cRespuesta, lDeuda);
				hoja.poner(cRespuesta, 3, 35);
				usingx("###,###", cRespuesta, lConvenioTotal);
				hoja.poner(cRespuesta, 5, 76);

				miniFecha(cRespuesta, (int)iDia, (int)iMes, (int)iAnio);
				hoja.poner(cRespuesta, 6, 6);
			}
			hoja.poner("NO.FACTURA:         IMPORTE:", r, 2);
			if (lFactura == 0L || memcmp(cDesc, "T.AIRE", 6) == 0)
			{
				if (memcmp(cDesc, "T.AIRE", 6) == 0)
				{
					hoja.poner("T.AIRE", r, 14);
				}
				else if (memcmp(cDesc, "COMP ADC", 8) == 0)
				{
					hoja.poner("COMP ADC", r, 13);
				}
				else
				{
					hoja.poner("ROPA", r, 15);
				}
			}
			else
			{
				usingx("######", cRespuesta, lFactura);
				hoja.poner(cRespuesta, r, 13);
			}
			usingx("###,###", cRespuesta, lImporteConvenio);
			hoja.poner(cRespuesta, r, 30);
			r++;
		}
	}
	usingx("###,###", cRespuesta, lDeuda);
	hoja.poner(cRespuesta, 3, 35);
	usingx("###,###", cRespuesta, lConvenioTotal);
	hoja.poner(cRespuesta, 5, 76);

	hoja.poner(cRespuesta, 7, 125);

	miniFecha(cRespuesta, (int)iDia, (int)iMes, (int)iAnio);
	hoja.poner(cRespuesta, 6, 6);

	hoja.poner(cRespuesta, 9, 113);

	hoja.poner(NORMAL, 20, 1);
	hoja.imprimir();
}

void CDlgCapturarAbono::imprimirReciboConvenioUnicoxx(C_FormasPCL &hoja, long lNumEmpleado)
{
	char cLog[500] = { 0 };
	char cRespuesta[80] = { 0 }, cEmpleado[10] = { 0 };
	CString sTexto;

	sprintf_s(cLog, "FC0200805021521336 - entra - imprimirReciboConvenioUnicoxx");
	grabarLog(cLog);

	hoja.poner(OCTAVOS, 0, 0);
	hoja.poner(COMPACTAR, 1, 1);
	miniFecha(cRespuesta, (int)iDiaActual, (int)iMesActual, (int)iAnioActual);
	hoja.poner(cRespuesta, 3, 2);
	hoja.poner("DEUDA TOTAL $                  NO.CTE:", 3, 22);
	usingx("#########", cRespuesta, m_grid.lCliente);
	hoja.poner(cRespuesta, 3, 60);
	hoja.poner("YO", 5, 2);

	m_nombre.GetWindowText(sTexto);
	sprintf_s(cRespuesta, "%s", (LPCTSTR)sTexto);
	hoja.poner(cRespuesta, 15, 5, 5);

	m_apellidoPaterno.GetWindowText(sTexto);
	sprintf_s(cRespuesta, "%s", (LPCTSTR)sTexto);
	hoja.poner(cRespuesta, 15, 5, 22);

	m_apellidoMaterno.GetWindowText(sTexto);
	sprintf_s(cRespuesta, "%s", (LPCTSTR)sTexto);
	hoja.poner(cRespuesta, 15, 5, 39);


	hoja.poner("ME COMPROMETO A PAGAR $        ANTES DEL", 5, 53);
	hoja.poner("DIA         EN LA TIENDA COPPEL. EN CASO DE NO CUMPLIR CON ESTE CONVENIO AUTORIZO AL DEPAR-", 6, 2);
	hoja.poner("TAMENTO DE COBRANZAS PARA QUE RECOJA LOS ARTICULOS SUFICIENTES PARA CUBRIR MI DEUDA.", 7, 2);
	hoja.poner("EL CUMPLIMIENTO DE ESTE CONVENIO,  LE PERMITIRA BENEFICIOS COMO: CONSERVAR SU CREDITO, MAS", 9, 2);
	hoja.poner("FACILIDADES AL COMPRAR, NO SER REPORTADOS A OTROS NEGOCIOS.", 10, 2);
	hoja.poner("NO.EMP.:", 14, 43);

	sprintf_s(cEmpleado, "%08ld", lNumEmpleado);
	lNumEmpleado = valor_campo(cEmpleado, 8);

	usingx("########", cRespuesta, lNumEmpleado);
	hoja.poner(cRespuesta, 14, 51);
	hoja.poner("--------------------------", 14, 63);
	hoja.poner("    FIRMA DEL EMPLEADO    ", 15, 63);

	hoja.poner("NO.CTE:", 3, 101);
	usingx("#########", cRespuesta, (double)m_grid.lCliente);
	hoja.poner(cRespuesta, 3, 109);

	hoja.poner("FECHA ACTUAL : ", 5, 100);

	miniFecha(cRespuesta, (int)iDiaActual, (int)iMesActual, (int)iAnioActual);
	hoja.poner(cRespuesta, 5, 115);

	hoja.poner("ME COMPROMETO A PAGAR :", 7, 100);

	hoja.poner("ANTES DEL : ", 9, 100);

	hoja.poner("--------------------------", 14, 100);
	hoja.poner("    FIRMA DEL CLIENTE     ", 15, 100);
}

bool CDlgCapturarAbono::crearTablaTemporal()
{
	char cLog[500] = { 0 };
	bool bResultado = false;
	char cSql[1385] = { 0 };

	sprintf_s(cLog, "FC0200805021521339 - entra - crearTablaTemporal");
	grabarLog(cLog);

	grabarLog("crearTablaTemporal::Creando tabla temporal tmpcagrabarabono");

	//crea la tabla temporal para la bd tienda.####        
	sprintf_s(cSql, "CREATE TEMPORARY TABLE tmpcagrabarabono(clave char(1) DEFAULT ' ',conceptocuenta char(10) DEFAULT ' '::bpchar,tienda int2 DEFAULT 0,factura int4 DEFAULT 0,fechacompra date DEFAULT now(),importe int4 DEFAULT 0,diapago int2 DEFAULT 0,fechavencimiento date DEFAULT now(),fechaultimomovimiento date DEFAULT now(),fechasaldacon date DEFAULT now(),fechaconvenio date DEFAULT now(),empleadoconvenio int4 DEFAULT 0,plazoconvenio int2 DEFAULT 0,importeconvenio int4 DEFAULT 0,saldo int4 DEFAULT 0,interesadicional int4 DEFAULT 0,base int4 DEFAULT 0,vencido int4 DEFAULT 0,minimo int4 DEFAULT 0, saldacon int4 DEFAULT 0,bonificacion int4 DEFAULT 0,supago int4 DEFAULT 0,numeroseguros int2 DEFAULT 0,numeromeses int2 DEFAULT 0,flagconyugal int2 DEFAULT 0, fechavencimientoanterior  date DEFAULT now(),saldaconanteriormuebles int4 DEFAULT 0,tipoconvenio int2 DEFAULT 0,flagcapturoconvenio int2 DEFAULT 0,status char  (1) DEFAULT ' ',cantidadanteriorseguros int2 DEFAULT 0, subtipoconvenio int2 DEFAULT 0, ipcarteracliente char(15)  DEFAULT ' ',interesprimermes int4 DEFAULT 0, tipoproducto int2 DEFAULT 0, minimototal int4 DEFAULT 0, saldototal int4 DEFAULT 0, vencidototal int4 DEFAULT 0, minimototalfinal int4 DEFAULT 0, saldototalfinal int4 DEFAULT 0, vencidototalfinal int4 DEFAULT 0, flagcuentaperdida smallint default 0,descuento int4 default 0) WITHOUT OIDS;");
	{
		CMaximo  Tabla(&odbc);
		if (!Tabla.Exec(cSql))
		{
			Tabla.odbc->GetLastError(Tabla.GetHstmt());
		}
		else
		{
			Tabla.Commit();
			bResultado = true;
		}
	}
	return  bResultado;
}

bool CDlgCapturarAbono::subirDatosTablaTemporal()
{
	char cLog[1024] = { 0 };
	bool bContinuar = true;
	int i = 0, iTiendaX = 0, iDiaX = 0, iMesX = 0, iAnioX = 0, iDiaPagoX = 0, iPlazoConvenioX = 0, iFlagCapturoConvenio = 0,
		iNumeroMesesX = 0, iNumeroSegurosX = 0, iFlagConyugalX = 0, iTipoConvenioX = 0, iSubTipoConvenioX = 0,
		iStatusCuenta = 0, iCantidadAnteriorSeguros = 0, iMesesVencido = 0, iTipoCuenta = 0, iNumFactura = 0, iPorcentajeBonificacion = 0L;
	long lFacturaX = 0L, lImporteX = 0L, lEfectuoConvenioX = 0L, lImporteConvenioX = 0L,
		lBonificacionX = 0L, lSaldaConX = 0L, lVencidoX = 0L, lMinimoX = 0L, lSaldaConAntMueblesX = 0L,
		lBaseX = 0L, lInteresAdicionalX = 0L, lSaldoX = 0L, lSuPagoX = 0L, lInteresPrimerMesX = 0,
		lMinimoTotal = 0, lSaldoTotal = 0, lVencidoTotal = 0, lCantidad = 0,
		lMinimoTotalFinal = 0, lSaldoTotalFinal = 0, lVencidoTotalFinal = 0;
	char cConcepto[20] = { 0 }, cConceptoTmp[20] = { 0 }, cFechaCompra[25] = { 0 }, cRespuesta[80] = { 0 }, cFechaVencimiento[25] = { 0 },
		cFechaUltMov[25] = { 0 }, cFechaSaldaCon[25] = { 0 }, cFechaConvenio[25] = { 0 }, cFechaVencimientoAnt[25] = { 0 },cFechaCRTP[25] = { 0 };
	char cTexto1[15] = { 0 }, cTexto2[15] = { 0 };
	CString sTexto, fecUltimacompra, sFechaCompraCRTP = "";

	sprintf_s(cLog, "FC0200805021521343 - entra - subirDatosTablaTemporal");
	grabarLog(cLog);

	jsonImporte = "";
	jsonImporte.Append("[");


	grabarLog("subirDatosTablaTemporal::Subiendo datos a tabla temporal tmpcagrabarabono");

	{
		CTmpCaGrabarAbono tmpCaGrabarAbono(&odbc);
		tmpCaGrabarAbono.prepararInsert("tmpCaGrabarAbono");

		iCtaPerdida = 0;

		m_grid2.QuickGetText(0, 12, &sTexto);
		sTexto.Trim();
		sTexto.Remove(','); sTexto.Remove('.');
		lSaldoTotal = atol(sTexto);

		m_grid2.QuickGetText(0, 15, &sTexto);
		sTexto.Trim();
		sTexto.Remove(','); sTexto.Remove('.');
		lVencidoTotal = atol(sTexto);

		m_grid2.QuickGetText(0, 16, &sTexto);
		sTexto.Trim();
		sTexto.Remove(','); sTexto.Remove('.');
		lMinimoTotal = atol(sTexto);

		tmpCaGrabarAbono.minimototalfinal = 0;
		tmpCaGrabarAbono.saldototalfinal = 0;
		tmpCaGrabarAbono.vencidototalfinal = 0;

		for (i = 0; i < iTotalCuentas; i++)
		{
			m_grid.QuickGetText(i, 21, &sTexto);
			sTexto.Trim(); sTexto.Remove(','); sTexto.Remove('.');
			sprintf_s(cRespuesta, "%s", (LPCTSTR)sTexto);
			lSuPagoX = atol(cRespuesta);



			m_grid.QuickGetText(i, 12, &sTexto);
			sTexto.Trim(); sTexto.Remove(','); sTexto.Remove('.');
			sprintf_s(cRespuesta, "%s", (LPCTSTR)sTexto);
			lSaldoX = atol(cRespuesta);



			m_grid.QuickGetText(i, 14, &sTexto);
			sTexto.Trim(); sTexto.Remove(','); sTexto.Remove('.');
			sprintf_s(cRespuesta, "%s", (LPCTSTR)sTexto);
			lBaseX = atol(cRespuesta);



			m_grid.QuickGetText(i, 15, &sTexto);
			sTexto.Trim(); sTexto.Remove(','); sTexto.Remove('.');
			sprintf_s(cRespuesta, "%s", (LPCTSTR)sTexto);
			lVencidoX = atol(cRespuesta);



			m_grid.QuickGetText(i, 16, &sTexto);
			sTexto.Trim(); sTexto.Remove(','); sTexto.Remove('.');
			sprintf_s(cRespuesta, "%s", (LPCTSTR)sTexto);
			lMinimoX = atol(cRespuesta);


			m_grid.QuickGetText(i, 35, &sTexto);
			sTexto.Trim(); sTexto.Remove(','); sTexto.Remove('.');
			sprintf_s(cRespuesta, "%s", (LPCTSTR)sTexto);
			lInteresPrimerMesX = atol(cRespuesta);

			m_grid.QuickGetText(i, 13, &sTexto);
			sTexto.Trim(); sTexto.Remove(','); sTexto.Remove('.');
			sprintf_s(cRespuesta, "%s", (LPCTSTR)sTexto);
			lInteresAdicionalX = atol(cRespuesta);

			m_grid.QuickGetText(i, 18, &sTexto);
			sTexto.Trim(); sTexto.Remove(','); sTexto.Remove('.');
			sprintf_s(cRespuesta, "%s", (LPCTSTR)sTexto);
			lSaldaConX = atol(cRespuesta);

			if (iCandidatoAprobado == 1 && iAplicoDescuento == 1)
			{
				m_grid.QuickGetText(i, 32, &sTexto);
				sTexto.Trim(); sTexto.Remove(','); sTexto.Remove('.');
				sprintf_s(cRespuesta, "%s", (LPCTSTR)sTexto);
				lSuPagoX += atol(cRespuesta);
			}

			if (lSuPagoX < lSaldaConX)
			{
				if (lBaseX != 0)
				{
					iMesesVencido = (lVencidoX - lInteresAdicionalX) / lBaseX;

					lCantidad = lMinimoX - lSuPagoX;
					if (lCantidad < 0)
					{
						lCantidad = 0;
					}
					lMinimoTotalFinal += lCantidad;
					if (iMesesVencido == 1)
					{
						lCantidad = lSaldoX - lSuPagoX - lInteresPrimerMesX;
					}
					else
					{
						lCantidad = lSaldoX - lSuPagoX;
					}

					if (lCantidad < 0)
					{
						lCantidad = 0;
					}
					lSaldoTotalFinal += lCantidad;
					if (iMesesVencido == 1)
					{
						lCantidad = lVencidoX - lSuPagoX - lInteresPrimerMesX;
					}
					else
					{
						lCantidad = lVencidoX - lSuPagoX;
					}
					if (lCantidad < 0)
					{
						lCantidad = 0;
					}
					lVencidoTotalFinal += lCantidad;
				}
				else
				{
					lCantidad = lMinimoX - lSuPagoX;
					lVencidoTotalFinal += lCantidad;
				}
			}
		}


		for (i = 0; i < iTotalCuentas; i++)
		{
			//inicializar variables
			iTiendaX = 0, iDiaX = 0, iMesX = 0, iAnioX = 0, iDiaPagoX = 0, iPlazoConvenioX = 0, iNumeroMesesX = 0, iNumeroSegurosX = 0, iFlagConyugalX = 0, iTipoConvenio = 0;
			lFacturaX = 0L, lImporteX = 0L, lEfectuoConvenioX = 0L, lImporteConvenioX = 0L, lBonificacionX = 0L, lSaldaConX = 0L, lVencidoX, lMinimoX = 0L, lSaldaConAntMueblesX = 0L, lBaseX = 0L, lInteresAdicionalX = 0L, lSaldoX = 0L, lSuPagoX = 0L;
			memset(cConcepto, 0, 20);
			memset(cRespuesta, 0, 80);

			tmpCaGrabarAbono.flagcuentaperdida = 0;

			sprintf_s(cFechaCompra, "%02d-%02d-%04d 00:00:00", 1, 1, 1900);
			cFechaCompra[19] = 0;

			sprintf_s(cFechaCRTP, "%04d-%02d-%02d", 1900, 1, 1);
			cFechaCRTP[10] = 0;

			printf_s(sFechaCompraCRTP, "%04d-%02d-%02d", 1900, 1, 1);

			sprintf_s(cFechaVencimiento, "%02d-%02d-%04d 00:00:00", 1, 1, 1900);
			cFechaVencimiento[19] = 0;

			sprintf_s(cFechaUltMov, "%02d-%02d-%04d 00:00:00", 1, 1, 1900);
			cFechaUltMov[19] = 0;

			sprintf_s(cFechaSaldaCon, "%02d-%02d-%04d 00:00:00", 1, 1, 1900);
			cFechaSaldaCon[19] = 0;

			sprintf_s(cFechaConvenio, "%02d-%02d-%04d 00:00:00", 1, 1, 1900);
			cFechaConvenio[19] = 0;

			sprintf_s(cFechaVencimientoAnt, "%02d-%02d-%04d 00:00:00", 1, 1, 1900);
			cFechaVencimientoAnt[19] = 0;

			m_grid.QuickGetText(i, -1, &sTexto);
			sTexto.Trim();
			sprintf_s(cConcepto, "%s", (LPCTSTR)sTexto);

			/*se agrega para obtener el tipo de cuenta*/
			m_grid.QuickGetText(i, 01, &sTexto);
			sTexto.Trim();
			sTexto.Remove(',');
			sTexto.Remove('.');
			sprintf_s(cRespuesta, "%s", (LPCTSTR)sTexto);
			iNumFactura = atol(cRespuesta);

			m_grid.QuickGetText(i, 37, &sTexto);
			sTexto.Trim();
			sTexto.Remove(',');
			sTexto.Remove('.');
			sprintf_s(cRespuesta, "%s", (LPCTSTR)sTexto);
			iTipoCuenta = atol(cRespuesta);

			//porcentaje de bonificacion
			m_grid.QuickGetText(i, 38, &sTexto);
			sTexto.Trim();
			sTexto.Remove(',');
			sTexto.Remove('.');
			sprintf_s(cRespuesta, "%s", (LPCTSTR)sTexto);
			iPorcentajeBonificacion = atol(cRespuesta);

			//fecha ultima compra
			m_grid.QuickGetText(i, 39, &sTexto);
			fecUltimacompra.Format("%s", sTexto);
			/*sTexto.Trim();
			sTexto.Remove(',');
			sTexto.Remove('.');
			sprintf_s(cRespuesta,"%s",sTexto);
			fecUltimacompra = atol( cRespuesta );*/

			if (memcmp(cConcepto, "ROPA", 4) != 0 && memcmp(cConcepto, "T.AIRE", 6) != 0 && memcmp(cConcepto, "COMP ADC", 8) != 0 && memcmp(cConcepto, "CP COMP ADC", 11) != 0)
			{
				m_grid.QuickGetText(i, 0, &sTexto);
				sTexto.Trim();
				iTiendaX = atoi(sTexto);
				if (iTiendaX < 0) iTiendaX = 0;

				m_grid.QuickGetText(i, 1, &sTexto);
				sTexto.Trim();
				lFacturaX = atol(sTexto);
				if (memcmp(cConcepto, "P.FAMILIAR", 10) == 0)
				{
					lFacturaX = iFoliosSegurosActual[0];
				}
			}

			m_grid.QuickGetText(i, 2, &sTexto);
			sTexto.Trim();
			sprintf_s(cConceptoTmp, "%s", (LPCTSTR)sTexto);

			if ((memcmp(cConceptoTmp, "CP ROPA", 7) == 0 || memcmp(cConceptoTmp, "CP T.AIRE", 9) == 0 || memcmp(cConceptoTmp, "CP COMP ADC", 11) == 0) && iFlagDespliegaDatosZ == 1)
			{
				iCtaPerdida = 1;
				lFacturaX = 999999;
			}

			if (memcmp(cConceptoTmp, "CP ROPA", 7) == 0 || memcmp(cConceptoTmp, "CP MUEB", 7) == 0 || memcmp(cConceptoTmp, "CP PRES", 7) == 0 || memcmp(cConceptoTmp, "CP T.AIRE", 9) == 0 ||
				memcmp(cConceptoTmp, "CP BANC", 7) == 0 || memcmp(cConceptoTmp, "CP COMP ADC", 11) == 0)
			{
				tmpCaGrabarAbono.flagcuentaperdida = 1;
			}

			if (memcmp(cConceptoTmp, "CP PRES", 7) == 0 && iFlagDespliegaDatosZ == 1)
			{
				m_grid.QuickGetText(i, 1, &sTexto);
				sTexto.Trim();
				lFacturaX = atol(sTexto);
			}

			if (memcmp(cConcepto, "SEGURO", 6) != 0 &&
				memcmp(cConcepto, "P.FAMILIAR", 10) != 0 &&
				memcmp(cConcepto, "P.SALUD", 7) != 0 &&
				memcmp(cConcepto, "ROPA", 4) != 0 &&
				memcmp(cConcepto, "T.AIRE", 6) != 0 &&
				memcmp(cConcepto, "COMP ADC", 8) != 0 &&
				memcmp(cConcepto, "AUTO PROT.", 10) != 0 &&
				memcmp(cConcepto, "CP COMP ADC", 11) != 0)
			{
				m_grid.QuickGetText(i, 3, &sTexto);
				sTexto.Trim();
				sTexto.Remove(',');
				sTexto.Remove('.');
				sprintf_s(cRespuesta, "%s", (LPCTSTR)sTexto);
				lImporteX = atol(cRespuesta);

				m_grid.QuickGetText(i, 4, &sTexto);
				sTexto.Trim();
				iDiaPagoX = atoi(sTexto);

				m_grid.QuickGetText(i, 2, &sTexto);
				sTexto.Trim();
				sprintf_s(cRespuesta, "%s", (LPCTSTR)sTexto);

				iDiaX = 0, iMesX = 0, iAnioX = 0;
				iMesX = obtenerMes(cRespuesta);
				iDiaX = valor_campo(&cRespuesta[0], 2);
				iAnioX = ano_2000_4dig((int)valor_campo(&cRespuesta[5], 2), iAnioActual);
				if (iMesX > 0 && iDiaX > 0 && iAnioX > 0)
				{
					sprintf_s(cFechaCompra, "%02d-%02d-%04d 00:00:00", iMesX, iDiaX, iAnioX);
					cFechaCompra[19] = 0;

					sprintf_s(cFechaCRTP, "%04d-%02d-%02d", iAnioX, iMesX, iDiaX);
					cFechaCRTP[10] = 0;

					sFechaCompraCRTP=cFechaCRTP;
				}

				m_grid.QuickGetText(i, 5, &sTexto);
				sTexto.Trim();
				sprintf_s(cRespuesta, "%s", (LPCTSTR)sTexto);
				iDiaX = 0, iMesX = 0, iAnioX = 0;
				iMesX = obtenerMes(cRespuesta);
				iDiaX = valor_campo(&cRespuesta[0], 2);
				iAnioX = ano_2000_4dig((int)valor_campo(&cRespuesta[5], 2), iAnioActual);
				if (iMesX > 0 && iDiaX > 0 && iAnioX > 0)
				{
					sprintf_s(cFechaUltMov, "%02d-%02d-%04d 00:00:00", iMesX, iDiaX, iAnioX);
					cFechaUltMov[19] = 0;
				}

				m_grid.QuickGetText(i, 7, &sTexto);
				sTexto.Trim();
				sprintf_s(cRespuesta, "%s", (LPCTSTR)sTexto);
				iDiaX = 0, iMesX = 0, iAnioX = 0;
				iMesX = obtenerMes(cRespuesta);
				iDiaX = valor_campo(&cRespuesta[0], 2);
				iAnioX = ano_2000_4dig((int)valor_campo(&cRespuesta[5], 2), iAnioActual);

				if (iMesX > 0 && iDiaX > 0 && iAnioX > 0)
				{
					sprintf_s(cFechaConvenio, "%02d-%02d-%04d 00:00:00", iMesX, iDiaX, iAnioX);
					cFechaConvenio[19] = 0;
				}

				m_grid.QuickGetText(i, 8, &sTexto);
				sTexto.Trim();
				lEfectuoConvenioX = atol(sTexto);

				m_grid.QuickGetText(i, 9, &sTexto);
				sTexto.Trim();
				iPlazoConvenioX = atoi(sTexto);

				m_grid.QuickGetText(i, 10, &sTexto);
				sTexto.Trim();
				lImporteConvenioX = atol(sTexto);

				m_grid.QuickGetText(i, 26, &sTexto);
				sTexto.Trim();
				lSaldaConAntMueblesX = atol(sTexto);

				m_grid.QuickGetText(i, 27, &sTexto);
				sTexto.Trim();
				iTipoConvenioX = atoi(sTexto);

				m_grid.QuickGetText(i, 34, &sTexto);
				sTexto.Trim();
				iSubTipoConvenioX = atoi(sTexto);

				tmpCaGrabarAbono.clave[0] = 'M';
				tmpCaGrabarAbono.clave[1] = 0;

				if (memcmp(cConcepto, "PRESTAMO", 8) == 0)
				{
					tmpCaGrabarAbono.clave[0] = 'P';
					tmpCaGrabarAbono.clave[1] = 0;
				}
				else if (memcmp(cConcepto, "BANCOPPEL", 8) == 0 || VerificarCuentaBcpl(cConcepto, "SOLEX") == 1)
				{
					tmpCaGrabarAbono.clave[0] = 'B';
					tmpCaGrabarAbono.clave[1] = 0;
				}
			}
			else
			{
				if (memcmp(cConcepto, "ROPA", 4) == 0 || memcmp(cConcepto, "T.AIRE", 6) == 0 || memcmp(cConcepto, "COMP ADC", 8) == 0 || memcmp(cConcepto, "CP COMP ADC", 11) == 0)
				{
					if (memcmp(cConcepto, "T.AIRE", 6) == 0)
					{
						tmpCaGrabarAbono.clave[0] = 'T';
						tmpCaGrabarAbono.clave[1] = 0;
					}
					else if (memcmp(cConcepto, "COMP ADC", 8) == 0 || memcmp(cConcepto, "CP COMP ADC", 11) == 0)
					{
						tmpCaGrabarAbono.clave[0] = 'V';
						tmpCaGrabarAbono.clave[1] = 0;
					}
					else
					{
						tmpCaGrabarAbono.clave[0] = 'R';
						tmpCaGrabarAbono.clave[1] = 0;
					}

					m_grid.QuickGetText(i, 4, &sTexto);
					sTexto.Trim();
					iDiaPagoX = atoi(sTexto);

					m_grid.QuickGetText(i, 5, &sTexto);
					sTexto.Trim();
					sprintf_s(cRespuesta, "%s", sTexto);
					iDiaX = 0, iMesX = 0, iAnioX = 0;
					iMesX = obtenerMes(cRespuesta);
					iDiaX = valor_campo(&cRespuesta[0], 2);
					iAnioX = ano_2000_4dig((int)valor_campo(&cRespuesta[5], 2), iAnioActual);

					if (iMesX > 0 && iDiaX > 0 && iAnioX > 0)
					{
						sprintf_s(cFechaUltMov, "%02d-%02d-%04d 00:00:00", iMesX, iDiaX, iAnioX);
						cFechaUltMov[19] = 0;
					}

					m_grid.QuickGetText(i, 6, &sTexto);
					sTexto.Trim();
					sprintf_s(cRespuesta, "%s", (LPCTSTR)sTexto);
					iDiaX = 0, iMesX = 0, iAnioX = 0;
					iMesX = obtenerMes(cRespuesta);
					iDiaX = valor_campo(&cRespuesta[0], 2);
					iAnioX = ano_2000_4dig((int)valor_campo(&cRespuesta[5], 2), iAnioActual);

					if (iMesX > 0 && iDiaX > 0 && iAnioX > 0)
					{
						sprintf_s(cFechaSaldaCon, "%02d-%02d-%04d 00:00:00", iMesX, iDiaX, iAnioX);
						cFechaSaldaCon[19] = 0;
					}

					m_grid.QuickGetText(i, 7, &sTexto);
					sTexto.Trim();
					sprintf_s(cRespuesta, "%s", (LPCTSTR)sTexto);
					iDiaX = 0, iMesX = 0, iAnioX = 0;
					iMesX = obtenerMes(cRespuesta);
					iDiaX = valor_campo(&cRespuesta[0], 2);
					iAnioX = ano_2000_4dig((int)valor_campo(&cRespuesta[5], 2), iAnioActual);
					if (iMesX > 0 && iDiaX > 0 && iAnioX > 0)
					{
						sprintf_s(cFechaConvenio, "%02d-%02d-%04d 00:00:00", iMesX, iDiaX, iAnioX);
						cFechaConvenio[19] = 0;
					}

					m_grid.QuickGetText(i, 8, &sTexto);
					sTexto.Trim();
					lEfectuoConvenioX = atol(sTexto);

					m_grid.QuickGetText(i, 9, &sTexto);
					sTexto.Trim();
					iPlazoConvenioX = atoi(sTexto);

					m_grid.QuickGetText(i, 10, &sTexto);
					sTexto.Trim();
					lImporteConvenioX = atol(sTexto);

					m_grid.QuickGetText(i, 27, &sTexto);
					sTexto.Trim();
					iTipoConvenioX = atoi(sTexto);

					m_grid.QuickGetText(i, 34, &sTexto);
					sTexto.Trim();
					iSubTipoConvenioX = atoi(sTexto);

				}
				else if (memcmp(cConcepto, "AUTO PROT.", 10) == 0)
				{
					tmpCaGrabarAbono.clave[0] = 'A';
					tmpCaGrabarAbono.clave[1] = 0;

					m_grid.QuickGetText(i, 1, &sTexto);
					sTexto.Trim();

					sprintf_s(cTexto1, "%s", (LPCTSTR)sTexto);
					memcpy(cTexto2, &cTexto1[4], 6);
					lFacturaX = atol(cTexto2);

					m_grid.QuickGetText(i, 21, &sTexto);
					sTexto.Trim();
					lImporteX = atol(sTexto);

					m_grid.QuickGetText(i, 16, &sTexto);
					sTexto.Trim();
					sprintf_s(cRespuesta, "%s", (LPCTSTR)sTexto);
					lSaldoX = atol(cRespuesta);

					m_grid.QuickGetText(i, 23, &sTexto);
					sTexto.Trim();
					iNumeroMesesX = atoi(sTexto);

					//Si se genera poliza nueva
					m_grid.QuickGetText(i, 36, &sTexto);
					sTexto.Trim();
					lInteresPrimerMesX = atoi(sTexto);

					m_grid.QuickGetText(i, 33, &sTexto);
					sTexto.Trim();
					sprintf_s(cRespuesta, "%s", (LPCTSTR)sTexto);
					iDiaX = 0, iMesX = 0, iAnioX = 0;
					iMesX = valor_campo(&cRespuesta[2], 2);
					iDiaX = valor_campo(&cRespuesta[0], 2);
					iAnioX = valor_campo(&cRespuesta[4], 4);
					if (iMesX > 0 && iDiaX > 0 && iAnioX > 0)
					{
						sprintf_s(cFechaVencimiento, "%02d-%02d-%04d 00:00:00", iMesX, iDiaX, iAnioX);
						cFechaVencimiento[19] = 0;
					}

					m_grid.QuickGetText(i, 25, &sTexto);
					sTexto.Trim();
					sprintf_s(cRespuesta, "%s", (LPCTSTR)sTexto);
					iDiaX = 0, iMesX = 0, iAnioX = 0;
					iMesX = valor_campo(&cRespuesta[2], 2);
					iDiaX = valor_campo(&cRespuesta[0], 2);
					iAnioX = valor_campo(&cRespuesta[4], 4);
					if (iMesX > 0 && iDiaX > 0 && iAnioX > 0)
					{
						sprintf_s(cFechaVencimientoAnt, "%02d-%02d-%04d 00:00:00", iMesX, iDiaX, iAnioX);
						cFechaVencimientoAnt[19] = 0;
					}

					//Fecha de activacion
					m_grid.QuickGetText(i, 35, &sTexto);
					sTexto.Trim();
					sprintf_s(cRespuesta, "%s", (LPCTSTR)sTexto);
					iDiaX = 0, iMesX = 0, iAnioX = 0;
					iMesX = valor_campo(&cRespuesta[2], 2);
					iDiaX = valor_campo(&cRespuesta[0], 2);
					iAnioX = valor_campo(&cRespuesta[4], 4);
					if (iMesX > 0 && iDiaX > 0 && iAnioX > 0)
					{
						sprintf_s(cFechaSaldaCon, "%02d-%02d-%04d 00:00:00", iMesX, iDiaX, iAnioX);
						cFechaCompra[19] = 0;
					}

					//Fecha de Venta del Seguro Auto
					m_grid.QuickGetText(i, 31, &sTexto);
					sTexto.Trim();
					sprintf_s(cRespuesta, "%s", (LPCTSTR)sTexto);
					iDiaX = 0, iMesX = 0, iAnioX = 0;
					iMesX = valor_campo(&cRespuesta[2], 2);
					iDiaX = valor_campo(&cRespuesta[0], 2);
					iAnioX = valor_campo(&cRespuesta[4], 4);
					if (iMesX > 0 && iDiaX > 0 && iAnioX > 0)
					{
						sprintf_s(cFechaCompra, "%02d-%02d-%04d 00:00:00", iMesX, iDiaX, iAnioX);
						cFechaCompra[19] = 0;
					}

					//Tipo vehiculo
					m_grid.QuickGetText(i, 34, &sTexto);
					sTexto.Trim();
					iFlagConyugalX = atoi(sTexto);

					//Poliza Anterior Anterior
					m_grid.QuickGetText(i, 29, &sTexto);
					sTexto.Trim();
					lSaldaConX = atoi(sTexto);

					//Importe de venta
					m_grid.QuickGetText(i, 30, &sTexto);
					sTexto.Trim();
					lImporteConvenioX = atoi(sTexto);

				}
				else
				{
					//fecha vencimiento 
					m_grid.QuickGetText(i, 25, &sTexto);
					sTexto.Trim();
					sprintf_s(cRespuesta, "%s", (LPCTSTR)sTexto);
					iDiaX = 0, iMesX = 0, iAnioX = 0;

					iMesX = valor_campo(&cRespuesta[2], 2);
					iDiaX = valor_campo(&cRespuesta[0], 2);
					iAnioX = valor_campo(&cRespuesta[4], 4);
					if (iMesX > 0 && iDiaX > 0 && iAnioX > 0)
					{
						sprintf_s(cFechaVencimiento, "%02d-%02d-%04d 00:00:00", iMesX, iDiaX, iAnioX);
						cFechaVencimiento[19] = 0;
					}

					m_grid.QuickGetText(i, 22, &sTexto);
					sTexto.Trim();
					iNumeroSegurosX = atoi(sTexto);

					m_grid.QuickGetText(i, 23, &sTexto);
					sTexto.Trim();
					iNumeroMesesX = atoi(sTexto);

					if (memcmp(cConcepto, "SEGURO", 6) == 0)
					{
						m_grid.QuickGetText(i, 24, &sTexto);
						sTexto.Trim();
						iFlagConyugalX = atoi(sTexto);
						tmpCaGrabarAbono.clave[0] = 'S';
						tmpCaGrabarAbono.clave[1] = 0;

					}
					else if (memcmp(cConcepto, "P.FAMILIAR", 10) == 0)
					{
						tmpCaGrabarAbono.clave[0] = 'C';
						tmpCaGrabarAbono.clave[1] = 0;
						iFlagConyugalX = 0;
					}
					else if (memcmp(cConcepto, "P.SALUD", 7) == 0)
					{
						tmpCaGrabarAbono.clave[0] = '2';
						tmpCaGrabarAbono.clave[1] = 0;
						iFlagConyugalX = 0;
					}

					m_grid.QuickGetText(i, 33, &sTexto);
					sTexto.Trim();

					sprintf_s(cRespuesta, "%s", sTexto);
					iDiaX = 0, iMesX = 0, iAnioX = 0;
					iMesX = (int)valor_campo(&cRespuesta[2], 2);
					iDiaX = valor_campo(&cRespuesta[0], 2);
					iAnioX = (int)valor_campo(&cRespuesta[4], 4);

					if (iMesX > 0 && iDiaX > 0 && iAnioX > 0)
					{
						sprintf_s(cFechaVencimientoAnt, "%02d-%02d-%04d 00:00:00", iMesX, iDiaX, iAnioX);
						cFechaVencimientoAnt[19] = 0;
					}
				}
			}

			if (memcmp(cConcepto, "SEGURO", 6) != 0 && memcmp(cConcepto, "P.FAMILIAR", 10) != 0 && memcmp(cConcepto, "AUTO PROT.", 10) != 0 && memcmp(cConcepto, "P.SALUD", 7) != 0)
			{
				m_grid.QuickGetText(i, 12, &sTexto);
				sTexto.Trim();
				sTexto.Remove(',');
				sTexto.Remove('.');
				sprintf_s(cRespuesta, "%s", (LPCTSTR)sTexto);
				lSaldoX = atol(cRespuesta);

				m_grid.QuickGetText(i, 13, &sTexto);
				sTexto.Trim();
				sTexto.Remove(',');
				sTexto.Remove('.');
				sprintf_s(cRespuesta, "%s", (LPCTSTR)sTexto);
				lInteresAdicionalX = atol(cRespuesta);

				m_grid.QuickGetText(i, 14, &sTexto);
				sTexto.Trim();
				sTexto.Remove(',');
				sTexto.Remove('.');
				sprintf_s(cRespuesta, "%s", (LPCTSTR)sTexto);
				lBaseX = atol(cRespuesta);

				m_grid.QuickGetText(i, 15, &sTexto);
				sTexto.Trim();
				sTexto.Remove(',');
				sTexto.Remove('.');
				sprintf_s(cRespuesta, "%s", (LPCTSTR)sTexto);
				lVencidoX = atol(cRespuesta);

				m_grid.QuickGetText(i, 16, &sTexto);
				sTexto.Trim();
				sTexto.Remove(',');
				sTexto.Remove('.');
				sprintf_s(cRespuesta, "%s", (LPCTSTR)sTexto);
				lMinimoX = atol(cRespuesta);

				m_grid.QuickGetText(i, 18, &sTexto);
				sTexto.Trim();
				sTexto.Remove(',');
				sTexto.Remove('.');

				sprintf_s(cRespuesta, "%s", (LPCTSTR)sTexto);
				lSaldaConX = atol(cRespuesta);

				m_grid.QuickGetText(i, 35, &sTexto);
				sTexto.Trim();
				sTexto.Remove(',');
				sTexto.Remove('.');
				sprintf_s(cRespuesta, "%s", (LPCTSTR)sTexto);
				lInteresPrimerMesX = atol(cRespuesta);



			}

			if (memcmp(cConcepto, "PLAN MOVISTAR", 14) != 0)
			{
				m_grid.QuickGetText(i, 19, &sTexto);
				sTexto.Trim();
				sTexto.Remove(',');
				sTexto.Remove('.');
				sprintf_s(cRespuesta, "%s", (LPCTSTR)sTexto);
				lBonificacionX = atol(cRespuesta);

				m_grid.QuickGetText(i, 21, &sTexto);
				sTexto.Trim();
				sTexto.Remove(',');
				sTexto.Remove('.');
				sprintf_s(cRespuesta, "%s", (LPCTSTR)sTexto);
				lSuPagoX = atol(cRespuesta);

				sprintf_s(tmpCaGrabarAbono.conceptocuenta, "%s", cConcepto);

				tmpCaGrabarAbono.tienda = (short)iTiendaX;
				tmpCaGrabarAbono.factura = lFacturaX;
				tmpCaGrabarAbono.importe = lImporteX;
				tmpCaGrabarAbono.diapago = (short)iDiaPagoX;

				iMesX = valor_campo(&cFechaCompra[0], 2);
				iDiaX = valor_campo(&cFechaCompra[3], 2);
				iAnioX = valor_campo(&cFechaCompra[6], 4);
				if (iMesX > 0 && iDiaX > 0 && iAnioX > 0L)
				{
					tmpCaGrabarAbono.fechacompra.ponerFecha(iDiaX, iMesX, iAnioX);
				}

				iMesX = valor_campo(&cFechaVencimiento[0], 2);
				iDiaX = valor_campo(&cFechaVencimiento[3], 2);
				iAnioX = valor_campo(&cFechaVencimiento[6], 4);
				if (iMesX > 0 && iDiaX > 0 && iAnioX > 0L)
				{
					tmpCaGrabarAbono.fechavencimiento.ponerFecha(iDiaX, iMesX, iAnioX);
				}

				iMesX = valor_campo(&cFechaUltMov[0], 2);
				iDiaX = valor_campo(&cFechaUltMov[3], 2);
				iAnioX = valor_campo(&cFechaUltMov[6], 4);
				if (iMesX > 0 && iDiaX > 0 && iAnioX > 0L)
				{
					tmpCaGrabarAbono.fechaultimomovimiento.ponerFecha(iDiaX, iMesX, iAnioX);
				}

				iMesX = valor_campo(&cFechaSaldaCon[0], 2);
				iDiaX = valor_campo(&cFechaSaldaCon[3], 2);
				iAnioX = valor_campo(&cFechaSaldaCon[6], 4);
				if (iMesX > 0 && iDiaX > 0 && iAnioX > 0L)
				{
					tmpCaGrabarAbono.fechasaldacon.ponerFecha(iDiaX, iMesX, iAnioX);
				}

				iMesX = valor_campo(&cFechaConvenio[0], 2);
				iDiaX = valor_campo(&cFechaConvenio[3], 2);
				iAnioX = valor_campo(&cFechaConvenio[6], 4);
				if (iMesX > 0 && iDiaX > 0 && iAnioX > 0L)
				{
					tmpCaGrabarAbono.fechaconvenio.ponerFecha(iDiaX, iMesX, iAnioX);
				}

				if (iCandidatoAprobado == 1 && iAplicoDescuento == 1)
				{
					m_grid.QuickGetText(i, 32, &sTexto);
					sTexto.Trim();
					sTexto.Remove(',');
					sTexto.Remove('.');
					sprintf_s(cRespuesta, "%s", (LPCTSTR)sTexto);
					tmpCaGrabarAbono.descuento = atol(cRespuesta);
					lSuPagoX += atol(cRespuesta);

				}
				else
				{
					tmpCaGrabarAbono.descuento = 0;
				}

				tmpCaGrabarAbono.empleadoconvenio = lEfectuoConvenioX;
				tmpCaGrabarAbono.plazoconvenio = (short)iPlazoConvenioX;
				tmpCaGrabarAbono.importeconvenio = lImporteConvenioX;
				tmpCaGrabarAbono.saldo = lSaldoX;
				tmpCaGrabarAbono.interesadicional = lInteresAdicionalX;
				tmpCaGrabarAbono.base = lBaseX;
				tmpCaGrabarAbono.vencido = lVencidoX;
				tmpCaGrabarAbono.minimo = lMinimoX;
				tmpCaGrabarAbono.saldacon = lSaldaConX;
				tmpCaGrabarAbono.bonificacion = lBonificacionX;
				tmpCaGrabarAbono.supago = lSuPagoX;
				tmpCaGrabarAbono.numeroseguros = (short)iNumeroSegurosX;
				tmpCaGrabarAbono.numeromeses = (short)iNumeroMesesX;
				tmpCaGrabarAbono.flagconyugal = (short)iFlagConyugalX;
				tmpCaGrabarAbono.interesprimermes = lInteresPrimerMesX;

				sprintf_s(cRespuesta, "%ld", lInteresAdicionalX);

				//datosCRTP
				if(iTipoCuenta==1 || iTipoCuenta==3){
					fecUltimacompra=sFechaCompraCRTP;
				}
				sTexto.Format("{\"tipocuenta\":%d, \"saldo\": %d, \"abonobase\":%d, \"plazo\":\"%d\", \"vencido\":%d, \"minimo\":%d, \"bonificacion\":%d, \"porcentajeBonificacion\":%d, "
					"\"descripcion\":\"AbonoCRTP\", \"fechaUltimaCompra\":\"%s\", \"factura\":%d, \"imp_abono\":%d}", iTipoCuenta, lSaldoX, lBaseX, iPlazoConvenioX, lVencidoX, lMinimoX,
					lBonificacionX, iPorcentajeBonificacion, fecUltimacompra, iNumFactura, lSuPagoX);

				jsonImporte.Append(sTexto);

				sprintf_s(cLog, "subirDatosTablaTemporal - Descuento Interes cliente:%d, interes:%d, saldo:%d, vencido:%d,concepto:%s", m_grid.lCliente,lInteresAdicionalX,lSaldoX,lVencidoX,tmpCaGrabarAbono.conceptocuenta);
				grabarLog(cLog);

				if (i < (iTotalCuentas - 1))
				{
					jsonImporte.Append(",");
				}

				m_grid.QuickGetText(i, 30, &sTexto);
				sTexto.Trim();
				iStatusCuenta = atoi(sTexto);

				tmpCaGrabarAbono.status[0] = '0';
				if (iStatusCuenta == 1) tmpCaGrabarAbono.status[0] = '1'; //la cuenta fue obtenida del ccuenta
				tmpCaGrabarAbono.status[1] = 0;

				m_grid.QuickGetText(i, 31, &sTexto);
				sTexto.Trim();
				iCantidadAnteriorSeguros = atoi(sTexto);
				tmpCaGrabarAbono.cantidadanteriorseguros = (short)iCantidadAnteriorSeguros;

				iMesX = valor_campo(&cFechaVencimientoAnt[0], 2);
				iDiaX = valor_campo(&cFechaVencimientoAnt[3], 2);
				iAnioX = valor_campo(&cFechaVencimientoAnt[6], 4);
				if (iMesX > 0 && iDiaX > 0 && iAnioX > 0L)
				{
					tmpCaGrabarAbono.fechavencimientoanterior.ponerFecha(iDiaX, iMesX, iAnioX);
				}

				tmpCaGrabarAbono.saldaconanteriormuebles = lSaldaConAntMueblesX;

				tmpCaGrabarAbono.tipoconvenio = (short)iTipoConvenioX;
				tmpCaGrabarAbono.subtipoconvenio = (short)iSubTipoConvenioX;

				m_grid.QuickGetText(i, 28, &sTexto);
				sTexto.Trim();
				iFlagCapturoConvenio = atoi(sTexto);
				tmpCaGrabarAbono.flagcapturoconvenio = (short)iFlagCapturoConvenio;

				m_grid.QuickGetText(i, 36, &sTexto);
				sTexto.Trim();
				tmpCaGrabarAbono.tipoproducto = (short)atoi(sTexto);

				tmpCaGrabarAbono.minimototal = lMinimoTotal;
				tmpCaGrabarAbono.saldototal = lSaldoTotal;
				tmpCaGrabarAbono.vencidototal = lVencidoTotal;
				tmpCaGrabarAbono.minimototalfinal = lMinimoTotalFinal;
				tmpCaGrabarAbono.saldototalfinal = lSaldoTotalFinal;
				tmpCaGrabarAbono.vencidototalfinal = lVencidoTotalFinal;

				if (memcmp(cConcepto, "CP COMP ADC", 11) == 0)
				{
					sprintf_s(tmpCaGrabarAbono.conceptocuenta, "%s", "CP ADC");
				}

				if (!tmpCaGrabarAbono.Insert())
				{
					tmpCaGrabarAbono.odbc->GetLastError(tmpCaGrabarAbono.GetHstmt());
					//Se obtiene el error
					grabarMensajeError("C", m_grid.iCaja, (LPTSTR)(LPCTSTR)m_grid.sServer, "CapturarAbono", "CDlgCapturarAbono", "subirDatosTablaTemporal", "No se pudo insertar en la tabla temporal tmpCaGrabarAbono", m_grid.lEmpleado, "ERROR EN LA CONSULTA(subirdatostablatemporal)", tmpCaGrabarAbono.odbc, m_grid.iMuestraMsg);
					bContinuar = false;
					break;
				}
			}
		}
		jsonImporte.Append("]");
	}
	return  bContinuar;
}

bool CDlgCapturarAbono::grabarAbono()
{
	char cLog[500] = { 0 };
	bool bConsultaOK = true, bGrabo = false, bEsSorteoExistente = false, bLevantarSC3 = true;

	char sArchivo[80] = { 0 }, sArchivo2[80] = { 0 }, cFolioTiendaTxt[25] = { 0 },
		cTxt[80] = { 0 }, cArea[3] = { 0 }, cSql[255] = { 0 }, cMensaje[200] = { 0 };

	short iError = 0, iDecrementarFolio = 0, iDecrementarFolioSeguro = 0, iDecrementarFolioRecibo = 0;

	__int64 i64FolioTienda = 0;

	long lImporteServicio = 0L, lSuPagoAbonos = 0L;

	int  iImprimeComprobantes = 0, iTipoProcesoComprobante = 0;

	sprintf_s(cLog, "ff164d0888ca - entra - grabarAbono - Cliente: %ld", m_grid.lCliente);
	grabarLog(cLog);

	iTotalAbonos = 0;
	iTotalAbonoSeg = 0;
	iTotalAbonoInte = 0;
	iConConvenio = 0;
	iImporteTotalConv = 0;
	iNumCandidatoUnico = 0;
	iFlagConsultaSC3 = 0;

	grabarLog("LLega a consultar  FLAGC_SERVICIOCORREO_CAPTURA_ABONOS");

	consultarFlag(&odbc, cSql, 'C', FLAGC_SERVICIOCORREO_CAPTURA_ABONOS, iFlagConsultaSC3);
	bEsSorteoExistente = EsCampaniaSorteoEncontrada();

	bLevantarSC3 = validarLevantarSC3();
	grabarLog("paso validarLevantarSC3  ");

	CDlgCapturarConvenio sorteoNav;

	if (iFlagConsultaSC3 == 1 && !bEsSorteoExistente && iSistema != SISTEMA_CAJERA_CAPTURISTA && bLevantarSC3)
	{
		grabarLog("690953243a39 - Se ejecuta primera pregunta de titularidad antes de comenzar con el grabado.");
		GetSetCuestionTitular();
	}
	else
	{
		grabarLog("e42851039ff4 - No Se ejecuta primera pregunta de titularidad.");
	}

	lNumeroRecibo = 0L;
	bPromocion = false;

	if (_access("c:\\sys\\mem\\cupDiner.dat", 0) == 0)
	{
		_unlink("c:\\sys\\mem\\cupDiner.dat");
	}

	bFlagCuponCajas = false;
	lDineroCoppel = 0L;

	if (iFlagDespliegaDatosZ == 1)
	{
		bConsultaOK = abrirConexionCuentaPerdida();
	}

	if (borrarDatosTemporalesFijas() && bConsultaOK)
	{
		if (crearTablasTemporalesTienda())
		{
			if (grabarAbonoTablasTemporales(iError) == true) //esta funcion en watcom es ca_abono.cppdf
			{
				if (procesarTransaccion(&odbc, "begin") == true)
				{
					if (incrementarFolioCajas() && verificarUltimoRecibo())
					{
						grabarMovimientoDescuentoMoratorio();
						if (incrementarAcumuladoMonetarioCajas() && incrementarFolioSysFolioGlobal(i64FolioTienda))
						{
							usingx("##############", cFolioTiendaTxt, i64FolioTienda);
							if (m_grid.lCliente == 1708)
							{
								if (grabarTmpClienteEtpCaCarmov(cFolioTiendaTxt))  //graba al cliente etp
								{
									procesarTransaccion(&odbc, "COMMIT");
									bGrabo = true;
								}
								else
								{
									procesarTransaccion(&odbc, "rollback");
									iDecrementarFolio = 1;
								}
							}
							else
							{
								if (grabarTmpCaEficienciaCajeras())  // grabar eficiencia de cajera
								{
									if (grabarTmpAbonoCaCarmov(cFolioTiendaTxt))  //grabar abono cuenta de ropa,muebles o prestamo
									{
										if (grabarTmpCaMovimientos()) // grabar los movimientos
										{
											if (grabarTmpAbonoInteresCaCarmov(cFolioTiendaTxt))   //grabar los abonos a intereses
											{
												if (grabarTmpConvenioCaCarmov(cFolioTiendaTxt))   //grabar convenio de la cuenta
												{
													if (grabarTmpBonificacionCaCarmov(cFolioTiendaTxt))   //grabar la bonificacion
													{
														/*Se modifico para que esta funcion guarde los beneficiarios en la tabla tdbeneficiarios
														y grabe los movimientos G6, G5 y G1 en la tabla cacarmov*/
														if (grabarTmpSeguroCaCarmov(cFolioTiendaTxt))   //grabar el seguro
														{
															if (grabarTmpTdbeneficiariosaTdBeneficiarios()) //grabar los beneficiarios capturados en la venta del seguro club en el menu de los segs club
															{
																if (grabarTmpSeguroAutoCaCarmov())
																{
																	if (grabarPagoServicio())
																	{
																		if (grabarCacarmovPlan())
																		{
																			if (grabarCandidatoPlan())
																			{
																				if (grabarTdBeneficiariosPlan())
																				{
																					if (procesarTransaccion(&odbc_1, "begin") == true)
																					{
																						if (grabarTmpCrPrestamo())   //actualiza el prestamo en la cartera
																						{
																							if (grabarTmpCrCmuebles()) //actualiza las cuentas de muebles en la cartera
																							{
																								if (grabarTmpCrCropa())  // actualiza la cuenta de ropa en la cartera
																								{
																									if (grabarTmpCrCropaDetalle())  // actualiza la cuenta de ropa en la cartera mae_carteraropadetalle
																									{
																										if (grabarTmpCrTaire())  // actualiza la cuenta del Tiempo Aire en la cartera
																										{
																											if (grabarTmpCrcDeudaBancoppel())   //actualiza la cuenta de deudabancoppal
																											{
																												if (grabarBeneficiariosCartera())
																												{
																													if (grabarCambioSitCte()) //Se actualiza la situacion del cliente
																													{
																														if (grabarTmpCrCRevolvente())
																														{
																															if (grabarTmpCrSegurosAuto())
																															{
																																if(grabarAbonoSegurosCacarmov())
																																{
																																	if(grabarAbonoSegurosCarmovX())
																																	{
																																		if (grabarTmpCrSeguros()) //actualiza los seguros en la cartera
																																		{
																																			if (grabarMaeCrSeguros())
																																			{
																																				if (GrabarCarmovx())//grabar carmovx
																																				{
																																					if (grabarCarmovxPlan())
																																					{
																																						if (grabarMaeBeneficiariosSeguro())
																																						{
																																							if (iFlagDespliegaDatosZ == 1) //cliente Z ctas perdidas
																																							{
																																								if (procesarTransaccion(&odbcCuentasPerdidas, "begin"))
																																								{//5a
																																									if (grabarCuentasPerdidas())
																																									{//4a
																																										if (procesarTransaccion(&odbc, "COMMIT"))
																																										{//3a
																																											if (procesarTransaccion(&odbc_1, "COMMIT"))
																																											{//2a
																																												if (procesarTransaccion(&odbcCuentasPerdidas, "COMMIT"))
																																												{//1a
																																													bGrabo = true;
																																													actualizarPuntualidad();
																																												}//1a
																																												else
																																												{
																																													procesarTransaccion(&odbc, "rollback");
																																													procesarTransaccion(&odbc_1, "rollback");
																																													iDecrementarFolio = 1;
																																													iDecrementarFolioSeguro = 1;
																																													iDecrementarFolioRecibo = 1;
																																												}
																																											}//2a
																																											else
																																											{
																																												procesarTransaccion(&odbc, "rollback");
																																												procesarTransaccion(&odbc_1, "rollback");
																																												iDecrementarFolio = 1;
																																												iDecrementarFolioSeguro = 1;
																																												iDecrementarFolioRecibo = 1;
																																											}
																																										}//3a
																																										else
																																										{
																																											procesarTransaccion(&odbc, "rollback");
																																											procesarTransaccion(&odbc_1, "rollback");
																																											iDecrementarFolio = 1;
																																											iDecrementarFolioSeguro = 1;
																																											iDecrementarFolioRecibo = 1;
																																										}
																																									}//4a   
																																									else
																																									{
																																										procesarTransaccion(&odbc, "rollback");
																																										procesarTransaccion(&odbc_1, "rollback");
																																										iDecrementarFolio = 1;
																																										iDecrementarFolioSeguro = 1;
																																										iDecrementarFolioRecibo = 1;
																																									}
																																								}//5a   
																																								else
																																								{
																																									procesarTransaccion(&odbc, "rollback");
																																									procesarTransaccion(&odbc_1, "rollback");
																																									iDecrementarFolio = 1;
																																									iDecrementarFolioSeguro = 1;
																																									iDecrementarFolioRecibo = 1;
																																								}
																																							}//iFlagDespliegaDatosZ    // Aqui  termina cuando un cliente tiene cuentas perdidas(Transaccion).
																																							else//Aqui empieza cuando es un cliente normal.
																																							{//2b
																																								if (procesarTransaccion(&odbc, "COMMIT") == true)
																																								{//1b                                                                                       
																																									if (procesarTransaccion(&odbc_1, "COMMIT"))
																																									{
																																										bGrabo = true;
																																										actualizarPuntualidad();
																																									}
																																									else
																																									{
																																										procesarTransaccion(&odbc, "rollback");
																																										procesarTransaccion(&odbc_1, "rollback");
																																										iDecrementarFolio = 1;
																																										iDecrementarFolioSeguro = 1;
																																										iDecrementarFolioRecibo = 1;
																																									}
																																								}//1b
																																								else
																																								{
																																									procesarTransaccion(&odbc, "rollback");
																																									procesarTransaccion(&odbc_1, "rollback");
																																									iDecrementarFolio = 1;
																																									iDecrementarFolioSeguro = 1;
																																									iDecrementarFolioRecibo = 1;
																																								}
																																							}//2b
																																						}
																																						else
																																						{
																																							procesarTransaccion(&odbc, "rollback");
																																							procesarTransaccion(&odbc_1, "rollback");
																																							iDecrementarFolio = 1;
																																							iDecrementarFolioSeguro = 1;
																																							iDecrementarFolioRecibo = 1;
																																						}
																																					}
																																					else
																																					{
																																						procesarTransaccion(&odbc, "rollback");
																																						procesarTransaccion(&odbc_1, "rollback");
																																						iDecrementarFolio = 1;
																																						iDecrementarFolioSeguro = 1;
																																						iDecrementarFolioRecibo = 1;
																																					}
																																				}
																																				else
																																				{
																																					procesarTransaccion(&odbc, "rollback");
																																					procesarTransaccion(&odbc_1, "rollback");
																																					iDecrementarFolio = 1;
																																					iDecrementarFolioSeguro = 1;
																																					iDecrementarFolioRecibo = 1;
																																				}
																																			}
																																			else
																																			{
																																				procesarTransaccion(&odbc, "rollback");
																																				procesarTransaccion(&odbc_1, "rollback");
																																				iDecrementarFolio = 1;
																																				iDecrementarFolioSeguro = 1;
																																				iDecrementarFolioRecibo = 1;
																																			}
																																		}
																																		else
																																		{
																																			procesarTransaccion(&odbc, "rollback");
																																			procesarTransaccion(&odbc_1, "rollback");
																																			iDecrementarFolio = 1;
																																			iDecrementarFolioSeguro = 1;
																																			iDecrementarFolioRecibo = 1;
																																		}
																																	}
																																	else
																																	{
																																		procesarTransaccion(&odbc, "rollback");
																																		procesarTransaccion(&odbc_1, "rollback");
																																		iDecrementarFolio = 1;
																																		iDecrementarFolioSeguro = 1;
																																		iDecrementarFolioRecibo = 1;
																																	}
																																}
																																else
																																{
																																	procesarTransaccion(&odbc, "rollback");
																																	procesarTransaccion(&odbc_1, "rollback");
																																	iDecrementarFolio = 1;
																																	iDecrementarFolioSeguro = 1;
																																	iDecrementarFolioRecibo = 1;
																																}
																															}
																															else
																															{
																																procesarTransaccion(&odbc, "rollback");
																																procesarTransaccion(&odbc_1, "rollback");
																																iDecrementarFolio = 1;
																																iDecrementarFolioSeguro = 1;
																																iDecrementarFolioRecibo = 1;
																																iError = 2;
																															}
																														}
																														else
																														{
																															procesarTransaccion(&odbc, "rollback");
																															procesarTransaccion(&odbc_1, "rollback");
																															iDecrementarFolio = 1;
																															iDecrementarFolioSeguro = 1;
																															iDecrementarFolioRecibo = 1;
																														}
																													}
																													else
																													{
																														procesarTransaccion(&odbc, "rollback");
																														procesarTransaccion(&odbc_1, "rollback");
																														iDecrementarFolio = 1;
																														iDecrementarFolioSeguro = 1;
																														iDecrementarFolioRecibo = 1;
																													}
																												}
																												else
																												{
																													procesarTransaccion(&odbc, "rollback");
																													procesarTransaccion(&odbc_1, "rollback");
																													iDecrementarFolio = 1;
																													iDecrementarFolioSeguro = 1;
																													iDecrementarFolioRecibo = 1;
																												}
																											}
																											else
																											{
																												procesarTransaccion(&odbc, "rollback");
																												procesarTransaccion(&odbc_1, "rollback");
																												iDecrementarFolio = 1;
																												iDecrementarFolioSeguro = 1;
																												iDecrementarFolioRecibo = 1;
																											}
																										}
																										else
																										{
																											procesarTransaccion(&odbc, "rollback");
																											procesarTransaccion(&odbc_1, "rollback");
																											iDecrementarFolio = 1;
																											iDecrementarFolioSeguro = 1;
																											iDecrementarFolioRecibo = 1;
																										}
																									}
																									else
																									{
																										procesarTransaccion(&odbc, "rollback");
																										procesarTransaccion(&odbc_1, "rollback");
																										iDecrementarFolio = 1;
																										iDecrementarFolioSeguro = 1;
																										iDecrementarFolioRecibo = 1;
																									}
																								}
																								else
																								{
																									procesarTransaccion(&odbc, "rollback");
																									procesarTransaccion(&odbc_1, "rollback");
																									iDecrementarFolio = 1;
																									iDecrementarFolioSeguro = 1;
																									iDecrementarFolioRecibo = 1;
																								}
																							}
																							else
																							{
																								procesarTransaccion(&odbc, "rollback");
																								procesarTransaccion(&odbc_1, "rollback");
																								iDecrementarFolio = 1;
																								iDecrementarFolioSeguro = 1;
																								iDecrementarFolioRecibo = 1;
																							}
																						}
																						else
																						{
																							procesarTransaccion(&odbc, "rollback");
																							procesarTransaccion(&odbc_1, "rollback");
																							iDecrementarFolio = 1;
																							iDecrementarFolioSeguro = 1;
																							iDecrementarFolioRecibo = 1;
																						}
																					}
																					else
																					{
																						procesarTransaccion(&odbc, "rollback");
																						iError = 2;
																						iDecrementarFolio = 1;
																					}
																				}
																				else // tdbeneficiariosplan
																				{
																					procesarTransaccion(&odbc, "rollback");
																					iDecrementarFolio = 1;
																				}
																			}
																			else
																			{
																				procesarTransaccion(&odbc, "rollback");
																				iDecrementarFolio = 1;
																			}
																		}
																		else // cacarmovplan
																		{
																			procesarTransaccion(&odbc, "rollback");
																			iDecrementarFolio = 1;
																		}
																	}
																	else
																	{
																		procesarTransaccion(&odbc, "rollback");
																		iDecrementarFolio = 1;
																		iDecrementarFolioSeguro = 1;
																	}
																}
																else
																{
																	procesarTransaccion(&odbc, "rollback");
																	iDecrementarFolio = 1;
																	iDecrementarFolioSeguro = 1;
																	iError = 1;
																}
															}
															else
															{
																procesarTransaccion(&odbc, "rollback");
																iDecrementarFolio = 1;
																iDecrementarFolioSeguro = 1;
															}
														}
														else
														{
															procesarTransaccion(&odbc, "rollback");
															iDecrementarFolio = 1;
														}
													}
													else
													{
														procesarTransaccion(&odbc, "rollback");
														iDecrementarFolio = 1;
													}
												}
												else
												{
													procesarTransaccion(&odbc, "rollback");
													iDecrementarFolio = 1;
												}
											}
											else
											{
												procesarTransaccion(&odbc, "rollback");
												iDecrementarFolio = 1;
											}
										}
										else
										{
											procesarTransaccion(&odbc, "rollback");
											iDecrementarFolio = 1;
										}
									}
									else
									{
										procesarTransaccion(&odbc, "rollback");
										iDecrementarFolio = 1;
									}
								}
								else
								{
									procesarTransaccion(&odbc, "rollback");
									iDecrementarFolio = 1;
								}
							}
						}
						else
						{
							procesarTransaccion(&odbc, "rollback");
							iDecrementarFolio = 1;
						}
					}
					else
					{
						procesarTransaccion(&odbc, "rollback");
					}
				}
				else
				{
					iError = 1;
				}
			}

			switch (iError)
			{
			case 1:
				grabarMensajeError("C", m_grid.iCaja, (LPTSTR)(LPCTSTR)m_grid.sServer, "CapturarAbono", "CDlgCapturarAbono", "grabarAbono", "Error al procesar la transaccion", m_grid.lEmpleado, "ERROR EN LA transaccion bd tienda", &odbc, m_grid.iMuestraMsg);
				break;
			case 2:
				grabarMensajeError("C", m_grid.iCaja, (LPTSTR)(LPCTSTR)m_grid.sServer, "CapturarAbono", "CDlgCapturarAbono", "grabarAbono", "Error al procesar la transaccion", m_grid.lEmpleado, "ERROR EN LA transaccion bd cartera", &odbc_1, m_grid.iMuestraMsg);
				break;
			default:
				break;
			}


			if (!bGrabo)
			{   // Banderas ke se activan si hubo algun error en la Transaccion, para Decrementar el Folio
				if (iDecrementarFolio == 1 && lNumeroRecibo > 0L)
				{
					if (iAplicoDescuento == 1)
					{
						sprintf_s(cJsonPostDescuentos, "{\"clave\":0,\"tipoMovimiento\":\"0\",\"tienda\":%d,\"ciudadGnDominio\": 0,\"cliente\": %ld,\"caja\": %d,\"numeroRecibo\": %d,\"folioFactura\":0,\"importe\": 0,\"saldoInicial\":0,\"saldoFinal\":0,"
							"\"saldoCuenta\":0,\"flagMovtoSupervisor\":\"0\",\"vencidoInicial\":0,\"minimoInicial\":0,\"ejercicio\":\"0\",\"fechaMvto\":\"1900/01/01\",\"efectuo\":0,\"clienteEdad\":0,\"cajaOriginalMora\":0,\"ipCarteraCliente\":\"\",\"base\":0,"
							"\"nombreCompleto\":\"\",\"minimoTotalMora\":0,\"saldoTotalMora\":0,\"vencidoTotalMora\":0,\"minimoTotalFinalMora\":0,\"saldoTotalFinalMora\":0,\"vencidoTotalFinalMora\":0,\"plazoConv\":0,\"numMovimiento\":0,"
							"\"statusMovimiento\":\"0\",\"ipTienda\":\"%s\",\"iva\": 0,\"fechaSaldaCon\":\"\",\"idu_transaccion\": 1}"
							, m_grid.iTienda, m_grid.lCliente, m_grid.iCaja, lNumeroRecibo);

						grabartmpClienteCandidatomoratorio(cJsonPostDescuentos, 5, "guardarEliminarCaCarmov");
					}
					decrementarFolioCajas();
				}

				if (iDecrementarFolioSeguro == 1 && iFoliosSegurosAdicionales[0] != 0)
				{
					if (!bBanderaTieneClub) //Si no tenia seguro decrementa el folio del seguro titular
					{
						decrementarFolioSeguroCajas();
					}
					for (int i = 0; i < iSegurosAdicionalesNuevos; i++) //Si capturo adicionales nuevos decrementa por cada adicional nuevo
					{
						decrementarFolioSeguroCajas();
					}
				}

				if (iDecrementarFolioRecibo == 1 && iFlagCapturoServicio == 1)
				{
					decrementarFolioRecibo();
				}
			}

			sprintf_s(cMensaje, "grabarAbono::Termino grabado Cliente = %ld, Recibo = %ld, bGrabo = %d", m_grid.lCliente, lNumeroRecibo, bGrabo);
			grabarLog(cMensaje);

			if (bGrabo) //si todo se hizo bien al grabar el abono
			{
				if (iAplicoDescuento == 1)
				{
					char cFechaMvto[15] = { 0 };

					GrabarTdAutorizacionHuellas03();

					sprintf_s(cFechaMvto, "%04d-%02d-%02d", iAnioActual, iMesActual, iDiaActual);
					sprintf_s(cJsonPostDescuentos, "{\"importeMora\":2,\"numeroRecibo\": %ld,\"caja\":%d,\"area\": \"%c\",\"cliente\": %ld,\"fechaGnDominio\":\"%s\",\"ipTienda\":\"%s\",\"ipCartera\":\"%s\",\"numTienda\": %d,\"fechaDescuento\":\"%s\"}"
						, lNumeroRecibo, m_grid.iCaja, m_grid.cArea, m_grid.lCliente, cFechaTienda, odbc.m_strServer, odbc_1.m_strServer, m_grid.iTienda, cFechaMvto);

					grabartmpClienteCandidatomoratorio(cJsonPostDescuentos, 4, "guardarContadorYBitacora");

				}
				grabarTmpCrCmueblesPlanes();//actualiza las cuentas de planes
				if (_access("C:\\SYS\\MEM\\RECIBO.PRN", 0) == 0)
				{
					int iRet = 0;
					errno = 0;
					iRet = _unlink("C:\\SYS\\MEM\\RECIBO.PRN");

				}

				sprintf_s(sArchivo, "%s", "C:\\SYS\\MEM\\RECIBO.PRN");

				obtenerFlagImpresora(iFlagImpresoraTermica);

				switch (iSistema)
				{
				case 1:
					cArea[0] = 'M';
					break;
				case 2:
					cArea[0] = 'R';
					break;
				case 3:
					cArea[0] = 'C';
					break;
				default:
					break;
				}
				cArea[1] = 0;

				if (iFlagPromocionDirecta == 1)
				{
					bPromocion = obtenerCiudadCandidata();

					if (bPromocion)
					{
						bPromocion = consultarPromocionDirecta();

						if (bPromocion)
						{
							bPromocion = mensajePromocionDirecta(iFlagImpresoraTermica);
						}
					}
				}


				if ((iFlagImpresoraTermica == 1 && iSistema == SISTEMA_CAJAS) || iSistema == SISTEMA_ROPA || iSistema == SISTEMA_MUEBLES)
				{
					if (iFlagTiendaLocal >= 1)
					{
						obtenerFechaCartera();
					}

					termica = new CGenerarImpresion(cArchivoImpresion, true);
					imprimirRecibo();
				}

				EjecutarProcesoSituacionesEspeciales();

				IniciarContactabilidad(); //21749

				bool bContinuar = true;
				if (iSistema == SISTEMA_CAJERA_CAPTURISTA || iFlagImpresoraTermica != 1)
				{
					bContinuar = imprimirReciboCajas(sArchivo, lImporteServicio);
				}

				if (bContinuar)
				{
					if ((iFlagImpresoraTermica == 1 && iSistema == SISTEMA_CAJAS) || iSistema == SISTEMA_ROPA || iSistema == SISTEMA_MUEBLES)
					{
						iFlagCapturoSeguroAdicional = (short)iFlagCapturoBeneficiariosClubNuevo;
						terminarReciboTermica();

						delete termica;

						abrirConexionBD(&odbc_1, cIpServidorCartera, cIpServidorCartera, CONECTA_CARTERA, m_grid.iTienda);

						fValidarStatusAfore();

						revizarImprimirPolizaSeguroAuto(RECIBO_ABONO_POLIZAS);
					}


					if (iFlagCapturoBeneficiariosClubNuevo == 2) //imprimir documentacion
					{
						if (iFlagImpresoraTermica == 1)
						{
							imprimirPolizaSeguroClubTermica(0, 0, 1, iRespuestaPoliza, 0, 0);
						}
						else
						{
							imprimirPolizaSeguroClub(0, iConyugal);
							imprimirPolizaSeguroClub(1, iConyugal);
						}
					}

					//Si capturo un seguro adicional nuevo o realizo un cambio de plan
					if (iFlagCapturoSeguroAdicional == 1 || iCambioPlanSeguroClub == 1)
					{
						imprimirPolizaSeguroClubAdicional(iFlagImpresoraTermica);
					}

					// 3858 impresion de poliza
					for (int i = 0; i < iCambiosDePlan; i++)
					{
						imprimirPolizaCambioPlan(i);
					}

					CInsertarGnTira insertarGnTira(&odbc);

					lSuPagoAbonos = lTotalAPagar - lTotalGlobalServicios;
					if (lSuPagoAbonos > 0 || (m_grid.iFlagCargo == 0 && lSuPagoAbonos != 0))
					{
						if (iFlagImpresoraTermica == 0)
						{
							bConsultaOK = grabarTdTira("C", 1, sArchivo, iDiaActual, iMesActual, iAnioActual, &odbc, cSql, m_grid.iCaja, lNumeroRecibo, iTipoImpresora, m_grid.iTienda, m_grid.lEmpleado, m_grid.lCliente);
						}
						if (!bConsultaOK)
						{
							grabarMensajeError("C", m_grid.iCaja, (LPTSTR)(LPCTSTR)m_grid.sServer, "CapturarAbono", "CDlgCapturarAbono", "grabarAbono", cSql, m_grid.lEmpleado, "ERROR EN LA CONSULTA(GrabartdTira)", insertarGnTira.odbc, m_grid.iMuestraMsg);
						}

						if (!(iFlagImpresoraTermica == 1 && iSistema == SISTEMA_CAJAS))
							impresionArchivo.imprimirArchivo(sArchivo);
					}

					if (iFlagCapturoServicio == 1)
					{
						bPagodeServicios = true;
						nombreArchivo("RECIBOSE.PRN", sArchivo2, DIRECTORIO_MEM);
						if (_access("c:\\sys\\mem\\RECIBOSE.prn", 0) == 0)
							_unlink("c:\\sys\\mem\\RECIBOSE.prn");

						imprimirReciboPagoServicios(sArchivo2, lImporteServicio);

						CInsertarGnTira insertarGnTira(&odbc);
						bConsultaOK = grabarTdTira("C", 1, sArchivo2, iDiaActual, iMesActual, iAnioActual, insertarGnTira.odbc, cSql, m_grid.iCaja, lNumeroRecibo, iTipoImpresora, m_grid.iTienda, m_grid.lEmpleado, m_grid.lCliente);
						if (!bConsultaOK)
						{
							grabarMensajeError("C", m_grid.iCaja, (LPTSTR)(LPCTSTR)m_grid.sServer, "CapturarAbono", "CDlgCapturarAbono", "grabarAbono", cSql, m_grid.lEmpleado, "ERROR EN LA CONSULTA(grabarabono 2)", insertarGnTira.odbc, m_grid.iMuestraMsg);
						}

						impresionArchivo.imprimirArchivo(sArchivo2);

						memset(cTxt, 0, sizeof(cTxt));

						sprintf_s(cTxt, "@C1%04d%06ld%09ld%02d%02d%04d", m_grid.iTienda, lNumeroRecibo, m_grid.lCliente, iDiaActual, iMesActual, iAnioActual);

						if (formaRegistroUnicoCajas(&odbc, 1, cTxt, m_grid.iCaja, 'C', iDiaActual, iMesActual, iAnioActual, cSql) == false) //cawregun.cpp
						{
							grabarMensajeError("C", m_grid.iCaja, (LPTSTR)(LPCTSTR)m_grid.sServer, "CapturarAbono", "CDlgCapturarAbono", "grabarAbono", "Error al procesar el formaRegistroUnicoCajas", m_grid.lEmpleado, "ERROR EN LA transaccion bd tienda", &odbc, m_grid.iMuestraMsg);
						}
					}

					if (iFlagConsultaSC3 == 1 && bLevantarSC3)
					{
						capturaDeDatosEcommerce(bGrabo, bEsSorteoExistente, iTipoProcesoComprobante, iImprimeComprobantes);
					}
				}
				else
				{
					delete termica;
				}

				//impresion de comprobante de captura de datos de correo
				if (iImprimeComprobantes == 1)
				{
					grabarLog("grabarAbono::Entra a imprimirConfirmacionCorreo");

					CString opcionImpresion = "";
					opcionImpresion = "correo";
					imprimirConfirmacionCorreo(cArea, lNumeroRecibo, SISTEMA_CAJAS, opcionImpresion, iTipoProcesoComprobante, sCliente);
				}
				//Imprime Recibo de captura de datos.

				if (iFlagAutoGteCargo == 1 && iFlagMovimiento == 0)
				{
					grabarTdAutorizacionHuellas();
				}

				if (iFlagTieneSeguroAdicional == 1 || iFlagCapturoSeguroAdicional == 1) //Para saber si tiene seguro adicional
				{
					borrarTemporalesSeguroAdicional(); //Para borrar las tablas despues de que termine de grabar
				}

				sprintf_s(cLog, "CDlgCapturarConvenio::sorteoNavidadMillonaria. Tienda: [%d], Caja [%d], IpTienda[%s]" , iTiendaDlg, iCajaActual, cIPServidorTiendaNumero);
				grabarLog(cLog);

				sorteoNav.sorteoNavidadMillonariaNav(iTiendaDlg, iCajaActual, cIPServidorTiendaNumero, iAnioActual, iMesActual, iDiaActual); // 38970 Navidad Millonaria



				if (bEsSorteoExistente && (iSistema == SISTEMA_CAJAS || iSistema == SISTEMA_ROPA 
					|| iSistema == SISTEMA_MUEBLES|| iSistema == SISTEMA_CAJERA_CAPTURISTA))
				{                    
					cargarSorteos();//Carga el dll para la consulta de sorteos y promociones
				}
				if (bCargaDatosSorteo)
				{
					cargarDatosSorteoNuevo(lFlagHuella);
				}
			}
			else
			{
				AfxMessageBox("Error en la Transaccion");
			}
		}
	}
	else
	{
		AfxMessageBox("Error al Borrar Tablas Temporales Fijas Cartera");
	}

	cerrarConexionBD(&odbcCuentasPerdidas);
	flagLlamaCRTP=0;
	if (bGrabo)
	{
		GuardaHit(m_grid2.lTotalAbonos);
		bFlag_GuardoHit = true;
		flagLlamaCRTP=1;
	}

	if (bGrabo && bClienteReestructurado && bValidarMontoDesbloqueo)
	{
		cFechaNacimientoCliente.Format("%.04d-%.02d-%.02d", iAnioNacimiento,static_cast<int>(iMesNacimiento), iDiaNacimiento);
		cJsonConfiguracion.Format("{'ServidorCartera':'%s','Tienda':{'ServidorTienda':'%s','Numero':%d},'OrigenLlamada':%d,'Cajero':%ld,'Ciudad':%d,'Caja':%d,'CajaOriginal':%d,'Area':'%c'}", cIpServidorCartera, m_grid.sServer, m_grid.iTienda, 4, m_grid.lEmpleado, iCiudadGnDominio, iCajaActual, iCajaOriginal, m_grid.cArea);
		cJsonReestructura.Format("{'Producto':{'NumeroProducto':%d},'Cliente':{'IduCliente':%d,'Nombre':'%s','ApellidoPaterno':'%s','ApellidoMaterno':'%s','FechaNacimiento':'%s','Puntualidad':'%s'}}", -1, m_grid.lCliente, cNombre, cApellidoPaterno, cApellidoMaterno, cFechaNacimientoCliente, cPuntualidad);
		cJsonConfiguracion.Replace(' ', '_');
		cJsonReestructura.Replace(' ', '_');
		cJsonParams.Format("%s %s", cJsonConfiguracion, cJsonReestructura);
		_spawnl(P_NOWAITO, PATH_PUENTETOCS, PATH_PUENTETOCS, m_grid.sServer, inoTienda, PATH_REESTTRUCTURA_DLL, NOMBRE_FUNCION_INICIAL, cJsonParams, NULL);
	}

	cargarCampanasDE();
	//cargarCoppelRecompensa(3);
	//LLamar GN0276 de coppel recompensa si se grabo correctamente el abono
	if(flagLlamaCRTP==1){
		cargarCoppelRecompensa(3);
	}

	validaGanador();

	cargarMerca360();			  
	grabarLog("grabarAbono::Termino");

	sprintf_s(cLog, "FC0200805021521360 - fin - grabarAbono - Cliente: %ld, bGrabo=%s", m_grid.lCliente,
		bGrabo ? "VERDADERO" : "FALSO");
	grabarLog(cLog);

	return bGrabo;
}

bool CDlgCapturarAbono::validarSituacionEspecialEmpleados(bool &bClienteEsEmpleado)
{
	char cLog[500] = { 0 };
	bool bRegresa = false;

	sprintf_s(cLog, "FC0200805021521362 - entra - validarSituacionEspecialEmpleados");
	grabarLog(cLog);

	if (lClienteDlg != 90001)
	{
		iProceso = CAPTURA_ABONO;
		iRegla = EXCLUIRCLIENTEPARASORTEO;
		if (ValidarSituacionEspecial(lClienteDlg, iRegla, iProceso, 3))
		{
			bRegresa = true;
			bClienteEsEmpleado = true;
		}
	}
	else
	{
		bRegresa = true;
	}
	return bRegresa;
}

bool CDlgCapturarAbono::EsCampaniaSorteoEncontrada()
{
	char cLog[500] = { 0 };
	bool bRegresa = false;
	char cTipoCampana[2] = { 0 }, cSql[180] = { 0 };
	int iCampana = 0;

	sprintf_s(cLog, "FC0200805021521366 - entra - EsCampaniaSorteoEncontrada");
	grabarLog(cLog);

	CConsultarGnVigenciaPromocion sorteo(&odbc);

	sprintf_s(cSql, "SELECT campana, tipocampana, prioridad FROM gnvigenciapromocion WHERE area IN (0,%d) AND "
		"'%04d-%02d-%02d' BETWEEN (fechainicio) AND (fechalimiteemision) ORDER BY prioridad", iSistema, iAnioActual,
		iMesActual, iDiaActual);

	if (sorteo.Exec(cSql))
	{
		sorteo.activarCols();
		while (sorteo.leer())
		{
			iCampana = sorteo.campana;
			sprintf_s(cTipoCampana, "%s", CString(sorteo.tipocampana).Trim());
			switch (cTipoCampana[0])
			{
			case 'I':
				{
					bRegresa = true;
				}
				break;
			default:
				break;
			}
		}
	}
	else
	{
		sorteo.odbc->GetLastError(sorteo.GetHstmt());
		grabarMensajeError("C", iCajaDlg, (LPTSTR)(LPCTSTR)m_grid.sServer, "EsCampaniaSorteoEncontrada", 
			"CDlgCapturarAbono", "consultaSorteosactivos", cSql, lEmpleadoDlg, 
			"ERROR EN LA CONSULTA (gnvigenciapromocion)", sorteo.odbc, iMuestraMsg);
	}
	return bRegresa;
}

bool CDlgCapturarAbono::grabarTdAutorizacionHuellas()
{
	char cLog[500] = { 0 };
	bool bContinuar = true;

	sprintf_s(cLog, "FC0200805021521370 - entra - grabarTdAutorizacionHuellas");
	grabarLog(cLog);

	// Pasa la Tabla Temporal tmptdAutorizacionHuellas a la tabla TDAUTORIZACIONHUELLAS
	if (iFlagAutoGteCargo == 1) //se capturo autorizacion del gerente
	{
		char cSql[42] = { 0 };
		sprintf_s(cSql, "SELECT cnGrabarTdAutorizacionHuellas()");
		CMaximo grabarAutorizacion(&odbc, false); //conexión a tienda.nnnn
		if (!grabarAutorizacion.Exec(cSql))
		{
			grabarAutorizacion.odbc->GetLastError(grabarAutorizacion.GetHstmt());
			grabarMensajeError("C", iCajaDlg, (LPTSTR)(LPCTSTR)m_grid.sServer, "CapturarAbono", "CDlgCapturarAbono", "grabarTdAutorizacionHuellas", cSql, lEmpleadoDlg, "ERROR EN LA CONSULTA (grabarAutorizacionGte)", grabarAutorizacion.odbc, iMuestraMsg);
			bContinuar = false;
		}
	}
	return bContinuar;
}

void CDlgCapturarAbono::buscarSeguroClub(void)
{
	char cLog[500] = { 0 };
	char cSql[150] = { 0 }, cFechaVencido[10] = { 0 }, cFecha[10] = { 0 };//15750 aumentar el Csql para que no desborde
	iDiaUltimoPago = 1, iMesUltimoPago = 1, iAnioUltimoPago = 1900;//15750
	CString sFechaVencido = "1900-01-01", sStatusSeguro = "", sClaveNoOfrecer = "";

	sprintf_s(cLog, "FC0200805021521374 - entra - buscarSeguroClub");
	grabarLog(cLog);

	iTipoSeguro = 0;

	sprintf_s(cSql, "SELECT fechavencimiento,statusseguro,clavenoofrecer,fechaultimopago from crseguros where cliente = %09ld and claveseguro = 'C'", m_grid.lCliente);

	CConsultarTipoSeguroCrSeguros consultarTipoSeguroCrSeguros(&odbc_1);
	if (!consultarTipoSeguroCrSeguros.Exec(cSql))
	{
		//Se obtiene el error
		consultarTipoSeguroCrSeguros.odbc->GetLastError(consultarTipoSeguroCrSeguros.GetHstmt());
		grabarMensajeError("C", m_grid.iCaja, (LPTSTR)(LPCTSTR)m_grid.sServer, "CapturarAbono", "CDlgCapturarAbono", "buscarSeguroClub", cSql, m_grid.lEmpleado, "ERROR EN LA CONSULTA(buscarseguroclub)", consultarTipoSeguroCrSeguros.odbc, m_grid.iMuestraMsg);
	}
	else
	{
		consultarTipoSeguroCrSeguros.activarCols();
		if (iFlagMarcadoCandidatosCPF == 1)
		{
			if (consultarTipoSeguroCrSeguros.Leer())
			{
				//15342
				sFechaVencido.Format("%04d-%02d-%02d", consultarTipoSeguroCrSeguros.fechavencimiento.ano(), consultarTipoSeguroCrSeguros.fechavencimiento.mes(), consultarTipoSeguroCrSeguros.fechavencimiento.dia());
				sStatusSeguro.Format("%c", consultarTipoSeguroCrSeguros.statusseguro[0]);
				sClaveNoOfrecer.Format("%c", consultarTipoSeguroCrSeguros.clavenoofrecer[0]);
				iDiaUltimoPago = (short)consultarTipoSeguroCrSeguros.fechaultimopago.dia();
				iMesUltimoPago = (short)consultarTipoSeguroCrSeguros.fechaultimopago.mes();
				iAnioUltimoPago = (short)consultarTipoSeguroCrSeguros.fechaultimopago.ano();
			}
			else
			{
				//15342. si no tiene seguro, asigna fecha por default
				sFechaVencido.Format("1900-01-01");
				iDiaUltimoPago = 1;
				iMesUltimoPago = 1;
				iAnioUltimoPago = 1900;
			}
			//15342
			iTipoSeguro = ValidarCandidatoClub(sStatusSeguro, sClaveNoOfrecer, sFechaVencido);
		}
		else
		{
			if (consultarTipoSeguroCrSeguros.Leer())
			{
				if (consultarTipoSeguroCrSeguros.statusseguro[0] == 'C' || consultarTipoSeguroCrSeguros.clavenoofrecer[0] == 'S')
				{
					if (consultarTipoSeguroCrSeguros.statusseguro[0] == 'C')
					{
						iTipoSeguro = 3; //tiene el seguro cancelado
					}
					else
					{
						if (consultarTipoSeguroCrSeguros.clavenoofrecer[0] == 'S')
						{
							iTipoSeguro = 4; // tiene clave de no ofrecer seguro
						}
					}
				}
				else
				{
					iTipoSeguro = 1; // seguro club activo 
				}

				sprintf_s(cFechaVencido, "%04d%02d%02d", consultarTipoSeguroCrSeguros.fechavencimiento.ano(), consultarTipoSeguroCrSeguros.fechavencimiento.mes(), consultarTipoSeguroCrSeguros.fechavencimiento.dia());
				sprintf_s(cFecha, "%04d%02d%02d", iAnioActual, iMesActual, iDiaActual);

				if (valor_campo(cFecha, 8) > valor_campo(cFechaVencido, 8))
				{
					if (iTipoSeguro != 3 && iTipoSeguro != 4)
					{
						iTipoSeguro = 6;    //tiene vencido antes de cada movimiento
					}
				}
				//15750
				iDiaUltimoPago = (short)consultarTipoSeguroCrSeguros.fechaultimopago.dia();
				iMesUltimoPago = (short)consultarTipoSeguroCrSeguros.fechaultimopago.mes();
				iAnioUltimoPago = (short)consultarTipoSeguroCrSeguros.fechaultimopago.ano();
			}
		}
	}
}

short CDlgCapturarAbono::ValidarCandidatoClub(CString Estatus, CString clavenoofrecer, CString FechaVencido)
{
	char cLog[500] = { 0 };
	char cFecha[10] = { 0 }, cConsulta[150] = { 0 };
	CString sSql = "";
	short iRegresa = 0;

	sprintf_s(cLog, "FC0200805021521378 - entra - ValidarCandidatoClub");
	grabarLog(cLog);

	sprintf_s(cConsulta, "select * from fun_validaricandidatoclub('%09ld','%ld','%s','%s','%s')", m_grid.lCliente, m_grid.lEmpleado, Estatus, clavenoofrecer, FechaVencido);

	CMaximo CandidatoClub(&odbc);
	if (CandidatoClub.Exec(cConsulta))
	{
		CandidatoClub.activarCols();
		if (CandidatoClub.Leer())
		{
			iRegresa = (short)CandidatoClub.Total;
		}
	}
	else
	{
		//Se obtiene el error
		CandidatoClub.odbc->GetLastError(CandidatoClub.GetHstmt());
		grabarMensajeError("C", m_grid.iCaja, (LPTSTR)(LPCTSTR)m_grid.sServer, "CapturarAbono", "CDlgCapturarAbono", "ValidarCandidatoClub", cConsulta, m_grid.lEmpleado, "error en fun_validaricandidatoclub", CandidatoClub.odbc, m_grid.iMuestraMsg);
	}
	return iRegresa;

}

/******************15750*****************************/
bool CDlgCapturarAbono::grabarAbonoTablasTemporales(short &iError)
{
	char cLog[500] = { 0 };
	bool bResultado = true;
	bool bResultadoGrabar = true;
	CString sTexto;
	int  iDiaConvenio = 0, iMesConvenio = 0, iAnioConvenio = 0, iFlagGrabo = 0,
		iDiaVenta = 0, iMesVenta = 0, iAnioVenta = 0, iAnioVencimiento = 0, iMesVencimiento = 0, iMesesVencido = 0,
		iDiaVencimiento = 0, iAnioVencimientoAnterior = 0, iMesVencimientoAnterior = 0, iDiaVencimientoAnterior = 0, iFlagConsideraCtasVdo = 0;
	long lEmpleadoMicro = 0L, lAbonoCuenta = 0L, lAbonoInteres = 0L, lSaldoNuevo = 0L, lInteresPrimerMes = 0L,
		lSaldoFinal = 0L, lImporteSaldaCon = 0L, lFechaSaldaCon = 0L,
		lNumeroBeneficiarios = 0L, lComision = 0L, lComision2 = 0L;
	char cAnexo, cFlagClienteLocalizar[3] = { 0 }, cClienteLocalizar[3] = { 0 }, cTipoMovimiento[3] = { 0 }, cEjercicio[3] = { 0 };
	long lImporteVenta, lSaldoFinalRopa = 0, lSaldoFinalTasa0 = 0, lSaldoDetalladoRopa = 0, lSaldoDetalladoTasa0 = 0;
	bool bConsultarComision = true;
	CString sql = "";

	int iGraboAdicional = 0;

	sprintf_s(cLog, "FC0200805021521382 - entra - grabarAbonoTablasTemporales");
	grabarLog(cLog);

	cAnexo = '1';
	memset(cFlagClienteLocalizar, '0', 3);
	//Cambio 14/Ago/2006
	memset(cClienteLocalizar, 0, sizeof(cClienteLocalizar));
	memset(cTipoMovimiento, 0, sizeof(cTipoMovimiento));
	memset(cEjercicio, 0, sizeof(cEjercicio));

	grabarLog("grabarAbonoTablasTemporales::grabando abono en tablas temporales");

	iFlagAbonoInteres = 0;
	iFlagConvenio = 0;
	iFlagBonificacion = 0;
	iFlagSeguro = 0;
	iFlagBeneficiarios = 0;
	iFlagClienteEtp = 0;
	iFlagAbono = 0;
	iFlagMovimientos = 0;
	iFlagEficienciaCajera = 0;
	iFlagCrPrestamo = 0;
	iFlagCrRopa = 0;
	iFlagCrTaire = 0;
	iFlagCrMuebles = 0;
	iFlagCrSeguro = 0;
	iFlagCrCRevolvente = 0;

	if (m_grid.lCliente == 1708)
	{
		memset(cSexoCliente, 0, sizeof(cSexoCliente));
		iEdadCliente = 0;
		iSituacionEspecial = 0;
		sprintf_s(cFechaNacimiento, "%02d-%02d-%04d %02d:%02d:%02d", 1, 1, 1900, 0, 0, 0);
		cFechaNacimiento[19] = 0;
	}

	if (iFlagSupervisor == 1)
	{
		lEmpleadoMicro = lEmpleadoSupervisor;
	}
	else
	{
		lEmpleadoMicro = m_grid.lEmpleado;
	}
	//OBTENER EL FLAG PARA CONSIDERAR EL ABONO BASE SOLO DE LAS CUENTAS CON VENCIDO PARA VALIDACION DE CONVENIOS.
	obtenerFlag('C', FLAGC_AB_CONSIDERANDOCTASVDO, iFlagConsideraCtasVdo);
	sql.Format("SELECT clave,conceptocuenta,tienda,factura,fechacompra,importe,diapago,fechavencimiento,fechaultimomovimiento,fechasaldacon,fechaconvenio, "
		" empleadoconvenio,plazoconvenio,importeconvenio,saldo,interesadicional,base,vencido,minimo,saldacon,bonificacion,supago,numeroseguros,numeromeses,flagconyugal, "
		" fechavencimientoanterior,saldaconanteriormuebles,tipoconvenio,flagcapturoconvenio,status,cantidadanteriorseguros,subtipoconvenio,interesprimermes, tipoproducto, "
		" minimototal,saldototal,vencidototal,minimototalfinal,saldototalfinal,vencidototalfinal, flagcuentaperdida, descuento FROM tmpcagrabarabono where conceptocuenta NOT IN ('P. CELULAR', 'SEG. MOTOS')");
	CTmpCaGrabarAbono tmpCaGrabarAbono(&odbc);
	iContadorRegistros = 0;
	if (tmpCaGrabarAbono.Exec(sql.GetBuffer()))
	{ //bandera2
		tmpCaGrabarAbono.activarCols();
		while (tmpCaGrabarAbono.Leer() && bResultadoGrabar == true)
		{
			if (memcmp(tmpCaGrabarAbono.conceptocuenta, "BANCOPPEL", 9) == 0 || memcmp(tmpCaGrabarAbono.conceptocuenta, "RTRA CPL", 8) == 0 || VerificarCuentaBcpl(tmpCaGrabarAbono.conceptocuenta, "SOLEX") == 1)
			{
				lImporteVenta = 1; //Para que carteras vea que es cuenta de Bancoppel...
			}
			else
			{
				lImporteVenta = 0;
			}
			if (m_grid.lCliente == 1708)    //grabar cliente ETP
			{
				if (bResultadoGrabar == true)
				{
					bResultadoGrabar = grabarClienteEtpTemporal(tmpCaGrabarAbono.supago);
					if (bResultadoGrabar == false)
					{
						iError = 1;
					}
					break;
				}
			}
			else
			{
				if (memcmp(tmpCaGrabarAbono.conceptocuenta, "P.FAMILIAR", 10) != 0 && memcmp(tmpCaGrabarAbono.conceptocuenta, "P.SALUD", 7) != 0 && iTotalConvenio == 0 && cPuntualidad[0] != 'Z' && bCliente_Abogado_Externo != true)
				{
					ValidarConvenioUnico(tmpCaGrabarAbono.base, tmpCaGrabarAbono.vencido, tmpCaGrabarAbono.supago, false);//Obtener Cuenta Candidata a convenio Unico VencidoFinal
				}
				if (tmpCaGrabarAbono.supago != 0L && memcmp(tmpCaGrabarAbono.conceptocuenta, "P.SALUD", 7))
				{
					lAbonoCuenta = 0L;
					lAbonoInteres = 0L;
					lComision = 0L;
					lInteresPrimerMes = 0;

					if (tmpCaGrabarAbono.clave[0] == 'P') // PRESTAMOS
					{
						if (bConsultarComision)
						{
							CString sConsulta;
							sConsulta.Format("SELECT comision FROM CrPrestamos WHERE cliente = %ld", m_grid.lCliente);
							CMaximo consultaPrestamos(&odbc_1);
							if (!consultaPrestamos.Exec(sConsulta))
							{
								consultaPrestamos.odbc->GetLastError(consultaPrestamos.GetHstmt());
								grabarMensajeError("C", m_grid.iCaja, (LPTSTR)(LPCTSTR)m_grid.sServer, "CapturarAbono", "CDlgCapturarAbono", "grabarAbonoTablasTemporales", (LPTSTR)(LPCTSTR)sConsulta, m_grid.lEmpleado, "Error #8752", &odbc_1, m_grid.iMuestraMsg);
							}
							else
							{
								consultaPrestamos.activarCols();
								if (consultaPrestamos.Leer())
								{
									lComision2 = consultaPrestamos.Total;
									lComision = lComision2;
									bConsultarComision = false;
								}
							}
						}
						else
							lComision = lComision2;
					}
					else
						lComision = 0L;

					if (tmpCaGrabarAbono.clave[0] == 'S' || tmpCaGrabarAbono.clave[0] == 'C')
					{
						//grabar seguros en el cacarmov
						iAnioVencimiento = tmpCaGrabarAbono.fechavencimiento.ano();
						iDiaVencimiento = tmpCaGrabarAbono.fechavencimiento.dia();
						iMesVencimiento = tmpCaGrabarAbono.fechavencimiento.mes();

						iAnioVencimientoAnterior = tmpCaGrabarAbono.fechavencimientoanterior.ano();
						iDiaVencimientoAnterior = tmpCaGrabarAbono.fechavencimientoanterior.dia();
						iMesVencimientoAnterior = tmpCaGrabarAbono.fechavencimientoanterior.mes();

						if (bResultadoGrabar == true)
						{
							bResultadoGrabar = grabarSeguroCaCarmovTemporal(iDiaVencimiento, iMesVencimiento, iAnioVencimiento, tmpCaGrabarAbono.numeroseguros, tmpCaGrabarAbono.supago, tmpCaGrabarAbono.cantidadanteriorseguros, iDiaVencimientoAnterior, iMesVencimientoAnterior, iAnioVencimientoAnterior, tmpCaGrabarAbono.clave, tmpCaGrabarAbono.status, tmpCaGrabarAbono.flagconyugal, tmpCaGrabarAbono.numeromeses, tmpCaGrabarAbono.factura, tmpCaGrabarAbono.tipoproducto, tmpCaGrabarAbono.minimototal, tmpCaGrabarAbono.saldototal, tmpCaGrabarAbono.vencidototal, tmpCaGrabarAbono.minimototalfinal, tmpCaGrabarAbono.saldototalfinal, tmpCaGrabarAbono.vencidototalfinal, iGraboAdicional);
							iTotalAbonoSeg++;
							if (bResultadoGrabar == false)
							{
								iError = 1;
							}
						}

						if (iFlagCapturoBeneficiariosClubNuevo == 2L || iFlagCapturoSeguroAdicional == 1) //Para generar el movimiento G5 cuando se compre seguro titular o adicional
						{
							if (tmpCaGrabarAbono.numeroseguros > 0)
							{
								if (tmpCaGrabarAbono.clave[0] == 'C') //seguro club
								{
									if (tmpCaGrabarAbono.flagconyugal != '1')
									{
										if (bResultadoGrabar == true)
										{
											bResultadoGrabar = grabarBeneficiariosCaCarmovTemporal(lNumeroBeneficiarios, lEmpleadoMicro, tmpCaGrabarAbono.tipoproducto, tmpCaGrabarAbono.minimototal, tmpCaGrabarAbono.saldototal, tmpCaGrabarAbono.vencidototal, tmpCaGrabarAbono.minimototalfinal, tmpCaGrabarAbono.saldototalfinal, tmpCaGrabarAbono.vencidototalfinal);
											if (bResultadoGrabar == false)
											{
												iError = 1;
											}
										}
									}
									else
									{
										if (iTipoSeguro == 0)
										{
											if (bResultadoGrabar == true)
											{
												bResultadoGrabar = grabarBeneficiariosCaCarmovTemporal(lNumeroBeneficiarios, lEmpleadoMicro, tmpCaGrabarAbono.tipoproducto, tmpCaGrabarAbono.minimototal, tmpCaGrabarAbono.saldototal, tmpCaGrabarAbono.vencidototal, tmpCaGrabarAbono.minimototalfinal, tmpCaGrabarAbono.saldototalfinal, tmpCaGrabarAbono.vencidototalfinal);
												if (bResultadoGrabar == false)
												{
													iError = 1;
												}
											}
										}
									}
								}
							}
						}
					}
					else if (tmpCaGrabarAbono.clave[0] == 'A')//Seguro Auto Proteccion Coppel
					{

						iDiaVenta = 0, iMesVenta = 0, iAnioVenta = 0;

						if (tmpCaGrabarAbono.interesprimermes == 0)
						{
							iDiaVenta = tmpCaGrabarAbono.fechasaldacon.dia();
							iMesVenta = tmpCaGrabarAbono.fechasaldacon.mes();
							iAnioVenta = tmpCaGrabarAbono.fechasaldacon.ano();
						}
						else
						{
							iDiaVenta = iDiaActual;
							iMesVenta = iMesActual;
							iAnioVenta = iAnioActual;
							sumarDia(1, iDiaVenta, iMesVenta, iAnioVenta);
						}
						bResultadoGrabar = grabarSeguroAutoCaCarmovTemporal(tmpCaGrabarAbono.importe, tmpCaGrabarAbono.saldo, tmpCaGrabarAbono.interesprimermes, tmpCaGrabarAbono.factura, tmpCaGrabarAbono.numeromeses,
							tmpCaGrabarAbono.fechavencimiento.dia(), tmpCaGrabarAbono.fechavencimiento.mes(), tmpCaGrabarAbono.fechavencimiento.ano(),
							tmpCaGrabarAbono.fechavencimientoanterior.dia(), tmpCaGrabarAbono.fechavencimientoanterior.mes(), tmpCaGrabarAbono.fechavencimientoanterior.ano(),
							iDiaVenta, iMesVenta, iAnioVenta,
							tmpCaGrabarAbono.tipoproducto, tmpCaGrabarAbono.minimototal, tmpCaGrabarAbono.saldototal, tmpCaGrabarAbono.vencidototal, tmpCaGrabarAbono.minimototalfinal, tmpCaGrabarAbono.saldototalfinal, tmpCaGrabarAbono.vencidototalfinal,
							tmpCaGrabarAbono.flagconyugal, tmpCaGrabarAbono.fechasaldacon.dia(), tmpCaGrabarAbono.fechasaldacon.mes(), tmpCaGrabarAbono.fechasaldacon.ano(),
							tmpCaGrabarAbono.saldacon, tmpCaGrabarAbono.importeconvenio,
							tmpCaGrabarAbono.fechacompra.dia(), tmpCaGrabarAbono.fechacompra.mes(), tmpCaGrabarAbono.fechacompra.ano());
						if (bResultadoGrabar == false)
						{
							iError = 1;
						}
					}
					else
					{
						iDiaConvenio = tmpCaGrabarAbono.fechaconvenio.dia();
						iMesConvenio = tmpCaGrabarAbono.fechaconvenio.mes();

						//calcular meses vencidos 
						if (tmpCaGrabarAbono.clave[0] == 'R' || tmpCaGrabarAbono.clave[0] == 'M' || tmpCaGrabarAbono.clave[0] == 'T' || tmpCaGrabarAbono.clave[0] == 'V')
						{
							if (tmpCaGrabarAbono.vencido > 0 && tmpCaGrabarAbono.base > 0)
							{
								iMesesVencido = 0L;
								lInteresPrimerMes = tmpCaGrabarAbono.interesprimermes;
								iMesesVencido = (tmpCaGrabarAbono.vencido - tmpCaGrabarAbono.interesadicional) / tmpCaGrabarAbono.base;
								//si es primer mes vencido el interesprimermes manejarse como bonificacion al int
								if (iMesesVencido == 1)
								{
									tmpCaGrabarAbono.saldo = tmpCaGrabarAbono.saldo - lInteresPrimerMes;
									tmpCaGrabarAbono.interesadicional = tmpCaGrabarAbono.interesadicional - lInteresPrimerMes;
									tmpCaGrabarAbono.vencido = tmpCaGrabarAbono.vencido - lInteresPrimerMes;
									tmpCaGrabarAbono.bonificacion = tmpCaGrabarAbono.bonificacion - lInteresPrimerMes;
									if ((tmpCaGrabarAbono.vencido - tmpCaGrabarAbono.supago) > 0)
									{
										lInteresPrimerMes = 0;
									}
								}
							}
						}

						//Grabar Eficiencia Cajera
						if (bResultadoGrabar == true)
						{
							bResultadoGrabar = grabarEficienciaCajeraTemporal(lEmpleadoMicro, tmpCaGrabarAbono.saldo, tmpCaGrabarAbono.supago, tmpCaGrabarAbono.saldacon, tmpCaGrabarAbono.vencido, iDiaConvenio, iMesConvenio, tmpCaGrabarAbono.plazoconvenio);
							if (bResultadoGrabar == false)
							{
								iError = 1;
							}
						}

						//Grabar Movimiento de Abono
						cEjercicio[0] = '3';
						cEjercicio[1] = 0;
						iAnioVenta = tmpCaGrabarAbono.fechacompra.ano();
						iDiaVenta = tmpCaGrabarAbono.fechacompra.dia();
						iMesVenta = tmpCaGrabarAbono.fechacompra.mes();
						if (tmpCaGrabarAbono.factura != 0L)
						{
							cEjercicio[0] = (char)(calcularEjercicio(iAnioVenta) + '0');
							cEjercicio[1] = 0;
						}

						lAbonoCuenta = tmpCaGrabarAbono.supago;

						if ((tmpCaGrabarAbono.saldo > 0 &&
							tmpCaGrabarAbono.interesadicional > 0) ||
							(tmpCaGrabarAbono.interesadicional > 0 &&
							cAnexo == '1'))
						{
							if (tmpCaGrabarAbono.supago > 0L)
							{
								calcularAbonoInteres(lAbonoCuenta, lAbonoInteres, tmpCaGrabarAbono.supago, tmpCaGrabarAbono.interesadicional);
							}
						}
						if (tmpCaGrabarAbono.clave[0] == 'R')
						{
							bResultadoGrabar = obtenerDistrubuccionAbonoRopa(tmpCaGrabarAbono.saldo, tmpCaGrabarAbono.interesadicional, tmpCaGrabarAbono.supago, tmpCaGrabarAbono.bonificacion);
							lSaldoDetalladoRopa = lSaldoRopa + lInteresesRopa;
							lSaldoDetalladoTasa0 = lSaldoTasa0 + lInteresesTasa0;
						}
						if ((lAbonoCuenta > 0L && tmpCaGrabarAbono.interesadicional < tmpCaGrabarAbono.supago) ||
							lAbonoCuenta < 0L)
						{
							if (tmpCaGrabarAbono.factura == 0L || (tmpCaGrabarAbono.factura == 999999 && iFlagDespliegaDatosZ == 1) || tmpCaGrabarAbono.clave[0] == 'T' || tmpCaGrabarAbono.clave[0] == 'V')
							{
								//Abono a Nuevo movimiento del tiempo aire
								if (tmpCaGrabarAbono.clave[0] == 'T')
								{
									cTipoMovimiento[0] = 'I';
									cTipoMovimiento[1] = 0;
								}
								else if (tmpCaGrabarAbono.clave[0] == 'V')
								{
									cTipoMovimiento[0] = '2';
									cTipoMovimiento[1] = 0;
								}
								else //Abono a Ropa
								{
									cTipoMovimiento[0] = '5';
									cTipoMovimiento[1] = 0;
								}
							}
							else
							{
								//Abono a Muebles
								cTipoMovimiento[0] = '1';
								cTipoMovimiento[1] = 0;
							}

							if (tmpCaGrabarAbono.clave[0] == 'P')
							{
								cTipoMovimiento[0] = 'B';
								cTipoMovimiento[1] = 0;
							}
							else if (tmpCaGrabarAbono.clave[0] == 'B')
							{
								cTipoMovimiento[0] = 'J';
								cTipoMovimiento[1] = 0;
							}

							lSaldoNuevo = calcularSaldoNuevo(tmpCaGrabarAbono.saldo, tmpCaGrabarAbono.interesadicional, tmpCaGrabarAbono.supago, tmpCaGrabarAbono.bonificacion, tmpCaGrabarAbono.saldacon);

							if (iFlagConsideraCtasVdo <= 0)
							{
								if (lSaldoNuevo == 0)
								{
									iAbonoBaseTotalConv = (iAbonoBaseTotalConv - tmpCaGrabarAbono.base);//Obtener el abono BaseFinal-- Cuentas sin Saldar
								}
							}
							//Validacion para quitarle la situacion de no vender a cliente con cuenta restructurada coppel
							if (memcmp(tmpCaGrabarAbono.conceptocuenta, "RTRA CPL", 8) == 0)
							{
								if (tmpCaGrabarAbono.supago > 0)
								{
									//Si su saldo es menos al 60% del importe de la cuenta se cambiara su situación para que pueda comprar
									if (tmpCaGrabarAbono.saldo >= (tmpCaGrabarAbono.importe * 40 / 100))
									{
										if (lSaldoNuevo <= (tmpCaGrabarAbono.importe * 40 / 100))
										{
											iFlagPago60Restructurado = 1;
										}
									}
								}
							}

							if (tmpCaGrabarAbono.supago >= tmpCaGrabarAbono.saldacon)
							{
								if (tmpCaGrabarAbono.saldacon == tmpCaGrabarAbono.supago)
								{
									lSaldoFinal = 0L;
									lSaldoFinalRopa = 0L;
									lSaldoFinalTasa0 = 0L;
								}
								else
								{
									lSaldoFinal = tmpCaGrabarAbono.saldo - lAbonoCuenta - lAbonoInteres - tmpCaGrabarAbono.bonificacion;
									lSaldoFinalRopa = lSaldoDetalladoRopa - lAbonoRopa - lAbonoInteresesRopa - lBonificacionRopa;
									lSaldoFinalTasa0 = lSaldoDetalladoTasa0 - lAbonoTasa0 - lAbonoInteresesTasa0 - lBonificacionTasa0;
								}

								if (flagClienteTestigo(&odbc) > 0)
								{
									if (cTipoMovimiento[0] == '1' && tmpCaGrabarAbono.importe >= 1000 &&
										(cPuntualidad[0] == 'A' || cPuntualidad[0] == 'B'))
									{
										lDineroCoppel += tmpCaGrabarAbono.importe;
										bFlagCuponCajas = true;
									}
								}
							}
							else
							{
								lSaldoFinal = tmpCaGrabarAbono.saldo - lAbonoCuenta - lAbonoInteres;
								lSaldoFinalRopa = lSaldoDetalladoRopa - lAbonoRopa - lAbonoInteresesRopa;
								lSaldoFinalTasa0 = lSaldoDetalladoTasa0 - lAbonoTasa0 - lAbonoInteresesTasa0;
							}

							if (iSituacionEspecial == 1)
							{
								cClienteLocalizar[0] = 'L';
								cClienteLocalizar[1] = 0;

								iSituacionEspecial = 2;
							}
							if (memcmp(tmpCaGrabarAbono.conceptocuenta, "PRESTAMO", 8) != 0 && memcmp(tmpCaGrabarAbono.conceptocuenta, "BANCOPPEL", 8) != 0 && VerificarCuentaBcpl(tmpCaGrabarAbono.conceptocuenta, "SOLEX") == 0)
							{
								if (memcmp(tmpCaGrabarAbono.conceptocuenta, "ROPA", 4) == 0 || memcmp(tmpCaGrabarAbono.conceptocuenta, "T.AIRE", 6) == 0 || memcmp(tmpCaGrabarAbono.conceptocuenta, "COMP ADC", 8) == 0)
								{
									sTexto.Format("%04d%02d%02d", tmpCaGrabarAbono.fechasaldacon.ano(), tmpCaGrabarAbono.fechasaldacon.mes(), tmpCaGrabarAbono.fechasaldacon.dia());
									lFechaSaldaCon = atol(sTexto);
								}
								else
								{
									lFechaSaldaCon = obtenerFechaSaldaCon(tmpCaGrabarAbono.factura, iDiaVenta, iMesVenta, iAnioVenta);
								}
							}
							lImporteSaldaCon = tmpCaGrabarAbono.saldacon - tmpCaGrabarAbono.supago;
							if (lImporteSaldaCon < 0L) lImporteSaldaCon = 0L;

							if (iFlagDespliegaDatosZ == 1)//El 9 Identifica al Cliente Z
							{
								lFechaSaldaCon = 19000101;
							}

							iFlagGrabo = 1;

							if (bResultadoGrabar == true)
							{
								if (tmpCaGrabarAbono.vencido > tmpCaGrabarAbono.supago)//restar el abono al vencido
								{
									EDatosConvenioCliente[iTotalAbonos].iAbonoVencidoFinal = (tmpCaGrabarAbono.vencido - tmpCaGrabarAbono.supago);
								}
								else
								{
									EDatosConvenioCliente[iTotalAbonos].iAbonoVencidoFinal = 0;
								}
								bResultadoGrabar = grabarAbonoCaCarmovTemporal(tmpCaGrabarAbono.clave[0], cEjercicio, tmpCaGrabarAbono.factura, tmpCaGrabarAbono.vencido, tmpCaGrabarAbono.minimo, lEmpleadoMicro,
									cTipoMovimiento, lAbonoCuenta, lSaldoNuevo, tmpCaGrabarAbono.saldo, lImporteSaldaCon, lSaldoFinal, cClienteLocalizar, lFechaSaldaCon,
									lImporteVenta, lComision, tmpCaGrabarAbono.tipoproducto, tmpCaGrabarAbono.minimototal, tmpCaGrabarAbono.saldototal, tmpCaGrabarAbono.vencidototal,
									tmpCaGrabarAbono.minimototalfinal, tmpCaGrabarAbono.saldototalfinal, tmpCaGrabarAbono.vencidototalfinal, tmpCaGrabarAbono.base, tmpCaGrabarAbono.flagcuentaperdida, lSaldoFinalRopa, lSaldoFinalTasa0, lSaldoDetalladoRopa, lSaldoDetalladoTasa0);
								iTotalAbonos++;
								if (bResultadoGrabar == false)
								{
									iError = 1;
								}
							}
						}
					}
					if (lAbonoInteres > 0L || lInteresPrimerMes > 0L)
					{
						//Grabar abono interes cacarmov

						if (bResultadoGrabar == true)
						{
							if (tmpCaGrabarAbono.vencido > tmpCaGrabarAbono.supago)//restar el abono al vencido
							{
								EDatosConvenioCliente[iTotalAbonoInte].iAbonoInteVencidoFinal = (tmpCaGrabarAbono.vencido - tmpCaGrabarAbono.supago);
							}
							else
							{
								EDatosConvenioCliente[iTotalAbonoInte].iAbonoInteVencidoFinal = 0;
							}
							lSaldoNuevo = grabarAbonoInteresCaCarmovTemporal(tmpCaGrabarAbono.factura, tmpCaGrabarAbono.clave, iFlagSupervisor, lAbonoInteres, lAbonoCuenta,
								tmpCaGrabarAbono.saldo, tmpCaGrabarAbono.interesadicional, tmpCaGrabarAbono.supago, tmpCaGrabarAbono.bonificacion,
								tmpCaGrabarAbono.saldacon, tmpCaGrabarAbono.status, cFlagClienteLocalizar, iAnioVenta,
								tmpCaGrabarAbono.vencido, tmpCaGrabarAbono.minimo, bResultadoGrabar, lImporteVenta, lComision, lInteresPrimerMes,
								tmpCaGrabarAbono.tipoproducto, tmpCaGrabarAbono.minimototal, tmpCaGrabarAbono.saldototal, tmpCaGrabarAbono.vencidototal,
								tmpCaGrabarAbono.minimototalfinal, tmpCaGrabarAbono.saldototalfinal, tmpCaGrabarAbono.vencidototalfinal,
								lAbonoInteresesRopa, lSaldoDetalladoRopa, lAbonoInteresesTasa0, lSaldoDetalladoTasa0, tmpCaGrabarAbono.descuento);
							iTotalAbonoInte++;
							if (bResultadoGrabar == false)
							{
								iError = 1;
							}
						}
					}
				}
			}

			//comienza grabado de temporales en la cartera
			if (tmpCaGrabarAbono.clave[0] == 'S' || tmpCaGrabarAbono.clave[0] == 'C')
			{
				if (tmpCaGrabarAbono.numeromeses != 0 || (tmpCaGrabarAbono.numeromeses == 0 && iFlagCapturoSeguroAdicional == 1 && iGraboAdicional == 0))
				{
					if (bResultadoGrabar == true)
					{
						bResultadoGrabar = grabarTemporalCarteraSeguro(tmpCaGrabarAbono.factura, iDiaVencimiento, iMesVencimiento, iAnioVencimiento, tmpCaGrabarAbono.clave, tmpCaGrabarAbono.numeroseguros, iGraboAdicional);
						if (bResultadoGrabar == false)
						{
							iError = 2;
						}
					}
				}
			}
			else
			{

				if (tmpCaGrabarAbono.clave[0] == 'P') //es un prestamo
				{
					if (bResultadoGrabar == true)
					{
						bResultadoGrabar = grabarTemporalCarteraPrestamos(lSaldoNuevo, lAbonoInteres, lAbonoCuenta, tmpCaGrabarAbono.supago, tmpCaGrabarAbono.status, tmpCaGrabarAbono.factura, tmpCaGrabarAbono.interesadicional);
						if (bResultadoGrabar == false)
						{
							iError = 2;
						}
					}
				}
				else if (tmpCaGrabarAbono.clave[0] == 'B') //es bancoppel
				{
					if (bResultadoGrabar == true)
					{
						bResultadoGrabar = grabarTemporalCarteraBancoppel(lSaldoNuevo, lAbonoInteres, lAbonoCuenta, tmpCaGrabarAbono.supago, tmpCaGrabarAbono.factura, tmpCaGrabarAbono.interesadicional);
						if (bResultadoGrabar == false)
						{
							iError = 2;
						}
					}
				}
				else if (tmpCaGrabarAbono.clave[0] == 'V') //es bancoppel
				{
					if (bResultadoGrabar == true)
					{
						bResultadoGrabar = grabarTemporalCarteraRevolvente(tmpCaGrabarAbono.supago, tmpCaGrabarAbono.status, tmpCaGrabarAbono.interesadicional, lAbonoInteres, lSaldoNuevo, lInteresPrimerMes);
						if (bResultadoGrabar == false)
						{
							iError = 2;
						}
					}
				}
				else
				{
					if ((tmpCaGrabarAbono.clave[0] == 'R' && tmpCaGrabarAbono.factura != 999999) || (tmpCaGrabarAbono.clave[0] == 'T' && tmpCaGrabarAbono.factura != 999999))  //es la cuenta de ropa o de Tiempo Aire
					{
						if (tmpCaGrabarAbono.clave[0] == 'T')
						{
							// ojo se diferencian por el ultimo parametro
							// graba la cuenta del Tiempo Aire 

							if (bResultadoGrabar == true)
							{
								bResultadoGrabar = grabarTemporalCarteraTiempoAire(tmpCaGrabarAbono.supago, tmpCaGrabarAbono.status, tmpCaGrabarAbono.interesadicional, lAbonoInteres, lSaldoNuevo, lInteresPrimerMes);
								if (bResultadoGrabar == false)
								{
									iError = 2;
								}
							}
						}
						else
						{
							//graba la cuenta de ropa 
							if (bResultadoGrabar == true)
							{
								bResultadoGrabar = grabarTemporalCarteraRopa(tmpCaGrabarAbono.supago, tmpCaGrabarAbono.status, tmpCaGrabarAbono.interesadicional, lAbonoInteres, lSaldoNuevo, lInteresPrimerMes);
								if (bResultadoGrabar == false)
								{
									iError = 2;
								}
							}
							//graba en el mae_carteraropadetalle 
							if (bResultadoGrabar == true)
							{
								bResultadoGrabar = grabarTmpCarteraRopaDetalle(tmpCaGrabarAbono.supago, lAbonoRopa, lAbonoTasa0, tmpCaGrabarAbono.status, lBonificacionRopa, lBonificacionTasa0, lAbonoInteresesRopa, lAbonoInteresesTasa0, tmpCaGrabarAbono.saldacon);
								if (bResultadoGrabar == false)
								{
									iError = 2;
								}
							}
						}
					}
					else
					{
						if (bResultadoGrabar == true)
						{
							bResultadoGrabar = grabarTemporalCarteraMuebles(tmpCaGrabarAbono.supago, tmpCaGrabarAbono.factura, tmpCaGrabarAbono.status, lAbonoInteres, lSaldoNuevo, lInteresPrimerMes);
							if (bResultadoGrabar == false)
							{
								iError = 2;
							}
						}

						if (memcmp(tmpCaGrabarAbono.conceptocuenta, "PLANTEL", 7) == 0 ||
							memcmp(tmpCaGrabarAbono.conceptocuenta, "UNEFON   &", 10) == 0 ||
							memcmp(tmpCaGrabarAbono.conceptocuenta, "IUSACELL &", 10) == 0)
						{
							if (bResultadoGrabar == true)
							{
								bResultadoGrabar = grabarTemporalCarteraPlanes(tmpCaGrabarAbono.supago, tmpCaGrabarAbono.factura);
								if (bResultadoGrabar == false)
								{
									iError = 2;
								}
							}
						}
					}
				}
			}


			if (tmpCaGrabarAbono.flagcapturoconvenio == 1)     //se capturo convenio a la cta
			{
				//grabar convenio cacarmov
				if (bResultadoGrabar == true)
				{
					if (tmpCaGrabarAbono.vencido > tmpCaGrabarAbono.supago)
					{
						EDatosConvenioCliente[iConConvenio].iAbonoConVencidoFinal = (tmpCaGrabarAbono.vencido - tmpCaGrabarAbono.supago);   
						EDatosConvenioCliente[iConConvenio].iAbonoBaseCta = tmpCaGrabarAbono.base;//Obtener el Abono Base de la cta
						EDatosConvenioCliente[iConConvenio].iAbonoPago = tmpCaGrabarAbono.supago;//Obtener el ImporteAbono
						ObtenerTipoConvenio(iContadorRegistros);//Tipo de Cta Que Realizo convenio.. 
						EDatosConvenioCliente[iConConvenio].iTipoCtaConvenio = iTipoCtaConv;
						bResultadoGrabar = grabarConvenioCaCarmovTemporal(tmpCaGrabarAbono.factura, tmpCaGrabarAbono.clave, tmpCaGrabarAbono.supago, tmpCaGrabarAbono.plazoconvenio,
							lEmpleadoMicro, tmpCaGrabarAbono.importeconvenio, iFlagSupervisor, tmpCaGrabarAbono.status,
							tmpCaGrabarAbono.minimo, tmpCaGrabarAbono.saldo, iAnioVenta, tmpCaGrabarAbono.vencido, tmpCaGrabarAbono.tipoconvenio, tmpCaGrabarAbono.subtipoconvenio, lImporteVenta, tmpCaGrabarAbono.tipoproducto, tmpCaGrabarAbono.minimototal, tmpCaGrabarAbono.saldototal, tmpCaGrabarAbono.vencidototal, tmpCaGrabarAbono.minimototalfinal, tmpCaGrabarAbono.saldototalfinal, tmpCaGrabarAbono.vencidototalfinal);

					}
					else
					{
						char sGrabarLog[1000] = { 0 };
						sprintf_s(sGrabarLog, "grabarAbonoTablasTemporales::No se Registra el convenio Con vencido = 0 o vencido <= al Pago  Datos Cliente=%ld factura='%d',clave=%s,supago='%ld',plazoconvenio='%d',lEmpleadoMicro='%d',importeconvenio='%d',iFlagSupervisor='%d',status=%s,minimo='%d',saldo='%d',iAnioVenta='%d',vencido='%ld',tipoconvenio='%d',subtipoconvenio='%d', lImporteVenta='%ld',tipoproducto='%d',minimototal='%d',saldototal='%ld',vencidototal='%ld',minimototalfinal='%d',saldototalfinal='%ld',vencidototalfinal='%ld'",
							m_grid.lCliente, tmpCaGrabarAbono.factura, tmpCaGrabarAbono.clave, tmpCaGrabarAbono.supago, tmpCaGrabarAbono.plazoconvenio, lEmpleadoMicro, tmpCaGrabarAbono.importeconvenio, iFlagSupervisor, tmpCaGrabarAbono.status, tmpCaGrabarAbono.minimo, tmpCaGrabarAbono.saldo, iAnioVenta, tmpCaGrabarAbono.vencido, tmpCaGrabarAbono.tipoconvenio, tmpCaGrabarAbono.subtipoconvenio, lImporteVenta, tmpCaGrabarAbono.tipoproducto, tmpCaGrabarAbono.minimototal, tmpCaGrabarAbono.saldototal,
							tmpCaGrabarAbono.vencidototal, tmpCaGrabarAbono.minimototalfinal, tmpCaGrabarAbono.saldototalfinal, tmpCaGrabarAbono.vencidototalfinal);
						grabarLog(sGrabarLog);
					}
					if (bResultadoGrabar == false)
					{
						iError = 1;
					}
				}
			}

			if (tmpCaGrabarAbono.bonificacion > 0L)
			{
				if (tmpCaGrabarAbono.supago >= tmpCaGrabarAbono.saldo) tmpCaGrabarAbono.bonificacion = 0;
				if (tmpCaGrabarAbono.supago > tmpCaGrabarAbono.saldacon)
				{
					tmpCaGrabarAbono.bonificacion = tmpCaGrabarAbono.saldo - tmpCaGrabarAbono.supago;
					if (tmpCaGrabarAbono.bonificacion < 0) tmpCaGrabarAbono.bonificacion = 0;
				}
			}

			if (tmpCaGrabarAbono.bonificacion > 0 && tmpCaGrabarAbono.supago >= tmpCaGrabarAbono.saldacon)
			{
				if (bResultadoGrabar == true)
				{
					bResultadoGrabar = grabarBonificacionCaCarmovTemporal(tmpCaGrabarAbono.factura, tmpCaGrabarAbono.clave, tmpCaGrabarAbono.bonificacion, tmpCaGrabarAbono.vencido, tmpCaGrabarAbono.minimo, lEmpleadoMicro, iFlagSupervisor, tmpCaGrabarAbono.status, iAnioVenta, cClienteLocalizar, lImporteVenta, lComision, tmpCaGrabarAbono.tipoproducto, tmpCaGrabarAbono.minimototal, tmpCaGrabarAbono.saldototal, tmpCaGrabarAbono.vencidototal, tmpCaGrabarAbono.minimototalfinal, tmpCaGrabarAbono.saldototalfinal, tmpCaGrabarAbono.vencidototalfinal, lBonificacionRopa, lBonificacionTasa0);
					if (bResultadoGrabar == false)
					{
						iError = 1;
					}
				}
			}
			//bandera1
			if (tmpCaGrabarAbono.clave[0] != 'S' && tmpCaGrabarAbono.clave[0] != 'C' && memcmp(tmpCaGrabarAbono.conceptocuenta, "P.SALUD", 7) != 0 && tmpCaGrabarAbono.clave[0] != 'A')
			{
				iDiaConvenio = tmpCaGrabarAbono.fechaconvenio.dia();
				iMesConvenio = tmpCaGrabarAbono.fechaconvenio.mes();
				iAnioConvenio = tmpCaGrabarAbono.fechaconvenio.ano();
				if (iDiaConvenio <= 0 || iMesConvenio <= 0 || iAnioConvenio <= 0)
				{
					iDiaConvenio = 1;
					iMesConvenio = 1;
					iAnioConvenio = 1900;
				}

				iDiaVenta = tmpCaGrabarAbono.fechacompra.dia();
				iMesVenta = tmpCaGrabarAbono.fechacompra.mes();
				iAnioVenta = tmpCaGrabarAbono.fechacompra.ano();
				if (iDiaVenta <= 0 || iMesVenta <= 0 || iAnioVenta <= 0)
				{
					iDiaVenta = 1;
					iMesVenta = 1;
					iAnioVenta = 1900;
				}
				//Grabar moviento en camovimientos.

				if (bResultadoGrabar == true)
				{
					bResultadoGrabar = grabarCaMovimientosTemporal(tmpCaGrabarAbono.plazoconvenio, tmpCaGrabarAbono.vencido, lEmpleadoMicro, tmpCaGrabarAbono.saldo,
						tmpCaGrabarAbono.supago, tmpCaGrabarAbono.interesadicional, tmpCaGrabarAbono.bonificacion,
						iDiaVenta, iMesVenta, iAnioVenta, iDiaConvenio, iMesConvenio, iAnioConvenio);
					if (bResultadoGrabar == false)
					{
						iError = 1;
					}
				}
			}
			if (iFlagConsideraCtasVdo == 1)
			{
				//Omitir Club de P.FAMILIAR. para el Calculo del Abono Base para los convenios..
				if (memcmp(tmpCaGrabarAbono.conceptocuenta, "P.FAMILIAR", 10) != 0)
				{
					int iVdoFinal = 0;
					//Si el vencido es > al pago se le Resta el Pago al vdo.
					if (tmpCaGrabarAbono.vencido > tmpCaGrabarAbono.supago)
					{
						iVdoFinal = (tmpCaGrabarAbono.vencido - tmpCaGrabarAbono.supago);
					}
					//1-Si lSaldoNuevo = 0 Y tmpCaGrabarAbono.supago > 0 -> la cuenta ha sido saldada por lo tanto se cumple la validacion y se Resta el abono base de ese cta.
					//2-Si el vencido de la cta <=0 se resta el Abono base de cta a iAbonoBaseTotalConv. 

					//Se agrego para tomar en cuenta solo el abono base de las cuentas que cuentan con vencido.
					if ((lSaldoNuevo == 0 && tmpCaGrabarAbono.supago > 0) || iVdoFinal <= 0)
					{
						//Obtener el abono BaseFinal de las Cuentas sin Saldar y con vdo.
						iAbonoBaseTotalConv = (iAbonoBaseTotalConv - tmpCaGrabarAbono.base);
					}
				}
			}
			iContadorRegistros++;
		}

		if (bResultadoGrabar == false)
		{
			bResultado = false;
		}
	}
	else
	{
		//Se obtiene el error
		tmpCaGrabarAbono.odbc->GetLastError(tmpCaGrabarAbono.GetHstmt());
		grabarMensajeError("C", m_grid.iCaja, (LPTSTR)(LPCTSTR)m_grid.sServer, "CapturarAbono", "CDlgCapturarAbono", "grabarAbonoTienda", sql.GetBuffer(), m_grid.lEmpleado, "ERROR EN LA CONSULTA(grabarabonotablastemporales)", tmpCaGrabarAbono.odbc, m_grid.iMuestraMsg);
	}
	return  bResultado;
}

void CDlgCapturarAbono::ObtenerTipoConvenio(int ifila)
{
	char cLog[500] = { 0 };
	CString sConcepto;

	char cDescripcion[20] = { 0 };
	CUGCell m_cell;
	iTipoCtaConv = 0;

	sprintf_s(cLog, "FC0200805021521392 - entra - ObtenerTipoConvenio");
	grabarLog(cLog);

	m_grid.QuickGetText(ifila, -1, &sConcepto);
	sConcepto.Trim();
	sprintf_s(cDescripcion, "%s", (LPCTSTR)sConcepto);

	if (memcmp(cDescripcion, "ROPA", 4) == 0 || memcmp(cDescripcion, "T.AIRE", 6) == 0 || memcmp(cDescripcion, "COMP ADC", 8) == 0)
	{
		if (memcmp(cDescripcion, "T.AIRE", 6) == 0)
		{
			iTipoCtaConv = 4;
		}
		else if (memcmp(cDescripcion, "COMP ADC", 8) == 0)
		{
			iTipoCtaConv = 6;
		}
		else
		{
			iTipoCtaConv = 1;
		}
	}
	else
	{
		if (memcmp(cDescripcion, "PRESTAMO", 8) == 0)
		{
			iTipoCtaConv = 2;
		}
		else if (memcmp(cDescripcion, "BANCOPPEL", 8) == 0 || VerificarCuentaBcpl(cDescripcion, "SOLEX") == 1)
		{
			iTipoCtaConv = 5;
		}
		else
		{
			iTipoCtaConv = 3;
		}
	}
}

int CDlgCapturarAbono::menuAyudaAbonos()
{
	char cLog[500] = { 0 };
	int iOpcion = 0;
	bool bSalir = true;
	char cMensaje[50] = { 0 };

	sprintf_s(cLog, "FC0200805021521396 - entra - menuAyudaAbonos");
	grabarLog(cLog);

	while (bSalir)
	{
		if ((iSistema == SISTEMA_ROPA && iFlagMenuDomiciliacionDeRopa == 1) || (iSistema == SISTEMA_MUEBLES && iFlagMenuDomiciliacionDeMuebles == 1))
		{
			char * opciones[] = { "       F1   Ayuda                          ", //F1
				"       F2   Recibir Abono                  ", //F2
				"       F3   Saldar Cuenta                  ", //F6
				"       F4   Pago Minimo                    ", //F7
				"       F5   Saldar Todo                    ", //F8
				"       F6   Pago Minimo Total              ", //F9
				"       F7   Calculadora                    ", //F10
				"       F8   Convenio                       ",
				"       CTRL_F3 Pantalla de movimientos     ",
				"       CTRL_F7 Menu Pagos Automáticos      ",
				"       Esc  Salir                          ", //
				"" };

			int respuesta[] = { F1,F2,F3,F4,F5,F6,F7,F8,CTRL_F3,CTRL_F7,ESC,0 };
			C_Menu menu(" MENU AYUDA CAPTURA DE ABONOS ", opciones, respuesta);
			iOpcion = menu.OpcionSeleccionada();
		}
		else if (iSistema == SISTEMA_MUEBLES || iSistema == SISTEMA_ROPA)
		{
			char * opciones[] = { "       F1   Ayuda                          ", //F1
				"       F2   Recibir Abono                  ", //F2
				"       F3   Saldar Cuenta                  ", //F6
				"       F4   Pago Minimo                    ", //F7
				"       F5   Saldar Todo                    ", //F8
				"       F6   Pago Minimo Total              ", //F9
				"       F7   Calculadora                    ", //F10
				"       F8   Convenio                       ",
				"       CTRL_F3 Pantalla de movimientos     ",
				"       Esc  Salir                          ", //
				"" };

			int respuesta[] = { F1,F2,F3,F4,F5,F6,F7,F8,CTRL_F3,ESC,0 };
			C_Menu menu(" MENU AYUDA CAPTURA DE ABONOS ", opciones, respuesta);
			iOpcion = menu.OpcionSeleccionada();
		}
		else
		{
			/*if ( iFlagSeguroAuto == 1 )
			{
			sprintf_s( cMensaje, "       CTRL_F1 Menú Seguros Coppel          " );
			}
			else
			{
			sprintf_s( cMensaje, "       CTRL_F1 Seguros Club de Protección   " );
			}*/
			sprintf_s(cMensaje, "       CTRL_F1 Seguros Club de Protección   ");
			if (iSistema == SISTEMA_CAJAS && iFlagDomiciliacionCuentas == 1)
			{
				char * opciones[] = {
					"       F1   Ayuda                           ",
					"       F2   Imprimir Recibo                 ",
					"       F3   Convenio                        ",
					"       F4   Agua, Luz y Telefono            ",
					"       F5   Seguros de Vida                 ",
					"       F6   Saldar Cuenta                   ",
					"       F7   Pago Minimo                     ",
					"       F8   Saldar Todo                     ",
					"       F9   Pago Minimo Total               ",
					"       F10  Calculadora                     ",
					cMensaje,
					"       CTRL_F7 Menu Domiciliacion           ",
					"       Esc  Salir                           ",
					"" };

				int respuesta[] = { F1,F2,F3,F4,F5,F6,F7,F8,F9,F10,CTRL_F1,CTRL_F7,0 };//Menu de Domiciliacion
				C_Menu menu(" MENU AYUDA DEL SISTEMA DE CAJAS ", opciones, respuesta);
				iOpcion = menu.OpcionSeleccionada();
			}
			else
			{
				char * opciones[] = {
					"       F1   Ayuda                           ",
					"       F2   Imprimir Recibo                 ",
					"       F3   Convenio                        ",
					"       F4   Agua, Luz y Telefono            ",
					"       F5   Seguros de Vida                 ",
					"       F6   Saldar Cuenta                   ",
					"       F7   Pago Minimo                     ",
					"       F8   Saldar Todo                     ",
					"       F9   Pago Minimo Total               ",
					"       F10  Calculadora                     ",
					cMensaje,
					"       Esc  Salir                           ",
					"" };

				int respuesta[] = { F1,F2,F3,F4,F5,F6,F7,F8,F9,F10,CTRL_F1,0 };
				C_Menu menu(" MENU AYUDA DEL SISTEMA DE CAJAS ", opciones, respuesta);
				iOpcion = menu.OpcionSeleccionada();
			}
		}

		switch (iOpcion)
		{
		case F1:
			iOpcion = VK_SHIFT;
			bSalir = false;
			break;
		case F2:
			//iOpcion=2;
			bSalir = false;
			break;
		case F3:
			//iOpcion=3;
			bSalir = false;
			break;
		case F4:
			//iOpcion=4;                
			bSalir = false;
			break;
		case F5:
			//iOpcion=5;                
			bSalir = false;
			break;
		case F6:
			//iOpcion=6;
			bSalir = false;
			break;
		case F7:
			//iOpcion=7;
			bSalir = false;
			break;
		case F8:
			//iOpcion=8;
			bSalir = false;
			break;
		case F9:
			//iOpcion=9;
			bSalir = false;
			break;
		case F10:
			//iOpcion=10;                
			bSalir = false;
			break;
		case CTRL_F1:
			//iOpcion=11;                                
			bSalir = false;
			break;
		case CTRL_F3:
			bSalir = false;
			break;
		case CTRL_F7:
			bSalir = false;
			break;
		case ESC:
			bSalir = false;
			//iOpcion=1;
			break;
		default:
			break;
		}
	}
	asignarFoco();
	return iOpcion;
}

void CDlgCapturarAbono::desplegarSaldarCuenta()
{
	char cLog[500] = { 0 };
	int iColX = 0;
	CString sSaldaConX, sConcepto;
	char cTexto[30] = { 0 };

	sprintf_s(cLog, "FC0200805021521401 - entra - desplegarSaldarCuenta");
	grabarLog(cLog);

	iColX = m_grid.GetCurrentCol(); //obtener la columna donde esta posicionado
	m_grid.QuickGetText(iColX, -1, &sConcepto);
	sConcepto.Trim();
	sprintf_s(cTexto, "%s", (LPCTSTR)sConcepto);

	if (memcmp(cTexto, "SEGURO", 6) != 0 && memcmp(cTexto, "P.FAMILIAR", 10) != 0 && memcmp(cTexto, "P.SALUD", 7) != 0 && memcmp(cTexto, "AUTO PROT.", 10) != 0)
	{
		m_grid.QuickGetText(iColX, 18, &sSaldaConX);
		sSaldaConX.Remove(',');
		sSaldaConX.Remove('.');
		sprintf_s(cTexto, "%s", (LPCTSTR)sSaldaConX);
		if (valor_campo(cTexto, 9) > 0L)
		{
			m_grid.QuickSetText(iColX, 21, cTexto);
			m_grid.RedrawCell(iColX, 21);
		}
	}
}

void CDlgCapturarAbono::desplegarPagoMinimoCuenta()
{
	char cLog[500] = { 0 };
	int iColX = 0;
	CString sTexto, sConcepto;
	long lMinimoX = 0L, lSaldoX = 0, lSaldaConX = 0L, lMin = 0L, lMinRedondeado = 0L;
	char cTexto[30] = { 0 };

	sprintf_s(cLog, "FC0200805021521405 - entra - desplegarPagoMinimoCuenta");
	grabarLog(cLog);

	iColX = m_grid.GetCurrentCol(); //obtener la columna donde esta posicionado
	m_grid.QuickGetText(iColX, -1, &sConcepto);
	sConcepto.Trim();
	sprintf_s(cTexto, "%s", (LPCTSTR)sConcepto);

	if (memcmp(cTexto, "SEGURO", 6) != 0 && memcmp(cTexto, "P.FAMILIAR", 10) != 0 && memcmp(cTexto, "P.SALUD", 7) != 0 && memcmp(cTexto, "AUTO PROT.", 10) != 0)
	{
		m_grid.QuickGetText(iColX, 16, &sTexto);
		sTexto.Remove('.');
		sTexto.Remove(',');
		sprintf_s(cTexto, "%s", (LPCTSTR)sTexto);
		lMinimoX = valor_campo(cTexto, 9);
		lMin = valor_campo(cTexto, 9);

		sprintf_s(cTexto, "%ld", lMin);
		m_grid.QuickSetText(iColX, 21, cTexto);
		m_grid.RedrawCell(iColX, 21);
	}
}

void CDlgCapturarAbono::desplegarSaldarTodasCuentas()
{
	char cLog[500] = { 0 };
	int i = 0;
	CString sSaldaConX, sConcepto;
	char cTexto[30] = { 0 };

	sprintf_s(cLog, "FC0200805021521409 - entra - desplegarSaldarTodasCuentas");
	grabarLog(cLog);

	for (i = 0; i < iTotalCuentas; i++)
	{
		m_grid.QuickGetText(i, -1, &sConcepto);
		sConcepto.Trim();
		sprintf_s(cTexto, "%s", (LPCTSTR)sConcepto);

		if (memcmp(cTexto, "SEGURO", 6) != 0 && memcmp(cTexto, "P.FAMILIAR", 10) != 0 && memcmp(cTexto, "P.SALUD", 7) != 0 && memcmp(cTexto, "AUTO PROT.", 10) != 0)
		{
			m_grid.QuickGetText(i, 18, &sSaldaConX);
			sSaldaConX.Remove('.');
			sSaldaConX.Remove(',');
			sprintf_s(cTexto, "%s", (LPCTSTR)sSaldaConX);
			if (valor_campo(cTexto, 9) > 0L)
			{
				m_grid.QuickSetText(i, 21, cTexto);
				m_grid.RedrawCell(i, 21);
			}
		}
	}
}

void CDlgCapturarAbono::desplegarPagoMinimoCuentas()
{
	char cLog[500] = { 0 };
	int i = 0;
	CString sTexto, sConcepto;
	char cTexto[30] = { 0 };
	long lMinimoX = 0L, lSaldoX = 0, lSaldaConX = 0L, lMin = 0L, lMinRedondeado = 0L;

	sprintf_s(cLog, "FC0200805021521413 - entra - desplegarPagoMinimoCuentas");
	grabarLog(cLog);

	for (i = 0; i < iTotalCuentas; i++)
	{
		m_grid.QuickGetText(i, -1, &sConcepto);
		sConcepto.Trim();
		sprintf_s(cTexto, "%s", (LPCTSTR)sConcepto);

		if (memcmp(cTexto, "SEGURO", 6) != 0 && memcmp(cTexto, "P.FAMILIAR", 10) != 0 && memcmp(cTexto, "P.SALUD", 7) != 0 && memcmp(cTexto, "AUTO PROT.", 10) != 0)
		{
			m_grid.QuickGetText(i, 16, &sTexto);
			sTexto.Remove(',');
			sTexto.Remove('.');
			sprintf_s(cTexto, "%s", (LPCTSTR)sTexto);
			lMinimoX = valor_campo(cTexto, 9);
			lMin = valor_campo(cTexto, 9);

			sprintf_s(cTexto, "%ld", lMin);
			m_grid.QuickSetText(i, 21, cTexto);
			m_grid.RedrawCell(i, 21);
		}
	}
}

void CDlgCapturarAbono::calculadora()
{
	char cLog[500] = { 0 };

	sprintf_s(cLog, "FC0200805021521417 - entra - calculadora");
	grabarLog(cLog);

	if (_access("c:\\windows\\system32\\calc.exe", 0) == 0)
	{
		_spawnl(_P_NOWAIT, "c:\\windows\\System32\\calc.exe", "c:\\windows\\System32\\calc.exe", NULL);
	}
	else
	{
		_spawnl(_P_NOWAIT, "c:\\windows\\calc.exe", "c:\\windows\\calc.exe", NULL);
	}
	iFoco = 1;
}

bool CDlgCapturarAbono::grabarClienteEtpTemporal(long lSuPago)
{
	char cLog[500] = { 0 };
	CString sTexto;
	bool bContinuar = true;

	sprintf_s(cLog, "FC0200805021521421 - entra - grabarClienteEtpTemporal");
	grabarLog(cLog);

	grabarLog("grabarClienteEtpTemporal::grabando cliente Etp en tabla temporal");

	CGrabarTmpCaCarmovEtp2 tmpCaCarmovEtp(&odbc);     // conexión al tienda.nnnn
	{

		tmpCaCarmovEtp.clave[0] = 'P';
		tmpCaCarmovEtp.clave[1] = 0;

		tmpCaCarmovEtp.tipomovimiento[0] = cTipoEtp[0];
		tmpCaCarmovEtp.tipomovimiento[1] = 0;
		tmpCaCarmovEtp.clavelocal[0] = '2';
		tmpCaCarmovEtp.clavelocal[1] = 0;

		tmpCaCarmovEtp.cliente = m_grid.lCliente;
		tmpCaCarmovEtp.tienda = (short)m_grid.iTienda;
		tmpCaCarmovEtp.ciudad = (short)iCiudadGnDominio;
		tmpCaCarmovEtp.caja = (short)iCajaActual;

		tmpCaCarmovEtp.fecha.ponerFecha(iDiaActual, iMesActual, iAnioActual);

		tmpCaCarmovEtp.importe = lSuPago;
		tmpCaCarmovEtp.recibo = 0L;
		tmpCaCarmovEtp.clienteetp = lClienteEtp;
		tmpCaCarmovEtp.cajaoriginal = (short)iCajaOriginal;
		tmpCaCarmovEtp.efectuo = m_grid.lEmpleado;

		if (iTipoEtpFicha == 1)
			tmpCaCarmovEtp.digito = 1;
		else
			tmpCaCarmovEtp.digito = 0;

		sTexto.Format("%s", cIpServidorCartera);
		sTexto.Trim();
		sprintf_s(tmpCaCarmovEtp.ipcarteracliente, "%s", (LPCTSTR)sTexto);

		tmpCaCarmovEtp.prepararInsert("tmpclienteetpcacarmov");
		if (tmpCaCarmovEtp.Insert())
		{
			tmpCaCarmovEtp.Commit();
			iFlagClienteEtp = 1;
		}
		else
		{
			tmpCaCarmovEtp.odbc->GetLastError(tmpCaCarmovEtp.GetHstmt());
			grabarMensajeError("C", m_grid.iCaja, (LPTSTR)(LPCTSTR)m_grid.sServer, "CapturarAbono", "CDlgCapturarAbono", "grabarClienteEtpTemporal", "Error al Insertar en la Tabla tmpclienteetpcacarmov", m_grid.lEmpleado, "ERROR EN LA CONSULTA(grabarclienteetptemporal)", tmpCaCarmovEtp.odbc, m_grid.iMuestraMsg);
			bContinuar = false;
		}
	}
	return bContinuar;
}

bool CDlgCapturarAbono::grabarEficienciaCajeraTemporal(long lEmpleado, long lSaldo, long lSuPago, long lSaldaCon, long lVencido, int iDiaConvenio, int iMesConvenio, int iPlazoConvenio)
{
	char cLog[500] = { 0 };
	long lConv = 0L;
	int iRespuestaConvenio = 0, iFlag = 0;
	bool bContinuar = true;

	sprintf_s(cLog, "FC0200805021521425 - entra - grabarEficienciaCajeraTemporal");
	grabarLog(cLog);

	grabarLog("grabarEficienciaCajeraTemporal::grabando eficiencia cajera en tabla temporal");

	CGrabarTmpCaEficienciaCajeras tmpCaEficienciaCajeras(&odbc);     // conexión al tienda.nnnn
	{
		tmpCaEficienciaCajeras.cuentasconsaldo = 0;
		tmpCaEficienciaCajeras.cuentasconvencido = 0;
		tmpCaEficienciaCajeras.cuentasconvencidosinconvenio = 0;
		tmpCaEficienciaCajeras.cuentasconconvenio = 0;

		tmpCaEficienciaCajeras.tienda = (short)m_grid.iTienda;
		tmpCaEficienciaCajeras.fechaeficienciacajera.ponerFecha(iDiaActual, iMesActual, iAnioActual);

		tmpCaEficienciaCajeras.caja = (short)m_grid.iCaja;
		tmpCaEficienciaCajeras.recibo = 0L;
		tmpCaEficienciaCajeras.cliente = m_grid.lCliente;
		tmpCaEficienciaCajeras.empleado = lEmpleado;

		if (lSaldo - lSuPago > 0L)
		{
			tmpCaEficienciaCajeras.cuentasconsaldo = lSaldaCon - lSuPago;
			iFlag = 1;
		}

		if (lVencido > 0L)
		{
			if (lVencido - lSuPago > 0L)
			{
				tmpCaEficienciaCajeras.cuentasconvencido = lVencido - lSuPago;
				iFlag = 1;
			}
		}

		if (iDiaConvenio > 0 &&
			iMesConvenio > 0 &&
			iPlazoConvenio > 0)
		{
			iRespuestaConvenio = checarVigenciaConvenio(iDiaConvenio, iMesConvenio, iPlazoConvenio);

			if (lVencido > 0L)
			{
				if (iRespuestaConvenio == 0L)
				{
					//Convenio vencido
					if (lVencido - lSuPago > 0L)
					{
						lConv = lVencido - lSuPago;
						tmpCaEficienciaCajeras.cuentasconvencidosinconvenio = lConv;
						iFlag = 1;
					}
				}
			}

			if (iRespuestaConvenio == 2)
			{
				//Convenio efectuado el d¡a de hoy
				lConv = lSuPago;
				if (lConv == 0L)
				{
					lConv = 1;
				}
				tmpCaEficienciaCajeras.cuentasconconvenio = lConv;
				iFlag = 1;
			}
		}
		else
		{
			if (lVencido > 0L)
			{
				//Cuenta sin Convenio
				if (lVencido - lSuPago > 0L)
				{
					tmpCaEficienciaCajeras.cuentasconvencidosinconvenio = lVencido - lSuPago;
					iFlag = 1;
				}
			}
		}

		if (iFlag == 1 && iFlagSupervisor != 1)
		{
			tmpCaEficienciaCajeras.prepararInsert("tmpcaeficienciacajeras");
			if (tmpCaEficienciaCajeras.Insert())
			{
				tmpCaEficienciaCajeras.Commit();
				iFlagEficienciaCajera = 1;

			}
			else
			{
				tmpCaEficienciaCajeras.odbc->GetLastError(tmpCaEficienciaCajeras.GetHstmt());
				grabarMensajeError("C", m_grid.iCaja, (LPTSTR)(LPCTSTR)m_grid.sServer, "CapturarAbono", "CDlgCapturarAbono", "grabarEficienciaCajeraTemporal", "Error al Insertar en la Tabla tmpCaEficienciaCajeras", m_grid.lEmpleado, "ERROR EN LA CONSULTA(grabareficienciacajeratemporal)", tmpCaEficienciaCajeras.odbc, m_grid.iMuestraMsg);
				bContinuar = false;
			}
		}
	}
	return bContinuar;
}

int CDlgCapturarAbono::checarVigenciaConvenio(int iDia, int iMes, int iPlazo)
{
	char cLog[500] = { 0 };
	int  iRegresa = 0;
	long lFecha1, lFecha2;
	char cFechaConvenio[10] = { 0 }, cFechaActual[10] = { 0 }, cTexto[20] = { 0 };

	sprintf_s(cLog, "FC0200805021521429 - entra - checarVigenciaConvenio");
	grabarLog(cLog);

	sprintf_s(cTexto, "%04d%02d%02d",
		iAnioActual,
		iMesActual,
		iDiaActual);
	lFecha1 = valor_campo(cTexto, 8);


	sprintf_s(cFechaConvenio, "%02d%02d", iMes, iDia);
	sprintf_s(cFechaActual, "%02d%02d", iMesActual, iDiaActual);

	if (valor_campo(cFechaConvenio, 6) > valor_campo(cFechaActual, 6))
	{
		sprintf_s(cTexto, "%04d%02d%02d",
			iAnioActual - 1,
			iMesActual,
			iDiaActual);
		lFecha2 = valor_campo(cTexto, 8);
	}
	else
	{
		sprintf_s(cTexto, "%04d%02d%02d",
			iAnioActual,
			iMesActual,
			iDiaActual);
		lFecha2 = valor_campo(cTexto, 8);
	}
	lFecha2 += (iPlazo * 7);

	if (lFecha1 <= lFecha2) { iRegresa = 1; }
	if (iDia == iDiaActual && iMes == iMesActual) { iRegresa = 2; }

	return(iRegresa);
}

bool CDlgCapturarAbono::grabarAbonoCaCarmovTemporal(char cClave, char *cEjercicio, long lFactura, long lVencido, long lMinimo, long lEmpleado,
													char *cTipoMovimiento, long lAbonoCuenta, long lSaldoNuevo, long lSaldo,
													long lImporteSaldaCon, long lSaldoFinal, char *cClienteLocalizar,
													long lFechaSaldaCon, long lImporteVenta, long lComision, int iTipoProducto,
													long lMinimoTotal, long lSaldoTotal, long lVencidoTotal, long lMinimoTotalFinal,
													long lSaldoTotalFinal, long lVencidoTotalFinal, long lBase, short iFlagCuentaPerdida, long lSaldoFinalRopa, long lSaldoFinalTasa0, long lSaldoDetalladoRopa, long lSaldoDetalladoTasa0)
{
	char cLog[500] = { 0 };
	int iMesSaldaCon = 0, iDiaSaldaCon = 0, iAnioSaldaCon = 0, iCuentasDetalle = 0;
	CString sTexto;
	bool bContinuar = true, bGraboRopa = false;
	char cTxt[20] = { 50 }, cArchTxt[80] = { 0 }, cNombreCompleto[50] = { 0 };

	sprintf_s(cLog, "FC0200805021521433 - entra - grabarAbonoCaCarmovTemporal");
	grabarLog(cLog);

	CGrabarAbonoTmpCaCarmov04 tmpCaCarmov(&odbc);     // conexión al tienda.nnnn

	{
		while (iCuentasDetalle <= iTotalCuentasDetalle && bContinuar == true)
		{
			if (cClave == 'V') //Reevolvente
			{
				tmpCaCarmov.clave[0] = 'D';
				tmpCaCarmov.clave[1] = 0;
			}
			else
			{
				tmpCaCarmov.clave[0] = 'S';
				tmpCaCarmov.clave[1] = 0;
			}

			tmpCaCarmov.cliente = m_grid.lCliente;

			tmpCaCarmov.tienda = (short)m_grid.iTienda;

			tmpCaCarmov.ciudad = (short)iCiudadGnDominio;

			tmpCaCarmov.caja = (short)iCajaActual;

			tmpCaCarmov.ejercicio[0] = cEjercicio[0];
			tmpCaCarmov.ejercicio[1] = 0;

			tmpCaCarmov.factura = lFactura;

			tmpCaCarmov.fecha.ponerFecha(iDiaActual, iMesActual, iAnioActual);

			tmpCaCarmov.recibo = 0L;
			tmpCaCarmov.vencidoinicial = lVencido;
			tmpCaCarmov.minimoinicial = lMinimo;

			tmpCaCarmov.tipomovimiento[0] = cTipoMovimiento[0];
			tmpCaCarmov.tipomovimiento[1] = 0;
			tmpCaCarmov.iva = 0;
			//tasa 0
			if (cClave == 'R')
			{
				if (iTipoDeduccionRopa == 0 && !bGraboRopa)
				{
					lAbonoCuenta = lAbonoRopa;
					lSaldo = lSaldoDetalladoRopa;
					lSaldoFinal = lSaldoFinalRopa;
					iCuentasDetalle = 1;
					bGraboRopa = true;
					tmpCaCarmov.iva = (short)iTipoDeduccionRopa;
				}
				else if (iTipoDeduccionTasa0 == 2)
				{
					lAbonoCuenta = lAbonoTasa0;
					lSaldo = lSaldoDetalladoTasa0;
					lSaldoFinal = lSaldoFinalTasa0;
					iCuentasDetalle = 2;
					tmpCaCarmov.iva = (short)iTipoDeduccionTasa0;
				}
			}
			else
			{
				iCuentasDetalle = 2;
			}

			tmpCaCarmov.importe = lAbonoCuenta;
			tmpCaCarmov.saldocuenta = lSaldoNuevo;
			tmpCaCarmov.saldoinicial = lSaldo;
			tmpCaCarmov.saldofinal = lSaldoFinal;
			tmpCaCarmov.base = lBase;

			if (iEdadCliente > 99) iEdadCliente = 99;
			tmpCaCarmov.edad = (short)iEdadCliente;
			//aaaammdd

			sprintf_s(cTxt, "%08ld", lFechaSaldaCon);
			iMesSaldaCon = valor_campo(&cTxt[4], 2);
			iDiaSaldaCon = valor_campo(&cTxt[6], 2);
			iAnioSaldaCon = valor_campo(&cTxt[0], 4);

			if (iMesSaldaCon > 0L && iDiaSaldaCon > 0L && iAnioSaldaCon > 0L)
			{
				tmpCaCarmov.fechasaldacon.ponerFecha(iDiaSaldaCon, iMesSaldaCon, iAnioSaldaCon);
			}
			else
			{
				tmpCaCarmov.fechasaldacon.ponerFecha(1, 1, 1900);
			}

			tmpCaCarmov.importesaldacon = lImporteSaldaCon;

			if (cClienteLocalizar[0] != 'C')
			{
				tmpCaCarmov.clientelocalizar[0] = cClienteLocalizar[0];
				tmpCaCarmov.clientelocalizar[1] = 0;
			}
			else
			{
				tmpCaCarmov.clientelocalizar[0] = 'L';
				tmpCaCarmov.clientelocalizar[1] = 0;
			}

			if (iFlagCuentaPerdida == 1)
			{
				tmpCaCarmov.tipoconvenio[0] = 'Z';
				tmpCaCarmov.tipoconvenio[1] = 0;
				lAbonoTotalTmp += lAbonoCuenta;
			}
			else
			{
				tmpCaCarmov.tipoconvenio[0] = ' ';
				tmpCaCarmov.tipoconvenio[1] = 0;
			}

			tmpCaCarmov.tiposeguro[0] = (char)(iTipoSeguro + '0');
			tmpCaCarmov.tiposeguro[1] = 0;

			tmpCaCarmov.cajaoriginal = (short)iCajaOriginal;

			if (m_grid.lCliente == 1708)
			{
				sTexto.Format("%s", cIpServidorCartera);
				sTexto.Trim();
				sprintf_s(tmpCaCarmov.ipcarteracliente, "%s", (LPCTSTR)sTexto);
			}
			else
			{
				sTexto.Format("%s", cIpServidorCartera);
				sTexto.Trim();
				sprintf_s(tmpCaCarmov.ipcarteracliente, "%s", (LPCTSTR)sTexto);
			}

			if (iFlagSupervisor != 1)
			{
				tmpCaCarmov.flagmovtosupervisor[0] = '0';  //cajero
				tmpCaCarmov.flagmovtosupervisor[1] = 0;
				tmpCaCarmov.efectuo = lEmpleado;
			}
			else
			{
				tmpCaCarmov.flagmovtosupervisor[0] = '1'; //supervisor
				tmpCaCarmov.flagmovtosupervisor[1] = 0;
				tmpCaCarmov.efectuo = lEmpleadoSupervisor;
			}

			tmpCaCarmov.importeventa = lImporteVenta; // Será 1 si la cuenta es de BANCOPPEL...
			tmpCaCarmov.comision = lComision;

			tmpCaCarmov.tarjeta = _atoi64(cTarjeta);

			sprintf_s(cNombreCompleto, "%s %s %s", (LPCTSTR)sNombreCliente, (LPCTSTR)sApellidoPaterno, (LPCTSTR)sApellidoMaterno);
			memcpy(tmpCaCarmov.nombrecliente, cNombreCompleto, 45);
			tmpCaCarmov.nombrecliente[44] = 0;

			tmpCaCarmov.tipoproducto = (short)iTipoProducto;
			tmpCaCarmov.minimototal = lMinimoTotal;
			tmpCaCarmov.minimototalfinal = lMinimoTotalFinal;
			tmpCaCarmov.saldototal = lSaldoTotal;
			tmpCaCarmov.saldototalfinal = lSaldoTotalFinal;
			tmpCaCarmov.vencidototal = lVencidoTotal;
			tmpCaCarmov.vencidototalfinal = lVencidoTotalFinal;
			tmpCaCarmov.plazoconvenio = iPlazoRopa;

			EDatosConvenioCliente[iTotalAbonos].iAbonoFactura = tmpCaCarmov.factura;
			EDatosConvenioCliente[iTotalAbonos].cAbonoPuntualidad = cPuntualidad[0];
			EDatosConvenioCliente[iTotalAbonos].cAbonoClave = tmpCaCarmov.clave[0];
			EDatosConvenioCliente[iTotalAbonos].cAbonoTipoMovi = tmpCaCarmov.tipomovimiento[0];
			tmpCaCarmov.prepararInsert("tmpabonocacarmov");
			if (tmpCaCarmov.Insert())
			{
				tmpCaCarmov.Commit();
				iFlagAbono = 1;
				iCuentasDetalle++;
			}
			else
			{
				tmpCaCarmov.odbc->GetLastError(tmpCaCarmov.GetHstmt());
				grabarMensajeError("C", m_grid.iCaja, (LPTSTR)(LPCTSTR)m_grid.sServer, "CapturarAbono", "CDlgCapturarAbono", "grabarAbonoCaCarmovTemporal", "Error al Insertar en la Tabla tmpabonocacarmov", m_grid.lEmpleado, "ERROR EN LA CONSULTA(grabarabonocacarmovtemporal)", tmpCaCarmov.odbc, m_grid.iMuestraMsg);
				bContinuar = false;
			}
		}
	}
	return bContinuar;
}

int CDlgCapturarAbono::calcularEjercicio(int iAnioVenta)
{
	char cLog[500] = { 0 };
	int iRegresa = 0;

	sprintf_s(cLog, "FC0200805021521438 - entra - calcularEjercicio");
	grabarLog(cLog);

	if (iAnioVenta <= (iAnioActual - 2))
	{
		iRegresa = 1;
	}
	else
	{
		if (iAnioVenta == (iAnioActual - 1))
		{
			iRegresa = 2;
		}
		else
		{
			iRegresa = 3;
		}
	}
	return(iRegresa);
}

void CDlgCapturarAbono::calcularAbonoInteres(long &lAbonoCuenta, long &lAbonoInteres, long lSuPago, long lInteresAdicional)
{
	char cLog[500] = { 0 };
	char cTexto[30] = { 0 };

	sprintf_s(cLog, "FC0200805021521442 - entra - calcularAbonoInteres");
	grabarLog(cLog);

	if (lInteresAdicional > lSuPago)
	{
		lAbonoInteres = lSuPago;
	}
	else
	{
		lAbonoInteres = lInteresAdicional;
		lAbonoCuenta = lSuPago - lInteresAdicional;
	}

	sprintf_s(cLog, "CDlgCapturarAbono::calcularAbonoInteres-> lSuPago = %ld, lInteresAdicional = %ld, lAbonoInteres = %ld, lAbonoCuenta = %ld", lSuPago, lInteresAdicional, lAbonoInteres, lAbonoCuenta);
	grabarLog(cLog);
}

long CDlgCapturarAbono::calcularSaldoNuevo(long lSaldo, long lInteresAdicional, long lSuPago,
										   long lBonificacion, long lSaldaCon)
{
	char cLog[500] = { 0 };
	long lSaldox = 0L, lSaldoNuevo = 0L;

	sprintf_s(cLog, "FC0200805021521446 - entra - calcularSaldoNuevo");
	grabarLog(cLog);

	if (lSuPago < 0L)
	{
		//Se trata de un cargo, se hace la resta para sumar de manera algebr ica
		lSaldoNuevo = (lSaldo - lInteresAdicional) - lSuPago;
	}
	else
	{
		lSaldox = lSaldo - lInteresAdicional;

		if (lInteresAdicional > lSuPago)
		{
			//El saldo NO se mueve, el abono afecta solo a los INTERESES.
			lSaldoNuevo = lSaldox;
		}
		else
		{
			if (lSuPago >= lSaldaCon)
			{
				if (lSuPago > lSaldo)
				{
					lSaldoNuevo = lSaldox - lSuPago - lBonificacion + lInteresAdicional;
				}
			}
			else
			{
				lSaldoNuevo = lSaldox - (lSuPago - lInteresAdicional);
			}
		}
	}
	return(lSaldoNuevo);
}

long CDlgCapturarAbono::obtenerFechaSaldaCon(long lFactura, int iDiaVentaTabla, int iMesVentaTabla, int iAnioVentaTabla)
{
	char cLog[500] = { 0 };
	long lFechaSaldaCon = 0L, lFechaCompra = 0L, lFechaActual = 0L;
	int iDiaSaldaCon = 0, iMesSaldaCon = 0, iAnioSaldaCon = 0, iDiaVenta = 0, iMesVenta = 0, iAnioVenta = 0;
	char cTxt[20] = { 0 };

	sprintf_s(cLog, "FC0200805021521450 - entra - obtenerFechaSaldaCon");
	grabarLog(cLog);

	sprintf_s(cTxt, "%04d%02d%02d", iAnioActual, iMesActual, iDiaActual);
	lFechaActual = valor_campo(cTxt, 8);

	if (lFactura == 0)
	{
		fechaSaldaCon(iDiaSaldaCon, iMesSaldaCon, iAnioSaldaCon);
		sprintf_s(cTxt, "%04d%02d%02d", iAnioSaldaCon, iMesSaldaCon, iDiaSaldaCon);
		lFechaSaldaCon = valor_campo(cTxt, 8);
	}
	else
	{
		iAnioSaldaCon = iAnioVentaTabla;
		iMesSaldaCon = iMesVentaTabla;
		iDiaSaldaCon = iDiaVentaTabla;

		obtenerFechaSaldaCon(iAnioSaldaCon, iMesSaldaCon, iDiaSaldaCon);

		sprintf_s(cTxt, "%04d%02d%02d", iAnioSaldaCon, iMesSaldaCon, iDiaSaldaCon);
		lFechaSaldaCon = valor_campo(cTxt, 8);
	}
	return lFechaSaldaCon;
}

bool CDlgCapturarAbono::grabarCaMovimientosTemporal(int iPlazoConvenio, long lVencido, long lEmpleado,
													long lSaldo, long lSuPago, long lAbonoInteres, long lBonificacion,
													int iDiaVenta, int iMesVenta, int iAnioVenta,
													int iDiaConvenio, int iMesConvenio, int iAnioConvenio)
{
	char cLog[500] = { 0 };
	long lSaldoFinal = 0L;
	bool bContinuar = true;

	sprintf_s(cLog, "FC0200805021521454 - entra - grabarCaMovimientosTemporal");
	grabarLog(cLog);

	grabarLog("grabarCaMovimientosTemporal::Grabando datos convenio en tabla temporal");

	CGrabarTmpCaMovimientos tmpCaMovimientos(&odbc);     // conexión al tienda.nnnn
	{
		tmpCaMovimientos.cliente = m_grid.lCliente;
		tmpCaMovimientos.fechaconvenio.ponerFecha(iDiaConvenio, iMesConvenio, iAnioConvenio);
		tmpCaMovimientos.plazoconvenio = (short)iPlazoConvenio;
		tmpCaMovimientos.vencido = lVencido - lSuPago;
		if (tmpCaMovimientos.vencido < 0L) tmpCaMovimientos.vencido = 0L;

		lSaldoFinal = lSaldo - lSuPago - lAbonoInteres - lBonificacion;
		if (lSaldoFinal < 0L)
		{
			lSaldoFinal = 0L;
		}

		tmpCaMovimientos.saldofinal = lSaldoFinal;
		tmpCaMovimientos.fechacompra.ponerFecha(iDiaVenta, iMesVenta, iAnioVenta);
		tmpCaMovimientos.caja = (short)m_grid.iCaja;
		tmpCaMovimientos.empleado = lEmpleado;


		tmpCaMovimientos.prepararInsert("tmpcamovimientos");
		if (tmpCaMovimientos.Insert())
		{
			tmpCaMovimientos.Commit();
			iFlagMovimientos = 1;
		}
		else
		{
			tmpCaMovimientos.odbc->GetLastError(tmpCaMovimientos.GetHstmt());
			grabarMensajeError("C", m_grid.iCaja, (LPTSTR)(LPCTSTR)m_grid.sServer, "CapturarAbono", "CDlgCapturarAbono", "grabarCaMovimientosTemporal", "Error al Insertar en la Tabla tmpcamovimientos", m_grid.lEmpleado, "ERROR EN LA CONSULTA(grabarcamovimientostemporal)", tmpCaMovimientos.odbc, m_grid.iMuestraMsg);
			bContinuar = false;
		}
	}
	return bContinuar;
}

long CDlgCapturarAbono::grabarAbonoInteresCaCarmovTemporal(long lFactura, char *cClaveCuenta, int iFlagSupervisor, long lAbonoInteres, long lAbonoCuenta, long lSaldo, long lInteresAdicional, long lSuPago, long lBonificacion, long lSaldaCon,
														   char *cStatus, char *cLocalizar, int iAnioVenta, long lVencido, long lMinimo, bool &bContinuar, long lImporteVenta, long lComision, long lInteresPrimerMes, int iTipoProducto,
														   long lMinimoTotal, long lSaldoTotal, long lVencidoTotal, long lMinimoTotalFinal, long lSaldoTotalFinal, long lVencidoTotalFinal, long lAbonoInteresesRopa, long lSaldoDetalladoRopa, long lAbonoInteresesTasa0, long lSaldoDetalladoTasa0, long imp_descuento)
{
	char cLog[1024] = { 0 };
	CString sTexto;
	//bool bContinuar;
	bContinuar = true;
	char cNombreCompleto[50] = { 0 };
	long lSaldoNuevoInteres = 0L, lSaldoNuevo = 0L, lSaldoDetalle = 0L;
	bool  bGraboRopa = false;
	int iCuentasDetalle = 0, importedesc = 0, saldosinininteres = 0;
	double importeropa = 0, importeropa0 = 0, diferenciaintropa = 0;

	sprintf_s(cLog, "FC0200805021521458 - entra - grabarAbonoInteresCaCarmovTemporal");
	grabarLog(cLog);

	grabarLog("grabarAbonoInteresCaCarmovTemporal:: Grabando interes en tabla temporal");

	CGrabarTmpAbonoInteresCaCarmov05 tmpAbonoInteresCaCarmov(&odbc);
	{
		while (iCuentasDetalle <= iTotalCuentasDetalle && bContinuar == true)
		{
			tmpAbonoInteresCaCarmov.clave[0] = 'I';
			tmpAbonoInteresCaCarmov.clave[1] = 0;

			tmpAbonoInteresCaCarmov.tienda = (short)m_grid.iTienda;

			tmpAbonoInteresCaCarmov.ciudad = (short)iCiudadGnDominio;

			tmpAbonoInteresCaCarmov.cliente = m_grid.lCliente;

			tmpAbonoInteresCaCarmov.caja = (short)iCajaActual;

			tmpAbonoInteresCaCarmov.recibo = 0L;

			tmpAbonoInteresCaCarmov.factura = lFactura;

			tmpAbonoInteresCaCarmov.vencidoinicial = lVencido;
			tmpAbonoInteresCaCarmov.minimoinicial = lMinimo;

			tmpAbonoInteresCaCarmov.fecha.ponerFecha(iDiaActual, iMesActual, iAnioActual);

			tmpAbonoInteresCaCarmov.clavelocal[0] = cLocal[0];
			tmpAbonoInteresCaCarmov.clavelocal[1] = 0;

			if (cLocalizar[0] == 'C')
			{
				tmpAbonoInteresCaCarmov.clientelocalizar[0] = 'L';
				tmpAbonoInteresCaCarmov.clientelocalizar[0] = 0;
			}
			else
			{
				tmpAbonoInteresCaCarmov.clientelocalizar[0] = '0';
				tmpAbonoInteresCaCarmov.clientelocalizar[0] = 0;
			}


			tmpAbonoInteresCaCarmov.anexo[0] = cStatus[0];
			tmpAbonoInteresCaCarmov.anexo[1] = 0;

			tmpAbonoInteresCaCarmov.plazoconvenio = 0;

			switch (cClaveCuenta[0])
			{

			case 'R'://Ropa
				tmpAbonoInteresCaCarmov.tipomovimiento[0] = '1';
				tmpAbonoInteresCaCarmov.tipomovimiento[1] = 0;
				tmpAbonoInteresCaCarmov.ejercicio[0] = '3';
				tmpAbonoInteresCaCarmov.ejercicio[1] = 0;
				tmpAbonoInteresCaCarmov.plazoconvenio = iPlazoRopa;
				break;
			case 'M'://Muebles
				tmpAbonoInteresCaCarmov.tipomovimiento[0] = '2';
				tmpAbonoInteresCaCarmov.tipomovimiento[1] = 0;
				tmpAbonoInteresCaCarmov.ejercicio[0] = (char)(calcularEjercicio(iAnioVenta) + '0');
				tmpAbonoInteresCaCarmov.ejercicio[1] = 0;
				break;
			case 'T':// Tiempo aire
				tmpAbonoInteresCaCarmov.tipomovimiento[0] = '3';
				tmpAbonoInteresCaCarmov.tipomovimiento[1] = 0;
				tmpAbonoInteresCaCarmov.ejercicio[0] = '3';
				tmpAbonoInteresCaCarmov.ejercicio[1] = 0;
				break;
			case 'P'://Pretamo
				tmpAbonoInteresCaCarmov.clave[0] = 'S';
				tmpAbonoInteresCaCarmov.clave[1] = 0;
				tmpAbonoInteresCaCarmov.tipomovimiento[0] = 'C';
				tmpAbonoInteresCaCarmov.tipomovimiento[1] = 0;
				tmpAbonoInteresCaCarmov.ejercicio[0] = (char)(calcularEjercicio(iAnioVenta) + '0');
				tmpAbonoInteresCaCarmov.ejercicio[1] = 0;
				break;
			case 'B'://bancoppel
				tmpAbonoInteresCaCarmov.tipomovimiento[0] = '4';
				tmpAbonoInteresCaCarmov.tipomovimiento[1] = 0;
				tmpAbonoInteresCaCarmov.ejercicio[0] = (char)(calcularEjercicio(iAnioVenta) + '0');
				tmpAbonoInteresCaCarmov.ejercicio[1] = 0;
				break;
			case 'V'://Revolvente
				tmpAbonoInteresCaCarmov.tipomovimiento[0] = '6';
				tmpAbonoInteresCaCarmov.tipomovimiento[1] = 0;
				tmpAbonoInteresCaCarmov.ejercicio[0] = '3';
				tmpAbonoInteresCaCarmov.ejercicio[1] = 0;
				break;
			default:
				break;
			}

			tmpAbonoInteresCaCarmov.tiposeguro[0] = (char)(iTipoSeguro + '0');
			tmpAbonoInteresCaCarmov.tiposeguro[1] = 0;

			if (iEdadCliente > 99) iEdadCliente = 99;
			tmpAbonoInteresCaCarmov.edad = (short)iEdadCliente;

			if (iFlagSupervisor != 1)
			{
				tmpAbonoInteresCaCarmov.flagmovtosupervisor[0] = '0';  //cajero
				tmpAbonoInteresCaCarmov.flagmovtosupervisor[1] = 0;
				tmpAbonoInteresCaCarmov.efectuo = m_grid.lEmpleado;
			}
			else
			{
				tmpAbonoInteresCaCarmov.flagmovtosupervisor[0] = '1'; //supervisor
				tmpAbonoInteresCaCarmov.flagmovtosupervisor[1] = 0;
				tmpAbonoInteresCaCarmov.efectuo = lEmpleadoSupervisor;
			}

			tmpAbonoInteresCaCarmov.importe = lAbonoInteres - imp_descuento;
			tmpAbonoInteresCaCarmov.base = lInteresPrimerMes;
			lSaldoNuevoInteres = lInteresAdicional - lAbonoInteres;
			tmpAbonoInteresCaCarmov.saldocuenta = lSaldoNuevoInteres;
			tmpAbonoInteresCaCarmov.iva = 0;
			//tasa 0
			if (cClaveCuenta[0] == 'R' && iTotalCuentasDetalle > 0)
			{
				saldosinininteres = lSaldo - lInteresAdicional;
				importeropa0 = (double)((double)(lSaldoTasa0) / (double)(saldosinininteres));
				importeropa0 = (int)((importeropa0)* imp_descuento);

				importeropa = (double)((double)(lSaldoRopa) / (double)(saldosinininteres));
				importeropa = (int)((importeropa)* imp_descuento);

				diferenciaintropa = imp_descuento - (importeropa0 + importeropa);

				if ((lInteresesRopa - importeropa) > 0)
				{
					importeropa += diferenciaintropa;
				}
				else
				{
					importeropa0 += diferenciaintropa;
				}

				if (iTipoDeduccionRopa == 0 && !bGraboRopa)
				{
					lAbonoInteres = lAbonoInteresesRopa;
					lSaldoDetalle = lSaldoDetalladoRopa;
					tmpAbonoInteresCaCarmov.iva = (short)iTipoDeduccionRopa;
					if (iAplicoDescuento == 1)
					{
						lAbonoInteres -= (long)importeropa;
					}
					bGraboRopa = true;
					iCuentasDetalle = 1;
				}
				else if (iTipoDeduccionTasa0 == 2)
				{
					lAbonoInteres = lAbonoInteresesTasa0;
					lSaldoDetalle = lSaldoDetalladoTasa0;
					tmpAbonoInteresCaCarmov.iva = (short)iTipoDeduccionTasa0;
					if (iAplicoDescuento == 1)
					{
						lAbonoInteres -= (long)importeropa0;
					}
					iCuentasDetalle = 2;
				}
				tmpAbonoInteresCaCarmov.importe = lAbonoInteres;
				lSaldoNuevoInteres = lInteresAdicional - (lAbonoInteresesRopa + lAbonoInteresesTasa0);
				tmpAbonoInteresCaCarmov.saldocuenta = lSaldoNuevoInteres;
				if (lAbonoCuenta != 0L)
				{
					tmpAbonoInteresCaCarmov.saldoinicial = lSaldoDetalle;
					tmpAbonoInteresCaCarmov.saldofinal = lSaldoDetalle - lAbonoInteres;

					lSaldoNuevo = calcularSaldoNuevo(lSaldo, lInteresAdicional, lSuPago, lBonificacion, lSaldaCon);
				}
				else
				{
					tmpAbonoInteresCaCarmov.saldoinicial = lInteresAdicional;
					tmpAbonoInteresCaCarmov.saldofinal = lSaldoNuevoInteres;
					lSaldoNuevo = calcularSaldoNuevo(lSaldo, lInteresAdicional, lSuPago, lBonificacion, lSaldaCon);
				}
			}
			else
			{
				if (lAbonoCuenta != 0L)
				{
					tmpAbonoInteresCaCarmov.saldoinicial = lSaldo;
					tmpAbonoInteresCaCarmov.saldofinal = lSaldo - lAbonoInteres;

					lSaldoNuevo = calcularSaldoNuevo(lSaldo, lInteresAdicional, lSuPago, lBonificacion, lSaldaCon);
				}
				else
				{
					tmpAbonoInteresCaCarmov.saldoinicial = lInteresAdicional;
					tmpAbonoInteresCaCarmov.saldofinal = lSaldoNuevoInteres;
					lSaldoNuevo = calcularSaldoNuevo(lSaldo, lInteresAdicional, lSuPago, lBonificacion, lSaldaCon);
				}
				iCuentasDetalle = 2;
			}

			sprintf_s(cLog, "grabarAbonoInteresCaCarmovTemporal -Descuento cliente:%d, abonointeres:%d,descuento:%d, totalabonointeres:%d, clave I tipomovimiento:%c",m_grid.lCliente,lAbonoInteres,imp_descuento,tmpAbonoInteresCaCarmov.importe,tmpAbonoInteresCaCarmov.tipomovimiento[0]);
			grabarLog(cLog);
			tmpAbonoInteresCaCarmov.cajaoriginal = (short)iCajaOriginal;

			if (m_grid.lCliente == 1708)
			{
				sTexto.Format("%s", cIpServidorCartera);
				sTexto.Trim();
				sprintf_s(tmpAbonoInteresCaCarmov.ipcarteracliente, "%s", (LPCTSTR)sTexto);
			}
			else
			{
				sTexto.Format("%s", cIpServidorCartera);
				sTexto.Trim();
				sprintf_s(tmpAbonoInteresCaCarmov.ipcarteracliente, "%s", (LPCTSTR)sTexto);
			}

			tmpAbonoInteresCaCarmov.importeventa = lImporteVenta;
			tmpAbonoInteresCaCarmov.comision = lComision;


			tmpAbonoInteresCaCarmov.tarjeta = _atoi64(cTarjeta);

			sprintf_s(cNombreCompleto, "%s %s %s", (LPCTSTR)sNombreCliente, (LPCTSTR)sApellidoPaterno, (LPCTSTR)sApellidoMaterno);
			memcpy(tmpAbonoInteresCaCarmov.nombrecliente, cNombreCompleto, 45);
			tmpAbonoInteresCaCarmov.nombrecliente[44] = 0;

			tmpAbonoInteresCaCarmov.tipoproducto = (short)iTipoProducto;
			tmpAbonoInteresCaCarmov.minimototal = lMinimoTotal;
			tmpAbonoInteresCaCarmov.minimototalfinal = lMinimoTotalFinal;
			tmpAbonoInteresCaCarmov.saldototal = lSaldoTotal;
			tmpAbonoInteresCaCarmov.saldototalfinal = lSaldoTotalFinal;
			tmpAbonoInteresCaCarmov.vencidototal = lVencidoTotal;
			tmpAbonoInteresCaCarmov.vencidototalfinal = lVencidoTotalFinal;

			//Se agrego para agregar la pountualidad del cliente---
			EDatosConvenioCliente[iTotalAbonoInte].cAbonoIntePuntualidad = cPuntualidad[0];
			EDatosConvenioCliente[iTotalAbonoInte].iAbonoInteFactura = tmpAbonoInteresCaCarmov.factura;
			EDatosConvenioCliente[iTotalAbonoInte].cAbonoInteClave = tmpAbonoInteresCaCarmov.clave[0];
			EDatosConvenioCliente[iTotalAbonoInte].cAbonoInteTipoMovi = tmpAbonoInteresCaCarmov.tipomovimiento[0];
			//*******************************
			tmpAbonoInteresCaCarmov.prepararInsert("tmpabonointerescacarmov");
			if (tmpAbonoInteresCaCarmov.Insert())
			{
				tmpAbonoInteresCaCarmov.Commit();
				iFlagAbonoInteres = 1;
				iCuentasDetalle++;
			}
			else
			{
				tmpAbonoInteresCaCarmov.odbc->GetLastError(tmpAbonoInteresCaCarmov.GetHstmt());
				grabarMensajeError("C", m_grid.iCaja, (LPTSTR)(LPCTSTR)m_grid.sServer, "CapturarAbono", "CDlgCapturarAbono", "grabarAbonoInteresCaCarmovTemporal", "Error al Insertar en la Tabla tmpabonointerescacarmov", m_grid.lEmpleado, "ERROR EN LA CONSULTA(grabarabonointerescacarmovtemporal)", tmpAbonoInteresCaCarmov.odbc, m_grid.iMuestraMsg);
				bContinuar = false;
			}
		}
	}
	return lSaldoNuevo;
}

bool CDlgCapturarAbono::grabarConvenioCaCarmovTemporal(long lFactura, char *cClaveCuenta, long lSuPago, int iPlazoConvenio,
													   long lEmpleadoMicro, long lImporteConvenio, int iFlagSupervisor, char *cStatus,
													   long lMinimo, long lSaldo, int iAnioVenta, long lVencido, int iTipoConvenio, int iSubTipoConvenio, long lImporteVenta, int iTipoProducto, long lMinimoTotal, long lSaldoTotal, long lVencidoTotal, long lMinimoTotalFinal, long lSaldoTotalFinal, long lVencidoTotalFinal)
{
	char cLog[500] = { 0 };
	CString sTexto;
	bool bContinuar = true;
	char cTxt[5] = { 0 }, cNombreCompleto[50] = { 0 };

	sprintf_s(cLog, "FC0200805021521463 - entra - grabarConvenioCaCarmovTemporal");
	grabarLog(cLog);

	grabarLog("grabarConvenioCaCarmovTemporal::Grabando convenio en tabla temporal");

	CGrabarTmpConvenioCaCarmov03 tmpConvenioCaCarmov(&odbc);     // conexión al tienda.nnnn
	{
		if (lFactura <= 0L || lFactura > 999999L)
		{
			tmpConvenioCaCarmov.factura = 0L;
		}
		else
		{
			tmpConvenioCaCarmov.factura = lFactura;
		}

		if (lSuPago == 0L)
		{
			tmpConvenioCaCarmov.saldoinicial = lSaldo;
			tmpConvenioCaCarmov.saldofinal = lSaldo;
			tmpConvenioCaCarmov.saldocuenta = lSaldo;
		}
		else
		{
			tmpConvenioCaCarmov.saldoinicial = 0;
			tmpConvenioCaCarmov.saldofinal = 0;
			tmpConvenioCaCarmov.saldocuenta = 0;
		}

		tmpConvenioCaCarmov.plazoconvenio = (short)iPlazoConvenio;
		tmpConvenioCaCarmov.efectuo = lEmpleadoMicro;

		if (EDatosConvenioCliente[iConConvenio].iAbonoConVencidoFinal >= lImporteConvenio)//En Caso que el vencido sea menor al conv, se topara al vencido de la cuenta..
		{
			tmpConvenioCaCarmov.importe = lImporteConvenio;
		}
		else
		{
			tmpConvenioCaCarmov.importe = (EDatosConvenioCliente[iConConvenio].iAbonoConVencidoFinal);
		}

		tmpConvenioCaCarmov.clave[0] = 'S';
		tmpConvenioCaCarmov.clave[1] = 0;

		switch (cClaveCuenta[0])
		{
		case 'T':
			tmpConvenioCaCarmov.tipomovimiento[0] = 'M'; //convenio de Tiempo Aire
			tmpConvenioCaCarmov.tipomovimiento[1] = 0;
			tmpConvenioCaCarmov.ejercicio[0] = '3';
			tmpConvenioCaCarmov.ejercicio[1] = 0;
			break;
		case 'R':
			tmpConvenioCaCarmov.tipomovimiento[0] = '9'; //convenio de ropa
			tmpConvenioCaCarmov.tipomovimiento[1] = 0;
			tmpConvenioCaCarmov.ejercicio[0] = '3';
			tmpConvenioCaCarmov.ejercicio[1] = 0;
			tmpConvenioCaCarmov.factura = 0L;
			break;
		case 'M':
			tmpConvenioCaCarmov.tipomovimiento[0] = '8'; //convenio de muebles
			tmpConvenioCaCarmov.tipomovimiento[1] = 0;
			tmpConvenioCaCarmov.ejercicio[0] = (char)(calcularEjercicio(iAnioVenta) + '0');
			tmpConvenioCaCarmov.ejercicio[1] = 0;
			break;
		case 'P':
			tmpConvenioCaCarmov.tipomovimiento[0] = 'F'; //convenio de un prestamo
			tmpConvenioCaCarmov.tipomovimiento[1] = 0;
			tmpConvenioCaCarmov.ejercicio[0] = (char)(calcularEjercicio(iAnioVenta) + '0');
			tmpConvenioCaCarmov.ejercicio[1] = 0;
			break;
		case 'B':
			tmpConvenioCaCarmov.tipomovimiento[0] = 'Q';//Convenio Bancoppel
			tmpConvenioCaCarmov.tipomovimiento[1] = 0;
			tmpConvenioCaCarmov.ejercicio[0] = (char)(calcularEjercicio(iAnioVenta) + '0');
			tmpConvenioCaCarmov.ejercicio[1] = 0;
			break;
		case 'V':
			tmpConvenioCaCarmov.clave[0] = 'D';
			tmpConvenioCaCarmov.clave[1] = 0;
			tmpConvenioCaCarmov.tipomovimiento[0] = '8';// Convenio Revolvente
			tmpConvenioCaCarmov.tipomovimiento[1] = 0;
			tmpConvenioCaCarmov.ejercicio[0] = '3';
			tmpConvenioCaCarmov.ejercicio[1] = 0;
			break;
		default:
			break;
		}

		sprintf_s(tmpConvenioCaCarmov.tipoconvenio, "%02d", iTipoConvenio);

		if (lFactura == 1)
		{
			tmpConvenioCaCarmov.clientelocalizar[0] = 'L';
			tmpConvenioCaCarmov.clientelocalizar[1] = 0;
		}
		else
		{
			tmpConvenioCaCarmov.clientelocalizar[0] = '0';
			tmpConvenioCaCarmov.clientelocalizar[1] = 0;
		}

		tmpConvenioCaCarmov.tiposeguro[0] = (char)(iTipoSeguro + '0');
		tmpConvenioCaCarmov.tiposeguro[1] = 0;

		tmpConvenioCaCarmov.cliente = m_grid.lCliente;
		tmpConvenioCaCarmov.tienda = (short)m_grid.iTienda;
		tmpConvenioCaCarmov.ciudad = (short)iCiudadGnDominio;
		tmpConvenioCaCarmov.caja = (short)iCajaActual;

		tmpConvenioCaCarmov.fecha.ponerFecha(iDiaActual, iMesActual, iAnioActual);

		tmpConvenioCaCarmov.recibo = 0L;
		tmpConvenioCaCarmov.vencidoinicial = lVencido;
		tmpConvenioCaCarmov.minimoinicial = lMinimo;

		tmpConvenioCaCarmov.anexo[0] = cStatus[0];
		tmpConvenioCaCarmov.anexo[1] = 0;


		tmpConvenioCaCarmov.clavelocal[0] = '1';
		tmpConvenioCaCarmov.clavelocal[1] = 0;

		if (iFlagSupervisor == 1)
		{
			tmpConvenioCaCarmov.flagmovtosupervisor[0] = '1';
			tmpConvenioCaCarmov.flagmovtosupervisor[1] = 0;
		}
		else
		{
			tmpConvenioCaCarmov.flagmovtosupervisor[0] = '0';
			tmpConvenioCaCarmov.flagmovtosupervisor[1] = 0;
		}

		sprintf_s(cTxt, "%d%d", iTipoConvenio, iSubTipoConvenio);

		tmpConvenioCaCarmov.tipoconvenio[0] = cTxt[0];
		tmpConvenioCaCarmov.tipoconvenio[1] = 0;

		tmpConvenioCaCarmov.subtipoconvenio[0] = cTxt[1];
		tmpConvenioCaCarmov.subtipoconvenio[1] = 0;

		tmpConvenioCaCarmov.cajaoriginal = (short)iCajaOriginal;

		if (m_grid.lCliente == 1708)
		{
			sTexto.Format("%s", cIpServidorCartera);
			sTexto.Trim();
			sprintf_s(tmpConvenioCaCarmov.ipcarteracliente, "%s", (LPCTSTR)sTexto);
		}
		else
		{
			sTexto.Format("%s", cIpServidorCartera);
			sTexto.Trim();
			sprintf_s(tmpConvenioCaCarmov.ipcarteracliente, "%s", (LPCTSTR)sTexto);
		}

		tmpConvenioCaCarmov.importeventa = lImporteVenta;

		tmpConvenioCaCarmov.tarjeta = _atoi64(cTarjeta);

		sprintf_s(cNombreCompleto, "%s %s %s", (LPCTSTR)sNombreCliente, (LPCTSTR)sApellidoPaterno, (LPCTSTR)sApellidoMaterno);
		memcpy(tmpConvenioCaCarmov.nombrecliente, cNombreCompleto, 45);
		tmpConvenioCaCarmov.nombrecliente[44] = 0;

		tmpConvenioCaCarmov.tipoproducto = (short)iTipoProducto;
		tmpConvenioCaCarmov.minimototal = lMinimoTotal;
		tmpConvenioCaCarmov.minimototalfinal = lMinimoTotalFinal;
		tmpConvenioCaCarmov.saldototal = lSaldoTotal;
		tmpConvenioCaCarmov.saldototalfinal = lSaldoTotalFinal;
		tmpConvenioCaCarmov.vencidototal = lVencidoTotal;
		tmpConvenioCaCarmov.vencidototalfinal = lVencidoTotalFinal;

		//Se agrego para actualizar la puntualidad del cliente y los convenios validos/invalidos
		EDatosConvenioCliente[iConConvenio].cPuntualidadcteConv = cPuntualidad[0];
		EDatosConvenioCliente[iConConvenio].CAbonosubtipoconvenio = tmpConvenioCaCarmov.subtipoconvenio[0];
		EDatosConvenioCliente[iConConvenio].iGanode = (short)iSistema;
		EDatosConvenioCliente[iConConvenio].iFacturaConv = tmpConvenioCaCarmov.factura;
		EDatosConvenioCliente[iConConvenio].cTipomovimientoConv = tmpConvenioCaCarmov.tipomovimiento[0];
		EDatosConvenioCliente[iConConvenio].cClave = tmpConvenioCaCarmov.clave[0];
		EDatosConvenioCliente[iConConvenio].iImporteFinalConv = tmpConvenioCaCarmov.importe;
		iImporteTotalConv = (iImporteTotalConv + tmpConvenioCaCarmov.importe);
		iVencidoTotalConv = lVencidoTotalFinal;
		iConConvenio++;
		/*****************************************************************************************/
		tmpConvenioCaCarmov.prepararInsert("tmpconveniocacarmov");
		if (tmpConvenioCaCarmov.Insert())
		{
			tmpConvenioCaCarmov.Commit();
			iFlagConvenio = 1;
		}
		else
		{
			tmpConvenioCaCarmov.odbc->GetLastError(tmpConvenioCaCarmov.GetHstmt());
			grabarMensajeError("C", m_grid.iCaja, (LPTSTR)(LPCTSTR)m_grid.sServer, "CapturarAbono", "CDlgCapturarAbono", "grabarConvenioCaCarmovTemporal", "Error al Insertar en la Tabla tmpconveniocacarmov", m_grid.lEmpleado, "ERROR EN LA CONSULTA(grabarconveniocacarmovtemporal)", tmpConvenioCaCarmov.odbc, m_grid.iMuestraMsg);
			bContinuar = false;
		}
	}
	return bContinuar;
}

bool CDlgCapturarAbono::grabarBonificacionCaCarmovTemporal(long lFactura, char *cClaveCuenta, long lBonificacion,
														   long lVencido, long lMinimo, long lEmpleadoMicro, int iFlagSupervisor,
														   char *cStatus, int iAnioVenta, char *cClienteLocalizar, long lImporteVenta, long lComision, int iTipoProducto, long lMinimoTotal, long lSaldoTotal, long lVencidoTotal, long lMinimoTotalFinal, long lSaldoTotalFinal, long lVencidoTotalFinal, long lBonificacionRopa, long lBonificacionTasa0)
{
	char cLog[500] = { 0 };
	CString sTexto;
	char cNombreCompleto[50] = { 0 };
	bool bContinuar = true, bGraboRopa = false;
	int iCuentasDetalle = 0;

	sprintf_s(cLog, "FC0200805021521468 - entra - grabarBonificacionCaCarmovTemporal");
	grabarLog(cLog);

	grabarLog("grabarBonificacionCaCarmovTemporal::Grabando bonificacion en tabla temporal");

	CGrabarTmpBonificacionCaCarmov04    tmpBonificacionCaCarmov(&odbc);     // conexión al tienda.nnnn
	{
		while (iCuentasDetalle <= iTotalCuentasDetalle && bContinuar == true)
		{
			tmpBonificacionCaCarmov.clave[0] = 'S';
			tmpBonificacionCaCarmov.clave[1] = 0;

			switch (cClaveCuenta[0])
			{
			case 'T':
				tmpBonificacionCaCarmov.tipomovimiento[0] = 'L';
				tmpBonificacionCaCarmov.tipomovimiento[1] = 0;
				break;
			case 'R':
				tmpBonificacionCaCarmov.tipomovimiento[0] = '7';
				tmpBonificacionCaCarmov.tipomovimiento[1] = 0;
				break;
			case 'M':
				tmpBonificacionCaCarmov.tipomovimiento[0] = '6';
				tmpBonificacionCaCarmov.tipomovimiento[1] = 0;
				break;
			case 'P':
				tmpBonificacionCaCarmov.tipomovimiento[0] = 'D'; //BONIF. DE PRESTAMOS
				tmpBonificacionCaCarmov.tipomovimiento[1] = 0;
				break;
			case 'B':
				tmpBonificacionCaCarmov.tipomovimiento[0] = 'K';//Bonif deuda Bancoppel
				tmpBonificacionCaCarmov.tipomovimiento[1] = 0;
				break;
			case 'V':
				tmpBonificacionCaCarmov.clave[0] = 'D';
				tmpBonificacionCaCarmov.clave[1] = 0;
				tmpBonificacionCaCarmov.tipomovimiento[0] = '7';
				tmpBonificacionCaCarmov.tipomovimiento[1] = 0;
				break;
			default:
				break;
			}
			tmpBonificacionCaCarmov.importe = lBonificacion;
			tmpBonificacionCaCarmov.iva = 0;
			//tasa 0
			if (cClaveCuenta[0] == 'R')
			{
				if (iTipoDeduccionRopa == 0 && !bGraboRopa)
				{
					tmpBonificacionCaCarmov.importe = lBonificacionRopa;
					tmpBonificacionCaCarmov.iva = (short)iTipoDeduccionRopa;
					bGraboRopa = true;
					iCuentasDetalle = 1;
				}
				else if (iTipoDeduccionTasa0 == 2)
				{
					tmpBonificacionCaCarmov.importe = lBonificacionTasa0;
					tmpBonificacionCaCarmov.iva = (short)iTipoDeduccionTasa0;
					iCuentasDetalle = 2;
				}
			}
			else
			{
				iCuentasDetalle = 2;
			}

			if (cClienteLocalizar[0] == 'C')
			{
				tmpBonificacionCaCarmov.clientelocalizar[0] = 'L';
				tmpBonificacionCaCarmov.clientelocalizar[1] = 0;
			}
			else
			{
				tmpBonificacionCaCarmov.clientelocalizar[0] = '0';
				tmpBonificacionCaCarmov.clientelocalizar[1] = 0;
			}

			tmpBonificacionCaCarmov.cliente = m_grid.lCliente;
			tmpBonificacionCaCarmov.tienda = (short)m_grid.iTienda;
			tmpBonificacionCaCarmov.ciudad = (short)iCiudadGnDominio;
			tmpBonificacionCaCarmov.caja = (short)iCajaActual;

			if (lFactura <= 0L)
			{
				tmpBonificacionCaCarmov.factura = 0L;
				tmpBonificacionCaCarmov.ejercicio[0] = '3';
				tmpBonificacionCaCarmov.ejercicio[1] = 0;
			}
			else
			{
				tmpBonificacionCaCarmov.factura = lFactura;
				tmpBonificacionCaCarmov.ejercicio[0] = (char)(calcularEjercicio(iAnioVenta) + '0');
				tmpBonificacionCaCarmov.ejercicio[1] = 0;
			}

			tmpBonificacionCaCarmov.recibo = 0L;
			tmpBonificacionCaCarmov.fecha.ponerFecha(iDiaActual, iMesActual, iAnioActual);
			tmpBonificacionCaCarmov.vencidoinicial = lVencido;
			tmpBonificacionCaCarmov.minimoinicial = lMinimo;
			tmpBonificacionCaCarmov.anexo[0] = cStatus[0];
			tmpBonificacionCaCarmov.anexo[1] = 0;
			tmpBonificacionCaCarmov.efectuo = lEmpleadoMicro;
			tmpBonificacionCaCarmov.clavelocal[0] = cLocal[0];
			tmpBonificacionCaCarmov.clavelocal[1] = 0;

			if (iFlagSupervisor == 1)
			{
				tmpBonificacionCaCarmov.flagmovtosupervisor[0] = '1';
				tmpBonificacionCaCarmov.flagmovtosupervisor[1] = 0;
			}
			else
			{
				tmpBonificacionCaCarmov.flagmovtosupervisor[0] = '0';
				tmpBonificacionCaCarmov.flagmovtosupervisor[1] = 0;
			}

			tmpBonificacionCaCarmov.cajaoriginal = (short)iCajaOriginal;

			if (m_grid.lCliente == 1708)
			{
				sTexto.Format("%s", cIpServidorCartera);
				sTexto.Trim();
				sprintf_s(tmpBonificacionCaCarmov.ipcarteracliente, "%s", (LPCTSTR)sTexto);
			}
			else
			{
				sTexto.Format("%s", cIpServidorCartera);
				sTexto.Trim();
				sprintf_s(tmpBonificacionCaCarmov.ipcarteracliente, "%s", (LPCTSTR)sTexto);
			}

			tmpBonificacionCaCarmov.importeventa = lImporteVenta;
			tmpBonificacionCaCarmov.comision = lComision;

			tmpBonificacionCaCarmov.tarjeta = _atoi64(cTarjeta);

			sprintf_s(cNombreCompleto, "%s %s %s", (LPCTSTR)sNombreCliente, (LPCTSTR)sApellidoPaterno, (LPCTSTR)sApellidoMaterno);
			memcpy(tmpBonificacionCaCarmov.nombrecliente, cNombreCompleto, 45);
			tmpBonificacionCaCarmov.nombrecliente[44] = 0;

			tmpBonificacionCaCarmov.tipoproducto = (short)iTipoProducto;
			tmpBonificacionCaCarmov.minimototal = lMinimoTotal;
			tmpBonificacionCaCarmov.minimototalfinal = lMinimoTotalFinal;
			tmpBonificacionCaCarmov.saldototal = lSaldoTotal;
			tmpBonificacionCaCarmov.saldototalfinal = lSaldoTotalFinal;
			tmpBonificacionCaCarmov.vencidototal = lVencidoTotal;
			tmpBonificacionCaCarmov.vencidototalfinal = lVencidoTotalFinal;

			tmpBonificacionCaCarmov.prepararInsert("tmpbonificacioncacarmov");
			if (tmpBonificacionCaCarmov.Insert())
			{
				tmpBonificacionCaCarmov.Commit();
				iFlagBonificacion = 1;
				iCuentasDetalle++;
			}
			else
			{
				tmpBonificacionCaCarmov.odbc->GetLastError(tmpBonificacionCaCarmov.GetHstmt());
				grabarMensajeError("C", m_grid.iCaja, (LPTSTR)(LPCTSTR)m_grid.sServer, "CapturarAbono", "CDlgCapturarAbono", "grabarBonificacionCaCarmovTemporal", "Error al Insertar en la Tabla tmpbonificacioncacarmov", m_grid.lEmpleado, "ERROR EN LA CONSULTA(grabarbonificacioncacarmovtemporal)", tmpBonificacionCaCarmov.odbc, m_grid.iMuestraMsg);
				bContinuar = false;
			}
		}
	}
	return bContinuar;
}

bool CDlgCapturarAbono::grabarBeneficiariosCaCarmovTemporal(long lNumeroBeneficiarios, long lEmpleadoMicro, int iTipoProducto, long lMinimoTotal, long lSaldoTotal, long lVencidoTotal, long lMinimoTotalFinal, long lSaldoTotalFinal, long lVencidoTotalFinal)
{
	char cLog[500] = { 0 };
	CString sTexto;
	bool bContinuar = true;
	char cNombreCompleto[50] = { 0 }, cMensaje[200] = { 0 };

	sprintf_s(cLog, "FC0200805021521473 - entra - grabarBeneficiariosCaCarmovTemporal");
	grabarLog(cLog);

	grabarLog("grabarBeneficiariosCaCarmovTemporal::grabando beneficiarios seguro club en tabla temporal");

	CInsertarTmpBeneficiariosCaCarmov01 tmpBeneficiariosCaCarmov(&odbc);     // conexión al tienda.nnnn    
	{
		tmpBeneficiariosCaCarmov.clave[0] = 'G';
		tmpBeneficiariosCaCarmov.clave[1] = 0;

		tmpBeneficiariosCaCarmov.tipomovimiento[0] = '5';
		tmpBeneficiariosCaCarmov.tipomovimiento[1] = 0;

		tmpBeneficiariosCaCarmov.cliente = m_grid.lCliente;

		tmpBeneficiariosCaCarmov.importe = lNumeroBeneficiarios;
		tmpBeneficiariosCaCarmov.recibo = 0L;
		tmpBeneficiariosCaCarmov.tienda = (short)m_grid.iTienda;
		tmpBeneficiariosCaCarmov.ciudad = (short)iCiudadGnDominio;
		tmpBeneficiariosCaCarmov.caja = (short)iCajaActual;
		tmpBeneficiariosCaCarmov.fecha.ponerFecha(iDiaActual, iMesActual, iAnioActual);
		tmpBeneficiariosCaCarmov.folio = 0L;
		tmpBeneficiariosCaCarmov.efectuo = lEmpleadoMicro;

		tmpBeneficiariosCaCarmov.movtoseguro[0] = 'C';
		tmpBeneficiariosCaCarmov.movtoseguro[1] = 0;

		tmpBeneficiariosCaCarmov.cajaoriginal = (short)iCajaOriginal;

		if (m_grid.lCliente == 1708)
		{
			sTexto.Format("%s", cIpServidorCartera);
			sTexto.Trim();
			sprintf_s(tmpBeneficiariosCaCarmov.ipcarteracliente, "%s", (LPCTSTR)sTexto);
		}
		else
		{
			sTexto.Format("%s", cIpServidorCartera);
			sTexto.Trim();
			sprintf_s(tmpBeneficiariosCaCarmov.ipcarteracliente, "%s", (LPCTSTR)sTexto);
		}

		if (iConyugal == 1)
		{
			tmpBeneficiariosCaCarmov.bonificacion = 0L;
		}
		else
		{
			tmpBeneficiariosCaCarmov.bonificacion = 77L;
		}

		tmpBeneficiariosCaCarmov.tarjeta = _atoi64(cTarjeta);

		sprintf_s(cNombreCompleto, "%s %s %s", (LPCTSTR)sNombreCliente, (LPCTSTR)sApellidoPaterno, (LPCTSTR)sApellidoMaterno);
		memcpy(tmpBeneficiariosCaCarmov.nombrecliente, cNombreCompleto, 45);
		tmpBeneficiariosCaCarmov.nombrecliente[44] = 0;

		tmpBeneficiariosCaCarmov.tipoproducto = (short)iTipoProducto;
		tmpBeneficiariosCaCarmov.minimototal = lMinimoTotal;
		tmpBeneficiariosCaCarmov.minimototalfinal = lMinimoTotalFinal;
		tmpBeneficiariosCaCarmov.saldototal = lSaldoTotal;
		tmpBeneficiariosCaCarmov.saldototalfinal = lSaldoTotalFinal;
		tmpBeneficiariosCaCarmov.vencidototal = lVencidoTotal;
		tmpBeneficiariosCaCarmov.vencidototalfinal = lVencidoTotalFinal;

		sprintf_s(cMensaje, "CDlgCapturarAbono::grabar beneficiario en tabla tmpbeneficiarioscacarmov, Cliente = %ld, importe = %ld", tmpBeneficiariosCaCarmov.cliente, tmpBeneficiariosCaCarmov.importe);
		grabarLog(cMensaje);

		tmpBeneficiariosCaCarmov.prepararInsert("tmpbeneficiarioscacarmov");

		if (tmpBeneficiariosCaCarmov.Insert())
		{
			tmpBeneficiariosCaCarmov.Commit();
			iFlagBeneficiarios = 1;
		}
		else
		{
			tmpBeneficiariosCaCarmov.odbc->GetLastError(tmpBeneficiariosCaCarmov.GetHstmt());
			grabarMensajeError("C", m_grid.iCaja, (LPTSTR)(LPCTSTR)m_grid.sServer, "CapturarAbono", "CDlgCapturarAbono", "grabarBeneficiariosCaCarmovTemporal", "Error al Insertar en la Tabla tmpbeneficiarioscacarmov", m_grid.lEmpleado, "ERROR EN LA CONSULTA(grabarbeneficiarioscacarmovtemporal)", tmpBeneficiariosCaCarmov.odbc, m_grid.iMuestraMsg);
			bContinuar = false;
		}

	}
	return bContinuar;
}

//////////////////////////////////////////  FUNCIONES MIAS (IVAN) ///////////////////////////////////////////////
void CDlgCapturarAbono::menuSegurosClub()
{
	char cLog[500] = { 0 };
	bool bSalir = true;
	CString sTexto = "";
	char cMsgBloqueo[1026] = { 0 };

	sprintf_s(cLog, "FC0200805021521477 - entra - menuSegurosClub");
	grabarLog(cLog);

	/*
	//seguros.ano_nacimiento=1;  //Activo con Beneficiarios
	//seguros.ano_nacimiento=2;  //Activo sin Beneficiarios
	//seguros.ano_nacimiento=3;  //Cancelado
	//seguros.ano_nacimiento=4;  //Marca como no ofrecer seguro
	//seguros.ano_nacimiento=5;  //Cancelado por promas
	//seguros.ano_nacimiento=9;  //No tiene seguro club
	*/

	//9923 --> Menu seguro
	grabarLog("menuSegurosClub:Menu Seguros Club de Proteccion Familiar");
	while (bSalir)
	{
		char * opciones[] = {
			"    F1   Activar Club de Protección Familiar   ",
			"    F2   Beneficiarios                         ",
			"    F3   Documentación                         ",
			"    F4   Cancelación de Seguro Adicional       ",
			"    F5   Activar Club Adicional                ",
			"    F6   Pago Apoyo Adicional                  ",
			"    F7   Migración de Seguros                  ",
			"    F8   Sistema de Seguros de Vida            ",
			"    Esc  Salir                                 ",
			"" };

		int respuesta[] = { F1,F2,F3,F4,F5,F6,F7,F8,ESC,0 };

		C_Menu menu(" CLUB DE PROTECCION FAMILIAR ", opciones, respuesta);
		switch (menu.OpcionSeleccionada())
		{
		case F1:
			{
				iClub = PantallaMenuConyugal();
				ventaClubProteccion();
				m_grid.GotoCell(0, 21);
			}
			if (iClub == 3)
			{
				bSalir = false;
			}
			break;

		case F2:    //si
			{
				if (ValidarHabilitarCambioBeneficiarioSeguro())
				{
					iClub = PantallaMenuBeneficiarios();
					clubBeneficiarios();
					m_grid.GotoCell(0, 21);
				}
				else
				{
					memset(cMsgBloqueo, 0, sizeof(cMsgBloqueo));
					ConsultarCatalogoMensajeTienda(MSG_BLOQUEOCAMBIOBENEFICIARIOSEGURO, cMsgBloqueo);
					sTexto.Format("%s", cMsgBloqueo);
					if (sTexto.Trim() != "")
					{
						AfxMessageBox(sTexto.Trim());
					}
				}

			}
			break;
		case F3:   //si
			{
				iClub = PantallaMenuConyugal();
				if (iClub > 0)
				{
					clubDocumentacion();
					m_grid.GotoCell(0, 21);
					if (iClub > 0)
					{
						bSalir = false;
					}
				}
			}
			break;

		case F4:   //si
			{
				if (iFlagPermiteCancelarSeguros == 1)
				{
					iClub = PantallaMenuConyugal();
					if (clubCancelacion() == 1)
					{
						if (iFlagTieneSeguroAdicional == 1)
						{
							borrarTemporalesSeguroAdicional();
						}
						iFlagTieneSeguroAdicional = 0;
						iFlagCapturoSeguroAdicional = 0;
						//borrarCuentaSeguroClubGrid();
						//ponerCuentaSeguroClubGrid();
						inicializar();
						desplegarDatosCliente();
						//m_grid.GotoCell(0,21);
						//sTexto.Format("");
						m_msgMinimo.SetWindowText(sTexto);
					}
					if (iClub > 0)
					{
						m_grid.GotoCell(0, 21);
					}
				}
				else
				{
					memset(cMsgBloqueo, 0, sizeof(cMsgBloqueo));
					ConsultarCatalogoMensajeTienda(MSG_BLOQUEOCANCELACIONSEGURO, cMsgBloqueo);
					sTexto.Format("%s", cMsgBloqueo);
					if (sTexto.Trim() != "")
					{
						AfxMessageBox(sTexto.Trim());
					}
				}
			}
			break;

		case F5:
			if (iFlagPermiteSeguroAdicionalBancoppel == 1)
			{
				ventaClubProteccionAdicional();
			}
			else
			{
				if (obtenerOrigenSeguro() == 1)
				{
					ventaClubProteccionAdicional();
				}
				else
				{
					memset(cMsgBloqueo, 0, sizeof(cMsgBloqueo));
					ConsultarCatalogoMensajeTienda(MSG_BLOQUEOSEGUROADICIONALBANCOPPEL, cMsgBloqueo);
					sTexto.Format("%s", cMsgBloqueo);
					if (sTexto.Trim() != "")
					{
						AfxMessageBox(sTexto.Trim());
					}
				}
			}
			break;
		case F6:
			if (iFlagApoyoAdicionalPF == 1)
			{
				//15750
				//Validar si el puente ya esta corriendo al momento de intentar levantar el modulo de pago de apoyo adicional
				if (numeroDeExes("PUENTETOCSHARP.EXE") == 1)
				{
					// Monstrar mensaje de que ya esta levantado una instancia del sistema    
					AfxMessageBox("LA OPCIÓN PAGO DE APOYO ADICIONAL YA ESTA ABIERTA");
				}
				else
				{
					//levantar el modulo de 
					llamarModuloPagoApoyoAdicional();
				}
			}
			else
			{
				memset(cMsgBloqueo, 0, sizeof(cMsgBloqueo));
				ConsultarCatalogoMensajeTienda(MSG_BLOQUEOPAGOAPOYOADICIONAL, cMsgBloqueo);
				sTexto.Format("%s", cMsgBloqueo);
				if (sTexto.Trim() != "")
				{
					AfxMessageBox(sTexto.Trim());
				}
			}
			break;

		case F7:
			llamarModuloMigracion();
			break;

		case F8:
			llamarModuloSegurosVida();
			break;

		case ESC:
			m_grid.GotoCell(0, 21);
			bSalir = false;
			break;

		default:
			break;
		}
	}
}

void CDlgCapturarAbono::ventaClubProteccion()
{
	char cLog[500] = { 0 };
	int iEdad = 0, iFlagBorra = 0, iFlag = -1, i = 0, k = 0, j = 0, iCont = 1;
	int fontID = m_grid.AddFont("Lucida Console Bold", 14, 200);
	iOpcionSeleccionada = 0;

	long lFolioSeguro = 0L;
	bool bContinuar = true;
	char cStatusSeguro = ' ', cTipoCan = ' ', cClaveNoOfrecer = ' ', cTexto[10] = { 0 }, cTexto2[10] = { 0 }, cMensajeSeguimiento[50] = { 0 };
	char cMensaje[80] = { 0 }, cEjecutable[80] = { 0 };
	CString sDato;

	sprintf_s(cLog, "FC0200805021521482 - entra - ventaClubProteccion");
	grabarLog(cLog);

	grabarLog("ventaClubProteccion: F1 Activar Club de Protección Familiar");

	if (iFlagNuevo != 1)
	{
		char cNombreProyecto[100] = { 0 }, cNombreFuncionDLL[10] = { 0 }, cInputParam1[1024] = { 0 }, cInputParam2[1024] = { 0 };
		SParametros parametros;
		memset(&parametros, 0, sizeof(SParametros));

		sprintf_s(cTexto, "%04d%02d", iAnioActual, iMesActual);
		sprintf_s(cTexto2, "%04d%02d", iAnioNacimiento, iMesNacimiento);
		iEdad = (valor_campo(cTexto, 6) - valor_campo(cTexto2, 6)) / 100L;

		if (iEdad >= iEdadMinimaClub && iEdad <= iEdadMaximaClub)
		{
			iOpcionSeleccionada = 1;
			if (iClub == 1)
			{
				sprintf_s(cMensajeSeguimiento, "Metodo TieneSeguroClub 7");
				grabarLog(cMensajeSeguimiento);
				bContinuar = tieneSeguroClub(cStatusSeguro, cTipoCan, cClaveNoOfrecer, lFolioSeguro, bCteSeguro);
			}
			else
			{
				sprintf_s(cMensajeSeguimiento, "Metodo TieneSeguroClubConyugal 6");
				grabarLog(cMensajeSeguimiento);
				bContinuar = tieneSeguroClubConyugal(cStatusSeguro, cTipoCan, cClaveNoOfrecer, lFolioSeguro);
			}
			if (iClub == 1)
			{
				switch (cStatusSeguro)
				{
				case 'A':case 'V':
					if (lFolioSeguro > 0L)
					{
						sprintf_s(cMensaje, "CLIENTE YA CUENTA CON CLUB DE PROTECCIÓN FAMILIAR NUM.FOLIO %06ld <ESC> SALIR", lFolioSeguro);
						AfxMessageBox(cMensaje);
					}
					break;
				default: //no tiene seguro club                                
					if (cClaveNoOfrecer == 'S')
					{
						if (AfxMessageBox("ESTE CLIENTE TIENE CLAVE DE NO OFRECER, ACTIVAR SEGURO CLUB DE PROTECCIÓN FAMILIAR,<Aceptar>", MB_YESNO | MB_ICONQUESTION) == IDYES)
						{
							iConyugal = 1;
							borrarSeguroClub(0);
							m_grid.iTotalCuentas++;
							iTotalCuentas++;
							CDlgCapturarDatosSeguro dlgCapturarDatosSeguro;

							m_grid.InsertCol(1);
							m_grid.RedrawAll();
							m_grid.SetColWidth(1, 83);
							m_grid.QuickSetFont(1, -1, fontID);
							m_grid.GetCell(1, 11, &m_cell);
							m_cell.SetBackColor(RGB(236, 233, 216));
							m_grid.SetCell(1, 11, &m_cell);
							m_grid.RedrawCell(1, 11);
							m_grid.GetCell(1, 17, &m_cell);
							m_cell.SetBackColor(RGB(236, 233, 216));
							m_grid.SetCell(1, 17, &m_cell);
							m_grid.RedrawCell(1, 17);
							m_grid.GetCell(1, 20, &m_cell);
							m_cell.SetBackColor(RGB(236, 233, 216));
							m_grid.SetCell(1, 20, &m_cell);
							m_grid.RedrawCell(1, 20);

							for (i = 0; i < 35; i++)
							{
								m_grid.QuickSetAlignment(1, i, UG_ALIGNLEFT);
							}

							m_grid.SetRowHeight(11, 3);
							m_grid.SetRowHeight(17, 3);
							m_grid.SetRowHeight(20, 3);

							m_grid.RedrawCol(1);

							desplegarPaginaSeguros(0, 0, 1, dlgCapturarDatosSeguro, 1);

							iClub = 3;
							iRespuestaPoliza = dlgCapturarDatosSeguro.iRespuesta;
						}
						iFlagBorra = 1;
						break;
					}
					if ((cStatusSeguro == '0' && iFlagBanorte >= 2) || bContinuar == false)
					{
						AfxMessageBox("EL CLIENTE NO ESTA AFILIADO AL CLUB PROTECCION FAMILIAR,<ESC> SALIR");
						break;
					}
					//cliente tiene seguro cancelado
					if (cStatusSeguro == 'C')
					{
						if (AfxMessageBox("ESTE CLIENTE TIENE CLAVE DE CANCELADO, ACTIVAR SEGURO CLUB DE PROTECCIÓN FAMILIAR < Aceptar >", MB_YESNO | MB_ICONQUESTION) == IDYES)
						{
							iConyugal = 1;
							borrarSeguroClubCancelado(0);
							m_grid.iTotalCuentas++;
							iTotalCuentas++;
							CDlgCapturarDatosSeguro dlgCapturarDatosSeguro;

							m_grid.InsertCol(1);
							m_grid.RedrawAll();
							m_grid.SetColWidth(1, 83);
							m_grid.QuickSetFont(1, -1, fontID);
							m_grid.GetCell(1, 11, &m_cell);
							m_cell.SetBackColor(RGB(236, 233, 216));
							m_grid.SetCell(1, 11, &m_cell);
							m_grid.RedrawCell(1, 11);
							m_grid.GetCell(1, 17, &m_cell);
							m_cell.SetBackColor(RGB(236, 233, 216));
							m_grid.SetCell(1, 17, &m_cell);
							m_grid.RedrawCell(1, 17);
							m_grid.GetCell(1, 20, &m_cell);
							m_cell.SetBackColor(RGB(236, 233, 216));
							m_grid.SetCell(1, 20, &m_cell);
							m_grid.RedrawCell(1, 20);

							for (i = 0; i < 35; i++)
							{
								m_grid.QuickSetAlignment(1, i, UG_ALIGNLEFT);
							}

							m_grid.SetRowHeight(11, 3);
							m_grid.SetRowHeight(17, 3);
							m_grid.SetRowHeight(20, 3);

							m_grid.RedrawCol(1);

							desplegarPaginaSeguros(0, 0, 1, dlgCapturarDatosSeguro, 1);
							iClub = 3;
							bBanderaTieneClub = false;
							iRespuestaPoliza = dlgCapturarDatosSeguro.iRespuesta;
						}
						iFlagBorra = 1;
						break;
					}
					else if (cStatusSeguro == 'P')//Pendiente
					{
						AfxMessageBox(cMensajeSeguro);
						break;
					}
					else if (cStatusSeguro != '0')
					{
						if (cClaveNoOfrecer == 'S')
						{
							AfxMessageBox("ESTE CLIENTE TIENE CLAVE DE NO OFRECER  REACTIVAR SEGURO CLUB DE PROTECCIÓN FAMILIAR ");
							break;
						}
						else
						{
							nombreArchivo("VTACLUB.DAT", cEjecutable, DIRECTORIO_MEM);
							if (_access(cEjecutable, 0) == 0)
							{
								_unlink(cEjecutable);
							}

							memset(&parametros, 0, sizeof(SParametros));

							parametros.iLink = generarLink();
							sprintf_s(parametros.sServer, "%s", (LPCTSTR)m_grid.sServer);
							parametros.iTienda = m_grid.iTienda;
							parametros.lEmpleado = m_grid.lEmpleado;
							parametros.iCajaActual = m_grid.iCaja;
							parametros.iMuestraMsg = m_grid.iMuestraMsg;

							parametros.iNumSistema = SISTEMA_CAJAS; //SISTEMA_CAJAS ó SISTEMA_CLIENTESNUEVOS
							parametros.lCliente = m_grid.lCliente; //Número de cliente al que se le va a vender seguro club
							parametros.iFlagGeneral = 1;
							memcpy(cInputParam1, &parametros, sizeof(SParametros));
							// Ruta del archivo DLL a ejecutar
							nombreArchivo("CN0024.DLL", cNombreProyecto, DIRECTORIO_CN);
							// Nombre de la función principal en el DLL
							sprintf_s(cNombreFuncionDLL, "CN0024");
							CargarDLL cargarDll(cNombreProyecto, cNombreFuncionDLL, cInputParam1, cInputParam2);
							iRegresaDll = cargarDll.getResultado();
							if (iRegresaDll > 0)
							{
								iFlagNuevo = 1; //se hizo venta de seguro club. 
								lNumeroConexion = iFlag; //numero de conexion para formar el nombre de la tabla temporal tmpCaVentaSeguroClub%d %d=iNumeroConexion 
								obtenerDatosTablaTmpParaGrid();
							}
							if (iRegresaDll <= 0)
							{
								AfxMessageBox(" Error al cargar el programa CN0024.DLL ");
							}
							break;
						}
					}
					break;
				}

			}
			if (iClub == 2)
			{
				switch (cStatusSeguro)
				{
				case 'A':
					if (lFolioSeguro > 0L)
					{
						sprintf_s(cMensaje, "CLIENTE YA CUENTA CON CLUB CONYUGAL NUM.FOLIO %06ld <ESC> SALIR", lFolioSeguro);
						AfxMessageBox(cMensaje);
					}
					break;
				default: //no tiene seguro club                                                                
					if (cClaveNoOfrecer == 'S')
					{
						if (AfxMessageBox("ESTE CLIENTE TIENE CLAVE DE NO OFRECER,ACTIVAR SEGURO CLUB DE PROTECCIÓN FAMILIAR, <Aceptar>", MB_YESNO | MB_ICONQUESTION) == IDYES)
						{
							borrarSeguroClub(1);
							m_grid.iTotalCuentas++;
							iTotalCuentas++;
							CDlgCapturarDatosSeguro dlgCapturarDatosSeguro;
							desplegarPaginaSeguros(0, 0, 1, dlgCapturarDatosSeguro, 1);
							iClub = 3;
							iRespuestaPoliza = dlgCapturarDatosSeguro.iRespuesta;
						}
						iFlagBorra = 1;
						break;
					}
					if ((cStatusSeguro == '0' && iFlagBanorte >= 2) || bContinuar == false)
					{
						AfxMessageBox("EL CLIENTE NO ESTA AFILIADO AL CLUB PROTECCION CONYUGAL COPPEL,<ESC> SALIR");
						break;
					}
					if (cStatusSeguro == 'C')
					{
						if (AfxMessageBox("ESTE CLIENTE TIENE CLAVE DE CANCELADO, ACTIVAR SEGURO CLUB DE PROTECCIÓN FAMILIAR < Aceptar >", MB_YESNO | MB_ICONQUESTION) == IDYES)
						{
							borrarSeguroClubCancelado(1);
							m_grid.iTotalCuentas++;
							iTotalCuentas++;
							CDlgCapturarDatosSeguro dlgCapturarDatosSeguro;
							desplegarPaginaSeguros(0, 0, 1, dlgCapturarDatosSeguro, 1);
							iClub = 3;
							bBanderaTieneClub = false;
							iRespuestaPoliza = dlgCapturarDatosSeguro.iRespuesta;
						}
						iFlagBorra = 1;
						break;
					}
					if (cStatusSeguro != '0')
					{
						if (cClaveNoOfrecer == 'S')
						{
							AfxMessageBox("ESTE CLIENTE TIENE CLAVE DE NO OFRECER REACTIVAR SEGURO CLUB DE PROTECCIÓN FAMILIAR");
							break;
						}
						else
						{
							nombreArchivo("VTACLUB.DAT", cEjecutable, DIRECTORIO_MEM);
							if (_access(cEjecutable, 0) == 0)
							{
								_unlink(cEjecutable);
							}

							memset(&parametros, 0, sizeof(SParametros));
							memset(cNombreProyecto, 0, sizeof(cNombreProyecto));
							memset(cNombreFuncionDLL, 0, sizeof(cNombreFuncionDLL));
							memset(cInputParam1, 0, sizeof(cInputParam1));
							memset(cInputParam2, 0, sizeof(cInputParam2));

							parametros.iLink = generarLink();
							sprintf_s(parametros.sServer, "%s", (LPCTSTR)m_grid.sServer);
							parametros.iTienda = m_grid.iTienda;
							parametros.lEmpleado = m_grid.lEmpleado;
							parametros.iCajaActual = m_grid.iCaja;
							parametros.iMuestraMsg = m_grid.iMuestraMsg;

							parametros.iNumSistema = SISTEMA_CAJAS; //SISTEMA_CAJAS ó SISTEMA_CLIENTESNUEVOS
							parametros.lCliente = m_grid.lCliente; //Número de cliente al que se le va a vender seguro club
							parametros.iFlagGeneral = 1;
							memcpy(cInputParam1, &parametros, sizeof(SParametros));
							// Ruta del archivo DLL a ejecutar
							nombreArchivo("CN0024.DLL", cNombreProyecto, DIRECTORIO_CN);
							// Nombre de la función principal en el DLL
							sprintf_s(cNombreFuncionDLL, "CN0024");
							CargarDLL cargarDll(cNombreProyecto, cNombreFuncionDLL, cInputParam1, cInputParam2);
							iRegresaDll = cargarDll.getResultado();
							if (iRegresaDll > 0)
							{
								iFlagNuevo = 1; //se hizo venta de seguro club. 
								lNumeroConexion = iFlag; //numero de conexion para formar el nombre de la tabla temporal tmpCaVentaSeguroClub%d %d=iNumeroConexion 
								obtenerDatosTablaTmpParaGrid();
							}
							if (iRegresaDll <= 0)
							{
								AfxMessageBox(" Error al cargar el programa CN0024.DLL ");
							}
							break;
						}
					}
					break;
				}

			}
		}
		else
		{
			sprintf_s(cMensaje, "CLIENTE CON EDAD MENOR A %d AÑOS 0 MAYOR A %d AÑOS", iEdadMinimaClub, iEdadMaximaClub);
			AfxMessageBox(cMensaje);
		}
	}
	sprintf_s(cLog, "FC0200805021521486 - entra - ventaClubProteccion");
	grabarLog(cLog);
}

bool CDlgCapturarAbono::tieneSeguroClub(char &cStatusSeguro, char &cTipoCan, char &cClaveNoOfrecer, long &lFolioSeguro, bool &bCteSeguro)
{
	CString sFechaVenc, sFechaActual;
	bool bContinuar = false, bMostrarSeguro = true;
	char cClaveSeguro = ' ', cSql[500] = { 0 }, cMensaje[100] = { 0 };
	int iFlagNoOfrecer = 0; //SE AGREGA VARIABLE PARA PET 15922 SE SUBE VARIABLE cSql a 500

	obtenerFlag('C', FLAGC_NOOFRECERCLUB, iFlagNoOfrecer);

	if (iFlagNoOfrecer == 1) {

		sprintf_s(cSql, "SELECT cr.claveseguro, cr.statusseguro, cr.folio, cr.tipocancelacion, cast( (CASE WHEN (SELECT count(1) FROM mae_crcomplementoclientes WHERE num_cliente = %ld and opc_complemento = 5) = 0 "
			"THEN '' ELSE 'S' END ) as character) as clavenoofrecer, cr.fechavencimiento FROM crseguros cr WHERE cliente = %ld and claveseguro='C' AND tiposeguro IN (0,1) ORDER BY fechavencimiento", m_grid.lCliente, m_grid.lCliente);

	}
	else {

		sprintf_s(cSql, "SELECT claveseguro, statusseguro, folio, tipocancelacion, clavenoofrecer, fechavencimiento FROM crseguros WHERE claveseguro = 'C'"
			"and cliente = %ld and tiposeguro in (0,1) ORDER BY fechavencimiento", m_grid.lCliente);
	}

	CConsultarCrSegurosClub crSegurosSQL(&odbc_1);
	if (crSegurosSQL.Exec(cSql))
	{
		crSegurosSQL.activarCols();
		while (crSegurosSQL.Leer() && bMostrarSeguro)
		{
			lFolioSeguro = crSegurosSQL.folio;
			sprintf_s(cMensaje, "Obtiene folio de la tabla crseguros Folio %ld", lFolioSeguro);
			grabarLog(cMensaje);
			cClaveSeguro = crSegurosSQL.claveseguro[0];
			cStatusSeguro = crSegurosSQL.statusseguro[0];
			cTipoCan = crSegurosSQL.tipocancelacion[0];
			cClaveNoOfrecer = crSegurosSQL.clavenoofrecer[0];
			sFechaVenc.Format("%04d%02d%02d", crSegurosSQL.fechavencimiento.ano(), crSegurosSQL.fechavencimiento.mes(), crSegurosSQL.fechavencimiento.dia());
			bContinuar = true;
			switch (iOpcionSeleccionada)
			{
			case 1:
				if (cStatusSeguro == 'A' || cStatusSeguro == 'V')
					bMostrarSeguro = false;
				break;

			case 2:
				{
					if (cStatusSeguro == 'V' || cStatusSeguro == 'A')
					{
						if (cStatusSeguro == 'A')
						{
							sFechaActual.Format("%04d%02d%02d", iAnioActual, iMesActual, iDiaActual);
							sFechaVenc.Format("%04d%02d%02d", crSegurosSQL.fechavencimiento.ano(), crSegurosSQL.fechavencimiento.mes(), crSegurosSQL.fechavencimiento.dia());

							if (atol(sFechaVenc) < atol(sFechaActual))
							{
								bCteSeguro = true;
								bMostrarSeguro = false;
								cStatusSeguro = 'V';
							}
							else
							{
								bCteSeguro = false;
							}
						}
						else
						{
							bCteSeguro = true;
							bMostrarSeguro = false;
						}
					}
				}
				break;
			case 4:
				{
					if (cStatusSeguro == 'V' || cStatusSeguro == 'A')
					{
						bCteSeguro = true;
						bMostrarSeguro = false;
						/*if( cStatusSeguro == 'A' )
						{
						sFechaActual.Format("%04d%02d%02d",iAnioActual ,iMesActual,iDiaActual);
						sFechaVenc.Format("%04d%02d%02d",crSegurosSQL.fechavencimiento.ano(),crSegurosSQL.fechavencimiento.mes(), crSegurosSQL.fechavencimiento.dia());

						if( atol(sFechaVenc) < atol(sFechaActual) )
						{
						bCteSeguro = true;
						bMostrarSeguro= false;
						}
						else
						{
						bCteSeguro = false;
						}
						}
						else
						{
						bCteSeguro = true;
						bMostrarSeguro= false;
						}*/
					}
				}
				break;
			default:break;
			}
		}
	}
	else
	{
		crSegurosSQL.odbc->GetLastError(crSegurosSQL.GetHstmt());
		grabarMensajeError("C", m_grid.iCaja, (LPTSTR)(LPCTSTR)m_grid.sServer, "CapturarAbono", "CDlgCapturarAbono", "tieneSeguroClub", cSql, m_grid.lEmpleado, "ERROR EN LA CONSULTA(tieneseguroclub)", crSegurosSQL.odbc, m_grid.iMuestraMsg);
		bContinuar = false;
	}
	return bContinuar;
}

void CDlgCapturarAbono::borrarSeguroClub(int iClave)
{
	char cSql[170] = { 0 };

	sprintf_s(cSql, "DELETE FROM crseguros WHERE cliente = %ld and claveseguro='C' and clavenoofrecer='S' and (claveconyugal=%d or (claveconyugal=1 and tiposeguro in (1,2)))", m_grid.lCliente, iClave);

	CMaximo deleteCrSeguros(&odbc_1);

	if (!deleteCrSeguros.Exec(cSql))
	{
		deleteCrSeguros.odbc->GetLastError(deleteCrSeguros.GetHstmt());
		grabarMensajeError("C", m_grid.iCaja, (LPTSTR)(LPCTSTR)m_grid.sServer, "CapturarAbono", "CDlgCapturarAbono", "borrarSeguroClub", cSql, m_grid.lEmpleado, "ERROR EN LA CONSULTA(borrarseguroclub)", deleteCrSeguros.odbc, m_grid.iMuestraMsg);
	}
}

void CDlgCapturarAbono::borrarSeguroClubCancelado(int iClave)
{
	char cSql[170] = { 0 };

	sprintf_s(cSql, "DELETE FROM crseguros WHERE cliente = %ld and claveseguro='C' and clavenoofrecer=' ' and (claveconyugal=%d or (claveconyugal=1 and tiposeguro in (1,2)))", m_grid.lCliente, iClave);

	CMaximo deleteCrSeguros(&odbc_1);

	if (!deleteCrSeguros.Exec(cSql))
	{
		deleteCrSeguros.odbc->GetLastError(deleteCrSeguros.GetHstmt());
		grabarMensajeError("C", m_grid.iCaja, (LPTSTR)(LPCTSTR)m_grid.sServer, "CapturarAbono", "CDlgCapturarAbono", "borrarSeguroClubCancelado", cSql, m_grid.lEmpleado, "ERROR EN LA CONSULTA(borrarseguroclubcancelado)", deleteCrSeguros.odbc, m_grid.iMuestraMsg);
	}
}

void CDlgCapturarAbono::clubBeneficiarios()
{
	char cLog[500] = { 0 };
	bool bContinuar = false;
	int  i = 0, iFlag = 0;
	long lFolioSeguro = 0L;
	char cStatusSeguro = 0, cTipoCan = 0, cClaveNoOfrecer = 0, cConcepto[20] = { 0 }, cTexto[20] = { 0 };
	CString sTexto, sLinkB, sIpB, sTiendaB, sEmpleadoB, sCajaB, sMuestraMsgB, sClienteB, sFolioB, sNumSegB, sNumMesesB, sPagoB, sBandera;

	sprintf_s(cLog, "FC0200805021521499 - entra - clubBeneficiarios");
	grabarLog(cLog);

	iEdad = 0;
	iOpcionSeleccionada = 2;
	grabarLog("clubBeneficiarios: F2   Beneficiarios");
	switch (iClub)
	{
	case 1:
		grabarLog("Metodo TieneSeguroClub 8");
		bContinuar = tieneSeguroClub(cStatusSeguro, cTipoCan, cClaveNoOfrecer, lFolioSeguro, bCteSeguro);
		if (!bContinuar)
		{
			AfxMessageBox("EL CLIENTE NO CUENTA CON CLUB DE PROTECCION FAMILIAR");
		}
		break;
	case 2:
		iEdad = (short)iAnioActual - iAnioNacimiento;
		if (iEdad >= 18 && iEdad <= 65)
		{
			grabarLog("Metodo TieneSeguroClubConyugal 7");
			bContinuar = tieneSeguroClubConyugal(cStatusSeguro, cTipoCan, cClaveNoOfrecer, lFolioSeguro);
			if (!bContinuar)
			{
				AfxMessageBox("EL CLIENTE NO CUENTA CON CLUB DE PROTECCION CONYUGAL COPPEL");
			}
		}
		else
		{
			AfxMessageBox("CLIENTE MENOR A 18 AÑOS O MAYOR A 65 AÑOS");
		}
		break;
	case 3:
		if (iFlagTieneSeguroAdicional == 0)
		{
			AfxMessageBox("EL CLIENTE NO CUENTA CON CLUB ADICIONAL");
			bContinuar = false;
		}
		else
		{
			grabarLog("Metodo TieneSeguroClub 9");
			bContinuar = tieneSeguroClub(cStatusSeguro, cTipoCan, cClaveNoOfrecer, lFolioSeguro, bCteSeguro);
		}
		break;
	default:
		break;
	}

	if (bContinuar)
	{
		switch (cStatusSeguro)
		{
		case 'V':
			AfxMessageBox("CLIENTE TIENE SU CLUB DE PROTECCIÓN FAMILIAR VENCIDO");
			break;
		case 'C':
			AfxMessageBox("CLIENTE TIENE SU CLUB DE PROTECCIÓN FAMILIAR CANCELADO. ACTIVAR EN OPCIÓN F1 DEL MENU CLUB DE PROTECCIÓN FAMILIAR");
			break;
		case 'P'://Pendiente
			AfxMessageBox(cMensajeSeguro);
			break;
		case ' ':
			AfxMessageBox("CLIENTE NO TIENE SEGURO CLUB DE PROTECCIÓN FAMILIAR");
			break;
		default:
			if (cClaveNoOfrecer == 'S')
			{
				AfxMessageBox("CLIENTE MARCADO COMO NO OFRECER. ACTIVAR EN OPCIÓN F1 DEL MENU DE CLUB DE PROTECCIÓN FAMILIAR");
			}
			else
			{
				char cNombreProyecto[100] = { 0 }, cNombreFuncionDLL[10] = { 0 }, cInputParam1[1024] = { 0 }, cInputParam2[1024] = { 0 }, cOutputParam1[1024] = { 0 }, cOutputParam2[1024] = { 0 };
				SParametros parametros;
				memset(&parametros, 0, sizeof(SParametros));

				if (iClub == 1)
				{
					CDlgCapturarDatosSeguro datosSeguro;

					datosSeguro.iCiudad = iCiudadGnDominio;
					datosSeguro.iTienda = m_grid.iTienda;
					iFlag = datosSeguro.checarHuellaChw(m_grid.lCliente, m_grid.iCaja, m_grid.lEmpleado, m_grid.iMuestraMsg);

					if (iFlag > 0)
					{
						//9923 -->generar nuevo folio al cambiar de benficiarios
						for (i = 0; i < iTotalCuentas; i++)
						{
							m_grid.QuickGetText(i, -1, &sTexto);
							sTexto.Trim();
							sprintf_s(cConcepto, "%s", (LPCTSTR)sTexto);
							if (memcmp(cConcepto, "P.FAMILIAR", 10) == 0)
							{
								m_grid.QuickGetText(i, 1, &sFolioB);
								sFolioB.Trim();
								m_grid.QuickGetText(i, 21, &sPagoB);
								sPagoB.Trim();
								m_grid.QuickGetText(i, 22, &sNumSegB);
								sNumSegB.Trim();
								m_grid.QuickGetText(i, 23, &sNumMesesB);
								sNumMesesB.Trim();
								break;
							}
						}
						sLinkB.Format("%d", generarLink());
						sIpB = m_grid.sServer;
						sTiendaB.Format("%d", m_grid.iTienda);
						sEmpleadoB.Format("%ld", m_grid.lEmpleado);
						sCajaB.Format("%d", m_grid.iCaja);
						sMuestraMsgB.Format("%d", m_grid.iMuestraMsg);
						sClienteB.Format("%ld", m_grid.lCliente);
						sBandera.Format("1");

						memset(&parametros, 0, sizeof(SParametros));

						parametros.iLink = generarLink();
						sprintf_s(parametros.sServer, "%s", (LPCTSTR)m_grid.sServer);
						parametros.iTienda = m_grid.iTienda;
						parametros.lEmpleado = m_grid.lEmpleado;
						parametros.iCajaActual = m_grid.iCaja;
						parametros.iMuestraMsg = m_grid.iMuestraMsg;


						parametros.lCliente = m_grid.lCliente;
						parametros.lFolioSeguro = atol(sFolioB);     // Folio
						parametros.iSensor = atoi(sNumSegB);    // Numero de Seguros
						parametros.iTipoServicio = atoi(sNumMesesB);     // Numero de Meses
						parametros.lCantidad = atol(sPagoB); // Su Pago    
						parametros.iFlagGeneral = 1;      // Bandera=1 Graba en todas las Tablas menos en la Tabla TemptdBeneficiarios
						// Bandera=0 Graba nada mas en la Tabla Temporal TemptdBeneficiarios
						parametros.iTiendaFactura = 2;

						/*
						sTexto.Format("que sera:  %d",parametros.iTiendaFactura);
						AfxMessageBox(sTexto); */
						//AfxMessageBox("Entro Por estos Lados 8");
						sprintf_s(cMensaje, "clubBeneficiarios: Se envian datos al modulo CA0071.DLL Folio %ld, iFlagGeneral = %d", parametros.lFolioSeguro, parametros.iFlagGeneral);
						grabarLog(cMensaje);
						memcpy(cInputParam1, &parametros, sizeof(SParametros));
						// Ruta del archivo DLL a ejecutar
						nombreArchivo("CA0071.DLL", cNombreProyecto, DIRECTORIO_CA);
						// Nombre de la función principal en el DLL
						sprintf_s(cNombreFuncionDLL, "CA0071");
						CargarDLL cargarDll(cNombreProyecto, cNombreFuncionDLL, cInputParam1, cInputParam2, cOutputParam1, cOutputParam2);
						iRegresaDll = cargarDll.getResultado();
						if (iRegresaDll <= 0)
						{
							AfxMessageBox("Ocurrio un error al llamado del modulo CA0071.DLL", MB_ICONERROR);
						}
						else
						{
							if (atoi(cOutputParam1))
							{
								long lFolioAux = 0l;
								iFlagCapturoBeneficiariosClubNuevo = 2;
								//9923 --> Grabar movimientos para captura de benficiarios y cambio de poliza
								grabarLog("Metodo TieneSeguroClub 10");
								bContinuar = tieneSeguroClub(cStatusSeguro, cTipoCan, cClaveNoOfrecer, lFolioAux, bCteSeguro);
								if (lFolioAux != lFolioSeguro)
								{
									sTexto.Format("%ld", lFolioAux);
									m_grid.QuickSetText(iColumnaClub, 1, sTexto);
									m_grid.QuickSetAlignment(iColumnaClub, 1, UG_ALIGNRIGHT);
									iFoliosSegurosActual[0] = lFolioAux;
								}
							}
						}
					}
					iRespuestaPoliza = datosSeguro.iRespuesta;
				}
				if (iClub == 2)
				{
					CDlgCapturarDatosSeguro datosSeguro;

					datosSeguro.iCiudad = iCiudadGnDominio;
					datosSeguro.iTienda = m_grid.iTienda;
					iFlag = datosSeguro.checarHuellaChw(m_grid.lCliente, m_grid.iCaja, m_grid.lEmpleado, m_grid.iMuestraMsg);
					if (iFlag > 0)
					{
						for (i = 0; i < iTotalCuentas; i++)
						{
							m_grid.QuickGetText(i, -1, &sTexto);
							sTexto.Trim();
							sprintf_s(cConcepto, "%s", sTexto);
							if (memcmp(cConcepto, "P.FAMILIAR", 10) == 0)
							{
								m_grid.QuickGetText(i, 1, &sFolioB);
								sFolioB.Trim();
								m_grid.QuickGetText(i, 21, &sPagoB);
								sPagoB.Trim();
								m_grid.QuickGetText(i, 22, &sNumSegB);
								sNumSegB.Trim();
								m_grid.QuickGetText(i, 23, &sNumMesesB);
								sNumMesesB.Trim();
								break;
							}
						}
						sLinkB.Format("%d", generarLink());
						sIpB = m_grid.sServer;
						sTiendaB.Format("%d", m_grid.iTienda);
						sEmpleadoB.Format("%ld", m_grid.lEmpleado);
						sCajaB.Format("%d", m_grid.iCaja);
						sMuestraMsgB.Format("%d", m_grid.iMuestraMsg);
						sClienteB.Format("%ld", m_grid.lCliente);
						sBandera.Format("1");

						memset(&parametros, 0, sizeof(SParametros));
						memset(cNombreProyecto, 0, sizeof(cNombreProyecto));
						memset(cNombreFuncionDLL, 0, sizeof(cNombreFuncionDLL));
						memset(cInputParam1, 0, sizeof(cInputParam1));
						memset(cInputParam2, 0, sizeof(cInputParam2));
						memset(cOutputParam1, 0, sizeof(cOutputParam1));
						memset(cOutputParam2, 0, sizeof(cOutputParam2));

						parametros.iLink = generarLink();
						sprintf_s(parametros.sServer, "%s", (LPCTSTR)m_grid.sServer);
						parametros.iTienda = m_grid.iTienda;
						parametros.lEmpleado = m_grid.lEmpleado;
						parametros.iCajaActual = m_grid.iCaja;
						parametros.iMuestraMsg = m_grid.iMuestraMsg;

						parametros.lCliente = m_grid.lCliente;
						parametros.lFolioSeguro = atol(sFolioB);     // Folio
						parametros.iSensor = atoi(sNumSegB);    // Numero de Seguros
						parametros.iTipoServicio = atoi(sNumMesesB);     // Numero de Meses
						parametros.lCantidad = atol(sPagoB); // Su Pago    
						parametros.iFlagGeneral = 1;      // Bandera=1 Graba en todas las Tablas menos en la Tabla TemptdBeneficiarios
						// Bandera=0 Graba nada mas en la Tabla Temporal TemptdBeneficiarios
						sprintf_s(cMensaje, "clubBeneficiarios: Se envian datos al modulo CA0108.DLL Folio %ld, iFlagGeneral = %d", parametros.lFolioSeguro, parametros.iFlagGeneral);
						grabarLog(cMensaje);
						memcpy(cInputParam1, &parametros, sizeof(SParametros));
						// Ruta del archivo DLL a ejecutar
						nombreArchivo("CA0108.DLL", cNombreProyecto, DIRECTORIO_CA);
						// Nombre de la función principal en el DLL
						sprintf_s(cNombreFuncionDLL, "CA0108");
						CargarDLL cargarDll(cNombreProyecto, cNombreFuncionDLL, cInputParam1, cInputParam2, cOutputParam1, cOutputParam2);
						iRegresaDll = cargarDll.getResultado();
						if (iRegresaDll <= 0)
						{
							AfxMessageBox("Ocurrio un error al llamado del modulo CA0108.DLL", MB_ICONERROR);
						}
						else
						{
							if (atoi(cOutputParam1))
							{
								iFlagCapturoBeneficiariosClubNuevo = 2;
							}
						}
					}
					iRespuestaPoliza = datosSeguro.iRespuesta;
				}

				if (iClub == 3)
				{
					CDlgCapturarDatosSeguro datosSeguro;
					datosSeguro.iTienda = m_grid.iTienda;
					datosSeguro.iCiudad = iCiudadGnDominio;
					iFlag = datosSeguro.checarHuellaChw(m_grid.lCliente, m_grid.iCaja, m_grid.lEmpleado, m_grid.iMuestraMsg);

					if (iFlag > 0)
					{
						EstructuraCliente parametrosAdicional;
						memset(&parametrosAdicional, 0, sizeof(EstructuraCliente));

						for (i = 0; i < iTotalCuentas; i++)
						{
							m_grid.QuickGetText(i, -1, &sTexto);
							sTexto.Trim();
							sprintf_s(cConcepto, "%s", (LPCTSTR)sTexto);
							if (memcmp(cConcepto, "P.FAMILIAR", 10) == 0)
							{
								m_grid.QuickGetText(i, 25, &sTexto);
								sTexto.Trim();
								sprintf_s(cTexto, "%s", (LPCTSTR)sTexto);

								m_grid.QuickGetText(i, 1, &sTexto);
								lFolioSeguro = atol(sTexto);
								break;
							}
						}

						memset(&parametros, 0, sizeof(SParametros));
						memset(cNombreProyecto, 0, sizeof(cNombreProyecto));
						memset(cNombreFuncionDLL, 0, sizeof(cNombreFuncionDLL));
						memset(cInputParam1, 0, sizeof(cInputParam1));
						memset(cInputParam2, 0, sizeof(cInputParam2));
						memset(cOutputParam1, 0, sizeof(cOutputParam1));
						memset(cOutputParam2, 0, sizeof(cOutputParam2));

						parametros.iLink = generarLink();
						sprintf_s(parametros.sServer, "%s", (LPCTSTR)m_grid.sServer);
						parametros.iTienda = m_grid.iTienda;
						parametros.lEmpleado = m_grid.lEmpleado;
						parametros.iCajaActual = m_grid.iCaja;
						parametros.iMuestraMsg = m_grid.iMuestraMsg;
						parametros.iNumSistema = SISTEMA_CAJAS;
						parametros.lCliente = m_grid.lCliente;
						parametros.iCiudad = iCiudad;
						parametros.iFlagGeneral = iSegurosAdicionales;

						parametrosAdicional.lFolio = lFolioSeguro;
						parametrosAdicional.iAnioNac = iAnioNacimiento;
						parametrosAdicional.iDiaNac = iDiaNacimiento;
						parametrosAdicional.iMesNac = iMesNacimiento;
						parametrosAdicional.iFlagCapturaAbonos = 1; //Para saber que se llamo desde el modulo capturarabono
						parametrosAdicional.iVentaSeguroClub = 0; //Para saber que es modificacion de beneficiarios
						parametrosAdicional.iCantidadMeses = 0;
						parametrosAdicional.iAnioVenc = valor_campo(&cTexto[4], 4);
						parametrosAdicional.iMesVenc = valor_campo(&cTexto[2], 2);
						parametrosAdicional.iDiaVenc = valor_campo(&cTexto[0], 2);
						parametrosAdicional.iMovimientoImpresion = 2;
						sprintf_s(parametrosAdicional.cNombreCompleto, "%s %s %s", sNombreCliente, sApellidoPaterno, sApellidoMaterno);
						sprintf_s(parametrosAdicional.cSexo, "%s", cSexoCliente);

						memcpy(cInputParam1, &parametros, sizeof(SParametros));
						memcpy(cInputParam2, &parametrosAdicional, sizeof(EstructuraCliente));

						// Ruta del archivo DLL a ejecutar
						sprintf_s(cMensaje, "clubBeneficiarios: Se envian datos al modulo CA0149.DLL Folio %ld, iFlagGeneral = %d, iFlagCapturaAbonos = %d", parametrosAdicional.lFolio, parametros.iFlagGeneral, parametrosAdicional.iFlagCapturaAbonos);
						grabarLog(cMensaje);
						nombreArchivo("CA0149.DLL", cNombreProyecto, DIRECTORIO_CA);
						// Nombre de la función principal en el DLL
						sprintf_s(cNombreFuncionDLL, "CA0149");
						CargarDLL cargarDll(cNombreProyecto, cNombreFuncionDLL, cInputParam1, cInputParam2, cOutputParam1, cOutputParam2);
						iRegresaDll = cargarDll.getResultado();
						if (iRegresaDll <= 0)
						{
							AfxMessageBox("Ocurrio un error al llamado del modulo CA0149.DLL", MB_ICONERROR);
						}
						else
						{
							borrarTemporalesSeguroAdicional(true);
							grabarTmpCacarMovSeguros();
						}
					}
				}
			}
			break;
		}
	}
}

void CDlgCapturarAbono::clubDocumentacion()
{
	char cLog[500] = { 0 };
	long lFolioSeguro = 0L;
	bool bContinuar = true;
	char cStatusSeguro = ' ', cTipoCan = ' ', cClaveNoOfrecer = ' ', cDirectorio[50] = { 0 }, cMensajeSeguimiento[50] = { 0 };

	sprintf_s(cLog, "FC0200805021521505 - entra - clubDocumentacion");
	grabarLog(cLog);

	if (iClub == 1)
	{
		sprintf_s(cMensajeSeguimiento, "Metodo TieneSeguroClub 11");
		grabarLog(cMensajeSeguimiento);
		bContinuar = tieneSeguroClub(cStatusSeguro, cTipoCan, cClaveNoOfrecer, lFolioSeguro, bCteSeguro);
	}
	else
	{
		sprintf_s(cMensajeSeguimiento, "Metodo TieneSeguroClubConyugal 8");
		grabarLog(cMensajeSeguimiento);
		bContinuar = tieneSeguroClubConyugal(cStatusSeguro, cTipoCan, cClaveNoOfrecer, lFolioSeguro);
	}
	//  no tiene seguro club   tiene clave de no ofrecer    tiene seguro cancelado
	if (bContinuar == false || cClaveNoOfrecer == 'S' || cStatusSeguro == 'C')
	{
		if (iClub == 1)
		{
			AfxMessageBox("EL CLIENTE NO ESTA AFILIADO A CLUB DE PROTECCIÓN FAMILIAR");
		}
		if (iClub == 2)
		{
			AfxMessageBox("EL CLIENTE NO ESTA AFILIADO AL CLUB DE PROTECCION CONYUGAL");
		}
	}
	else if (cStatusSeguro == 'P')
	{
		AfxMessageBox(cMensajeSeguro);
	}
	else
	{
		if (iClub == 1)
		{
			if (AfxMessageBox("¿ IMPRIMIR DOCUMENTACION DEL CLUB DE PROTECCION FAMILIAR (SI/NO) ?", MB_YESNO | MB_ICONQUESTION) == IDYES)
			{
				nombreArchivo("CADOCPRO.TXT", cDirectorio, DIRECTORIO_MEM);
				if (_access(cDirectorio, 0) == 0)
				{
					_unlink(cDirectorio);
				}
				//Activar

				C_FormasPCL hoja(22, 270, cDirectorio, iFinLinea, iTipoImpresora, 1);
				if (imprimirClausulaClub(hoja, iConyugal, iRespuestaPoliza))
				{
					impresionArchivo.imprimirArchivo(cDirectorio);
					AfxMessageBox("EL REPORTE SE IMPRIMIO CORRECTAMENTE");
				}
			}
			else
			{
				iClub = 0;
			}
		}
		else
		{
			if (AfxMessageBox("¿ IMPRIMIR DOCUMENTACION DEL CLUB DE PROTECC.CONYUGAL COPPEL (SI/NO) ?", MB_YESNO | MB_ICONQUESTION) == IDYES)
			{
				nombreArchivo("CADOCPRO.TXT", cDirectorio, DIRECTORIO_MEM);
				if (_access(cDirectorio, 0) == 0)
				{
					_unlink(cDirectorio);
				}
				//Activar
				C_FormasPCL hoja(22, 270, cDirectorio, iFinLinea, iTipoImpresora, 1);
				if (imprimirClausulaClub(hoja, iConyugal, iRespuestaPoliza))
				{
					impresionArchivo.imprimirArchivo(cDirectorio);
				}
			}
			else
			{
				iClub = 0;
			}
		}
	}
}

bool CDlgCapturarAbono::clubCancelacion()
{
	char cLog[500] = { 0 };
	long lFolioSeguro = 0L;
	bool bCanceloSeguro = false;
	bool bContinuar = true;
	char cStatusSeguro = ' ', cTipoCan = ' ', cClaveNoOfrecer = ' ', cMensajeSeguimiento[50] = { 0 };
	CString sLinkB, sIpB, sTiendaB, sEmpleadoB, sCajaB, sMuestraMsgB, sClienteB, sFolioB, sSistemaB;
	int iFlag = 0;

	sprintf_s(cLog, "FC0200805021521509 - entra - clubCancelacion");
	grabarLog(cLog);

	iOpcionSeleccionada = 4;
	// Proyecto CancelarSeguroClub CA0027.EXE (MARTHA)
	if (iClub == 1)
	{
		sprintf_s(cMensajeSeguimiento, "Metodo TieneSeguroClub 12");
		grabarLog(cMensajeSeguimiento);
		bContinuar = tieneSeguroClub(cStatusSeguro, cTipoCan, cClaveNoOfrecer, lFolioSeguro, bCteSeguro);
	}
	else
	{
		sprintf_s(cMensajeSeguimiento, "Metodo TieneSeguroClubConyugal 9");
		grabarLog(cMensajeSeguimiento);
		bContinuar = tieneSeguroClubConyugal(cStatusSeguro, cTipoCan, cClaveNoOfrecer, lFolioSeguro);
	}
	//  no tiene seguro club o  tiene clave de no ofrecer o   tiene seguro cancelado
	/*if ( cStatusSeguro == 'A' && !bCteSeguro)
	{
	if (iClub==1)
	{
	AfxMessageBox("NO SE PUEDE CANCELAR UN SEGURO ACTIVO");
	}
	}
	if ( bContinuar == false || cClaveNoOfrecer== 'S' || cStatusSeguro=='C' )
	{
	if (iClub==1)
	{
	AfxMessageBox("EL CLIENTE NO ESTA AFILIADO AL CLUB DE PROTECCION FAMILIAR");
	}
	if (iClub==2)
	{
	if (cClaveNoOfrecer== 'S' || cStatusSeguro== ' ')
	{
	AfxMessageBox("EL CLIENTE NO ESTA AFILIADO AL SEGURO CLUB DE PROTECCION CONYUGAL COPPEL");
	}
	else
	{
	if (cStatusSeguro== 'C')
	{
	AfxMessageBox("EL CLIENTE YA ESTA MARCADO COMO CANDELADO EN SEGURO CLUB DE PROTECCION CONYUGAL COPPEL");
	}
	}
	}
	}
	else if ( cStatusSeguro == 'P' )
	{
	AfxMessageBox(cMensajeSeguro);
	}
	else
	{*/
	if (consultarAdicional())
	{
		if (consultaFechaAfiliacionTitular())
		{
			if (bCteSeguro)
			{
				CDlgCapturarDatosSeguro datosSeguro;

				datosSeguro.iTienda = m_grid.iTienda;
				datosSeguro.iCiudad = iCiudadGnDominio;

				iFlag = datosSeguro.checarHuellaChw(m_grid.lCliente, m_grid.iCaja, m_grid.lEmpleado, m_grid.iMuestraMsg);
				if (iFlag > 0)
				{
					char cNombreProyecto[100] = { 0 }, cNombreFuncionDLL[10] = { 0 }, cInputParam1[1024] = { 0 }, cInputParam2[1024] = { 0 }, cOutputParam1[1024] = { 0 }, cOutputParam2[1024] = { 0 };
					SParametros parametros;
					memset(&parametros, 0, sizeof(SParametros));

					sLinkB.Format("%d", generarLink());
					sIpB = m_grid.sServer;
					sTiendaB.Format("%d", m_grid.iTienda);
					sEmpleadoB.Format("%ld", m_grid.lEmpleado);
					sCajaB.Format("%d", m_grid.iCaja);
					sMuestraMsgB.Format("%d", m_grid.iMuestraMsg);
					sClienteB.Format("%ld", m_grid.lCliente);
					sSistemaB.Format("3");
					sFolioB.Format("%ld", lFolioSeguro);

					parametros.iLink = generarLink();
					sprintf_s(parametros.sServer, "%s", (LPCTSTR)m_grid.sServer);
					parametros.iTienda = m_grid.iTienda;
					parametros.lEmpleado = m_grid.lEmpleado;
					parametros.iCajaActual = m_grid.iCaja;
					parametros.iMuestraMsg = m_grid.iMuestraMsg;

					parametros.lCliente = m_grid.lCliente;
					parametros.iNumSistema = atoi(sSistemaB);
					parametros.lFolioSeguro = atol(sFolioB);
					parametros.iTipo = iClub;
					memcpy(cInputParam1, &parametros, sizeof(SParametros));

					// Ruta del archivo DLL a ejecutar
					nombreArchivo("CN0027.DLL", cNombreProyecto, DIRECTORIO_CN);

					// Nombre de la función principal en el DLL
					sprintf_s(cNombreFuncionDLL, "CN0027");

					CargarDLL cargarDll(cNombreProyecto, cNombreFuncionDLL, cInputParam1, cInputParam2, cOutputParam1, cOutputParam2);
					iRegresaDll = cargarDll.getResultado();

					if (atoi(cOutputParam1) == 2)
					{
						bCanceloSeguro = true;
					}

					if (iRegresaDll <= 0)
					{
						AfxMessageBox("Ocurrio un error al llamado del modulo CN0027.DLL", MB_ICONERROR);
					}
				}
				iRespuestaPoliza = datosSeguro.iRespuesta;
			}
		}
		else {
			//PARA CANCELAR SEGUROS DE ESTE DIA PASE A LA OPCION \n CONSULTA/CANCELACION DE RECIBOS DE CAJAS
			AfxMessageBox("PARA CANCELAR SEGUROS DE ESTE DIA PASE A LA OPCION CONSULTA/CANCELACION DE RECIBOS DE CAJAS", MB_ICONINFORMATION);
		}
	}
	else
	{
		AfxMessageBox("EL CLIENTE NO CUENTA CON SEGUROS ADICIONALES QUE CANCELAR");
	}
	return bCanceloSeguro;
}

bool CDlgCapturarAbono::consultarAdicional()
{
	char cLog[500] = { 0 };
	int iContador = 0;
	long lPoliza = 0L;
	bool bRegresa = false;
	char cSql[100] = { 0 };
	i64Cliente = 0;
	CString sTexto = "";

	sprintf_s(cLog, "FC0200805021521513 - entra - consultarAdicional");
	grabarLog(cLog);

	//CLASE QUE CONTIENE FUNCION PARA CONSULTAR ADICIONALES
	CAdiional seguro2(&odbc_1);
	sTexto.Trim();
	i64Cliente = _atoi64(sTexto);
	sprintf_s(cSql, "select poliza as poliza2,nombreadicional from fun_consultaradicional('%ld')", m_grid.lCliente);
	if (seguro2.Exec(cSql))
	{
		seguro2.activarCols();
		while (seguro2.leer())
		{
			lPoliza = (long)seguro2.poliza2;

			if (lPoliza > 0)
			{
				bRegresa = true;
			}
			else
			{
				bRegresa = false;
			}
			iContador++;
		}

		if (iContador == 0)
		{
			AfxMessageBox("OCURRIO UN ERROR");
			bRegresa = false;
		}

	}
	else
	{
		seguro2.odbc->GetLastError(seguro2.GetHstmt());
		grabarMensajeError("C", iCajaDlg, (LPTSTR)(LPCTSTR)m_grid.sServer, "CA0030", "DlgCapturarAbono", "consultarAdicional", cSql, lEmpleadoDlg, "ERROR AL CONSULTAR LOS SEGUROS ADICIONALES", &odbc, m_grid.iMuestraMsg);
		sTexto.Format("%s", cSql);
		AfxMessageBox("Error en : " + sTexto);
	}
	return bRegresa;
}

bool CDlgCapturarAbono::consultaFechaAfiliacionTitular()
{
	char cLog[500] = { 0 };
	char sSqlquery[250] = { 0 }, cFechadominio[10] = { 0 }, cFechaAfiliacion[10] = { 0 };
	CString texto = "";
	bool bFechaAfiliacionDia = true;

	sprintf_s(cLog, "FC0200805021521517 - entra - consultaFechaAfiliacionTitular");
	grabarLog(cLog);

	CobtenFechaAfiliacion afiliacionSql(&odbc_1);
	if (iClub == 1) {
		sprintf_s(sSqlquery, "SELECT cliente, statusseguro,fechavencimiento,fechaafiliacion FROM crSeguros WHERE claveseguro = 'C' AND cliente = %ld AND claveconyugal in (0,1) and tiposeguro in (0,1) order by fechavencimiento ", m_grid.lCliente);

	}
	else {
		sprintf_s(sSqlquery, "SELECT cliente, statusseguro,fechavencimiento,fechaafiliacion FROM crSeguros WHERE claveseguro = 'C' AND cliente =%ld  AND claveconyugal=1", m_grid.lCliente);
	}
	if (afiliacionSql.Exec(sSqlquery)) {
		afiliacionSql.activarCols();
		if (afiliacionSql.Leer())
		{
			sprintf_s(cFechadominio, "%04d%02d%02d", iAnioActual, iMesActual, iDiaActual);
			sprintf_s(cFechaAfiliacion, "%04d%02d%02d", afiliacionSql.fechaafiliacion.ano(), afiliacionSql.fechaafiliacion.mes(), afiliacionSql.fechaafiliacion.dia());
			if (atoi(cFechadominio) == atoi(cFechaAfiliacion)) {
				bFechaAfiliacionDia = false;
			}
		}
	}
	else
	{
		//Se obtiene el error
		afiliacionSql.odbc->GetLastError(afiliacionSql.GetHstmt());
		grabarMensajeError("C", m_grid.iCaja, (LPTSTR)(LPCTSTR)m_grid.sServer, "CapturarAbono", "CDlgCapturarAbono", "incrementarAcumuladoMonetarioCajas", sSqlquery, lEmpleadoDlg, "Error al consultar la fecha de afiliacion", afiliacionSql.odbc, m_grid.iMuestraMsg);
	}
	return bFechaAfiliacionDia;
}
int CDlgCapturarAbono::checarCuentaSegurosClub()
{
	char cLog[500] = { 0 };
	int i = 0, iFlag = 0;
	CString sTexto;
	char cConcepto[20] = { 0 };
	sprintf_s(cLog, "FC0200805021521520 - entra - checarCuentaSegurosClub");
	grabarLog(cLog);
	for (i = 0; i < iTotalCuentas; i++)
	{
		m_grid.QuickGetText(i, -1, &sTexto);
		sTexto.Trim();
		sprintf_s(cConcepto, "%s", (LPCTSTR)sTexto);
		if (memcmp(cConcepto, "P.FAMILIAR", 10) == 0)
		{
			iFlag = 1;
			break;
		}
	}
	return iFlag;
}

bool CDlgCapturarAbono::grabarSeguroCaCarmovTemporal(int iDiaVencimiento, int iMesVencimiento, int iAnioVencimiento, int iCantidadSeguros, long lSuPago, int iCantidadAnteriorSeguros,
													 int iDiaVencimientoAnterior, int iMesVencimientoAnterior, int iAnioVencimientoAnterior, char *cClaveCuenta,
													 char *cStatusCuenta, int iFlagConyugal, int iNumeroMeses, long lFactura, int iTipoProducto, long lMinimoTotal, long lSaldoTotal, long lVencidoTotal, long lMinimoTotalFinal, long lSaldoTotalFinal, long lVencidoTotalFinal, int iGraboAdicional)
{
	char cLog[500] = { 0 };
	CString sTexto;
	bool bContinuar = true, bConsulta = false;;
	int iAnnio = 0, iMonto = 0, iFlagConsulta = 0, iFlagNuevoX = 0; //iFlag=0,
	char cTxt[80] = { 0 }, cNombreCompleto[50] = { 0 }, cSqlTxt[255] = { 0 }, cMensaje[200] = { 0 };
	long lMesActual = 0L, lMesVencimientoX = 0L, lTotalMeses = 0L, lCuotaNormal = 0L, lCuotaConyugal = 0L,
		lBonificacion = 0L;

	sprintf_s(cLog, "FC0200805021521525 - entra - grabarSeguroCaCarmovTemporal");
	grabarLog(cLog);

	grabarLog("grabarSeguroCaCarmovTemporal::grabando seguro en tabla temporal");
	sprintf_s(cMensaje, "grabarSeguroCaCarmovTemporal:: pago seguro: %ld", lSuPago);
	grabarLog(cMensaje);

	iFlagNuevoX = iFlagNuevo;

	CGrabarTmpSeguroCaCarmov01 tmpSeguroCaCarmov(&odbc);     // conexión al tienda.nnnn

	{
		if (iCantidadSeguros != 0L)
		{
			tmpSeguroCaCarmov.clave[0] = '0';
			tmpSeguroCaCarmov.clave[1] = 0;

			tmpSeguroCaCarmov.tipomovimiento[0] = '0';
			tmpSeguroCaCarmov.tipomovimiento[1] = 0;

			tmpSeguroCaCarmov.clavelocal[0] = '0';
			tmpSeguroCaCarmov.clavelocal[1] = 0;

			tmpSeguroCaCarmov.tiposeguro[0] = '0';
			tmpSeguroCaCarmov.flagseguroconyugal[0] = '0';

			tmpSeguroCaCarmov.tiposeguro[1] = 0;
			tmpSeguroCaCarmov.flagseguroconyugal[1] = 0;

			if (cSexoCliente[0] == 'F')
			{
				tmpSeguroCaCarmov.sexo[0] = '2';
			}
			else
			{
				tmpSeguroCaCarmov.sexo[0] = '1';
			}

			tmpSeguroCaCarmov.sexo[1] = 0;

			tmpSeguroCaCarmov.clientelocalizar[0] = '0';
			tmpSeguroCaCarmov.clientelocalizar[1] = 0;

			tmpSeguroCaCarmov.movtoseguro[0] = '0';
			tmpSeguroCaCarmov.movtoseguro[1] = 0;

			tmpSeguroCaCarmov.flagmontoseguro[0] = '0';
			tmpSeguroCaCarmov.flagmontoseguro[1] = 0;

			tmpSeguroCaCarmov.clave[0] = 'G';
			tmpSeguroCaCarmov.clave[1] = 0;

			tmpSeguroCaCarmov.clavelocal[0] = cLocal[0];
			tmpSeguroCaCarmov.clavelocal[1] = 0;

			tmpSeguroCaCarmov.cliente = m_grid.lCliente;

			if (iFlagBanorte != 0 && cClaveCuenta[0] == 'C')
			{
				tmpSeguroCaCarmov.movtoseguro[0] = 'C';
				tmpSeguroCaCarmov.movtoseguro[1] = 0;
			}
			else
			{
				tmpSeguroCaCarmov.movtoseguro[0] = '0';
				tmpSeguroCaCarmov.movtoseguro[1] = 0;
			}

			tmpSeguroCaCarmov.mesesvencidos = iTipoSeguro;

			tmpSeguroCaCarmov.tienda = (short)m_grid.iTienda;
			tmpSeguroCaCarmov.ciudad = (short)iCiudadGnDominio;
			tmpSeguroCaCarmov.caja = (short)iCajaActual;

			tmpSeguroCaCarmov.importe = lSuPago;

			if (cStatusCuenta[0] == '0') //seguro nuevo
			{
				tmpSeguroCaCarmov.folio = 0L;
			}
			else
			{
				tmpSeguroCaCarmov.folio = lFactura;
			}
			tmpSeguroCaCarmov.recibo = 0L;

			tmpSeguroCaCarmov.cantidadseguros = (short)iCantidadSeguros;


			if (iEdadCliente > 99) iEdadCliente = 99;
			tmpSeguroCaCarmov.edad = (short)iEdadCliente;

			tmpSeguroCaCarmov.efectuo = m_grid.lEmpleado;

			tmpSeguroCaCarmov.fechavencimiento.ponerFecha(iDiaVencimiento, iMesVencimiento, iAnioVencimiento);

			tmpSeguroCaCarmov.fecha.ponerFecha(iDiaActual, iMesActual, iAnioActual);

			tmpSeguroCaCarmov.tiposeguro[0] = '2';
			if (lBaseCcuenta == 0L) tmpSeguroCaCarmov.tiposeguro[0] = '1';
			tmpSeguroCaCarmov.tiposeguro[1] = 0;

			tmpSeguroCaCarmov.fechanacimiento.ponerFecha(iDiaNacimiento, iMesNacimiento, iAnioNacimiento);

			if (iFlagComproSeguro == 1)
			{
				//El seguro se compra por el Sistema de Cajas.
				if (iFlagNuevoX == 1 && cClaveCuenta[0] == 'C')
				{
					tmpSeguroCaCarmov.tipomovimiento[0] = '6';
					tmpSeguroCaCarmov.tipomovimiento[1] = 0;

					tmpSeguroCaCarmov.fechanacimiento.ponerFecha(iDiaNacimiento, iMesNacimiento, iAnioNacimiento);

				}
				else
				{
					if (iFlagReactivo == 1 && cClaveCuenta[0] == 'C')
					{
						tmpSeguroCaCarmov.tipomovimiento[0] = '7';
						tmpSeguroCaCarmov.tipomovimiento[1] = 0;
						tmpSeguroCaCarmov.fechanacimiento.ponerFecha(iDiaNacimiento, iMesNacimiento, iAnioNacimiento);
					}
					else
					{
						if (cClaveCuenta[0] == 'C' &&    bBanderaTieneClub == false)
						{
							tmpSeguroCaCarmov.tipomovimiento[0] = '6';
							tmpSeguroCaCarmov.tipomovimiento[1] = 0;
							iFlagNuevoX = 1;
						}
						else
						{
							tmpSeguroCaCarmov.tipomovimiento[0] = '2';
							tmpSeguroCaCarmov.tipomovimiento[1] = 0;
						}
					}
				}
				if (iFlagConyugal == 1)
				{
					//Al comprar un seguro
					tmpSeguroCaCarmov.flagseguroconyugal[0] = '1';
					tmpSeguroCaCarmov.flagseguroconyugal[1] = 0;

					bConsulta = false;
					iFlagConsulta = 0;
					lCuotaNormal = 0L, lCuotaConyugal = 0L;
					//cawcuota.cpp
					lCuotaNormal = obtenerCuotaSeguro(iAnioNacimiento, iMesNacimiento, &odbc, cSqlTxt, bConsulta, iFlagConsulta);
					if (bConsulta != true && iFlagConsulta != 1)
					{
						grabarMensajeError("C", m_grid.iCaja, (LPTSTR)(LPCTSTR)m_grid.sServer, "CA0030", "CDlgCapturarAbono", "grabarSeguroCaCarmovTemporal 1", (LPTSTR)(LPCTSTR)cSqlTxt, m_grid.lEmpleado, "ERROR EN LA CONSULTA(grabarsegurocacarmovtemporal)", &odbc, m_grid.iMuestraMsg);
						lCuotaNormal = 0;
					}

					bConsulta = false;
					iFlagConsulta = 0;
					//cawcuota.cpp
					lCuotaConyugal = obtenerCuotaSeguro(iAnioNacimiento, iMesNacimiento, &odbc, cSqlTxt, bConsulta, iFlagConsulta);
					if (bConsulta != true && iFlagConsulta != 1)
					{
						grabarMensajeError("C", m_grid.iCaja, (LPTSTR)(LPCTSTR)m_grid.sServer, "CA0030", "CDlgCapturarAbono", "grabarSeguroCaCarmovTemporal 2", (LPTSTR)(LPCTSTR)cSqlTxt, m_grid.lEmpleado, "ERROR EN LA CONSULTA(grabarsegurocacarmovtemporal 2)", &odbc, m_grid.iMuestraMsg);
						lCuotaConyugal = 0;
					}
					tmpSeguroCaCarmov.bonificacion = (lCuotaNormal - lCuotaConyugal) * iCantidadSeguros;
				}
				else
				{
					tmpSeguroCaCarmov.flagseguroconyugal[0] = '0';
					tmpSeguroCaCarmov.flagseguroconyugal[1] = 0;
				}
			}
			else
			{
				if (iFlagNuevoX == 1 && cClaveCuenta[0] == 'C')
				{
					tmpSeguroCaCarmov.tipomovimiento[0] = '6';
					tmpSeguroCaCarmov.tipomovimiento[1] = 0;
					tmpSeguroCaCarmov.fechanacimiento.ponerFecha(iDiaNacimiento, iMesNacimiento, iAnioNacimiento);
				}
				else
				{
					if (iFlagReactivo == 1 && cClaveCuenta[0] == 'C')
					{
						tmpSeguroCaCarmov.tipomovimiento[0] = '7';
						tmpSeguroCaCarmov.tipomovimiento[1] = 0;
						tmpSeguroCaCarmov.fechanacimiento.ponerFecha(iDiaNacimiento, iMesNacimiento, iAnioNacimiento);
					}
					else
					{
						//antes (pcuentas_cliente+i)->usa_mex=='1')
						if (cClaveCuenta[0] == 'C' && (bBanderaTieneClub == false))
						{
							tmpSeguroCaCarmov.tipomovimiento[0] = '6';
							tmpSeguroCaCarmov.tipomovimiento[1] = 0;
							iFlagNuevoX = 1;
						}
						else
						{
							tmpSeguroCaCarmov.tipomovimiento[0] = '1';
							tmpSeguroCaCarmov.tipomovimiento[1] = 0;
						}


						if (cClaveCuenta[0] == 'C')
						{
							bBanderaSeguroVigente = true;
							tmpSeguroCaCarmov.fechanacimiento.ponerFecha(iDiaNacimiento, iMesNacimiento, iAnioNacimiento);
						}
						else
						{
							tmpSeguroCaCarmov.fechanacimiento.ponerFecha(iDiaNacimiento, iMesNacimiento, iAnioNacimiento);
						}
					}
				}
				if (lBonificacion > 0)
				{
					tmpSeguroCaCarmov.bonificacion = lBonificacion;
				}
				else
				{
					if (iConyugal == 1)
					{
						tmpSeguroCaCarmov.bonificacion = 0L;
					}
					else
					{
						tmpSeguroCaCarmov.bonificacion = 77L;
					}
				}
				if (iFlagBanorte != 0 && cClaveCuenta[0] == 'C')
				{
					if (cSexoCliente[0] == 'F')
					{
						tmpSeguroCaCarmov.sexo[0] = '1';
						tmpSeguroCaCarmov.sexo[1] = 0;
					}
					if (cSexoCliente[0] == 'M')
					{
						tmpSeguroCaCarmov.sexo[0] = '2';
						tmpSeguroCaCarmov.sexo[1] = 0;
					}
				}
				else
				{
					tmpSeguroCaCarmov.sexo[0] = '0';
					tmpSeguroCaCarmov.sexo[1] = 0;
				}

				if (iFlagNuevoX == 1)
				{
					tmpSeguroCaCarmov.cantidadsegurosanterior = 0;
				}
				else
				{
					tmpSeguroCaCarmov.cantidadsegurosanterior = (short)iCantidadAnteriorSeguros;
				}

				if (iFlagNuevoX == 1)
				{
					tmpSeguroCaCarmov.fechavencimientoanterior.ponerFecha(1, 1, 1900);
				}
				else
				{
					tmpSeguroCaCarmov.fechavencimientoanterior.ponerFecha(iDiaVencimientoAnterior, iMesVencimientoAnterior, iAnioVencimientoAnterior);
				}
				if (iCantidadAnteriorSeguros > 0 && iFlagConyugal == 1)
				{
					//Al hacer un abono en seguro conyugal
					tmpSeguroCaCarmov.flagseguroconyugal[0] = '1';
					tmpSeguroCaCarmov.flagseguroconyugal[1] = 0;

					bConsulta = false;
					iFlagConsulta = 0;
					lCuotaNormal = 0L, lCuotaConyugal = 0L;
					//cawcuota.cpp
					lCuotaNormal = obtenerCuotaSeguro(iAnioNacimiento, iMesNacimiento, &odbc, cSqlTxt, bConsulta, iFlagConsulta);
					if (bConsulta != true && iFlagConsulta != 1)
					{
						grabarMensajeError("C", m_grid.iCaja, (LPTSTR)(LPCTSTR)m_grid.sServer, "CA0030", "CDlgCapturarAbono", "grabarSeguroCaCarmovTemporal 3", (LPTSTR)(LPCTSTR)cSqlTxt, m_grid.lEmpleado, "ERROR EN LA CONSULTA(grabarsegurocacarmovtemporal 3)", &odbc, m_grid.iMuestraMsg);
						lCuotaNormal = 0;
					}

					bConsulta = false;
					iFlagConsulta = 0;
					//cawcuota.cpp
					lCuotaConyugal = obtenerCuotaSeguro(iAnioNacimiento, iMesNacimiento, &odbc, cSqlTxt, bConsulta, iFlagConsulta);
					if (bConsulta != true && iFlagConsulta != 1)
					{
						grabarMensajeError("C", m_grid.iCaja, (LPTSTR)(LPCTSTR)m_grid.sServer, "CA0030", "CDlgCapturarAbono", "grabarSeguroCaCarmovTemporal 4", (LPTSTR)(LPCTSTR)cSqlTxt, m_grid.lEmpleado, "ERROR EN LA CONSULTA (grabarsegurocacarmovtemporal 4)", &odbc, m_grid.iMuestraMsg);
						lCuotaConyugal = 0;
					}
					tmpSeguroCaCarmov.bonificacion = (lCuotaNormal - lCuotaConyugal) * iCantidadSeguros;
				}
				else
				{
					tmpSeguroCaCarmov.flagseguroconyugal[0] = '0';
					tmpSeguroCaCarmov.flagseguroconyugal[1] = 0;
				}
			}
			if (iSituacionEspecial == 1)
			{
				tmpSeguroCaCarmov.clientelocalizar[0] = 'L';
				tmpSeguroCaCarmov.clientelocalizar[1] = 0;
				iSituacionEspecial = 2;
			}
			else
			{
				tmpSeguroCaCarmov.clientelocalizar[0] = '0';
				tmpSeguroCaCarmov.clientelocalizar[1] = 0;
			}

			tmpSeguroCaCarmov.cantidadmeses = (short)iNumeroMeses;

			//Para grabar el tipo de movimiento que sea en la venta de seguro
			// 1=Normal    2=Aumento del 50%   3=Aumento del 75%
			memset(cTxt, 0, 80);
			sprintf_s(cTxt, "%04d%02d", iAnioActual, iMesActual);
			lMesActual = valor_campo(cTxt, 6);
			memset(cTxt, 0, 80);
			sprintf_s(cTxt, "%04d%02d", iAnioVencimiento, iMesVencimiento);
			lMesVencimientoX = valor_campo(cTxt, 6);
			lTotalMeses = lMesVencimientoX - lMesActual;
			iAnnio = iAnioVencimiento - iAnioActual;
			if (lTotalMeses < 0) lTotalMeses = 0;
			if (lTotalMeses > 80) lTotalMeses = (lTotalMeses - (90 * iAnnio)) + (2 * iAnnio);
			iMonto = 1;
			if (iFlagConyugal == 1)
			{
				if (lTotalMeses > 5)
				{
					iMonto = 3;
				}
				else
				{
					iMonto = 2;
				}
			}
			else
			{
				if (lTotalMeses > 5) iMonto = 2;
			}
			tmpSeguroCaCarmov.flagmontoseguro[0] = (char)iMonto + '0';
			tmpSeguroCaCarmov.flagmontoseguro[1] = 0;

			//Termina
		}
		tmpSeguroCaCarmov.cajaoriginal = (short)iCajaOriginal;

		if (m_grid.lCliente == 1708)
		{
			sTexto.Format("%s", cIpServidorCartera);
			sTexto.Trim();
			sprintf_s(tmpSeguroCaCarmov.ipcarteracliente, "%s", (LPCTSTR)sTexto);
		}
		else
		{
			sTexto.Format("%s", cIpServidorCartera);
			sTexto.Trim();
			sprintf_s(tmpSeguroCaCarmov.ipcarteracliente, "%s", (LPCTSTR)sTexto);
		}

		tmpSeguroCaCarmov.tarjeta = _atoi64(cTarjeta);


		sprintf_s(cNombreCompleto, "%s %s %s", (LPCTSTR)sNombreCliente, (LPCTSTR)sApellidoPaterno, (LPCTSTR)sApellidoMaterno);
		memcpy(tmpSeguroCaCarmov.nombrecliente, cNombreCompleto, 45);
		tmpSeguroCaCarmov.nombrecliente[45] = 0;

		tmpSeguroCaCarmov.tipoproducto = (short)iTipoProducto;
		tmpSeguroCaCarmov.minimototal = lMinimoTotal;
		tmpSeguroCaCarmov.minimototalfinal = lMinimoTotalFinal;
		tmpSeguroCaCarmov.saldototal = lSaldoTotal;
		tmpSeguroCaCarmov.saldototalfinal = lSaldoTotalFinal;
		tmpSeguroCaCarmov.vencidototal = lVencidoTotal;
		tmpSeguroCaCarmov.vencidototalfinal = lVencidoTotalFinal;

		if (iFlagTieneSeguroAdicional == 1 || iFlagCapturoSeguroAdicional == 1)
		{
			tmpSeguroCaCarmov.tiposeguro[0] = '1';
			tmpSeguroCaCarmov.flagseguroconyugal[0] = '1';
		}

		if (bBanderaTieneClub || iFlagCapturoSeguroAdicional == 1 || tmpSeguroCaCarmov.tipomovimiento[0] == '6')
		{
			grabarLog("Consulta Precio seguro 6");
			consultarPrecioSeguroClub(tmpSeguroCaCarmov.importe, tmpSeguroCaCarmov.cantidadseguros, 1);
		}

		if (iFlagTieneSeguroAdicional == 1 && tmpSeguroCaCarmov.tipomovimiento[0] == '1')
		{
			if (iConyugal == 1)
			{
				grabarLog("Consulta Precio seguro 7");
				consultarPrecioSeguroClub(tmpSeguroCaCarmov.importe, tmpSeguroCaCarmov.cantidadseguros, 1);
			}
			else
			{
				tmpSeguroCaCarmov.importe = obtenerCuotaClub(m_grid.lCliente, tmpSeguroCaCarmov.cantidadseguros, tmpSeguroCaCarmov.cantidadmeses,
					iFlagBanorte, &odbc, &odbc_1, cSqlTxt, bContinuar, iFlagConsulta, iConyugal) * tmpSeguroCaCarmov.cantidadmeses;
			}
		}

		if (cClaveCuenta[0] == 'C')
		{
			if (iFlagCapturoSeguroAdicional == 1 && tmpSeguroCaCarmov.tiposeguro[0] == '2')
			{
				tmpSeguroCaCarmov.importe *= iNumMesesAdicional;
			}
			else
			{
				tmpSeguroCaCarmov.importe *= iNumeroMeses;
			}
		}
		else
		{
			tmpSeguroCaCarmov.importe = lSuPago;
		}
		sprintf_s(cMensaje, "Se envia datos a tabla tmpsegurocacarmov::Importe = %ld, Folio: %ld", tmpSeguroCaCarmov.importe, tmpSeguroCaCarmov.folio);
		grabarLog(cMensaje);
		/**********************************************************************************************/

		EDatosConvenioCliente[iTotalAbonoSeg].cAbonoSegClave = tmpSeguroCaCarmov.clave[0];
		EDatosConvenioCliente[iTotalAbonoSeg].cAbonoSegTipoMovi = tmpSeguroCaCarmov.tipomovimiento[0];
		EDatosConvenioCliente[iTotalAbonoSeg].iAbonoSegFactura = tmpSeguroCaCarmov.folio;
		EDatosConvenioCliente[iTotalAbonoSeg].cAbonoSegPuntualidad = cPuntualidad[0];
		/****************************************************************************************************/
		if (tmpSeguroCaCarmov.importe == 0 || tmpSeguroCaCarmov.folio == -1)
		{
			bContinuar = false;
		}
		else
		{
			tmpSeguroCaCarmov.prepararInsert("tmpsegurocacarmov");
			if (tmpSeguroCaCarmov.Insert())
			{
				if ((iFlagTieneSeguroAdicional == 1 || iFlagCapturoSeguroAdicional == 1) && iGraboAdicional == 0 && cClaveCuenta[0] == 'C')
				{
					bContinuar = grabarSeguroCaCarmovTemporalAdicional(tmpSeguroCaCarmov);
				}
			}
			else
			{
				bContinuar = false;
			}
		}

		if (bContinuar)
		{
			tmpSeguroCaCarmov.Commit();
			iFlagSeguro = 1;
		}
		else
		{
			tmpSeguroCaCarmov.odbc->GetLastError(tmpSeguroCaCarmov.GetHstmt());
			grabarMensajeError("C", m_grid.iCaja, (LPTSTR)(LPCTSTR)m_grid.sServer, "CapturarAbono", "CDlgCapturarAbono", "grabarSeguroCaCarmovTemporal", "Error al Insertar en la Tabla tmpsegurocacarmov", m_grid.lEmpleado, "ERROR EN LA CONSULTA(grabarsegurocacarmovtemporal 5)", tmpSeguroCaCarmov.odbc, m_grid.iMuestraMsg);
			bContinuar = false;
		}
	}
	return bContinuar;
}

int CDlgCapturarAbono::checarFinalDeMes(int &iMes1, int &iMes2, int &iMes3, int &iMes4, int &iMes5, int &iMes6, int &iMes7, int &iMes8, int &iMes9,
										int &iMes10, int &iMes11, int &iMes12)
{
	char cLog[500] = { 0 };
	int iFlag = 0;

	sprintf_s(cLog, "FC0200805021521532 - entra - checarFinalDeMes");
	grabarLog(cLog);

	switch (iMesActual)
	{
	case 1:
		if (iDiaActual == 31)
		{
			iMes1 = 1;
			iFlag = 1;
		}
		break;
	case 2:
		if (checar_bisiesto(iAnioActual) == 1)
		{
			if (iDiaActual == 29)
			{
				iMes2 = 1;
				iFlag = 1;
			}
		}
		else
		{
			if (iDiaActual == 28)
			{
				iMes2 = 1;
				iFlag = 1;
			}
		}
		break;
	case 3:
		if (iDiaActual == 31)
		{
			iMes3 = 1;
			iFlag = 1;
		}
		break;
	case 4:
		if (iDiaActual == 30)
		{
			iMes4 = 1;
			iFlag = 1;
		}
		break;
	case 5:
		if (iDiaActual == 31)
		{
			iMes5 = 1;
			iFlag = 1;
		}
		break;
	case 6:
		if (iDiaActual == 30)
		{
			iMes6 = 1;
			iFlag = 1;
		}
		break;
	case 7:
		if (iDiaActual == 31)
		{
			iMes7 = 1;
			iFlag = 1;
		}
		break;
	case 8:
		if (iDiaActual == 31)
		{
			iMes8 = 1;
			iFlag = 1;
		}
		break;
	case 9:
		if (iDiaActual == 30)
		{
			iMes9 = 1;
			iFlag = 1;
		}
		break;
	case 10:
		if (iDiaActual == 31)
		{
			iMes10 = 1;
			iFlag = 1;
		}
		break;
	case 11:
		if (iDiaActual == 30)
		{
			iMes11 = 1;
			iFlag = 1;
		}
		break;
	case 12:
		if (iDiaActual == 31)
		{
			iMes12 = 1;
			iFlag = 1;
		}
		break;
	default:
		break;
	}
	return(iFlag);
}
//funciones de postgres

bool CDlgCapturarAbono::incrementarFolioCajas()
{
	char cLog[500] = { 0 };
	bool bResultado = false;
	CString  sTexto;
	long lAbonoCte = 0;
	int j = 0;
	char cSql[55] = { 0 };

	sprintf_s(cLog, "FC0200805021521536 - entra - incrementarFolioCajas");
	grabarLog(cLog);

	grabarLog("incrementarFolioCajas::Obteniendo numero de recibo");

	for (j = 0; j < m_grid.iTotalCuentas; j++) //borrar la cuenta del seguro club del grid
	{
		m_grid.QuickGetText(j, 21, &sTexto);
		sTexto.Trim();
		lAbonoCte += atol(sTexto);
	}

	if (lAbonoCte > 0 || lAbonoCte < 0 || m_grid.lCliente == 1708 || iFlagConvenio == 1)
	{
		if (iSistema == 1)
		{
			sprintf_s(cSql, "SELECT gnincrementarfolio('M', '99', '7', '1' )");
		}
		if (iSistema == 2)
		{
			sprintf_s(cSql, "SELECT gnincrementarfolio('R', '98', '7', '1' )");
		}
		if (iSistema == 3 || iSistema == 7)
		{
			sprintf_s(cSql, "SELECT gnincrementarfolio('C', '%d', '7', '1' )", m_grid.iCaja);
		}

		CMaximo folioCoppel(&odbc, false);
		if (folioCoppel.Exec(cSql))
		{
			folioCoppel.activarCols();
			if (folioCoppel.Leer())
			{
				lNumeroRecibo = (long)folioCoppel.Total;
				bResultado = true;
			}
		}
		else
		{
			//Se obtiene el error
			folioCoppel.odbc->GetLastError(folioCoppel.GetHstmt());
			grabarMensajeError("C", m_grid.iCaja, (LPTSTR)(LPCTSTR)m_grid.sServer, "CapturarAbono", "CDlgCapturarAbono", "incrementarFolioCajas", cSql, m_grid.lEmpleado, "ERROR EN LA CONSULTA(incrementarfoliocajas)", folioCoppel.odbc, m_grid.iMuestraMsg);
		}
	}
	else
	{
		bResultado = true;
	}
	return  bResultado;
}

bool CDlgCapturarAbono::incrementarAcumuladoMonetarioCajas()
{
	char cLog[500] = { 0 };
	bool bResultado = false;
	char cSql[85] = { 0 };

	sprintf_s(cLog, "FC0200805021521540 - entra - incrementarAcumuladoMonetarioCajas");
	grabarLog(cLog);

	sprintf_s(cSql, "SELECT gnincrementaracumuladomonetario('C', '%d', '%ld', '%d' ) ", m_grid.iCaja, lTotalAPagar, 1);

	CMaximo folioCoppel(&odbc, false);
	if (folioCoppel.Exec(cSql))
	{
		folioCoppel.activarCols();
		if (folioCoppel.Leer())
		{
			lAcumuladoMonetario = (long)folioCoppel.Total;
			bResultado = true;
		}
	}
	else
	{
		//Se obtiene el error
		folioCoppel.odbc->GetLastError(folioCoppel.GetHstmt());
		grabarMensajeError("C", m_grid.iCaja, (LPTSTR)(LPCTSTR)m_grid.sServer, "CapturarAbono", "CDlgCapturarAbono", "incrementarAcumuladoMonetarioCajas", cSql, m_grid.lEmpleado, "ERROR EN LA CONSULTA(incrementaracumuladomonetariocajas)", folioCoppel.odbc, m_grid.iMuestraMsg);
	}
	return  bResultado;
}

bool CDlgCapturarAbono::consultarAcumuladoMonetarioCajas()
{
	char cLog[500] = { 0 };
	bool bResultado = false;
	char cSql[85] = { 0 };

	sprintf_s(cLog, "FC0200805021521544 - entra - consultarAcumuladoMonetarioCajas");
	grabarLog(cLog);

	sprintf_s(cSql, "SELECT gnincrementaracumuladomonetario('C', '%d', '%ld', '%d' )", m_grid.iCaja, 0, 0);

	CMaximo  folioCoppel(&odbc);
	if (folioCoppel.Exec(cSql))
	{
		folioCoppel.activarCols();
		if (folioCoppel.Leer())
		{
			lConsultaAcumulado = (long)folioCoppel.Total;
			bResultado = true;
		}
	}
	else
	{
		//Se obtiene el error
		folioCoppel.odbc->GetLastError(folioCoppel.GetHstmt());
		grabarMensajeError("C", m_grid.iCaja, (LPTSTR)(LPCTSTR)m_grid.sServer, "CapturarAbono", "CDlgCapturarAbono", "consultarAcumuladoMonetarioCajas", cSql, m_grid.lEmpleado, "ERROR EN LA CONSULTA(consultaracumuladomonetariocajas)", folioCoppel.odbc, m_grid.iMuestraMsg);
	}
	return  bResultado;
}

bool CDlgCapturarAbono::grabarTmpClienteEtpCaCarmov(char *cFolioTiendaTxt)
{
	char cLog[500] = { 0 };
	bool bResultado = false;
	char cSql[90] = { 0 };

	sprintf_s(cLog, "FC0200805021521548 - entra - grabarTmpClienteEtpCaCarmov");
	grabarLog(cLog);

	grabarLog("grabarTmpClienteEtpCaCarmov::grabando datos cliente Etp");

	sprintf_s(cSql, "SELECT cagrabartmpclienteetpcacarmov01('%ld','%d','%s')", lNumeroRecibo, iFlagClienteEtp, cFolioTiendaTxt);

	CMaximo flagCoppel(&odbc, false);
	if (flagCoppel.Exec(cSql))
	{
		flagCoppel.activarCols();
		if (flagCoppel.Leer())
		{
			bResultado = true;
		}
	}
	else
	{
		//Se obtiene el error
		flagCoppel.odbc->GetLastError(flagCoppel.GetHstmt());
		grabarMensajeError("C", m_grid.iCaja, (LPTSTR)(LPCTSTR)m_grid.sServer, "CapturarAbono", "CDlgCapturarAbono", "grabarTmpClienteEtpCaCarmov", cSql, m_grid.lEmpleado, "ERROR EN LA CONSULTA(grabartmpclienteetpcacarmov)", flagCoppel.odbc, m_grid.iMuestraMsg);
	}
	return  bResultado;
}

bool CDlgCapturarAbono::grabarTmpCaEficienciaCajeras()
{
	char cLog[500] = { 0 };
	bool bResultado = false;
	char cSql[70] = { 0 };

	sprintf_s(cLog, "FC0200805021521551 - entra - grabarTmpCaEficienciaCajeras");
	grabarLog(cLog);

	grabarLog("grabarTmpCaEficienciaCajeras::grabando eficiencia cajera");
	grabarLog(cSql);

	sprintf_s(cSql, "SELECT cagrabartmpcaeficienciacajeras('%ld','%d')", lNumeroRecibo, iFlagEficienciaCajera);

	CMaximo flagCoppel(&odbc, false);
	if (flagCoppel.Exec(cSql))
	{
		flagCoppel.activarCols();
		if (flagCoppel.Leer())
		{
			bResultado = true;
		}
	}
	else
	{
		//Se obtiene el error
		flagCoppel.odbc->GetLastError(flagCoppel.GetHstmt());
		grabarMensajeError("C", m_grid.iCaja, (LPTSTR)(LPCTSTR)m_grid.sServer, "CapturarAbono", "CDlgCapturarAbono", "grabarTmpCaEficienciaCajeras", cSql, m_grid.lEmpleado, "ERROR EN LA CONSULTA(grabartmpcaeficienciacajeras)", flagCoppel.odbc, m_grid.iMuestraMsg);
	}
	return  bResultado;
}

bool CDlgCapturarAbono::grabarTmpAbonoCaCarmov(char *cFolioTiendaTxt)
{
	char cLog[500] = { 0 };
	bool bResultado = false;
	char cSql[110] = { 0 }, cMensaje[150] = { 0 };

	sprintf_s(cLog, "FC0200805021521555 - entra - grabarTmpAbonoCaCarmov");
	grabarLog(cLog);

	sprintf_s(cMensaje, "grabarTmpAbonoCaCarmov::grabando abono cliente = %ld, recibo = %ld", m_grid.lCliente, lNumeroRecibo);
	grabarLog(cMensaje);

	sprintf_s(cSql, "SELECT fun_cagrabartmpabonocacarmov('%ld','%d','%s','%d');", lNumeroRecibo, iFlagAbono, cFolioTiendaTxt, iStatusAforeNvo);

	CMaximo flagCoppel(&odbc, false);

	if (flagCoppel.Exec(cSql))
	{
		flagCoppel.activarCols();
		if (flagCoppel.Leer())
		{
			bResultado = true;
			bResultado = grabarAbonoCacarmov();
		}
	}
	else
	{
		//Se obtiene el error
		flagCoppel.odbc->GetLastError(flagCoppel.GetHstmt());
		grabarMensajeError("C", m_grid.iCaja, (LPTSTR)(LPCTSTR)m_grid.sServer, "CapturarAbono", "CDlgCapturarAbono",
			"fun_cagrabartmpabonocacarmov", cSql, m_grid.lEmpleado, "ERROR EN LA CONSULTA(fun_cagrabartmpabonocacarmov)",
			flagCoppel.odbc, m_grid.iMuestraMsg);
	}
	return  bResultado;
}

bool CDlgCapturarAbono::grabarTmpCaMovimientos()
{
	char cLog[500] = { 0 };
	bool bResultado = false;
	char cSql[45] = { 0 };

	sprintf_s(cLog, "FC0200805021521559 - entra - grabarTmpCaMovimientos");
	grabarLog(cLog);

	sprintf_s(cSql, "SELECT cagrabartmpcamovimientos('%d')", iFlagMovimientos);

	CMaximo flagCoppel(&odbc, false);
	if (flagCoppel.Exec(cSql))
	{
		flagCoppel.activarCols();
		if (flagCoppel.Leer())
		{
			bResultado = true;
		}
	}
	else
	{
		//Se obtiene el error
		flagCoppel.odbc->GetLastError(flagCoppel.GetHstmt());
		grabarMensajeError("C", m_grid.iCaja, (LPTSTR)(LPCTSTR)m_grid.sServer, "CapturarAbono", "CDlgCapturarAbono", "grabarTmpCaMovimientos", cSql, m_grid.lEmpleado, "ERROR EN LA CONSULTA(grabartmpcamovimientos)", flagCoppel.odbc, m_grid.iMuestraMsg);
	}
	return  bResultado;
}

bool CDlgCapturarAbono::grabarTmpAbonoInteresCaCarmov(char *cFolioTiendaTxt)
{
	char cLog[500] = { 0 };
	bool bResultado = false;
	char cSql[100] = { 0 };

	sprintf_s(cLog, "FC0200805021521563 - entra - grabarTmpAbonoInteresCaCarmov");
	grabarLog(cLog);

	sprintf_s(cSql, "SELECT fun_cagrabartmpabonointerescacarmov('%ld','%d','%s','%d') ", lNumeroRecibo, iFlagAbonoInteres, cFolioTiendaTxt, iStatusAforeNvo);

	CMaximo flagCoppel(&odbc, false);
	if (flagCoppel.Exec(cSql))
	{
		flagCoppel.activarCols();
		if (flagCoppel.Leer())
		{
			bResultado = true;
			bResultado = grabarAbonoInteCacarmov();//Actualizar Abono Intereses
		}
	}
	else
	{
		//Se obtiene el error
		flagCoppel.odbc->GetLastError(flagCoppel.GetHstmt());
		grabarMensajeError("C", m_grid.iCaja, (LPTSTR)(LPCTSTR)m_grid.sServer, "CapturarAbono", "CDlgCapturarAbono", "fun_cagrabartmpabonointerescacarmov", cSql, m_grid.lEmpleado, "ERROR EN LA CONSULTA(fun_cagrabartmpabonointerescacarmov)", flagCoppel.odbc, m_grid.iMuestraMsg);
	}
	return  bResultado;
}

bool CDlgCapturarAbono::grabarTmpConvenioCaCarmov(char *cFolioTiendaTxt)
{
	char cLog[500] = { 0 };
	bool bResultado = false;
	char cSql[100] = { 0 };

	sprintf_s(cLog, "FC0200805021521567 - entra - grabarTmpConvenioCaCarmov");
	grabarLog(cLog);

	sprintf_s(cSql, "SELECT cagrabartmpconveniocacarmov08('%ld','%d','%s','%d') ", lNumeroRecibo, iFlagConvenio, cFolioTiendaTxt, iStatusAforeNvo);

	CMaximo flagCoppel(&odbc, false);
	if (flagCoppel.Exec(cSql))
	{
		flagCoppel.activarCols();
		if (flagCoppel.Leer())
		{
			bResultado = true;
			bResultado = grabarConvenioCacarmov();//Actulizar convenios
		}
	}
	else
	{
		//Se obtiene el error
		flagCoppel.odbc->GetLastError(flagCoppel.GetHstmt());
		grabarMensajeError("C", m_grid.iCaja, (LPTSTR)(LPCTSTR)m_grid.sServer, "CapturarAbono", "CDlgCapturarAbono", "grabarTmpConvenioCaCarmov", cSql, m_grid.lEmpleado, "ERROR EN LA CONSULTA(grabartmpconveniocacarmov)", flagCoppel.odbc, m_grid.iMuestraMsg);
	}
	return  bResultado;
}

bool CDlgCapturarAbono::grabarTmpBonificacionCaCarmov(char *cFolioTiendaTxt)
{
	char cLog[500] = { 0 };
	bool bResultado = false;
	char cSql[110] = { 0 };

	sprintf_s(cLog, "FC0200805021521570 - entra - grabarTmpBonificacionCaCarmov");
	grabarLog(cLog);

	sprintf_s(cSql, "SELECT fun_cagrabartmpbonificacioncacarmov( '%ld','%d','%s','%d' )", lNumeroRecibo, iFlagBonificacion, cFolioTiendaTxt, iStatusAforeNvo);

	CMaximo flagCoppel(&odbc, false);
	if (flagCoppel.Exec(cSql))
	{
		flagCoppel.activarCols();
		if (flagCoppel.Leer())
		{
			bResultado = true;
		}
	}
	else
	{
		//Se obtiene el error
		flagCoppel.odbc->GetLastError(flagCoppel.GetHstmt());
		grabarMensajeError("C", m_grid.iCaja, (LPTSTR)(LPCTSTR)m_grid.sServer, "CapturarAbono", "CDlgCapturarAbono", "fun_cagrabartmpbonificacioncacarmov", cSql, m_grid.lEmpleado, "ERROR EN LA CONSULTA(fun_cagrabartmpbonificacioncacarmov)", flagCoppel.odbc, m_grid.iMuestraMsg);
	}
	return  bResultado;
}

bool CDlgCapturarAbono::grabarTmpSeguroCaCarmov(char *cFolioTiendaTxt)
{
	char cLog[500] = { 0 };
	bool bResultado = false;
	char cSql[220] = { 0 }, cFechaUltimoPago[12] = { 0 };//15750
	int iClub = 0, iAfirme = 0;

	sprintf_s(cLog, "FC0200805021521574 - entra - grabarTmpSeguroCaCarmov");
	grabarLog(cLog);

	//15750
	sprintf_s(cFechaUltimoPago, "%04d-%02d-%02d", iAnioUltimoPago, iMesUltimoPago, iDiaUltimoPago);
	//15750
	sprintf_s(cSql, "SELECT folioseguro, seguroclub FROM fun_cagrabartmpsegurocacarmov('%ld','%d','%s','%d','%d','%ld','%d','%s','%s') ", lNumeroRecibo, iFlagSeguro, cFolioTiendaTxt, iStatusAforeNvo, m_grid.iTienda, m_grid.lCliente, iFlagBeneficiarios, cFechaMovimiento, cFechaUltimoPago);

	CConsultarFoliosSeguro folioCoppel(&odbc, false);
	if (folioCoppel.Exec(cSql))
	{
		folioCoppel.activarCols();
		while (folioCoppel.Leer())
		{
			if (folioCoppel.seguroclub == 1)
			{
				iFoliosSegurosAdicionales[iClub] = (int)folioCoppel.folioseguro; //Para obtener los folios de los seguros y poder actualizar la tabla crseguros
				sprintf_s(cMensaje, "Se obtiene los folios seguros: Folio: %ld", iFoliosSegurosAdicionales[iClub]);
				grabarLog(cMensaje);
				iClub++;
			}
			else
			{
				iFoliosAfirme[iAfirme] = (int)folioCoppel.folioseguro; //Seguros afirme
				iAfirme++;
			}
		}
		bResultado = true;
		bResultado = grabarAbonoSegCacarmov();
	}
	else
	{
		//Se obtiene el error
		folioCoppel.odbc->GetLastError(folioCoppel.GetHstmt());
		grabarMensajeError("C", m_grid.iCaja, (LPTSTR)(LPCTSTR)m_grid.sServer, "CapturarAbono", "CDlgCapturarAbono", "grabarTmpSeguroCaCarmov", cSql, m_grid.lEmpleado, "ERROR EN LA CONSULTA(grabartmpsegurocacarmov)", folioCoppel.odbc, m_grid.iMuestraMsg);
	}
	return  bResultado;
}

//graba en las tablas temporales de la cartera las cuenta de ropa,muebles,prestamos
//seguro
bool CDlgCapturarAbono::grabarTemporalCarteraSeguro(long lFactura, int iDiaVencimiento, int iMesVencimiento, int iAnioVencimiento, char *cClave, int iNumeroSeguros, int &iGraboAdicional)
{
	char cLog[500] = { 0 };
	bool bContinuar = true;
	char cNombreTablaTemporal[80] = { 0 }, cMensajeSeguimiento[150] = { 0 };

	sprintf_s(cLog, "FC0200805021521578 - entra - grabarTemporalCarteraSeguro");
	grabarLog(cLog);

	CGrabarTmpAbonoCrSegurosFija01 tmpCrSeguros(&odbc_1);     // conexión a la B.D cartera

	{
		tmpCrSeguros.cliente = m_grid.lCliente;

		//
		{         //no tiene seguro club      y no es seguro afirme
			//esta validacion es nada mas cuando el seguro club es nuevo
			if (bBanderaTieneClub == false && cClave[0] != 'S')
			{
				tmpCrSeguros.folio = 0L;  //bandera para checar si fue seguro nuevo

				tmpCrSeguros.fechavencimiento.ponerFecha(iDiaVencimiento, iMesVencimiento, iAnioVencimiento);

				tmpCrSeguros.cantidadseguros = (short)iNumeroSeguros;


				if (cClave[0] == 'C')//es club proteccion
				{
					tmpCrSeguros.cvesinbeneficiarios = 1;
					if (iFlagNuevo == 1) tmpCrSeguros.cvesinbeneficiarios = 1;

					tmpCrSeguros.claveseguro[0] = 'C';
					tmpCrSeguros.claveseguro[1] = 0;
				}
				else
				{
					tmpCrSeguros.cvesinbeneficiarios = 0;
					tmpCrSeguros.claveseguro[0] = '0';
					tmpCrSeguros.claveseguro[1] = 0;
				}
				if (iConyugal == 2)
				{
					tmpCrSeguros.claveconyugal = 1;
				}
				else
				{
					tmpCrSeguros.claveconyugal = 0;
				}
			}
			else
			{
				if (lFactura != 0)
				{
					tmpCrSeguros.folio = lFactura;
				}
				else
				{
					//reactivo seguro club

					tmpCrSeguros.folio = obtenerFacturaSeguroCancelado();
				}
				if (iDiaVencimiento == 0)
				{
					iDiaVencimiento = 1;
				}
				if (iMesVencimiento == 0)
				{
					iMesVencimiento = 1;
				}
				tmpCrSeguros.fechavencimiento.ponerFecha(iDiaVencimiento, iMesVencimiento, iAnioVencimiento);
				tmpCrSeguros.cantidadseguros = (short)iNumeroSeguros;

				if (cClave[0] == 'C')//es club proteccion
				{
					tmpCrSeguros.cvesinbeneficiarios = 1;
					if (iFlagNuevo == 1) tmpCrSeguros.cvesinbeneficiarios = 1;

					tmpCrSeguros.claveseguro[0] = 'C';
					tmpCrSeguros.claveseguro[1] = 0;

				}
				else
				{
					tmpCrSeguros.cvesinbeneficiarios = 0;
					tmpCrSeguros.claveseguro[0] = '0';
					tmpCrSeguros.claveseguro[1] = 0;
				}
				if (iConyugal == 2)
				{
					tmpCrSeguros.claveconyugal = 1;
				}
				else
				{
					tmpCrSeguros.claveconyugal = 0;
				}
			}

			if (iFlagTieneSeguroAdicional == 1 || iFlagCapturoSeguroAdicional == 1)
			{
				tmpCrSeguros.claveconyugal = 1;
			}

			tmpCrSeguros.caja = (short)m_grid.iCaja;
			tmpCrSeguros.sistema = (short)iSistema;
			tmpCrSeguros.tienda = (short)m_grid.iTienda;
			sprintf_s(cNombreTablaTemporal, "tmpabonocrseguros");

			//Campos nuevos para el seguro adicional
			memset(tmpCrSeguros.nombreadicional, 0, sizeof(tmpCrSeguros.nombreadicional));
			memset(tmpCrSeguros.apellidopaternoadic, 0, sizeof(tmpCrSeguros.apellidopaternoadic));
			memset(tmpCrSeguros.apellidomaternoadic, 0, sizeof(tmpCrSeguros.apellidomaternoadic));
			tmpCrSeguros.fecnacadic.ponerFecha(1, 1, 1900);
			tmpCrSeguros.parentescoadic = 0;
			tmpCrSeguros.consecutivoseguro = 0; //Seguro titular se guarda con 0
			sprintf_s(cMensajeSeguimiento, "grabarTemporalCarteraSeguro:Graba en temporal tmpabonocrseguros Folio: %ld", tmpCrSeguros.folio);
			grabarLog(cMensajeSeguimiento);
			tmpCrSeguros.prepararInsert(cNombreTablaTemporal);
			if (tmpCrSeguros.Insert())
			{
				if ((iFlagTieneSeguroAdicional == 1 || iFlagCapturoSeguroAdicional == 1) && iGraboAdicional == 0 && cClave[0] == 'C')
				{
					bContinuar = grabarTemporalCarteraSeguroAdicional(tmpCrSeguros);
					iGraboAdicional = 1;
				}
			}
			else
			{
				bContinuar = false;
			}
			if (bContinuar)
			{
				tmpCrSeguros.Commit();
				iFlagCrSeguro = 1;
			}
			else
			{
				tmpCrSeguros.Error();
				tmpCrSeguros.odbc->GetLastError(tmpCrSeguros.GetHstmt());
				grabarMensajeError("C", m_grid.iCaja, (LPTSTR)(LPCTSTR)m_grid.sServer, "CapturarAbono", "CDlgCapturarAbono", "grabarTemporalCarteraSeguro", "Error al Insertar en la Tabla tmpabonocrseguros", m_grid.lEmpleado, "ERROR EN LA CONSULTA(grabartemporalcarteraseguro)", tmpCrSeguros.odbc, m_grid.iMuestraMsg);
			}
		}
	}
	return bContinuar;

}

//prestamo
bool CDlgCapturarAbono::grabarTemporalCarteraPrestamos(long lSaldoNuevo, long lAbonoInteres, long lAbonoCuenta, long lSuPago, char *cStatus, long lFactura, long lInteresCalculado)
{
	char cLog[500] = { 0 };
	bool bContinuar = true;
	char cNombreTablaTemporal[80] = { 0 };

	sprintf_s(cLog, "FC0200805021521583 - entra - grabarTemporalCarteraPrestamos");
	grabarLog(cLog);

	grabarLog("grabarTemporalCarteraPrestamos::Grabando prestamo en tabla temporal cartera");

	CGrabarTmpAbonoCrPrestamosFija tmpCrPrestamos(&odbc_1);     // conexión a la B.D cartera
	{
		if (lSuPago > 0L)
		{
			if (cStatus[0] == '1')
			{

				tmpCrPrestamos.cliente = m_grid.lCliente;
				tmpCrPrestamos.tienda = (short)m_grid.iTienda;
				tmpCrPrestamos.factura = lFactura;

				tmpCrPrestamos.interesadicional = lInteresCalculado - lAbonoInteres;
				//tmpCrPrestamos.interesadicional = lAbonoInteres; //restar el interesadicional en la funcion de postgres
				tmpCrPrestamos.saldoactual = lSaldoNuevo;
				tmpCrPrestamos.importeultimomovimiento = lAbonoCuenta;
				tmpCrPrestamos.fechaultimomovimiento.ponerFecha(iDiaActual, iMesActual, iAnioActual);

				tmpCrPrestamos.caja = (short)m_grid.iCaja;
				tmpCrPrestamos.sistema = (short)iSistema;

				sprintf_s(cNombreTablaTemporal, "tmpabonocrprestamos");
				tmpCrPrestamos.prepararInsert(cNombreTablaTemporal);
				if (tmpCrPrestamos.Insert())
				{
					tmpCrPrestamos.Commit();
					iFlagCrPrestamo = 1;
				}
				else
				{
					tmpCrPrestamos.odbc->GetLastError(tmpCrPrestamos.GetHstmt());
					grabarMensajeError("C", m_grid.iCaja, (LPTSTR)(LPCTSTR)m_grid.sServer, "CapturarAbono", "CDlgCapturarAbono", "grabarTemporalCarteraPrestamos", "Error al Insertar en la Tabla tmpabonocrprestamos", m_grid.lEmpleado, "ERROR EN LA CONSULTA(grabartemporalcarteraprestamos)", tmpCrPrestamos.odbc, m_grid.iMuestraMsg);
					bContinuar = false;
				}

			}
		}

	}
	return bContinuar;
}

bool CDlgCapturarAbono::grabarTemporalCarteraRopa(long lSuPago, char *cStatus, long lInteresAdicional, long lAbonoInteres, long lSaldoNuevo, long lInteresPrimerMes)
{
	char cLog[500] = { 0 };
	int iFlag = 0;
	bool bContinuar = true;
	char cNombreTablaTemporal[80] = { 0 };

	sprintf_s(cLog, "FC0200805021521587 - entra - grabarTemporalCarteraRopa");
	grabarLog(cLog);

	grabarLog("grabarTemporalCarteraRopa::Grabando ropa en tabla temporal cartera");

	CGrabarTmpAbonoCrCropaFija02 tmpCrCropa(&odbc_1);     // conexión a la B.D cartera
	{
		tmpCrCropa.cliente = m_grid.lCliente;

		if (lSuPago > 0L)
		{
			iFlag = 1;
		}
		else if (lSuPago < 0L)
		{
			if (iFlagMovimiento == 0) // si es 0 es cargo
			{
				//Se trata de un Cargo
				iFlag = 1;
			}
		}

		if (iFlag == 1)
		{
			if (cStatus[0] == '1')
			{

				tmpCrCropa.saldo = lSaldoNuevo;
				tmpCrCropa.interesadicional = 0L;
				tmpCrCropa.interesadicionalprimermes = 0;
				if (lSuPago < 0 &&
					lInteresAdicional > 0)
				{
					tmpCrCropa.minimoapagar = lSuPago;  //restarlo en la funcion de postgres
					tmpCrCropa.flagactualizacion = 0;
				}
				else
				{
					tmpCrCropa.interesadicional = lAbonoInteres;
					tmpCrCropa.minimoapagar = lSaldoNuevo;
					tmpCrCropa.flagactualizacion = 1;
					tmpCrCropa.interesadicionalprimermes = lInteresPrimerMes;
				}
				tmpCrCropa.fechaultimomovimiento.ponerFecha(iDiaActual, iMesActual, iAnioActual);
			}

			tmpCrCropa.caja = (short)m_grid.iCaja;
			tmpCrCropa.sistema = (short)iSistema;
			tmpCrCropa.tienda = (short)m_grid.iTienda;

			sprintf_s(cNombreTablaTemporal, "tmpabonocrcropa");

			tmpCrCropa.prepararInsert(cNombreTablaTemporal);
			if (tmpCrCropa.Insert())
			{
				tmpCrCropa.Commit();
				iFlagCrRopa = 1;
			}
			else
			{
				tmpCrCropa.odbc->GetLastError(tmpCrCropa.GetHstmt());
				grabarMensajeError("C", m_grid.iCaja, (LPTSTR)(LPCTSTR)m_grid.sServer, "CapturarAbono", "CDlgCapturarAbono", "grabarTemporalCarteraRopa", "Error al Insertar en la Tabla tmpabonocrcropa", m_grid.lEmpleado, "ERROR EN LA CONSULTA(grabartemporalcarteraropa)", tmpCrCropa.odbc, m_grid.iMuestraMsg);
				bContinuar = false;
			}
		}

	}
	return bContinuar;
}

//muebles
bool CDlgCapturarAbono::grabarTemporalCarteraMuebles(long lSuPago, long lFactura, char *cStatus, long lAbonoInteres, long lSaldoNuevo, long lInteresPrimerMes)
{
	char cLog[500] = { 0 };
	int iFlag = 0;
	CString sTexto;
	bool bContinuar = true;
	char cNombreTablaTemporal[80] = { 0 };

	sprintf_s(cLog, "FC0200805021521591 - entra - grabarTemporalCarteraMuebles");
	grabarLog(cLog);

	grabarLog("grabarTemporalCarteraMuebles::Grabando muebles en tabla temporal cartera");

	CGrabarTmpAbonoCrCmueblesFija02 tmpCrCmuebles(&odbc_1);     // conexión a la B.D cartera
	{
		tmpCrCmuebles.cliente = m_grid.lCliente;
		tmpCrCmuebles.factura = lFactura;

		if (lSuPago > 0L)
		{
			iFlag = 1;
		}
		else if (lSuPago < 0L)
		{
			if (iFlagMovimiento == 0)
			{
				//Se trata de un Cargo
				iFlag = 1;
			}
		}

		if (iFlag == 1)
		{

			if (cStatus[0] == 0) //se anexo la cuenta
			{
				/*cmuebles.cliente=cliente/10L;
				//cmuebles.tienda_donde_compro=(char)(pcuentas_cliente+i)->tienda_donde_compro;
				cmuebles.tienda_compro_cte=(pcuentas_cliente+i)->tienda_donde_compro;
				//if( cmuebles.tienda_donde_compro==0 ) cmuebles.tienda_donde_compro=(char)coppel.tienda;
				if( cmuebles.tienda_compro_cte==0 ) cmuebles.tienda_compro_cte=(short)coppel.tienda;

				cmuebles.factura=(pcuentas_cliente+i)->factura;
				cmuebles.dia_venta=(pcuentas_cliente+i)->dia_venta;
				cmuebles.mes_venta=(pcuentas_cliente+i)->mes_venta;
				cmuebles.ano_venta=(pcuentas_cliente+i)->ano_venta;
				cmuebles.importe_de_la_venta=(pcuentas_cliente+i)->importe_de_la_compra;
				cmuebles.plazo=0;
				cmuebles.intereses_sobre_compra=0L;
				cmuebles.abono_mensual=0L;
				cmuebles.enganche=0L;
				memcpy( cmuebles.descripcion,(pcuentas_cliente+i)->descripcion,10 );
				cmuebles.saldo=(pcuentas_cliente+i)->saldo-(pcuentas_cliente+i)->su_pago;
				cmuebles.intereses_adicionales=(pcuentas_cliente+i)->intereses_adicionales;
				cmuebles.dia_ultimo_movimiento=(char)coppel.dia;
				cmuebles.mes_ultimo_movimiento=(char)coppel.mes;
				cmuebles.ano_ultimo_movimiento=(char)(coppel.ano-1900);
				cmuebles.clave_dificil_cobro='A';
				cmuebles.dia_convenio=0;
				cmuebles.mes_convenio=0;
				cmuebles.importe_convenio=0L;
				cmuebles.plazo_convenio=0;
				cmuebles.efectuo_convenio=0L;*/

			}
			else
			{
				tmpCrCmuebles.interesadicional = lAbonoInteres; //restarlo en la funcion de postgres
				tmpCrCmuebles.saldo = lSaldoNuevo;
				tmpCrCmuebles.fechaultimomovimiento.ponerFecha(iDiaActual, iMesActual, iAnioActual);
				tmpCrCmuebles.interesadicionalprimermes = lInteresPrimerMes;
			}
			tmpCrCmuebles.caja = (short)m_grid.iCaja;
			tmpCrCmuebles.sistema = (short)iSistema;
			tmpCrCmuebles.tienda = (short)m_grid.iTienda;

			sprintf_s(cNombreTablaTemporal, "tmpabonocrcmuebles");
			tmpCrCmuebles.prepararInsert(cNombreTablaTemporal);
			if (tmpCrCmuebles.Insert())
			{
				tmpCrCmuebles.Commit();
				iFlagCrMuebles = 1;
			}
			else
			{
				tmpCrCmuebles.odbc->GetLastError(tmpCrCmuebles.GetHstmt());
				grabarMensajeError("C", m_grid.iCaja, (LPTSTR)(LPCTSTR)m_grid.sServer, "CapturarAbono", "CDlgCapturarAbono", "grabarTemporalCarteraMuebles", "Error al Insertar en la Tabla tmpabonocrcmuebles", m_grid.lEmpleado, "ERROR EN LA CONSULTA(grabartemporalcarteramuebles)", tmpCrCmuebles.odbc, m_grid.iMuestraMsg);
				bContinuar = false;
			}
		}
	}
	return bContinuar;

}

bool CDlgCapturarAbono::grabarTemporalCarteraPlanes(long lSuPago, long lFactura)
{
	char cLog[500] = { 0 };
	int iFlag = 0;
	CString sTexto;
	bool bContinuar = true;
	char cNombreTablaTemporal[80] = { 0 };

	sprintf_s(cLog, "FC0200805021521596 - entra - grabarTemporalCarteraPlanes");
	grabarLog(cLog);

	grabarLog("grabarTemporalCarteraPlanes::Grabando planes en tabla temporal cartera");

	CTmpAbonoCrCmueblesPlanFija tmpCrCmueblesPlanes(&odbc_1);     // conexión a la B.D cartera
	{
		tmpCrCmueblesPlanes.cliente = m_grid.lCliente;
		tmpCrCmueblesPlanes.factura = lFactura;
		tmpCrCmueblesPlanes.abonosmes = lSuPago;

		tmpCrCmueblesPlanes.caja = (short)m_grid.iCaja;
		tmpCrCmueblesPlanes.sistema = (short)iSistema;
		tmpCrCmueblesPlanes.tienda = (short)m_grid.iTienda;

		sprintf_s(cNombreTablaTemporal, "tmpabonocrcmueblesplanes");
		tmpCrCmueblesPlanes.prepararInsert(cNombreTablaTemporal);
		if (tmpCrCmueblesPlanes.Insert())
		{
			tmpCrCmueblesPlanes.Commit();
			bTienePlantel = true;
		}
		else
		{
			tmpCrCmueblesPlanes.odbc->GetLastError(tmpCrCmueblesPlanes.GetHstmt());
			grabarMensajeError("C", m_grid.iCaja, (LPTSTR)(LPCTSTR)m_grid.sServer, "CapturarAbono", "CDlgCapturarAbono", "grabarTemporalCarteraPlanes", "Error al Insertar en la Tabla tmpabonocrcmueblesplanes", m_grid.lEmpleado, "ERROR EN LA CONSULTA(grabarTemporalCarteraPlanes)", tmpCrCmueblesPlanes.odbc, m_grid.iMuestraMsg);
			bContinuar = false;
		}
	}
	return bContinuar;
}

//Se modifica para que guarde el seguro titular y los seguros adicionales
bool CDlgCapturarAbono::grabarTmpCrSeguros()
{
	char cLog[500] = { 0 };
	bool bResultado = true;
	int i = 0, iTipoSeguro = 0, iFlagBorrarTabla = 0;
	char cSql[130] = { 0 }, cMensajeSeguimiento[150] = { 0 };

	sprintf_s(cLog, "FC0200805021521600 - entra - grabarTmpCrSeguros");
	grabarLog(cLog);

	grabarLog("grabarTmpCrSeguros::grabando cuenta de seguros en cartera");

	while (i < iSegurosAfirme && iFoliosAfirme[i] != 0) //Para guardar los seguros afirmes
	{
		iTipoSeguro = 1; //Seguro titular

		if (iFoliosSegurosAdicionales[0] == 0 && i + 1 == iSegurosAfirme)
			iFlagBorrarTabla = 1; //Para que la funcion borre los registros de la tabla tmpabonocrseguros
		sprintf_s(cMensajeSeguimiento, "grabarTmpCrSeguros:Graba Seguros con funcion FUN_CRGRABARTMPCRSEGUROSCRSEGUROS Folio: %ld", iFoliosSegurosAdicionales[i]);
		grabarLog(cMensajeSeguimiento);

		sprintf_s(cSql, "SELECT FUN_CRGRABARTMPCRSEGUROSCRSEGUROS('%d','%ld','%d','%d','%d','%d','%d','%d','0')", iFlagCrSeguro, iFoliosAfirme[i], m_grid.iCaja, iSistema, m_grid.iTienda, iTipoSeguro, i, iFlagBorrarTabla);

		i++;

		CMaximo flagCoppel(&odbc_1, false);
		if (flagCoppel.Exec(cSql))
		{
			flagCoppel.activarCols();
			if (flagCoppel.Leer())
			{
				bResultado = true;
			}
		}
		else
		{
			//Se obtiene el error
			flagCoppel.odbc->GetLastError(flagCoppel.GetHstmt());
			grabarMensajeError("C", m_grid.iCaja, (LPTSTR)(LPCTSTR)m_grid.sServer, "CapturarAbono", "CDlgCapturarAbono", "grabarTmpCrSeguros", cSql, m_grid.lEmpleado, "ERROR EN LA CONSULTA(grabartmpcrseguros)", flagCoppel.odbc, m_grid.iMuestraMsg);
			bResultado = false;
			break;
		}
	}

	if (bResultado && iFoliosSegurosAdicionales[0] != 0) //Para saber que se abono o compro un seguro
	{
		i = 0;

		while (i < (iSegurosAdicionales + 1)) //Para guardar los seguros adicionales y el seguro titular
		{
			if (iFlagTieneSeguroAdicional == 1 || iFlagCapturoSeguroAdicional == 1)
			{
				if (i == 0)
					iTipoSeguro = 1; //Seguro titular
				else
					iTipoSeguro = 2; //Seguro adicional
			}

			if (i == iSegurosAdicionales)
				iFlagBorrarTabla = 1; //Para que la funcion borre los registros de la tabla tmpabonocrseguros

			sprintf_s(cSql, "SELECT FUN_CRGRABARTMPCRSEGUROSCRSEGUROS('%d','%ld','%d','%d','%d','%d','%d','%d','1') ", iFlagCrSeguro, iFoliosSegurosAdicionales[i], m_grid.iCaja, iSistema, m_grid.iTienda, iTipoSeguro, i, iFlagBorrarTabla);

			i++;

			CMaximo flagCoppel(&odbc_1, false);
			if (flagCoppel.Exec(cSql))
			{
				flagCoppel.activarCols();
				if (flagCoppel.Leer())
				{
					bResultado = true;

					char cFechaActual[12] = { 0 };
					sprintf_s(cFechaActual, "%04d-%02d-%02d", iAnioActual, iMesActual, iDiaActual);

					if (checarCuentaSegurosClubSMS() == 0)
					{
						char cSqlFlagSMS[50] = { 0 };
						sprintf_s(cSqlFlagSMS, "SELECT gnconsultarflag( '%c','%d');", 'C', 92);
						CMaximo flagCoppelSMS(&odbc);

						if (flagCoppelSMS.Exec(cSqlFlagSMS))
						{
							flagCoppelSMS.activarCols();
							if (flagCoppelSMS.Leer())
							{
								iFlagNoEnviarSMS = (short)flagCoppelSMS.Total;
							}
						}
						else
						{
							//FlagCoppel.odbc->GetLastError( FlagCoppel.GetHstmt() );
						}

						if (iFlagNoEnviarSMS == 1)
						{
							char cNombreProyecto[100] = { 0 }, cNombreFuncionDLL[10] = { 0 }, cInputParam1[1024] = { 0 }, cInputParam2[1024] = { 0 }, cOutParam1[1024] = { 0 }, cOutParam2[8524] = { 0 };
							SParametros argv;//add
							Parametros2 parametros2;

							memset(&argv, 0, sizeof(argv));
							memset(&parametros2, 0, sizeof(parametros2));

							argv.iTienda = m_grid.iTienda;
							sprintf_s(argv.sServer, "%s", m_grid.sServer);
							argv.lEmpleado = m_grid.lEmpleado;
							argv.iCajaActual = m_grid.iCaja;
							argv.iMuestraMsg = m_grid.iMuestraMsg;
							lClienteDlg = m_grid.lCliente;
							iTiendaDlg = m_grid.iTienda;

							parametros2.cliente = lClienteDlg;
							parametros2.numTda = iTiendaDlg;
							sprintf_s(parametros2.folioClub, "%d", iFoliosSegurosAdicionales[0]);
							sprintf_s(FolioClubMovSMS, "%d", iFoliosSegurosAdicionales[0]);
							parametros2.folioPrestamo = 0;


							memcpy(cInputParam1, &argv, sizeof(argv));
							memcpy(cInputParam2, &parametros2, sizeof(parametros2));

							nombreArchivo("GN0266.DLL", cNombreProyecto, DIRECTORIO_GN);

							CargarDLL cargarDll(cNombreProyecto, "GN0266", cInputParam1, cInputParam2, cOutParam1, cOutParam2);

							iRegresaDll = cargarDll.getResultado();
							if (iRegresaDll < 1)
							{
								AfxMessageBox("Error al cargar el Modulo de envio SMS(GN0266)");
							}
							if (iRegresaDll == 3)
							{
								//iFlagCorte = 3;
							}
							if (iRegresaDll == 1)
							{
								sprintf_s(cSql, "update mov_mensajes_sms set num_colaborador = %ld where fol_seguro = %d;", m_grid.lEmpleado, iFoliosSegurosAdicionales[i]);

								CActualizarEmpleadoMovSMS flagCoppel(&odbc_1, false);
								{
									if (flagCoppel.Exec(cSql))
									{
										flagCoppel.activarCols();
										if (flagCoppel.Leer())
											int respuesta = 0;
									}
								}
							}

						}

						else
						{
							sprintf_s(cSql, "delete from mov_mensajes_sms where fol_seguro = '%ld'; ", iFoliosSegurosAdicionales[0]);

							CCEliminarMensajeSMS flagCoppel(&odbc_1, false);
							{
								if (flagCoppel.Exec(cSql))
								{
									flagCoppel.activarCols();
									if (flagCoppel.Leer())
										int respuesta = 0;
								}
							}
						}
					}
				}
			}
			else
			{
				//Se obtiene el error
				flagCoppel.odbc->GetLastError(flagCoppel.GetHstmt());
				grabarMensajeError("C", m_grid.iCaja, (LPTSTR)(LPCTSTR)m_grid.sServer, "CapturarAbono", "CDlgCapturarAbono", "grabarTmpCrSeguros", cSql, m_grid.lEmpleado, "ERROR EN LA CONSULTA(grabartmpcrseguros)", flagCoppel.odbc, m_grid.iMuestraMsg);
				bResultado = false;
				break;
			}
		}
	}
	return  bResultado;
}

bool CDlgCapturarAbono::borrarDatosTemporalesFijas()
{
	char cLog[500] = { 0 };
	bool bResultado = false;
	char cSql[70] = { 0 };

	sprintf_s(cLog, "FC0200805021521606 - entra - borrarDatosTemporalesFijas");
	grabarLog(cLog);

	grabarLog("borrarDatosTemporalesFijas::Borrando datos de tablas temporales");

	if (m_grid.lCliente != 1708)
	{
		sprintf_s(cSql, "SELECT fun_crborrardatostemporalfija('%d','%d','%d')", m_grid.iCaja, iSistema, m_grid.iTienda);

		CMaximo flagCoppel(&odbc_1);
		if (flagCoppel.Exec(cSql))
		{
			flagCoppel.activarCols();
			if (flagCoppel.Leer())
			{
				bResultado = true;
			}
		}
		else
		{
			//Se obtiene el error
			flagCoppel.Error();
			flagCoppel.odbc->GetLastError(flagCoppel.GetHstmt());
			grabarMensajeError("C", m_grid.iCaja, (LPTSTR)(LPCTSTR)m_grid.sServer, "CapturarAbono", "CDlgCapturarAbono", "fun_crborrardatostemporalfija", cSql, m_grid.lEmpleado, "ERROR EN LA CONSULTA(fun_crborrardatostemporalfija)", flagCoppel.odbc, m_grid.iMuestraMsg);
		}
	}
	else
	{
		bResultado = true;
	}
	return  bResultado;
}

bool CDlgCapturarAbono::grabarTmpCrCropa()
{
	char cLog[500] = { 0 };
	bool bResultado = false;
	char cSql[80] = { 0 };

	sprintf_s(cLog, "FC0200805021521610 - entra - grabarTmpCrCropa");
	grabarLog(cLog);

	grabarLog("grabarTmpCrCropa::grabando cuenta de ropa en cartera");

	sprintf_s(cSql, "SELECT crgrabartmpcrcropacrcropa02('%d','%d','%d','%d')", iFlagCrRopa, m_grid.iCaja, iSistema, m_grid.iTienda);

	CMaximo flagCoppel(&odbc_1, false);
	if (flagCoppel.Exec(cSql))
	{
		flagCoppel.activarCols();
		if (flagCoppel.Leer())
		{
			bResultado = true;
		}
	}
	else
	{
		//Se obtiene el error
		flagCoppel.odbc->GetLastError(flagCoppel.GetHstmt());
		grabarMensajeError("C", m_grid.iCaja, (LPTSTR)(LPCTSTR)m_grid.sServer, "CapturarAbono", "CDlgCapturarAbono", "grabarTmpCrCropa", cSql, m_grid.lEmpleado, "ERROR EN LA CONSULTA(grabartmpcrcropa)", flagCoppel.odbc, m_grid.iMuestraMsg);
	}
	return  bResultado;
}

bool CDlgCapturarAbono::grabarTmpCrCmuebles()
{
	char cLog[500] = { 0 };
	bool bResultado = false;
	char cSql[82] = { 0 };

	sprintf_s(cLog, "FC0200805021521614 - entra - grabarTmpCrCmuebles");
	grabarLog(cLog);

	grabarLog("grabarTmpCrCmuebles::grabando cuentas de muebles en cartera");

	sprintf_s(cSql, "SELECT crgrabartmpcrcmueblescrcmuebles02('%d','%d','%d','%d')", iFlagCrMuebles, m_grid.iCaja, iSistema, m_grid.iTienda);

	CMaximo flagCoppel(&odbc_1, false);
	if (flagCoppel.Exec(cSql))
	{
		flagCoppel.activarCols();
		if (flagCoppel.Leer())
		{
			bResultado = true;
		}
	}
	else
	{
		//Se obtiene el error
		flagCoppel.odbc->GetLastError(flagCoppel.GetHstmt());
		grabarMensajeError("C", m_grid.iCaja, (LPTSTR)(LPCTSTR)m_grid.sServer, "CapturarAbono", "CDlgCapturarAbono", "grabarTmpCrCmuebles", cSql, m_grid.lEmpleado, "ERROR EN LA CONSULTA(grabartmpcrcmuebles)", flagCoppel.odbc, m_grid.iMuestraMsg);
	}
	return bResultado;
}

bool CDlgCapturarAbono::grabarTmpCrPrestamo()
{
	char cLog[500] = { 0 };
	bool bResultado = false;
	char cSql[100] = { 0 };

	sprintf_s(cLog, "FC0200805021521618 - entra - grabarTmpCrPrestamo");
	grabarLog(cLog);

	grabarLog("grabarTmpCrPrestamo::grabando prestamo en cartera");

	sprintf_s(cSql, "SELECT crgrabartmpcrprestamoscrprestamos01('%d','%ld','%d','%d','%d') ", iFlagCrPrestamo, lNumeroRecibo, m_grid.iCaja, m_grid.iTienda, iSistema);

	CMaximo flagCoppel(&odbc_1, false);
	if (flagCoppel.Exec(cSql))
	{
		flagCoppel.activarCols();
		if (flagCoppel.Leer())
		{
			bResultado = true;
		}
	}
	else
	{
		//Se obtiene el error
		flagCoppel.odbc->GetLastError(flagCoppel.GetHstmt());
		grabarMensajeError("C", m_grid.iCaja, (LPTSTR)(LPCTSTR)m_grid.sServer, "CapturarAbono", "CDlgCapturarAbono", "grabarTmpCrPrestamo", cSql, m_grid.lEmpleado, "ERROR EN LA CONSULTA(grabartmpcrprestamo)", flagCoppel.odbc, m_grid.iMuestraMsg);
	}
	return  bResultado;
}

bool CDlgCapturarAbono::grabarTmpCrcDeudaBancoppel()
{
	char cLog[500] = { 0 };
	bool bResultado = false;
	char cSql[85] = { 0 };

	sprintf_s(cLog, "FC0200805021521622 - entra - grabarTmpCrcDeudaBancoppel");
	grabarLog(cLog);

	grabarLog("grabarTmpCrcDeudaBancoppel::grabando cuenta de deuda bancoppel en cartera");

	sprintf_s(cSql, "SELECT crgrabartmpcrcdeudabancoppel( '%ld','%d','%d','%d' ) ", lNumeroRecibo, m_grid.iCaja, m_grid.iTienda, iSistema);

	CMaximo flagCoppel(&odbc_1, false);
	if (flagCoppel.Exec(cSql))
	{
		flagCoppel.activarCols();
		if (flagCoppel.Leer())
		{
			bResultado = true;
		}
	}
	else
	{
		//Se obtiene el error
		flagCoppel.odbc->GetLastError(flagCoppel.GetHstmt());
		flagCoppel.Error();
		grabarMensajeError("C", m_grid.iCaja, (LPTSTR)(LPCTSTR)m_grid.sServer, "CapturarAbono", "CDlgCapturarAbono", "grabarTmpCrcDeudaBancoppel", cSql, m_grid.lEmpleado, "ERROR EN LA CONSULTA(grabarTmpCrcDeudaBancoppel)", flagCoppel.odbc, m_grid.iMuestraMsg);
	}
	return  bResultado;
}

bool CDlgCapturarAbono::crearTablasTemporalesTienda()
{
	char cLog[500] = { 0 };
	bool bResultado = false;
	char cSql[50] = { 0 };

	sprintf_s(cLog, "FC0200805021521626 - entra - crearTablasTemporalesTienda");
	grabarLog(cLog);

	grabarLog("crearTablasTemporalesTienda::Creando tablas temporales de tienda");

	sprintf_s(cSql, "SELECT fun_cacreartablastemporalestienda()");

	CMaximo flagCoppel(&odbc);
	if (flagCoppel.Exec(cSql))
	{
		flagCoppel.activarCols();
		if (flagCoppel.Leer())
		{
			bResultado = true;
		}
	}
	else
	{
		//Se obtiene el error
		flagCoppel.odbc->GetLastError(flagCoppel.GetHstmt());
		grabarMensajeError("C", m_grid.iCaja, (LPTSTR)(LPCTSTR)m_grid.sServer, "CapturarAbono", "CDlgCapturarAbono", "fun_cacreartablastemporalestienda", cSql, m_grid.lEmpleado, "ERROR EN LA CONSULTA(fun_cacreartablastemporalestienda)", flagCoppel.odbc, m_grid.iMuestraMsg);
	}
	return  bResultado;
}

void CDlgCapturarAbono::menuSegurosDeVida()
{
	char cLog[500] = { 0 };
	bool bSalir = true;
	CString sTexto, sFolio1, sCantidadSeguros1, sFolio2, sCantidadSeguros2, sFolioBaja, sFlagConyugal1, sFlagConyugal2, sConcepto;
	long lFolio1 = 0L, lFolio2 = 0L;
	long lGteHuella = 0, lRespuesta = -1;
	int iFlagErrorExe = 0, iFlag = 0, iCantSeguro1 = 0, iCantSeguro2 = 0, iFlagConyugal1 = 0, iFlagConyugal2 = 0,
		iPosFolio1 = 0, iPosFolio2 = 0;

	char cNombreProyecto[100] = { 0 }, cNombreFuncionDLL[10] = { 0 }, cInputParam1[1024] = { 0 }, cInputParam2[1024] = { 0 }, cOutputParam1[1024] = { 0 }, cOutputParam2[1024] = { 0 };
	SParametros parametros;
	memset(&parametros, 0, sizeof(SParametros));

	sprintf_s(cLog, "FC0200805021521630 - entra - menuSegurosDeVida");
	grabarLog(cLog);

	datosSeguro(lFolio1, lFolio2, iCantSeguro1, iCantSeguro2, iFlagConyugal1, iFlagConyugal2, iPosFolio1, iPosFolio2);
	sFolio1.Format("%ld", lFolio1);
	sCantidadSeguros1.Format("%d", iCantSeguro1);
	sFolio2.Format("%ld", lFolio2);
	sCantidadSeguros2.Format("%d", iCantSeguro2);
	sFlagConyugal1.Format("%d", iFlagConyugal1);
	sFlagConyugal2.Format("%d", iFlagConyugal2);

	{
		while (bSalir)
		{
			char * opciones[] = {
				"       F1   Documentos para tramite    ",
				"       F2   Cambios de Folio           ",
				"       F3   Bajas de folio             ",
				"       Esc  Salir                      ",
				"" };

			int respuesta[] = { F1,F2,F3,ESC,0 };

			C_Menu menu(" SEGUROS DE VIDA ", opciones, respuesta);
			switch (menu.OpcionSeleccionada())
			{
			case F1:
				{
					// ReporteDoctoSeguroAfirme
					memset(&parametros, 0, sizeof(SParametros));

					parametros.iLink = generarLink();
					sprintf_s(parametros.sServer, "%s", (LPCTSTR)m_grid.sServer);
					parametros.iTienda = m_grid.iTienda;
					parametros.lEmpleado = m_grid.lEmpleado;
					parametros.iCajaActual = m_grid.iCaja;
					parametros.iMuestraMsg = m_grid.iMuestraMsg;

					parametros.lCliente = m_grid.lCliente;
					parametros.lCodigo1 = atol(sFolio1);
					parametros.lCodigo2 = atol(sFolio2);

					memcpy(cInputParam1, &parametros, sizeof(SParametros));

					// Ruta del archivo DLL a ejecutar
					nombreArchivo("CA0068.DLL", cNombreProyecto, DIRECTORIO_CA);

					// Nombre de la función principal en el DLL
					sprintf_s(cNombreFuncionDLL, "CA0068");

					CargarDLL cargarDll(cNombreProyecto, cNombreFuncionDLL, cInputParam1, cInputParam2);
					iRegresaDll = cargarDll.getResultado();

					if (iRegresaDll <= 0)
					{
						AfxMessageBox("Error al cargar el programa CA0068", MB_ICONERROR);
					}
				}
				break;

			case F2:
				if (checarClaveGerente() != 1)
				{
					AfxMessageBox("LA HUELLA NO ES DE GERENTE");
				}
				else
				{
					{
						// CapturarBeneficiarioAfirme
						if (lFolio1 > 0)
						{
							iFlagMesUltimoMovimiento = 1;

							memset(&parametros, 0, sizeof(SParametros));

							parametros.iLink = generarLink();
							sprintf_s(parametros.sServer, "%s", (LPCTSTR)m_grid.sServer);
							parametros.iTienda = m_grid.iTienda;
							parametros.lEmpleado = m_grid.lEmpleado;
							parametros.iCajaActual = m_grid.iCaja;
							parametros.iMuestraMsg = m_grid.iMuestraMsg;

							parametros.lCliente = m_grid.lCliente; //Cliente
							parametros.lFolioSeguro = atol(sFolio1); //Folio
							parametros.iFlagEtiqueta = atoi(sCantidadSeguros1); //Numero de Seguros
							parametros.iFlagEtiqNuevas = atoi(sFlagConyugal1); //Flag conyugal

							memcpy(cInputParam1, &parametros, sizeof(SParametros));

							// Ruta del archivo DLL a ejecutar
							nombreArchivo("CA0076.DLL", cNombreProyecto, DIRECTORIO_CA);

							// Nombre de la función principal en el DLL
							sprintf_s(cNombreFuncionDLL, "CA0076");

							CargarDLL cargarDll(cNombreProyecto, cNombreFuncionDLL, cInputParam1, cInputParam2, cOutputParam1, cOutputParam2);
							iRegresaDll = cargarDll.getResultado();
							lFolio1 = atol(cOutputParam1);
							if (iRegresaDll <= 0)
							{
								AfxMessageBox("Error al cargar el programa CA0076.DLL", MB_ICONERROR);
							}
							else
							{
								if (lFolio1 > 0)
								{
									sTexto.Format("%ld", lFolio1);
									m_grid.QuickSetText(iPosFolio1, 1, sTexto);
									m_grid.RedrawCell(iPosFolio1, 1);
								}
							}
						}

						if (lFolio2 > 0)
						{
							iFlagMesUltimoMovimiento = 1;
							memset(&parametros, 0, sizeof(SParametros));

							parametros.iLink = generarLink();
							sprintf_s(parametros.sServer, "%s", (LPCTSTR)m_grid.sServer);
							parametros.iTienda = m_grid.iTienda;
							parametros.lEmpleado = m_grid.lEmpleado;
							parametros.iCajaActual = m_grid.iCaja;
							parametros.iMuestraMsg = m_grid.iMuestraMsg;

							parametros.lCliente = m_grid.lCliente; // Cliente
							parametros.lFolioSeguro = atol(sFolio2); // Folio
							parametros.iFlagEtiqueta = atoi(sCantidadSeguros2); // Numero de Seguros
							parametros.iFlagEtiqNuevas = atoi(sFlagConyugal2); // Flag conyugal

							memcpy(cInputParam1, &parametros, sizeof(SParametros));

							// Ruta del archivo DLL a ejecutar
							nombreArchivo("CA0076.DLL", cNombreProyecto, DIRECTORIO_CA);

							// Nombre de la función principal en el DLL
							sprintf_s(cNombreFuncionDLL, "CA0076");

							CargarDLL cargarDll(cNombreProyecto, cNombreFuncionDLL, cInputParam1, cInputParam2, cOutputParam1, cOutputParam2);
							iRegresaDll = cargarDll.getResultado();
							lFolio2 = atol(cOutputParam1);
							if (iRegresaDll <= 0)
							{
								AfxMessageBox("Error al cargar el programa CA0076.dll", MB_ICONERROR);
							}
							else
							{
								if (lFolio2 > 0)
								{
									sTexto.Format("%ld", lFolio2);
									m_grid.QuickSetText(iPosFolio2, 1, sTexto);
									m_grid.RedrawCell(iPosFolio2, 1);
								}
							}
						}
					}
				}
				break;
			case F3:
				{
					validarHuellaEmpleadoGte01(&odbc, lGteHuella, 1, 2, 0L, m_grid.iTienda, iSistema, m_grid.iCaja, "CA0030");//gnwSuplirHuellaGerente.cpp
					if (lGteHuella == -1)
					{
						memset(&parametros, 0, sizeof(SParametros));

						parametros.iLink = generarLink();
						sprintf_s(parametros.sServer, "%s", (LPCTSTR)m_grid.sServer);
						parametros.iTienda = m_grid.iTienda;
						parametros.lEmpleado = m_grid.lEmpleado;
						parametros.iCajaActual = m_grid.iCaja;
						parametros.iMuestraMsg = m_grid.iMuestraMsg;

						parametros.iNumSistema = iSistema;

						memcpy(cInputParam1, &parametros, sizeof(SParametros));

						// Ruta del archivo DLL a ejecutar
						nombreArchivo("GN0055.DLL", cNombreProyecto, DIRECTORIO_GN);

						// Nombre de la función principal en el DLL
						sprintf_s(cNombreFuncionDLL, "GN0055");

						CargarDLL cargarDll(cNombreProyecto, cNombreFuncionDLL, cInputParam1, cInputParam2, cOutputParam1, cOutputParam2);
						iRegresaDll = cargarDll.getResultado();
						lRespuesta = atol(cOutputParam1);
						if (iRegresaDll <= 0)
						{
							iFlagErrorExe = 1;
							AfxMessageBox("Error al cargar el programa GN0055.dll", MB_ICONERROR);
						}
						else
						{
							lGteHuella = lRespuesta;
							if (lGteHuella == 2) // No hay conexión
								iFlagErrorExe = 1;
						}
					}

					if (lGteHuella > 15)
					{
						memset(&parametros, 0, sizeof(SParametros));

						parametros.iLink = generarLink();
						sprintf_s(parametros.sServer, "%s", (LPCTSTR)m_grid.sServer);
						parametros.iTienda = m_grid.iTienda;
						parametros.lEmpleado = m_grid.lEmpleado;
						parametros.iCajaActual = m_grid.iCaja;
						parametros.iMuestraMsg = m_grid.iMuestraMsg;

						parametros.lCliente = m_grid.lCliente;
						parametros.lCodigo1 = atol(sFolio1);
						parametros.lCodigo2 = atol(sFolio2);

						memcpy(cInputParam1, &parametros, sizeof(SParametros));

						// Ruta del archivo DLL a ejecutar
						nombreArchivo("CA0070.DLL", cNombreProyecto, DIRECTORIO_CA);

						// Nombre de la función principal en el DLL
						sprintf_s(cNombreFuncionDLL, "CA0070");

						CargarDLL cargarDll(cNombreProyecto, cNombreFuncionDLL, cInputParam1, cInputParam2, cOutputParam1, cOutputParam2);
						iRegresaDll = cargarDll.getResultado();

						iFlag = atoi(cOutputParam1);
						//se dio de baja el folio 1
						if (iFlag == 1)
						{
							m_grid.QuickSetText(iPosFolio1, -1, "SEGUROCAN");
							m_grid.QuickSetAlignment(iPosFolio1, -1, UG_ALIGNCENTER);
							m_grid.RedrawCell(iPosFolio1, -1);

							m_grid.QuickSetText(iPosFolio1, 1, "000000");
							m_grid.QuickSetAlignment(iPosFolio1, 1, UG_ALIGNCENTER);
							m_grid.RedrawCell(iPosFolio1, 1);

							m_grid.QuickSetText(iPosFolio1, 12, "0");
							m_grid.QuickSetAlignment(iPosFolio1, 12, UG_ALIGNCENTER);
							m_grid.RedrawCell(iPosFolio1, 12);

						}
						//se dio de baja el folio 2
						if (iFlag == 2)
						{
							m_grid.QuickSetText(iPosFolio2, -1, "SEGUROCAN");
							m_grid.QuickSetAlignment(iPosFolio2, -1, UG_ALIGNCENTER);
							m_grid.RedrawCell(iPosFolio2, -1);

							m_grid.QuickSetText(iPosFolio2, 1, "000000");
							m_grid.QuickSetAlignment(iPosFolio1, 2, UG_ALIGNCENTER);
							m_grid.RedrawCell(iPosFolio2, 1);

							m_grid.QuickSetText(iPosFolio2, 12, "0");
							m_grid.QuickSetAlignment(iPosFolio2, 12, UG_ALIGNCENTER);
							m_grid.RedrawCell(iPosFolio2, 12);

						}
						if (iFlag < 0)
						{
							AfxMessageBox("Error al cargar el programa CA0070", MB_ICONERROR);
						}
					}
					else
					{
						if (iFlagErrorExe == 0)
						{
							pintarMensajesErrorPasstda(lGteHuella);
						}
					}
				}
				break;

			case ESC:
				bSalir = false;
				break;
			default:
				break;
			}
		}
	}
}

void CDlgCapturarAbono::datosSeguro(long &lFolio1, long &lFolio2, int &iCantSeguro1, int &iCantSeguro2, int &iFlagConyugal1, int &iFlagConyugal2, int &iPosFolio1, int &iPosFolio2)
{
	char cLog[500] = { 0 };
	int i = 0, iContSeguros = 0;
	CString sConcepto, sFactura, sCantSeguros, sFlagConyugal;
	char cTxt[30] = { 0 };

	lFolio1 = 0L;
	lFolio2 = 0L;
	iCantSeguro1 = 0;
	iCantSeguro2 = 0;
	iFlagConyugal1 = 0;
	iFlagConyugal2 = 0;

	sprintf_s(cLog, "FC0200805021521637 - entra - datosSeguro");
	grabarLog(cLog);

	for (i = 0; i < iTotalCuentas; i++)
	{
		m_grid.QuickGetText(i, -1, &sConcepto);
		sConcepto.Trim();
		sprintf_s(cTxt, "%s", (LPCTSTR)sConcepto);

		if (memcmp(cTxt, "SEGURO", 6) == 0)
		{
			m_grid.QuickGetText(i, 1, &sFactura);
			m_grid.QuickGetText(i, 22, &sCantSeguros);
			m_grid.QuickGetText(i, 24, &sFlagConyugal);

			if (iContSeguros == 0)
			{
				lFolio1 = atol(sFactura);
				iCantSeguro1 = atoi(sCantSeguros);
				iFlagConyugal1 = atoi(sFlagConyugal);
				iPosFolio1 = i;
			}
			if (iContSeguros != 0)
			{
				lFolio2 = atol(sFactura);
				iCantSeguro2 = atoi(sCantSeguros);
				iFlagConyugal2 = atoi(sFlagConyugal);
				iPosFolio2 = i;
			}
			iContSeguros++;
		}
	}
}

//grabar pago de servicios
bool CDlgCapturarAbono::grabarPagoServicio()
{
	char cLog[500] = { 0 };
	bool bResultado = true, bContinuar = true;
	int iModo = 0, iTipoOperacion = 0, iRegistros = 0, iTipoPago = 0;
	CString sAuxiliar;
	char cContrato[255] = { 0 }, cImporte[255] = { 0 }, cSql[255] = { 0 };
	long lRespuesta = 0L;
	char cIpTienda[22] = { 0 };
	char cClaveServicio;
	long lTotalServicio = 0L;
	long lReciboServicio = 0L;

	sprintf_s(cLog, "FC0200805021521641 - entra - grabarPagoServicio");
	grabarLog(cLog);

	if (iFlagCapturoServicio == 1)
	{
		grabarLog("grabarPagoServicio::grabando pago de servicios");

		obtenerTotalGlobalServicio(iCajaActual, lTotalGlobalServicios);

		sprintf_s(cIpTienda, "%s", (LPCTSTR)m_grid.sServer);

		sprintf_s(cSql, "SELECT ccontratocfe,cimportecfe,iflagcfe,iregistroscfe,ccontratotelmex,cimportetelmex,iflagtelmex,iregistrostelmex,irespuesta from cagrabarpagoservicio( '%d','%d','%s','%s','%s' )", m_grid.iCaja, m_grid.iTienda, cIpServidorCFE, cIpServidorTelmex, cIpServidorCentral);

		CGrabarPagoServicio grabarPagoServicio(&odbc, false);

		if (grabarPagoServicio.Exec(cSql))
		{
			grabarPagoServicio.activarCols();
			if (grabarPagoServicio.Leer())
			{
				if (grabarPagoServicio.irespuesta == 1)
				{
					if (grabarPagoServicio.iflagcfe == 1)
					{
						iModo = 0;
						iTipoOperacion = 1;
						sAuxiliar.Format("%s", grabarPagoServicio.ccontratocfe);
						sAuxiliar.Trim();
						sprintf_s(cContrato, "%s", (LPCTSTR)sAuxiliar);
						sAuxiliar.Format("%s", grabarPagoServicio.cimportecfe);
						sAuxiliar.Trim();
						sprintf_s(cImporte, "%s", (LPCTSTR)sAuxiliar);
						iRegistros = grabarPagoServicio.iregistroscfe;
						cClaveServicio = 'W';
						obtenerTotalServicio(cClaveServicio, iCajaActual, lTotalServicio);

						obtenerFolioServicio(lReciboServicio, 'W', ' ');

						if (!grabarPSservicioAbono(&odbc, iTipoOperacion, m_grid.iCaja, cContrato, cImporte, iRegistros, iModo, lRespuesta, cClaveServicio, lTotalServicio, cSql, iTipoPago, cIpTienda, lReciboServicio) == true)
						{
							bContinuar = false;
						}
					}

					if (grabarPagoServicio.iflagtelmex == 1 && bContinuar)
					{
						iModo = 0;
						iTipoOperacion = 2;
						sAuxiliar.Format("%s", grabarPagoServicio.ccontratotelmex);
						sAuxiliar.Trim();
						sprintf_s(cContrato, "%s", (LPCTSTR)sAuxiliar);
						sAuxiliar.Format("%s", grabarPagoServicio.cimportetelmex);
						sAuxiliar.Trim();
						sprintf_s(cImporte, "%s", (LPCTSTR)sAuxiliar);
						cClaveServicio = 'F';
						obtenerTotalServicio(cClaveServicio, iCajaActual, lTotalServicio);
						obtenerFolioServicio(lReciboServicio, 'F', ' ');
						iRegistros = grabarPagoServicio.iregistrostelmex;
						if (!grabarPSservicioAbono(&odbc, iTipoOperacion, m_grid.iCaja, cContrato, cImporte, iRegistros, iModo, lRespuesta, cClaveServicio, lTotalServicio, cSql, iTipoPago, cIpTienda, lReciboServicio) == true)
						{
							bContinuar = false;
						}
					}
				}
			}
		}
		else
		{
			//Se obtiene el error
			grabarPagoServicio.odbc->GetLastError(grabarPagoServicio.GetHstmt());
			grabarMensajeError("C", m_grid.iCaja, (LPTSTR)(LPCTSTR)m_grid.sServer, "CapturarAbono", "CDlgCapturarAbono", "grabarPagoServicio", cSql, m_grid.lEmpleado, "ERROR EN LA CONSULTA(grabarpagoservicio)", grabarPagoServicio.odbc, m_grid.iMuestraMsg);
			bContinuar = false;
		}
	}
	return  bContinuar;
}

//hasta aqui

//imprimir recibo pago de servicios
void CDlgCapturarAbono::imprimirReciboPagoServicios(char *cImagen, long lImporteServicio)
{
	char cLog[500] = { 0 };
	int  i, iPagina, iLinea, iEsSeguro = 0, iEsClub = 0,
		iCuenta1 = 0, iCuenta2 = 0, iCuenta3 = 0, iContadorSeguros = 0,
		iDiaVencimientoX = 0, iMesVencimientoX = 0, iAnioVencimientoX = 0, iNumeroMesesX = 0,
		iIndicadorSeguro = 0,
		iFlagNoDebeServicio = 0L, iFlagAnexo = 0, iAnioVencCrSeguros = 0, iNumCtas = 0;

	long lAcumuladoServicio = 0L, lSuPagoServicio = 0L, lUstedDebiaServicio = 0L,
		lReciboServicio = 0L, lEntregoServicio = 0L,
		lAbonoTotalServicio = 0L, lInteresTotalServicio = 0L, lDebeTotalServicio = 0L, lVencidoTotalServicio = 0L,
		lSaldaConTotalServicio = 0L, lTotalAPagarServicio = 0L;

	CString sTexto;
	char cTxt[80] = { 0 }, cConstante[80] = { 0 }, cClave[5] = { 0 };

	sprintf_s(cLog, "FC0200805021521646 - entra - imprimirReciboPagoServicios");
	grabarLog(cLog);

	iPagina = 2; iLinea = 2;
	lUstedDebiaServicio = 0L;

	C_FormasPCL hoja(22, 270, cImagen, iFinLinea, iTipoImpresora, 1);

	m_mensaje.SetWindowText(" IMPRIMIENDO RECIBO PAGO DE SERVICIOS ");

	for (i = 0; i < iTotalCuentas; i++)
	{
		m_grid.QuickGetText(i, 4, &sTexto);
		sTexto.Trim();
		sprintf_s(cTxt, "%s", (LPCTSTR)sTexto);
		iMesVencimientoX = obtenerMes(cTxt);
		iAnioVencimientoX = ano_2000_4dig((int)valor_campo(&cTxt[5], 2), iAnioActual);
		iDiaVencimientoX = valor_campo(&cTxt[0], 2);

		m_grid.QuickGetText(i, 23, &sTexto);
		iNumeroMesesX = atol(sTexto);

		m_grid.QuickGetText(i, -1, &sTexto);
		sTexto.Trim();
		sprintf_s(cTxt, "%s", (LPCTSTR)sTexto);

		if (memcmp(cTxt, "SEGURO", 6) == 0 || memcmp(cTxt, "P.FAMILIAR", 10) == 0)
		{
			iEsSeguro = 1;
			if (memcmp(cTxt, "P.FAMILIAR", 10) == 0)
			{
				iEsClub = 1;
			}
			else
			{
				iEsClub = 0;
			}
		}
		else
		{
			iEsSeguro = 0;
		}

		if (iEsSeguro == 1)
		{
			++iContadorSeguros;
			if (iCuenta1 == 0)
			{
				iCuenta1 = i;
			}
			else
			{
				if (iCuenta2 == 0)
				{
					iCuenta2 = i;
				}
				else
				{
					iCuenta3 = i;
				}
			}
			if (iEsClub != 1)
			{
				if (iNumeroMesesX != 0)
				{
					//cawvense.cpp
					//calcularFechaVencimientoSeguroAfirme( iNumeroMeses,iDiaVencimientoX,iMesVencimientoX,iAnioVencimientoX,iDiaActual,iMesActual,iAnioActual );
					bBanderaSeguroVigente = true;
				}
			}
		}
	}
	lTotalAPagarServicio = lTotalAPagar;
	lEntregoServicio = lPagoCliente - (lTotalAPagarServicio - lImporteServicio);
	lAcumuladoServicio = lConsultaAcumulado - lImporteServicio;

	// pagos de agua
	if (iCuentasAgua > 0)
	{
		cClave[0] = 'A';
		cClave[1] = 0;
		imprimirPagoServicios(hoja, iLinea, iPagina, iContadorSeguros, cClave, lUstedDebiaServicio, cConstante, lImporteServicio, lSuPagoServicio, lReciboServicio, iFlagAnexo, lAcumuladoServicio, " ");

		totalesRecibo(hoja, iPagina, iLinea,
			lAcumuladoServicio, iFlagServicio, lUstedDebiaServicio,
			iContadorSeguros, iFlagAnexo, iFlagNoDebeServicio,
			iCuenta1, iCuenta2, iCuenta3, iIndicadorSeguro,
			lAbonoTotalServicio, lInteresTotalServicio, lDebeTotalServicio,
			lVencidoTotalServicio, lSaldaConTotalServicio,
			lSuPagoServicio, lEntregoServicio, lReciboServicio);
		lEntregoServicio -= lSuPagoServicio;
		lSuPagoServicio = 0L;
	}

	// pagos de Telefono
	if (iCuentasTelefono > 0)
	{
		cClave[0] = 'F';
		cClave[1] = 0;
		imprimirPagoServicios(hoja, iLinea, iPagina, iContadorSeguros, cClave, lUstedDebiaServicio, cConstante, lImporteServicio, lSuPagoServicio, lReciboServicio, iFlagAnexo, lAcumuladoServicio, " ");

		totalesRecibo(hoja, iPagina, iLinea,
			lAcumuladoServicio, iFlagServicio, lUstedDebiaServicio,
			iContadorSeguros, iFlagAnexo, iFlagNoDebeServicio,
			iCuenta1, iCuenta2, iCuenta3, iIndicadorSeguro,
			lAbonoTotalServicio, lInteresTotalServicio, lDebeTotalServicio,
			lVencidoTotalServicio, lSaldaConTotalServicio,
			lSuPagoServicio, lEntregoServicio, lReciboServicio);
		lEntregoServicio -= lSuPagoServicio;
		lSuPagoServicio = 0L;
	}
	// pagos de predial
	if (iCuentasPredial > 0)
	{
		cClave[0] = 'V';
		cClave[1] = 0;
		imprimirPagoServicios(hoja, iLinea, iPagina, iContadorSeguros, cClave, lUstedDebiaServicio, cConstante, lImporteServicio, lSuPagoServicio, lReciboServicio, iFlagAnexo, lAcumuladoServicio, " ");

		totalesRecibo(hoja, iPagina, iLinea,
			lAcumuladoServicio, iFlagServicio, lUstedDebiaServicio,
			iContadorSeguros, iFlagAnexo, iFlagNoDebeServicio,
			iCuenta1, iCuenta2, iCuenta3, iIndicadorSeguro,
			lAbonoTotalServicio, lInteresTotalServicio, lDebeTotalServicio,
			lVencidoTotalServicio, lSaldaConTotalServicio,
			lSuPagoServicio, lEntregoServicio, lReciboServicio);
		lEntregoServicio -= lSuPagoServicio;
		lSuPagoServicio = 0L;
	}
	// pagos de sofol
	if (iCuentasSofol > 0)
	{
		cClave[0] = 'B';
		cClave[1] = 0;
		imprimirPagoServicios(hoja, iLinea, iPagina, iContadorSeguros, cClave, lUstedDebiaServicio, cConstante, lImporteServicio, lSuPagoServicio, lReciboServicio, iFlagAnexo, lAcumuladoServicio, " ");

		totalesRecibo(hoja, iPagina, iLinea,
			lAcumuladoServicio, iFlagServicio, lUstedDebiaServicio,
			iContadorSeguros, iFlagAnexo, iFlagNoDebeServicio,
			iCuenta1, iCuenta2, iCuenta3, iIndicadorSeguro,
			lAbonoTotalServicio, lInteresTotalServicio, lDebeTotalServicio,
			lVencidoTotalServicio, lSaldaConTotalServicio,
			lSuPagoServicio, lEntregoServicio, lReciboServicio);
		lEntregoServicio -= lSuPagoServicio;
		lSuPagoServicio = 0L;
	}
	// pagos de gas
	if (iCuentasGas > 0)
	{
		cClave[0] = 'G';
		cClave[1] = 0;
		imprimirPagoServicios(hoja, iLinea, iPagina, iContadorSeguros, cClave, lUstedDebiaServicio, cConstante, lImporteServicio, lSuPagoServicio, lReciboServicio, iFlagAnexo, lAcumuladoServicio, " ");

		totalesRecibo(hoja, iPagina, iLinea,
			lAcumuladoServicio, iFlagServicio, lUstedDebiaServicio,
			iContadorSeguros, iFlagAnexo, iFlagNoDebeServicio,
			iCuenta1, iCuenta2, iCuenta3, iIndicadorSeguro,
			lAbonoTotalServicio, lInteresTotalServicio, lDebeTotalServicio,
			lVencidoTotalServicio, lSaldaConTotalServicio,
			lSuPagoServicio, lEntregoServicio, lReciboServicio);
		lEntregoServicio -= lSuPagoServicio;
		lSuPagoServicio = 0L;
	}

	// pagos de Megacable

	if (iCuentasMegacable > 0)
	{
		cClave[0] = 'M';
		cClave[1] = 0;
		imprimirPagoServicios(hoja, iLinea, iPagina, iContadorSeguros, cClave, lUstedDebiaServicio, cConstante, lImporteServicio, lSuPagoServicio, lReciboServicio, iFlagAnexo, lAcumuladoServicio, " ");

		totalesRecibo(hoja, iPagina, iLinea,
			lAcumuladoServicio, iFlagServicio, lUstedDebiaServicio,
			iContadorSeguros, iFlagAnexo, iFlagNoDebeServicio,
			iCuenta1, iCuenta2, iCuenta3, iIndicadorSeguro,
			lAbonoTotalServicio, lInteresTotalServicio, lDebeTotalServicio,
			lVencidoTotalServicio, lSaldaConTotalServicio,
			lSuPagoServicio, lEntregoServicio, lReciboServicio);
		lEntregoServicio -= lSuPagoServicio;
		lSuPagoServicio = 0L;
	}
	//pagos de NEXTEL
	if (iCuentasNextel > 0)
	{
		cClave[0] = 'K';
		cClave[1] = 0;
		imprimirPagoServicios(hoja, iLinea, iPagina, iContadorSeguros, cClave, lUstedDebiaServicio, cConstante, lImporteServicio, lSuPagoServicio, lReciboServicio, iFlagAnexo, lAcumuladoServicio, " ");

		totalesRecibo(hoja, iPagina, iLinea,
			lAcumuladoServicio, iFlagServicio, lUstedDebiaServicio,
			iContadorSeguros, iFlagAnexo, iFlagNoDebeServicio,
			iCuenta1, iCuenta2, iCuenta3, iIndicadorSeguro,
			lAbonoTotalServicio, lInteresTotalServicio, lDebeTotalServicio,
			lVencidoTotalServicio, lSaldaConTotalServicio,
			lSuPagoServicio, lEntregoServicio, lReciboServicio);
		lEntregoServicio -= lSuPagoServicio;
		lSuPagoServicio = 0L;
	}

	//pagos de Alestra
	if (iCuentasAlestra > 0)
	{
		cClave[0] = 'Q';
		cClave[1] = 0;
		imprimirPagoServicios(hoja, iLinea, iPagina, iContadorSeguros, cClave, lUstedDebiaServicio, cConstante, lImporteServicio, lSuPagoServicio, lReciboServicio, iFlagAnexo, lAcumuladoServicio, " ");

		totalesRecibo(hoja, iPagina, iLinea,
			lAcumuladoServicio, iFlagServicio, lUstedDebiaServicio,
			iContadorSeguros, iFlagAnexo, iFlagNoDebeServicio,
			iCuenta1, iCuenta2, iCuenta3, iIndicadorSeguro,
			lAbonoTotalServicio, lInteresTotalServicio, lDebeTotalServicio,
			lVencidoTotalServicio, lSaldaConTotalServicio,
			lSuPagoServicio, lEntregoServicio, lReciboServicio);
		lEntregoServicio -= lSuPagoServicio;
		lSuPagoServicio = 0L;
	}
	// Pago de CFE
	if (iCuentasCfe > 0)
	{
		cClave[0] = 'W';
		cClave[1] = 0;
		imprimirPagoServicios(hoja, iLinea, iPagina, iContadorSeguros, cClave, lUstedDebiaServicio, cConstante, lImporteServicio, lSuPagoServicio, lReciboServicio, iFlagAnexo, lAcumuladoServicio, " ");

		totalesRecibo(hoja, iPagina, iLinea,
			lAcumuladoServicio, iFlagServicio, lUstedDebiaServicio,
			iContadorSeguros, iFlagAnexo, iFlagNoDebeServicio,
			iCuenta1, iCuenta2, iCuenta3, iIndicadorSeguro,
			lAbonoTotalServicio, lInteresTotalServicio, lDebeTotalServicio,
			lVencidoTotalServicio, lSaldaConTotalServicio,
			lSuPagoServicio, lEntregoServicio, lReciboServicio);
		lEntregoServicio -= lSuPagoServicio;
		lSuPagoServicio = 0L;
	}
	// Pago de AXTEL
	if (iCuentasAxtel > 0)
	{
		cClave[0] = 'U';
		cClave[1] = 0;
		imprimirPagoServicios(hoja, iLinea, iPagina, iContadorSeguros, cClave, lUstedDebiaServicio, cConstante, lImporteServicio, lSuPagoServicio, lReciboServicio, iFlagAnexo, lAcumuladoServicio, " ");

		totalesRecibo(hoja, iPagina, iLinea,
			lAcumuladoServicio, iFlagServicio, lUstedDebiaServicio,
			iContadorSeguros, iFlagAnexo, iFlagNoDebeServicio,
			iCuenta1, iCuenta2, iCuenta3, iIndicadorSeguro,
			lAbonoTotalServicio, lInteresTotalServicio, lDebeTotalServicio,
			lVencidoTotalServicio, lSaldaConTotalServicio,
			lSuPagoServicio, lEntregoServicio, lReciboServicio);
		lEntregoServicio -= lSuPagoServicio;
		lSuPagoServicio = 0L;
	}

	if (iCuentasCablemas > 0)
	{
		cClave[0] = 'Q';
		cClave[1] = 0;
		imprimirPagoServicios(hoja, iLinea, iPagina, iContadorSeguros, cClave, lUstedDebiaServicio, cConstante, lImporteServicio, lSuPagoServicio, lReciboServicio, iFlagAnexo, lAcumuladoServicio, "1");

		totalesRecibo(hoja, iPagina, iLinea,
			lAcumuladoServicio, iFlagServicio, lUstedDebiaServicio,
			iContadorSeguros, iFlagAnexo, iFlagNoDebeServicio,
			iCuenta1, iCuenta2, iCuenta3, iIndicadorSeguro,
			lAbonoTotalServicio, lInteresTotalServicio, lDebeTotalServicio,
			lVencidoTotalServicio, lSaldaConTotalServicio,
			lSuPagoServicio, lEntregoServicio, lReciboServicio);
		lEntregoServicio -= lSuPagoServicio;
		lSuPagoServicio = 0L;
	}
}

void CDlgCapturarAbono::totalesRecibo(C_FormasPCL &hoja, int iPagina, int iLinea,
									  long lAcumuladoServicio, int iFlagServicio,
									  long &lUstedDebiaServicio, int iContadorSeguros, int iFlagAnexo,
									  int iFlagNoDebeServicio, int iCuenta1, int iCuenta2, int iCuenta3, int iIndicadorSeguro, long lAbonoTotalServicio,
									  long lInteresTotalServicio, long lDebeTotalServicio, long lVencidoTotalServicio, long lSaldaConTotalServicio,
									  long lSuPagoServicio, long lEntregoServicio, long lReciboServicio)
{
	char cLog[500] = { 0 };
	char cConstante[80] = { 0 }, cRespuesta[80] = { 0 };
	long lCambioServicio = 0L;
	int  iRen = 0;

	sprintf_s(cLog, "FC0200805021521653 - entra - totalesRecibo");
	grabarLog(cLog);

	if (m_grid.lCliente > 0)
	{
		determinaMensajeRecibo(cConstante, iFlagNoDebeServicio);
	}
	else
	{
		memset(cConstante, 0, 62);
		cConstante[60] = 0;
	}
	if (iLinea > 0)
	{
		if (iContadorSeguros == 0)
		{
			if (iFlagBanorte == 0)
			{
				hoja.poner("PROTEJA A SU FAMILIA, ADQUIERA YA SU SEGURO DE VIDA", 12, 20);
			}
		}

		if (iContadorSeguros != 0)
		{
			verificarVigenciaSeguros(iCuenta1, iCuenta2, iCuenta3, iContadorSeguros, hoja, iIndicadorSeguro, iFlagServicio);
		}

		imprimirTotales(hoja, lUstedDebiaServicio, iContadorSeguros, iFlagAnexo);

		if (iContadorSeguros == 3)
		{
			hoja.poner(cConstante, 14, 20);
		}
		else
		{
			hoja.poner(cConstante, 13, 20);
		}

		encabezadoTalonCajasServicio(hoja, iPagina - 1, iContadorSeguros, lReciboServicio);
	}

	if (iContadorSeguros == 0) iRen = 8; else iRen = 8 + iContadorSeguros;
	hoja.poner("TOTALES  :", iRen - 1, 0);
	usingx("###,###", cRespuesta, (double)lUstedDebiaServicio);
	hoja.poner(cRespuesta, iRen - 1, 33);
	usingx("###,###", cRespuesta, (double)lAbonoTotalServicio);
	hoja.poner(cRespuesta, iRen - 1, 42);
	usingx("###,###", cRespuesta, (double)lInteresTotalServicio);
	hoja.poner(cRespuesta, iRen - 1, 51);
	usingx("###,###", cRespuesta, (double)lDebeTotalServicio);
	hoja.poner(cRespuesta, iRen - 1, 59);
	usingx("###,###", cRespuesta, (double)lVencidoTotalServicio);
	hoja.poner(cRespuesta, iRen - 1, 68);
	usingx("###,###", cRespuesta, (double)lSaldaConTotalServicio);
	hoja.poner(ENFATIZAR, iRen - 1, 79);
	hoja.poner(cRespuesta, iRen - 1, 79);
	hoja.poner(NO_ENFATIZAR, iRen - 1, 79);
	hoja.poner("ENTREGO  :", iRen, 0);
	usingx("###,###.##", cRespuesta, (double)lEntregoServicio);
	hoja.poner(cRespuesta, iRen, 13);
	hoja.poner("SU PAGO :", iRen, 33);

	usingx("###,###.##", cRespuesta, (double)lSuPagoServicio);

	hoja.poner(cRespuesta, iRen, 43);

	lCambioServicio = (lEntregoServicio - lSuPagoServicio);

	hoja.poner("SU CAMBIO :", iRen, 59);
	usingx("###,###.##", cRespuesta, (double)lCambioServicio);
	hoja.poner(cRespuesta, iRen, 78);


	if (m_grid.lCliente == 1708L)
	{
		if (iContadorSeguros != 0) hoja.poner("TOTALES  :", 10, 105);
		else hoja.poner("TOTALES  :", iRen + 2, 105);
	}
	else
	{
		if (iContadorSeguros != 0) hoja.poner("TOTALES  :", 10, 107);
		else hoja.poner("TOTALES  :", iRen + 2, 107);
	}

	usingx("###,###.##", cRespuesta, (double)lSuPagoServicio);
	if (iContadorSeguros != 0) hoja.poner(cRespuesta, 10, 119);
	else hoja.poner(cRespuesta, iRen + 2, 119);

	usingx("###,###.00", cRespuesta, (double)lAcumuladoServicio / 100);

	if (bBanderaSeguroConyugal)
	{
		imprimirDescuentoConyugal();
	}

	compactarImpresion(hoja);

	encabezadoReciboCajas(hoja);

	hoja.poner(SEXTOS, 19, 0);


	if (iFlagTdaConCubrebocas == 1)
	{
		hoja.poner("RECUERDA USAR CUBREBOCAS", 15, 26);
	}
	else if (iFlagTdaConEstacionamiento == 1)
	{
		hoja.poner("ESTACIONAMIENTO EXCLUSIVO PARA CLIENTES", 15, 26);
	}

	hoja.imprimir();
}
//hasta aqui la impresion de los pagos de servicios

bool CDlgCapturarAbono::consultarImportePagoServicio(char *cClave, long &lImporte)
{
	char cLog[500] = { 0 };
	bool bResultado = false;
	char cSql[55] = { 0 };

	sprintf_s(cLog, "FC0200805021521658 - entra - consultarImportePagoServicio");
	grabarLog(cLog);

	sprintf_s(cSql, "SELECT caconsultarimportepagoservicio('%d','%c')", m_grid.iCaja, cClave[0]);

	CMaximo folioCoppel(&odbc);
	if (folioCoppel.Exec(cSql))
	{
		folioCoppel.activarCols();
		if (folioCoppel.Leer())
		{
			lImporte = (long)folioCoppel.Total;
			bResultado = true;
		}
	}
	else
	{
		//Se obtiene el error
		folioCoppel.odbc->GetLastError(folioCoppel.GetHstmt());
		grabarMensajeError("C", m_grid.iCaja, (LPTSTR)(LPCTSTR)m_grid.sServer, "CapturarAbono", "CDlgCapturarAbono", "consultarImportePagoServicio", cSql, m_grid.lEmpleado, "ERROR EN LA CONSULTA(consultarimportepagoservicio)", folioCoppel.odbc, m_grid.iMuestraMsg);
	}
	return  bResultado;
}

bool CDlgCapturarAbono::consultarCuentasPagoServicio(char *cClave, int &iCuentasServicio, char * cTipo)
{
	char cLog[500] = { 0 };
	bool bResultado = false;
	char cSql[65] = { 0 };

	sprintf_s(cLog, "FC0200805021521662 - entra - consultarCuentasPagoServicio");
	grabarLog(cLog);

	if (cClave[0] == 'Q' && cTipo[0] == '1')
	{
		sprintf_s(cSql, "SELECT caconsultarcuentaspagoservicio01('%d','%c','1');", m_grid.iCaja, cClave[0]);
	}
	else
	{
		sprintf_s(cSql, "SELECT caconsultarcuentaspagoservicio01('%d','%c','');", m_grid.iCaja, cClave[0]);
	}

	CMaximo flagCoppel(&odbc);
	if (flagCoppel.Exec(cSql))
	{
		flagCoppel.activarCols();
		if (flagCoppel.Leer())
		{
			iCuentasServicio = (int)flagCoppel.Total;
			bResultado = true;
		}
	}
	else
	{
		//Se obtiene el error
		flagCoppel.odbc->GetLastError(flagCoppel.GetHstmt());
		grabarMensajeError("C", m_grid.iCaja, (LPTSTR)(LPCTSTR)m_grid.sServer, "CapturarAbono", "CDlgCapturarAbono", "consultarCuentasPagoServicio", cSql, m_grid.lEmpleado, "ERROR EN LA CONSULTA(consultarcuentaspagoservicio)", flagCoppel.odbc, m_grid.iMuestraMsg);
	}
	return  bResultado;
}

void CDlgCapturarAbono::imprimirImportePagoServicio(C_FormasPCL &hoja, int iLinea, long lImporte)
{
	char cLog[500] = { 0 };
	char cRespuesta[10] = { 0 };

	sprintf_s(cLog, "FC0200805021521666 - entra - imprimirImportePagoServicio");
	grabarLog(cLog);

	usingx("#####.##", cRespuesta, (double)lImporte);
	hoja.poner(cRespuesta, iLinea, 44);
	hoja.poner(cRespuesta, iLinea, 117);
}

void CDlgCapturarAbono::imprimirPagoServicios(C_FormasPCL &hoja, int &iLinea, int &iPagina, int iContadorSeguros, char *cClave, long &lUstedDebiaServicio, char *cConstante, long &lImporteServicio, long &lSuPagoServicio, long &lReciboServicio, int iFlagAnexo, long &lAcumuladoServicio, char *cTipo)
{
	char cLog[500] = { 0 };
	CString sDato;
	char cSql[245] = { 0 }, cDato[20] = { 0 }, cRespuesta[80] = { 0 };

	sprintf_s(cLog, "FC0200805021521670 - entra - imprimirPagoServicios");
	grabarLog(cLog);

	sprintf_s(cSql, "SELECT clave,tienda,ciudad,caja,recibo,folio,importe,cuenta,ruta,rpu,compania,contrato,fechavencimiento,credito,telefono,efectuo,tipomovimiento from tmpcacarmovservicio where caja = %d AND clave = '%c' AND TRIM(tipomovimiento)=TRIM('%c')", m_grid.iCaja, cClave[0], cTipo[0]);
	CObtenerDatosTmpCaCarmovServicio obtenerDatosTmpCaCarmovServicio(&odbc);
	if (obtenerDatosTmpCaCarmovServicio.Exec(cSql))
	{
		obtenerDatosTmpCaCarmovServicio.activarCols();
		while (obtenerDatosTmpCaCarmovServicio.Leer())
		{
			if (iLinea > 5)
			{
				hoja.poner(cConstante, 13, 20);

				imprimirTotales(hoja, lUstedDebiaServicio, iContadorSeguros, iFlagAnexo);

				encabezadoTalonCajasServicio(hoja, iPagina - 1, iContadorSeguros, lReciboServicio);

				encabezadoReciboCajas(hoja);

				hoja.poner(SEXTOS, 19, 0);

				hoja.imprimir();
				compactarImpresion(hoja);
				iPagina++;
				iLinea = 2;
			}

			if (obtenerDatosTmpCaCarmovServicio.clave[0] == 'A')  //pago de agua
			{
				hoja.poner("PAGO DE AGUA POR", iLinea, 0);
				hoja.poner("PAGO AGUA", iLinea, 105);

				obtenerFolioServicio(lReciboServicio, 'A', ' ');
				if (iFlagJapac == 1)
				{
					imprimirReferenciaJapac(hoja, iLinea);
				}

				lImporteServicio = obtenerDatosTmpCaCarmovServicio.importe;
				lAcumuladoServicio += obtenerDatosTmpCaCarmovServicio.importe;
				lSuPagoServicio += lImporteServicio;
				imprimirImportePagoServicio(hoja, iLinea, lImporteServicio);
				iLinea++;
			}

			if (obtenerDatosTmpCaCarmovServicio.clave[0] == 'F') //pago de telefono
			{
				hoja.poner("PAGO DE TELEFONO DEL NUMERO", iLinea, 0);
				usingx("##########", cRespuesta, (double)obtenerDatosTmpCaCarmovServicio.telefono);
				hoja.poner(cRespuesta, iLinea, 28);
				hoja.poner("POR", iLinea, 39);
				hoja.poner("TEL", iLinea, 105);

				obtenerFolioServicio(lReciboServicio, 'F', ' ');

				lImporteServicio = obtenerDatosTmpCaCarmovServicio.importe;
				lAcumuladoServicio += obtenerDatosTmpCaCarmovServicio.importe;
				lSuPagoServicio += lImporteServicio;
				hoja.poner(cRespuesta, iLinea, 108);

				usingx("#####.##", cRespuesta, (double)lImporteServicio);
				hoja.poner(cRespuesta, iLinea, 44);
				hoja.poner(cRespuesta, iLinea, 117);
				iLinea++;

			}
			if (obtenerDatosTmpCaCarmovServicio.clave[0] == 'V') //pago de predial
			{
				if (iCiudadGnDominio != 4)
				{
					hoja.poner("PAGO DE CABLE POR", iLinea, 0);
					hoja.poner("PAGO CABLE", iLinea, 105);
				}
				else
				{
					hoja.poner("PAGO DE PREDIAL POR", iLinea, 0);
					hoja.poner("PAGO PREDIAL", iLinea, 105);
				}

				obtenerFolioServicio(lReciboServicio, 'V', ' ');

				lImporteServicio = obtenerDatosTmpCaCarmovServicio.importe;
				lAcumuladoServicio += obtenerDatosTmpCaCarmovServicio.importe;
				lSuPagoServicio += lImporteServicio;
				imprimirImportePagoServicio(hoja, iLinea, lImporteServicio);
				iLinea++;
			}

			if (obtenerDatosTmpCaCarmovServicio.clave[0] == 'B') //pago de sofol
			{
				hoja.poner("PAGO DE SOFOL POR", iLinea, 0);
				hoja.poner("PAGO SOFOL", iLinea, 105);

				obtenerFolioServicio(lReciboServicio, 'B', ' ');

				lImporteServicio = obtenerDatosTmpCaCarmovServicio.importe;
				lAcumuladoServicio += obtenerDatosTmpCaCarmovServicio.importe;
				lSuPagoServicio += lImporteServicio;
				imprimirImportePagoServicio(hoja, iLinea, lImporteServicio);
				iLinea++;
			}

			if (obtenerDatosTmpCaCarmovServicio.clave[0] == 'G') //pago de Gas
			{
				hoja.poner("PAGO DE GAS POR", iLinea, 0);
				hoja.poner("PAGO GAS", iLinea, 105);

				obtenerFolioServicio(lReciboServicio, 'G', ' ');

				lImporteServicio = obtenerDatosTmpCaCarmovServicio.importe;
				lAcumuladoServicio += obtenerDatosTmpCaCarmovServicio.importe;
				lSuPagoServicio += lImporteServicio;
				imprimirImportePagoServicio(hoja, iLinea, lImporteServicio);
				iLinea++;
			}

			if (obtenerDatosTmpCaCarmovServicio.clave[0] == 'M') //pago de Megacable
			{
				hoja.poner("PAGO DE MEGACABLE POR", iLinea, 0);
				hoja.poner("PAGO MEGACABLE", iLinea, 103);

				obtenerFolioServicio(lReciboServicio, 'M', ' ');

				//contrato
				hoja.poner(obtenerDatosTmpCaCarmovServicio.contrato, 22, iLinea, 55);
				hoja.poner("MC", iLinea, 103);
				hoja.poner(obtenerDatosTmpCaCarmovServicio.contrato, 22, iLinea, 105);

				lImporteServicio = obtenerDatosTmpCaCarmovServicio.importe;
				lAcumuladoServicio += obtenerDatosTmpCaCarmovServicio.importe;
				lSuPagoServicio += lImporteServicio;

				usingx("#####.##", cRespuesta, (double)lImporteServicio);
				hoja.poner(cRespuesta, iLinea, 42);
				hoja.poner(cRespuesta, iLinea, 130);
				iLinea++;
			}

			if (obtenerDatosTmpCaCarmovServicio.clave[0] == 'K') //pago de Nextel
			{
				hoja.poner("PAGO DE NEXTEL POR", iLinea, 0);
				hoja.poner("PAGO NEXTEL", iLinea, 103);

				obtenerFolioServicio(lReciboServicio, 'K', ' ');

				//cuenta
				hoja.poner(obtenerDatosTmpCaCarmovServicio.cuenta, 20, iLinea, 55);
				hoja.poner("NX", iLinea, 103);
				hoja.poner(obtenerDatosTmpCaCarmovServicio.cuenta, 20, iLinea, 105);

				lImporteServicio = obtenerDatosTmpCaCarmovServicio.importe;
				lAcumuladoServicio += obtenerDatosTmpCaCarmovServicio.importe;
				lSuPagoServicio += lImporteServicio;

				usingx("#####.##", cRespuesta, (double)lImporteServicio);
				hoja.poner(cRespuesta, iLinea, 42);
				hoja.poner(cRespuesta, iLinea, 129); //Cambio: AlonsoV
				iLinea++;
			}

			if (obtenerDatosTmpCaCarmovServicio.clave[0] == 'Q' && obtenerDatosTmpCaCarmovServicio.tipomovimiento[0] == ' ') //pago de Alestra
			{
				hoja.poner("PAGO DE AT&T POR", iLinea, 0);
				hoja.poner("PAGO AT&T", iLinea, 103);

				obtenerFolioServicio(lReciboServicio, 'Q', ' ');

				//cuenta
				hoja.poner(obtenerDatosTmpCaCarmovServicio.cuenta, 10, iLinea, 55);
				hoja.poner("AL", iLinea, 103);
				hoja.poner(obtenerDatosTmpCaCarmovServicio.cuenta, 10, iLinea, 105);
				lImporteServicio = obtenerDatosTmpCaCarmovServicio.importe;
				lAcumuladoServicio += obtenerDatosTmpCaCarmovServicio.importe;
				lSuPagoServicio += lImporteServicio;

				usingx("#####.##", cRespuesta, (double)lImporteServicio);
				hoja.poner(cRespuesta, iLinea, 42);
				hoja.poner(cRespuesta, iLinea, 129);
				iLinea++;
			}

			if (obtenerDatosTmpCaCarmovServicio.clave[0] == 'W') //pago de cfe
			{
				hoja.poner("PAGO DE CFE POR", iLinea, 0);
				hoja.poner("PAGO CFE", iLinea, 103);

				obtenerFolioServicio(lReciboServicio, 'W', ' ');

				//RPU
				hoja.poner(obtenerDatosTmpCaCarmovServicio.rpu, 12, iLinea, 55);
				hoja.poner("AL", iLinea, 103);
				hoja.poner(obtenerDatosTmpCaCarmovServicio.rpu, 12, iLinea, 105);
				lImporteServicio = (long)obtenerDatosTmpCaCarmovServicio.importe;
				lAcumuladoServicio += obtenerDatosTmpCaCarmovServicio.importe;
				lSuPagoServicio += lImporteServicio;

				usingx("#####.##", cRespuesta, (double)lImporteServicio);
				hoja.poner(cRespuesta, iLinea, 42);
				hoja.poner(cRespuesta, iLinea, 128);
				iLinea++;
			}
			if (obtenerDatosTmpCaCarmovServicio.clave[0] == 'U') //pago de axtel
			{

				hoja.poner("PAGO DE AXTEL POR", iLinea, 0);
				hoja.poner("PAGO AXTEL", iLinea, 109);

				obtenerFolioServicio(lReciboServicio, 'U', ' ');

				sDato.Format("%s", obtenerDatosTmpCaCarmovServicio.cuenta);
				sDato.Trim();
				sDato.Format("%s %s-%s", sDato.Left(8), sDato.Mid(8, 8), sDato.Right(1));
				sprintf_s(cDato, "%s", (LPCTSTR)sDato);
				hoja.poner(cDato, iLinea, 55);
				//
				hoja.poner("AXTEL ", iLinea, 103);
				hoja.poner(cDato, iLinea, 109);
				lImporteServicio = obtenerDatosTmpCaCarmovServicio.importe;
				lAcumuladoServicio += obtenerDatosTmpCaCarmovServicio.importe;
				lSuPagoServicio += lImporteServicio;

				usingx("#####.##", cRespuesta, (double)lImporteServicio);
				hoja.poner(cRespuesta, iLinea, 42);
				hoja.poner(cRespuesta, iLinea, 129);//130
				iLinea++;
			}

			if (obtenerDatosTmpCaCarmovServicio.clave[0] == 'Q' && obtenerDatosTmpCaCarmovServicio.tipomovimiento[0] == '1') //pago de Cablemas
			{
				obtenerFolioServicio(lReciboServicio, 'Q', '1');

				sDato.Format("%s", obtenerDatosTmpCaCarmovServicio.credito);
				sDato.Trim();

				sprintf_s(cRespuesta, "%s%s", CString(obtenerDatosTmpCaCarmovServicio.contrato).Trim(), (LPCTSTR)sDato);

				iLinea = 2;

				hoja.poner("PAGO DE SERVICIO CABLEMAS", iLinea, 0);
				hoja.poner("PAGO CABLEMAS", iLinea, 100);

				iLinea += 2;
				hoja.poner("Referencia:", iLinea, 0);
				hoja.poner("Referencia:", iLinea, 100);

				hoja.poner(cRespuesta, iLinea, 12);
				iLinea++;
				hoja.poner(cRespuesta, iLinea, 100);

				lImporteServicio = obtenerDatosTmpCaCarmovServicio.importe;
				lAcumuladoServicio += obtenerDatosTmpCaCarmovServicio.importe;
				lSuPagoServicio += lImporteServicio;

				hoja.poner("Importe: $", iLinea, 0);

				usingx("#####.##", cRespuesta, (double)lImporteServicio);
				hoja.poner(cRespuesta, iLinea, 9);

				iLinea += 2;

				hoja.poner("Importe: $", iLinea, 100);
				hoja.poner(cRespuesta, iLinea, 109);

				iLinea += 4;

				if (iContadorSeguros == 1)
				{
					iLinea++;
				}

				hoja.poner("RECUERDA QUE SI REALIZAS EL PAGO DE TU SERVICIO DESPUES DE LA FECHA LIMITE,", iLinea++, 0);
				hoja.poner("CABLEMAS APLICARA UN CARGO POR PAGO EXTEMPORANEO DE $50 PESOS A TU ESTADO DE CUENTA", iLinea++, 0);

				iLinea++;
			}
		}
	}
	else
	{
		//Se obtiene el error
		obtenerDatosTmpCaCarmovServicio.odbc->GetLastError(obtenerDatosTmpCaCarmovServicio.GetHstmt());
		grabarMensajeError("C", m_grid.iCaja, (LPTSTR)(LPCTSTR)m_grid.sServer, "CapturarAbono", "CDlgCapturarAbono", "imprimirPagoServicios", cSql, m_grid.lEmpleado, "ERROR EN LA CONSULTA(imprimirpagoservicios)", obtenerDatosTmpCaCarmovServicio.odbc, m_grid.iMuestraMsg);
	}
}

void CDlgCapturarAbono::consultarImporteTotalPagoServicio(long &lImporteTotalServicio)
{
	char cLog[500] = { 0 };
	char cSql[60] = { 0 };

	sprintf_s(cLog, "FC0200805021521677 - entra - consultarImporteTotalPagoServicio");
	grabarLog(cLog);

	sprintf_s(cSql, "SELECT importe FROM tmpcacarmovservicio WHERE caja = %d", m_grid.iCaja);
	//importe total de los pagos de servicio
	CMaximo importeTotalTmpCaCarmovServicio(&odbc, false);
	if (importeTotalTmpCaCarmovServicio.Exec(cSql))
	{
		importeTotalTmpCaCarmovServicio.activarCols();
		while (importeTotalTmpCaCarmovServicio.Leer())
		{
			lImporteTotalServicio += importeTotalTmpCaCarmovServicio.Total;
		}
	}
	else
	{
		//Se obtiene el error
		importeTotalTmpCaCarmovServicio.odbc->GetLastError(importeTotalTmpCaCarmovServicio.GetHstmt());
		grabarMensajeError("C", m_grid.iCaja, (LPTSTR)(LPCTSTR)m_grid.sServer, "CapturarAbono", "CDlgCapturarAbono", "consultarImporteTotalPagoServicio", cSql, m_grid.lEmpleado, "ERROR EN LA CONSULTA(consultarimportetotalpagoservicio)", importeTotalTmpCaCarmovServicio.odbc, m_grid.iMuestraMsg);
	}
}

void CDlgCapturarAbono::menuCajas(int iOpcion)
{
	char cLog[500] = { 0 };
	CString sDato, sLink, sTienda, sEmpleado, sCaja, sMuestraMsg, sOpcion;
	char cCadena[128] = { 0 }, cBarraOpciones[255] = { 0 };
	char cNombreProyecto[100] = { 0 }, cNombreFuncionDLL[10] = { 0 }, cInputParam1[1024] = { 0 }, cInputParam2[1024] = { 0 }, cOutputParam1[1024] = { 0 }, cOutputParam2[1024] = { 0 };

	SParametros parametros;
	memset(&parametros, 0, sizeof(SParametros));

	sprintf_s(cLog, "FC0200805021521681 - entra - menuCajas - iOpcion[%d]", iOpcion);
	grabarLog(cLog);

	if ((iSistema == SISTEMA_MUEBLES || iSistema == SISTEMA_ROPA) && iOpcion != VK_F7)
	{
		//AfxMessageBox("ESTA OPCION NO ESTA DISPONIBLE EN EL AREA DE MUEBLES Y ROPA");

		if (iFlagReestructuraDisponible == 1)
		{
			bool bSalir = true;
			char * opciones[] = { "F1   Cancelar Reestructura      ",
				"Esc  Salir                      ",
				"" };

			int respuesta[] = { F1,0 };

			while (bSalir)
			{
				C_Menu menu("CANCELAR RECIBOS REESTRUCTURA", opciones, respuesta);

				switch (menu.OpcionSeleccionada())
				{
				case F1:
					{
						CString sJsonConfiguracion, sJsonReestructura, sJsonParams;
						sJsonConfiguracion.Format("{'ServidorCartera':\'%s\','Tienda':{'ServidorTienda':\'%s\','Numero':%d},'OrigenLlamada':%d,'Cajero':%d,'Ciudad':%d,'Caja':%d,'CajaOriginal':%d,'Area':'%c'}", cIpServidorCartera, m_grid.sServer, m_grid.iTienda, 2, m_grid.lEmpleado, 0, iCajaActual, iCajaOriginal, m_grid.cArea);
						sJsonReestructura.Format("{'Producto':{'NumeroProducto':%d,'ImporteFinanciamiento':%d,'ImporteSaldo':%d,'InteresMoratorio':%d,'EsPorcentaje':%d,'NumeroAbonos':%d,'ListadoPlazo':[{'Seleccionado':false,'Descripcion':\'%s\','Meses':%d,'ImporteSaldo':%d,'ImporteAbonoBase':%d},{'Seleccionado':false,'Descripcion':\'%s\','Meses':%d,'ImporteSaldo':%d,'ImporteAbonoBase':%d},{'Seleccionado':false,'Descripcion':\'%s\','Meses':%d,'ImporteSaldo':%d,'ImporteAbonoBase':%d}]},'Hit':{'Formaliza':%d,'AbonoAnterior':%d,'AbonoNuevo':%d,'Abono':%d,'NoFinaliza':%d},'Cliente':{'IduCliente':%d,'Nombre':\'%s\','ApellidoPaterno':\'%s\','ApellidoMaterno':\'%s\','Cuenta':{'Saldo':%d,'AbonoMensual':%d,'Tienda':%d,'Descripcion':\'%s\','SaldoVencido':%d,'SaldoFinanciar':%d,'InteresMoratorio':%d}}}", -1, 0, 0, 0, 0, 0, "", 0, 0, 0, "", 0, 0, 0, "", 0, 0, 0, 0, 0, 0, 0, 0, 0, "", "", "", 0, 0, 0, "", 0, 0, 0);
						sJsonConfiguracion.Replace(' ', '_');
						sJsonReestructura.Replace(' ', '_');
						sJsonParams.Format("%s %s", sJsonConfiguracion, sJsonReestructura);
						_spawnl(P_WAIT, PATH_PUENTETOCS, PATH_PUENTETOCS, m_grid.sServer, m_grid.sServer, PATH_REESTTRUCTURA_DLL, NOMBRE_FUNCION_INICIAL, sJsonParams, NULL);
					}
					break;
				case ESC:
					bSalir = false;
					break;
				default:
					break;
				}
			}
		}
	}
	else
	{
		if (iOpcion == 14 && iSistema != 3)
		{
			AfxMessageBox("FAVOR DE PASAR A CAJAS DE ABONOS A REALIZAR LOS PAGOS DE SERVICIOS");
		}
		else
		{
			
			if(iOpcion < 100) iOpcion += 111;
			if (iOpcion == VK_F1) iOpcion = 0;
			sOpcion.Format("%d", iOpcion);

			CString CResultadoString = "";
			CString sAux = "";

			CString sRuta = "C:\\sys\\progx\\ca\\CA0005.DLL";
			CString sClaseConstructor = "MenuCajas.Inicio";
			CString sMetodo = "Cargar";
			CStringArray sArgsConstructor;
			CStringArray sArgsMetodo;

			sArgsMetodo.Add(m_grid.sServer);	// string ipServidor

			sAux.Format("%d", m_grid.iTienda);
			sArgsMetodo.Add(sAux);				// int numTienda

			sAux.Format("%ld", m_grid.lEmpleado);
			sArgsMetodo.Add(sAux);				// long empleado

			sAux.Format("%d", m_grid.iCaja);
			sArgsMetodo.Add(sAux);				// int caja

			sAux.Format("%d", m_grid.iMuestraMsg);
			sArgsMetodo.Add(sAux);				// int guardaError

			sArgsMetodo.Add(sOpcion);			// int opcion

			sAux.Format("%d", iSistema);
			sArgsMetodo.Add(sAux);				// int numSistema

			WinExec("C:\\Windows\\Microsoft.NET\\Framework\\v4.0.30319\\RegAsm.exe C:\\sys\\progx\\libcsharp\\PUENTECSHARPTIENDA.DLL /tlb:C:\\sys\\progx\\libcsharp\\PUENTECSHARPTIENDA.TLB /codebase", SW_HIDE);
	
			::CoInitialize(NULL);
			CCargaDllCSharp *objCargaDll = new CCargaDllCSharp();
			objCargaDll->CargarDllCSharp(sRuta, sClaseConstructor, METODO_STRING, sMetodo, sArgsConstructor, sArgsMetodo);
			objCargaDll->getRespuesta(CResultadoString);
			grabarLog("CDlgCapturarAbono Liberar --> objCargaDll 22133 Cambio Softtek");
			delete objCargaDll;
			grabarLog("CDlgCapturarAbono Se libera --> objCargaDll 22133 Cambio Softtek");
			::CoUninitialize();
			

			#pragma region SE SEPARA LA CADENA DE RESPUESTA EN UN ARRAY Y LUEGO EN LAS VARIABLES iRegresaDll Y lClienteDlg
			CStringArray CResultadosArray;
			char *context = NULL;

			char* token = strtok_s((LPSTR)(LPCTSTR)CResultadoString, "_", &context);

			while (token != NULL)
			{
				CResultadosArray.Add(token);
				token = strtok_s(NULL, "_", &context);
			}

			sAux = CResultadosArray[0];
			iRegresaDll = (int)atol(sAux);
			
			sAux = CResultadosArray[1];
			lClienteDlg = atol(sAux);
			#pragma endregion

			ShowWindow(SW_SHOWNORMAL);
			ShowWindow(SW_SHOWMAXIMIZED);

			if (iRegresaDll <= 0)
			{
				AfxMessageBox("Error al cargar el programa CA0005.DLL", MB_ICONERROR);
				lClienteDlg = 0L;
			}
			else if (iRegresaDll == 3)
			{
				iFlagCorte = 3;
				CDialog2012::OnCancel();
			}
			if (lClienteDlg > 0L)
			{
				sDato.Format("%ld", lClienteDlg);
				m_cliente.SetWindowText(sDato);
				validarNumeroCliente(cCadena);
				iCajaOriginal = m_grid.iCaja;
				iContador = 1;
				iFoco = 1;
				asignarFoco();
				m_grid.GotoCell(0, 21);
				m_grid.bLlenarGrid = true;
				m_barra.ShowWindow(TRUE);

				iniciarMovimientoOperacion();

				if (iOpcion == VK_F7)
					iBuscarCliente = 1;

				if (bFlagSituacionesInformativas)
				{
					if (iFlagRegistroPL > 0 && iFlagCampoInteligentePL > 0 && !bProvieneDatos_OtraArea
						&& (iSistema == SISTEMA_CAJAS || iSistema == SISTEMA_MUEBLES || iSistema == SISTEMA_ROPA))
					{
						sprintf_s(cBarraOpciones, " [CTRL+F3]  PANTALLA DE MOVIMIENTOS      [CTRL+F4]  MOSTRAR INFORMATIVAS [CTRL+F9] %.50s", cOpcionPL);
					}
					else
					{
						sprintf_s(cBarraOpciones, " [CTRL+F3]  PANTALLA DE MOVIMIENTOS      [CTRL+F4]  MOSTRAR INFORMATIVAS");
					}
				}
				else
				{
					if (iFlagRegistroPL > 0 && iFlagCampoInteligentePL > 0 && !bProvieneDatos_OtraArea
						&& (iSistema == SISTEMA_CAJAS || iSistema == SISTEMA_MUEBLES || iSistema == SISTEMA_ROPA))
					{
						sprintf_s(cBarraOpciones, "[CTRL+F6] CONSULTAR HISTORIAL DE CONV.   [CTRL+F3]  PANTALLA DE MOVIMIENTOS   [CTRL+F9] %.50s", cOpcionPL);

					}
					else
					{
						sprintf_s(cBarraOpciones, "[CTRL+F6] CONSULTAR HISTORIAL DE CONV.   [CTRL+F3]  PANTALLA DE MOVIMIENTOS ");
					}
				}
				ponerMensajeNR(this, m_barra, m_mensaje1, cBarraOpciones);
			}

			if (iOpcion == 13)
			{
				if (checarCorteCajas() == 1)
				{
					iFlagCorte = 1;
					CDialog2012::OnCancel();
				}
			}
		}
	}
}

bool CDlgCapturarAbono::validarNumeroCliente(char *cTextoMsj)
{
	char cLog[500] = { 0 };
	bool bValorRegresa = true, bConsulta = false, bContinuar = false, bRegresa = false;
	CString sNumeroCliente, sTexto, sDato;
	long lResp = 0l, lGteHuella = 0l;
	int iFlagErrorExe = 0;
	char cIdentificacion[20] = { 0 };
	char cNombreTablaTmp[40] = { 0 };

	sprintf_s(cLog, "FC0200805021521687 - entra - validarNumeroCliente");
	grabarLog(cLog);

	// se agrega funcion para mostrar titulo de tienda modo local

	m_cliente.GetWindowText(sTexto);
	grabarLog("CDlgCapturarAbono::validarNumeroCliente: Inicio");
	if (sTexto.IsEmpty())
	{
		sprintf(cTextoMsj, "%s", "El número de cliente no puede ser nulo...");
		m_grid.lCliente = 0L;
		m_cliente.SetSel(0, 9);
		bValorRegresa = false;
	}
	else
	{
		if (iSistema == 7 && sTexto.GetLength() == 16)
		{
			sprintf(cTextoMsj, "%s", " CLIENTE FUERA DE RANGO ");
			m_grid.lCliente = 0L;
			m_cliente.SetSel(0, 16);
			bValorRegresa = false;
		}
		else if (sTexto.GetLength() == 16)
		{
			bValorRegresa = LeerTarjeta(1, cTextoMsj);
		}
		else if (sTexto.GetLength() <= 9)
		{
			m_grid.lCliente = atol(sTexto);
		}
		else
		{
			sprintf(cTextoMsj, "%s", " CLIENTE FUERA DE RANGO ");
			m_grid.lCliente = 0L;
			m_cliente.SetSel(0, sTexto.GetLength());
			bValorRegresa = false;
		}

		if (bValorRegresa)
		{
			//WARD JUAN
			if (((m_grid.lCliente > lClienteMaximo || m_grid.lCliente < 100000) && m_grid.lCliente != 1708) || esEmpleado(m_grid.lCliente) == 1)
			{
				sprintf(cTextoMsj, "%s", " CLIENTE FUERA DE RANGO ");
				m_grid.lCliente = 0L;
				m_cliente.SetSel(0, sTexto.GetLength());
				bValorRegresa = false;
			}
			else
			{
				if (m_grid.lCliente > 0L)
				{
					if (bValorRegresa)
					{
						if (checar_digito(m_grid.lCliente))
						{
							m_grid.lCliente = 0L;
							m_cliente.SetSel(0, sTexto.GetLength());
							bValorRegresa = false;
							sprintf(cTextoMsj, "%s", " !! DIGITO VERIFICADOR INVALIDO !! ");
						}

						if (m_grid.lCliente == 1)
						{
							sprintf(cTextoMsj, "%s", " CLIENTE INCORRECTO ");
							m_grid.lCliente = 0L;
							m_cliente.SetSel(0, sTexto.GetLength());
							bValorRegresa = false;
						}

					}
					if (bValorRegresa)
					{
						checarEImprimirMemos(3, &odbc, m_grid.iCaja, 0);
						if (iFlagMovimiento == 0) // es un cargo
						{
							validarHuellaEmpleadoGte01(&odbc, lGteHuella, 1, 4, m_grid.lCliente, m_grid.iTienda, 3, m_grid.iCaja, "CA0030");//gnwSuplirHuellaGerente.cpp 
							if (lGteHuella <= 90000000)
							{
								if (lGteHuella == -1)
								{
									char cNombreProyecto[100] = { 0 }, cNombreFuncionDLL[10] = { 0 }, cInputParam1[1024] = { 0 }, cInputParam2[1024] = { 0 }, cOutputParam1[1024] = { 0 }, cOutputParam2[1024] = { 0 };
									SParametros parametros;
									memset(&parametros, 0, sizeof(SParametros));

									nombreArchivo("GN0055.dll", cNombreProyecto, DIRECTORIO_GN);
									parametros.iLink = generarLink();
									parametros.iTienda = m_grid.iTienda;
									parametros.lEmpleado = m_grid.lEmpleado;
									parametros.iCajaActual = m_grid.iCaja;
									parametros.iMuestraMsg = m_grid.iMuestraMsg;
									parametros.iNumSistema = SISTEMA_CAJAS;
									sprintf_s(parametros.sServer, "%s", (LPCTSTR)m_grid.sServer);

									memcpy(cInputParam1, &parametros, sizeof(SParametros));
									CargarDLL cargarDll(cNombreProyecto, "GN0055", cInputParam1, cInputParam2, cOutputParam1, cOutputParam2);
									lResp = atol(cOutputParam1);
									if (lResp < 0)
									{
										iFlagErrorExe = 1;
										AfxMessageBox("Error al cargar el programa GN0055.dll (validarnumerocliente)", MB_ICONERROR);
										m_grid.lCliente = 0L;
										m_cliente.SetSel(0, 16);
										bValorRegresa = false;
									}
									else
									{
										lGteHuella = lResp;
										if (lGteHuella == 2) // No hay conexión
											iFlagErrorExe = 1;
									}
								}

								if (iFlagErrorExe == 0)
								{
									pintarMensajesErrorPasstda(lGteHuella);
									sprintf(cTextoMsj, "HUELLA INCORRECTA");
									m_grid.lCliente = 0L;
									m_cliente.SetSel(0, sTexto.GetLength());
									bValorRegresa = false;
									iFlagMensajeHuella = 1;

								}
								else
								{
									bValorRegresa = true;
									iFlagMensajeHuella = 0;
								}
							}
							else
							{
								char cSqlTxt[255] = { 0 };
								iFlagAutoGteCargo = 1;
								//Se graba en tmp la autorizacion del gerente.
								grabarAutorizacionGerentesTA('B', lNumeroRecibo, m_grid.lCliente, lGteHuella, cIdentificacion, iSistema, m_grid.iTienda, iCiudadGnDominio, iDiaActual, iMesActual, iAnioActual, bContinuar, &odbc, cSqlTxt, cNombreTablaTmp);
							}
						}
					}

					if (bValorRegresa)
					{
						if (m_grid.lCliente < 0L)
						{
							sprintf(cTextoMsj, "%s", " CLIENTE INCORRECTO ");
							m_grid.lCliente = 0L;
							m_cliente.SetSel(0, sTexto.GetLength());
							bValorRegresa = false;
						}
						else
						{
							if (m_grid.lCliente == 1708L && iFlagETP == 1)
							{
								sprintf(cTextoMsj, "%s", " CLIENTE INVALIDO ");
								bValorRegresa = false;
							}
						}
					}

					//Activar
					if (esEmpleado(m_grid.lCliente) != 1)
					{
						if (iFlagSupervisor == -1)
						{
							iFlagSupervisor = 0;
							if (iFlagMovimiento == 2)
							{
								iFlagMovimiento = 1;
								iFlagSupervisor = 1;
							}
						}
					}
					if (esEmpleado(m_grid.lCliente) != 1 && bValorRegresa)
					{
						if (iFlagSupervisor == 1 && iFlagCapturaSurpervisor == 0)
						{
							CDlgCapturarNumEmpleSupervisor dlgEmpleadoSupervisor;
							dlgEmpleadoSupervisor.lEmpleado = m_grid.lEmpleado;
							dlgEmpleadoSupervisor.iCaja = m_grid.iCaja;
							m_grid.iTotalCuentas = 0;
							m_grid.iFlagConvenioRealizado = 0;
							dlgEmpleadoSupervisor.DoModal();

							if (dlgEmpleadoSupervisor.lEmpleadoSupervisor <= 0L)
							{
								lEmpleadoSupervisor = 0L;
								inicializarCaptura();
							}
							else
							{
								lEmpleadoSupervisor = dlgEmpleadoSupervisor.lEmpleadoSupervisor;
								iFlagCapturaSurpervisor = 1;
							}
						}
					}

					if (m_grid.lCliente == 1708L)
					{
						if (iFlagETP == 1)
						{
							sprintf(cTextoMsj, "%s", " CLIENTE INVALIDO ");
						}
						else
						{
							CDlgCapturarClienteEtp dlgClienteEtp;
							dlgClienteEtp.DoModal();

							if (dlgClienteEtp.lClienteEtp > 0L)
							{
								lClienteEtp = dlgClienteEtp.lClienteEtp;
								if (iFlagMovimiento == 0)
								{
									if (tiposDeEtp() <= 0)
									{
										inicializarCaptura();

									}
									else
									{
										m_grid.SetFocus();
									}
								}
								else
								{
									if (tiposDeEtp2() <= 0)
									{
										inicializarCaptura();

									}
									else
									{
										m_grid.SetFocus();
									}
								}
							}
							else
							{
								inicializarCaptura();
							}
						}
					}
				}
				else
				{
					if (m_grid.lCliente == 0)
					{
						sprintf(cTextoMsj, "%s", " CLIENTE INCORRECTO ");
						m_grid.lCliente = 0L;
						m_cliente.SetSel(0, sTexto.GetLength());
						bValorRegresa = false;
					}
				}
				if (bValorRegresa && iContador == 0)
				{
					iContador = 1;
					MostrarControlesPlanLealtad();
				}
			}
		}
	}

	sprintf_s(cLog, "FC0200805021521690 - fin -validarNumeroCliente: Fin bValorRegresa = %d", bValorRegresa);
	grabarLog(cLog);

    //6267707 Cajas/Legado no hay registro en tdcheques ni en SOA
    limpiarFolioRezagado(false);
	eliminarRegistroTemporalSesionTarjetaIniciarProcesoFacturacion();
    //6267707 Cajas/Legado no hay registro en tdcheques ni en SOA

	return bValorRegresa;
}

int CDlgCapturarAbono::checarClaveGerente()
{
	char cLog[500] = { 0 };
	int iFlagGerente = 0;
	long lNumeroEmpleadoHuella = 0L;
	long lRegresaGerente = 0;

	sprintf_s(cLog, "FC0200805021521692 - entra - checarClaveGerente");
	grabarLog(cLog);

	//Cambio: Alonsov -- Se modifica para que utilize la funcion validarHuellaEmpleadoGte
	//ya que verificaClaveGte no verificaba realmente si el empleado era Gerente.
	iTiendaDlg = m_grid.iTienda;

	validarHuellaEmpleadoGte01(&odbc, lRegresaGerente, 1, 2, 0, iTiendaDlg, iSistema, iCajaDlg, "CA0030");//gnwSuplirHuellaGerente.cpp
	if (lRegresaGerente < 16)
	{
		pintarMensajesErrorPasstda(lGteHuella);
		iFlagGerente = 0;
	}
	else
	{
		iFlagGerente = 1;
	}
	return iFlagGerente;
}

bool CDlgCapturarAbono::obtenerDatosTablaTmpParaGrid()
{
	char cLog[500] = { 0 };
	bool bRegresa = false, bConsulta = false;
	CString sDato;
	int i = 0, j = 0, iFlagConsulta = -1;
	char cTxt[25] = { 0 }, cSqlTxt[255] = { 0 }, cEjecutable[80] = { 0 };
	long lCuota = 0;

	VentaClub ventaClub;

	sprintf_s(cLog, "FC0200805021521696 - entra - obtenerDatosTablaTmpParaGrid");
	grabarLog(cLog);

	nombreArchivo("VTACLUB.DAT", cEjecutable, DIRECTORIO_MEM);
	if (_access(cEjecutable, 0) == 0)
	{
		for (i = 0; i < iTotalCuentas; i++)
		{
			m_grid.QuickGetText(i, -1, &sDato);
			sDato.Trim();
			sprintf_s(cTxt, "%s", (LPCTSTR)sDato);

			if (memcmp(cTxt, "P.FAMILIAR", 6) == 0)
			{
				break;
			}
		}
		for (j = 22; j < 35; j++) //ciclo para blanquear las columnas ocultas de la 22 a la 32
		{
			sDato.Format("%d", 0);
			m_grid.QuickSetText(i, j, sDato);
			m_grid.RedrawCell(i, j);
		}

		C_Archivo arcVtaClub;
		arcVtaClub.abrir(cEjecutable, &ventaClub, sizeof(ventaClub));
		arcVtaClub.leer(&ventaClub, 0L);
		if (ventaClub.lCliente == m_grid.lCliente)
		{
			sDato.Format("%ld", 999999);
			m_grid.QuickSetText(i, 1, sDato);
			m_grid.QuickSetAlignment(i, 1, UG_ALIGNCENTER);

			miniFecha(cTxt, valor_campo(&ventaClub.cFechaVencimiento[0], 2), valor_campo(&ventaClub.cFechaVencimiento[2], 2), valor_campo(&ventaClub.cFechaVencimiento[4], 4));
			m_grid.QuickSetText(i, 4, cTxt);
			m_grid.QuickSetAlignment(i, 4, UG_ALIGNCENTER);

			sDato.Format(" SEGS   %ld", ventaClub.iCantidadSeguros);
			m_grid.QuickSetText(i, 12, sDato);
			m_grid.QuickSetAlignment(i, 12, UG_ALIGNCENTER);

			sDato.Format("# MESES %d", ventaClub.iMesesAsegurados);
			m_grid.QuickSetText(i, 13, sDato);
			m_grid.QuickSetAlignment(i, 13, UG_ALIGNCENTER);

			sDato.Format("%d", ventaClub.iCantidadSeguros);
			m_grid.QuickSetText(i, 22, sDato);
			m_grid.QuickSetAlignment(i, 22, UG_ALIGNCENTER);

			sDato.Format("%d", ventaClub.iMesesAsegurados);
			m_grid.QuickSetText(i, 23, sDato);
			m_grid.QuickSetAlignment(i, 23, UG_ALIGNCENTER);

			iMarcaSeguroClub = ventaClub.iAnioNacimiento; //regresa 1 de que el seguro esta activo con beneficiarios.
			if (iConyugal == 1)
			{
				grabarLog("Consulta Precio seguro 8");
				if (!consultarPrecioSeguroClub(lCuota, (short)ventaClub.iCantidadSeguros, 1))
				{
					bConsulta = false;
					iFlagConsulta = 0;
				}
			}
			else
			{
				lCuota = obtenerCuotaClub(m_grid.lCliente, ventaClub.iCantidadSeguros, ventaClub.iMesesAsegurados, iFlagBanorte, &odbc, &odbc_1, cSqlTxt, bConsulta, iFlagConsulta, iConyugal); //cawcuota.cpp
			}

			if (bConsulta != true && iFlagConsulta != 1)
			{
				grabarMensajeError("C", m_grid.iCaja, (LPTSTR)(LPCTSTR)m_grid.sServer, "CA0030", "CDlgCapturarAbono", "obtenerDatosTablaTmpParaGrid", (LPTSTR)(LPCTSTR)cSqlTxt, m_grid.lEmpleado, "ERROR EN LA CONSULTA(obtenerdatostablatmpparagrid)", &odbc, m_grid.iMuestraMsg);
				lCuota = 0;
			}

			usingx("###,###", cTxt, (double)lCuota);
			m_grid.QuickSetText(i, 16, cTxt);
			m_grid.QuickSetAlignment(i, 16, UG_ALIGNRIGHT);

			sDato.Format("%d", lCuota);
			m_grid.QuickSetText(i, 21, sDato);
			m_grid.QuickSetAlignment(i, 21, UG_ALIGNCENTER);

			m_grid.RedrawAll();

			if (ventaClub.iSegClubNoTiene == 1) //no tiene seguro club
			{
				bBanderaTieneClub = true;
			}
			else
			{
				bBanderaTieneClub = false;
			}
		}
	}
	else
	{
		AfxMessageBox(" NO SE ENCONTRO EL ARCHIVO VTACLUB.DAT ");
	}
	return bRegresa = true;
}

//esta funcion es para grabar los beneficiarios capturados en la
//venta del seguro club al hacerlo en el menu de los seguros club opcion F1
//lo graba de la table tmpTdBeneficiarios a
//la tabla TdBeneficiarios.
bool CDlgCapturarAbono::grabarTmpTdbeneficiariosaTdBeneficiarios()
{
	char cLog[500] = { 0 };
	bool bRegresa = true;

	sprintf_s(cLog, "FC0200805021521700 - entra - grabarTmpTdbeneficiariosaTdBeneficiarios");
	grabarLog(cLog);

	grabarLog("grabarTmpTdbeneficiariosaTdBeneficiarios::grabando beneficiarios seguros");

	if (lNumeroConexion > 0L)
	{
		char cSql[90] = { 0 };

		sprintf_s(cSql, "SELECT cagrabartmptdbeneficiariosclubatdbeneficiarios('tmptdbeneficiarios%ld')", lNumeroConexion);

		CMaximo flagCoppel(&odbc, false);
		if (flagCoppel.Exec(cSql))
		{
			flagCoppel.activarCols();
			if (flagCoppel.Leer())
			{
				bRegresa = true;
			}
		}
		else
		{
			//Se obtiene el error
			bRegresa = false;
			flagCoppel.odbc->GetLastError(flagCoppel.GetHstmt());
			grabarMensajeError("C", m_grid.iCaja, (LPTSTR)(LPCTSTR)m_grid.sServer, "CapturarAbono", "CDlgCapturarAbono", "consultarCuentasPagoServicio", cSql, m_grid.lEmpleado, "ERROR EN LA CONSULTA(grabartmptdbeneficiariosatdbeneficiarios)", flagCoppel.odbc, m_grid.iMuestraMsg);
		}
	}
	return bRegresa;
}

void CDlgCapturarAbono::inicializar()
{
	char cLog[500] = { 0 };
	int i = 0;
	CUGCell m_cell;

	sprintf_s(cLog, "FC0200805021521704 - entra - inicializar");
	grabarLog(cLog);

	cuentasSeguros.jsonAbonoCelularesC.limpiar();
	cuentasSeguros.jsonAbonoCelularesCL.limpiar();
	cuentasSeguros.jsonAbonoMotosC.limpiar();
	cuentasSeguros.jsonAbonoMotosCL.limpiar();

	memset(cSituacionEspecial, 0, sizeof(cSituacionEspecial));
	bTienePlantel = false;
	{

		m_grid.QuickSetRange(0, 0, 5, 35, &m_cell);
		for (i = -1; i < 6; i++)
		{
			m_grid.m_cell.SetBackColor(RGB(236, 233, 216));
			m_grid.SetCell(i, 11, &m_grid.m_cell);
			m_grid.RedrawCell(i, 11);
			m_grid.m_cell.SetBackColor(RGB(236, 233, 216));
			m_grid.SetCell(i, 17, &m_grid.m_cell);
			m_grid.RedrawCell(i, 17);
			m_grid.m_cell.SetBackColor(RGB(236, 233, 216));
			m_grid.SetCell(i, 20, &m_grid.m_cell);
			m_grid.RedrawCell(i, 20);
		}
		m_grid.RedrawAll();
	}

	{
		m_grid2.QuickSetRange(0, 0, 0, 22, &m_cell);
		m_grid2.m_cell.SetBackColor(RGB(236, 233, 216));
		m_grid2.SetCell(0, 11, &m_grid.m_cell);
		m_grid2.RedrawCell(0, 11);

		m_grid2.m_cell.SetBackColor(RGB(236, 233, 216));
		m_grid2.SetCell(0, 17, &m_grid.m_cell);
		m_grid2.RedrawCell(0, 17);

		m_grid2.m_cell.SetBackColor(RGB(236, 233, 216));
		m_grid2.SetCell(0, 20, &m_grid.m_cell);
		m_grid2.RedrawCell(0, 20);
		m_grid2.RedrawAll();
	}
}

long CDlgCapturarAbono::obtenerTotalAbonoCuentasPagoServicio(long &lTotal)
{
	char cLog[500] = { 0 };
	bool bResultado = false;
	CString sPago;
	int i = 0;
	CUGCell m_cell;
	long lTotalCuentas = 0L, lTotalPagoServicios = 0L;

	sprintf_s(cLog, "FC0200805021521708 - entra - obtenerTotalAbonoCuentasPagoServicio");
	grabarLog(cLog);

	for (i = 0; i < iTotalCuentas; i++)
	{
		m_grid.GetCell(i, 21, &m_cell);
		m_grid.QuickGetText(i, 21, &sPago);
		lTotalCuentas = lTotalCuentas + atol(sPago);
	}
	lTotal = lTotalCuentas * 100;

	if (iSistema == 3)
	{
		char cSql[55] = { 0 };

		sprintf_s(cSql, "SELECT caconsultartotalimportepagoservicio('%d')", m_grid.iCaja);

		CMaximo folioCoppel(&odbc);
		if (folioCoppel.Exec(cSql))
		{
			folioCoppel.activarCols();
			if (folioCoppel.Leer())
			{
				lTotalPagoServicios = lTotalPagoServicios + folioCoppel.Total;
				bResultado = true;
			}
		}
		else
		{
			//Se obtiene el error
			bResultado = false;
			folioCoppel.odbc->GetLastError(folioCoppel.GetHstmt());
			grabarMensajeError("C", m_grid.iCaja, (LPTSTR)(LPCTSTR)m_grid.sServer, "CapturarAbono", "CDlgCapturarAbono", "obtenerTotalAbono", cSql, m_grid.lEmpleado, "ERROR EN LA CONSULTA(obtenertotalabonocuentaspagoservicio)", folioCoppel.odbc, m_grid.iMuestraMsg);
		}
	}

	lTotal = lTotal + lTotalPagoServicios;
	return  bResultado;
}

bool CDlgCapturarAbono::incrementarFolioSysFolioGlobal(__int64 &i64FolioTienda)
{
	char cLog[500] = { 0 };
	bool bRetorno = false, bClase = false;
	int iTipoFolio = 0, iFlagConsulta = 0;
	char cSqlTxt[255] = { 0 };

	sprintf_s(cLog, "FC0200805021521712 - entra - incrementarFolioSysFolioGlobal");
	grabarLog(cLog);

	iTipoFolio = FOLIOGLOBAL_TIENDA;

	incrementarFolioTienda(&odbc, cSqlTxt, iFlagConsulta, bClase, iTipoFolio, 1, i64FolioTienda);
	if (iFlagConsulta != 1)
	{
		grabarMensajeError("C", m_grid.iCaja, (LPTSTR)(LPCTSTR)m_grid.sServer, "CapturarAbono", "CDlgCapturarAbono", "incrementarFolioSysFolioGlobal", cSqlTxt, m_grid.lEmpleado, "ERROR EN LA CONSULTA(incrementarfoliosysfolioglobal)", &odbc, m_grid.iMuestraMsg);
	}
	else
	{
		bRetorno = true;
	}
	return bRetorno;
}

bool CDlgCapturarAbono::borrarPagoServicio()
{
	char cLog[500] = { 0 };
	char cSql[45] = { 0 };
	bool bRespuesta = false;

	sprintf_s(cLog, "FC0200805021521716 - entra - borrarPagoServicio");
	grabarLog(cLog);

	sprintf_s(cSql, "SELECT caborrartmpcacarmovservicio('%d')", m_grid.iCaja);

	CMaximo folioCoppel(&odbc);
	if (!folioCoppel.Exec(cSql))
	{
		folioCoppel.odbc->GetLastError(folioCoppel.GetHstmt());
		grabarMensajeError("C", m_grid.iCaja, (LPTSTR)(LPCTSTR)m_grid.sServer, "CapturarAbono", "CDlgCapturarAbono", "borrarPagoServicio", cSql, m_grid.lEmpleado, "ERROR EN LA CONSULTA(borrarpagoservicio)", folioCoppel.odbc, m_grid.iMuestraMsg);
	}
	else
	{
		bRespuesta = true;
	}
	return bRespuesta;
}

void CDlgCapturarAbono::borrarCuentaSeguroClubGrid()
{
	char cLog[500] = { 0 };
	int i = 0, j = 0, k = 0, iCuentaSeguroClub = 0, iCont = 1;
	CString sDato;
	char cTxt[80] = { 0 };
	//******* Get the index value of the font. 
	int fontID = m_grid.AddFont("Lucida Console Bold", 14, 200);

	sprintf_s(cLog, "FC0200805021521720 - entra - borrarCuentaSeguroClubGrid");
	grabarLog(cLog);

	for (j = 0; j < m_grid.iTotalCuentas; j++) //borrar la cuenta del seguro club del grid
	{
		m_grid.QuickGetText(j, -1, &sDato);
		sDato.Trim();
		sprintf_s(cTxt, "%s", (LPCTSTR)sDato);

		if (memcmp(cTxt, "P.FAMILIAR", 10) == 0)
		{
			iCuentaSeguroClub = 1;
			m_grid.DeleteCol(j);
			m_grid.AppendCol();

			m_grid.iTotalCuentas--;
			iTotalCuentas--;
			if (m_grid.iTotalCuentas < 8)
			{
				for (k = m_grid.iTotalCuentas; k < 8; k++)
				{
					m_grid.QuickSetFont(k, -1, fontID);

					m_grid.GetCell(k, 11, &m_cell);
					m_cell.SetBackColor(RGB(236, 233, 216));
					m_grid.SetCell(k, 11, &m_cell);
					m_grid.RedrawCell(k, 11);
					m_grid.GetCell(k, 17, &m_cell);
					m_cell.SetBackColor(RGB(236, 233, 216));
					m_grid.SetCell(k, 17, &m_cell);
					m_grid.RedrawCell(k, 17);
					m_grid.GetCell(k, 20, &m_cell);
					m_cell.SetBackColor(RGB(236, 233, 216));
					m_grid.SetCell(k, 20, &m_cell);
					m_grid.RedrawCell(k, 20);

					m_grid.SetColWidth(k, 83);

					sDato.Format("ARTÍCULO %d", iCont);
					m_grid.QuickSetText(k, -1, sDato);


					for (i = 0; i < 35; i++)
					{
						m_grid.QuickSetAlignment(k, i, UG_ALIGNLEFT);
					}

					m_grid.SetRowHeight(11, 3);
					m_grid.SetRowHeight(17, 3);
					m_grid.SetRowHeight(20, 3);

					m_grid.RedrawCol(k);
					iCont++;
				}
			}
			m_grid.GotoCell(0, 21);
			break;
		}
	}
}

void CDlgCapturarAbono::ponerCuentaSeguroClubGrid()
{
	char cLog[500] = { 0 };
	int i = 0, k = 0, j = 0, iCont = 1, iFlag = 0;
	CString sDato;
	char cTxt[80] = { 0 };
	int fontID = m_grid.AddFont("Lucida Console Bold", 14, 200);

	sprintf_s(cLog, "FC0200805021521724 - entra - ponerCuentaSeguroClubGrid");
	grabarLog(cLog);

	for (j = 0; j < m_grid.iTotalCuentas; j++) //borrar la cuenta del seguro club del grid
	{
		m_grid.QuickGetText(j, -1, &sDato);
		sDato.Trim();
		sprintf_s(cTxt, "%s", (LPCTSTR)sDato);
		if (memcmp(cTxt, "P.FAMILIAR", 10) == 0)
		{
			iFlag = 1; //ya tiene seguro club
			break;
		}
	}
	i = 0, k = 0, j = 0;
	if (iFlag == 0)
	{
		m_grid.InsertCol(1);
		m_grid.RedrawAll();
		CDlgCapturarDatosSeguro dlgCapturarDatosSeguro;

		desplegarPaginaSeguros(0, 0, 1, dlgCapturarDatosSeguro, 1);
		m_grid.iTotalCuentas++;
		iTotalCuentas++;

		m_grid.SetColWidth(1, 83);
		m_grid.GetCell(1, 11, &m_cell);
		m_cell.SetBackColor(RGB(236, 233, 216));
		m_grid.SetCell(1, 11, &m_cell);
		m_grid.RedrawCell(1, 11);
		m_grid.GetCell(1, 17, &m_cell);
		m_cell.SetBackColor(RGB(236, 233, 216));
		m_grid.SetCell(1, 17, &m_cell);
		m_grid.RedrawCell(1, 17);
		m_grid.GetCell(1, 20, &m_cell);
		m_cell.SetBackColor(RGB(236, 233, 216));
		m_grid.SetCell(1, 20, &m_cell);
		m_grid.RedrawCell(1, 20);
		for (i = 0; i < 35; i++)
		{
			m_grid.QuickSetAlignment(1, i, UG_ALIGNLEFT);
		}

		m_grid.SetRowHeight(11, 3);
		m_grid.SetRowHeight(17, 3);
		m_grid.SetRowHeight(20, 3);

		m_grid.RedrawCol(1);

		if (m_grid.iTotalCuentas < 8)
		{
			for (k = m_grid.iTotalCuentas; k < 8; k++)
			{
				m_grid.QuickSetFont(k, -1, fontID);

				sDato.Format("ARTÍCULO %d", iCont);
				m_grid.QuickSetText(k, -1, sDato);

				m_grid.RedrawCol(k);
				iCont++;
			}
		}
		m_grid.GotoCell(0, 21);
		iRespuestaPoliza = dlgCapturarDatosSeguro.iRespuesta;
	}
}

long CDlgCapturarAbono::checarVigenciaSeguro(int iCantidadSeguros, long lTotalMinimo, long lCuotaX, long lCuotaPS, long lTotalMinimoSeguros)
{
	char cLog[500] = { 0 };
	int iDiaVenSeg = 0, iMesVenSeg = 0, iAnioVenSeg = 0, iEntro = 0, iRango = 0,
		iFlagConsulta = 0, iDiaVenPS = 0, iMesVenPS = 0, iAnioVenPS = 0;
	char cSql[500] = { 0 }, cTexto[100] = { 0 }, cTexto2[100] = { 0 }, cTexto3[100] = { 0 }, cFechaVence[20] = { 0 }, cFechaActual[20] = { 0 }, cFechaMSJ[20] = { 0 }, cMes[8] = { 0 }, cCantidad1[13] = { 0 }, cCantidad2[13] = { 0 }, cMensajeSeguimiento[50] = { 0 };
	long lRegresa = 0, lFolioSeguro = 0L;
	bool bConsulta = true, bIndividual = false, bConyugal = false, bTieneSeguro = false, bVencidoSeguro = false;
	char cStatusSeguro = ' ', cTipoCan = ' ', cClaveNoOfrecer = ' ', cSqlTxt[255] = { 0 };
	int iMesesVencidosSeguro = 0, iFlagNoOfrecer = 0, iTotal; //LA VARIABLE iFlagNoOfrecer e iTotal son nuevas para pet.15922 y la variable cSql se subio a 500
	short iDia = 0, iMes = 0, iAnio = 0;
	CString sFecVigPlan = "", sTexto = "";
	CString msjInvitacion = "";
	CString msj1 = "";

	sprintf_s(cLog, "FC0200805021521728 - entra - checarVigenciaSeguro");
	grabarLog(cLog);

	if(lTotalMinimoSeguros > 0){
		lTotalMinimo = lTotalMinimo + lTotalMinimoSeguros;
	}

	if (iCantidadSeguros < 1)
	{
		iCantidadSeguros = 1;
	}

	obtenerFlag('C', FLAGC_NOOFRECERCLUB, iFlagNoOfrecer);

	if (iFlagNoOfrecer == 1) {

		sprintf_s(cSql, "SELECT cr.claveseguro, cr.statusseguro, cr.fechavencimiento, cast( (CASE WHEN (SELECT count(1) FROM mae_crcomplementoclientes WHERE num_cliente = %ld and opc_complemento = 5) = 0 "
			"THEN '' ELSE 'S' END ) as character) as clavenoofrecer FROM crseguros cr WHERE cliente = %ld and claveseguro='C' AND tiposeguro IN (0,1)", m_grid.lCliente, m_grid.lCliente);

	}
	else {

		sprintf_s(cSql, "SELECT claveseguro,statusseguro,fechavencimiento,clavenoofrecer FROM crseguros WHERE cliente = %ld AND claveseguro='C' AND tiposeguro IN (0,1)", m_grid.lCliente);

	}

	CChecarVigenciaSeguro vigenciaSeguro(&odbc_1);
	if (vigenciaSeguro.Exec(cSql))
	{
		vigenciaSeguro.activarCols();
		while (vigenciaSeguro.Leer())
		{
			iEntro = 1;

			iDiaVenSeg = vigenciaSeguro.fechavencimiento.dia();
			iMesVenSeg = vigenciaSeguro.fechavencimiento.mes();
			iAnioVenSeg = vigenciaSeguro.fechavencimiento.ano();

			iDia = (short)iDiaVenSeg;
			iMes = (short)iMesVenSeg;
			iAnio = (short)iAnioVenSeg;

			//se agrega valor a la variable cClaveNoOfrecer para llevar valor de la clave no ofrecer para pet.15922
			cClaveNoOfrecer = vigenciaSeguro.clavenoofrecer[0];

			if (vigenciaSeguro.statusseguro[0] != 'C' && vigenciaSeguro.clavenoofrecer[0] != 'S' && vigenciaSeguro.statusseguro[0] != 'P')
			{
				if ((iEdadCliente >= iEdadMinimaClub && iEdadCliente <= iEdadMaximaClub) && iFlagBanorte >= 2)
				{
					memset(cTexto, 0, 100);

					if (bConsulta == false && iFlagConsulta != 1)
					{
						//Se obtiene el error
						grabarMensajeError("C", m_grid.iCaja, (LPTSTR)(LPCTSTR)m_grid.sServer, "CA0030", "CDlgCapturarAbono", "checarVigenciaSeguro", (LPTSTR)(LPCTSTR)cSqlTxt, m_grid.lEmpleado, "ERROR EN LA CONSULTA(checarVigenciaSeguro)", &odbc, m_grid.iMuestraMsg);
					}
					else
					{
						sprintf_s(cMensajeSeguimiento, "Metodo TieneSeguroClub 13");
						grabarLog(cMensajeSeguimiento);
						bIndividual = tieneSeguroClub(cStatusSeguro, cTipoCan, cClaveNoOfrecer, lFolioSeguro, bCteSeguro);
						sprintf_s(cMensajeSeguimiento, "Metodo TieneSeguroClubConyugal 10");
						grabarLog(cMensajeSeguimiento);
						bConyugal = tieneSeguroClubConyugal(cStatusSeguro, cTipoCan, cClaveNoOfrecer, lFolioSeguro);
						if (bIndividual || bConyugal)
						{
							bTieneSeguro = true;
							sprintf_s(cFechaVence, "%04ld%02ld%02ld", iAnioVenSeg, iMesVenSeg, iDiaVenSeg);
							sprintf_s(cFechaActual, "%04d%02d%02d", iAnioActual, iMesActual, iDiaActual);
							obtenerMes(iMesVenSeg, cMes);
							sprintf_s(cFechaMSJ, "%02ld%s%02d", iDiaVenSeg, cMes, iAnioVenSeg % 100);
							if (atol(cFechaActual) > atol(cFechaVence))
							{
								bVencidoSeguro = true;

								iMesesVencidosSeguro = (((iAnioActual - iAnioVenSeg) * 12) + (iMesActual - iMesVenSeg));

								if (lTotalMinimo > -1 && lTotalMinimo < 1000)
								{
									sprintf_s(cCantidad1, "%ld", lTotalMinimo);
								}
								else
								{
									if (lTotalMinimo > 999 && lTotalMinimo < 1000000)
									{
										usingx("###,###", cCantidad1, lTotalMinimo);
									}
									else
									{
										sprintf_s(cCantidad1, "%ld", lTotalMinimo);
									}
								}

								if (lCuotaX > -1 && lCuotaX < 1000)
								{
									sprintf_s(cCantidad2, "%ld", lCuotaX);
								}
								else
								{
									if (lCuotaX > 999 && lCuotaX < 1000000)
									{
										usingx("###,###", cCantidad2, lCuotaX);
									}
									else
									{
										sprintf_s(cCantidad2, "%ld", lCuotaX);
									}
								}
								sprintf_s(cTexto, "SU MINIMO A PAGAR ES DE $%s.", cCantidad1);
								sprintf_s(cTexto2, "SU CLUB DE PROTECCIÓN FAMILIAR VENCIÓ EL %s, LO REACTIVA POR $%s", cFechaMSJ, cCantidad2);
							}
							else if (atol(cFechaActual) <= atol(cFechaVence))
							{
								if (lTotalMinimo + lCuotaX > -1 && lTotalMinimo + lCuotaX < 1000)
								{
									sprintf_s(cCantidad1, "%ld", lTotalMinimo + lCuotaX);
								}
								else
								{
									if (lTotalMinimo + lCuotaX > 999 && lTotalMinimo + lCuotaX < 1000000)
									{
										usingx("###,###", cCantidad1, lTotalMinimo + lCuotaX);
									}
									else
									{
										sprintf_s(cCantidad1, "%ld", lTotalMinimo + lCuotaX);
									}
								}

								if (lCuotaX > -1 && lCuotaX < 1000)
								{
									sprintf_s(cCantidad2, "%ld", lCuotaX);
								}
								else
								{
									if (lCuotaX > 999 && lCuotaX < 1000000)
									{
										usingx("###,###", cCantidad2, lCuotaX);
									}
									else
									{
										sprintf_s(cCantidad2, "%ld", lCuotaX);
									}
								}
								sprintf_s(cTexto, "SU MINIMO A PAGAR ES DE $%s,", cCantidad1);
								sprintf_s(cTexto2, "INCLUYENDO $%s DE SU CLUB DE PROTECCION FAMILIAR", cCantidad2);
							}
						}
						m_msgMinimo.SetWindowText(cTexto);
						m_mensaje.SetWindowText(cTexto2);
						m_mensaje.UpdateWindow();
						lRegresa = lCuotaX;
					}
				}
			}
		}

		if (iEntro == 0) //si no tiene seguro
		{

			//PET 15922
			if (iFlagNoOfrecer == 1) {

				CMaximo consultacliente(&odbc_1);

				sprintf_s(cSql, "select count(1) from mae_crcomplementoclientes where num_cliente =%ld and opc_complemento = 5", m_grid.lCliente);

				if (consultacliente.Exec(cSql)) {

					consultacliente.activarCols();
					if (consultacliente.leer())
					{
						iTotal = consultacliente.Total;
					}
					if (iTotal >= 1) {
						cClaveNoOfrecer = 'S';
					}
				}

			}
			//termina PET 15922

			if ((iEdadCliente >= iEdadMinimaClub && iEdadCliente < iEdadMaximaClub) && iFlagBanorte >= 2)
			{
				iCantidadSeguros = 1;
				iNumeroMeses = 1;
				if (iConyugal == 1)
				{
					grabarLog("Consulta Precio seguro 9");
					if (!consultarPrecioSeguroClub(lCuotaX, (short)iCantidadSeguros, 1))
					{
						bConsulta = false;
						iFlagConsulta = 0;
					}
				}
				else
				{
					lCuotaX = obtenerCuotaClub(m_grid.lCliente, iCantidadSeguros, iNumeroMeses, iFlagBanorte, &odbc, &odbc_1, cSqlTxt, bConsulta, iFlagConsulta, iConyugal); //cawcuota.cpp
				}
				memset(cTexto, 0, 100);

				if (!bConsulta && iFlagConsulta != 1)
				{
					//Se obtiene el error
					grabarMensajeError("C", m_grid.iCaja, (LPTSTR)(LPCTSTR)m_grid.sServer, "CA0030", "CDlgCapturarAbono", "checarVigenciaSeguro", (LPTSTR)(LPCTSTR)cSqlTxt, m_grid.lEmpleado, "ERROR EN LA CONSULTA(checarVigenciaSeguro 2)", &odbc, m_grid.iMuestraMsg);
				}
				else
				{
					sprintf_s(cMensajeSeguimiento, "Metodo TieneSeguroClub 14");
					grabarLog(cMensajeSeguimiento);
					bIndividual = tieneSeguroClub(cStatusSeguro, cTipoCan, cClaveNoOfrecer, lFolioSeguro, bCteSeguro);
					sprintf_s(cMensajeSeguimiento, "Metodo TieneSeguroClubConyugal 11");
					grabarLog(cMensajeSeguimiento);
					bConyugal = tieneSeguroClubConyugal(cStatusSeguro, cTipoCan, cClaveNoOfrecer, lFolioSeguro);
					if (!bIndividual)
					{
						if (lTotalMinimo > -1 && lTotalMinimo < 1000)
						{
							sprintf_s(cCantidad1, "%ld", lTotalMinimo);
						}
						else
						{
							if (lTotalMinimo > 999 && lTotalMinimo < 1000000)
							{
								usingx("###,###", cCantidad1, lTotalMinimo);
							}
							else
							{
								sprintf_s(cCantidad1, "%ld", lTotalMinimo);
							}
						}
					}
					lRegresa = lCuotaX;
				}
			}
		}
	}
	else
	{
		//Se obtiene el error
		vigenciaSeguro.odbc->GetLastError(vigenciaSeguro.GetHstmt());
		grabarMensajeError("C", m_grid.iCaja, (LPTSTR)(LPCTSTR)m_grid.sServer, "CapturarAbono", "CDlgCapturarAbono", "checarVigenciaSeguro", cSql, m_grid.lEmpleado, "ERROR EN LA CONSULTA(checarVigenciaSeguro)", vigenciaSeguro.odbc, m_grid.iMuestraMsg);
	}

	//15922
	if (iFlagNoOfrecer == 1) {

		if (cClaveNoOfrecer == 'S') {
			bCandidatoSeguro = 0;

			sprintf_s(cSql, "SELECT respuesta FROM fun_grabar_tmp_ctesnoofrecerclub(%ld)", m_grid.lCliente);

			CInsertarCteNoOfrecer clienteNoOfrecer(&odbc);
			if (clienteNoOfrecer.Exec(cSql))
			{
				//AfxMessageBox(cSql);
				clienteNoOfrecer.activarCols();
				if (clienteNoOfrecer.leer()) {

				}
			}
		}
	}
	//TERMINA 15922

	//3858.2

	validarComplementoCliente(4, iFlagMesRegaladoCPS);
	memset(cSql, 0, sizeof(cSql));
	sprintf_s(cSql,
		"SELECT * FROM FUN_TDMENSAJEINVITACIONABONO('%d', '%d','%d', '%d', '%d', '%d', '%04d%02d%02d', '%04d%02d%02d', '%ld','%ld','%ld');",
		bCandidatoSeguro, bCandidatoPSVenta, (!((bool)iFlagMesRegalado)), (!((bool)iFlagMesRegaladoCPS)), bTieneSeguro, bBanderaTienePlan,
		iAnioVencimientoCPF, iMesVencimientoCPF, iDiaVencimientoCPF, iAnioVencimientoCPS, iMesVencimientoCPS, iDiaVencimientoCPS,
		(long)(lTotalMinimo), lCuotaX, lCuotaPS
		);
	cObtenerMensajeAbono cConsulta(&odbc);
	if (cConsulta.Exec(cSql))
	{
		cConsulta.activarCols();
		if (cConsulta.Leer())
		{
			m_msgMinimo.SetWindowText(cConsulta.msg1);
			m_mensaje.SetWindowText(cConsulta.msg2);
			m_mensaje2.SetWindowText(cConsulta.msg3);
			m_mensaje3.SetWindowText(cConsulta.msg4);
		}
	}
	else
	{
		cConsulta.odbc->GetLastError(cConsulta.GetHstmt());
		grabarMensajeError("C", m_grid.iCaja, (LPTSTR)(LPCTSTR)m_grid.sServer, "CapturarAbono", "CDlgCapturarAbono", "checarVigenciaSeguro", cSql, m_grid.lEmpleado, "ERROR AL EJECUTAR LA FUNCION(FUN_TDMENSAJEINVITACIONABONO)", cConsulta.odbc, m_grid.iMuestraMsg);
	}
	return lRegresa;
}

int CDlgCapturarAbono::vencidoSeguro(int iDiaVencSeg, int iMesVencSeg, int iAnioVencSeg)
{
	char cLog[500] = { 0 };
	char cFechaA[7] = { 0 }, cFechaS[7] = { 0 };
	int  iFlag = 0;

	sprintf_s(cLog, "FC0200805021521734 - entra - vencidoSeguro");
	grabarLog(cLog);

	sprintf_s(cFechaA, "%02d%02d%02d", iAnioActual - 2000,
		iMesActual,
		iDiaActual);
	cFechaA[6] = 0;
	sprintf_s(cFechaS, "%02d%02d%02d", iAnioVencSeg - 2000,
		iMesVencSeg,
		iDiaVencSeg);
	cFechaS[6] = 0;

	if (valor_campo(cFechaA, 6) > valor_campo(cFechaS, 6))
	{
		iFlag = 1;
	}
	return(iFlag);
}

int CDlgCapturarAbono::checarCorteCajas()
{
	char cLog[500] = { 0 };
	int iFlag = 0;

	sprintf_s(cLog, "FC0200805021521737 - entra - checarCorteCajas");
	grabarLog(cLog);

	if (iFlagTerminacion > 4 && iFlagTerminacion < 35)//valida si no se termino el passe 
	{
		iFlag = 1;
	}
	else
	{
		char cSql[110] = { 0 };

		sprintf_s(cSql, "SELECT billetes2000, numempcajero, numempgte FROM cacortecontable WHERE sistema = %d AND caja = %d", iSistema, m_grid.iCaja);

		CChecarCorteCaja checarCorteCaja(&odbc);
		if (checarCorteCaja.Exec(cSql))
		{
			checarCorteCaja.activarCols();
			if (checarCorteCaja.Leer())
			{
				if (checarCorteCaja.billetes2000 != 0L || checarCorteCaja.numempcajero > 0 || checarCorteCaja.numempgte > 0)
				{
					iFlag = 1;
				}
			}
		}
	}
	return(iFlag);
}

void CDlgCapturarAbono::procesoCierreCajas()
{
	char cLog[500] = { 0 };

	sprintf_s(cLog, "FC0200805021521741 - entra - procesoCierreCajas");
	grabarLog(cLog);

	//MENU CIERRE DE DIA CAJAS
	{
		char cNombreProyecto[100] = { 0 }, cNombreFuncionDLL[10] = { 0 }, cInputParam1[1024] = { 0 }, cInputParam2[1024] = { 0 };
		SParametros parametros;
		memset(&parametros, 0, sizeof(SParametros));

		parametros.iLink = generarLink();
		sprintf_s(parametros.sServer, "%s", (LPCTSTR)m_grid.sServer);
		parametros.iTienda = m_grid.iTienda;
		parametros.lEmpleado = m_grid.lEmpleado;
		parametros.iCajaActual = m_grid.iCaja;
		parametros.iMuestraMsg = m_grid.iMuestraMsg;
		parametros.iNumSistema = iSistema;
		parametros.lCliente = m_grid.lCliente;

		memcpy(cInputParam1, &parametros, sizeof(SParametros));

		// Ruta del archivo DLL a ejecutar
		nombreArchivo("CA0084.DLL", cNombreProyecto, DIRECTORIO_CA);
		// Nombre de la función principal en el DLL
		sprintf_s(cNombreFuncionDLL, "CA0084");


		CargarDLL cargarDll(cNombreProyecto, cNombreFuncionDLL, cInputParam1, cInputParam2);
		iRegresaDll = cargarDll.getResultado();
		if (iRegresaDll < 1)
		{
			AfxMessageBox("Error al cargar el programa CA0084");
		}
		if (iRegresaDll == 3)
		{
			iFlagCorte = 3;
		}
	}
}

void CDlgCapturarAbono::menuOperacionesVarias()
{
	char cLog[500] = { 0 };
	sprintf_s(cLog, "FC0200805021521745 - entra - menuOperacionesVarias");
	grabarLog(cLog);
	{
		// Operaciones Varias
		char cNombreProyecto[100] = { 0 }, cNombreFuncionDLL[10] = { 0 }, cInputParam1[1024] = { 0 }, cInputParam2[1024] = { 0 };
		SParametros parametros;
		memset(&parametros, 0, sizeof(SParametros));

		parametros.iLink = generarLink();
		sprintf_s(parametros.sServer, "%s", (LPCTSTR)m_grid.sServer);
		parametros.iTienda = m_grid.iTienda;
		parametros.lEmpleado = m_grid.lEmpleado;
		parametros.iCajaActual = m_grid.iCaja;
		parametros.iMuestraMsg = m_grid.iMuestraMsg;
		parametros.iNumSistema = iSistema;
		parametros.lCliente = m_grid.lCliente;

		memcpy(cInputParam1, &parametros, sizeof(SParametros));

		// Ruta del archivo DLL a ejecutar
		nombreArchivo("CA0016.DLL", cNombreProyecto, DIRECTORIO_CA);

		// Nombre de la función principal en el DLL
		sprintf_s(cNombreFuncionDLL, "CA0016");

		CargarDLL cargarDll(cNombreProyecto, cNombreFuncionDLL, cInputParam1, cInputParam2);
		iRegresaDll = cargarDll.getResultado();

		if (iRegresaDll < 1)
		{
			AfxMessageBox("Error al cargar el programa CA0016.", MB_ICONERROR);
		}
	}
}

long CDlgCapturarAbono::obtenerFacturaSeguroCancelado()
{
	char cLog[500] = { 0 };
	long lFolioRegresa = 0;
	char cSql[125] = { 0 }, cMensajeSeguimiento[150] = { 0 };

	sprintf_s(cLog, "FC0200805021521749 - entra - obtenerFacturaSeguroCancelado");
	grabarLog(cLog);

	CMaximo consultarFolioSegCancCrSeguros(&odbc_1);

	sprintf_s(cSql, "SELECT folio FROM crseguros WHERE cliente = %ld AND claveseguro='C' AND tiposeguro IN (0,1) ORDER BY keyx LIMIT 1", m_grid.lCliente);

	if (!consultarFolioSegCancCrSeguros.Exec(cSql))
	{
		//Se obtiene el error
		consultarFolioSegCancCrSeguros.odbc->GetLastError(consultarFolioSegCancCrSeguros.GetHstmt());
		grabarMensajeError("C", m_grid.iCaja, (LPTSTR)(LPCTSTR)m_grid.sServer, "CapturarAbono", "CDlgCapturarAbono", "obtenerFacturaSeguroCancelado", cSql, m_grid.lEmpleado, "ERROR EN LA CONSULTA(obtenerFacturaSeguroCancelado)", consultarFolioSegCancCrSeguros.odbc, m_grid.iMuestraMsg);
	}
	else
	{
		consultarFolioSegCancCrSeguros.activarCols();
		if (consultarFolioSegCancCrSeguros.Leer())
		{
			lFolioRegresa = consultarFolioSegCancCrSeguros.Total;
			sprintf_s(cMensajeSeguimiento, "obtenerFacturaSeguroCancelado:obtiene folio de la tabla crseguros Folio: %ld", lFolioRegresa);
			grabarLog(cMensajeSeguimiento);
		}
	}
	return lFolioRegresa;
}

bool CDlgCapturarAbono::obtenerPolizaSeguro(long &lPoliza, int iTipo)
{
	char cLog[500] = { 0 };
	char cSql[50] = { 0 };
	bool bContinuar = true;

	sprintf_s(cLog, "FC0200805021521753 - entra - obtenerPolizaSeguro");
	grabarLog(cLog);

	sprintf_s(cSql, "SELECT folio FROM crPolizas WHERE tipo = %d", iTipo);

	CMaximo crPolizaSQL(&odbc_1);
	if (crPolizaSQL.Exec(cSql))
	{
		crPolizaSQL.activarCols();
		if (crPolizaSQL.Leer())
		{
			lPoliza = crPolizaSQL.Total;
		}
	}
	else
	{
		crPolizaSQL.odbc->GetLastError(crPolizaSQL.GetHstmt());
		grabarMensajeError("N", iCajaDlg, (LPTSTR)(LPCTSTR)m_grid.sServer, "CA0030", "CDlgCapturarBeneficiarioSeguroClub", "obtenerPolizaSeguro", cSql, lEmpleadoDlg, "ERROR EN LA CONSULTA", crPolizaSQL.odbc, iMuestraMsg);
		bContinuar = false;
	}
	return bContinuar;
}

void CDlgCapturarAbono::obtenerMes(int iMes, char *cNomMes)
{
	memset(cNomMes, 0, 5);
	char * meses[] = { "000","ENE","FEB","MAR","ABR","MAY","JUN","JUL","AGO","SEP","OCT","NOV","DIC" };
	sprintf(cNomMes, "%s", meses[iMes]);
}

bool CDlgCapturarAbono::datosDeCliente(int &iCasa, int &iColonia, int &iCalle, int &iCiudad, long &lCodigoPostal, char *cNombreCalle, char *cNombreZona, char *cNombreCiudad)
{
	char cLog[500] = { 0 };
	int iInicio = 0;
	bool bContinuar = true;
	char cSql[200] = { 0 };

	sprintf_s(cLog, "FC0200805021521761 - entra - datosDeCliente");
	grabarLog(cLog);

	memset(cNombreCalle, 0, sizeof(cNombreCalle));
	memset(cNombreZona, 0, sizeof(cNombreZona));
	memset(cNombreCiudad, 0, sizeof(cNombreCiudad));

	//Buscar datos del cliente en crCliente
	sprintf_s(cSql, "SELECT cliente, puntualidad, casa, telefono, nombre, apellidopaterno, apellidomaterno, fechanacimiento, calle, ciudad, colonia, limitecredito FROM crCliente WHERE cliente = %ld ", m_grid.lCliente);
	CObtenerDatosCliente crClienteSQL(&odbc_1);

	if (crClienteSQL.Exec(cSql))
	{
		crClienteSQL.activarCols();
		if (crClienteSQL.Leer())
		{
			iCasa = crClienteSQL.casa;
			iCalle = crClienteSQL.calle;
			iColonia = crClienteSQL.colonia;
			iCiudad = crClienteSQL.ciudad;
		}
	}
	else
	{
		crClienteSQL.odbc->GetLastError(crClienteSQL.GetHstmt());
		grabarMensajeError("N", iCajaDlg, (LPTSTR)(LPCTSTR)m_grid.sServer, "CA0030", "CDlgCapturarBeneficiarioSeguroClub", "datosDeCliente", cSql, lEmpleadoDlg, "ERROR EN LA CONSULTA", crClienteSQL.odbc, iMuestraMsg);
		bContinuar = false;
	}

	if (bContinuar)
	{
		sprintf_s(cSql, "SELECT calle, nombrecalle FROM crCalles WHERE calle = %d", iCalle);
		CConsultarCalle crCallesSQL(&odbc_1);
		if (crCallesSQL.Exec(cSql))
		{
			crCallesSQL.activarCols();
			if (crCallesSQL.Leer())
			{
				sprintf(cNombreCalle, "%s", crCallesSQL.nombrecalle);
			}
		}
		else
		{
			crCallesSQL.odbc->GetLastError(crCallesSQL.GetHstmt());
			grabarMensajeError("N", iCajaDlg, (LPTSTR)(LPCTSTR)m_grid.sServer, "CA0030", "CDlgCapturarBeneficiarioSeguroClub", "datosDeCliente", cSql, lEmpleadoDlg, "ERROR EN LA CONSULTA", crCallesSQL.odbc, iMuestraMsg);
			bContinuar = false;
		}

		if (bContinuar)
		{
			sprintf_s(cSql, "SELECT nombrezona,municipio,codigopostal FROM crZonas WHERE ciudad=%d AND colonia = %d", iCiudad, iColonia);
			CConsultarZonaCliente crZonaSQL(&odbc_1);
			if (crZonaSQL.Exec(cSql))
			{
				crZonaSQL.activarCols();
				if (crZonaSQL.Leer())
				{
					sprintf(cNombreZona, "%s", crZonaSQL.nombrezona);
					sprintf(cNombreCiudad, "%s", crZonaSQL.municipio);
					lCodigoPostal = crZonaSQL.codigopostal;
				}
			}
			else
			{
				crZonaSQL.odbc->GetLastError(crZonaSQL.GetHstmt());
				grabarMensajeError("N", iCajaDlg, (LPTSTR)(LPCTSTR)m_grid.sServer, "CA0030.EXE", "CDlgCapturarBeneficiarioSeguroClub", "datosDeCliente", cSql, lEmpleadoDlg, "ERROR EN LA CONSULTA", crZonaSQL.odbc, iMuestraMsg);
				bContinuar = false;
			}
		}
	}
	return bContinuar;
}

bool CDlgCapturarAbono::tieneSeguroClubConyugal(char &cStatusSeguro, char &cTipoCan, char &cClaveNoOfrecer, long &lFolioSeguro)
{
	char cSql[500] = { 0 }, cMensaje[100] = { 0 };
	bool bContinuar = false;
	char cClaveSeguro = ' ';
	int iFlagNoOfrecer = 0; //SE AGREGA VARIABLE PARA PET.15922 Y SE SUBE cSql a 500

	obtenerFlag('C', FLAGC_NOOFRECERCLUB, iFlagNoOfrecer);

	if (iFlagNoOfrecer == 1) {

		sprintf_s(cSql, "SELECT cr.claveseguro, cr.statusseguro, cr.folio, cr.tipocancelacion, (CASE WHEN (SELECT count(1) FROM mae_crcomplementoclientes WHERE num_cliente = %ld and opc_complemento = 5) = 0 "
			"THEN '' ELSE 'S' END ) AS clavenoofrecer, cr.fechavencimiento FROM crseguros cr "
			"WHERE cliente = %ld and claveseguro = 'C' AND claveconyugal = 1 ORDER BY statusseguro,fechaafiliacion LIMIT 1", m_grid.lCliente, m_grid.lCliente);

	}
	else {

		sprintf_s(cSql, "SELECT claveseguro, statusseguro, folio, tipocancelacion, clavenoofrecer, fechavencimiento FROM crseguros WHERE claveseguro = 'C' AND cliente = %ld AND claveconyugal = 1 ORDER BY statusseguro,fechaafiliacion LIMIT 1", m_grid.lCliente);
	}

	CConsultarCrSegurosClub crSegurosSQL(&odbc_1);
	if (crSegurosSQL.Exec(cSql))
	{
		crSegurosSQL.activarCols();
		if (crSegurosSQL.Leer())
		{
			lFolioSeguro = crSegurosSQL.folio;
			sprintf_s(cMensaje, "Se obntiene seguro Conyugal de la tabla crseguro folio: %ld", lFolioSeguro);
			grabarLog(cMensaje);
			cClaveSeguro = crSegurosSQL.claveseguro[0];
			cStatusSeguro = crSegurosSQL.statusseguro[0];
			cTipoCan = crSegurosSQL.tipocancelacion[0];
			cClaveNoOfrecer = crSegurosSQL.clavenoofrecer[0];
			bContinuar = true;
		}
	}
	else
	{
		crSegurosSQL.odbc->GetLastError(crSegurosSQL.GetHstmt());
		grabarMensajeError("C", m_grid.iCaja, (LPTSTR)(LPCTSTR)m_grid.sServer, "CapturarAbono", "CDlgCapturarAbono", "tieneSeguroClubConyugal", cSql, m_grid.lEmpleado, "ERROR EN LA CONSULTA(tieneseguroclubConyugal)", crSegurosSQL.odbc, m_grid.iMuestraMsg);
		bContinuar = false;

	}
	return bContinuar;
}

void separarConyuge(char *cNombreConyuge, char *cApPaternoc, char *cApMaternoc, char *cNombrec)
{
	CUtil util;
	char cLog[500] = { 0 };
	int i = 0, iControl = 1, j = 0;

	sprintf_s(cLog, "FC0200805021521769 - entra - separarConyuge");
	util.GrabarLog(cLog);

	for (i = 0; i < 32; i++)
	{
		if (cNombreConyuge[i] == ' ')
		{
			cNombreConyuge[i] = '*';
		}
	}
	for (i = 0; i < 32; i++)
	{
		if (iControl == 1)
		{
			cApPaternoc[j] = cNombreConyuge[i];
			if (cNombreConyuge[i] == '*')
			{
				cApPaternoc[j] = 0;
				j = 0;
				iControl++;
			}
			else
			{
				j++;
			}
		}
		else
		{
			if (iControl == 2)
			{
				cApMaternoc[j] = cNombreConyuge[i];
				if (cNombreConyuge[i] == '*')
				{
					cApMaternoc[j] = 0;
					j = 0;
					iControl++;
				}
				else
				{
					j++;
				}
			}
			else
			{
				if (iControl == 3)
				{
					if (cNombreConyuge[i] == '*')
					{
						cNombrec[j] = ' ';
					}
					else
					{
						cNombrec[j] = cNombreConyuge[i];
					}
					j++;
				}
				cNombrec[15] = 0;
			}
		}
	}
}

static int PantallaMenuConyugal(void)
{
	CUtil util;
	char cLog[500] = { 0 };
	unsigned char sc = 0, ac = 0;
	int iFlag = 3;

	sprintf_s(cLog, "FC0200805021521773 - entra - PantallaMenuConyugal");
	util.GrabarLog(cLog);

	while (iFlag == 3)
	{
		char * opciones[] = {
			" F1  CLUB DE PROTECCIÓN FAMILIAR ",
			" Esc SALIR                       ",
			"" };
		int respuesta[] = { F1,ESC,0 };
		C_Menu menu(" CLUB DE PROTECCION FAMILIAR ", opciones, respuesta);
		switch (menu.OpcionSeleccionada())
		{
		case F1:
			iFlag = 1;
			break;
		case ESC:
			iFlag = 0;
		default:
			break;
		}
	}
	return(iFlag);
}

int ChecarCantidadSeguros(int iTipo, long lCliente, long lFolio)
{
	CUtil util;
	char cLog[500] = { 0 };
	char cSql[125] = { 0 };
	int iSeguros = 0;

	sprintf_s(cLog, "FC0200805021521777 - entra - ChecarCantidadSeguros");
	util.GrabarLog(cLog);

	sprintf_s(cSql, "SELECT cantidadseguros FROM crseguros WHERE cliente = %ld and folio = %ld and claveconyugal = %d;", lCliente, lFolio, iTipo);

	CMaximo crSegurosSQL(&odbc_1);
	if (crSegurosSQL.Exec(cSql))
	{
		crSegurosSQL.activarCols();
		if (crSegurosSQL.Leer())
		{
			iSeguros = crSegurosSQL.Total;
		}
	}
	else
	{
		crSegurosSQL.odbc->GetLastError(crSegurosSQL.GetHstmt());
		//grabarMensajeError( "C", m_grid.iCaja, (LPTSTR)(LPCTSTR)m_grid.sServer, "CapturarAbono", "CDlgCapturarAbono", "ChecarCantidadSeguros", (LPTSTR)(LPCTSTR)sConsulta,m_grid.lEmpleado,"ERROR EN LA CONSULTA(ChecarCantidadSeguros)",crSegurosSQL.odbc,m_grid.iMuestraMsg);
	}
	return iSeguros;
}

bool CDlgCapturarAbono::grabarTmpCrCmueblesPlanes()
{
	char cLog[500] = { 0 };
	bool bResultado = false;
	char cTexto[100] = { 0 }, cArchivo[30] = { 0 }, cFinLinea[5] = { 0 }, cTpoImpre[5] = { 0 };
	int iEjecutar = 0;

	struct TaPagos
	{
		char cEstado[3],
			cContrato[9];
	}taPagos;

	memset(&taPagos, 0, sizeof(TaPagos));

	sprintf_s(cLog, "FC0200805021521781 - entra - grabarTmpCrCmueblesPlanes");
	grabarLog(cLog);

	grabarLog("grabarTmpCrCmueblesPlanes::Actualizando Cartera de planes");

	if (bTienePlantel == true)
	{
		if (_access("C:\\SYS\\PROGS\\TAPAGOS.EXE", 0) != 0)
		{
			AfxMessageBox("HABLAR A MESA DE AYUDA DE SISTEMAS, NO EXISTE MODULO C:\\SYS\\PROGS\\TAPAGOS.EXE");
		}
		else
		{
			char cSql[130] = { 0 };

			sprintf_s(cTpoImpre, "%1d", iTipoImpresora);
			sprintf_s(cFinLinea, "%1d", iFinLinea);

			CTmpAbonoCrCmueblesPlanFija tmpPlan(&odbc_1);

			sprintf_s(cSql, "SELECT cliente,factura,abonosmes from tmpabonocrcmueblesplanes where sistema = %d and caja = %d and tienda = %d ", iSistema, m_grid.iCaja, m_grid.iTienda);
			if (tmpPlan.Exec(cSql))
			{
				tmpPlan.activarCols();
				while (tmpPlan.Leer())
				{

					memset(cTexto, ' ', sizeof(cTexto));
					memset(cArchivo, ' ', sizeof(cArchivo));

					sprintf_s(cArchivo, "c:\\sys\\mem\\tapagos.res");

					if (_access(cArchivo, 0) == 0) _unlink(cArchivo);

					m_mensaje.SetWindowText(" FAVOR DE ESPERAR, ACTUALIZANDO CARTERA DE PLANES ...  ");

					sprintf_s(cTexto, "3 %03d C %02ld %09ld %07ld %06ld %07ld %s %c %c",
						m_grid.iTienda,
						m_grid.iCaja,
						m_grid.lCliente,
						tmpPlan.factura,
						lNumeroRecibo,
						tmpPlan.abonosmes,
						cIpServidorPlanes,
						cTpoImpre[0],
						cFinLinea[0]
					);

					iEjecutar = (int)_spawnl(P_WAIT, "c:\\sys\\progs\\tapagos.exe", "c:\\sys\\progs\\tapagos.exe", cTexto, NULL);
					if (iEjecutar < 0)
					{
						AfxMessageBox("Error al cargar el programa tapagos.exe", MB_ICONERROR);
					}
				}
			}
			else
			{
				//Se obtiene el error
				tmpPlan.odbc->GetLastError(tmpPlan.GetHstmt());
				grabarMensajeError("C", m_grid.iCaja, (LPTSTR)(LPCTSTR)m_grid.sServer, "CapturarAbono", "CDlgCapturarAbono", "grabarTmpCrCmueblesPlanes", cSql, m_grid.lEmpleado, "ERROR EN LA CONSULTA(grabarTmpCrCmueblesPlanes)", tmpPlan.odbc, m_grid.iMuestraMsg);
			}
		}
	}
	return  bResultado;
}

bool CDlgCapturarAbono::decrementarFolioCajas()
{
	char cLog[500] = { 0 };
	bool bResultado = false;
	char cSql[55] = { 0 };

	if (iSistema == 1)
	{
		sprintf_s(cSql, "SELECT gnincrementarfolio('M', '99', '7', '-1' ) ");
	}

	if (iSistema == 2)
	{
		sprintf_s(cSql, "SELECT gnincrementarfolio('R', '98', '7', '-1' ) ");
	}

	if (iSistema == 3)
	{
		sprintf_s(cSql, "SELECT gnincrementarfolio('C', '%d', '7', '-1' ) ", m_grid.iCaja);
	}

	CMaximo folioCoppel(&odbc);

	sprintf_s(cLog, "FC0200805021521785 - entra - decrementarFolioCajas");
	grabarLog(cLog);

	if (folioCoppel.Exec(cSql))
	{
		folioCoppel.activarCols();
		if (folioCoppel.Leer())
		{
			bResultado = true;
		}
	}
	else
	{
		folioCoppel.odbc->GetLastError(folioCoppel.GetHstmt());
		grabarMensajeError("C", m_grid.iCaja, (LPTSTR)(LPCTSTR)m_grid.sServer, "CapturarAbono", "CDlgCapturarAbono", "decrementarFolioCajas", cSql, m_grid.lEmpleado, "ERROR EN LA CONSULTA(incrementarfoliocajas)", folioCoppel.odbc, m_grid.iMuestraMsg);
	}
	return  bResultado;
}

bool CDlgCapturarAbono::decrementarFolioSeguroCajas()
{
	char cLog[500] = { 0 };
	bool bResultado = false;
	char cSql[50] = { 0 };

	sprintf_s(cLog, "FC0200805021521789 - entra - decrementarFolioSeguroCajas");
	grabarLog(cLog);

	sprintf_s(cSql, "SELECT gnincrementarfolio('C', '0', '2', '-1' )");

	CMaximo  folioCoppel(&odbc);
	if (folioCoppel.Exec(cSql))
	{
		folioCoppel.activarCols();
		if (folioCoppel.Leer())
		{
			bResultado = true;
		}
	}
	else
	{
		folioCoppel.odbc->GetLastError(folioCoppel.GetHstmt());
		grabarMensajeError("C", m_grid.iCaja, (LPTSTR)(LPCTSTR)m_grid.sServer, "CapturarAbono", "CDlgCapturarAbono", "decrementarFolioSeguroCajas", cSql, m_grid.lEmpleado, "ERROR EN LA CONSULTA(incrementarfoliocajas)", folioCoppel.odbc, m_grid.iMuestraMsg);
	}
	return  bResultado;
}

bool CDlgCapturarAbono::decrementarFolioRecibo()
{
	char cLog[500] = { 0 };
	bool bResultado = false;
	char cSql[55] = { 0 };

	sprintf_s(cLog, "FC0200805021521793 - entra - decrementarFolioRecibo");
	grabarLog(cLog);

	sprintf_s(cSql, "SELECT gnincrementarfolio('C', '%d', '7', '-1' )", m_grid.iCaja);

	CMaximo folioCoppel(&odbc);
	if (folioCoppel.Exec(cSql))
	{
		folioCoppel.activarCols();
		if (folioCoppel.Leer())
		{
			bResultado = true;
		}
	}
	else
	{
		folioCoppel.odbc->GetLastError(folioCoppel.GetHstmt());
		grabarMensajeError("C", m_grid.iCaja, (LPTSTR)(LPCTSTR)m_grid.sServer, "CapturarAbono", "CDlgCapturarAbono", "decrementarFolioRecibo", cSql, m_grid.lEmpleado, "ERROR EN LA CONSULTA(incrementarfoliocajas)", folioCoppel.odbc, m_grid.iMuestraMsg);
	}
	return  bResultado;
}

bool CDlgCapturarAbono::verificarUltimoRecibo()
{
	char cLog[500] = { 0 };
	bool bRespuesta = false;
	char cSql[40] = { 0 };

	sprintf_s(cLog, "FC0200805021521797 - entra - verificarUltimoRecibo");
	grabarLog(cLog);

	grabarLog("verificarUltimoRecibo::Verificando numero de recibo");

	if (iSistema == 1)
	{
		sprintf_s(cSql, "SELECT caverificarultimorecibo('99')");
	}
	else if (iSistema == 2)
	{
		sprintf_s(cSql, "SELECT caverificarultimorecibo('98')");
	}
	else
	{
		sprintf_s(cSql, "SELECT caverificarultimorecibo('%d')", iCajaActual);
	}

	CMaximo verificarRecibo(&odbc, false);

	if (!verificarRecibo.Exec(cSql))
	{
		verificarRecibo.odbc->GetLastError(verificarRecibo.GetHstmt());
		grabarMensajeError("C", m_grid.iCaja, (LPTSTR)(LPCTSTR)m_grid.sServer, "CapturarAbono", "CDlgCapturarAbono", "verificarUltimoRecibo", cSql, m_grid.lEmpleado, "ERROR EN LA CONSULTA(verificarUltimoRecibo)", verificarRecibo.odbc, m_grid.iMuestraMsg);
		bRespuesta = false;
	}
	else
	{
		verificarRecibo.activarCols();
		if (verificarRecibo.leer())
		{
			lNumeroRecibo = verificarRecibo.Total;
			lFolioGrabarAbono = verificarRecibo.Total;
			bRespuesta = true;
		}
	}
	return bRespuesta;
}

int CDlgCapturarAbono::obtenerClaveConyugalCrSegurosAf(long lCliente)
{
	char cLog[500] = { 0 };
	char cSql[85] = { 0 };
	int iClaveConyugal = 0;

	sprintf_s(cLog, "FC0200805021521801 - entra - obtenerClaveConyugalCrSegurosAf");
	grabarLog(cLog);

	sprintf_s(cSql, "SELECT claveconyugal FROM crseguros WHERE cliente = %d AND claveseguro='S'", lCliente);
	CConsultarClaveConyugalCrSeguros claveConyugalCrSeguros(&odbc_1);
	if (!claveConyugalCrSeguros.Exec(cSql))
	{
		//Se obtiene el error
		claveConyugalCrSeguros.odbc->GetLastError(claveConyugalCrSeguros.GetHstmt());
		grabarMensajeError("C", m_grid.iCaja, (LPTSTR)(LPCTSTR)m_grid.sServer, "CapturarAbono", "CDlgCapturarAbono", "obtenerClaveConyugalCrSeguros", cSql, m_grid.lEmpleado, "ERROR EN LA CONSULTA(obtenerClaveConyugaCrSeguros)", claveConyugalCrSeguros.odbc, m_grid.iMuestraMsg);
	}
	else
	{
		claveConyugalCrSeguros.activarCols();
		while (claveConyugalCrSeguros.Leer())
		{
			iClaveConyugal = claveConyugalCrSeguros.claveconyugal;
		}
	}
	return(iClaveConyugal);
}

bool CDlgCapturarAbono::verificarEmpleadoTdClaves(long lEmpleado, int &iEncontro)
{
	char cLog[500] = { 0 };
	bool bRespuesta = false;
	char cSql[80] = { 0 };
	iEncontro = 0;

	sprintf_s(cLog, "FC0200805021521805 - entra - verificarEmpleadoTdClaves");
	grabarLog(cLog);

	sprintf_s(cSql, "SELECT empleado FROM tdclaves WHERE empleado = %ld AND area = 'C'", lEmpleado);

	CMaximo consultarClaves(&odbc);

	if (!consultarClaves.Exec(cSql))
	{
		consultarClaves.odbc->GetLastError(consultarClaves.GetHstmt());
		grabarMensajeError("C", m_grid.iCaja, (LPTSTR)(LPCTSTR)m_grid.sServer, "CapturarAbono", "CDlgCapturarAbono", "verificarEmpleadoTdClaves", cSql, m_grid.lEmpleado, "ERROR EN LA CONSULTA(verificarEmpleadoTdClaves)", consultarClaves.odbc, m_grid.iMuestraMsg);
	}
	else
	{
		consultarClaves.activarCols();
		if (consultarClaves.leer())
		{
			iEncontro = 1;
		}
	}
	return bRespuesta;
}

void CDlgCapturarAbono::checarEncuestaEdosCtas()
{
	char cLog[500] = { 0 };
	char cSql[80] = { 0 };

	sprintf_s(cLog, "FC0200805021521809 - entra - checarEncuestaEdosCtas");
	grabarLog(cLog);

	sprintf_s(cSql, "SELECT status,fecha,totaledoscta,keyx FROM caencuestaedocta ORDER BY fecha");

	CConsultarCaEncuestaEdoCta consultarCaEncuestaEdoCta(&odbc);

	if (consultarCaEncuestaEdoCta.Exec(cSql))
	{
		consultarCaEncuestaEdoCta.activarCols();
		while (consultarCaEncuestaEdoCta.leer())
		{
			if (consultarCaEncuestaEdoCta.status == 1)
			{
				if (iDiaActual >= consultarCaEncuestaEdoCta.fecha.dia() && consultarCaEncuestaEdoCta.fecha.mes() == iMesActual && consultarCaEncuestaEdoCta.fecha.ano() == iAnioActual)
				{
					lKeyxEdoCtas = consultarCaEncuestaEdoCta.keyx;
					iFlagExisteEncuesta = (int)consultarCaEncuestaEdoCta.status;
					if (consultarCaEncuestaEdoCta.totaledoscta == -3)
						lTotalEdosCta = 0;
					else
						lTotalEdosCta = consultarCaEncuestaEdoCta.totaledoscta;
					break;
				}
			}
		}
	}
}

int CDlgCapturarAbono::desplegarDatosClienteEtp()
{
	char cLog[500] = { 0 };
	int iFlag = 0, j = 0;
	CString sDato;

	sprintf_s(cLog, "FC0200805021521813 - entra - desplegarDatosClienteEtp");
	grabarLog(cLog);

	sDato.Format("%d", 0);
	m_grid.QuickSetText(0, 12, sDato);
	m_grid.QuickSetAlignment(0, 12, UG_ALIGNRIGHT);

	sDato.Format("%d", 0);
	m_grid.QuickSetText(0, 13, sDato);
	m_grid.QuickSetAlignment(0, 13, UG_ALIGNRIGHT);

	sDato.Format("%d", 0);
	m_grid.QuickSetText(0, 14, sDato);
	m_grid.QuickSetAlignment(0, 14, UG_ALIGNRIGHT);

	sDato.Format("%d", 0);
	m_grid.QuickSetText(0, 15, sDato);
	m_grid.QuickSetAlignment(0, 15, UG_ALIGNRIGHT);

	sDato.Format("%d", 0);
	m_grid.QuickSetText(0, 16, sDato);
	m_grid.QuickSetAlignment(0, 16, UG_ALIGNRIGHT);

	sDato.Format("%d", 0);
	m_grid.QuickSetText(0, 18, sDato);
	m_grid.QuickSetAlignment(0, 18, UG_ALIGNRIGHT);

	sDato.Format("%d", 0);
	m_grid.QuickSetText(0, 19, sDato);
	m_grid.QuickSetAlignment(0, 19, UG_ALIGNRIGHT);

	sDato.Format("%d", 0);
	m_grid.QuickSetText(0, 21, sDato);
	m_grid.QuickSetAlignment(0, 21, UG_ALIGNRIGHT);

	for (j = 22; j < 34; j++) //ciclo para blanquear las columnas ocultas de la 22 a la 33
	{
		sDato.Format("%d", 0);
		m_grid.QuickSetText(0, j, sDato);
		m_grid.RedrawCell(0, j);
	}

	iFoco = 1;
	asignarFoco();
	m_grid.GotoCell(0, 21);
	m_grid.RedrawAll();
	iFlag = 1;
	return iFlag;
}

bool CDlgCapturarAbono::GrabarCarmovx()
{    
	char cMensaje[200] = { 0 };
	bool bFlag = false, bGrabar = false, bSeguro = false;
	CString sql = "";
	CString sXml;
	int iMov = 0, iEnganche = 0, iNumeroArticulos = 0, iDevolucionFactura = 0, iFactura = 0, iAbono = 0, iDiaSaldaCon = 0, iMesSaldaCon, iAnioSaldaCon = 0;
	char cNombre[17] = { 0 }, cApellidoPat[17] = { 0 }, cApellidoMat[17] = { 0 }, cIva[2] = { 0 }, cFechaNacimiento[12] = { 0 }, cFlagSeguroConyugal = ' ', cTipoConvenio = ' ', cTipoGrabado = ' ';
	short iParentesco = 0, iDiaNac = 0, iMesNac = 0, iAnioNac = 0;
	string sSql;

	sprintf_s(cMensaje, "FC0200805021521817 - entra - GrabarCarmovx");
	grabarLog(cMensaje);

	grabarLog("CDlgCapturarAbono::GrabarCarmovx::grabando abonos en carmovx");

	CGrabarCrCarmovX consultarCaCarmov(&odbc, false);
	CMaximo grabarCarmovx(&odbc_1, false);

	sql.Format("SELECT clave, tipomovimiento, tienda, ciudad, cliente, clienteetp, caja, recibo, factura, importe, saldoinicial, saldofinal, saldocuenta,"
		"vencidoinicial, minimoinicial, base, fechasaldacon, importesaldacon, tipoconvenio, subtipoconvenio, plazoconvenio, ejercicio, clavetdaocob,"
		"grabacartera, anexo, clavelocal, clientelocalizar, tiposeguro, flagseguroconyugal, movtoseguro, flagmontoseguro, statusseguro, causabaja,"
		"cantidadseguros, cantidadsegurosanterior, cantidadmeses, bonificacion, mesesvencidos, fechanacimiento, edad, sexo, areaajuste,"
		"fechaabonoajuste, claveajuste, ajuste, tiendaorigen, numerocontrol, comision, clienteremitente, tipogastoviaje, centro, flagincluyerecibo,"
		"ruta, folio, cuenta, iva, telefono, compania, contrato, credito, fechavencimiento, fechavencimientoanterior, fecha, efectuo, cajaoriginal,"
		"foliotienda, rpu, flagmovtosupervisor, interes, importeventa, folioanterior, digito, sac, ipcarteracliente,"
		"fol_sucursal, num_cliente, num_movimiento, clv_statusmovimiento, fechadocumento "
		"FROM cacarmov WHERE recibo = %ld and caja = %d and not (clave = 'G' and tipomovimiento = '1' and tiposeguro in ('4','5') and flagseguroconyugal in ('3','4'))", lNumeroRecibo, iCajaActual);
	grabarLog(sql.GetBuffer());
	if (!consultarCaCarmov.Exec(sql.GetBuffer()))
	{
		grabarMensajeError("C", m_grid.iCaja, (LPTSTR)(LPCTSTR)m_grid.sServer, "CapturarAbono", "CDlgCapturarAbono", "GrabarCarmovx", sql.GetBuffer(), m_grid.lEmpleado, "ERROR EN LA CONSULTA(GrabarCarmovx)", consultarCaCarmov.odbc, m_grid.iMuestraMsg);
	}
	else
	{
		consultarCaCarmov.activarCols();
		while (consultarCaCarmov.leer())
		{
			if (consultarCaCarmov.clave[0] == 'S' || consultarCaCarmov.clave[0] == 'I')
			{
				if (consultarCaCarmov.tipomovimiento[0] == '1' || consultarCaCarmov.tipomovimiento[0] == '2' ||
					consultarCaCarmov.tipomovimiento[0] == '5' || consultarCaCarmov.tipomovimiento[0] == '6' ||
					consultarCaCarmov.tipomovimiento[0] == '7' || consultarCaCarmov.tipomovimiento[0] == '8' ||
					consultarCaCarmov.tipomovimiento[0] == '9' || consultarCaCarmov.tipomovimiento[0] == 'A' ||
					consultarCaCarmov.tipomovimiento[0] == 'B' || consultarCaCarmov.tipomovimiento[0] == 'C' ||
					consultarCaCarmov.tipomovimiento[0] == 'D' || consultarCaCarmov.tipomovimiento[0] == 'F' ||
					consultarCaCarmov.tipomovimiento[0] == 'I' || consultarCaCarmov.tipomovimiento[0] == '3' || //abono TA interes TA
					consultarCaCarmov.tipomovimiento[0] == 'L' || consultarCaCarmov.tipomovimiento[0] == 'M' ||   // Bonificacion TA Convenio TA
					consultarCaCarmov.tipomovimiento[0] == 'J' || consultarCaCarmov.tipomovimiento[0] == 'Q' ||   // Abono Bancoppel, Convenio Bancoppel
					consultarCaCarmov.tipomovimiento[0] == 'K' || consultarCaCarmov.tipomovimiento[0] == '4'      // Bonificacion Bancoppel, Pago interes Adicional Bancoppel
					)
				{
					bGrabar = true;
					iMov++;
				}
			}
			if (consultarCaCarmov.clave[0] == 'D')
			{
				if (consultarCaCarmov.tipomovimiento[0] == '2' || consultarCaCarmov.tipomovimiento[0] == '7' ||
					consultarCaCarmov.tipomovimiento[0] == '8'
					)
				{
					bGrabar = true;
					iMov++;
				}
			}
			// 9923 --> Grabado de movimientos en carmovx
			if (consultarCaCarmov.clave[0] == 'G')
			{
				if (consultarCaCarmov.tipomovimiento[0] == '1' || consultarCaCarmov.tipomovimiento[0] == '2' ||
					consultarCaCarmov.tipomovimiento[0] == '6')
				{
					bGrabar = true;
					bSeguro = true;
					iMov++;
				}
			}

			if (bGrabar)
			{
				sXml = "";
				iEnganche = 0, iNumeroArticulos = 0, iDevolucionFactura = iFactura = iAbono = 0;
				cFlagSeguroConyugal = ' ';
				cTipoConvenio = consultarCaCarmov.tipoconvenio[0];
				sprintf_s(cFechaNacimiento, "1900-01-01");
				sprintf_s(cNombre, " ");
				sprintf_s(cApellidoPat, " ");
				sprintf_s(cApellidoMat, " ");
				iParentesco = 0;
				iAnioSaldaCon = consultarCaCarmov.fechasaldacon.ano();
				iMesSaldaCon = consultarCaCarmov.fechasaldacon.mes();
				iDiaSaldaCon = consultarCaCarmov.fechasaldacon.dia();

				if (consultarCaCarmov.clave[0] == 'G' && consultarCaCarmov.tipomovimiento[0] == '6')
				{
					iEnganche = 1; // el seguro nacio como Club de Proteccion Familiar
					if (iFlagMesRegalado == 1)
					{
						iNumeroArticulos = 1;//Se le regalo un mes al seguro
					}
				}

				if (bSeguro)
				{
					iFactura = consultarCaCarmov.folio;
					if (consultarCaCarmov.flagseguroconyugal[0] == '1' && consultarCaCarmov.tiposeguro[0] == '2') //Seg. Adicional
					{
						cFlagSeguroConyugal = 'A';
						obtenerDatosAdicional(consultarCaCarmov.folio, cNombre, cApellidoPat, cApellidoMat, iParentesco, iDiaNac, iMesNac, iAnioNac);
						iAnioSaldaCon = iAnioNac;
						iMesSaldaCon = iMesNac;
						iDiaSaldaCon = iDiaNac;
					}
					else if (consultarCaCarmov.flagseguroconyugal[0] == '1' && consultarCaCarmov.tiposeguro[0] == '1')//Seg Titular c/Adicionales
					{
						cFlagSeguroConyugal = 'I';
					}
					else if (consultarCaCarmov.tiposeguro[0] == '3')
					{
						cFlagSeguroConyugal = '3';
						iFactura = consultarCaCarmov.factura;
						sprintf_s(cFechaNacimiento, "%04d-%02d-%02d", consultarCaCarmov.fechanacimiento.ano(), consultarCaCarmov.fechanacimiento.mes(), consultarCaCarmov.fechanacimiento.dia());
						iDevolucionFactura = consultarCaCarmov.folioanterior;
					}
					else // Movimiento a Seguro Normal.
					{
						cFlagSeguroConyugal = ' ';
					}
				}
				else
				{
					iFactura = consultarCaCarmov.factura;
					cFlagSeguroConyugal = consultarCaCarmov.flagseguroconyugal[0];
				}

				//Insertar interes mes uno
				if (consultarCaCarmov.clave[0] == 'I')
				{
					iAbono = consultarCaCarmov.base;
				}

				if ((consultarCaCarmov.clave[0] == 'S' && consultarCaCarmov.tipomovimiento[0] == '5') || (consultarCaCarmov.clave[0] == 'S' && consultarCaCarmov.tipomovimiento[0] == '7') || (consultarCaCarmov.clave[0] == 'I' && consultarCaCarmov.tipomovimiento[0] == '1'))
				{
					sprintf_s(cIva, "%d", consultarCaCarmov.iva);
					cIva[1] = 0;
					cTipoConvenio = cIva[0];
				}

				if (CString(consultarCaCarmov.ipcarteracliente).Trim() == CString(cIpServidorCartera).Trim())
				{
					cTipoGrabado = 'T';
				}
				else
				{
					cTipoGrabado = 'F';
				}

				//Almacena datos para consumo del servicio de club de proteccion mercadotecnia 360
				datosClientes360.Format("cliente=%ld&tienda=%d&clave=%s&movimiento=%s&caja=%d&numcte=%ld", m_grid.lCliente, m_grid.iTienda, consultarCaCarmov.clave, consultarCaCarmov.tipomovimiento, consultarCaCarmov.caja, consultarCaCarmov.num_cliente);
				cNumRecibo360.Format("folio=%ld",  lNumeroRecibo);
				cTipoMovimiento360.Format( consultarCaCarmov.tipomovimiento);
				cClave360.Format(consultarCaCarmov.clave);

				sXml.Format("<Datos>"
					"<clave>%c</clave>"
					"<tipomovimiento>%c</tipomovimiento>"
					"<cliente>%ld</cliente>"
					"<folio>%ld</folio>"
					"<importe>%ld</importe>"
					"<enganche>%d</enganche>"
					"<interes>%d</interes>"
					"<fecha>%04d-%02d-%02d</fecha>"
					"<devolucionfactura>%ld</devolucionfactura>"
					"<factura>%ld</factura>"
					"<tienda>%d</tienda>"
					"<ciudadtiendamov>%d</ciudadtiendamov>"
					"<plazo>%d</plazo>"
					"<abono>%d</abono>"
					"<descripcionarticulo> </descripcionarticulo>"
					"<numeroarticulos>%d</numeroarticulos>"
					"<diapago>%d</diapago>"
					"<saldocuenta>%d</saldocuenta>"
					"<plazoconvenio>%d</plazoconvenio>"
					"<efectuo>%ld</efectuo>"
					"<claveajuste> </claveajuste>"
					"<fechasaldacon>%04d-%02d-%02d</fechasaldacon>"
					"<vencidoinicial>%d</vencidoinicial>"
					"<saldoinicial>%d</saldoinicial>"
					"<tipoconvenio>%c</tipoconvenio>"
					"<subtipoconvenio>%c</subtipoconvenio>"
					"<importesaldacon>%d</importesaldacon>"
					"<fechanacimiento>%s</fechanacimiento>"
					"<fechavencimiento>%04d-%02d-%02d</fechavencimiento>"
					"<flagseguroconyugal>%c</flagseguroconyugal>"
					"<cantidadseguros>%d</cantidadseguros>"
					"<movtoseguro>%c</movtoseguro>"
					"<caja>%d</caja>"
					"<cajaoriginal>%d</cajaoriginal>"
					"<area>%c</area>"
					"<tipograbado>%c</tipograbado>"
					"<statusafore>%d</statusafore>"
					"<ganode>0</ganode>"
					"<gastode>0</gastode>"
					"<porcentajede>0</porcentajede>"
					"<nombre>%s</nombre>"
					"<apellidopaterno>%s</apellidopaterno>"
					"<apellidomaterno>%s</apellidomaterno>"
					"</Datos>", consultarCaCarmov.clave[0], consultarCaCarmov.tipomovimiento[0], consultarCaCarmov.cliente, lNumeroRecibo, consultarCaCarmov.importe / 100, iEnganche, consultarCaCarmov.interes, iAnioActual, iMesActual, iDiaActual, iDevolucionFactura, iFactura, consultarCaCarmov.tienda, iCiudadGnDominio, consultarCaCarmov.plazoconvenio, iAbono, iNumeroArticulos, iParentesco, consultarCaCarmov.saldocuenta, consultarCaCarmov.plazoconvenio, consultarCaCarmov.efectuo, iAnioSaldaCon, iMesSaldaCon, iDiaSaldaCon, consultarCaCarmov.vencidoinicial, consultarCaCarmov.saldoinicial, cTipoConvenio, consultarCaCarmov.subtipoconvenio[0], consultarCaCarmov.importesaldacon, cFechaNacimiento, consultarCaCarmov.fechavencimiento.ano(), consultarCaCarmov.fechavencimiento.mes(), consultarCaCarmov.fechavencimiento.dia(), cFlagSeguroConyugal, consultarCaCarmov.cantidadseguros, consultarCaCarmov.movtoseguro[0], consultarCaCarmov.caja, consultarCaCarmov.cajaoriginal, consultarCaCarmov.caja == 99 ? '1' : consultarCaCarmov.caja == 98 ? '2' : '3', cTipoGrabado, iStatusAforeNvo, cNombre, cApellidoPat, cApellidoMat);
				sprintf_s(cMensaje, "CDlgCapturarAbono::GrabarCarmovx:: grabando movimiento --> Clave[%s], TipoMovimiento[%s], Importe[%ld], Factura[%d], TipoSeguro[%c]", consultarCaCarmov.clave, consultarCaCarmov.tipomovimiento, consultarCaCarmov.importe / 100, iFactura, consultarCaCarmov.tiposeguro[0]);
				grabarLog(cMensaje);
				if (bSeguro && consultarCaCarmov.importe == 0 || lNumeroRecibo == -1)
				{
					bGrabar = false;
					bSeguro = false;
					bFlag = false;
					break;
				}
				else
				{
					sSql.clear();
					sSql.append("SELECT status FROM fun_crgrabarcarmovx('").append(sXml).append("');");

					if (grabarCarmovx.Exec(sSql.c_str()))
					{
						grabarCarmovx.activarCols();
						if (grabarCarmovx.Leer())
						{
							if (grabarCarmovx.Total == 0) // 0 es OK
							{
								bFlag = true;
							}
							else
							{
								bFlag = false;
								grabarCarmovx.odbc->GetLastError(grabarCarmovx.GetHstmt());
								grabarMensajeError("C", m_grid.iCaja, (LPTSTR)(LPCTSTR)m_grid.sServer, "CapturarAbono", "CDlgCapturarAbono", "grabarCarmovx", sql.GetBuffer(), m_grid.lEmpleado, "ERROR AL GRABAR (fun_crgrabarcarmovx)", grabarCarmovx.odbc, m_grid.iMuestraMsg);
								sprintf_s(cMensaje, "CDlgCapturarAbono::GrabarCarmovx::Error fun_crgrabarcarmovx --> Total = %ld", grabarCarmovx.Total);
								grabarLog(cMensaje);
								grabarLog((char*)sSql.c_str());
								break;
							}
						}
						else
						{
							bFlag = false;
							grabarCarmovx.odbc->GetLastError(grabarCarmovx.GetHstmt());
							grabarMensajeError("C", m_grid.iCaja, (LPTSTR)(LPCTSTR)m_grid.sServer, "CapturarAbono", "CDlgCapturarAbono", "grabarCarmovx", sql.GetBuffer(), m_grid.lEmpleado, "ERROR AL LEER (fun_crgrabarcarmovx)", grabarCarmovx.odbc, m_grid.iMuestraMsg);
							sprintf_s(cMensaje, "CDlgCapturarAbono::GrabarCarmovx::Error al leer fun_crgrabarcarmovx");
							grabarLog(cMensaje);
							grabarLog((char*)sSql.c_str());
							break;
						}
					}
					else
					{
						bFlag = false;
						grabarCarmovx.odbc->GetLastError(grabarCarmovx.GetHstmt());
						grabarMensajeError("C", m_grid.iCaja, (LPTSTR)(LPCTSTR)m_grid.sServer, "CapturarAbono", "CDlgCapturarAbono", "grabarCarmovx", sql.GetBuffer(), m_grid.lEmpleado, "ERROR EN LA CONSULTA(fun_crgrabarcarmovx)", grabarCarmovx.odbc, m_grid.iMuestraMsg);
						sprintf_s(cMensaje, "CDlgCapturarAbono::GrabarCarmovx::Error en funcion fun_crgrabarcarmovx");
						grabarLog(cMensaje);
						grabarLog((char*)sSql.c_str());
						break;
					}

					grabarCarmovx.ClearResults();
					grabarCarmovx.ClearStatement();
				}
			}

			bGrabar = false;
			bSeguro = false;
		}
	}

	if (iMov == 0) bFlag = true;


	sprintf_s(cMensaje, "CDlgCapturarAbono::GrabarCarmovx::termina grabando abonos en carmovx bFlag = %d, iMov =  %d", bFlag, iMov);
	grabarLog(cMensaje);
	return bFlag;
}

void CDlgCapturarAbono::obtenerTotalServicio(char cClave, int iCaja, long &lTotalServicio)
{
	char cLog[500] = { 0 };
	char cSql[100] = { 0 };

	sprintf_s(cLog, "FC0200805021521823 - entra - obtenerTotalServicio");
	grabarLog(cLog);

	sprintf_s(cSql, "SELECT COALESCE(sum(importe),0) FROM tmpcacarmovservicio WHERE clave = '%c' AND caja = %d", cClave, iCaja);

	CMaximo consultarServicio(&odbc);

	if (!consultarServicio.Exec(cSql))
	{
		AfxMessageBox("ERROR AL OBTENER TOTAL DE SERVICIOS");
	}
	else
	{
		consultarServicio.activarCols();
		if (consultarServicio.leer())
		{
			lTotalServicio = consultarServicio.Total;
		}
	}
}

void CDlgCapturarAbono::obtenerTotalGlobalServicio(int iCaja, long &lTotalGlobalServicio)
{
	char cLog[500] = { 0 };
	char cSql[80] = { 0 };

	sprintf_s(cLog, "FC0200805021521827 - entra - obtenerTotalGlobalServicio");
	grabarLog(cLog);

	sprintf_s(cSql, "SELECT COALESCE(sum(importe),0) FROM tmpcacarmovservicio WHERE caja = %d", iCaja);

	CMaximo consultarServicio(&odbc, false);

	if (!consultarServicio.Exec(cSql))
	{
		AfxMessageBox("ERROR AL OBTENER TOTAL DE SERVICIOS");
	}
	else
	{
		consultarServicio.activarCols();
		if (consultarServicio.leer())
		{
			lTotalGlobalServicio = consultarServicio.Total;
		}
	}
}

void CDlgCapturarAbono::obtenerFolioServicio(long &lRecibo, char cClave, char cTipo)
{
	char cLog[500] = { 0 };
	char cSql[140] = { 0 };

	sprintf_s(cLog, "FC0200805103819995 - entra - obtenerFolioServicio");
	grabarLog(cLog);

	sprintf_s(cSql, "SELECT recibo FROM cacarmov WHERE recibo > %ld AND caja = %d AND clave = '%c' AND TRIM(tipomovimiento)=TRIM('%c')", lFolioGrabarAbono, m_grid.iCaja, cClave, cTipo);

	CMaximo consultarFolio(&odbc);

	if (!consultarFolio.Exec(cSql))
	{
		consultarFolio.odbc->GetLastError(consultarFolio.GetHstmt());
		grabarMensajeError("C", m_grid.iCaja, (LPTSTR)(LPCTSTR)m_grid.sServer, "CapturarAbono", "CDlgCapturarAbono", "obtenerFolio", cSql, m_grid.lEmpleado, "ERROR EN LA CONSULTA(obtenerFolio)", consultarFolio.odbc, m_grid.iMuestraMsg);

	}
	else
	{
		consultarFolio.activarCols();
		if (consultarFolio.leer())
		{
			lRecibo = consultarFolio.Total;
		}

		if (lRecibo == 0)
		{
			lRecibo = lFolioGrabarAbono;
		}
	}
}

void CDlgCapturarAbono::encabezadoTalonCajasServicio(C_FormasPCL &hoja, int iPagina, int iContadorSeguros, long lReciboServicio)
{
	char cLog[500] = { 0 };
	int iRen = 0;
	char cRespuesta[15] = { 0 };

	sprintf_s(cLog, "FC0200805103819992 - entra - encabezadoTalonCajasServicio");
	grabarLog(cLog);

	if (iContadorSeguros < 3)
	{
		iRen = 14;
	}
	else
	{
		iRen = 15;
	}
	miniFecha(cRespuesta, (int)iDiaActual, (int)iMesActual, (int)iAnioActual);

	if (m_grid.lCliente == 1708L)
	{
		hoja.poner(cRespuesta, iRen + 1, 106);
	}
	else
	{
		hoja.poner(cRespuesta, iRen, 106);
	}

	{
		sprintf_s(cRespuesta, "%04d", m_grid.iTienda);
		hoja.poner(cRespuesta, iRen, 125);

		sprintf_s(cRespuesta, "%02d", m_grid.iCaja);
		hoja.poner(cRespuesta, iRen, 130);

		if (bPagodeServicios)
		{
			consultarFolioCajas();
			lNumeroRecibo = lNumeroConsulta;
			bPagodeServicios = false;
		}

		sprintf_s(cRespuesta, "%06ld-%02d", lReciboServicio, iPagina);
		hoja.poner(cRespuesta, iRen, 114);
		if (iContadorSeguros != 0) hoja.poner(cRespuesta, iRen - 2, 83);
		else hoja.poner(cRespuesta, iRen - 3, 83);
	}
}

bool CDlgCapturarAbono::grabarCuentasPerdidas()
{
	char cLog[500] = { 0 };
	bool bRegresa = true;
	CString sTexto;
	char cTxt[50] = { 0 };
	long lSaldo = 0L, lFactura = 0L;
	int iFlagCuenta = 0;
	bool bFlagError = true;

	sprintf_s(cLog, "FC0200805021521839 - entra - grabarCuentasPerdidas");
	grabarLog(cLog);

	if (iFlagDespliegaDatosZ == 1)
	{
		for (int i = 0; i < iTotalCuentas; i++)
		{
			m_grid.QuickGetText(i, 2, &sTexto);
			sTexto.Trim();
			sprintf_s(cTxt, "%s", (LPCTSTR)sTexto);

			m_grid.QuickGetText(i, 21, &sTexto);
			sTexto.Trim();
			lSaldo = atol(sTexto);

			m_grid.QuickGetText(i, 1, &sTexto);
			sTexto.Trim();
			lFactura = atol(sTexto);

			if (memcmp(cTxt, "CP ROPA", 7) == 0) //cuenta perdida de ropa
			{
				iFlagCuenta = 1;
			}
			else
			{
				if (memcmp(cTxt, "CP MUEB", 7) == 0) //cuenta perdida de muebles
				{

					iFlagCuenta = 2;
				}
				else
				{
					if (memcmp(cTxt, "CP PRES", 7) == 0) //cuenta perdida de prestamo
					{
						iFlagCuenta = 3;
					}
					else
					{
						if (memcmp(cTxt, "CP BANC", 7) == 0) //cuenta perdida de deuda Bancoppel
						{
							iFlagCuenta = 4;
						}
						else
						{
							if (memcmp(cTxt, "CP T.AIRE", 9) == 0) //cuenta perdida de Tiempo Aire
							{
								iFlagCuenta = 5;
							}
							else
							{
								if (memcmp(cTxt, "CP COMP ADC", 11) == 0) //cuenta perdida de Revolvente
								{
									iFlagCuenta = 6;
								}
							}
						}
					}
				}
			}

			if (iFlagCuenta > 0 && lSaldo > 0)
			{
				char cSql[220] = { 0 };
				CMaximo flagCoppel(&odbcCuentasPerdidas, false);

				sprintf_s(cSql, "SELECT fun_cpactualizarcuentasperdidas( '%d','%ld','%ld','%ld','%04d-01-01','%04d-%02d-%02d','%d','%d','%c','%ld','%ld','%d','%d' ) ", iFlagCuenta, m_grid.lCliente, lFactura, lSaldo, iAnioActual, iAnioActual, iMesActual, iDiaActual, m_grid.iTienda, lNumeroRecibo, m_grid.cArea, lAbonoRopa, lAbonoTasa0, iTipoDeduccionRopa, iTipoDeduccionTasa0);
				grabarLog(cSql);

				if (flagCoppel.Exec(cSql))
				{
					flagCoppel.activarCols();
					if (flagCoppel.Leer())
					{
						bRegresa = true;
					}
				}
				else
				{
					//Se obtiene el error
					flagCoppel.odbc->GetLastError(flagCoppel.GetHstmt());
					grabarMensajeError("C", m_grid.iCaja, (LPTSTR)(LPCTSTR)m_grid.sServer, "CapturarAbono", "CDlgCapturarAbono", "fun_cpactualizarcuentasperdidas", cSql, m_grid.lEmpleado, "ERROR EN LA CONSULTA(fun_cpactualizarcuentasperdidas)", flagCoppel.odbc, m_grid.iMuestraMsg);
					bFlagError = false;
				}
			}
			iFlagCuenta = 0;
		}
	}

	if (!bFlagError)
	{
		bRegresa = false;
	}
	return bRegresa;
}

bool CDlgCapturarAbono::abrirConexionCuentaPerdida()
{
	char cLog[500] = { 0 };
	bool bRegresa = true;
	char cSql[255] = { 0 }, cIpCredito[20] = { 0 }, cIpCredito2[20] = { 0 };

	sprintf_s(cLog, "FC0200805021521843 - entra - abrirConexionCuentaPerdida");
	grabarLog(cLog);

	grabarLog("abrirConexionCuentaPerdida::Abriendo conexion al servidor de cuentas perdidas");

	if (iFlagDespliegaDatosZ == 1)
	{
		bRegresa = consultarIpServidores(&odbc, cIpCredito, cIpCredito2, SERV_CTASPERDIDAS, cSql);

		if (!bRegresa)
		{
			grabarMensajeError("C", m_grid.iCaja, (LPTSTR)(LPCTSTR)m_grid.sServer, "CapturarAbono", "CDlgCapturarAbono", "obtenerIpPersonal", cSql, m_grid.lEmpleado, "ERROR EN LA CONSULTA(obteneripcredito)", &odbc, m_grid.iMuestraMsg);
		}
		else
		{
			if (abrirConexionBD(&odbcCuentasPerdidas, cIpCredito, cIpCredito2, CONECTA_CUENTASPERDIDAS, iTiendaDlg))
			{
				bRegresa = true;
			}
			else
			{
				AfxMessageBox("Error al abrir conexión BD CUENTAS PERDIDAS");
				bRegresa = false;
			}
		}
	}
	return bRegresa;
}

bool CDlgCapturarAbono::grabarTmpCrTaire()
{
	char cLog[500] = { 0 };
	bool bResultado = false;
	char cSql[80] = { 0 };

	sprintf_s(cLog, "FC0200805021521847 - entra - grabarTmpCrTaire");
	grabarLog(cLog);

	grabarLog("grabarTmpCrTaire::grabando cuenta de tiempo aire en cartera");

	sprintf_s(cSql, "SELECT crgrabartmpcrTaireCrTaire02('%d','%d','%d','%d' ) ", iFlagCrTaire, m_grid.iCaja, iSistema, m_grid.iTienda);

	CMaximo flagCoppel(&odbc_1, false);
	if (flagCoppel.Exec(cSql))
	{
		flagCoppel.activarCols();
		if (flagCoppel.Leer())
		{
			bResultado = true;
		}
	}
	else
	{
		//Se obtiene el error
		flagCoppel.odbc->GetLastError(flagCoppel.GetHstmt());
		grabarMensajeError("C", m_grid.iCaja, (LPTSTR)(LPCTSTR)m_grid.sServer, "CapturarAbono", "CDlgCapturarAbono", "grabarTmpCrTaire", cSql, m_grid.lEmpleado, "ERROR EN LA CONSULTA(grabartmpcrtaire)", flagCoppel.odbc, m_grid.iMuestraMsg);
	}
	return  bResultado;
}

bool CDlgCapturarAbono::grabarTmpCrCRevolvente()
{
	char cLog[500] = { 0 };
	bool bResultado = false;
	char cSql[85] = { 0 };

	sprintf_s(cLog, "FC0200805021521851 - entra - grabarTmpCrCRevolvente");
	grabarLog(cLog);

	grabarLog("grabarTmpCrCRevolvente::grabando cuenta revolvente en cartera");

	sprintf_s(cSql, "SELECT crgrabartmpRevolventecrcrevolvente('%d','%d','%d','%d' ) ", iFlagCrCRevolvente, m_grid.iCaja, iSistema, m_grid.iTienda);

	CMaximo flagCoppel(&odbc_1, false);
	if (flagCoppel.Exec(cSql))
	{
		flagCoppel.activarCols();
		if (flagCoppel.Leer())
		{
			bResultado = true;
		}
	}
	else
	{
		//Se obtiene el error
		flagCoppel.odbc->GetLastError(flagCoppel.GetHstmt());
		grabarMensajeError("C", m_grid.iCaja, (LPTSTR)(LPCTSTR)m_grid.sServer, "CapturarAbono", "CDlgCapturarAbono", "grabarTmpCrCRevolvente", cSql, m_grid.lEmpleado, "ERROR EN LA CONSULTA(crgrabartmpRevolventecrcrevolvente)", flagCoppel.odbc, m_grid.iMuestraMsg);
	}
	return  bResultado;
}

bool CDlgCapturarAbono::grabarTemporalCarteraTiempoAire(long lSuPago, char *cStatus, long lInteresAdicional, long lAbonoInteres, long lSaldoNuevo, long lInteresPrimerMes)
{
	char cLog[500] = { 0 };
	int iFlag = 0;
	bool bContinuar = true;

	sprintf_s(cLog, "FC0200805021521855 - entra - grabarTemporalCarteraTiempoAire");
	grabarLog(cLog);

	grabarLog("grabarTemporalCarteraTiempoAire::Grabando tiempo aire en tabla temporal cartera");

	CGrabarTmpAbonoCrTaireFija02 tmpCrCrTaire(&odbc_1); //conexión a la B.D cartera
	{
		tmpCrCrTaire.cliente = m_grid.lCliente;

		if (lSuPago > 0L)
		{
			iFlag = 1;
		}
		else if (lSuPago < 0L)
		{
			if (iFlagMovimiento == 0) // si es 0 es cargo
			{
				//Se trata de un Cargo
				iFlag = 1;
			}
		}

		if (iFlag == 1)
		{
			if (cStatus[0] == '1')
			{

				tmpCrCrTaire.saldo = lSaldoNuevo;
				tmpCrCrTaire.interesadicional = 0L;
				tmpCrCrTaire.interesadicionalprimermes = 0L;
				if (lSuPago < 0 &&
					lInteresAdicional > 0)
				{
					tmpCrCrTaire.minimoapagar = lSuPago;  //restarlo en la funcion de postgres
					tmpCrCrTaire.flagactualizacion = 0;
				}
				else
				{
					tmpCrCrTaire.interesadicional = lAbonoInteres;
					tmpCrCrTaire.minimoapagar = lSaldoNuevo;
					tmpCrCrTaire.flagactualizacion = 1;
					tmpCrCrTaire.interesadicionalprimermes = lInteresPrimerMes;
				}
				tmpCrCrTaire.fechaultimomovimiento.ponerFecha(iDiaActual, iMesActual, iAnioActual);
			}

			tmpCrCrTaire.caja = (short)m_grid.iCaja;
			tmpCrCrTaire.sistema = (short)iSistema;
			tmpCrCrTaire.tienda = (short)m_grid.iTienda;

			tmpCrCrTaire.prepararInsert("tmpabonocrtaire");
			if (tmpCrCrTaire.Insert())
			{
				tmpCrCrTaire.Commit();
				iFlagCrTaire = 1;
			}
			else
			{
				tmpCrCrTaire.odbc->GetLastError(tmpCrCrTaire.GetHstmt());
				grabarMensajeError("C", m_grid.iCaja, (LPTSTR)(LPCTSTR)m_grid.sServer, "CapturarAbono", "CDlgCapturarAbono", "grabarTemporalCarteraRopa", "Error al Insertar en la Tabla tmpabonocrtaire", m_grid.lEmpleado, "ERROR EN LA CONSULTA(grabartemporalcarteraropa)", tmpCrCrTaire.odbc, m_grid.iMuestraMsg);
				bContinuar = false;
			}
		}

	}
	return bContinuar;
}

bool CDlgCapturarAbono::grabarTemporalCarteraRevolvente(long lSuPago, char *cStatus, long lInteresAdicional, long lAbonoInteres, long lSaldoNuevo, long lInteresPrimerMes)
{
	char cLog[500] = { 0 };
	int iFlag = 0;
	bool bContinuar = true;

	sprintf_s(cLog, "FC0200805021521859 - entra - grabarTemporalCarteraRevolvente");
	grabarLog(cLog);

	grabarLog("grabarTemporalCarteraRevolvente::Grabando cuenta revolvente en tabla temporal cartera");

	CGrabarTmpAbonoCrRevolvente tmpCrCRevolvente(&odbc_1); //conexión a la B.D cartera
	{
		tmpCrCRevolvente.cliente = m_grid.lCliente;

		if (lSuPago > 0L)
		{
			iFlag = 1;
		}
		else if (lSuPago < 0L)
		{
			if (iFlagMovimiento == 0) // si es 0 es cargo
			{
				//Se trata de un Cargo
				iFlag = 1;
			}
		}

		if (iFlag == 1)
		{
			if (cStatus[0] == '1')
			{

				tmpCrCRevolvente.saldo = lSaldoNuevo;
				tmpCrCRevolvente.interesadicional = 0L;
				tmpCrCRevolvente.interesadicionalprimermes = 0L;
				if (lSuPago < 0 &&
					lInteresAdicional > 0)
				{
					tmpCrCRevolvente.minimoapagar = lSuPago;  //restarlo en la funcion de postgres
					tmpCrCRevolvente.flagactualizacion = 0;
				}
				else
				{
					tmpCrCRevolvente.interesadicional = lAbonoInteres;
					tmpCrCRevolvente.minimoapagar = lSaldoNuevo;
					tmpCrCRevolvente.flagactualizacion = 1;
					tmpCrCRevolvente.interesadicionalprimermes = lInteresPrimerMes;
				}
				tmpCrCRevolvente.fechaultimomovimiento.ponerFecha(iDiaActual, iMesActual, iAnioActual);
			}

			tmpCrCRevolvente.caja = (short)m_grid.iCaja;
			tmpCrCRevolvente.sistema = (short)iSistema;
			tmpCrCRevolvente.tienda = (short)m_grid.iTienda;

			tmpCrCRevolvente.prepararInsert("tmpabonocrcrevolvente");
			if (tmpCrCRevolvente.Insert())
			{
				tmpCrCRevolvente.Commit();
				iFlagCrCRevolvente = 1;
			}
			else
			{
				tmpCrCRevolvente.odbc->GetLastError(tmpCrCRevolvente.GetHstmt());
				grabarMensajeError("C", m_grid.iCaja, (LPTSTR)(LPCTSTR)m_grid.sServer, "CapturarAbono", "CDlgCapturarAbono", "grabarTemporalCarteraRopa", "Error al Insertar en la Tabla tmpabonocrcrevolvente", m_grid.lEmpleado, "ERROR EN LA CONSULTA(grabartemporalcarteraropa)", tmpCrCRevolvente.odbc, m_grid.iMuestraMsg);
				bContinuar = false;
			}
		}
	}
	return bContinuar;
}

void CDlgCapturarAbono::mostrarMensajeTarjetaBanco()
{
	char cLog[500] = { 0 };
	char cDll[64] = { 0 };
	char cArgvIN1[1024] = { 0 }, cArgvIN2[1024] = { 0 };
	char cArgvOUT1[1024] = { 0 }, cArgvOUT2[1024] = { 0 };
	char cDato[100] = { 0 };
	char cArchivo[40] = { 0 };
	sprintf_s(cArchivo, "c:\\sys\\mem\\InvitacionBancoppel.prn");

	sprintf_s(cLog, "FC0200805021521863 - entra - mostrarMensajeTarjetaBanco");
	grabarLog(cLog);

	SParametros parametros;

	memset(&parametros, 0, sizeof(parametros));

	sprintf_s(parametros.sServer, "%s", m_grid.sServer);
	parametros.iLink = generarLink();
	parametros.iTienda = iTiendaDlg;
	parametros.lCliente = lClienteDlg;
	parametros.lEmpleado = lEmpleadoDlg;

	sprintf_s(parametros.cNombre, cNombre);
	sprintf_s(parametros.cApellidoPaterno, cApellidoPaterno);
	sprintf_s(parametros.cApellidoMaterno, cApellidoMaterno);

	memcpy(cArgvIN1, &parametros, sizeof(parametros));

	nombreArchivo("GN0084", cDll, DIRECTORIO_GN);

	CargarDLL dll(cDll, "GN0084", cArgvIN1, cArgvIN2, cArgvOUT1, cArgvOUT2);

	if (dll.getResultado() != 1)
	{
		AfxMessageBox("OCURRIÓ UN ERROR AL CARGAR EL GN0084.DLL");
	}
	else
	{
		if (atoi(cArgvOUT1) == 201) // Acepto la promocion, se imprime volante.
		{
			grabarLog("imprimirMensajeInvitacionBancoppel::Imprimiendo Mensaje Invitacion Bancoppel");
			if (iFlagImpresoraTermica == 1)
			{
				imprimirMensajeInvitacionBancoppel();
			}
			else  //Impresion Matricial
			{
				if (iSistema == 3)
				{
					C_FormasPCL hoja(22, 270, cArchivo, iFinLinea, iTipoImpresora, 1);
					compactarImpresion(hoja);

					sprintf_s(cDato, "Usted es un muy buen Cliente de Coppel y PROBABLEMENTE PUEDA obtener");
					hoja.poner(cDato, 8, 8);

					sprintf_s(cDato, "su Tarjeta de Credito BanCoppel VISA.");
					hoja.poner(cDato, 9, 23);

					sprintf_s(cDato, "Lo invitamos a que pase a BanCoppel para que realice el trámite.");
					hoja.poner(cDato, 10, 10);

					sprintf_s(cDato, "Es muy fácil.");
					hoja.poner(cDato, 11, 36);

					hoja.imprimir();
					impresionArchivo.imprimirArchivo(cArchivo);
				}
				else // Muebles o Ropa
				{
					C_FormasPCL hoja(33, 270, cArchivo, iFinLinea, iTipoImpresora, 1);

					compactarImpresion(hoja);

					sprintf_s(cDato, "Usted es un muy buen Cliente de Coppel");
					hoja.poner(cDato, 8, 2);
					sprintf_s(cDato, "y PROBABLEMENTE PUEDA obtener");
					hoja.poner(cDato, 9, 6);
					sprintf_s(cDato, "su Tarjeta de Credito BanCoppel VISA.");
					hoja.poner(cDato, 10, 3);

					sprintf_s(cDato, "Lo invitamos a que pase a BanCoppel para que");
					hoja.poner(cDato, 12, 0);
					sprintf_s(cDato, "realice el trámite. Es muy fácil.");
					hoja.poner(cDato, 13, 5);

					hoja.imprimir();
					impresionArchivo.imprimirArchivo(cArchivo);
				}
			}
		}
	}
}

void CDlgCapturarAbono::mostrarMovtosCliente()
{
	char cLog[500] = { 0 };
	char cDll[64] = { 0 }, cArgvIN1[1024] = { 0 }, cArgvIN2[1024] = { 0 }, cArgvOUT1[1024] = { 0 }, cArgvOUT2[1024] = { 0 };
	SParametros parametros;
	memset(&parametros, 0, sizeof(parametros));

	sprintf_s(cLog, "FC0200805021521868 - entra - mostrarMovtosCliente");
	grabarLog(cLog);

	sprintf_s(parametros.sServer, "%s", (LPCTSTR)m_grid.sServer);
	parametros.iLink = generarLink();
	parametros.iTienda = m_grid.iTienda;

	if (m_grid.lCliente == 1708)
	{
		parametros.lCliente = lClienteEtp;
		sprintf_s(parametros.sIpCartera1, cIpServidorCartera);
	}
	else
	{
		parametros.lCliente = m_grid.lCliente;
		sprintf_s(parametros.sIpCartera1, cIpServidorCartera);
	}

	parametros.iCajaActual = m_grid.iCaja;
	switch (iSistema)
	{
	case 1: parametros.sArea[0] = 'M';
		break;
	case 2: parametros.sArea[0] = 'R';
		break;
	case 3: parametros.sArea[0] = 'C';
		break;
	case 7: parametros.sArea[0] = '7'; //Sistema Cajera Capturista
		break;
	default:break;
	}
	parametros.sArea[1] = 0;

	sprintf_s(parametros.sIpCredito1, cIpServidorCredito);
	sprintf_s(parametros.sFechaGnDominio, "%04d%02d%02d", iAnioActual, iMesActual, iDiaActual);

	memcpy(cArgvIN1, &parametros, sizeof(parametros));

	nombreArchivo("CA0043.DLL", cDll, DIRECTORIO_CA);

	CargarDLL dll(cDll, "CA0043", cArgvIN1, cArgvIN2, cArgvOUT1, cArgvOUT2);

	if (dll.getResultado() != 1)
	{
		AfxMessageBox("OCURRIÓ UN ERROR AL CARGAR EL CA0043.DLL");
	}
	sprintf_s(cLog, "FC0200805021521870 - entra - mostrarMovtosCliente");
	grabarLog(cLog);
}

int CDlgCapturarAbono::checarHoraInvitacion()
{
	char cLog[500] = { 0 };
	int  iMensaje = 0, iHora = 0, iMinuto = 0, iCajaArchivo = 0, iHoraDif = 0, iMinutosDif = 0, iTiempoTranscurrido = 0;
	char cSql[85] = { 0 }, sHoraActual[6] = { 0 }, sHoraArchivo[6] = { 0 };

	sprintf_s(cLog, "FC0200805021521872 - entra - checarHoraInvitacion");
	grabarLog(cLog);

	iTiempoMensaje = 30;

	CTime time = CTime::GetCurrentTime();
	C_Archivo arcInvafore;

	sprintf_s(sHoraActual, "%02d%02d", time.GetHour(), time.GetMinute());
	CInsertarHoraMensaje  insertarHoraSQL(&odbc);
	sprintf_s(cSql, "SELECT caja,hora,minuto,tiempomensaje FROM cainvitacionafore");
	if (insertarHoraSQL.Exec(cSql))
	{
		insertarHoraSQL.activarCols();
		if (insertarHoraSQL.Leer())
		{
			iCajaArchivo = insertarHoraSQL.caja;
			iHora = insertarHoraSQL.hora;
			iMinuto = insertarHoraSQL.minuto;
			iTiempoMensaje = insertarHoraSQL.tiempomensaje;
		}
	}

	if (iStatusAfore == 20)
	{
		iFlagMsjAfore = 0; //No se actualiza Tabla
		iMensaje = 1; //Si mostrara mensaje...
	}
	else
	{
		if (iCajaArchivo == 0) // No leyó registro de la tabla...
		{
			if (iStatusAfore == 0 || iStatusAfore == 1 || iStatusAfore == 3 || iStatusAfore == 4 || iStatusAfore == 5 || iStatusAfore == 6 || iStatusAfore == 8)
			{
				iFlagMsjAfore = 1; //Insertara registro en la tabla cainvitacionafore
				iMensaje = 1; //Si mostrara mensaje...
			}
		}
		else
		{
			sprintf_s(sHoraArchivo, "%02d%02d", iHora, iMinuto);
			sHoraActual[4] = 0;
			sHoraArchivo[4] = 0;

			iHoraDif = time.GetHour() - iHora;
			if (iHoraDif > 1)
			{
				if (iStatusAfore == 0 || iStatusAfore == 1 || iStatusAfore == 3 || iStatusAfore == 4 || iStatusAfore == 5 || iStatusAfore == 6 || iStatusAfore == 8)
				{
					iFlagMsjAfore = 2; // Actualizara la tabla cainvitacionafore
					iMensaje = 1; // Si mostrara mensaje...
				}
			}
			else
			{
				if (iHoraDif == 1)
				{
					iMinutosDif = 60 - iMinuto;
					iTiempoTranscurrido = iMinutosDif + time.GetMinute();

					if ((iTiempoTranscurrido >= iTiempoMensaje) && (iStatusAfore == 0 || iStatusAfore == 1 || iStatusAfore == 3 || iStatusAfore == 4 || iStatusAfore == 5 || iStatusAfore == 6 || iStatusAfore == 8))
					{
						iFlagMsjAfore = 2; // Actualizara la tabla cainvitacionafore
						iMensaje = 1; // Si mostrara mensaje...
					}
					else
					{
						iFlagMsjAfore = 0;//No se actualiza Tabla 
						iMensaje = 0;//No mostrará mensaje
					}
				}
				else
				{
					iTiempoTranscurrido = time.GetMinute() - iMinuto;
					if ((iTiempoTranscurrido >= iTiempoMensaje) && (iStatusAfore == 0 || iStatusAfore == 1 || iStatusAfore == 3 || iStatusAfore == 4 || iStatusAfore == 5 || iStatusAfore == 6 || iStatusAfore == 8))
					{
						iFlagMsjAfore = 2; // Actualizara la tabla cainvitacionafore
						iMensaje = 1; // Si mostrara mensaje...
					}
					else
					{
						iFlagMsjAfore = 0;//No se actualiza Tabla 
						iMensaje = 0;//No mostrará mensaje
					}
				}
			}
		}
	}

	if (iMensaje == 1) //Si mostrará mensaje ...
	{
		bCambioStatusAfore = true;
		switch (iStatusAfore)
		{
		case 0: iStatusAforeNvo = 1; break;
		case 5: iStatusAforeNvo = 7; break;
		case 20: iStatusAforeNvo = 21; break;
		default: iStatusAforeNvo = iStatusAfore; break; //Se queda con el valor que trae de la tabla crcliente...
		}
	}
	else
	{
		iFlagMsjAfore = 0;
		bCambioStatusAfore = false;
		iStatusAforeNvo = 99; //No mostrara mensaje...
	}
	return iMensaje;
}

void CDlgCapturarAbono::obtenerFechaCartera()
{
	char cLog[500] = { 0 };
	char cSql[60] = { 0 }, cFechaCartera[10] = { 0 };

	sprintf_s(cLog, "FC0200805021521877 - entra - obtenerFechaCartera");
	grabarLog(cLog);

	sprintf_s(cSql, "SELECT fechanacimiento FROM crcliente WHERE cliente = -1");
	CFechaCoppel consultarFecha(&odbc_1);

	if (consultarFecha.Exec(cSql))
	{
		consultarFecha.activarCols();
		if (consultarFecha.leer())
		{
			sprintf_s(cFechaCartera, "%04d%02d%02d", consultarFecha.fecha.ano(), consultarFecha.fecha.mes(), consultarFecha.fecha.dia());
			if (atol(cFechaMasActualCte) < atol(cFechaCartera))
				sprintf_s(cFechaMasActualCte, "%s", cFechaCartera);

			miniFecha(cFechaMasActualCte, valor_campo(&cFechaMasActualCte[6], 2), valor_campo(&cFechaMasActualCte[4], 2), valor_campo(&cFechaMasActualCte[0], 4));
		}
	}
}

//Deuda Bancoppel
bool CDlgCapturarAbono::grabarTemporalCarteraBancoppel(long lSaldoNuevo, long lAbonoInteres, long lAbonoCuenta, long lSuPago, long lFactura, long lInteresCalculado)
{
	char cLog[500] = { 0 };
	bool bContinuar = true;

	sprintf_s(cLog, "FC0200805021521881 - entra - grabarTemporalCarteraBancoppel");
	grabarLog(cLog);

	grabarLog("grabarTemporalCarteraBancoppel::Grabando Deuda Bancoppel en tabla temporal cartera");

	CGrabarTmpAbonoCrPrestamosFija tmpCrBancoppel(&odbc_1); // conexión a la B.D cartera

	if (lSuPago > 0L)
	{
		tmpCrBancoppel.cliente = m_grid.lCliente;
		tmpCrBancoppel.tienda = (short)m_grid.iTienda;
		tmpCrBancoppel.factura = lFactura;

		tmpCrBancoppel.interesadicional = lInteresCalculado - lAbonoInteres;
		tmpCrBancoppel.saldoactual = lSaldoNuevo;
		tmpCrBancoppel.importeultimomovimiento = lAbonoCuenta;
		tmpCrBancoppel.fechaultimomovimiento.ponerFecha(iDiaActual, iMesActual, iAnioActual);
		tmpCrBancoppel.caja = (short)m_grid.iCaja;
		tmpCrBancoppel.sistema = (short)iSistema;

		tmpCrBancoppel.prepararInsert("tmpabonocrcancelacionbancoppel");
		if (tmpCrBancoppel.Insert())
		{
			tmpCrBancoppel.Commit();
			iFlagCrPrestamo = 1;
		}
		else
		{
			tmpCrBancoppel.odbc->GetLastError(tmpCrBancoppel.GetHstmt());
			grabarMensajeError("C", m_grid.iCaja, (LPTSTR)(LPCTSTR)m_grid.sServer, "CapturarAbono", "CDlgCapturarAbono", "grabarTemporalCarteraBancoppel", "Error al Insertar en la Tabla tmpabonocrcancelacionbancoppel", m_grid.lEmpleado, "ERROR EN LA CONSULTA(tmpabonocrcancelacionbancoppel)", tmpCrBancoppel.odbc, m_grid.iMuestraMsg);
			bContinuar = false;
		}
	}
	return bContinuar;
}

bool CDlgCapturarAbono::grabarCambioSitCte()
{
	char cLog[500] = { 0 };
	bool bRegresar = true;

	sprintf_s(cLog, "FC0200805021521885 - entra - grabarCambioSitCte");
	grabarLog(cLog);

	if (iFlagPago60Restructurado == 1) //esta activo lo de la nueva cartera del tiempo aire
	{
		grabarLog("grabarCambioSitCte::actualizando datos cliente");

		iProceso = CAPTURA_ABONO;
		iRegla = INCLUIRCARCLIENTECUENTARESTRUCTURADA;

		if (ValidarSituacionEspecial(m_grid.lCliente, iRegla, iProceso, 3))
		{
			iRegla = DESMARCARCLIENTECUENTARESTRUCTURADA;
			if (ConsultaMarcarSituacionEspecial(iRegla, iProceso, cSituacioEspecial, iIdSituacion))
			{
				char cNombre[50] = { 0 }, cMensaje[512] = { 0 };
				sprintf_s(cNombre, "%s %s %s", sNombreCliente, sApellidoPaterno, sApellidoMaterno);
				sprintf_s(cJsonPost, "{\"ClaveEstatus\":\"D\",\"NumeroCliente\":%d,\"NumeroFolioSolicitante\":0,\"NombreCliente\":\"%s\""
					",\"IdSituacionEspecialSolicitado\":%d,\"NumEmpleadoAutoriza\":%ld,\"Tienda\":%d,\"Caja\":%d"
					",\"Area\":\"C\"}", m_grid.lCliente, cNombre, iIdSituacion, m_grid.lEmpleado, m_grid.iTienda, m_grid.iCaja);

				if (!grabarCrearSituacionEspecialArray(cJsonPost, cMensaje))
				{
					AfxMessageBox(cMensaje);
				}
			}
			else
			{
				bRegresar = false;
			}
		}
	}
	return bRegresar;
}

void CDlgCapturarAbono::validarPopUpPrestamoPersonal()
{
	char cLog[500] = { 0 };
	char cDll[64] = { 0 }, cArgvIN1[1024] = { 0 }, cArgvIN2[1024] = { 0 }, cArgvOUT1[1024] = { 0 }, cArgvOUT2[1024] = { 0 };
	long lImportePrestamo = 0;
	bool bPrestamoBRM = false;
	int iFlagInvitacionBRM = 0;
	bool bPopUp = false;

	sprintf_s(cLog, "FC0200805021521889 - entra - validarPopUpPrestamoPersonal");
	grabarLog(cLog);

	obtenerFlag('C', FLAGC_INVITACION_BRM_PRESTAMOS, iFlagInvitacionBRM);

	sprintf_s(cLog, "CDlgCapturarAbono::validarPopUpPrestamoPersonal. Flag para invitacion BRM: %d", iFlagInvitacionBRM);
	grabarLog(cLog);

	if (iFlagInvitacionBRM == 1)
	{
		if(GenerarToken( cIPServidorTiendaNumero, iTiendaDlg, IDU_ORIGEN , iCajaActual , IDU_SERVICIOBRM , "api.prestamospersonales", OPCION_TOKEN_AUTH))
		{
			bPrestamoBRM = leerCandidatoPrestamoBRM(m_grid.lCliente);

			sprintf_s( cLog, "CDlgCapturarAbono::validarPopUpPrestamoPersonal: El valor de iEstatusApi es: [%d]", iEstatusApi);
			grabarLog( cLog );

			sprintf_s( cLog, "CDlgCapturarAbono::validarPopUpPrestamoPersonal: El valor de bPrestamoBRM es: [%d]", bPrestamoBRM);
			grabarLog( cLog );

			if(bPrestamoBRM == false && iEstatusApi == 410)
			{
				sprintf_s( cLog, "CDlgCapturarAbono::validarPopUpPrestamoPersonal: El cliente no pertenece al grupo de evaluacion");
				grabarLog( cLog );

				sprintf_s( cLog, "CDlgCapturarAbono::validarPopUpPrestamoPersonal: El cliente se valida por ccuenta");
				grabarLog( cLog );

				try
				{
					lImportePrestamo = leerCandidatoPrestamoCCuenta(m_grid.sServer, m_grid.iTienda, m_grid.lEmpleado, iCajaActual, m_grid.iMuestraMsg, lClienteDlg, iSistema);

					sprintf_s( cLog, "CDlgCapturarAbono::validarPopUpPrestamoPersonal: El valor de importe es: [%d]", lImportePrestamo);
					grabarLog( cLog );

					if (lImportePrestamo > 0)
					{
						mostrarPopUpPrestamoPersonal();
					}
				}
				catch(...)
				{
					sprintf_s(cLog, "CDlgCapturarAbono::validarPopUpPrestamoPersonal. mostrarPopUp.");
					grabarLog(cLog);
				}
			}
			if(bPrestamoBRM == true && iEstatusApi == 200)
			{
				try
				{
					mostrarPopUpPrestamoPersonal();
				}
				catch(...)
				{
					sprintf_s(cLog, "CDlgCapturarAbono::validarPopUpPrestamoPersonal. mostrarPopUp");
					grabarLog(cLog);
				}
			}
		}

	}
	else 
	{
		sprintf_s(cLog, "CDlgCapturarAbono::validarPopUpPrestamoPersonal. El cliente se valida por ccuenta.");
		grabarLog(cLog);

		lImportePrestamo = leerCandidatoPrestamoCCuenta(m_grid.sServer, m_grid.iTienda, m_grid.lEmpleado, iCajaActual, m_grid.iMuestraMsg, lClienteDlg, iSistema);

		sprintf_s( cLog, "CDlgCapturarAbono::validarPopUpPrestamoPersonal: El valor de importe es: [%d]", lImportePrestamo);
		grabarLog( cLog );

		if (lImportePrestamo > 0)
		{
			mostrarPopUpPrestamoPersonal();
		}

	}
	grabarLog("CDlgCapturarAbono:: Salió de validarPopUpPrestamoPersonal()" );
}
void CDlgCapturarAbono::mostrarPopUpPrestamoPersonal()
{
	char cLog[500] = { 0 };
	long lIdPopUp = 0;
	short iTitular = 0;
	int iInvitacion = 0;
	char cDll[64] = { 0 }, cArgvIN1[1024] = { 0 }, cArgvIN2[1024] = { 0 }, cArgvOUT1[1024] = { 0 }, cArgvOUT2[1024] = { 0 };

	sprintf_s(cLog, "CDlgCapturarAbono::mostrarPopUpPrestamoPersonal. Mensaje Pop Up Invitacion Prestamo Personal ");
	grabarLog(cLog);

	SParametros parametros;
	memset(&parametros, 0, sizeof(parametros));
	parametros.iLink = generarLink();
	sprintf_s(parametros.sServer, "%s", (LPCTSTR)m_grid.sServer);
	parametros.iTienda = m_grid.iTienda;
	parametros.lEmpleado = m_grid.lEmpleado;
	parametros.iCajaActual = iCajaActual;
	parametros.iMuestraMsg = m_grid.iMuestraMsg;
	parametros.lCliente = lClienteDlg;
	parametros.iNumSistema = iSistema;


	if (AfxMessageBox("¡Es un cliente puntual! Felicitalo, invítale a gozar del beneficio del Préstamo Personal, indicale la cantidad más alta de la que puede disponer." , MB_OKCANCEL) == IDOK )
	{
		iInvitacion = 1;
		sprintf_s(cLog, "CDlgCapturarAbono::mostrarPopUpPrestamoPersonal. El cliente ha aceptado la invitacion");
		grabarLog(cLog);
	}
	else
	{
		iInvitacion = 2;
		grabarLog("El cliente ha rechazado la invitacion");
	}
	//VALIDAR CLIENTE TITULAR
	if (this->iBiometrizadoCliente == VALIDACION_BIOMETRIZADA_TITULAR)
	{
		iTitular = 1; 
		grabarLog("grabarAbono::Es cliente titular");
	}

	lIdPopUp = InvitacionPrestamoPopUp(m_grid.iTienda, iCajaActual, iCiudadGnDominio, lClienteDlg, m_grid.lEmpleado, iInvitacion, iTitular, iSistema);
	if (lIdPopUp != 0)
	{
		parametros.iNumSistema = 5;
		parametros.lKeyX = lIdPopUp;
		sprintf_s(cLog, "CDlgCapturarAbono::mostrarPopUpPrestamoPersonal(): iNumSistema [%i], lKeyX[%i]", parametros.iNumSistema, parametros.lKeyX);
		grabarLog(cLog);
	}
	if (iInvitacion == 1 && iTitular == 1)
	{
		parametros.iTipoCoordenada = 1;
		//Ruta del archivo DLL a ejecutar
		memcpy(cArgvIN1, &parametros, sizeof(parametros));
		nombreArchivo( "CA0164.DLL", cDll, DIRECTORIO_CA );
		CargarDLL dll(cDll, "CA0164", cArgvIN1, cArgvIN2, cArgvOUT1, cArgvOUT2);
	}
	grabarLog("CDlgCapturarAbono:: Salió de mostrarPopUpPrestamoPersonal()" );
}


long CDlgCapturarAbono::InvitacionPrestamoPopUp(int iTienda, int iCaja, int iCiudad, long lCliente, long lCajero, int iInvitacion, int iTitular, short iSistema)
{
	int iRetorno = 0;
	bool bRetorno = false;
	CString sUrl = "", sRespuesta = "";
	char ConsultaUrl[128] = {0};
	char cMetodoServicio[255] =  {0};
	char cJson[350] = {0};
	char cLog[500] = {0};
	long lIdPopUp = 0;
	Json::Value root;
	Json::Reader reader;

	iRetorno = sprintf_s( cMetodoServicio, "/invitacionprestamopopup" );
	if (iRetorno >=0) {
		bRetorno = true;
	}

	iRetorno = sprintf_s( cJson, "{\"numeroTienda\": %i,\"numeroCaja\": %i,\"numeroCiudad\": %i,\"numeroCliente\": %i,\"numeroCajero\": %i,\"opcionInvitacionaceptada\": %i,\"opcionClienteTitular\": %i}", iTienda, iCaja, iCiudad, lCliente, lCajero, iInvitacion, iTitular);

	sprintf_s(cLog, "InvitacionPrestamoPopUp - entra - Json %s", cJson);
	grabarLog(cLog);

	obtenerurlService(URL_APIPOPUP, urlservice);
	sUrl.Format( "%s%s", urlservice, cMetodoServicio );
	sprintf_s(ConsultaUrl, "%s", sUrl.Trim());

	sprintf_s(cLog, "InvitacionPrestamoPopUp - entra - url %s", ConsultaUrl);
	grabarLog(cLog);

	//GENERAR TOKEN
	//(char *cIpTiendaLocal , int iTienda , int iSistema , int iCaja , int iServicio , char *cNombreServicio , int iOpcion);
	if( GenerarToken( cIPServidorTiendaNumero , iTienda, IDU_ORIGEN , iCaja , IDU_SERVICIO , "api.popup", OPCION_TOKEN_AUTH ) )
	{
		this->consumirServicio = new CConsumirServicioRest( ConsultaUrl, cJson, sToken );
		sRespuesta.AppendFormat( "%s", this->consumirServicio->ObtenerUltimaRespuesta() );
		grabarLog("CDlgCapturarAbono Liberar --> consumirServicio 25446 Cambio Softtek");
		delete this->consumirServicio;
		grabarLog("CDlgCapturarAbono Se libera --> objCargaDll 25446 Cambio Softtek");


		sprintf_s(cLog, "GenerarToken:: Generar token");
		grabarLog(cLog);	

		if (!sRespuesta.IsEmpty())
		{
			std::string sInJson = sRespuesta;
			bool bParsedSuccess = reader.parse(sInJson, root, false);

			if(bParsedSuccess)
			{
				if (root["meta"]["statusCode"].asInt64() == 200)
				{
					lIdPopUp = root["data"]["identificadorPopUp"].asInt64();
					grabarLog("Consulto el identificador pop up");
				}
			}
		}
	}
	return lIdPopUp;
}
bool CDlgCapturarAbono::GenerarTokenSSO( long lCliente, short iTienda, short iCaja, short iSistema, long lEmpleado, char* cIpTiendaNumero)
{
	bool bRespuesta = true;
	iscIdOrigenConfig = 1; 
	iscIduServicioConfig = 6; //Llaves de prestamo personal 
	sesion = NULL;
	entorno = new CEntorno();   
	entorno->lCliente = lCliente;
	entorno->iTienda = iTienda;
	entorno->iCaja = iCaja;
	entorno->iSistema = iSistema;
	entorno->lEmpleado = lEmpleado;
	entorno->sIpTienda.AppendFormat("%s", cIpTiendaNumero);
	sToken.Empty();
	this->sesion = new CSesion(entorno, iscIdOrigenConfig, iscIduServicioConfig);   
	sToken.AppendFormat("%s", this->sesion->GetLastToken());
	grabarLog("CDlgCapturarAbono Liberar --> sesion  entorno 25487 Cambio Softtek");
	delete sesion; 
	delete entorno;
	grabarLog("CDlgCapturarAbono Se libera --> sesion  entorno 25487 Cambio Softtek");
	if (sToken.IsEmpty())
	{
		bRespuesta = false;
	} 
	return bRespuesta;
}

bool CDlgCapturarAbono::GenerarToken(char *cIpTiendaLocal , int iTienda , int iSistema , int iCaja , int iServicio , char *cNombreServicio , int iOpcion)
{
	bool bRetorno = false , bRegresa = false, bFlag = false;
	CString sIpTiendaLocal = "" , sTienda = "" , sSistema = "" , sCaja = "" , sServicio = "" , sNombreServicio = "" , sOpcion = "";
	CString sRuta = "" , sClaseConstructor = "" , sMetodo = "";
	CStringArray sArgsConstructor;
	CStringArray sArgsMetodo;
	CString sRespuesta = "";
	int iRetorno = 0;
	sToken.Empty();

	int iFlagTokenServicios = 0;

	bFlag = obtenerFlag('C', FLAGC_ENVIAR_TOKEN_PRESTAMOS, iFlagTokenServicios);

	grabarLog("CDlgCapturarAbono::GenerarToken(...) : Inicia metodo GenerarToken(...)");

	if(iFlagTokenServicios == 1)
	{
		WinExec("C:\\Windows\\Microsoft.NET\\Framework\\v4.0.30319\\RegAsm.exe C:\\sys\\progx\\libcsharp\\PUENTECSHARPTIENDA.DLL /tlb:C:\\sys\\progx\\libcsharp\\PUENTECSHARPTIENDA.TLB /codebase",SW_HIDE);

		sIpTiendaLocal.Format( "%s" , cIpTiendaLocal );
		sTienda.Format( "%i" , iTienda );
		sSistema.Format( "%i" , iSistema );
		sCaja.Format( "%i" , iCaja );
		sServicio.Format( "%i" , iServicio );
		sNombreServicio.Format( "%s" , cNombreServicio);
		sOpcion.Format( "%i" , iOpcion );

		sRuta = "C:\\SYS\\PROGX\\GN\\GN0290.DLL";
		sClaseConstructor = "ObtenerTokenServicios.ObtenerToken";
		sMetodo = "ObtenerTokenServicio";

		sArgsConstructor.Add("");

		sArgsMetodo.Add( cIpTiendaLocal );
		sArgsMetodo.Add( sTienda );
		sArgsMetodo.Add( sSistema );
		sArgsMetodo.Add( sCaja );
		sArgsMetodo.Add( sServicio );
		sArgsMetodo.Add( cNombreServicio );
		sArgsMetodo.Add( sOpcion );

		grabarLog("CDlgCapturarAbono::GenerarToken(...) -> Inicia cargado de GN290");

		::CoInitialize(NULL);
		CCargaDllCSharp *objPuente = new CCargaDllCSharp();
		objPuente->CargarDllCSharp( sRuta , sClaseConstructor , METODO_STRING , sMetodo , sArgsConstructor , sArgsMetodo );
		objPuente->getRespuesta( sRespuesta );
		grabarLog("CDlgCapturarAbono Liberar --> objPuente 25545 Cambio Softtek");
		delete objPuente;
		grabarLog("CDlgCapturarAbono Liberar --> objPuente 25487 Cambio Softtek");

		::CoUninitialize();

		grabarLog("CDlgCapturarAbono::GenerarToken(...) -> Finaliza cargado de GN290");


		if (!sRespuesta.IsEmpty())
		{
			sToken.AppendFormat( "%s" , sRespuesta );
			grabarLog("CDlgCapturarAbono::GenerarToken(...) -> bRegresa[ true ]");
			bRegresa = true;
		}
		else
		{
			grabarLog("CDlgCapturarAbono::GenerarToken(...) -> Error al obtener el TokenAuth: bRegresa[ false ]");
			bRegresa = false;
		}
	}
	else
	{
		sToken.AppendFormat( "%s" , "Token" );
		grabarLog("CDlgCapturarAbono::GenerarToken(...) -> Token default");
		bRegresa = true;
	}

	grabarLog("CDlgCapturarAbono::GenerarToken(...) : Finaliza metodo GenerarToken(...)");
	return bRegresa;

}


void CDlgCapturarAbono::imprimirReferenciaJapac(C_FormasPCL &hoja, int iLinea)
{
	char cLog[500] = { 0 };
	CString sReferencia;
	char cSql[180] = { 0 }, cRecibo[10] = { 0 }, cCuenta[10] = { 0 }, cTexto[22] = { 0 };
	int iDigitoVerificador = 0;

	CObtenerReciboJapac  obtenerReciboJapacTmp(&odbc);

	sprintf_s(cLog, "FC0200805021521893 - entra - imprimirReferenciaJapac");
	grabarLog(cLog);

	sprintf_s(cSql, "SELECT clave, tienda, ciudad, caja, recibo, importe, ruta, folio, cuenta, efectuo, digito, cliente, flagincluyerecibo FROM tmpcacarmovservicio WHERE clave = 'A' and caja = %d;", m_grid.iCaja);

	if (!obtenerReciboJapacTmp.Exec(cSql))
	{
		obtenerReciboJapacTmp.odbc->GetLastError(obtenerReciboJapacTmp.GetHstmt());
		grabarMensajeError("C", m_grid.iCaja, (LPTSTR)(LPCTSTR)m_grid.sServer, "CapturarAbono", "CDlgCapturarAbono", "imprimirReferenciaJapac", cSql, m_grid.lEmpleado, "ERROR EN LA CONSULTA(imprimirReferenciaJapac)", obtenerReciboJapacTmp.odbc, m_grid.iMuestraMsg);
	}
	else
	{
		obtenerReciboJapacTmp.activarCols();
		while (obtenerReciboJapacTmp.Leer())
		{
			sprintf_s(cRecibo, "%09d", obtenerReciboJapacTmp.folio); //RECIBO
			sprintf_s(cCuenta, "%s", obtenerReciboJapacTmp.cuenta); //CUENTA
			cRecibo[9] = 0;
			cCuenta[9] = 0;
			iDigitoVerificador = obtenerReciboJapacTmp.digito;        //DIGITO VERIFICADOR

			sReferencia.Format("%s-%s-%d", cRecibo, cCuenta, iDigitoVerificador);
			sReferencia.Trim();
			sprintf_s(cTexto, "%s", sReferencia);
			cTexto[21] = 0;

			hoja.poner("REFERENCIA:", iLinea, 56);
			hoja.poner(cTexto, iLinea, 68);
		}
	}
	sprintf_s(cLog, "FC0200805021521895 - entra - imprimirReferenciaJapac");
	grabarLog(cLog);

}

int CDlgCapturarAbono::tiposDeEtp2()
{
	char cLog[500] = { 0 };
	int iTipoEtp = 0;
	bool bSalir = true;
	iTipoEtpFicha = 0;

	sprintf_s(cLog, "FC0200805021521897 - entra - tiposDeEtp2");
	grabarLog(cLog);

	while (bSalir)
	{
		char * opciones[] = {
			"       F3         Efectivo Por Recuperación de Robo Ropa    ",
			"       F4         Efectivo Por Recuperación de Robo muebles ",
			"       F5         Estacionamiento                           ",
			"       F6         Ficha Extraviada                          ",
			"       Esc  Salir                                           ",
			"" };

		int respuesta[] = { F3,F4,F5,F6,ESC,0 };

		C_Menu menu(" TIPOS DE ETP ", opciones, respuesta);

		switch (menu.OpcionSeleccionada())
		{
		case F3:
			{
				m_mensaje.SetWindowText("E   Efectivo Por Recuperación de Robo Ropa                     ");
				iTipoEtp = 4;
				cTipoEtp[0] = 'E';
				bSalir = false;
			}
			break;
		case F4:
			{
				m_mensaje.SetWindowText("J   Efectivo Por Recuperación de Robo Muebles                     ");
				iTipoEtp = 8;
				cTipoEtp[0] = 'J';
				bSalir = false;
			}
			break;
		case F5:
			{
				m_mensaje.SetWindowText("K   Estacionamiento                     ");
				iTipoEtp = 9;
				cTipoEtp[0] = 'K';
				iTipoEtpFicha = 0;
				bSalir = false;
			}
			break;
		case F6:
			{
				m_mensaje.SetWindowText("K   Ficha Extraviada                     ");
				iTipoEtp = 9;
				cTipoEtp[0] = 'K';
				iTipoEtpFicha = 1;
				bSalir = false;
			}
			break;
		case ESC:
			bSalir = false;
			break;
		default:
			break;
		}
		cTipoEtp[1] = 0;
	}
	return iTipoEtp;
}

bool CDlgCapturarAbono::LeerTarjeta(int iOpcion, char *cTextoMsj)
{
	char cLog[500] = { 0 };
	CString sDato;
	bool bRegresa = false;
	char cDato[20] = { 0 };
	char cNombreProyecto[100] = { 0 }, cNombreFuncionDLL[10] = { 0 }, cInputParam1[1024] = { 0 }, cInputParam2[1024] = { 0 }, cOutputParam1[1024] = { 0 }, cOutputParam2[1024] = { 0 };

	SParametros parametros;
	memset(&parametros, 0, sizeof(SParametros));

	sprintf_s(cLog, "FC0200805021521901 - entra - LeerTarjeta");
	grabarLog(cLog);

	struct RespuestaModulo
	{
		long lCliente;
		char cMsjError[50];
		__int64 iNumTarjeta;
	}
	sRespuestaModulo;

	memset(cTarjeta, 0, sizeof(cTarjeta));
	memset(&sRespuestaModulo, 0, sizeof(sRespuestaModulo));

	sprintf_s(cNombreProyecto, "C:\\sys\\progx\\gn\\GN0110.DLL");
	sprintf_s(cNombreFuncionDLL, "GN0110");

	sprintf_s(parametros.sServer, "%s", (LPCTSTR)m_grid.sServer);
	parametros.iTienda = m_grid.iTienda;
	parametros.lEmpleado = m_grid.lEmpleado;
	parametros.iCajaActual = m_grid.iCaja;
	parametros.iMuestraMsg = m_grid.iMuestraMsg;
	parametros.iNumSistema = iSistema;
	parametros.iTipo = iOpcion; // 0 - Lee la tarjeta. 1 - Busca el numero de tarjeta en cartera sin leer tarjeta.

	parametros.iLink = generarLink();

	if (iOpcion == 1)
	{
		m_cliente.GetWindowText(sDato);
		sDato.Trim();
		sprintf_s(cDato, "%s", (LPCTSTR)sDato);
		memcpy(cInputParam2, cDato, 16);
	}

	memcpy(cInputParam1, &parametros, sizeof(SParametros));
	CargarDLL cargarDll(cNombreProyecto, cNombreFuncionDLL, cInputParam1, cInputParam2, cOutputParam1, cOutputParam2);

	if (cargarDll.getResultado() > 0)
	{
		memcpy(&sRespuestaModulo, cOutputParam1, sizeof(sRespuestaModulo));
		lClienteDlg = sRespuestaModulo.lCliente;

		if (lClienteDlg > 1)
		{
			bRegresa = true;
			sDato.Format("%ld", lClienteDlg);
			m_cliente.SetWindowText(sDato);
			sprintf_s(cTarjeta, "%I64d", sRespuestaModulo.iNumTarjeta);
			if (iOpcion == 1)
			{
				m_grid.lCliente = lClienteDlg;
			}
		}

		if (lClienteDlg <= 0)
		{
			sprintf(cTextoMsj, "%s", sRespuestaModulo.cMsjError);
			m_grid.lCliente = 0L;
			m_cliente.SetSel(0, 16);
		}
	}
	return bRegresa;
}

void CDlgCapturarAbono::pagoAbonosPlanMovistar()
{
	char cLog[500] = { 0 };
	SParametros parametros;
	char cNombreProyecto[100] = { 0 }, cNombreFuncionDLL[10] = { 0 }, cInputParam1[1024] = { 0 }, cInputParam2[1024] = { 0 };
	int iRegresaDll = 0;

	memset(&parametros, 0, sizeof(parametros));

	sprintf_s(cLog, "FC0200805021521905 - entra - pagoAbonosPlanMovistar");
	grabarLog(cLog);

	nombreArchivo("GN0057.DLL", cNombreProyecto, DIRECTORIO_GN);
	sprintf_s(cNombreFuncionDLL, "GN0057");

	parametros.iLink = generarLink();

	sprintf_s(parametros.sServer, "%s", (LPCTSTR)m_grid.sServer);
	parametros.iTienda = m_grid.iTienda;
	parametros.lEmpleado = m_grid.lEmpleado;
	parametros.iCajaActual = m_grid.iCaja;
	parametros.iMuestraMsg = m_grid.iMuestraMsg;
	parametros.iNumSistema = iSistema;
	parametros.iFlagServicio = 2;

	memcpy(cInputParam1, &parametros, sizeof(parametros));
	CargarDLL cargarDll(cNombreProyecto, cNombreFuncionDLL, cInputParam1, cInputParam2);
	iRegresaDll = cargarDll.getResultado();

	if (iRegresaDll < 0)
	{
		AfxMessageBox("Error al cargar el programa GN0057.DLL", MB_ICONERROR);
	}
}

bool CDlgCapturarAbono::validarCaja()
{
	char cLog[500] = { 0 };
	bool bRegresa = true;
	int iCajaDuplicada = 0;
	SParametros argv;

	sprintf_s(cLog, "FC0200805021521909 - entra - validarCaja");
	grabarLog(cLog);

	if (iSistema == 3)
	{
		char cNombreProyecto[100] = { 0 }, cInputParam1[1024] = { 0 }, cInputParam2[1024] = { 0 };
		memset(&argv, 0, sizeof(argv));
		sprintf_s(argv.sServer, "%s", (LPCTSTR)m_grid.sServer);
		argv.iNumSistema = SISTEMA_CAJAS;
		argv.iTienda = m_grid.iTienda;
		argv.iCajaActual = iCajaActual;
		argv.iFlagGeneral = 0;

		argv.iLink = generarLink();

		memcpy(cInputParam1, &argv, sizeof(argv));
		nombreArchivo("GN0073.DLL", cNombreProyecto, DIRECTORIO_GN);
		CargarDLL cargarDll(cNombreProyecto, "GN0073", cInputParam1, cInputParam2);
		iCajaDuplicada = cargarDll.getResultado();
		//iCajaDuplicada = 0 Mensaje invalido o verificacion de link incorrecto
		//               = 1 registro de caja OK
		//               = 2 error de conexion
		//               = 3 error al verificar el sistema-caja
		//               = 4 caja duplicada o eliminada

		if (iCajaDuplicada != 1)
		{
			bRegresa = false;
		}
	}
	return bRegresa;
}

bool CDlgCapturarAbono::imprimirClausulaClub(C_FormasPCL &xHoja, int iConyugal, int iEstaEnfermo)
{
	char cLog[500] = { 0 };
	int iCol = 1, iRen = 3;
	char cConsulta[600] = { 0 }, cTextoOut[256] = { 0 };
	CString sDato = "";
	bool bContinuar = true;

	sprintf_s(cLog, "FC0200805021521913 - entra - imprimirClausulaClub");
	grabarLog(cLog);

	iniciarHoja(xHoja);
	xHoja.poner("Resumen de condiciones generales", iRen, iCol);
	iRen++;

	sprintf_s(cConsulta, "SELECT catMod.idu_modulopolizaclub, catMsg.idu_mensajepolizaclub, catMsg.desc_mensaje"
		" FROM cat_modulospolizaclub catMod"
		" INNER JOIN cat_mensajespolizaclub catMsg ON catMod.idu_modulopolizaclub = catMsg.idu_modulopolizaclub"
		" AND catMod.idu_tipoImpresion = catMsg.idu_tipoImpresion AND catMod.nom_area = catMsg.nom_area"
		" WHERE catMod.idu_modulopolizaclub IN (%d) AND catMod.idu_tipoImpresion = %d AND catMod.nom_area = 'C'"
		" ORDER BY catMod.idu_modulopolizaclub ASC, catMsg.idu_mensajepolizaclub ASC;", SECCION_1, MATRICIAL);

	CConsultarDescripcionClub ConsultaDescImpresion1(&odbc);

	if (ConsultaDescImpresion1.Exec(cConsulta))
	{
		ConsultaDescImpresion1.activarCols();
		while (ConsultaDescImpresion1.leer())
		{
			memset(cTextoOut, 0, sizeof(cTextoOut));
			sDato.Format("%s", ConsultaDescImpresion1.desc_mensaje);
			sDato.Trim();
			sDato.Replace('¿', '¨');
			sprintf_s(cTextoOut, "%s", (LPCTSTR)sDato);
			ponerAcento(cTextoOut);
			xHoja.poner(cTextoOut, iRen, iCol);
			iRen++;
			bContinuar = true;
		}
		if (bContinuar)
		{
			finHoja(xHoja);
			iRen = 4;
		}
	}
	else
	{
		ConsultaDescImpresion1.odbc->GetLastError(ConsultaDescImpresion1.GetHstmt());
		grabarMensajeError("C", m_grid.iCaja, (LPTSTR)(LPCTSTR)m_grid.sServer, "CA0030", "CDlgCapturarAbono", "imprimirClausulaClub", cConsulta, m_grid.lEmpleado, "ERROR AL OBTENER IMPRESION", ConsultaDescImpresion1.odbc, m_grid.iMuestraMsg);
		bContinuar = false;
	}
	if (bContinuar)
	{
		memset(cConsulta, 0, sizeof(cConsulta));
		sprintf_s(cConsulta, "SELECT catMod.idu_modulopolizaclub, catMsg.idu_mensajepolizaclub, catMsg.desc_mensaje"
			" FROM cat_modulospolizaclub catMod"
			" INNER JOIN cat_mensajespolizaclub catMsg ON catMod.idu_modulopolizaclub = catMsg.idu_modulopolizaclub"
			" AND catMod.idu_tipoImpresion = catMsg.idu_tipoImpresion AND catMod.nom_area = catMsg.nom_area"
			" WHERE catMod.idu_modulopolizaclub IN (%d) AND catMod.idu_tipoImpresion = %d AND catMod.nom_area = 'C'"
			" ORDER BY catMod.idu_modulopolizaclub ASC, catMsg.idu_mensajepolizaclub ASC;", SECCION_2, MATRICIAL);

		CConsultarDescripcionClub ConsultaDescImpresion2(&odbc);

		if (ConsultaDescImpresion2.Exec(cConsulta))
		{
			ConsultaDescImpresion2.activarCols();
			while (ConsultaDescImpresion2.leer())
			{
				memset(cTextoOut, 0, sizeof(cTextoOut));
				sDato.Format("%s", ConsultaDescImpresion2.desc_mensaje);
				sDato.Trim();
				sDato.Replace('¿', '¨');
				sprintf_s(cTextoOut, "%s", (LPCTSTR)sDato);
				ponerAcento(cTextoOut);
				xHoja.poner(cTextoOut, iRen, iCol);
				iRen++;
				bContinuar = true;
			}
			if (bContinuar)
			{
				finHoja(xHoja);
				iRen = 4;
			}
		}
		else
		{
			ConsultaDescImpresion2.odbc->GetLastError(ConsultaDescImpresion2.GetHstmt());
			grabarMensajeError("C", m_grid.iCaja, (LPTSTR)(LPCTSTR)m_grid.sServer, "CA0030", "CDlgCapturarAbono", "imprimirClausulaClub", cConsulta, m_grid.lEmpleado, "ERROR AL OBTENER IMPRESION", ConsultaDescImpresion2.odbc, m_grid.iMuestraMsg);
			bContinuar = false;
		}
		if (bContinuar)
		{
			memset(cConsulta, 0, sizeof(cConsulta));
			sprintf_s(cConsulta, "SELECT catMod.idu_modulopolizaclub, catMsg.idu_mensajepolizaclub, catMsg.desc_mensaje"
				" FROM cat_modulospolizaclub catMod"
				" INNER JOIN cat_mensajespolizaclub catMsg ON catMod.idu_modulopolizaclub = catMsg.idu_modulopolizaclub"
				" AND catMod.idu_tipoImpresion = catMsg.idu_tipoImpresion AND catMod.nom_area = catMsg.nom_area"
				" WHERE catMod.idu_modulopolizaclub IN (%d) AND catMod.idu_tipoImpresion = %d AND catMod.nom_area = 'C'"
				" ORDER BY catMod.idu_modulopolizaclub ASC, catMsg.idu_mensajepolizaclub ASC;", SECCION_3, MATRICIAL);

			CConsultarDescripcionClub ConsultaDescImpresion3(&odbc);

			if (ConsultaDescImpresion3.Exec(cConsulta))
			{
				ConsultaDescImpresion3.activarCols();
				while (ConsultaDescImpresion3.leer())
				{
					memset(cTextoOut, 0, sizeof(cTextoOut));
					sDato.Format("%s", ConsultaDescImpresion3.desc_mensaje);
					sDato.Trim();
					sDato.Replace('¿', '¨');
					sprintf_s(cTextoOut, "%s", (LPCTSTR)sDato);
					ponerAcento(cTextoOut);
					xHoja.poner(cTextoOut, iRen, iCol);
					iRen++;
					bContinuar = true;
				}
			}
			else
			{
				ConsultaDescImpresion3.odbc->GetLastError(ConsultaDescImpresion3.GetHstmt());
				grabarMensajeError("C", m_grid.iCaja, (LPTSTR)(LPCTSTR)m_grid.sServer, "CA0030", "CDlgCapturarAbono", "imprimirClausulaClub", cConsulta, m_grid.lEmpleado, "ERROR AL OBTENER IMPRESION", ConsultaDescImpresion3.odbc, m_grid.iMuestraMsg);
				bContinuar = false;
			}
			if (bContinuar)
			{
				if (iConyugal == 1)
				{
					if (iEstaEnfermo == 0)
					{
						xHoja.poner("SI(  )  NO( X ) ", iRen, iCol);
						iRen++;
					}
					else
					{
						xHoja.poner("SI( X )  NO(  ) ", iRen, iCol);
						iRen++;
					}
				}
				else
				{
					xHoja.poner("SI(  )  NO(  ) ", iRen, iCol);
					iRen++;
				}
				memset(cConsulta, 0, sizeof(cConsulta));
				sprintf_s(cConsulta, "SELECT catMod.idu_modulopolizaclub, catMsg.idu_mensajepolizaclub, catMsg.desc_mensaje"
					" FROM cat_modulospolizaclub catMod"
					" INNER JOIN cat_mensajespolizaclub catMsg ON catMod.idu_modulopolizaclub = catMsg.idu_modulopolizaclub"
					" AND catMod.idu_tipoImpresion = catMsg.idu_tipoImpresion AND catMod.nom_area = catMsg.nom_area"
					" WHERE catMod.idu_modulopolizaclub IN (%d) AND catMod.idu_tipoImpresion = %d AND catMod.nom_area = 'C'"
					" ORDER BY catMod.idu_modulopolizaclub ASC, catMsg.idu_mensajepolizaclub ASC;", SECCION_4, MATRICIAL);

				CConsultarDescripcionClub ConsultaDescImpresion4(&odbc);

				if (ConsultaDescImpresion4.Exec(cConsulta))
				{
					ConsultaDescImpresion4.activarCols();
					while (ConsultaDescImpresion4.leer())
					{
						memset(cTextoOut, 0, sizeof(cTextoOut));
						sDato.Format("%s", ConsultaDescImpresion4.desc_mensaje);
						sDato.Trim();
						sDato.Replace('¿', '¨');
						sprintf_s(cTextoOut, "%s", (LPCTSTR)sDato);
						ponerAcento(cTextoOut);
						xHoja.poner(cTextoOut, iRen, iCol);
						iRen++;
						bContinuar = true;
					}
					if (bContinuar)
					{
						finHoja(xHoja);
						iRen = 4;
					}
				}
				else
				{
					ConsultaDescImpresion4.odbc->GetLastError(ConsultaDescImpresion4.GetHstmt());
					grabarMensajeError("C", m_grid.iCaja, (LPTSTR)(LPCTSTR)m_grid.sServer, "CA0030", "CDlgCapturarAbono", "imprimirClausulaClub", cConsulta, m_grid.lEmpleado, "ERROR AL OBTENER IMPRESION", ConsultaDescImpresion4.odbc, m_grid.iMuestraMsg);
					bContinuar = false;
				}
				if (bContinuar)
				{
					memset(cConsulta, 0, sizeof(cConsulta));
					sprintf_s(cConsulta, "SELECT catMod.idu_modulopolizaclub, catMsg.idu_mensajepolizaclub, catMsg.desc_mensaje"
						" FROM cat_modulospolizaclub catMod"
						" INNER JOIN cat_mensajespolizaclub catMsg ON catMod.idu_modulopolizaclub = catMsg.idu_modulopolizaclub"
						" AND catMod.idu_tipoImpresion = catMsg.idu_tipoImpresion AND catMod.nom_area = catMsg.nom_area"
						" WHERE catMod.idu_modulopolizaclub IN (%d) AND catMod.idu_tipoImpresion = %d AND catMod.nom_area = 'C'"
						" ORDER BY catMod.idu_modulopolizaclub ASC, catMsg.idu_mensajepolizaclub ASC;", SECCION_5, MATRICIAL);

					CConsultarDescripcionClub ConsultaDescImpresion5(&odbc);

					if (ConsultaDescImpresion5.Exec(cConsulta))
					{
						ConsultaDescImpresion5.activarCols();
						while (ConsultaDescImpresion5.leer())
						{
							memset(cTextoOut, 0, sizeof(cTextoOut));
							sDato.Format("%s", ConsultaDescImpresion5.desc_mensaje);
							sDato.Trim();
							sDato.Replace('¿', '¨');
							sprintf_s(cTextoOut, "%s", (LPCTSTR)sDato);
							ponerAcento(cTextoOut);
							xHoja.poner(cTextoOut, iRen, iCol);
							iRen++;
							bContinuar = true;
						}
						if (bContinuar)
						{
							iRen++;
							iRen++;
							xHoja.poner("                          _________________________________________                            ", iRen, iCol);
							iRen++;
							xHoja.poner("                                      Firma del Asegurado                                      ", iRen++, iCol);
							finHoja(xHoja);
						}
					}
					else
					{
						ConsultaDescImpresion5.odbc->GetLastError(ConsultaDescImpresion5.GetHstmt());
						grabarMensajeError("C", m_grid.iCaja, (LPTSTR)(LPCTSTR)m_grid.sServer, "CA0030", "CDlgCapturarAbono", "imprimirClausulaClub", cConsulta, m_grid.lEmpleado, "ERROR AL OBTENER IMPRESION", ConsultaDescImpresion5.odbc, m_grid.iMuestraMsg);
						bContinuar = false;
					}
				}
			}
		}
	}
	return bContinuar;
}

//Menu para modificar los beneficiarios del titular o de los adicionales
static int PantallaMenuBeneficiarios(void)
{
	CUtil util;
	char cLog[500] = { 0 };
	int iFlag = 4;

	sprintf_s(cLog, "FC0200805021521920 - entra - PantallaMenuBeneficiarios");
	util.GrabarLog(cLog);

	while (iFlag == 4)
	{
		char * opciones[] = {
			" F1  CLUB DE PROTECCIÓN FAMILIAR ",
			" F2  CLUB ADICIONAL              ",
			" Esc SALIR                       ",
			"" };
		int respuesta[] = { F1,F2,ESC,0 };
		C_Menu menu(" CLUB DE PROTECCION FAMILIAR ", opciones, respuesta);
		switch (menu.OpcionSeleccionada())
		{
		case F1:
			iFlag = 1;
			break;
		case F2:
			iFlag = 3;
			break;
		case ESC:
			iFlag = 0;
			break;
		default:
			break;
		}
	}
	return(iFlag);
}

//Cambio para el envio de SMS
int CDlgCapturarAbono::checarCuentaSegurosClubSMS()
{
	char cLog[500] = { 0 };
	int i = 0, iFlag = 0;
	CString sTexto;
	char cConcepto[20] = { 0 };

	sprintf_s(cLog, "FC0200805021521924 - entra - checarCuentaSegurosClubSMS");
	grabarLog(cLog);

	for (i = 0; i < iTotalCuentas; i++)
	{
		m_grid.QuickGetText(i, -1, &sTexto);
		sTexto.Trim();
		sprintf_s(cConcepto, "%s", (LPCTSTR)sTexto);
		if (memcmp(cConcepto, "P.FAMILIAR", 10) == 0)
		{
			m_grid.QuickGetText(i, 2, &sTexto);
			sTexto.Trim();
			sprintf_s(cConcepto, "%s", (LPCTSTR)sTexto);

			if (memcmp(cConcepto, "AFILIADO", 8) == 0)
			{
				iFlag = 1;
				break;
			}

			m_grid.QuickGetText(i, 3, &sTexto);
			sTexto.Trim();
			sprintf_s(cConcepto, "%s", (LPCTSTR)sTexto);
			if (memcmp(cConcepto, "VENCIO EL", 9) == 0)
			{
				iFlag = 1;
				break;
			}
		}
	}
	return iFlag;
}

//Para grabar los movimientos de los seguros adicionales en la tabla tmpsegurocacarmov
bool CDlgCapturarAbono::grabarSeguroCaCarmovTemporalAdicional(CGrabarTmpSeguroCaCarmov01 &tmpAdicionales)
{
	char cLog[500] = { 0 };
	char cSql[310] = { 0 };
	bool bRegresa = true;
	int iEdadAdicional = 0;
	short iDiaVencimientoAnterior = 1, iMesVencimientoAnterior = 1, iAnioVencimientoAnterior = 1900;

	sprintf_s(cLog, "FC0200805021521928 - entra - grabarSeguroCaCarmovTemporalAdicional");
	grabarLog(cLog);

	grabarLog("grabarSeguroCaCarmovTemporalAdicional::grabando seguro club adicional en tabla temporal");

	sprintf_s(cSql, "SELECT clave,tienda,caja,cliente,folio,cantidadseguros,cantidadsegurosanterior,importe,nombreadicional,apellidopaternoadic,apellidomaternoadic,fecnacadic,parentescoadic,respuesta FROM tmpcacarmovseguros WHERE cliente = %ld and clave = 'G' and tienda= %d and caja = %d order by consecutivo;", m_grid.lCliente, m_grid.iTienda, m_grid.iCaja);

	CGrabarTmpCaCarmovSeguro caCarmovSeguros(&odbc);
	if (caCarmovSeguros.Exec(cSql))
	{
		caCarmovSeguros.activarCols();

		iDiaVencimientoAnterior = (short)tmpAdicionales.fechavencimientoanterior.dia();
		iMesVencimientoAnterior = (short)tmpAdicionales.fechavencimientoanterior.mes();
		iAnioVencimientoAnterior = (short)tmpAdicionales.fechavencimientoanterior.ano();

		while (caCarmovSeguros.Leer())
		{
			tmpAdicionales.cantidadseguros = caCarmovSeguros.cantidadseguros;
			tmpAdicionales.cantidadsegurosanterior = caCarmovSeguros.cantidadsegurosanterior;
			tmpAdicionales.folio = caCarmovSeguros.folio;
			sprintf_s(tmpAdicionales.tiposeguro, "2");
			tmpAdicionales.fechanacimiento.ponerFecha(caCarmovSeguros.fecnacadic.dia(), caCarmovSeguros.fecnacadic.mes(), caCarmovSeguros.fecnacadic.ano());

			//Se calcula la edad del adicional
			iEdadAdicional = iAnioActual - caCarmovSeguros.fecnacadic.ano();
			if (iMesActual < caCarmovSeguros.fecnacadic.mes() || (iMesActual == caCarmovSeguros.fecnacadic.mes() && iDiaActual < caCarmovSeguros.fecnacadic.dia()))
			{
				iEdadAdicional--;
			}

			tmpAdicionales.edad = (short)iEdadAdicional; //para que grabe la edad del adicional

			// COMPRA DE SEGURO
			if (tmpAdicionales.folio == 0) //Para saber que es un seguro adicional nuevo
			{
				tmpAdicionales.tipomovimiento[0] = '6'; //Para guardar el movimiento G6 del seguro adicional
				tmpAdicionales.cantidadmeses = (short)iNumMesesAdicional; //Meses que se abonaron al seguro adicional
				//tmpAdicionales.importe=caCarmovSeguros.importe; //Importe del seguro adicional
				grabarLog("Consulta Precio seguro 10");
				consultarPrecioSeguroClub(tmpAdicionales.importe, tmpAdicionales.cantidadseguros, 2, (short)iEdadAdicional);

				tmpAdicionales.importe = tmpAdicionales.importe * iNumMesesAdicional;

				tmpAdicionales.mesesvencidos = 0;
				tmpAdicionales.fechavencimientoanterior.ponerFecha(1, 1, 1900);
			}
			else // ABONO A SEGURO
			{
				tmpAdicionales.tipomovimiento[0] = '1'; //Para guardar el movimiento G1 del seguro adicional
				tmpAdicionales.importe = caCarmovSeguros.importe * tmpAdicionales.cantidadmeses; //Importe del seguro adicional
				tmpAdicionales.tiposeguro[0] = '2';
				tmpAdicionales.flagseguroconyugal[0] = '1';
				tmpAdicionales.fechavencimientoanterior.ponerFecha(iDiaVencimientoAnterior, iMesVencimientoAnterior, iAnioVencimientoAnterior);
			}
			sprintf_s(cLog, "grabarSeguroCaCarmovTemporalAdicional:Importe: %ld, Folio= %ld, seguros = %d, segurosant = %d", tmpAdicionales.importe, tmpAdicionales.folio, tmpAdicionales.cantidadseguros, tmpAdicionales.cantidadsegurosanterior);
			grabarLog(cLog);

			if (!tmpAdicionales.Insert())
			{
				bRegresa = false;
				break;
			}
		}
	}
	else
	{
		bRegresa = false;
		caCarmovSeguros.odbc->GetLastError(caCarmovSeguros.GetHstmt());
		grabarMensajeError("C", m_grid.iCaja, (LPTSTR)(LPCTSTR)m_grid.sServer, "CA0030", "CDlgCapturarAbono", "grabarSeguroCaCarmovTemporalAdicional", cSql, m_grid.lEmpleado, "ERROR #10158", caCarmovSeguros.odbc, m_grid.iMuestraMsg);
	}
	return bRegresa;
}

//Para vender el seguro adicional
void CDlgCapturarAbono::ventaClubProteccionAdicional()
{
	char cLog[500] = { 0 };
	long lCuota = 0L, lCuotaNuevos = 0L, lCuotaTotal = 0L, lFolioSeguro = 0L;
	int i = 0, iFlag = 0, iFlagMsj = 0;
	short iSegurosCapturados = 0, iNumMeses = 0;
	char cTexto[20] = { 0 }, cMensajeSeguimiento[50] = { 0 };
	CString sTexto = "";
	bool bContinuar = false, bVencido = false;
	char cStatusSeguro = ' ', cTipoCan = ' ', cClaveNoOfrecer = ' ';

	sprintf_s(cLog, "FC0200805021521932 - entra - ventaClubProteccionAdicional");
	grabarLog(cLog);

	grabarLog("ventaClubProteccionAdicional: F5   Activar Club Adicional");

	long lSuPagoFamiliar = 0L;
	char cConcepto[20] = { 0 }, cRespuesta[80] = { 0 };

	if (iFlagSeguroAdicional == 1) //Si esta activo el flag para vender seguros adicionales
	{
		sprintf_s(cMensajeSeguimiento, "Metodo TieneSeguroClub 15");
		grabarLog(cMensajeSeguimiento);
		tieneSeguroClub(cStatusSeguro, cTipoCan, cClaveNoOfrecer, lFolioSeguro, bCteSeguro);

		if (cStatusSeguro != 'P')
		{
			if (iEdadCliente >= iEdadMinimaClub && iEdadCliente <= iEdadMaximaClubAdicional) //Si el cliente se encuentra en el rango de edad para comprar seguro adicional
			{
				if (iSegurosAdicionales < 10)
				{
					m_grid.QuickGetText(iColumnaClub, 22, &sTexto);

					if (atoi(sTexto) <= 3)
					{
						/* m_puntualidad2.GetWindowText(sTexto);
						if (sTexto.Trim() == "Z") //Al cliente Z no se le vende seguro adicional
						{
						AfxMessageBox("CLIENTE NO ES CANDIDATO PARA OFRECER CLUB ADICIONAL");
						}
						else
						{*/

						//Se agrego for
						for (int i = 0; i < iTotalCuentas; i++)
						{
							m_grid.QuickGetText(i, -1, &sTexto);
							sTexto.Trim();
							sprintf_s(cConcepto, "%s", (LPCTSTR)sTexto);
							if (memcmp(cConcepto, "P.FAMILIAR", 10) == 0)
							{
								m_grid.QuickGetText(i, 21, &sTexto);
								sTexto.Trim();
								sTexto.Remove(',');
								sTexto.Remove('.');
								sprintf_s(cRespuesta, "%s", (LPCTSTR)sTexto);
								lSuPagoFamiliar = atol(cRespuesta);
							}
						}
						//

						iNumMesesAdicional = 0;
						for (i = 0; i < iTotalCuentas; i++)
						{
							m_grid.QuickGetText(i, -1, &sTexto);
							sTexto.Trim();
							sprintf_s(cTexto, "%s", (LPCTSTR)sTexto);

							if (memcmp(cTexto, "P.FAMILIAR", 10) == 0)
							{
								m_grid.QuickGetText(i, 29, &sTexto);
								if (atoi(sTexto) == 0)
								{
									bVencido = true; //Para saber si tiene seguro vencido
								}

								m_grid.QuickGetText(i, 23, &sTexto);
								iNumMeses = (short)atol(sTexto);
								iNumMesesAdicional = iNumMeses;

								m_grid.QuickGetText(i, 1, &sTexto);
								lFolioSeguro = atol(sTexto);

								if (iNumMeses != 0)
								{
									bContinuar = true; //Para que permita vender seguro adicional siempre y cuando se abone al menos un mes al seguro titular
								}
								else
								{
									if (bBanderaTieneClub && !bVencido && iNumMeses == 0) //Si tiene club de proteccion y no esta vencido
									{
										bContinuar = consultarCrSegurosFechaVenceTit();
									}
									if (!bContinuar)
									{
										if (bBanderaTieneClub)
										{
											AfxMessageBox("CLIENTE NECESITA ABONAR A SU FOLIO CLUB DE PROTECCION FAMILIAR PARA ADQUIRIR SU CLUB ADICIONAL", MB_ICONINFORMATION);
											iFlagMsj = 1;
										}
										else
										{
											AfxMessageBox("ES NECESARIO AFILIAR AL CLUB DE PROTECCION FAMILIAR", MB_ICONINFORMATION);
											iFlagMsj = 1;
										}
									}
								}

								break;
							}
						}
						//se agrego && lSuPagoFamiliar>0
						if (bContinuar && lSuPagoFamiliar > 0)
						{
							CDlgCapturarDatosSeguro datosSeguro;

							datosSeguro.iCiudad = iCiudadGnDominio;
							datosSeguro.iTienda = m_grid.iTienda;
							iFlag = datosSeguro.checarHuellaChw(m_grid.lCliente, m_grid.iCaja, m_grid.lEmpleado, m_grid.iMuestraMsg); //Para pedir la huella del cliente o gerente

							if (iFlag > 0) //Si la huella ingresada es valida
							{
								if (bBanderaTieneClub && !bVencido) //Si tiene club de proteccion y no esta vencido
								{
									consultarCrSegurosFechaMesVence();
								}

								char cNombreProyecto[100] = { 0 }, cNombreFuncionDLL[10] = { 0 }, cInputParam1[1024] = { 0 }, cInputParam2[1024] = { 0 }, cOutputParam1[1024] = { 0 }, cOutputParam2[1024] = { 0 };
								SParametros parametros;
								memset(&parametros, 0, sizeof(SParametros));

								EstructuraCliente parametrosAdicional;
								memset(&parametrosAdicional, 0, sizeof(EstructuraCliente));

								parametros.iLink = generarLink();
								sprintf_s(parametros.sServer, "%s", (LPCTSTR)m_grid.sServer);
								parametros.iTienda = m_grid.iTienda;
								parametros.lEmpleado = m_grid.lEmpleado;
								parametros.iCajaActual = m_grid.iCaja;
								parametros.iMuestraMsg = m_grid.iMuestraMsg;
								parametros.iNumSistema = SISTEMA_CAJAS;
								parametros.lCliente = m_grid.lCliente;
								parametros.iCiudad = iCiudad;
								parametros.iFlagGeneral = iSegurosAdicionales; //Para saber cuantos adicionales tiene el cliente
								parametros.lFactura = 0;

								m_grid.QuickGetText(i, 25, &sTexto);
								sTexto.Trim();
								sprintf_s(cTexto, "%s", (LPCTSTR)sTexto);

								parametrosAdicional.lFolio = lFolioSeguro; //Folio del seguro titular
								parametrosAdicional.iAnioNac = iAnioNacimiento; //Año de nacimiento del cliente
								parametrosAdicional.iDiaNac = iDiaNacimiento; //Dia de nacimiento del cliente
								parametrosAdicional.iMesNac = iMesNacimiento; //Mes de nacimiento del cliente
								parametrosAdicional.iFlagCapturaAbonos = 1;//Para saber que se llamo desde el modulo capturarabono
								parametrosAdicional.iVentaSeguroClub = 1; //Para saber que es venta de seguro adicional
								parametrosAdicional.iCantidadMeses = iNumMesesAdicional; //Numero de meses que se le cobraran al seguro adicional
								parametrosAdicional.iAnioVenc = valor_campo(&cTexto[4], 4); //Año de vencimiento del seguro
								parametrosAdicional.iMesVenc = valor_campo(&cTexto[2], 2); //Mes de vencimiento del seguro
								parametrosAdicional.iDiaVenc = valor_campo(&cTexto[0], 2); //Dia de vencimiento del seguro
								sprintf_s(parametrosAdicional.cNombreCompleto, "%s %s %s", (LPCTSTR)sNombreCliente, (LPCTSTR)sApellidoPaterno, (LPCTSTR)sApellidoMaterno); //Nombre del completo del cliente
								sprintf_s(parametrosAdicional.cSexo, "%s", cSexoCliente);

								memcpy(cInputParam1, &parametros, sizeof(SParametros));
								memcpy(cInputParam2, &parametrosAdicional, sizeof(EstructuraCliente));
								// Ruta del archivo DLL a ejecutar
								nombreArchivo("CA0149.DLL", cNombreProyecto, DIRECTORIO_CA);
								// Nombre de la función principal en el DLL
								sprintf_s(cNombreFuncionDLL, "CA0149");
								CargarDLL cargarDll(cNombreProyecto, cNombreFuncionDLL, cInputParam1, cInputParam2, cOutputParam1, cOutputParam2);
								iRegresaDll = cargarDll.getResultado();
								if (iRegresaDll > 0)
								{
									iSegurosCapturados = (short)(atoi(cOutputParam1) - iSegurosAdicionales); //Para saber cuantos seguros adicionales se capturaron
									iSegurosAdicionalesNuevos = iSegurosAdicionalesNuevos + iSegurosCapturados; //Para saber el total de seguros adicionales nuevos que se han capturado
									if (iSegurosCapturados > 0)
									{
										iFlagCapturoSeguroAdicional = 1; //Para saber que se capturo un seguro adicional
										iSegurosAdicionales = iSegurosAdicionales + iSegurosCapturados;

										sprintf_s(cTexto, "ADIC %d", iSegurosAdicionales); //Para mostrar en pantalla el numero de seguros adicionales

										m_grid.QuickSetText(i, 5, cTexto);
										m_grid.QuickSetAlignment(i, 5, UG_ALIGNCENTER);

										obtenerPreciosSegurosAdicionales(lCuotaNuevos);
										lCuota = consultarCuotaAdicionales(false); //Obtiene la cuota de los seguros adicionales que ya tenia el cliente
										lImporteAdicionalesNuevos = (lCuotaNuevos * iNumMesesAdicional); //Importe Adicionales Nuevos
										lCuotaTotal = (lCuotaClub + lCuota) * iNumMeses + lImporteAdicionalesNuevos; //Para saber el total a pagar de los seguros del cliente

										//Para imprimir la cuota por mes de los seguros.
										//La cuota de los seguros adicionales nuevos se divide entre el total de meses para obtener la cuota por mes
										usingx("###,###", cTexto, (double)(lCuotaNuevos + lCuotaClub + lCuota)); //Para mostrar la cuota total por mes de los seguros
										m_grid.QuickSetText(i, 16, cTexto);
										m_grid.QuickSetAlignment(i, 16, UG_ALIGNCENTER);

										usingx("#####", cTexto, (double)lCuotaTotal); //Para mostrar el total a pagar de los seguros

										m_grid.QuickSetText(i, 21, cTexto);
										m_grid.QuickSetAlignment(i, 21, UG_ALIGNRIGHT);
										m_grid.RedrawAll();
										m_grid.obtenerTotalAbono();
									}
								}
								else
								{
									AfxMessageBox(" Error al cargar el programa CA0149.DLL ");
								}
							}
						}
						else {
							//se agrego else
							if (iFlagMsj == 0) {
								AfxMessageBox("CLIENTE NECESITA ABONAR A SU FOLIO CLUB DE PROTECCION FAMILIAR PARA ADQUIRIR SU CLUB ADICIONAL", MB_ICONINFORMATION);
							}
						}
						// }  final del else que valida a los clientes z
					}
				}
				else
				{
					AfxMessageBox("EL CLIENTE SOLO PUEDE TENER HASTA 10 SEGUROS ADICIONALES");
				}
			}
			else
			{
				AfxMessageBox("EL CLIENTE TITULAR, POR SU RANGO DE EDAD NO PUEDE COMPRAR SEGURO ADICIONAL");
			}
		}
		else
		{
			AfxMessageBox(cMensajeSeguro);
		}
	}
	else
	{
		AfxMessageBox("TIENDA NO AUTORIZADA PARA VENTA DE CLUB ADICIONAL");
	}
}

//Para obtener los meses y dias que faltan para el vencimiento del seguro y calcular los meses que se cobraran del seguro adicional
void CDlgCapturarAbono::consultarCrSegurosFechaMesVence()
{
	char cLog[500] = { 0 };
	long lMesesSeguro = 0L, lDiasSeguro = 0L;
	char cSql[360] = { 0 }, cFechaActual[12] = { 0 };

	sprintf_s(cLog, "FC0200805021521940 - entra - consultarCrSegurosFechaMesVence");
	grabarLog(cLog);

	sprintf_s(cFechaActual, "%04d-%02d-%02d", iAnioActual, iMesActual, iDiaActual);

	sprintf_s(cSql, "SELECT DATE_PART('years',AGE(fechavencimiento,'%s'))*12 + DATE_PART('MONTH', AGE(fechavencimiento,'%s')) AS meses, DATE_PART('DAYS', AGE(fechavencimiento,'%s')) AS dias,fechavencimiento FROM crseguros WHERE claveseguro = 'C' "
		"AND cliente = %ld AND statusseguro='A' AND tiposeguro IN (0,1) ORDER BY fechavencimiento", cFechaActual, cFechaActual, cFechaActual, m_grid.lCliente);

	CConsultarCrSegurosFechaMesDiaVence crSegurosSQL(&odbc_1);
	if (crSegurosSQL.Exec(cSql))
	{
		crSegurosSQL.activarCols();
		if (crSegurosSQL.Leer())
		{
			lMesesSeguro = crSegurosSQL.meses; //Meses para la fecha de vencimiento
			lDiasSeguro = crSegurosSQL.dias; //Dias para la fecha de vencimiento

			if (lMesesSeguro >= 0 && lDiasSeguro >= 0) //Para asegurarse que el seguro no esta vencido
			{
				if (lMesesSeguro == 0) //Si falta menos de 1 mes para la fecha de vencimiento
				{
					if (lDiasSeguro > 29) //Si faltan mas de 29 dias se le cobra un mes mas al cliente
					{
						iNumMesesAdicional += 1;
					}
				}
				else
				{
					if (lDiasSeguro <= 29) //Si faltan menos de 30 dias 
					{
						iNumMesesAdicional = iNumMesesAdicional + (short)lMesesSeguro; //Se cobran los meses que compro el cliente + los meses que faltan para la fecha de vencimiento
					}
					else
					{
						//Se cobran los meses que compro el cliente + los meses que faltan para la fecha de vencimiento + 1 mes
						iNumMesesAdicional = iNumMesesAdicional + (short)lMesesSeguro + 1;
					}
				}
			}
		}
	}
	else
	{
		crSegurosSQL.odbc->GetLastError(crSegurosSQL.GetHstmt());
		grabarMensajeError("C", m_grid.iCaja, (LPTSTR)(LPCTSTR)m_grid.sServer, "CA0030", "CDlgCapturarAbono", "consultarCrSegurosFechaMesVence", cSql, m_grid.lEmpleado, "ERROR #10159", crSegurosSQL.odbc, m_grid.iMuestraMsg);
	}
}

bool CDlgCapturarAbono::consultarCrSegurosFechaVenceTit()
{
	char cLog[500] = { 0 };
	long lMesesSeguro = 0L, lDiasSeguro = 0L;
	bool bContinuar = true;
	char cSql[355] = { 0 }, cFechaActual[12] = { 0 };

	sprintf_s(cLog, "FC0200805021521944 - entra - consultarCrSegurosFechaVenceTit");
	grabarLog(cLog);

	sprintf_s(cFechaActual, "%04d-%02d-%02d", iAnioActual, iMesActual, iDiaActual);

	sprintf_s(cSql, "SELECT DATE_PART('YEARS',AGE(fechavencimiento,'%s'))*12 + DATE_PART('MONTH', AGE(fechavencimiento,'%s')) AS meses, DATE_PART('DAYS', AGE(fechavencimiento,'%s')) AS dias,fechavencimiento FROM crseguros WHERE claveseguro = 'C' "
		"AND cliente = %ld AND statusseguro='A' AND tiposeguro IN (0,1) ORDER BY fechavencimiento", cFechaActual, cFechaActual, cFechaActual, m_grid.lCliente);

	CConsultarCrSegurosFechaMesDiaVence crSegurosSQL(&odbc_1);
	if (crSegurosSQL.Exec(cSql))
	{
		crSegurosSQL.activarCols();
		if (crSegurosSQL.Leer())
		{
			lMesesSeguro = crSegurosSQL.meses; //Meses para la fecha de vencimiento
			lDiasSeguro = crSegurosSQL.dias; //Dias para la fecha de vencimiento

			if (lMesesSeguro >= 0 && lDiasSeguro >= 0) //Para asegurarse que el seguro no esta vencido
			{
				if (lMesesSeguro < 2)
				{
					bContinuar = false;
				}
				else if (lMesesSeguro == 2 && lDiasSeguro == 0)
				{
					bContinuar = false;
				}
			}
		}
	}
	else
	{
		crSegurosSQL.odbc->GetLastError(crSegurosSQL.GetHstmt());
		grabarMensajeError("C", m_grid.iCaja, (LPTSTR)(LPCTSTR)m_grid.sServer, "CA0030", "CDlgCapturarAbono", "consultarCrSegurosFechaMesVence", cSql, m_grid.lEmpleado, "ERROR #10159", crSegurosSQL.odbc, m_grid.iMuestraMsg);
	}
	return bContinuar;
}

/*Para obtener el importe de los seguros adicionales, si la variable bNuevos es true entonces obtiene la suma del importe
de los seguros adicionales nuevos(folio=0), si la variable bNuevos es false entonces obtiene la suma del importe de los
seguros adicionales que ya tenia el cliente(folio<>0).
Los folios igual a 0 tienen el importe total a cobrar y los folios diferentes de 0 tienen el importe a cobrar por mes*/
int CDlgCapturarAbono::consultarCuotaAdicionales(bool bNuevos)
{
	char cLog[500] = { 0 };
	int iRegresa;
	char cSql[160] = { 0 };

	sprintf_s(cLog, "FC0200805021521947 - entra - consultarCuotaAdicionales");
	grabarLog(cLog);

	CMaximo consultarImporteAdicionales(&odbc);

	grabarLog("consultarCuotaAdicionales:Consulta Importe Adicionales");

	if (bNuevos)
		sprintf_s(cSql, "SELECT COALESCE(SUM(importe),0) FROM tmpcacarmovseguros WHERE cliente = %ld AND clave = 'G' AND tienda= %d AND caja = %d AND folio=0;", m_grid.lCliente, m_grid.iTienda, m_grid.iCaja);
	else
		sprintf_s(cSql, "SELECT COALESCE(SUM(importe),0) FROM tmpcacarmovseguros WHERE cliente = %ld AND clave = 'G' AND tienda= %d AND caja = %d AND folio<>0;", m_grid.lCliente, m_grid.iTienda, m_grid.iCaja);

	if (consultarImporteAdicionales.Exec(cSql))
	{
		consultarImporteAdicionales.activarCols();
		if (consultarImporteAdicionales.leer())
		{
			iRegresa = consultarImporteAdicionales.Total;
		}
	}
	else
	{
		consultarImporteAdicionales.odbc->GetLastError(consultarImporteAdicionales.GetHstmt());
		grabarMensajeError("C", m_grid.iCaja, (LPTSTR)(LPCTSTR)m_grid.sServer, "CA0030", "CDlgCapturarAbono", "consultarCuotaAdicionales", cSql, m_grid.lEmpleado, "ERROR #10206", consultarImporteAdicionales.odbc, m_grid.iMuestraMsg);
	}
	return iRegresa;
}

int CDlgCapturarAbono::consultarCuotaAdicionalesPS()
{
	char cLog[500] = { 0 };
	int iRegresa;
	char cSql[160] = { 0 };

	sprintf_s(cLog, "FC0200805021521951 - entra - consultarCuotaAdicionalesPS");
	grabarLog(cLog);

	CMaximo consultarImporteAdicionales(&odbc);

	sprintf_s(cSql, "SELECT COALESCE(SUM(importe),0) FROM tmpcacarmovseguros WHERE cliente = %ld AND clave = '2' AND tienda= %d AND caja = %d;", m_grid.lCliente, m_grid.iTienda, m_grid.iCaja);

	if (consultarImporteAdicionales.Exec(cSql))
	{
		consultarImporteAdicionales.activarCols();
		if (consultarImporteAdicionales.leer())
		{
			iRegresa = consultarImporteAdicionales.Total;
		}
	}
	else
	{
		consultarImporteAdicionales.odbc->GetLastError(consultarImporteAdicionales.GetHstmt());
		grabarMensajeError("C", m_grid.iCaja, (LPTSTR)(LPCTSTR)m_grid.sServer, "CA0030", "CDlgCapturarAbono", "consultarCuotaAdicionalesPS", cSql, m_grid.lEmpleado, "ERROR #10206", consultarImporteAdicionales.odbc, m_grid.iMuestraMsg);
	}
	return iRegresa;
}

//Para guardar los movimientos de los seguros adicionales en la tabla tmpabonocrseguros
bool CDlgCapturarAbono::grabarTemporalCarteraSeguroAdicional(CGrabarTmpAbonoCrSegurosFija01 &tmpCrSeguros)
{
	char cLog[500] = { 0 };
	char cSql[310] = { 0 };
	bool bRegresa = true;
	short iConsecutivoSeguro = 0;

	sprintf_s(cLog, "FC0200805021521955 - entra - grabarTemporalCarteraSeguroAdicional");
	grabarLog(cLog);

	sprintf_s(cSql, "SELECT clave,tienda,caja,cliente,folio,cantidadseguros,cantidadsegurosanterior,importe,nombreadicional,apellidopaternoadic,apellidomaternoadic,fecnacadic,parentescoadic,respuesta FROM tmpcacarmovseguros WHERE cliente = %ld and clave = 'G' and tienda= %d and caja = %d order by consecutivo;", m_grid.lCliente, m_grid.iTienda, m_grid.iCaja);

	CGrabarTmpCaCarmovSeguro caCarmovSeguros(&odbc);
	if (caCarmovSeguros.Exec(cSql))
	{
		caCarmovSeguros.activarCols();
		while (caCarmovSeguros.Leer())
		{
			iConsecutivoSeguro++;
			tmpCrSeguros.cantidadseguros = caCarmovSeguros.cantidadseguros;
			tmpCrSeguros.folio = caCarmovSeguros.folio; //Folio del seguro adicional, si es 0 significa que es un seguro nuevo
			sprintf_s(tmpCrSeguros.nombreadicional, caCarmovSeguros.nombreadicional);
			sprintf_s(tmpCrSeguros.apellidopaternoadic, caCarmovSeguros.apellidopaternoadic);
			sprintf_s(tmpCrSeguros.apellidomaternoadic, caCarmovSeguros.apellidomaternoadic);
			tmpCrSeguros.fecnacadic = caCarmovSeguros.fecnacadic;
			tmpCrSeguros.parentescoadic = caCarmovSeguros.parentescoadic;
			tmpCrSeguros.consecutivoseguro = iConsecutivoSeguro; //Para saber que registro se debe tomar al momento de guardar en la tabla crseguros
			if (!tmpCrSeguros.Insert())
			{
				bRegresa = false;
				break;
			}
		}
	}
	else
	{
		bRegresa = false;
		tmpCrSeguros.odbc->GetLastError(tmpCrSeguros.GetHstmt());
		grabarMensajeError("C", m_grid.iCaja, (LPTSTR)(LPCTSTR)m_grid.sServer, "CA0030", "CDlgCapturarAbono", "grabarTemporalCarteraSeguroAdicional", cSql, m_grid.lEmpleado, "ERROR #10161", tmpCrSeguros.odbc, m_grid.iMuestraMsg);
	}
	return bRegresa;
}

//Para borrar los registros del cliente de las tablas temporales fijas tmpcacarmovseguros y temptdbeneficiarios al momento de desplegar las cuentas del cliente
bool CDlgCapturarAbono::borrarTemporalesSeguroAdicional(bool bBorrar)
{
	char cLog[500] = { 0 };
	bool bRegresa = true;

	sprintf_s(cLog, "FC0200805021521959 - entra - borrarTemporalesSeguroAdicional");
	grabarLog(cLog);

	grabarLog("borrarTemporalesSeguroAdicional: tmpcacarmovseguros y temptdbeneficiarios");

	if (iColumnaClub == -1 || bBorrar)
	{
		char cSql[150] = { 0 };

		CGrabarTmpCaCarmovSeguro tmpcaCarmovSeguros(&odbc);

		sprintf_s(cSql, "DELETE FROM tmpcacarmovseguros WHERE cliente = %ld AND clave='G' AND tienda=%d AND caja=%d;", m_grid.lCliente, m_grid.iTienda, m_grid.iCaja);

		if (!tmpcaCarmovSeguros.Exec(cSql))
		{
			bRegresa = false;
			tmpcaCarmovSeguros.odbc->GetLastError(tmpcaCarmovSeguros.GetHstmt());
			grabarMensajeError("C", m_grid.iCaja, (LPTSTR)(LPCTSTR)m_grid.sServer, "CA0030", "CDlgCapturarAbono", "borrarTemporalesSeguroAdicional", cSql, m_grid.lEmpleado, "ERROR #10208", tmpcaCarmovSeguros.odbc, m_grid.iMuestraMsg);
		}

		tmpcaCarmovSeguros.ClearResults();
		tmpcaCarmovSeguros.ClearStatement();

		sprintf_s(cSql, "DELETE FROM temptdbeneficiarios WHERE cliente = %ld AND tienda=%d AND caja=%d AND fecha='%04d-%02d-%02d' AND tiposeguro='2';", m_grid.lCliente, m_grid.iTienda, m_grid.iCaja, iAnioActual, iMesActual, iDiaActual);

		if (!tmpcaCarmovSeguros.Exec(cSql))
		{
			bRegresa = false;
			tmpcaCarmovSeguros.odbc->GetLastError(tmpcaCarmovSeguros.GetHstmt());
			grabarMensajeError("C", m_grid.iCaja, (LPTSTR)(LPCTSTR)m_grid.sServer, "CA0030", "CDlgCapturarAbono", "borrarTemporalesSeguroAdicional", cSql, m_grid.lEmpleado, "ERROR #10209", tmpcaCarmovSeguros.odbc, m_grid.iMuestraMsg);
		}
	}
	return bRegresa;
}

//Para guardar los seguros adicionales que tiene el cliente en la tabla tmpcacarmovseguros al momento de desplegar las cuentas del cliente
bool CDlgCapturarAbono::grabarTmpCacarMovSeguros()
{
	char cLog[500] = { 0 };
	bool bRegresa = true;
	int iEdadAdicional = 0;
	long lCuotaAdicional = 0;
	short iMaximoSeguros = 0, iConsecutivo = 0;
	char cSql[355] = {0}, cFechaVencimientoAdicional[12] = { 0 }, cFechaTienda[12] = { 0 };
	bool bSeguroAdicionalVigente = false;

	sprintf_s(cLog, "FC0200805021521964 - entra - grabarTmpCacarMovSeguros");
	grabarLog(cLog);

	grabarLog("grabarTmpCacarMovSeguros: tmpcacarmovseguros");

	sprintf_s(cSql, "SELECT folio,cantidadseguros,trim(nombreadicional) as nombreadicional,trim(apellidopaternoadic) as apellidopaternoadic,trim(apellidomaternoadic) as apellidomaternoadic,fecnacadic,parentescoadic, fechavencimiento FROM crseguros WHERE cliente = %ld and tiposeguro=2 and claveconyugal = 1 and claveseguro='C' and statusseguro='A' order by folio;", m_grid.lCliente);

	CConsultarCrSegurosClubAdicional crSegurosSQL(&odbc_1);
	if (crSegurosSQL.Exec(cSql)) //Se obtienen los seguros adicionales del cliente
	{
		CGrabarTmpCaCarmovSeguro tmpcaCarmovSeguros(&odbc);

		sprintf_s(tmpcaCarmovSeguros.clave, "G"); //Para saber que es un seguro
		tmpcaCarmovSeguros.tienda = (short)m_grid.iTienda;
		tmpcaCarmovSeguros.caja = (short)m_grid.iCaja;
		tmpcaCarmovSeguros.cliente = m_grid.lCliente;
		tmpcaCarmovSeguros.cantidadsegurosanterior = 0;
		tmpcaCarmovSeguros.respuesta = 0;

		tmpcaCarmovSeguros.prepararInsert("tmpcacarmovseguros");

		crSegurosSQL.activarCols();
		while (crSegurosSQL.Leer())
		{
			bSeguroAdicionalVigente = false;
			tmpcaCarmovSeguros.cantidadsegurosanterior = crSegurosSQL.cantidadseguros;
			//Se calcula la edad del adicional
			iEdadAdicional = (int)iAnioActual - crSegurosSQL.fecnacadic.ano();
			if (iMesActual < crSegurosSQL.fecnacadic.mes() || (iMesActual == crSegurosSQL.fecnacadic.mes() && iDiaActual < crSegurosSQL.fecnacadic.dia()))
			{
				iEdadAdicional--;
			}

			sprintf_s(cFechaVencimientoAdicional, "%04d%02d%02d", crSegurosSQL.fechavencimiento.ano(), crSegurosSQL.fechavencimiento.mes(), crSegurosSQL.fechavencimiento.dia());
			sprintf_s(cFechaTienda, "%04d%02d%02d", iAnioActual, iMesActual, iDiaActual);

			if (atoi(cFechaVencimientoAdicional) >= atoi(cFechaTienda))
			{
				bSeguroAdicionalVigente = true;
			}

			if ((iEdadAdicional <= iEdadMaximaAbonoClubAdic && bSeguroAdicionalVigente) || (!bSeguroAdicionalVigente && iEdadAdicional <= iEdadMaximaClubAdicional))
			{
				iConsecutivo++;

				//Se consulta cuanto es el maximo de seguros que puede tener el seguro adicional
				consultarMaximoSegurosClubAdicional(iMaximoSeguros, crSegurosSQL.cantidadseguros, 2, (short)iEdadAdicional); // si es plan salud consultar dato respectivo
				if (iMaximoSeguros < crSegurosSQL.cantidadseguros)
				{
					tmpcaCarmovSeguros.cantidadseguros = iMaximoSeguros;
				}
				else
				{
					tmpcaCarmovSeguros.cantidadseguros = crSegurosSQL.cantidadseguros;
				}

				sprintf_s(tmpcaCarmovSeguros.nombreadicional, crSegurosSQL.nombreadicional);
				sprintf_s(tmpcaCarmovSeguros.apellidopaternoadic, crSegurosSQL.apellidopaternoadic);
				sprintf_s(tmpcaCarmovSeguros.apellidomaternoadic, crSegurosSQL.apellidomaternoadic);
				tmpcaCarmovSeguros.folio = crSegurosSQL.folio;
				tmpcaCarmovSeguros.fecnacadic = crSegurosSQL.fecnacadic;
				tmpcaCarmovSeguros.parentescoadic = crSegurosSQL.parentescoadic;
				tmpcaCarmovSeguros.consecutivo = iConsecutivo; //Consecutivo para saber que registro actualizar al guardar

				grabarLog("Consulta Precio seguro 11");
				consultarPrecioSeguroClub(lCuotaAdicional, tmpcaCarmovSeguros.cantidadseguros, 2, (short)iEdadAdicional); // si es plan salud consultar dato respectivo

				tmpcaCarmovSeguros.importe = (int)lCuotaAdicional; //importe a cobrar por mes

				iFoliosSegurosActual[iConsecutivo] = (int)tmpcaCarmovSeguros.folio;

				if (!tmpcaCarmovSeguros.Insert())
				{
					bRegresa = false;
					break;
				}
			}
		}
		if (bRegresa && iConsecutivo > 0)
		{
			tmpcaCarmovSeguros.Commit();

			iSegurosAdicionales = iConsecutivo;
		}
	}
	else
	{
		bRegresa = false;
		crSegurosSQL.odbc->GetLastError(crSegurosSQL.GetHstmt());
		grabarMensajeError("C", m_grid.iCaja, (LPTSTR)(LPCTSTR)m_grid.sServer, "CA0030", "CDlgCapturarAbono", "grabarTmpCacarMovSeguros", cSql, m_grid.lEmpleado, "ERROR #10162", crSegurosSQL.odbc, m_grid.iMuestraMsg);
	}
	return bRegresa;
}

//Para obtener los datos de los beneficiarios del seguro adicional solicitado
bool CDlgCapturarAbono::obtenerDatosBeneficiarioAdicional(int iFolioAdicional)
{
	char cLog[500] = { 0 };
	char cSql[410] = { 0 };
	bool valorRegresa = false;

	sprintf_s(cLog, "FC0200805021521967 - entra - obtenerDatosBeneficiarioAdicional");
	grabarLog(cLog);

	CObtenerDatosTdBeneficiariosClub obtenerDatosBeneficiarios(&odbc);
	sprintf_s(cSql, "SELECT folio,cliente,nombreasegurado,nombre1,apellidopaterno1,apellidomaterno1, nombre2,apellidopaterno2,apellidomaterno2,nombre3,apellidopaterno3,apellidomaterno3,porcentaje1,porcentaje2,porcentaje3,parentesco1,parentesco2,parentesco3,nombreconyuge,nombre4,apellidopaterno4,apellidomaterno4,porcentaje4,parentesco4 FROM tdBeneficiarios WHERE cliente = %ld AND tiposeguro='2' AND folio=%d", m_grid.lCliente, iFolioAdicional);

	if (!obtenerDatosBeneficiarios.Exec(cSql))
	{
		//Se obtiene el error
		obtenerDatosBeneficiarios.odbc->GetLastError(obtenerDatosBeneficiarios.GetHstmt());
		grabarMensajeError("C", m_grid.iCaja, (LPTSTR)(LPCTSTR)m_grid.sServer, "CA0030", "CDlgCapturarAbono", "obtenerDatosBeneficiarioAdicional", cSql, m_grid.lEmpleado, "ERROR #10163", obtenerDatosBeneficiarios.odbc, m_grid.iMuestraMsg);
	}
	else
	{
		obtenerDatosBeneficiarios.activarCols();
		if (obtenerDatosBeneficiarios.Leer())
		{
			memcpy(cNombreAsegurado, obtenerDatosBeneficiarios.nombreasegurado, 32);
			cNombreAsegurado[32] = 0;
			memcpy(cNombreBeneficiario1, obtenerDatosBeneficiarios.nombre1, 15);
			cNombreBeneficiario1[15] = 0;

			memcpy(cApPatBeneficiario1, obtenerDatosBeneficiarios.apellidopaterno1, 15);
			cApPatBeneficiario1[15] = 0;

			memcpy(cApMatBeneficiario1, obtenerDatosBeneficiarios.apellidomaterno1, 15);
			cApMatBeneficiario1[15] = 0;

			memcpy(cNombreBeneficiario2, obtenerDatosBeneficiarios.nombre2, 15);
			cNombreBeneficiario2[15] = 0;

			memcpy(cApPatBeneficiario2, obtenerDatosBeneficiarios.apellidopaterno2, 15);
			cApPatBeneficiario2[15] = 0;

			memcpy(cApMatBeneficiario2, obtenerDatosBeneficiarios.apellidomaterno2, 15);
			cApMatBeneficiario2[15] = 0;

			memcpy(cNombreBeneficiario3, obtenerDatosBeneficiarios.nombre3, 15);
			cNombreBeneficiario3[15] = 0;

			memcpy(cApPatBeneficiario3, obtenerDatosBeneficiarios.apellidopaterno3, 15);
			cApPatBeneficiario3[15] = 0;

			memcpy(cApMatBeneficiario3, obtenerDatosBeneficiarios.apellidomaterno3, 15);
			cApMatBeneficiario3[15] = 0;

			memcpy(cNombreConyuge, obtenerDatosBeneficiarios.nombreconyuge, 32);
			cNombreConyuge[32] = 0;

			memcpy(cNombreBeneficiario4, obtenerDatosBeneficiarios.nombre4, 15);
			cNombreBeneficiario4[15] = 0;

			memcpy(cApPatBeneficiario4, obtenerDatosBeneficiarios.apellidopaterno4, 15);
			cApPatBeneficiario4[15] = 0;

			memcpy(cApMatBeneficiario4, obtenerDatosBeneficiarios.apellidomaterno4, 15);
			cApMatBeneficiario4[15] = 0;

			iPorcentaje1 = obtenerDatosBeneficiarios.porcentaje1;
			iPorcentaje2 = obtenerDatosBeneficiarios.porcentaje2;
			iPorcentaje3 = obtenerDatosBeneficiarios.porcentaje3;
			iPorcentaje4 = obtenerDatosBeneficiarios.porcentaje4;
			iParentesco1 = obtenerDatosBeneficiarios.parentesco1;
			iParentesco2 = obtenerDatosBeneficiarios.parentesco2;
			iParentesco3 = obtenerDatosBeneficiarios.parentesco3;
			iParentesco4 = obtenerDatosBeneficiarios.parentesco4;
			valorRegresa = true;
		}
	}
	return valorRegresa;
}

//Para obtener la respuesta que se le da a la poliza del seguro adicional
short CDlgCapturarAbono::obtenerRespuestaPolizaAdicional(short iConsecutivo)
{
	char cLog[500] = { 0 };
	short iRegresa = 0;
	char cSql[170] = { 0 };

	sprintf_s(cLog, "FC0200805021521971 - entra - obtenerRespuestaPolizaAdicional");
	grabarLog(cLog);

	CMaximo consultarPoliza(&odbc);

	sprintf_s(cSql, "SELECT respuesta FROM tmpcacarmovseguros WHERE cliente = %ld AND clave = 'G' AND tienda= %d AND caja = %d AND folio=0 AND consecutivo=%d;", m_grid.lCliente, m_grid.iTienda, m_grid.iCaja, iConsecutivo);

	if (consultarPoliza.Exec(cSql))
	{
		consultarPoliza.activarCols();
		consultarPoliza.leer();
		iRegresa = (short)consultarPoliza.Total;
	}
	else
	{
		consultarPoliza.odbc->GetLastError(consultarPoliza.GetHstmt());
		grabarMensajeError("C", m_grid.iCaja, (LPTSTR)(LPCTSTR)m_grid.sServer, "CA0030", "CDlgCapturarAbono", "obtenerRespuestaPolizaAdicional", cSql, m_grid.lEmpleado, "ERROR #10207", consultarPoliza.odbc, m_grid.iMuestraMsg);
	}
	return iRegresa;
}

//Para imprimir las polizas de los seguros adicionales nuevos
bool CDlgCapturarAbono::imprimirPolizaSeguroClubAdicional(int iFlagImpresoraTermica)
{
	char cLog[500] = { 0 };
	char cTexto[80] = { 0 }, cValorParentesco[5] = { 0 }, cNombreAdicional[17] = { 0 }, cApellidoPaternoAdicional[17] = { 0 }, cApellidoMaternoAdicional[17] = { 0 },
		cConsulta[600] = { 0 }, cTextoOut[256] = { 0 }, cNombreCalle[35], cNombreZona[35], cComa[4] = { 0 };
	int iCol = 1, iRen = 0, iFolioAdicional = 0, iParentescoAdic = 0;
	short iCantidadSeguros = 0, iRespuesta = 0, iEdadAdicional = 0, iAnioNacimientoAdicional = 0, iMesNacimientoAdicional = 0, iDiaNacimientoAdicional = 0, iConsecutivo = 0, iCambioPlan = 0;
	long lMontoClub = 0L;
	bool valorRegresa = false, bContinuar = false;

	CString sDato = "", sFolios = "";
	char cDirectorio[80] = { 0 };

	sprintf_s(cLog, "FC0200805021521975 - entra - imprimirPolizaSeguroClubAdicional");
	grabarLog(cLog);

	sprintf_s(cComa, ", ");

	for (int i = 1; i < 16; i++)
	{
		if (iFoliosSegurosAdicionales[i] == 0)
		{
			break;
		}
		else if (iFoliosSegurosActual[i] != iFoliosSegurosAdicionales[i])
		{
			if (bContinuar)
			{
				sFolios.Append(cComa);
			}
			sprintf_s(cPoliza, "%d", iFoliosSegurosAdicionales[i]);

			sFolios.Append(cPoliza);
			bContinuar = true;
		}
	}

	if (bContinuar)
	{
		char cSql[500] = { 0 };

		sprintf_s(cSql, "SELECT folio,cantidadseguros,TRIM(nombreadicional) AS nombreadicional,TRIM(apellidopaternoadic) AS apellidopaternoadic,TRIM(apellidomaternoadic) AS apellidomaternoadic,fecnacadic,parentescoadic FROM crseguros WHERE cliente = %ld AND tiposeguro=2 AND claveconyugal = 1 AND claveseguro='C' AND statusseguro='A' AND folio IN (%s) ORDER BY folio;", m_grid.lCliente, sFolios);

		CConsultarCrSegurosClubAdicional crSegurosSQL(&odbc_1);
		if (crSegurosSQL.Exec(cSql)) //Se obtienen todos los folios de los seguros adicionales nuevos
		{
			crSegurosSQL.activarCols();
			while (crSegurosSQL.Leer())
			{
				iCantidadSeguros = (short)crSegurosSQL.cantidadseguros;
				sprintf_s(cNombreAdicional, crSegurosSQL.nombreadicional);
				sprintf_s(cApellidoPaternoAdicional, crSegurosSQL.apellidopaternoadic);
				sprintf_s(cApellidoMaternoAdicional, crSegurosSQL.apellidomaternoadic);

				iFolioAdicional = crSegurosSQL.folio;

				iAnioNacimientoAdicional = (short)crSegurosSQL.fecnacadic.ano();
				iMesNacimientoAdicional = (short)crSegurosSQL.fecnacadic.mes();
				iDiaNacimientoAdicional = (short)crSegurosSQL.fecnacadic.dia();

				iParentescoAdic = crSegurosSQL.parentescoadic;

				iCambioPlan = 0;

				for (short i = 1; i < 16; i++)
				{
					if (iFoliosSegurosAdicionales[i] == 0)
					{
						break;
					}
					else if (iFolioAdicional == iFoliosSegurosAdicionales[i])
					{

						if (iFoliosSegurosActual[i] != iFoliosSegurosAdicionales[i])
						{
							//Si es seguro nuevo
							if (iFoliosSegurosActual[i] == 0)
							{
								iRespuesta = obtenerRespuestaPolizaAdicional(i);
							}
							else
							{
								iCambioPlan = 1;
								iRespuesta = 0;
							}
						}

						break;
					}
				}

				//Se calcula la edad del adicional
				iEdadAdicional = iAnioActual - iAnioNacimientoAdicional;
				if (iMesActual < iMesNacimientoAdicional || (iMesActual == iMesNacimientoAdicional && iDiaActual < iDiaNacimientoAdicional))
				{
					iEdadAdicional--;
				}

				if (iFlagImpresoraTermica == 1)
				{
					imprimirPolizaSeguroClubTermica((long)iFolioAdicional, iCantidadSeguros, 2, iRespuesta, iEdadAdicional, iCambioPlan);
				}
				else
				{
					for (int i = 0; i < 2; i++)//Para imprimir 2 copias, una para el cliente y otra para publicidad
					{
						//Activar
						sprintf_s(cDirectorio, "c:\\sys\\mem\\PolizaClub.PRN");
						_unlink(cDirectorio);
						C_FormasPCL hoja(22, 270, cDirectorio, iFinLinea, iTipoImpresora, 1);

						if (imprimirClausulaClub(hoja, iConyugal, iRespuesta))
						{
							obtenerDatosBeneficiarioAdicional(iFolioAdicional);

							iniciarHoja(hoja);
							iRen = 3;
							memset(cTexto, 0, 80);
							hoja.poner("Nombre del contratante: COPPEL S.A. DE C.V.", iRen, iCol);
							iRen++;
							sprintf_s(cTexto, "Num.de póliza: %s %s", cPoliza, cFechaVigencia);
							hoja.poner(cTexto, iRen, iCol);
							iRen++;

							miniFecha(cTexto, iDiaActual, iMesActual, iAnioActual);

							memset(cTexto, 0, 80);
							obtenerMes(iMesActual, cNomMes);

							sprintf_s(cTexto, "Vigencia:%02d/%s/%02d al     /   /     ", iDiaActual, cNomMes, iAnioActual);
							hoja.poner(cTexto, iRen, iCol);
							iRen++;

							memset(cConsulta, 0, sizeof(cConsulta));
							sprintf_s(cConsulta, "SELECT catMod.idu_modulopolizaclub, catMsg.idu_mensajepolizaclub, catMsg.desc_mensaje"
								" FROM cat_modulospolizaclub catMod"
								" INNER JOIN cat_mensajespolizaclub catMsg ON catMod.idu_modulopolizaclub = catMsg.idu_modulopolizaclub"
								" AND catMod.idu_tipoImpresion = catMsg.idu_tipoImpresion AND catMod.nom_area = catMsg.nom_area"
								" WHERE catMod.idu_modulopolizaclub IN (%d) AND catMod.idu_tipoImpresion = %d AND catMod.nom_area = 'C'"
								" ORDER BY catMod.idu_modulopolizaclub ASC, catMsg.idu_mensajepolizaclub ASC;", SECCION_6, MATRICIAL);

							CConsultarDescripcionClub ConsultaDescImpresion(&odbc);

							if (ConsultaDescImpresion.Exec(cConsulta))
							{
								ConsultaDescImpresion.activarCols();
								while (ConsultaDescImpresion.leer())
								{
									memset(cTextoOut, 0, sizeof(cTextoOut));
									sDato.Format("%s", ConsultaDescImpresion.desc_mensaje);
									sDato.Trim();
									sDato.Replace('¿', '¨');
									sprintf_s(cTextoOut, "%s", (LPCTSTR)sDato);
									ponerAcento(cTextoOut);
									hoja.poner(cTextoOut, iRen, iCol);
									iRen++;
									bContinuar = true;
								}
							}
							else
							{
								ConsultaDescImpresion.odbc->GetLastError(ConsultaDescImpresion.GetHstmt());
								grabarMensajeError("C", m_grid.iCaja, (LPTSTR)(LPCTSTR)m_grid.sServer, "CA0030", "CDlgCapturarAbono", "imprimirNotaImportante", cConsulta, m_grid.lEmpleado, "ERROR AL OBTENER IMPRESION", ConsultaDescImpresion.odbc, m_grid.iMuestraMsg);
								bContinuar = false;
							}
							if (bContinuar)
							{
								hoja.poner("Datos del asegurado:", iRen, iCol);
								iRen = iRen + 2;

								hoja.poner("Ap.Pat.         Ap.Mat.         Nombre(s)       PARENT:", 8, iCol);

								hoja.poner(cApellidoPaternoAdicional, iRen, iCol);
								hoja.poner(cApellidoMaternoAdicional, iRen, iCol + 16);
								hoja.poner(cNombreAdicional, iRen, iCol + 32);

								if (iParentescoAdic == 1)
								{
									sprintf_s(cTexto, "CONYUGE");
								}
								else
								{
									sprintf_s(cTexto, "HIJO(A)");
								}

								hoja.poner(cTexto, iRen, iCol + 48);

								memset(cTexto, 0, 80); //cliente-folio
								sprintf_s(cTexto, "%08ld%1d-%06ld", m_grid.lCliente / 10L, (int)calcular_digito(m_grid.lCliente / 10L), iFolioAdicional);
								hoja.poner(cTexto, iRen, 58 + iCol);
								iRen = iRen + 3;

								hoja.poner("Domicilio:(calle, numero, col, dlg ó mpio, estado, cp.)", iRen, iCol);
								iRen++;
								datosDeCliente(iCasa, iColonia, iCalle, iCiudad, lCodigoPostal, cNombreCalle, cNombreZona, cNombreCiudad);
								memset(cTexto, ' ', 80);
								sprintf_s(cTexto, "%s", cNombreCalle);
								cTexto[12] = 0;
								hoja.poner(cTexto, 12, iRen, iCol);
								hoja.poner(", ", iRen, iCol + 13);

								memset(cTexto, ' ', 80);
								sprintf_s(cTexto, "%06ld", iCasa);
								hoja.poner(cTexto, iRen, iCol + 15);
								hoja.poner(", ", iRen, iCol + 21);

								memset(cTexto, ' ', 80);
								sprintf_s(cTexto, "%s", cNombreZona);
								cTexto[12] = 0;
								hoja.poner(cTexto, 12, iRen, iCol + 23);
								hoja.poner(", ", iRen, iCol + 35);

								memset(cTexto, ' ', 80);
								sprintf_s(cTexto, "%s", cNombreCiudad);
								cTexto[12] = 0;
								hoja.poner(cTexto, 12, iRen, iCol + 37);
								hoja.poner(", ", iRen, iCol + 49);

								memset(cTexto, ' ', 80);
								sprintf_s(cTexto, "%06ld", lCodigoPostal);
								hoja.poner(cTexto, iRen, iCol + 52);
								iRen++;

								obtenerMes(iMesNacimientoAdicional, cNomMes);
								sprintf_s(cTexto, "Fecha de Nacimiento:%02d/%s/%04d. Sexo: %c  Nacionalidad: M", iDiaNacimientoAdicional, cNomMes, iAnioNacimientoAdicional, cSexo);
								hoja.poner(cTexto, iRen, iCol);

								finHoja(hoja);
								iniciarHoja(hoja);

								memset(cTexto, ' ', 80);
								cOcupacion[20] = 0;
								sprintf_s(cTexto, "Ocupación: %s  Curp:  ", cOcupacion);
								hoja.poner(cTexto, 3, iCol);

								//se pinta e imprime monto asegurado.
								consultarMontoSeguroClub(lMontoClub, (short)iCantidadSeguros, 2, (short)iEdadAdicional);
								usingx("###,###", cMonto, (double)lMontoClub);
								sprintf_s(cTexto, "Cobertura contratada: Fallecimiento. Suma Asegurada:  $%s", cMonto);
								hoja.poner(cTexto, 4, iCol);

								hoja.poner("Designación de Beneficiarios:", 5, iCol);
								hoja.poner("Ap.Pat.        Ap.Mat.        Nombre(s)         PARENT:   PORC.", 6, iCol);

								hoja.poner(cApPatBeneficiario1, 15, 7, iCol);
								hoja.poner(cApMatBeneficiario1, 15, 7, iCol + 15);
								hoja.poner(cNombreBeneficiario1, 15, 7, iCol + 30);

								if (iPorcentaje1 > 0)
								{
									checarParentesco(cValorParentesco, iParentesco1);
									cValorParentesco[4] = 0;
									hoja.poner(cValorParentesco, 4, 7, 51);

									memset(cTexto, 0, 80);
									usingx("###", cTexto, (double)iPorcentaje1);
									cTexto[3] = 0;
									hoja.poner(cTexto, 3, 7, 60);
									hoja.poner("%", 1, 7, 63);
								}

								hoja.poner(cApPatBeneficiario2, 15, 8, iCol);
								hoja.poner(cApMatBeneficiario2, 15, 8, iCol + 15);
								hoja.poner(cNombreBeneficiario2, 15, 8, iCol + 30);

								if (iPorcentaje2 > 0)
								{
									checarParentesco(cValorParentesco, iParentesco2);
									cValorParentesco[4] = 0;
									hoja.poner(cValorParentesco, 4, 8, 51);

									memset(cTexto, 0, 80);
									usingx("###", cTexto, (double)iPorcentaje2);
									cTexto[3] = 0;
									hoja.poner(cTexto, 3, 8, 60);
									hoja.poner("%", 1, 8, 63);
								}

								hoja.poner(cApPatBeneficiario3, 15, 9, iCol);
								hoja.poner(cApMatBeneficiario3, 15, 9, iCol + 15);
								hoja.poner(cNombreBeneficiario3, 15, 9, iCol + 30);

								if (iPorcentaje3 > 0)
								{
									checarParentesco(cValorParentesco, iParentesco3);
									cValorParentesco[4] = 0;
									hoja.poner(cValorParentesco, 4, 9, 51);

									memset(cTexto, 0, 80);
									usingx("###", cTexto, (double)iPorcentaje3);
									cTexto[3] = 0;
									hoja.poner(cTexto, 3, 9, 60);
									hoja.poner("%", 1, 9, 63);
								}

								hoja.poner(cApPatBeneficiario4, 15, 10, iCol);
								hoja.poner(cApMatBeneficiario4, 15, 10, iCol + 15);
								hoja.poner(cNombreBeneficiario4, 15, 10, iCol + 30);

								if (iPorcentaje4 > 0)
								{
									checarParentesco(cValorParentesco, iParentesco4);
									cValorParentesco[4] = 0;
									hoja.poner(cValorParentesco, 4, 10, 51);
									memset(cTexto, 0, 80);
									usingx("###", cTexto, (double)iPorcentaje4);
									cTexto[3] = 0;
									hoja.poner(cTexto, 3, 10, 60);
									hoja.poner("%", 1, 10, 63);
								}

								hoja.poner("FECHA:", 11, iCol);
								memset(cTexto, 0, 80);
								miniFecha(cTexto, iDiaActual, iMesActual, iAnioActual);

								hoja.poner(cTexto, 7, 11, 8 + iCol);

								hoja.poner("_________________________________________", 12, 26 + iCol);
								hoja.poner("           Firma del Asegurado           ", 13, 26 + iCol);

								finHoja(hoja);

								if (imprimirNotaImportante(hoja, i))
								{
									impresionArchivo.imprimirArchivo(cDirectorio);
									if (i == 0)
									{
										procesoGrabarGnTira(iTipoImpresora);
									}
								}
							}
						}
					}
				}
				iConsecutivo++;
				valorRegresa = true;
			}
		}
		else
		{
			crSegurosSQL.odbc->GetLastError(crSegurosSQL.GetHstmt());
			grabarMensajeError("C", m_grid.iCaja, (LPTSTR)(LPCTSTR)m_grid.sServer, "CA0030", "CDlgCapturarAbono", "imprimirPolizaSeguroClubAdicional", cSql, m_grid.lEmpleado, "ERROR #10164", crSegurosSQL.odbc, m_grid.iMuestraMsg);
		}
	}
	return valorRegresa;
}

//Para imprimir los totales en el recibo cuando el cliente tenga seguro adicional y se pase del numero de renglones para la impresion
void CDlgCapturarAbono::imprimirTotalesAdicional(C_FormasPCL &hoja, int iFlagAnexo, int iRenglon)
{
	char cLog[500] = { 0 };
	char cRespuesta[20] = { 0 };
	CString sTexto = "";

	sprintf_s(cLog, "FC0200805021521981 - entra - imprimirTotalesAdicional");
	grabarLog(cLog);

	if (m_grid.lCliente == 1708)        //ETP
	{
		sprintf_s(cRespuesta, "%09ld %c", m_grid.lCliente, cTipoEtp[0]);
	}
	else
	{
		sprintf_s(cRespuesta, "%09ld %c", m_grid.lCliente, cPuntualidad[0]);
	}

	if (iFlagAnexo == 0)
	{
		sprintf_s(cRespuesta, "%09ld %c", m_grid.lCliente, cPuntualidad[0]);
	}

	hoja.poner(cRespuesta, iRenglon, 105);

	sprintf_s(cRespuesta, "%09ld", m_grid.lCliente);
	hoja.poner("CTE", iRenglon, 0);
	hoja.poner(cRespuesta, iRenglon, 4);

	miniFecha(cRespuesta, (int)iDiaActual, (int)iMesActual, (int)iAnioActual);
	hoja.poner(cRespuesta, iRenglon, 64);

	sprintf_s(cRespuesta, "%04d", m_grid.iTienda);
	hoja.poner(cRespuesta, iRenglon, 74);

	sprintf_s(cRespuesta, "%02d", m_grid.iCaja);
	hoja.poner(cRespuesta, iRenglon, 79);

	m_nombre.GetWindowText(sTexto);
	sprintf_s(cRespuesta, "%s", (LPCTSTR)sTexto);
	hoja.poner(cRespuesta, 15, iRenglon, 14);

	m_apellidoPaterno.GetWindowText(sTexto);
	sprintf_s(cRespuesta, "%s", (LPCTSTR)sTexto);
	hoja.poner(cRespuesta, 15, iRenglon, 30);

	m_apellidoMaterno.GetWindowText(sTexto);
	sprintf_s(cRespuesta, "%s", (LPCTSTR)sTexto);
	hoja.poner(cRespuesta, 15, iRenglon, 47);
}

//Para imprimir la parte de los seguros adicionales en el recibo
bool CDlgCapturarAbono::imprimirReciboSeguroClubAdicional(C_FormasPCL &hoja, char * cRespuesta2, int iRenglon, int iContadorSeguros, int iFlagAnexo, int &iPagina, int &iLinea)
{
	char cLog[500] = { 0 };
	bool bRegresa = false;
	int iNumSeguros = 0;
	long lMontoClub = 0L, lFolio = 0L;
	char cSql[360] = { 0 }, cTexto[120] = { 0 }, cTexto2[8] = { 0 }, cFechaTienda[12] = { 0 }, cFechaVencimientoAdicional[12] = { 0 };
	short iEdadAdicional = 0;
	bool bSeguroAdicionalVigente = false;

	sprintf_s(cLog, "FC0200805021521985 - entra - imprimirReciboSeguroClubAdicional");
	grabarLog(cLog);

	sprintf_s(cSql, "SELECT folio,cantidadseguros,TRIM(nombreadicional) AS nombreadicional,TRIM(apellidopaternoadic) AS apellidopaternoadic,TRIM(apellidomaternoadic) AS apellidomaternoadic,fecnacadic,parentescoadic, fechavencimiento FROM crseguros WHERE cliente = %ld AND tiposeguro=2 AND claveconyugal = 1 AND claveseguro='C' AND statusseguro='A' ORDER BY folio", m_grid.lCliente);

	CConsultarCrSegurosClubAdicional crSegurosSQL(&odbc_1);
	if (crSegurosSQL.Exec(cSql)) //Se obtienen los seguros adicionales del cliente
	{
		bRegresa = true;
		crSegurosSQL.activarCols();
		while (crSegurosSQL.Leer()) //Para poner en el recibo el mensaje "FOLIO:  #### AFILIADO AL CLUB CON # SEGUROS ADICIONAL: $ ###,### VENCE DDMMMYY"
		{
			bSeguroAdicionalVigente = false;

			//Se calcula la edad del adicional
			iEdadAdicional = (short)(iAnioActual - crSegurosSQL.fecnacadic.ano());
			if (iMesActual < crSegurosSQL.fecnacadic.mes() || (iMesActual == crSegurosSQL.fecnacadic.mes() && iDiaActual < crSegurosSQL.fecnacadic.dia()))
			{
				iEdadAdicional--;
			}

			sprintf_s(cFechaVencimientoAdicional, "%04d%02d%02d", crSegurosSQL.fechavencimiento.ano(), crSegurosSQL.fechavencimiento.mes(), crSegurosSQL.fechavencimiento.dia());
			sprintf_s(cFechaTienda, "%04d%02d%02d", iAnioActual, iMesActual, iDiaActual);

			if (atoi(cFechaVencimientoAdicional) >= atoi(cFechaTienda))
			{
				bSeguroAdicionalVigente = true;
			}

			if ((iEdadAdicional <= iEdadMaximaAbonoClubAdic && bSeguroAdicionalVigente) || (!bSeguroAdicionalVigente && iEdadAdicional <= iEdadMaximaClubAdicional))
			{
				iNumSeguros = crSegurosSQL.cantidadseguros;
				consultarMontoSeguroClub(lMontoClub, (short)iNumSeguros, 2, iEdadAdicional);
				lFolio = crSegurosSQL.folio;
				usingx("###,###", cTexto2, lMontoClub);
				cTexto2[7] = 0;

				iRenglon++;
				if (iRenglon > 14)
				{

					hoja.poner(ENFATIZAR, 13, 15);
					hoja.poner(NO_ENFATIZAR, 13, 83);

					imprimirTotalesAdicional(hoja, iFlagAnexo, iRenglon);

					encabezadoTalonCajas(hoja, iPagina - 1, iContadorSeguros);

					encabezadoReciboCajas(hoja);

					hoja.poner(SEXTOS, 19, 0);

					hoja.imprimir();
					compactarImpresion(hoja);
					iPagina++;
					iRenglon = 2;
				}
				sprintf_s(cTexto, "FOLIO:  %d AFILIADO AL CLUB DE PROTECCIÓN FAMILIAR CON %d SEGUROS ADICIONAL: $ %s VENCE %s ", lFolio, iNumSeguros, cTexto2, cRespuesta2);
				hoja.poner(cTexto, iRenglon, 0);
			}
		}

		iRenglon++;

		hoja.poner(ENFATIZAR, 13, 15);
		hoja.poner(NO_ENFATIZAR, 13, 83);

		imprimirTotalesAdicional(hoja, iFlagAnexo, 15);

		encabezadoTalonCajas(hoja, iPagina - 1, iContadorSeguros);

		encabezadoReciboCajas(hoja);

		hoja.poner(SEXTOS, 19, 0);

		hoja.imprimir();
		compactarImpresion(hoja);
		iPagina++;

		iRenglon = 1;

		crSegurosSQL.ClearResults();
		crSegurosSQL.ClearStatement();

		if (crSegurosSQL.Exec(cSql))
		{
			crSegurosSQL.activarCols();
			while (crSegurosSQL.Leer()) //Para poner en el recibo el mensaje "FOLIO:  #### NOMBREADICIONAL"
			{
				bSeguroAdicionalVigente = false;

				//Se calcula la edad del adicional
				iEdadAdicional = (short)(iAnioActual - crSegurosSQL.fecnacadic.ano());
				if (iMesActual < crSegurosSQL.fecnacadic.mes() || (iMesActual == crSegurosSQL.fecnacadic.mes() && iDiaActual < crSegurosSQL.fecnacadic.dia()))
				{
					iEdadAdicional--;
				}

				sprintf_s(cFechaVencimientoAdicional, "%04d%02d%02d", crSegurosSQL.fechavencimiento.ano(), crSegurosSQL.fechavencimiento.mes(), crSegurosSQL.fechavencimiento.dia());
				sprintf_s(cFechaTienda, "%04d%02d%02d", iAnioActual, iMesActual, iDiaActual);

				if (atoi(cFechaVencimientoAdicional) >= atoi(cFechaTienda))
				{
					bSeguroAdicionalVigente = true;
				}

				if ((iEdadAdicional <= iEdadMaximaAbonoClubAdic && bSeguroAdicionalVigente) || (!bSeguroAdicionalVigente && iEdadAdicional <= iEdadMaximaClubAdicional))
				{
					iRenglon++;
					if (iRenglon > 14)
					{

						hoja.poner(ENFATIZAR, 13, 15);
						hoja.poner(NO_ENFATIZAR, 13, 83);

						imprimirTotalesAdicional(hoja, iFlagAnexo, iRenglon);

						encabezadoTalonCajas(hoja, iPagina - 1, iContadorSeguros);

						encabezadoReciboCajas(hoja);

						hoja.poner(SEXTOS, 19, 0);

						hoja.imprimir();
						compactarImpresion(hoja);
						iPagina++;
						iRenglon = 2;
					}

					lFolio = crSegurosSQL.folio;
					sprintf_s(cTexto, "FOLIO:  %d %s %s %s", lFolio, crSegurosSQL.nombreadicional, crSegurosSQL.apellidopaternoadic, crSegurosSQL.apellidomaternoadic);
					hoja.poner(cTexto, iRenglon, 0);
				}
			}

			iRenglon++;

			if (iRenglon > 7)
			{

				hoja.poner(ENFATIZAR, 13, 15);
				hoja.poner(NO_ENFATIZAR, 13, 83);

				imprimirTotalesAdicional(hoja, iFlagAnexo, 15);

				encabezadoTalonCajas(hoja, iPagina - 1, iContadorSeguros);

				encabezadoReciboCajas(hoja);

				hoja.poner(SEXTOS, 19, 0);

				hoja.imprimir();
				compactarImpresion(hoja);
				iPagina++;
				iRenglon = 2;
			}

			iLinea = iRenglon - 1; //Para saber en que linea se quedo al imprimir el recibo
		}
		else
		{
			bRegresa = false;
		}
	}
	else
	{
		bRegresa = false;
	}

	if (!bRegresa)
	{
		crSegurosSQL.odbc->GetLastError(crSegurosSQL.GetHstmt());
		grabarMensajeError("C", m_grid.iCaja, (LPTSTR)(LPCTSTR)m_grid.sServer, "CA0030", "CDlgCapturarAbono", "imprimirReciboSeguroClubAdicional", cSql, m_grid.lEmpleado, "ERROR #10165", crSegurosSQL.odbc, m_grid.iMuestraMsg);
	}
	return bRegresa;
}

void CDlgCapturarAbono::obtenerDatosAdicional(long lFolioSeguro, char *cNombre, char *cApellidoPat, char *cApellidoMat, short &iParentesco, short &iDiaNac, short &iMesNac, short &iAnioNac)
{
	char cLog[500] = { 0 };
	char cSql[340] = { 0 };

	sprintf_s(cLog, "FC0200805021521989 - entra - obtenerDatosAdicional");
	grabarLog(cLog);

	sprintf_s(cSql, "SELECT 0, 0, TRIM(nombreadicional) AS nombreadicional, TRIM(apellidopaternoadic) AS apellidopaternoadic, TRIM(apellidomaternoadic) AS apellidomaternoadic, fecnacadic, parentescoadic "
		"FROM crseguros WHERE cliente = %ld AND folio = %ld AND tiposeguro=2 AND claveconyugal = 1 AND claveseguro='C' AND "
		"statusseguro='A'", m_grid.lCliente, lFolioSeguro);
	grabarLog(cSql);
	CConsultarCrSegurosClubAdicional crSegurosSQL(&odbc_1);

	if (crSegurosSQL.Exec(cSql))
	{
		crSegurosSQL.activarCols();
		if (crSegurosSQL.leer())
		{
			sprintf(cNombre, crSegurosSQL.nombreadicional);
			sprintf(cApellidoMat, crSegurosSQL.apellidomaternoadic);
			sprintf(cApellidoPat, crSegurosSQL.apellidopaternoadic);
			iDiaNac = (short)crSegurosSQL.fecnacadic.dia();
			iMesNac = (short)crSegurosSQL.fecnacadic.mes();
			iAnioNac = (short)crSegurosSQL.fecnacadic.ano();
			iParentesco = crSegurosSQL.parentescoadic;
		}
	}
}

bool CDlgCapturarAbono::ValidarExisteConvenio()
{
	char cLog[500] = { 0 };
	bool bContinuar = false;
	CMaximo Tablax(&odbc, false);
	char cSqlConv[256] = { 0 };

	iTotalConvenio = 0;

	sprintf_s(cLog, "FC0200805021521993 - entra - ValidarExisteConvenio");
	grabarLog(cLog);

	sprintf_s(cSqlConv,
		"SELECT COUNT(*) FROM cacarmov WHERE cliente= '%ld' AND ((clave = 'S' AND tipomovimiento IN ('8', '9', 'F', 'M', 'Q')) OR (clave = 'D' AND tipomovimiento = '8')) AND efectuo='%ld' AND fecha ='%04d-%02d-%02d'",
		m_grid.lCliente, m_grid.lEmpleado, iAnioActual, iMesActual, iDiaActual);

	if (Tablax.Exec(cSqlConv))
	{
		Tablax.activarCols();
		if (Tablax.Leer())
		{
			iTotalConvenio = (int)Tablax.Total;
			bContinuar = true;
		}
	}
	return bContinuar;
}

bool CDlgCapturarAbono::ValidarConvenioUnico(int AbonoBase, int Vencido, int Pago, bool bflg_candconvunico)
{
	char cLog[500] = { 0 };
	bool bContinuar = false;
	CMaximo Tablax(&odbc, false);
	int iMesesVencidoCta, iVencidoFinalCta;
	iMesesVencidoCta = iVencidoFinalCta = 0;
	char cSql[120] = { 0 };
	iflg_candconvunico = 0;

	sprintf_s(cLog, "FC0200805021521997 - entra - ValidarConvenioUnico");
	grabarLog(cLog);

	sprintf_s(cSql, "SELECT num_mesesparaconvunico FROM ctl_variablesparaconvenios WHERE anio=%d and mes =%d limit 1", ianio, imes);
	if (Tablax.Exec(cSql))
	{
		Tablax.activarCols();
		if (Tablax.Leer())
		{
			imesesparaconvunico = (int)Tablax.Total;
			bContinuar = true;
		}
	}
	if (Vencido > Pago && AbonoBase > 0)//restar el abono al vencido
	{
		if (bflg_candconvunico == false)
		{
			iVencidoFinalCta = (Vencido - Pago);//Obtener Vencido final
		}
		else
		{
			iVencidoFinalCta = Vencido;
		}
		iMesesVencidoCta = (iVencidoFinalCta / AbonoBase);//Obtener Meses Vencidos
	}
	else
	{
		iVencidoFinalCta = 0;
	}

	if (iMesesVencidoCta >= imesesparaconvunico)//Si se cumple la condicion cuenta candidata a Conv.Unico
	{
		if (bflg_candconvunico != true)
		{
			iNumCandidatoUnico++;
		}
		else
		{
			iflg_candconvunico = 1;
		}
	}
	return bContinuar;
}

bool CDlgCapturarAbono::obtenerFlagImpresora(int &iFlagImpresoraTermica)
{
	char cLog[500] = { 0 };
	short iCaja = 0;
	char cSql[70] = { 0 };
	char cArea[3] = { 0 };
	bool bContinuar = true;

	sprintf_s(cLog, "FC0200805021522001 - entra - obtenerFlagImpresora");
	grabarLog(cLog);

	CMaximo Tablax(&odbc, false);

	iFlagImpresoraTermica = 0;
	switch (iSistema)
	{
	case 1:
		cArea[0] = 'M';
		iCaja = (short)iCajaOriginal;
		break;
	case 2:
		cArea[0] = 'R';
		iCaja = (short)iCajaOriginal;
		break;
	case 3:
	case 7:
		cArea[0] = 'C';
		iCaja = (short)iCajaActual;
		break;
	default:break;
	}
	cArea[1] = 0;

	sprintf_s(cSql, "SELECT tipotermica FROM sysmicros WHERE area = '%s' AND caja = %d", cArea, iCaja);

	if (Tablax.Exec(cSql))
	{
		Tablax.activarCols();
		if (Tablax.Leer())
		{
			iFlagImpresoraTermica = (int)Tablax.Total;
		}
	}
	return bContinuar;
}

void CDlgCapturarAbono::consultarEncuesta()
{
	char cLog[500] = { 0 };

	sprintf_s(cLog, "FC0200805021522005 - entra - consultarEncuesta");
	grabarLog(cLog);

	if (iFlagEncuestaCat == 1)
	{
		if (iSistema == SISTEMA_CAJAS)
		{
			char cNombreProyecto[100] = { 0 }, cNombreFuncionDLL[10] = { 0 }, cInputParam1[1024] = { 0 }, cInputParam2[1024] = { 0 }, cOutputParam1[1024] = { 0 }, cOutputParam2[1024] = { 0 };
			SParametros parametros;
			memset(&parametros, 0, sizeof(SParametros));

			nombreArchivo("CA0153.DLL", cNombreProyecto, DIRECTORIO_CA); //ConsultarEncuesta
			sprintf_s(cNombreFuncionDLL, "CA0153");

			parametros.iLink = generarLink();
			sprintf_s(parametros.sServer, "%s", (LPCTSTR)m_grid.sServer);
			parametros.iTienda = m_grid.iTienda;
			parametros.lEmpleado = m_grid.lEmpleado;
			parametros.iCajaActual = m_grid.iCaja;
			parametros.iMuestraMsg = m_grid.iMuestraMsg;
			parametros.iNumSistema = iSistema;
			parametros.iTipo = 0; //Consultar encuesta

			parametros.lCliente = m_grid.lCliente;

			grabarLog("consultarEncuesta::Cargando modulo CA0153");

			memcpy(cInputParam1, &parametros, sizeof(SParametros));
			CargarDLL cargarDll(cNombreProyecto, cNombreFuncionDLL, cInputParam1, cInputParam2, cOutputParam1, cOutputParam2);

			iRegresaDll = cargarDll.getResultado();

			if (iRegresaDll < 0)
			{
				AfxMessageBox("Error al cargar el programa CA0153.DLL", MB_ICONERROR);
			}
			if (iRegresaDll > 0)
			{
				iMostrarEncuestaCat = atoi(cOutputParam1);
			}
		}
	}
}

void CDlgCapturarAbono::pedirEncuestaCat()
{
	char cLog[500] = { 0 };
	char cMensaje[80] = { 0 };

	sprintf_s(cLog, "FC0200805021522009 - entra - pedirEncuestaCat");
	grabarLog(cLog);

	if (iFlagEncuestaCat == 1 && iMostrarEncuestaCat > 0)
	{
		if (iSistema == SISTEMA_CAJAS)
		{
			if (GetSetCuestionTitular() == RESPUESTA_CUESTION_POSITIVA)
			{
				char cNombreProyecto[100] = { 0 }, cNombreFuncionDLL[10] = { 0 }, cInputParam1[1024] = { 0 },
					cInputParam2[1024] = { 0 }, cOutputParam1[1024] = { 0 }, cOutputParam2[1024] = { 0 };

				sprintf_s(cMensaje, "Tipo de Encuesta: %d", iMostrarEncuestaCat);
				AfxMessageBox(cMensaje);

				SParametros parametros;
				memset(&parametros, 0, sizeof(SParametros));

				nombreArchivo("CA0153.DLL", cNombreProyecto, DIRECTORIO_CA); //ConsultarEncuesta
				sprintf_s(cNombreFuncionDLL, "CA0153");

				parametros.iLink = generarLink();
				sprintf_s(parametros.sServer, "%s",(LPCTSTR)m_grid.sServer);
				parametros.iTienda = m_grid.iTienda;
				parametros.lEmpleado = m_grid.lEmpleado;
				parametros.iCajaActual = m_grid.iCaja;
				parametros.iMuestraMsg = m_grid.iMuestraMsg;
				parametros.iNumSistema = iSistema;
				parametros.iTipo = iMostrarEncuestaCat; //Disminuir Encuesta
				parametros.lCliente = m_grid.lCliente;

				memcpy(cInputParam1, &parametros, sizeof(SParametros));
				CargarDLL cargarDll(cNombreProyecto, cNombreFuncionDLL, cInputParam1, cInputParam2, cOutputParam1, cOutputParam2);

				iRegresaDll = cargarDll.getResultado();

				if (iRegresaDll < 0)
				{
					AfxMessageBox("Error al cargar el programa CA0153.DLL", MB_ICONERROR);
				}
			}
		}
	}
}

bool CDlgCapturarAbono::verificarPromocionAsteriscoCoppel()
{
	char cLog[500] = { 0 };
	bool bContinuar = false;

	sprintf_s(cLog, "FC0200805021522013 - entra - verificarPromocionAsteriscoCoppel");
	grabarLog(cLog);

	// Si el cliente es canditado, esta activo el flag de impresion promocional y abono a la cuenta de tiempo aire
	if (iFlagAbonoTA == 1)
	{
		if (ConsultaFlagImpresion())
		{
			ImpresionasteriscoCoppel();
		}
	}
	return bContinuar;
}

bool CDlgCapturarAbono::verificarPromocionesMesActual()
{
	char cLog[500] = { 0 };
	char cSql[60] = { 0 };
	bool bContinuar = false;

	sprintf_s(cLog, "FC0200805021522017 - entra - verificarPromocionesMesActual");
	grabarLog(cLog);

	CMaximo imprimirSQL(&odbc);
	sprintf_s(cSql, "SELECT * FROM muVerificarFlagPromocionalTA(%ld)", m_grid.lCliente);

	if (imprimirSQL.Exec(cSql))
	{
		imprimirSQL.activarCols();
		if (imprimirSQL.Leer() && imprimirSQL.Total == 0)
		{
			bContinuar = true;
		}
	}
	return bContinuar;
}

void CDlgCapturarAbono::imprimirPromocionAsteriscoCoppel(C_FormasPCL &hoja, int iSistema)
{
	char cLog[500] = { 0 };

	sprintf_s(cLog, "FC0200805021522021 - entra - imprimirPromocionAsteriscoCoppel");
	grabarLog(cLog);

	if (iSistema == SISTEMA_MUEBLES || iSistema == SISTEMA_ROPA)
	{
		hoja.poner("¨Se agotó tu tiempo aire?", 4, 18);

		hoja.poner("En Coppel puedes  recargar tiempo aire  desde", 6, 8);
		hoja.poner("tu celular a cualquier hora,  desde cualquier", 7, 8);
		hoja.poner("lugar y ­a crédito!.", 8, 8);

		hoja.poner("Solo  acude  a  cualquier   tienda  Coppel  o", 10, 8);
		hoja.poner("zapatera   Coppel   CANADA  y   registra  el", 11, 8);
		hoja.poner("n£mero  de  celular (puedes  registrar  hasta", 12, 8);
		hoja.poner("tres).", 13, 8);

		hoja.poner("Despu‚s  marca   desde  tu  celular   *Coppel", 15, 8);
		hoja.poner("( *267735 ) y una grabación  te  indicar   de", 16, 8);
		hoja.poner("manera f cil la forma de recargar tiempo aire", 17, 8);
		hoja.poner("a partir de $100.", 18, 8);

		hoja.poner("Coppel.... Mejora tu vida.", 20, 8);
	}
	else if (iSistema == SISTEMA_CAJAS)
	{
		hoja.poner("¨Se agotó tu tiempo aire?", 2, 35);

		hoja.poner("En Coppel puedes recargar  tiempo aire  desde tu  celular a cualquier hora,", 4, 8);
		hoja.poner("desde cualquier lugar y ­a cr‚dito!.", 5, 8);

		hoja.poner("Sólo   acude  a  cualquier  tienda  Coppel  o  zapater¡a  Coppel  CANADA  y", 7, 8);
		hoja.poner("registra el n£mero de celular (puedes registrar hasta tres).", 8, 8);

		hoja.poner("Despu‚s  marca desde  tu celular  *Coppel ( *267735 )  y  una  grabación te", 10, 8);
		hoja.poner("indicar  de manera f cil la forma de recargar tiempo aire a partir de $100.", 11, 8);

		hoja.poner("Coppel.... Mejora tu vida.", 13, 8);
	}

	hoja.imprimir();
}

void CDlgCapturarAbono::marcarFlagPromocionTA(long lNumeroRecibo)
{
	char cLog[500] = { 0 };
	char cSql[150] = { 0 };

	sprintf_s(cLog, "FC0200805021522025 - entra - marcarFlagPromocionTA");
	grabarLog(cLog);

	CMaximo marcarSQL(&odbc, true);

	if (iSistema == SISTEMA_MUEBLES)
		sprintf_s(cSql, "UPDATE caCarmov SET flagPromocionAlta = 1 WHERE cliente = %ld AND recibo = %ld AND caja = 99 AND cajaoriginal = %d", m_grid.lCliente, lNumeroRecibo, m_grid.iCaja);
	else if (iSistema == SISTEMA_ROPA)
		sprintf_s(cSql, "UPDATE caCarmov SET flagPromocionAlta = 1 WHERE cliente = %ld AND recibo = %ld AND caja = 98 AND cajaoriginal = %d", m_grid.lCliente, lNumeroRecibo, m_grid.iCaja);
	else if (iSistema == SISTEMA_CAJAS)
		sprintf_s(cSql, "UPDATE caCarmov SET flagPromocionAlta = 1 WHERE cliente = %ld AND recibo = %ld AND caja = %d", m_grid.lCliente, lNumeroRecibo, m_grid.iCaja);

	if (!marcarSQL.Exec(cSql))
	{
		marcarSQL.odbc->GetLastError(marcarSQL.GetHstmt());
	}
}

void CDlgCapturarAbono::imprimirPolizaSeguroClubTermica(long lFolio, short iSeguros, short iTipoSeguro, short iRespuesta, short iEdad, short iCambioPlan)
{
	char cLog[500] = { 0 };
	char cNombreProyecto[100] = { 0 }, cNombreFuncionDLL[10] = { 0 }, cInputParam1[1024] = { 0 }, cInputParam2[1024] = { 0 },
		cOutputParam1[1024] = { 0 }, cOutputParam2[1024] = { 0 }, cArea[3] = { 0 };
	int iRegresaDll = 0, iMesesSeguro = 0, iNumeroSeguros = 0;
	long lPago = 0L, lFolioClub = 0L;
	CString sTexto;

	sprintf_s(cLog, "FC0200805021522029 - entra - imprimirPolizaSeguroClubTermica");
	grabarLog(cLog);

	SParametros parametros;
	memset(&parametros, 0, sizeof(parametros));

	if (iTipoSeguro == 2)
	{
		lFolioClub = lFolio;
		iNumeroSeguros = iSeguros;
		iMesesSeguro = iNumMesesAdicional;
		grabarLog("Consulta Precio seguro 12");
		consultarPrecioSeguroClub(lPago, (short)iSeguros, 2, (short)iEdad);
		lPago = lPago * iNumMesesAdicional;
	}
	else
	{
		for (int iCol = 0; iCol < iTotalCuentas; iCol++)
		{
			m_grid.QuickGetText(iCol, -1, &sTexto);
			sTexto.Trim();

			if (sTexto == "P.FAMILIAR") //Si es seguro
			{
				lFolioClub = (long)iFoliosSegurosAdicionales[0];

				if (iFoliosSegurosAdicionales[0] != iFoliosSegurosActual[0] && iFoliosSegurosActual[0] != 0)
				{
					iCambioPlan = 1;
				}

				m_grid.QuickGetText(iCol, 23, &sTexto);
				iMesesSeguro = atoi(sTexto);

				m_grid.QuickGetText(iCol, 21, &sTexto);
				lPago = atol(sTexto);
				break;
			}
		}
		iNumeroSeguros = obtenerNumeroSeguros();

		if (iSegurosAdicionales > 0)
		{
			lPago = lCuotaClub * iMesesSeguro;
		}
	}

	switch (iSistema)
	{
	case SISTEMA_MUEBLES:
		cArea[0] = 'M';
		break;
	case SISTEMA_ROPA:
		cArea[0] = 'R';
		break;
	default:
		cArea[0] = 'C';
		break;
	}

	if (!bBanderaTieneClub && iFlagMesRegalado == 1)//un cambio
		iMesesSeguro++;

	sprintf_s(parametros.sServer, "%s", (LPCTSTR)m_grid.sServer);
	parametros.iTienda = m_grid.iTienda;
	parametros.lEmpleado = m_grid.lEmpleado;
	parametros.iCajaActual = m_grid.iCaja;
	sprintf_s(parametros.sArea, "%s", cArea);
	parametros.iMuestraMsg = m_grid.iMuestraMsg;
	parametros.lCliente = m_grid.lCliente;
	parametros.lFactura = lNumeroRecibo;
	parametros.lFolioSeguro = lFolioClub; // Folio
	parametros.iSensor = iNumeroSeguros; // Numero de Seguros
	parametros.iTipoServicio = iMesesSeguro; // Numero de Meses
	parametros.lCantidad = lPago; // Su Pago
	parametros.iFlagServicio = iRespuesta; //Para saber si se va imprimir la respuesta de la poliza
	parametros.iTipo = iTipoSeguro; //Tipo Seguro 1 = Titular, 2 = Adicional
	parametros.iTiendaFactura = iCambioPlan; // 0 --> Nuevo , 1 --> Cambio de plan

	memcpy(cInputParam1, &parametros, sizeof(SParametros));
	// Ruta del archivo DLL a ejecutar
	nombreArchivo("CA0157.DLL", cNombreProyecto, DIRECTORIO_CA);
	// Nombre de la función principal en el DLL
	sprintf_s(cNombreFuncionDLL, "CA0157");
	CargarDLL cargarDll(cNombreProyecto, cNombreFuncionDLL, cInputParam1, cInputParam2, cOutputParam1, cOutputParam2);
	iRegresaDll = cargarDll.getResultado();
	if (iRegresaDll <= 0)
	{
		AfxMessageBox("Ocurrio un error al llamado del modulo CA0157.DLL", MB_ICONERROR);
	}
}

bool  CDlgCapturarAbono::consultarPromocionDirecta()
{
	char cLog[500] = { 0 };
	bool bResultado = false;
	char cIPServidorSolicitudes[20] = { 0 }, cIPServidorSolicitudesAlterno[20] = { 0 }, cSql[255] = { 0 };

	sprintf_s(cLog, "FC0200805021522033 - entra - consultarPromocionDirecta");
	grabarLog(cLog);

	if (consultarIpServidores(&odbc, cIPServidorSolicitudes, cIPServidorSolicitudesAlterno, SERV_SOLICITUDES, cSql))
	{
		if (abrirConexionBD(&odbcSolicitudes, cIPServidorSolicitudes, cIPServidorSolicitudesAlterno, CONECTA_SOLICITUDES, iTiendaDlg))
		{
			sprintf_s(cSql, "SELECT departamento, clase, grupo, familia, retorno FROM gnActivarClientePromoDirecta( '%ld', '%d', '%04d-%02d-%02d' ) ", m_grid.lCliente, iCiudadCliente, iAnioActual, iMesActual, iDiaActual);

			CConsultarDatosCliente obtenerCliente(&odbcSolicitudes);

			if (obtenerCliente.Exec(cSql))
			{
				obtenerCliente.activarCols();
				if (obtenerCliente.Leer())
				{
					if (obtenerCliente.retorno == 1)
					{
						lDepartamento = obtenerCliente.departamento;
						lClase = obtenerCliente.clase;
						lGrupo = obtenerCliente.grupo;
						bResultado = true;
					}
				}
			}
			else
			{
				obtenerCliente.Error();
				obtenerCliente.odbc->GetLastError(obtenerCliente.GetHstmt());
				grabarMensajeError("C", m_grid.iCaja, (LPTSTR)(LPCTSTR)m_grid.sServer, "CA0030", "CDlgCapturarAbono", "consultarPromocionDirecta", cSql, m_grid.lEmpleado, "ERROR #10937", obtenerCliente.odbc, m_grid.iMuestraMsg);
			}
		}
	}

	odbcSolicitudes.Close();
	return bResultado;
}

bool  CDlgCapturarAbono::mensajePromocionDirecta(int iFlagImpresoraTermica)
{
	char cLog[500] = { 0 };
	CString sTexto;
	bool bResultado = false;
	char cNombre[30] = { 0 }, cApellidoPaterno[30] = { 0 }, cApellidoMaterno[30] = { 0 }, cSql[230] = { 0 };
	sprintf_s(cNombre, "%s", (LPCTSTR)sNombreCliente);
	sprintf_s(cApellidoPaterno, "%s", (LPCTSTR)sApellidoPaterno);
	sprintf_s(cApellidoMaterno, "%s", (LPCTSTR)sApellidoMaterno);

	sprintf_s(cLog, "FC0200805021522037 - entra - mensajePromocionDirecta");
	grabarLog(cLog);

	memset(cEncabezado, 0, sizeof(cEncabezado));
	memset(cParrafo1, 0, sizeof(cParrafo1));
	memset(cParrafo2, 0, sizeof(cParrafo2));
	memset(cParrafo3, 0, sizeof(cParrafo3));
	memset(cParrafo4, 0, sizeof(cParrafo4));

	sprintf_s(cSql, "SELECT cencabezado, cparrafo1, cparrafo2, cparrafo3, cparrafo4 FROM gnobtenermensajepromociondirecta( '%d', '%d','%d','%c', '%c','%s', '%s', '%s' ) ", lDepartamento, lClase, lGrupo, cSexo, cEstCivil, cNombre, cApellidoPaterno, cApellidoMaterno);

	CObtenerMensajePromocionDirecta obtenerMensajePromocion(&odbc);

	if (obtenerMensajePromocion.Exec(cSql))
	{
		obtenerMensajePromocion.activarCols();
		if (obtenerMensajePromocion.Leer())
		{
			sprintf_s(cEncabezado, obtenerMensajePromocion.cencabezado);
			sprintf_s(cParrafo1, obtenerMensajePromocion.cparrafo1);
			sTexto.Format("%s", obtenerMensajePromocion.cparrafo2);
			if (iFlagImpresoraTermica)
				sTexto.Replace("%", "%%");
			sprintf_s(cParrafo2, "%s", sTexto);
			sprintf_s(cParrafo3, obtenerMensajePromocion.cparrafo3);
			sprintf_s(cParrafo4, obtenerMensajePromocion.cparrafo4);
			bResultado = true;
		}
	}
	else
	{
		obtenerMensajePromocion.odbc->GetLastError(obtenerMensajePromocion.GetHstmt());
		grabarMensajeError("C", m_grid.iCaja, (LPTSTR)(LPCTSTR)m_grid.sServer, "CA0030", "CDlgCapturarAbono", "mensajePromocionDirecta", cSql, m_grid.lEmpleado, "ERROR #10937", obtenerMensajePromocion.odbc, m_grid.iMuestraMsg);
	}
	return bResultado;
}

void CDlgCapturarAbono::imprimirMensajePromoDirectaCajas(C_FormasPCL &hoja)
{
	char cLog[500] = { 0 };
	char cTexto[301] = { 0 }, cRenglon[500] = { 0 }, cLetra = ' ';
	int iRenglon = 2, iLongitud = 0, iCaracterInicialRenglon = 0, iCaracterActualParrafo = 0, iTomarCaracteres = 0,
		iPosicionCaracterAux = 0;
	CString sTexto = "", sTexto1 = "";

	sprintf_s(cLog, "FC0200805021522041 - entra - imprimirMensajePromoDirectaCajas");
	grabarLog(cLog);

	if ((strlen(cEncabezado) != 0) && (strlen(cParrafo1) != 0) && (strlen(cParrafo2) != 0) &&
		(strlen(cParrafo3) != 0) && (strlen(cParrafo4) != 0))
	{
		for (int iParrafo = 1; iParrafo <= 5; iParrafo++)
		{
			iCaracterActualParrafo = 0;
			iPosicionCaracterAux = 0;
			iCaracterInicialRenglon = 0;
			iTomarCaracteres = 0;

			switch (iParrafo)
			{
			case 1:
				sTexto.Format("%s", cEncabezado);
				break;
			case 2:
				sTexto.Format("%s", cParrafo1);
				break;
			case 3:
				sTexto.Format("%s", cParrafo2);
				break;
			case 4:
				sTexto.Format("%s", cParrafo3);
				break;
			case 5:
				sTexto.Format("%s", cParrafo4);
				break;
			default:
				break;
			}

			sTexto.Replace("á", " ");
			sTexto.Replace('é', '‚');
			sTexto.Replace('í', '¡');
			sTexto.Replace("ó", "ó");
			sTexto.Replace('ú', '£');
			sTexto.Replace('ñ', '¤');

			iLongitud = sTexto.GetLength();
			sprintf_s(cTexto, "%s", (LPCTSTR)sTexto);

			if (iParrafo != 1) iRenglon += 2;

			if (iLongitud <= 110)
			{
				hoja.poner(COMPACTAR, iRenglon, 40);
				hoja.poner(cTexto, iRenglon, 2);
			}
			else
			{
				while (iCaracterInicialRenglon <= iLongitud)
				{
					iCaracterActualParrafo += 110;
					if (cTexto[iCaracterInicialRenglon + 110] == ' ')
					{
						memset(cRenglon, 0, sizeof(cTexto));
						iTomarCaracteres = 110;
						sprintf_s(cRenglon, "%.111s", sTexto.Mid(iCaracterInicialRenglon, iTomarCaracteres));
						sTexto1.Format("%s", cRenglon);
						sTexto1.Trim();
						sprintf_s(cRenglon, "%s", (LPCTSTR)sTexto1);

						iRenglon++;
						hoja.poner(COMPACTAR, iRenglon, 0);
						hoja.poner(cRenglon, iRenglon, 2);
						iCaracterInicialRenglon += iTomarCaracteres;
					}
					else
					{
						iPosicionCaracterAux = 110;
						cLetra = cTexto[iCaracterActualParrafo];

						while (cLetra != ' ' && cLetra != 0)
						{
							iCaracterActualParrafo--;
							iPosicionCaracterAux--;
							cLetra = cTexto[iCaracterActualParrafo];
						}

						memset(cRenglon, 0, sizeof(cTexto));
						sprintf_s(cRenglon, "%.111s", sTexto.Mid(iCaracterInicialRenglon, iPosicionCaracterAux));
						sTexto1.Format("%s", cRenglon);
						sTexto1.Trim();
						sprintf_s(cRenglon, "%s", (LPCTSTR)sTexto1);

						iRenglon++;
						hoja.poner(COMPACTAR, iRenglon, 0);
						hoja.poner(cRenglon, iRenglon, 2);
						iCaracterInicialRenglon += iPosicionCaracterAux;
					}
				}
			}
		}
		hoja.imprimir();
	}
}

bool CDlgCapturarAbono::obtenerCiudadCandidata()
{
	char cLog[500] = { 0 };
	char cSql[50] = { 0 };
	bool bContinuar = true;

	sprintf_s(cLog, "FC0200805021522046 - entra - obtenerCiudadCandidata");
	grabarLog(cLog);

	sprintf_s(cSql, "SELECT gnciudadcandidatapromocion('%ld')", iCiudadCliente);

	CMaximo ciudadCandidata(&odbc, false); //conexión a tienda.nnnn
	if (ciudadCandidata.Exec(cSql))
	{
		ciudadCandidata.activarCols();
		if (ciudadCandidata.Leer())
		{
			if (ciudadCandidata.Total == 1) bContinuar = true;
		}
	}
	else
	{
		ciudadCandidata.odbc->GetLastError(ciudadCandidata.GetHstmt());
		grabarMensajeError("C", m_grid.iCaja, (LPTSTR)(LPCTSTR)m_grid.sServer, "CA0030", "CDlgCapturarAbono", "obtenerCiudadCandidata", cSql, m_grid.lEmpleado, "ERROR #10937", ciudadCandidata.odbc, m_grid.iMuestraMsg);
		bContinuar = false;
	}
	return bContinuar;
}

void CDlgCapturarAbono::cargarSorteos()
{
	CTitularidad titularidad;
	long lKeyTmp = 0;
	int iRegistros = 0;
	char cQuery[512] = { 0 };
	char cJsonP[512] = { 0 };
	char cLog[500] = { 0 };
	char cNombreProyecto[100] = { 0 }, cNombreFuncionDLL[10] = { 0 }, cInputParam1[1024] = { 0 },
		cInputParam2[1024] = { 0 }, cOutputParam1[1024] = { 0 }, cOutputParam2[1024] = { 0 };
	int iRegresaDll = 0;
	bool bHayProblemas = false;
	SParametros parametros;

	sprintf_s(cLog, "FC0200805021522050 - entra - cargarSorteos");
	grabarLog(cLog);

	grabarLog("CDlgCapturarAbono::cargarSorteos: Inicia modulo de sorteos GN0133");

	memset(&parametros, 0, sizeof(parametros));

	sprintf_s(parametros.sServer, "%s", (LPCTSTR)m_grid.sServer);
	sprintf_s(parametros.cNombre, "%s", cNombre);
	sprintf_s(parametros.cApellidoPaterno, "%s", cApellidoPaterno);
	sprintf_s(parametros.cApellidoMaterno, "%s", cApellidoMaterno);
	parametros.iTienda = m_grid.iTienda;
	parametros.iCajaActual = m_grid.iCaja;
	parametros.iNumSistema = iSistema;
	parametros.lCliente = m_grid.lCliente;
	parametros.lEmpleado = m_grid.lEmpleado;
	parametros.lFactura = lNumeroRecibo;
	parametros.iBodega = 6;//origen de captura de datos
	parametros.iFlagCredito = this->iNumeroAdicional;

	if (iSistema == SISTEMA_CAJERA_CAPTURISTA)
	{
		parametros.iTipoServicio = 15; // cajera capturista
	}
	else
	{
		parametros.iTipoServicio = 3;//Abonos
	}
	parametros.iFlagGeneral = iFlagDescuentoEspecial;
	parametros.lKeyX = titularidad.lKey;
	titularidad.iBiometrizadoCliente = this->iBiometrizadoCliente;
	titularidad.iBiometrizadoGerente = this->iBiometrizadoGerente;
	titularidad.iTipoCuestion = this->iTipoCuestion;
	titularidad.iNumAdicional = this->iNumeroAdicional;
	titularidad.GetJSON(cJsonP);
	sprintf(cQuery,
		"SELECT fun_grabarctlrespuestapuente as lResultado FROM fun_grabarctlrespuestapuente("
		"'TITULARIDAD', %d::SMALLINT, %d::SMALLINT,'%d', '%s', '{}')",
		iTiendaDlg, iCajaDlg, iSistema, cJsonP);

	CRespuestaPuenteEntrada respuestaEntrada(&odbc, cQuery);
	if (!respuestaEntrada.Leer())
	{
		sprintf_s(cLog, "94cf54afe491 [ERR] - No fue posible recibir la respuesta de grabado en ctl_respuestapuente");
		grabarLog(cLog);
		bHayProblemas = true;
	}

	memcpy(cInputParam1, &parametros, sizeof(SParametros));
	nombreArchivo("GN0133.DLL", cNombreProyecto, DIRECTORIO_GN);
	sprintf_s(cNombreFuncionDLL, "GN0133");
	CargarDLL cargarDll(cNombreProyecto, cNombreFuncionDLL, cInputParam1, cInputParam2, cOutputParam1, cOutputParam2);
	iRegresaDll = cargarDll.getResultado();

	if (iRegresaDll <= 0)
	{
		AfxMessageBox("Ocurrio un error al llamado del modulo GN0133.DLL", MB_ICONERROR);
	}

	sprintf(cQuery,
		"select des_registroentrada as cEntrada, des_registrosalida as cSalida from "
		"fun_obtenerctlrespuestapuente('TITULARIDAD', %d::SMALLINT, %d::SMALLINT, '%d')",
		iTiendaDlg, iCajaDlg, iSistema);
	CRespuestaPuenteSalida respuestaPuenteSalida(&odbc, cQuery);

	while (respuestaPuenteSalida.leer())
	{
		iRegistros++;
	}

	if (iRegistros == 1)
	{
		lKeyTmp = titularidad.lKey;
		titularidad.SetJSON(respuestaPuenteSalida.cSalida);
		if (lKeyTmp == titularidad.lKey)
		{
			this->iBiometrizadoCliente = titularidad.iBiometrizadoCliente;
			this->iBiometrizadoGerente = titularidad.iBiometrizadoGerente;
			this->iTipoCuestion = titularidad.iTipoCuestion;
			this->iNumeroAdicional = titularidad.iNumAdicional;
		}
		else
		{
			sprintf(cLog, "a8b25f6779eb - keyx no coincide entre emisor y receptor");
			grabarLog(cLog);
			bHayProblemas = true;
		}
	}
	else
	{
		sprintf(cLog, "808deddbdc19 - Se encontró una cantidad de registros inesperados");
		grabarLog(cLog);
		bHayProblemas = true;
	}
	if (bHayProblemas)
	{
		AfxMessageBox(
			"Se ha presentado un error con la titularidad. Favor de contactar a Mesa de Ayuda",
			MB_ICONINFORMATION | MB_TOPMOST | MB_APPLMODAL);
	}
}

void CDlgCapturarAbono::cargarDatosSorteoNuevo(long lFlagHuella)
{
	char cLog[500] = { 0 };
	char cEjecutable[80] = { 0 }, cInputParam1[1024] = { 0 }, cInputParam2[1024] = { 0 }, cOutParam1[1024] = { 0 }, cOutParam2[1024] = { 0 };
	SParametros argv;

	sprintf_s(cLog, "FC0200805021522054 - entra - cargarDatosSorteoNuevo");
	grabarLog(cLog);

	grabarLog("CDlgCapturarAbono::cargarDatosSorteoNuevo: Inicia modulo de sorteos GN0137");

	memset(&argv, 0, sizeof(argv));

	sprintf_s(argv.sServer, "%s", (LPCTSTR)m_grid.sServer);
	argv.iTienda = m_grid.iTienda;
	argv.lEmpleado = m_grid.lEmpleado;
	argv.lCliente = m_grid.lCliente;
	argv.iCajaActual = m_grid.iCaja;
	argv.iNumSistema = iSistema;
	argv.iTipoServicio = 3;
	argv.lFactura = lNumeroRecibo;
	argv.iFlagGeneral = 1;
	argv.iFlagServicio = lFlagHuella;
	sprintf_s(argv.cNombre, "%.15s", cNombre);
	sprintf_s(argv.cApellidoPaterno, "%.15s", cApellidoPaterno);
	sprintf_s(argv.cApellidoMaterno, "%.15s", cApellidoMaterno);

	memcpy(cInputParam1, &argv, sizeof(argv));
	nombreArchivo("GN0137.DLL", cEjecutable, DIRECTORIO_GN);

	CargarDLL cargarDll(cEjecutable, "GN0137", cInputParam1, cInputParam2, cOutParam1, cOutParam2);
}

void CDlgCapturarAbono::cargarCampanasDE()
{
	char cLog[500] = { 0 };

	CString sReciboFin = "", sCliente = "", sCajaActual = "", cArea = "",
		sCiudad = "", sNomCliente = "", sTienda = "", sTipoMovimiento = "", sAccion = "", sCajaOriginal = "";

	sprintf_s(cLog, "FC0200805021522058 - entra - cargarCampanasDE");
	grabarLog(cLog);

	grabarLog("CDlgCapturarAbono::cargarCampanasDE: Inicia cargar modulo GN0261");

	sTipoMovimiento = "2";
	sAccion = "1";
	sReciboFin.Format("%d", lNumeroRecibo);
	sCliente.Format("%d", lClienteDlg);
	sCiudad.Format("%d", iCiudadGnDominio);
	sTienda.Format("%ld", m_grid.iTienda);

	switch (iSistema)
	{
		case SISTEMA_MUEBLES:
			cArea = 'C';
			sCajaOriginal.Format("%d", iCajaOriginal);
			sCajaActual = "99";
			break;
		case SISTEMA_ROPA:
			cArea = 'C';
			sCajaOriginal.Format("%d", iCajaOriginal);
			sCajaActual = "98";
			break;
		case SISTEMA_CAJAS:
			cArea = 'C';
			sCajaOriginal.Format("%d", iCajaActual);
			sCajaActual.Format("%d", iCajaActual);
			break;
		default:
			break;
	}

	CargarDLLCS cargarDllCS;
	cargarDllCS.addParam(cIPServidorTiendaNumero);
	cargarDllCS.addParam((LPTSTR)(LPCTSTR)sTienda);
	cargarDllCS.addParam("C:\\SYS\\PROGX\\GN\\GN0261.DLL");
	cargarDllCS.addParam("AsignarRetirarDineroElectronicfo.Form1");
	cargarDllCS.addParam((LPTSTR)(LPCTSTR)cArea);
	cargarDllCS.addParam((LPTSTR)(LPCTSTR)sCajaActual);
	cargarDllCS.addParam((LPTSTR)(LPCTSTR)sCiudad);
	cargarDllCS.addParam((LPTSTR)(LPCTSTR)sCliente);
	cargarDllCS.addParam((LPTSTR)(LPCTSTR)sNomCliente);
	cargarDllCS.addParam((LPTSTR)(LPCTSTR)sReciboFin);
	cargarDllCS.addParam((LPTSTR)(LPCTSTR)sTipoMovimiento);
	cargarDllCS.addParam((LPTSTR)(LPCTSTR)sAccion);
	cargarDllCS.addParam((LPTSTR)(LPCTSTR)sCajaOriginal);

	cargarDllCS.cargarDllCS("C:\\SYS\\PROGX\\GN\\GN0261.DLL", "AsignarRetirarDineroElectronico.Form1");
}

void CDlgCapturarAbono::cargarCoppelRecompensa(int flag)
{
	char cLog[500] = { 0 };

	CString sCliente = "", sCajaActual = "", cArea = "", sReciboFin = "", sCiudad = "", sNomCliente = "", sTienda = "",
		sTipoMovimiento = "", sAccion = "", sCajaOriginal = "", jsonDatosClientes = "", sEmpleado = "", sFlagCRTP;

	sprintf_s(cLog, "FC0200805021522062 - entra - cargarCoppelRecompensa");
	grabarLog(cLog);

	grabarLog("CDlgCapturarAbono::cargarCoppelRecompensa: Inicia modulo de Coppel Recompensa GN0276");

	sTipoMovimiento = "2";
	sAccion = "1";
	sReciboFin.Format("%d", lNumeroRecibo);
	sCliente.Format("%d", lClienteDlg);
	sCiudad.Format("%d", iCiudadGnDominio);
	sTienda.Format("%ld", m_grid.iTienda);
	sEmpleado.Format("%ld", m_grid.lEmpleado);

	jsonDatosClientes.Format("%s,\"folioAbono\":%d, \"cuentas\":%s}", datosCliente, lNumeroRecibo, jsonImporte);

	//grabarLog((LPTSTR)(LPCTSTR)jsonDatosClientes);

	sFlagCRTP.Format("%d", flag);
	switch (iSistema)
	{
		case SISTEMA_MUEBLES:
			cArea = 'C';
			sCajaOriginal.Format("%d", iCajaOriginal);
			sCajaActual = "99";
			break;
		case SISTEMA_ROPA:
			cArea = 'C';
			sCajaOriginal.Format("%d", iCajaOriginal);
			sCajaActual = "98";
			break;
		case SISTEMA_CAJAS:
			cArea = 'C';
			sCajaOriginal.Format("%d", iCajaActual);
			sCajaActual.Format("%d", iCajaActual);
			break;
		default:
			cArea = 'C';
			sCajaOriginal.Format("%d", iCajaActual);
			sCajaActual.Format("%d", iCajaActual);
			break;
	}

	CargarDLLCS cargarDatosDllCS;
	cargarDatosDllCS.addParam(cIPServidorTiendaNumero);
	cargarDatosDllCS.addParam((LPTSTR)(LPCTSTR)sTienda);
	cargarDatosDllCS.addParam("C:\\sys\\PROGX\\gn\\GN0276.DLL");
	cargarDatosDllCS.addParam("ValidarCRTP.Form1");
	cargarDatosDllCS.addParam((LPTSTR)(LPCTSTR)cArea);
	cargarDatosDllCS.addParam((LPTSTR)(LPCTSTR)sCajaActual);
	cargarDatosDllCS.addParam((LPTSTR)(LPCTSTR)sCiudad);
	cargarDatosDllCS.addParam((LPTSTR)(LPCTSTR)sCliente);
	cargarDatosDllCS.addParam((LPTSTR)(LPCTSTR)sNomCliente);
	cargarDatosDllCS.addParam((LPTSTR)(LPCTSTR)sReciboFin);
	cargarDatosDllCS.addParam((LPTSTR)(LPCTSTR)sTipoMovimiento);
	cargarDatosDllCS.addParam((LPTSTR)(LPCTSTR)sAccion);
	cargarDatosDllCS.addParam((LPTSTR)(LPCTSTR)sCajaOriginal);
	cargarDatosDllCS.addParam((LPTSTR)(LPCTSTR)sFlagCRTP);
	cargarDatosDllCS.addParam((LPTSTR)(LPCTSTR)jsonDatosClientes);
	cargarDatosDllCS.addParam((LPTSTR)(LPCTSTR)sEmpleado);

	cargarDatosDllCS.cargarDllCS("C:\\sys\\PROGX\\gn\\GN0276.DLL", "ValidarCRTP.Form1");

	datosCliente = "";
	jsonImporte = "";
}

void CDlgCapturarAbono::fnLlamarCcuenta()
{
	char cLog[500] = { 0 };
	char cMensajeSeguimiento[60] = { 0 };

	sprintf_s(cLog, "FC0200805021522075 - entra - fnLlamarCcuenta");
	grabarLog(cLog);

	CCuentaWeb *pCuenta = new CCuentaWeb(m_grid.lCliente, cFechaTienda, (short)m_grid.iTienda, (short)iCiudadGnDominio, cIpServidorCartera, cIpServidorCCuentaWeb, (short)iFlagTimeOutCCuenta);

	pCuenta->leerCliente();
	pCuenta->leerTotales01();
	pCuenta->leerLineaCredito();

	lVencidoTiempoAireAsterisco = (long)pCuenta->totalesCuenta.lVencidoTotal;
	lAbonoBaseTiempoAireAsterisco = (long)pCuenta->totalesCuenta.lBaseTotal;

	memset(cMensajeSeguimiento, 0, sizeof(cMensajeSeguimiento));
	sprintf_s(cMensajeSeguimiento, "Cliente: %ld", m_grid.lCliente);
	grabarLog(cMensajeSeguimiento);

	iPorcentajeUtilizado = (int)(pCuenta->lineaCredito.lSaldoCliente / (float)pCuenta->lineaCredito.lLineadeCreditoReal) * 100;

	sprintf_s(cMensajeSeguimiento, "Respuesta... iPorcentajeUtilizado: %ld", iPorcentajeUtilizado);
	grabarLog(cMensajeSeguimiento);

	delete pCuenta;

	sprintf_s(cLog, "FC0200805021522077 - entra - fnLlamarCcuenta");
	grabarLog(cLog);
}

void CDlgCapturarAbono::menuSegurosCoppel()
{
	char cLog[500] = { 0 };
	bool bSalir = true;
	CString sTexto = "";
	char cMsgBloqueo[1024] = { 0 };

	sprintf_s(cLog, "FC0200805021522079 - entra - menuSegurosCoppel");
	grabarLog(cLog);

	while (bSalir)
	{
		char * opciones[] = { "  F1   Club de Protección Familiar",
			"  F2   Club de Protección Salud   ",
			"  F3   Auto Protección Coppel     ",
			"  F4   Reimprimir Pólizas         ",
			"  Esc  Salir                      ",
			"" };

		int respuesta[] = { F1,F2,F3,F4,ESC,0 };

		C_Menu menu(" MENU SEGUROS COPPEL ", opciones, respuesta);
		switch (menu.OpcionSeleccionada())
		{
		case F1:
			menuSegurosClub();
			break;

		case F2:
			{
				if (iFlagPlandeSalud == 1)
				{
					if (!bTieneDatosEnTemporales)
					{
						menuClubDeProteccionSalud();
					}
					else
					{
						memset(cMensaje, 0, sizeof(cMensaje));
						consultarMensaje(859, cMensaje); // "EXISTEN CAMBIOS PENDIENTES DE APLICAR, SI DESEA CONTINUAR CON LA ACTUALIZACIÓN SE DEBERÁ ELIMINAR EL RECIBO ANTERIOR"
						AfxMessageBox(cMensaje, MB_ICONINFORMATION);
						memset(cMensaje, 0, sizeof(cMensaje));
					}
				}
				else
				{
					memset(cMsgBloqueo, 0, sizeof(cMsgBloqueo));
					ConsultarCatalogoMensajeTienda(MSG_CLUBPROTECCIONSALUDDISPONIBLE, cMsgBloqueo); //3858
					sTexto.Format("%s", cMsgBloqueo);
					if (sTexto.Trim() != "")
					{
						AfxMessageBox(sTexto.Trim());
					}
				}
			}
			break;
		case F3:
			{
				if (iFlagSeguroAuto == 1)
				{
					cargarVentaSeguroAutoProteccion();
				}
				else
				{
					memset(cMsgBloqueo, 0, sizeof(cMsgBloqueo));
					ConsultarCatalogoMensajeTienda(MSG_AUTOPROTECCIONNODISPONIBLE, cMsgBloqueo); //3858
					sTexto.Format("%s", cMsgBloqueo);
					if (sTexto.Trim() != "")
					{
						AfxMessageBox(sTexto.Trim());
					}
				}

			}
			break;
		case F4:
			llamarModuloReimpresionPolizasSeguros();
			break;

		case ESC:
			m_grid.GotoCell(0, 21);
			bSalir = false;
			break;

		default:
			break;
		}
	}
}

void CDlgCapturarAbono::cargarVentaSeguroAutoProteccion()
{
	char cLog[500] = { 0 };
	char cNombreProyecto[100] = { 0 }, cNombreFuncionDLL[10] = { 0 }, cInputParam1[1024] = { 0 }, cInputParam2[1024] = { 0 },
		cOutputParam1[1024] = { 0 }, cOutputParam2[1024] = { 0 };
	int iRegresaDll = 0;

	sprintf_s(cLog, "FC0200805021522083 - entra - cargarVentaSeguroAutoProteccion");
	grabarLog(cLog);

	SParametros parametros;
	memset(&parametros, 0, sizeof(parametros));

	sprintf_s(parametros.sServer, "%s", (LPCTSTR)m_grid.sServer);
	parametros.iTienda = m_grid.iTienda;
	parametros.iCajaActual = m_grid.iCaja;
	parametros.iNumSistema = iSistema;
	parametros.lCliente = m_grid.lCliente;
	parametros.lEmpleado = m_grid.lEmpleado;
	parametros.iMuestraMsg = iMuestraMsg;
	parametros.iCiudad = 0;

	memcpy(cInputParam1, &parametros, sizeof(SParametros));
	nombreArchivo("CN0099.DLL", cNombreProyecto, DIRECTORIO_CN);
	sprintf_s(cNombreFuncionDLL, "CN0099");
	CargarDLL cargarDll(cNombreProyecto, cNombreFuncionDLL, cInputParam1, cInputParam2, cOutputParam1, cOutputParam2);
	iRegresaDll = cargarDll.getResultado();
	if (iRegresaDll <= 0)
	{
		AfxMessageBox("Ocurrio un error al llamado del modulo CN0099.DLL", MB_ICONERROR);
	}
}

void CDlgCapturarAbono::ImpresionasteriscoCoppel()
{
	char cLog[500] = { 0 };
	char cNombreFuncionDLL[10] = { 0 };
	char cInputParam1[1024] = { 0 }, cSqlTxt[255] = { 0 }, cIpServidorTienda[20] = { 0 };
	char cInputParam2[1024] = { 0 }, cEjecutable[80];
	int iFlag = 0, iTipoTienda = 0;

	sprintf_s(cLog, "FC0200805021522087 - entra - ImpresionasteriscoCoppel");
	grabarLog(cLog);

	SParametros parametros;
	memset(&parametros, 0, sizeof(SParametros));

	parametros.iTienda = m_grid.iTienda;
	parametros.lEmpleado = m_grid.lEmpleado;
	parametros.iCajaActual = m_grid.iCaja;
	parametros.iMuestraMsg = 1;

	switch (iSistema)
	{
	case 1:
		parametros.sArea[0] = 'M';
		break;
	case 2:
		parametros.sArea[0] = 'R';
		break;
	case 3:
		parametros.sArea[0] = 'C';
		break;
	default:
		parametros.sArea[0] = 'C';
		break;
	}
	parametros.lCliente = m_grid.lCliente;
	parametros.iTipoServicio = 2;
	parametros.iTipo = 1;
	parametros.iTipoCoordenada = 0;

	sprintf_s(cNombreFuncionDLL, "GN0154");
	nombreArchivo("GN0154.DLL", cEjecutable, DIRECTORIO_GN);

	parametros.iLink = generarLink();
	if (consultarIpServidores(&odbc, cIpServidorTienda, cIpServidorTienda, SERV_TIENDA_LOCAL, cSqlTxt))
	{
		sprintf_s(parametros.sServer, "%s", cIpServidorTienda);
		memcpy(cInputParam1, &parametros, sizeof(SParametros));

		CargarDLL cargarDll(cEjecutable, cNombreFuncionDLL, cInputParam1, cInputParam2);
		iFlag = cargarDll.getResultado();

		if (iFlag != 1)
		{
			AfxMessageBox("Error al consultar el módulo GN0154");
		}
	}
}

bool CDlgCapturarAbono::ConsultaFlagImpresion()
{
	char cLog[500] = { 0 };
	bool bContinua = false;
	char cSql[40] = { 0 };

	sprintf_s(cLog, "FC0200805021522091 - entra - ConsultaFlagImpresion");
	grabarLog(cLog);

	sprintf_s(cSql, "SELECT gnconsultarflag('0', '%d');", FLAG_IMPRESIONPROMOCIONAL_TA);
	CMaximo consultaflag(&odbc);

	if (consultaflag.Exec(cSql))
	{
		consultaflag.activarCols();
		if (consultaflag.leer())
		{
			if (consultaflag.Total == 1)
			{
				bContinua = true;
			}
		}
	}
	else
	{
		consultaflag.odbc->GetLastError(consultaflag.GetHstmt());
		grabarMensajeError("C", m_grid.iCaja, (LPTSTR)(LPCTSTR)m_grid.sServer, "CA0030", "CDlgCapturarAbono", "ConsultaFlagImpresion", cSql, m_grid.lEmpleado, "Error al obtener fecha salda con", consultaflag.odbc, m_grid.iMuestraMsg);
	}
	return bContinua;
}

bool CDlgCapturarAbono::obtenerFechaSaldaCon(int &iAnioSaldaCon, int &iMesSaldaCon, int &iDiaSaldaCon)
{
	char cLog[500] = { 0 };
	bool bRegresa = false;
	char cSql[70] = { 0 };

	sprintf_s(cLog, "FC0200805021522099 - entra - obtenerFechaSaldaCon");
	grabarLog(cLog);

	CFechaCoppel fechaSaldaCon(&odbc);

	if (iAnioSaldaCon == 0)
	{
		iAnioSaldaCon = iAnioActual;
	}

	if (iMesSaldaCon == 0)
	{
		iMesSaldaCon = iMesActual;
	}

	if (iDiaSaldaCon == 0)
	{
		iDiaSaldaCon = 1;
	}

	sprintf_s(cSql, "SELECT gnobtenerfechasaldacon('%04d-%02d-%02d', '%04d-%02d-%02d');", iAnioSaldaCon, iMesSaldaCon, iDiaSaldaCon, iAnioActual, iMesActual, iDiaActual);

	if (fechaSaldaCon.Exec(cSql))
	{
		fechaSaldaCon.activarCols();
		if (fechaSaldaCon.leer())
		{
			iAnioSaldaCon = fechaSaldaCon.fecha.ano();
			iMesSaldaCon = fechaSaldaCon.fecha.mes();
			iDiaSaldaCon = fechaSaldaCon.fecha.dia();

			bRegresa = true;
		}
	}
	else
	{
		fechaSaldaCon.odbc->GetLastError(fechaSaldaCon.GetHstmt());
		grabarMensajeError("C", m_grid.iCaja, (LPTSTR)(LPCTSTR)m_grid.sServer, "CA0030", "CDlgCapturarAbono", "obtenerFechaSaldaCon", cSql, m_grid.lEmpleado, "Error al obtener fecha salda con", fechaSaldaCon.odbc, m_grid.iMuestraMsg);
	}
	return bRegresa;
}

bool CDlgCapturarAbono::imprimirNotaImportante(C_FormasPCL &xHoja, int iCont)
{
	char cLog[500] = { 0 };
	int iCol = 1, iRen = 5;
	bool bRegresa = false;
	char cTextoOut[256] = { 0 }, cConsulta[512] = { 0 };
	CString sDato = "";

	sprintf_s(cLog, "FC0200805021522103 - entra - imprimirNotaImportante");
	grabarLog(cLog);

	if (iCont == 0)
	{
		xHoja.poner("PARA EL CLIENTE", iRen, iCol);
		iRen++;
	}
	else
	{
		xHoja.poner("PARA PUBLICIDAD", iRen, iCol);
		iRen++;
		iRen++;

	}
	sprintf_s(cConsulta, "SELECT catMod.idu_modulopolizaclub, catMsg.idu_mensajepolizaclub, catMsg.desc_mensaje"
		" FROM cat_modulospolizaclub catMod"
		" INNER JOIN cat_mensajespolizaclub catMsg ON catMod.idu_modulopolizaclub = catMsg.idu_modulopolizaclub"
		" AND catMod.idu_tipoImpresion = catMsg.idu_tipoImpresion AND catMod.nom_area = catMsg.nom_area"
		" WHERE catMod.idu_modulopolizaclub IN (%d) AND catMod.idu_tipoImpresion = %d AND catMod.nom_area = 'C'"
		" ORDER BY catMod.idu_modulopolizaclub ASC, catMsg.idu_mensajepolizaclub ASC;", SECCION_7, MATRICIAL);

	CConsultarDescripcionClub ConsultaDescImpresion(&odbc);

	if (ConsultaDescImpresion.Exec(cConsulta))
	{
		ConsultaDescImpresion.activarCols();
		while (ConsultaDescImpresion.leer())
		{
			memset(cTextoOut, 0, sizeof(cTextoOut));
			sDato.Format("%s", ConsultaDescImpresion.desc_mensaje);
			sDato.Trim();
			sDato.Replace('¿', '¨');
			sprintf_s(cTextoOut, "%s", (LPCTSTR)sDato);
			ponerAcento(cTextoOut);
			xHoja.poner(cTextoOut, iRen, iCol);
			iRen++;
			bRegresa = true;
		}
		if (bRegresa)
		{
			finHoja(xHoja);
		}
	}
	else
	{
		ConsultaDescImpresion.odbc->GetLastError(ConsultaDescImpresion.GetHstmt());
		grabarMensajeError("C", m_grid.iCaja, (LPTSTR)(LPCTSTR)m_grid.sServer, "CA0030", "CDlgCapturarAbono", "imprimirNotaImportante", cConsulta, m_grid.lEmpleado, "ERROR AL OBTENER IMPRESION", ConsultaDescImpresion.odbc, m_grid.iMuestraMsg);
		bRegresa = false;
	}
	return bRegresa;
}

void CDlgCapturarAbono::procesoGrabarGnTira(int iTipoImpresora)
{
	char cLog[500] = { 0 };
	char cSql[255] = { 0 }, cArchivoBorra2[50] = { 0 }, cRutaImagen[50] = { 0 };
	long lFolio = 0L;
	bool bContinuar = false;

	sprintf_s(cLog, "FC0200805021522107 - entra - procesoGrabarGnTira");
	grabarLog(cLog);

	sprintf_s(cSql, "SELECT folio FROM crseguros WHERE claveseguro = 'C' and cliente = %ld", m_grid.lCliente);

	CMaximo crSegurosSQL(&odbc_1);
	if (crSegurosSQL.Exec(cSql))
	{
		crSegurosSQL.activarCols();
		if (crSegurosSQL.Leer())
		{
			lFolio = crSegurosSQL.Total;
			bContinuar = true;
		}
	}
	else
	{
		crSegurosSQL.odbc->GetLastError(crSegurosSQL.GetHstmt());
		grabarMensajeError("C", m_grid.iCaja, (LPTSTR)(LPCTSTR)m_grid.sServer, "CapturarAbono", "CDlgCapturarAbono", "procesoGrabarGnTira", cSql, m_grid.lEmpleado, "ERROR EN LA CONSULTA(tieneseguroclub)", crSegurosSQL.odbc, m_grid.iMuestraMsg);
		bContinuar = false;

	}
	if (bContinuar)
	{
		memset(cArchivoBorra2, ' ', 50);
		sprintf_s(cArchivoBorra2, "c:\\sys\\mem\\tiras.log");

		if (_access(cArchivoBorra2, 0) == 0)
		{
			_unlink(cArchivoBorra2);
		}

		sprintf_s(cRutaImagen, "c:\\sys\\mem\\PolizaClub.PRN");

		if (_access(cRutaImagen, 0) == 0)
		{
			if (!grabarGnTira("C", 65, 0, cRutaImagen, iDiaActual, iMesActual, iAnioActual, &odbc, cSql, m_grid.iCaja, lFolio, iTipoImpresora, m_grid.lEmpleado, 0, 1))
			{
				grabarMensajeError("C", m_grid.iCaja, (LPTSTR)(LPCTSTR)m_grid.sServer, "CapturarAbono", "CDlgCapturarAbono", "procesoGrabarGnTira", "Ocurrio un Error al Grabar la Imagen de Impresion", m_grid.lEmpleado, "Ocurrio un Error al Grabar la Imagen de Impresion", &odbc, m_grid.iMuestraMsg);
			}
		}
	}
}

bool CDlgCapturarAbono::consultarEdadesSeguroClub(short iTipoSeguro)
{
	char cLog[500] = { 0 };
	bool bRegresa = true;

	sprintf_s(cLog, "FC0200805021522111 - entra - consultarEdadesSeguroClub");
	grabarLog(cLog);

	if (abrirConexionBD(&odbc_1, cIpServidorCartera, cIpServidorCartera, CONECTA_CARTERA, m_grid.iTienda))
	{
		char cSql[85] = { 0 };

		CConsultarEdadesClub edades(&odbc_1);

		sprintf_s(cSql, "SELECT edadminima, edadmaxima, edadmaximaabono FROM fun_obteneredadesseguro('%d')", iTipoSeguro);

		if (edades.Exec(cSql))
		{
			edades.activarCols();
			if (edades.leer())
			{
				if (iTipoSeguro == 1)
				{
					iEdadMinimaClub = edades.edadminima;
					iEdadMaximaClub = edades.edadmaxima;
					iEdadMaximaAbonoClub = edades.edadmaximaabono;
				}
				else
				{
					iEdadMaximaClubAdicional = edades.edadmaxima;
					iEdadMaximaAbonoClubAdic = edades.edadmaximaabono;
				}
			}
		}
		else
		{
			bRegresa = false;
			edades.odbc->GetLastError(edades.GetHstmt());
			grabarMensajeError("C", iCajaDlg, cIpServidorCartera, "CA0030", "CDlgCapturarAbono", "consultarEdadesSeguroClub", cSql, lEmpleadoDlg, "Error al Consultar Edades Seguro Club", edades.odbc, iMuestraMsg);
		}
	}
	else
	{
		AfxMessageBox("Error al abrir conexión BD CARTERA");
	}
	cerrarConexionBD(&odbc_1);
	return bRegresa;
}

bool CDlgCapturarAbono::consultarPrecioSeguroClub(long &lPrecioSeguroClub, short iSeguros, short iTipoSeguro, short iEdadAdicional)
{
	char cLog[500] = { 0 };
	bool bRegresa = true;
	char cSql[180] = { 0 };
	short iFlagVenta = 0;

	sprintf_s(cLog, "FC0200805021522115 - entra - consultarPrecioSeguroClub");
	grabarLog(cLog);

	CConsultarPrecioSeguroClub precio(&odbc_1);

	if (!bBanderaTieneClub || iSeguroVigente == 0)
	{
		iFlagVenta = 1;
	}

	sprintf_s(cSql, "SELECT precioseguro, montoseguro, maximoseguros, planseguro FROM fun_consultarPlanesSeguroClub01( '%04d-%02d-%02d', '%ld', '%d', '1', '%d', '%d', '%d' )", iAnioActual, iMesActual, iDiaActual, m_grid.lCliente, iSeguros, iTipoSeguro, iEdadAdicional, iFlagVenta);
	grabarLog(cSql);
	if (precio.Exec(cSql))
	{
		precio.activarCols();
		if (precio.leer())
		{
			lPrecioSeguroClub = precio.precioseguro;
			sprintf_s(cMensaje, "consultarPrecioSeguroClub:Consulta precios seguro precio seguro %ld", lPrecioSeguroClub);
			grabarLog(cMensaje);

			if (iTipoSeguro == 1)
			{
				sprintf_s(cPlanSeguroClub, "%s", CString(precio.planseguro).Trim());
			}
		}
	}
	else
	{
		bRegresa = false;
		precio.odbc->GetLastError(precio.GetHstmt());
		grabarMensajeError("C", iCajaDlg, (LPTSTR)(LPCTSTR)odbc_1.m_strServer, "CA0030", "CDlgCapturarDatosSeguro", "consultarPrecioSeguroClub", cSql, lEmpleadoDlg, "Error al Consultar Precio Seguro Club", precio.odbc, iMuestraMsg);
	}
	return bRegresa;
}

bool CDlgCapturarAbono::consultarMontoSeguroClub(long &lMontoSeguroClub, short iSeguros, short iTipoSeguro, short iEdadAdicional)
{
	char cLog[500] = { 0 };
	bool bRegresa = true;
	char cSql[160] = { 0 };

	sprintf_s(cLog, "FC0200805021522119 - entra - consultarMontoSeguroClub");
	grabarLog(cLog);

	CConsultarPrecioSeguroClub precio(&odbc_1);

	sprintf_s(cSql, "SELECT precioseguro, montoseguro, maximoseguros FROM fun_consultarPlanesSeguroClub01( '%04d-%02d-%02d', '%ld', '%d', '1', '%d', '%d' )", iAnioActual, iMesActual, iDiaActual, m_grid.lCliente, iSeguros, iTipoSeguro, iEdadAdicional);

	if (precio.Exec(cSql))
	{
		precio.activarCols();
		if (precio.leer())
		{
			lMontoSeguroClub = precio.montoseguro;
		}
	}
	else
	{
		bRegresa = false;
		precio.odbc->GetLastError(precio.GetHstmt());
		grabarMensajeError("C", iCajaDlg, (LPTSTR)(LPCTSTR)odbc_1.m_strServer, "CA0030", "CDlgCapturarDatosSeguro", "consultarMontoSeguroClub", cSql, lEmpleadoDlg, "Error al Consultar monto Seguro Club", precio.odbc, iMuestraMsg);
	}
	return bRegresa;
}

/*
Funcion para recalcular el precio de los seguros adicionales, ya que despues de capturar un adicional
se puede modificar el numero de meses del titular y comprar mas adicionales y no se actualiza el importe
que realmente debe pagar el cliente
*/
bool CDlgCapturarAbono::obtenerPreciosSegurosAdicionales(long &lPrecioSeguroClub)
{
	char cLog[500] = { 0 };
	char cSql[160] = { 0 };
	int iEdadAdicional = 0;
	long lCuotaAdicional = 0;
	bool bRegresa = true;

	sprintf_s(cLog, "FC0200805021522123 - entra - obtenerPreciosSegurosAdicionales");
	grabarLog(cLog);

	CConsultarDatosSeguroAdicional precioadicional(&odbc);

	sprintf_s(cSql, "SELECT cantidadseguros, fecnacadic FROM tmpcacarmovseguros WHERE cliente = %ld and clave='G' and tienda=%d and caja=%d and folio = 0;", m_grid.lCliente, m_grid.iTienda, m_grid.iCaja);

	if (precioadicional.Exec(cSql))
	{
		precioadicional.activarCols();

		while (precioadicional.Leer())
		{
			//Se calcula la edad del adicional
			iEdadAdicional = iAnioActual - precioadicional.fecnacadic.ano();
			if (iMesActual < precioadicional.fecnacadic.mes() || (iMesActual == precioadicional.fecnacadic.mes() && iDiaActual < precioadicional.fecnacadic.dia()))
			{
				iEdadAdicional--;
			}

			consultarPrecioSeguroClub(lCuotaAdicional, precioadicional.cantidadseguros, 2, (short)iEdadAdicional);

			lPrecioSeguroClub += lCuotaAdicional;
		}
	}
	else
	{
		bRegresa = false;
		precioadicional.odbc->GetLastError(precioadicional.GetHstmt());
		grabarMensajeError("C", iCajaDlg, (LPTSTR)(LPCTSTR)odbc_1.m_strServer, "CA0030", "CDlgCapturarDatosSeguro", "obtenerPreciosAdicionales", cSql, lEmpleadoDlg, "Error al Consultar Precio Seguro Club Adicional", precioadicional.odbc, iMuestraMsg);
	}
	return bRegresa;
}

/*
Funcion para obtener el numero maximo de seguros que puede tener un seguro adicional,
esto se hizo para que cuando el seguro este  vencido y el cliente ya no puede comprar
la cantidad de seguros se le baje automaticamente al maximo que puede tener
*/
bool CDlgCapturarAbono::consultarMaximoSegurosClubAdicional(short &iMaximoSeguros, short iSeguros, short iTipoSeguro, short iEdadAdicional)
{
	char cLog[500] = { 0 };
	bool bRegresa = true;
	char cSql[170] = { 0 };
	short iFlagVenta = 0;

	sprintf_s(cLog, "FC0200805021522127 - entra - consultarMaximoSegurosClubAdicional");
	grabarLog(cLog);

	CConsultarPrecioSeguroClub seguros(&odbc_1);

	if (!bBanderaTieneClub || iSeguroVigente == 0)
	{
		iFlagVenta = 1;
	}

	sprintf_s(cSql, "SELECT precioseguro, montoseguro, maximoseguros FROM fun_consultarPlanesSeguroClub01('%04d-%02d-%02d','%ld','%d','1','%d','%d','%d')", iAnioActual, iMesActual, iDiaActual, m_grid.lCliente, iSeguros, iTipoSeguro, iEdadAdicional, iFlagVenta);

	if (seguros.Exec(cSql))
	{
		seguros.activarCols();
		if (seguros.leer())
		{
			iMaximoSeguros = seguros.maximoseguros;
		}
	}
	else
	{
		bRegresa = false;
		seguros.odbc->GetLastError(seguros.GetHstmt());
		grabarMensajeError("C", iCajaDlg, (LPTSTR)(LPCTSTR)odbc_1.m_strServer, "CA0030", "CDlgCapturarDatosSeguro", "consultarMaximoSegurosClubAdicional", cSql, lEmpleadoDlg, "Error al Consultar Número Maximo de Seguros Adicional", seguros.odbc, iMuestraMsg);
	}
	return bRegresa;
}

void CDlgCapturarAbono::consultarMensajeSeguro()
{
	char cLog[500] = { 0 };
	char cSql[70] = { 0 };

	sprintf_s(cLog, "FC0200805021522131 - entra - consultarMensajeSeguro");
	grabarLog(cLog);

	CConsultarMensajeSeguro mensaje(&odbc);

	sprintf_s(cSql, "SELECT des_mensaje FROM cat_mensajes WHERE idu_tipomensaje = 378");

	//Mensaje por default
	sprintf_s(cMensajeSeguro, "Estimado Cliente: Por el momento no le podemos realizar este movimiento del Club de Protección Familiar en Tienda Coppel,\nya que aparece con Estatus de Pendiente, favor de dirigirse a ventanillas de sucursal Bancoppel.");

	if (mensaje.Exec(cSql))
	{
		mensaje.activarCols();
		if (mensaje.leer())
		{
			sprintf_s(cMensajeSeguro, mensaje.des_mensaje);
		}
	}
	else
	{
		mensaje.odbc->GetLastError(mensaje.GetHstmt());
		grabarMensajeError("C", iCajaDlg, (LPTSTR)(LPCTSTR)odbc.m_strServer, "CA0030", "CDlgCapturarAbono", "consultarMensajeSeguro", cSql, lEmpleadoDlg, "ERROR EN LA CONSULTA", mensaje.odbc, iMuestraMsg);
	}
}

bool CDlgCapturarAbono::grabarBeneficiariosCartera()
{
	char cLog[500] = { 0 };
	bool bRegresa = true;

	sprintf_s(cLog, "FC0200805021522135 - entra - grabarBeneficiariosCartera");
	grabarLog(cLog);

	if (iFoliosSegurosActual[1] != 0)
	{
		for (int i = 1; i < 16; i++)
		{
			if (iFoliosSegurosActual[i] != 0 && iFoliosSegurosAdicionales[i] != 0)
			{
				//Si realizo cambio de plan
				if (iFoliosSegurosActual[i] != iFoliosSegurosAdicionales[i])
				{
					iCambioPlanSeguroClub = 1;
					break;
				}
			}
			else
			{
				break;
			}
		}
	}

	//Si Compro seguro club titular o adicional o realizo cambio de plan
	if (iFlagCapturoBeneficiariosClubNuevo == 2 || iFlagCapturoSeguroAdicional == 1 || iCambioPlanSeguroClub == 1)
	{
		bool bEsCambioPlanSeguro = false;
		long lFolioPoliza = 0L;
		char cSql[800] = { 0 };

		iTipoSeguroPF = 0;

		sprintf_s(cSql, "SELECT TRIM(nombre1) AS nombre1, TRIM(apellidopaterno1) AS apellidopaterno1, TRIM(apellidomaterno1) AS apellidomaterno1, porcentaje1, parentesco1, num_telefono1 AS telefono1, fec_nacimiento1 AS fechanacimiento1,"
			"TRIM(nombre2) AS nombre2, TRIM(apellidopaterno2) AS apellidopaterno2, TRIM(apellidomaterno2) AS apellidomaterno2, porcentaje2, parentesco2, num_telefono2 AS telefono2, fec_nacimiento2 AS fechanacimiento2,"
			"TRIM(nombre3) As nombre3, TRIM(apellidopaterno3) AS apellidopaterno3, TRIM(apellidomaterno3) AS apellidomaterno3, porcentaje3, parentesco3, num_telefono3 AS telefono3, fec_nacimiento3 AS fechanacimiento3,"
			"TRIM(tiposeguro) as tiposeguro, folio "
			"FROM fun_consultartdbeneficiarios('%ld','0','%d','%04d-%02d-%02d','%ld');", m_grid.lCliente, m_grid.iCaja, iAnioActual, iMesActual, iDiaActual, lNumeroRecibo);

		grabarLog(cSql);
		grabarLogBeneficiarios(cSql); 

		CConsultarBeneficiario beneficiarios(&odbc);

		if (beneficiarios.Exec(cSql))
		{
			beneficiarios.activarCols();
			while (beneficiarios.leer())
			{
				bEsCambioPlanSeguro = false;

				sprintf_s(cNombreBeneficiario1, beneficiarios.nombre1);
				sprintf_s(cApPatBeneficiario1, beneficiarios.apellidopaterno1);
				sprintf_s(cApMatBeneficiario1, beneficiarios.apellidomaterno1);
				iPorcentaje1 = beneficiarios.porcentaje1;
				iParentesco1 = beneficiarios.parentesco1;
				sprintf_s(cNombreBeneficiario2, beneficiarios.nombre2);
				sprintf_s(cApPatBeneficiario2, beneficiarios.apellidopaterno2);
				sprintf_s(cApMatBeneficiario2, beneficiarios.apellidomaterno2);
				iPorcentaje2 = beneficiarios.porcentaje2;
				iParentesco2 = beneficiarios.parentesco2;
				sprintf_s(cNombreBeneficiario3, beneficiarios.nombre3);
				sprintf_s(cApPatBeneficiario3, beneficiarios.apellidopaterno3);
				sprintf_s(cApMatBeneficiario3, beneficiarios.apellidomaterno3);
				iPorcentaje3 = beneficiarios.porcentaje3;
				iParentesco3 = beneficiarios.parentesco3;

				iTipoSeguroPF = (short)atoi(beneficiarios.tiposeguro);

				lTelefono1 = beneficiarios.telefono1;
				lTelefono2 = beneficiarios.telefono2;
				lTelefono3 = beneficiarios.telefono3;

				iMesNacimiento1 = beneficiarios.fechanacimiento1.mes();
				iMesNacimiento2 = beneficiarios.fechanacimiento2.mes();
				iMesNacimiento3 = beneficiarios.fechanacimiento3.mes();

				iAnioNacimiento1 = beneficiarios.fechanacimiento1.ano();
				iAnioNacimiento2 = beneficiarios.fechanacimiento2.ano();
				iAnioNacimiento3 = beneficiarios.fechanacimiento3.ano();

				iDiaNacimiento1 = beneficiarios.fechanacimiento1.dia();
				iDiaNacimiento2 = beneficiarios.fechanacimiento2.dia();
				iDiaNacimiento3 = beneficiarios.fechanacimiento3.dia();
				lFolioPoliza = beneficiarios.folio;

				for (int i = 0; i < 16; i++)
				{
					if (iFoliosSegurosActual[i] != 0)
					{
						if (iFoliosSegurosAdicionales[i] == lFolioPoliza)
						{
							//Si realizo cambio de plan
							if (iFoliosSegurosActual[i] != iFoliosSegurosAdicionales[i])
							{
								lFolioNuevo = iFoliosSegurosAdicionales[i];
								lFolioAnterior = iFoliosSegurosActual[i];
								bEsCambioPlanSeguro = true;
							}
							break;
						}
					}
					else
					{
						break;
					}
				}

				if (bEsCambioPlanSeguro)// 9923--> Fue cambio de plan
				{
					// Remplazar folio y generar movimiento del cambio de plan
					bRegresa = realizarProcesoCambioPolizaSeguro(lFolioAnterior, lFolioNuevo);
				}
				else
				{
					bRegresa = grabarBeneficiariosCartera(lFolioPoliza);
				}
			}
		}
		else
		{
			bRegresa = false;
			beneficiarios.odbc->GetLastError(beneficiarios.GetHstmt());
			grabarMensajeError("C", m_grid.iCaja, (LPTSTR)(LPCTSTR)odbc.m_strServer, "CA0030", "CDlgCapturarAbono", "consultarTdBenficiarios", cSql, lEmpleadoDlg, "ERROR AL EJECUTAR LA FUNCION FUN_CONSULTARTDBENEFICIARIOS", beneficiarios.odbc, iMuestraMsg);
		}
	}
	return bRegresa;
}

//9923 --> Modificar para grabar en central
bool CDlgCapturarAbono::grabarBeneficiariosCartera(long lFolio)
{
	char cLog[500] = { 0 };
	bool bRegresa = false;
	char cSql[1500] = { 0 }, cXml[1300] = { 0 }, cSql1[1500] = { 0 }, cSql2[3000] = { 0 }, cSql3[3000] = { 0 };

	CConsultarBeneficiario beneficiarios(&odbc);
	sprintf_s(cLog, "FC0200805021522141 - entra - grabarBeneficiariosCartera ( lFolio=%ld )", lFolio);
	grabarLog(cLog);
	grabarLogBeneficiarios(cLog);

	generarXMLBeneficiarios(lFolio, cXml);
	CMaximo grabarBeneficiario(&odbc_1, false);
	grabarLog("Inicia Grabado de fun_crGrabarBeneficiariosSeguro");
	grabarLogBeneficiarios("Inicia Grabado de fun_crGrabarBeneficiariosSeguro");
	sprintf_s(cSql, "SELECT ((XPATH('//status/text()', fun_crGrabarBeneficiariosSeguro('%s')))[1]::TEXT)::INT4", cXml);
	grabarLog(cSql);
	grabarLogBeneficiarios(cSql);

	if (grabarBeneficiario.Exec(cSql))
	{
		grabarBeneficiario.activarCols();
		if (grabarBeneficiario.Leer())
		{
			if (grabarBeneficiario.Total == 1)
			{
				bRegresa = true;
			}
			else
			{
				grabarLog(cSql);
				grabarLogBeneficiarios(cSql);
				grabarMensajeError("C", m_grid.iCaja, (LPTSTR)(LPCTSTR)odbc.m_strServer, "CA0030", "CDlgCapturarAbono", "grabarBeneficiariosCartera", cSql, lEmpleadoDlg, "ERROR AL GRABAR BENEFICIARIOS EN CARTERAS", grabarBeneficiario.odbc, iMuestraMsg);
			}
		}
	}
	else
	{
		grabarBeneficiario.odbc->GetLastError(grabarBeneficiario.GetHstmt());
		grabarMensajeError("C", m_grid.iCaja, (LPTSTR)(LPCTSTR)odbc.m_strServer, "CA0030", "CDlgCapturarAbono", "grabarBeneficiariosCartera", cSql, lEmpleadoDlg, "ERROR AL GRABAR BENEFICIARIOS EN CARTERAS", grabarBeneficiario.odbc, iMuestraMsg);
	}
	//|----------------------->Funcion que inserta en la tabla mov_tdbeneficiariostemporalhistorica<-----------------------|
	CMaximo grabarBeneficiarioHistorica(&odbc, false);
	grabarLog("Inicia Grabado de fun_guardarbeneficiariostemporalhistorica Beneficiario 1");
	grabarLogBeneficiarios("Inicia Grabado de fun_guardarbeneficiariostemporalhistorica Beneficiario 1");
	//Beneficiario 1
	sprintf_s(cSql1, "SELECT fun_guardarbeneficiariostemporalhistorica(%ld, 1::SMALLINT, %ld, %d, '%s', '%s', '%s', '%04d-%02d-%02d'::DATE, %d::SMALLINT, 1::SMALLINT, %d::SMALLINT, 0::BIGINT, current_date, 26::SMALLINT, %d::SMALLINT, %d::SMALLINT, %d, '')", 
		m_grid.lCliente, lFolio, iTipoSeguroPF, cNombreBeneficiario1, cApPatBeneficiario1, cApMatBeneficiario1, iAnioNacimiento1, iMesNacimiento1, iDiaNacimiento1, iPorcentaje1, iParentesco1, m_grid.iTienda, m_grid.iCaja, lNumeroRecibo);
	grabarLog(cSql1);
	grabarLogBeneficiarios(cSql1);

	//Grabado en las tablas
	if (grabarBeneficiarioHistorica.Exec(cSql1))
	{
		grabarBeneficiarioHistorica.activarCols();
		if (grabarBeneficiarioHistorica.Leer())
		{
			if (grabarBeneficiarioHistorica.Total == 1)
			{
				grabarLog("TODO ESTA CORRECTO");

				grabarLogBeneficiarios("TODO ESTA CORRECTO");
			}
			else
			{
				grabarLog(cSql1);
				grabarMensajeError("C", m_grid.iCaja, (LPTSTR)(LPCTSTR)odbc.m_strServer, "CA0030", "CDlgCapturarAbono", "grabarBeneficiariosCartera", cSql1, lEmpleadoDlg, "ERROR AL GRABAR BENEFICIARIOS EN CARTERAS", grabarBeneficiarioHistorica.odbc, iMuestraMsg);
			}
		}
	}
	else
	{
		grabarBeneficiarioHistorica.odbc->GetLastError(grabarBeneficiarioHistorica.GetHstmt());
		grabarMensajeError("C", m_grid.iCaja, (LPTSTR)(LPCTSTR)odbc.m_strServer, "CA0030", "CDlgCapturarAbono", "grabarBeneficiariosCartera", cSql1, lEmpleadoDlg, "ERROR AL GRABAR BENEFICIARIOS EN CARTERAS", grabarBeneficiarioHistorica.odbc, iMuestraMsg);
	}

	//Beneficiario 2
	CMaximo grabarBeneficiarioHistorica2(&odbc, false);
	grabarLog("Inicia Grabado de fun_guardarbeneficiariostemporalhistorica Beneficiario 2");
	grabarLogBeneficiarios("Inicia Grabado de fun_guardarbeneficiariostemporalhistorica Beneficiario 2");
	sprintf_s(cSql2, "SELECT fun_guardarbeneficiariostemporalhistorica(%ld, 1::SMALLINT, %ld, %d, '%s', '%s', '%s', '%04d-%02d-%02d'::DATE, %d::SMALLINT, 2::SMALLINT, %d::SMALLINT, 0::BIGINT, current_date, 26::SMALLINT, %d::SMALLINT, %d::SMALLINT, %d, '')", 
		m_grid.lCliente, lFolio, iTipoSeguroPF, cNombreBeneficiario2, cApPatBeneficiario2, cApMatBeneficiario2, iAnioNacimiento2, iMesNacimiento2, iDiaNacimiento2, iPorcentaje2, iParentesco2, m_grid.iTienda, m_grid.iCaja, lNumeroRecibo);
	grabarLog(cSql2);
	grabarLogBeneficiarios(cSql2);
	if (grabarBeneficiarioHistorica2.Exec(cSql2))
	{
		grabarBeneficiarioHistorica2.activarCols();
		if (grabarBeneficiarioHistorica2.Leer())
		{
			if (grabarBeneficiarioHistorica2.Total == 1)
			{
				grabarLog("TODO ESTA CORRECTO");
				grabarLogBeneficiarios("TODO ESTA CORRECTO");
			}
			else
			{
				grabarLog(cSql2);
				grabarMensajeError("C", m_grid.iCaja, (LPTSTR)(LPCTSTR)odbc.m_strServer, "CA0030", "CDlgCapturarAbono", "grabarBeneficiariosCartera", cSql2, lEmpleadoDlg, "ERROR AL GRABAR BENEFICIARIOS EN CARTERAS", grabarBeneficiarioHistorica2.odbc, iMuestraMsg);
			}
		}
	}
	else
	{
		grabarBeneficiarioHistorica2.odbc->GetLastError(grabarBeneficiarioHistorica2.GetHstmt());
		grabarMensajeError("C", m_grid.iCaja, (LPTSTR)(LPCTSTR)odbc.m_strServer, "CA0030", "CDlgCapturarAbono", "grabarBeneficiariosCartera", cSql2, lEmpleadoDlg, "ERROR AL GRABAR BENEFICIARIOS EN CARTERAS", grabarBeneficiarioHistorica2.odbc, iMuestraMsg);
	}

	//Beneficiarios 3
	CMaximo grabarBeneficiarioHistorica3(&odbc, false);
	grabarLog("Inicia Grabado de fun_guardarbeneficiariostemporalhistorica Beneficiario 3");
	grabarLogBeneficiarios("Inicia Grabado de fun_guardarbeneficiariostemporalhistorica Beneficiario 3");
	sprintf_s(cSql3, "SELECT fun_guardarbeneficiariostemporalhistorica(%ld, 1::SMALLINT, %ld, %d, '%s', '%s', '%s', '%04d-%02d-%02d'::DATE, %d::SMALLINT, 3::SMALLINT, %d::SMALLINT, 0::BIGINT, current_date, 26::SMALLINT, %d::SMALLINT, %d::SMALLINT, %d, '')", 
		m_grid.lCliente, lFolio, iTipoSeguroPF, cNombreBeneficiario3, cApPatBeneficiario3, cApMatBeneficiario3, iAnioNacimiento3, iMesNacimiento3, iDiaNacimiento3, iPorcentaje3, iParentesco3,  m_grid.iTienda, m_grid.iCaja, lNumeroRecibo);
	if(strcmp(cNombreBeneficiario3, "") != 0)
	{
		grabarLog(cSql3);
		grabarLogBeneficiarios(cSql3);

		if (grabarBeneficiarioHistorica3.Exec(cSql3))
		{
			grabarBeneficiarioHistorica3.activarCols();
			if (grabarBeneficiarioHistorica3.Leer())
			{
				if (grabarBeneficiarioHistorica3.Total == 1)
				{
					grabarLog("TODO ESTA CORRECTO");
					grabarLogBeneficiarios("TODO ESTA CORRECTO");
				}
				else
				{
					grabarLog(cSql3);
					grabarMensajeError("C", m_grid.iCaja, (LPTSTR)(LPCTSTR)odbc.m_strServer, "CA0030", "CDlgCapturarAbono", "grabarBeneficiariosCartera", cSql3, lEmpleadoDlg, "ERROR AL GRABAR BENEFICIARIOS EN CARTERAS", grabarBeneficiarioHistorica3.odbc, iMuestraMsg);
				}
			}
		}
		else
		{
			grabarBeneficiarioHistorica3.odbc->GetLastError(grabarBeneficiarioHistorica3.GetHstmt());
			grabarMensajeError("C", m_grid.iCaja, (LPTSTR)(LPCTSTR)odbc.m_strServer, "CA0030", "CDlgCapturarAbono", "grabarBeneficiariosCartera", cSql3, lEmpleadoDlg, "ERROR AL GRABAR BENEFICIARIOS EN CARTERAS", grabarBeneficiarioHistorica3.odbc, iMuestraMsg);
		}
	}
	else
	{
		grabarLog("No se Guardo Beneficiario 3");
		grabarLogBeneficiarios("No se Guardo Beneficiario 3");
	}
	return bRegresa;
}

bool CDlgCapturarAbono::funVerificarFoco(long lCampo)
{
	char cLog[500] = { 0 };

	sprintf_s(cLog, "FC0200805021522145 - entra - funVerificarFoco");
	grabarLog(cLog);

	bool bRegresa = false;
	CWnd *pWnd = GetFocus();

	if (pWnd->GetDlgCtrlID() == lCampo)
	{
		bRegresa = true;
	}
	return bRegresa;
}

void CDlgCapturarAbono::grabarLog(char *cTexto)
{
	/*
	char sArch[80] = { 0 };
	int iTamanio = strlen(cTexto) + 100;
	char *cTextoGrabar = new char[iTamanio];
	memset(cTextoGrabar, 0, iTamanio);
	CTime tFecha = CTime::GetCurrentTime();

	sprintf_s(sArch, "C:\\sys\\mem\\CapturarAbonos%02d%02d.log", tFecha.GetMonth(), tFecha.GetDay());

	sprintf_s(cTextoGrabar, iTamanio, "%04d-%02d-%02d %02d:%02d:%02d %s\n", tFecha.GetYear(), tFecha.GetMonth(), tFecha.GetDay(), tFecha.GetHour(), tFecha.GetMinute(), tFecha.GetSecond(), cTexto);
	C_Archivo arch(sArch, &cTextoGrabar, sizeof(cTextoGrabar));
	arch.posicionar((long)0, BASE_FINAL);
	arch.grabar(cTextoGrabar, (unsigned int)strlen(cTextoGrabar));

	delete[]cTextoGrabar;
	*/

	util.GrabarLog(cTexto);
}
void CDlgCapturarAbono::grabarLogBeneficiarios(char *cTexto) 
{
	char sArch[80] = { 0 };
	int iTamanio = strlen(cTexto) + 100;
	char *cTextoGrabar = new char[iTamanio];
	memset(cTextoGrabar, 0, iTamanio);
	CTime tFecha = CTime::GetCurrentTime();

	sprintf_s(sArch, "C:\\sys\\mem\\ClubProteccionFamiliarBeneficiarios_CA0030_%02d%02d.log", tFecha.GetMonth(), tFecha.GetDay());

	sprintf_s(cTextoGrabar, iTamanio, "%04d-%02d-%02d %02d:%02d:%02d %s\n", tFecha.GetYear(), tFecha.GetMonth(), tFecha.GetDay(), tFecha.GetHour(), tFecha.GetMinute(), tFecha.GetSecond(), cTexto);
	C_Archivo arch(sArch, &cTextoGrabar, sizeof(cTextoGrabar));
	arch.posicionar((long)0, BASE_FINAL);
	arch.grabar(cTextoGrabar, (unsigned int)strlen(cTextoGrabar));

	delete[]cTextoGrabar;
}
bool CDlgCapturarAbono::ValidarSituacionEspecial(long lCliente, int iReglaConsulta, int iProcesoConsulta, int iArea)
{
	char cLog[500] = { 0 };
	bool bRegresa = true;
	char cSql[100] = { 0 };

	sprintf_s(cLog,
		"FC0200805021522149 - entra - ValidarSituacionEspecial(lCliente=%ld, iReglaConsulta=%d, iProcesoConsulta=%d, iArea=%d)",
		lCliente, iReglaConsulta, iProcesoConsulta, iArea);
	grabarLog(cLog);

	sprintf_s(cSql, "SELECT fun_validarsituacionespecial('%d','%d', '%d', '%ld');", iProcesoConsulta, iReglaConsulta, iArea, lCliente);

	CMaximo flagCoppel(&odbc_1);
	if (flagCoppel.Exec(cSql))
	{
		flagCoppel.activarCols();
		if (flagCoppel.Leer())
		{
			if (flagCoppel.Total == 1)
			{
				bRegresa = true;
			}
			else
			{
				bRegresa = false;
			}
		}
	}
	else
	{
		flagCoppel.odbc->GetLastError(flagCoppel.GetHstmt());
		grabarMensajeError("C", m_grid.iCaja, (LPTSTR)(LPCTSTR)odbc.m_strServer,
			"CA0030", "CDlgCapturarAbono", "grabarBeneficiariosCartera", "", lEmpleadoDlg,
			"ERROR AL consultar validacion de situacion especial", &odbc, iMuestraMsg);
	}
	return bRegresa;
}

bool CDlgCapturarAbono::ConsultaMarcarSituacionEspecial(int iReglaConsulta, int iProcesoConsulta, char *cSituacionEspecial, int &iIdSituacion)
{
	char cLog[500] = { 0 };
	bool bRegresa = true;

	char cSql[110] = { 0 };

	sprintf_s(cLog, "FC0200805021522155 - entra - ConsultaMarcarSituacionEspecial");
	grabarLog(cLog);

	sprintf_s(cSql, "SELECT idsituacion, clvsituacion, numcausasituacion FROM fun_traerrespuestaregla('%d','%d','3');",
		iReglaConsulta, iProcesoConsulta);

	CConsultaSituacionCausa flagCoppel(&odbc_1);
	if (flagCoppel.Exec(cSql))
	{
		flagCoppel.activarCols();
		if (flagCoppel.Leer())
		{
			iIdSituacion = flagCoppel.idsituacion;
			cSituacionEspecial[0] = flagCoppel.clvsituacion;
			iCausaSituacion = (short)flagCoppel.numcausasituacion;
		}
	}
	else
	{
		flagCoppel.odbc->GetLastError(flagCoppel.GetHstmt());
		grabarMensajeError("C", m_grid.iCaja, (LPTSTR)(LPCTSTR)odbc.m_strServer, "CA0030", "CDlgCapturarAbono", "grabarBeneficiariosCartera", cSql, lEmpleadoDlg, "ERROR AL consultar la funcion fun_traerrespuestaregla()", &odbc, iMuestraMsg);
	}
	return bRegresa;
}

bool CDlgCapturarAbono::grabarCrearSituacionEspecialArray(char *cJsonPostLocal, char *cMensaje)
{
	char cLog[500] = { 0 };
	bool bRegresa = true;
	int iResult = 0, iPuerto = 0;
	CString sAux = "", sContenido = "", sUrl = "", sMensaje = "";
	char cIpWSSitEsp[17] = { 0 }, cIpWSSitEspAlterno[17] = { 0 }, cSql[255] = { 0 };
	char ConsultaUrl[128] = { 0 };
	char *file;
	CUT_HTTPClient clienteHttp;

	sprintf_s(cLog, "FC0200805021522159 - entra - grabarCrearSituacionEspecialArray");
	grabarLog(cLog);

	struct SRecibeDatosWSSituaciones
	{
		bool bResultado; //2
		int iIduSituacion;
		int iCausaSituacion;
		char cMensaje[1024]; //9
		char cClaveSituacion[3]; //3
		int IdMotivo;
	};

	clienteHttp.AddSendHeaderTag("Content-Type: application/json; charset=utf-8");
	bErrorWS = false;

	SRecibeDatosWSSituaciones sRespuestaWSSitEsp;
	memset(&sRespuestaWSSitEsp, 0, sizeof(sRespuestaWSSitEsp));

	if (consultarIpServidores(&odbc, cIpWSSitEsp, cIpWSSitEspAlterno, SERV_WSSITUACIONESESPECIALES, cSql))
	{
		if (ConsultarPuerto(iPuerto))
		{
			file = (LPTSTR)(LPCTSTR)cJsonPostLocal;
			char *cFormUrlencoded = new char[strlen(file) + 12];
			sprintf(cFormUrlencoded, file);
			CUT_BufferDataSource ds(cFormUrlencoded, _tcslen(cFormUrlencoded));

			sUrl.Format("http://%s:%d/SituacionesEspeciales/api/situacionespecial/movimientosituacionespecialtienda/marcar", cIpWSSitEsp, iPuerto);
			sprintf_s(ConsultaUrl, "%s", (LPCTSTR)sUrl.Trim());
			iResult = clienteHttp.POST((LPSTR)ConsultaUrl, ds);

			if (iResult == UTE_SUCCESS)
			{
				LPCSTR line;

				for (int i = 0; i < clienteHttp.GetBodyLineCount(); i++)
				{
					line = clienteHttp.GetBodyLine(i);
					if (line != NULL)
					{
						sContenido.AppendFormat("%s\r\n", line);
					}
				}
			}
			else
			{
				sAux.Format("ERROR \n %s", CUT_ERR::GetErrorString(iResult));
				sprintf(cMensaje, "%s", (LPCTSTR)sAux);
				bErrorWS = true;
				bRegresa = false;
			}

			if (bRegresa)
			{
				char *json = new char[sContenido.GetLength() + 2];
				sprintf(json, "%s", (LPCTSTR)sContenido);

				StaticJsonBuffer<100000> jsonBuffer;
				JsonObject& root = jsonBuffer.parseObject(json); //se accede a la raiz del json
				if (!root.success())
				{
					//Indica que la estructura del json no es correcta
					sAux.Format("parseObject() root failed"); //Dejar log del error
					sprintf(cMensaje, "%s", (LPCTSTR)sAux);
					bErrorWS = true;
					bRegresa = false;
				}
				else
				{
					sRespuestaWSSitEsp.bResultado = root["Resultado"];
					if (sRespuestaWSSitEsp.bResultado)
					{
						bRegresa = true;
					}
					else
					{
						memcpy(sRespuestaWSSitEsp.cMensaje, root["Mensaje"], 512);
						sMensaje.Format("%.500s", sRespuestaWSSitEsp.cMensaje);
						sprintf(cMensaje, "%s", (LPCTSTR)sMensaje.Trim());
						sRespuestaWSSitEsp.IdMotivo = root["IdMotivo"];
						bErrorWS = true;
						if (sRespuestaWSSitEsp.IdMotivo == 1)
						{
							sMensaje.Format("");
							bRegresa = true;
						}
						else
						{
							bRegresa = false;
						}
					}
				}

				delete[]json;
			}

			delete[]cFormUrlencoded;
		}
	}
	else
	{
		bRegresa = false;
	}
	return bRegresa;
}

void CDlgCapturarAbono::cargarMerca360()
{
	CUT_HTTPClient clienteHTTP;
	bool bRegresa = true;
	int iResult = 0;
	CString iPuerto = ConsultaPuertoMerca360();
	CString flagMerca= ConsultaFlagMerca360();
	char ipServidorMerca360 [17], ipAlterno[17], cSql[255];
	CString url;
	char cLog[500] = { 0 };
	cNombreCliente360.Replace(_T(" "), _T("%20"));

	LPCSTR jsonResult = "";


	sprintf_s(cLog, "FC0200805021522155 - entra - Consumo de servicio de club de proteccion Mercadotecnia360");
	grabarLog(cLog);

	if (consultarIpServidores(&odbc, ipServidorMerca360, ipAlterno, SERV_WSMERCA360, cSql))
	{
		if(flagMerca=="1")
		{
			sprintf_s(cLog, "FC0200805021522155 - entra - flagmerca 1");
			grabarLog(cLog);
			if(cClave360=="G" && cTipoMovimiento360 == "1")
			{
				sprintf_s(cLog, "FC0200805021522155 - entra - Iniciando consumo del servicio enviomsjmerca360");
				grabarLog(cLog);
				url.Format(
					_T("http://%s:%s/api/v1/enviomsjmerca360?%s&%s&%s"),ipServidorMerca360,iPuerto,datosClientes360,cNombreCliente360,cNumRecibo360);

				int nLen = url.GetLength();
				LPTSTR getUrl = url.GetBuffer(nLen);

				url.ReleaseBuffer();

				iResult = clienteHTTP.GET(getUrl);

				if(iResult == UTE_SUCCESS)
				{
					sprintf_s(cLog, "FC0200805021522155 - entra -exitoso");
					grabarLog(cLog);
					LPCSTR line;
					int lCount = clienteHTTP.GetBodyLineCount();
					for(int i = 0; i < lCount; i++)
					{
						line = clienteHTTP.GetBodyLine(i);
						if(line != NULL)
						{
							jsonResult = line;
						}
					}
				}
				else
				{
					sprintf_s(cLog, "FC0200805021522155 - entra -fallo");
					grabarLog(cLog);
					bRegresa = false;
				}
			}
		}
	}
}

static CString ConsultaPuertoMerca360()
{
	bool bRegresa = false;
	char cIpServidorWSMerca360[50] ={0};
	CString cSql;

	cSql.Format("SELECT puerto FROM sysservidores WHERE tiposervidor = %d;", SERV_WSMERCA360);
	CMaximo ConsultaPuerto(&odbc);
	if(ConsultaPuerto.Exec(cSql))
	{
		ConsultaPuerto.activarCols();
		if(ConsultaPuerto.leer())
		{
			puertoT.Format("%d",ConsultaPuerto.Total);
			bRegresa = true;
		}
	}
	return puertoT;
}

static CString ConsultaFlagMerca360()
{
	bool bRegresa = false;
	char flagMerca360[50] ={0};
	CString cSql;

	cSql.Format("SELECT flag FROM sysflags WHERE tipoflag = %d;", FLAG_MERCA360);
	CMaximo FlagCoppel(&odbc);
	if(FlagCoppel.Exec(cSql))
	{
		FlagCoppel.activarCols();
		if(FlagCoppel.leer())
		{
			iFlag.Format("%d",FlagCoppel.Total);
			bRegresa = true;
		}
	}
	return iFlag;

}										
void CDlgCapturarAbono::obtenerSituacionEspecialRegla(int iArea, int iRegla, int iProceso, long lCliente)
{
	char cLog[500] = { 0 };
	CString sResultado, strToken, sSituacionesMostrar, sSituacionesNoMostrar, sSituacionesTemporal, sSituacionesTemporal1, cadenaSituacion;;
	char cMensaje[1024] = { 0 }, cResultado[1024] = { 0 }, cSql[100] = { 0 };
	bool bRegresa = true, bMostrar = true;
	int iContadorArreglo = 0, nTokenPos = 0, iPrioridad = 1;
	CStringArray arrSitEsp;
	bFlagSituacionesInformativas = false;
	bValidarMontoDesbloqueo = false;

	sprintf_s(cLog, "FC0200805021522164 - entra - obtenerSituacionEspecialRegla");
	grabarLog(cLog);

	memset(cSituacionEspecialesMandar, 0, sizeof(cSituacionEspecialesMandar));

	sprintf_s(cSql, "SELECT ccadenasituacion FROM fun_obtenersituacionclienteregla(%d, %d, %d, %ld)", iArea, iProceso, iRegla, lCliente);

	CObtenerSituacionReglaCliente SitEsp(&odbc_1, false); //conexión a tienda.nnnn

	if (SitEsp.Exec(cSql))
	{
		SitEsp.activarCols();
		while (SitEsp.Leer())
		{
			sprintf_s(cResultado, "%s%s|", cResultado, SitEsp.ccadenasituacion);
			cadenaSituacion.Format("%s", SitEsp.ccadenasituacion);
			if (cadenaSituacion.Trim() == "I-27")
			{
				bValidarMontoDesbloqueo = true;
			}

			iContadorArreglo++;
		}
		sResultado.Format("%s", cResultado);
		strToken = sResultado.Tokenize(_T("|"), nTokenPos);

		arrSitEsp.SetSize(iContadorArreglo);
		for (int i = 0; i < iContadorArreglo; i++)
		{
			if (!strToken.IsEmpty())
			{
				arrSitEsp[i] = strToken;
				strToken = sResultado.Tokenize(_T("|"), nTokenPos);
			}
		}

		//65 espacios puede mostrar
		for (int i = 0; i < iContadorArreglo; i++)
		{
			sSituacionesTemporal = arrSitEsp.GetAt(i);
			if (strcmp(sSituacionesTemporal, "-1") == 0)
			{
				bMostrar = false;
				iPrioridad = 0;
			}
			else
			{
				bMostrar = true;
			}

			if (bMostrar)
			{
				if (((sSituacionesMostrar.Trim().GetLength() + sSituacionesTemporal.Trim().GetLength()) < 12) && (iPrioridad == 1))//59 por los 12 espacios para mostar "Cliente " sit esp, motivo, persona
				{
					sSituacionesTemporal1.Format("%s%s", sSituacionesMostrar, sSituacionesTemporal.Trim());
					sSituacionesMostrar.Format("%s,", sSituacionesTemporal1.Trim());
					iPrioridad = 0;
				}
				else
				{
					sSituacionesTemporal1.Format("%s%s", sSituacionesNoMostrar, sSituacionesTemporal.Trim());
					sSituacionesNoMostrar.Format("%s,", sSituacionesTemporal1.Trim());
				}
			}
		}
		if (sSituacionesMostrar.Trim().GetLength() > 0 || sSituacionesNoMostrar.Trim().GetLength() > 0)
		{
			sSituacionesMostrar.Delete(sSituacionesMostrar.Trim().GetLength() - 1, sSituacionesMostrar.Trim().GetLength());
			sSituacionesNoMostrar.Delete(sSituacionesNoMostrar.Trim().GetLength() - 1, sSituacionesNoMostrar.Trim().GetLength());
		}
		if (sSituacionesMostrar.Trim().GetLength() > 0)
		{
			sprintf_s(cMensaje, "%s", sSituacionesMostrar.Trim());
			m_msgminimo2.SetWindowText(cMensaje);
		}
		if (sSituacionesNoMostrar.Trim().GetLength() > 0)
		{
			sprintf_s(cSituacionEspecialesMandar, "%s", sSituacionesNoMostrar);
			bFlagSituacionesInformativas = true;
		}

	}
	else
	{
		SitEsp.odbc->GetLastError(SitEsp.GetHstmt());
		grabarMensajeError("C", iCajaDlg, cIpServidorCartera, "CA0030", "CapturarFactura", "ObtenerSituacionEspecialRegla", cSql, lEmpleadoDlg, "ERROR al consultar funcion fun_obtenersituacionclienteregla", SitEsp.odbc, 2749);
	}
}

void CDlgCapturarAbono::MostrarSituacionesEnOpcion()
{
	char cLog[500] = { 0 };

	sprintf_s(cLog, "FC0200805021522169 - entra - MostrarSituacionesEnOpcion");
	grabarLog(cLog);

	if (bFlagSituacionesInformativas)
	{
		char cInput1[1024] = { 0 }, cInput2[1024] = { 0 };
		SParametros parametros;

		struct SituacionEspecial
		{
			int iLink;
			char cSituacionEspecial[1000];
		};

		memset(&parametros, 0, sizeof(SParametros));

		parametros.iLink = generarLink();
		parametros.iTienda = iTiendaDlg;
		sprintf_s(parametros.sServer, "%s", cIpServidorCartera);
		parametros.iCajaActual = iCajaDlg;
		parametros.lEmpleado = lEmpleadoDlg;

		SituacionEspecial parametrosSituacion;
		memset(&parametrosSituacion, 0, sizeof(SituacionEspecial));
		parametrosSituacion.iLink = parametros.iLink;

		sprintf_s(parametrosSituacion.cSituacionEspecial, "%s", cSituacionEspecialesMandar);

		memcpy(cInput1, &parametros, sizeof(SParametros));
		memcpy(cInput2, &parametrosSituacion, sizeof(parametrosSituacion));

		//CapturarDirectorioCliente.cpp
		CargarDLL cargarDll("C:\\sys\\progx\\gn\\GN0196.DLL", "GN0196", cInput1, cInput2);
	}
}

bool CDlgCapturarAbono::ConsultarPuerto(int &iPuerto)
{
	char cLog[500] = { 0 };
	bool bRegresa = false;
	char cSql[65] = { 0 };

	sprintf_s(cLog, "FC0200805021522173 - entra - ConsultarPuerto");
	grabarLog(cLog);

	sprintf_s(cSql, "SELECT puerto FROM sysservidores WHERE tiposervidor = %d;", SERV_WSSITUACIONESESPECIALES);
	CMaximo ConsultaPuerto(&odbc); //tienda
	if (ConsultaPuerto.Exec(cSql))
	{
		ConsultaPuerto.activarCols();
		if (ConsultaPuerto.leer())
		{
			iPuerto = ConsultaPuerto.Total;
			bRegresa = true;
		}
	}
	else
	{
		ConsultaPuerto.odbc->GetLastError(ConsultaPuerto.GetHstmt());
		grabarMensajeError("C", iCajaDlg, cIpServidorCartera, "CA0030", "CDlgCapturarAbono", "ConsultarPuerto", (LPTSTR)(LPCTSTR)cSql, lEmpleadoDlg, "ERROR #2749", ConsultaPuerto.odbc, 2749);
	}
	return bRegresa;
}

void CDlgCapturarAbono::tituloMostrar()
{
	char cLog[500] = { 0 };
	char cFechaTitulo[10] = { 0 };
	CString sTitulo = "", sFechaTitulo = "", sTituloMostrar = "";
	int iFlagTiendaLocal = 0;

	sprintf_s(cLog, "FC0200805021522177 - entra - tituloMostrar");
	grabarLog(cLog);

	miniFecha(cFechaTitulo, iDiaActual, iMesActual, iAnioActual);
	sFechaTitulo.Format("%.7s", cFechaTitulo);

	obtenerFlag('0', FLAG_TIENDALOCAL, iFlagTiendaLocal);

	if (iFlagTiendaLocal == 1)
	{
		sTitulo = "TIENDA OPERANDO EN MODO LOCAL";
	}
	else
	{
		sTitulo = "                                                      ";

	}

	switch (iFlagMovimiento)
	{
	case 1:
		{
			sTituloMostrar.Format("CAPTURA DE ABONOS          %s       ABONOS DE CTES                    CAJA: %d   FECHA: %s %s %s", sTitulo, m_grid.iCaja, sFechaTitulo.Mid(0, 2), sFechaTitulo.Mid(2, 3), sFechaTitulo.Mid(5, 7));
		}
		break;
	case 0:
		{
			sTituloMostrar.Format("CAPTURA DE ABONOS          %s       CARGOS DE CTES                    CAJA: %d   FECHA: %s %s %s", sTitulo, m_grid.iCaja, sFechaTitulo.Mid(0, 2), sFechaTitulo.Mid(2, 3), sFechaTitulo.Mid(5, 7));
		}
		break;
	case 2:
		{
			sTituloMostrar.Format("CAPTURA DE ABONOS          %s       ABONOS POR SUPERVISOR COBRANZA    CAJA: %d   FECHA: %s %s %s", sTitulo, m_grid.iCaja, sFechaTitulo.Mid(0, 2), sFechaTitulo.Mid(2, 3), sFechaTitulo.Mid(5, 7));
		}
		break;
	default:
		break;
	}

	SetWindowText(sTituloMostrar);
}

void CDlgCapturarAbono::fValidarStatusAfore()
{
	char cLog[500] = { 0 };

	sprintf_s(cLog, "FC0200805021522181 - entra - fValidarStatusAfore");
	grabarLog(cLog);

	obtenerFlag('C', FLAGC_MENSAJESAFORE, iFlagMensajeAfore);
	if (iFlagMensajeAfore == 1 && m_grid.cArea == 'C')
	{
		char cInputParam1[1024] = { 0 }, cInputParam2[1024] = { 0 };
		SParametros parametros;
		memset(&parametros, 0, sizeof(parametros));

		parametros.iLink = generarLink();
		sprintf_s(parametros.sServer, "%s", cIPServidorTiendaNumero);
		parametros.iTienda = m_grid.iTienda;
		parametros.lEmpleado = m_grid.lEmpleado;
		parametros.iCajaActual = m_grid.iCaja;
		parametros.lCliente = m_grid.lCliente;
		parametros.iTipo = iStatusAfore;
		sprintf_s(parametros.sFecha, "%04d%02d%02d", iAnioNacimiento, iMesNacimiento, iDiaNacimiento);

		memcpy(cInputParam1, &parametros, sizeof(SParametros));

		CargarDLL cargarDll("C:\\SYS\\PROGX\\GN\\GN0197.DLL", "ValidarSituacionAfore", cInputParam1, cInputParam2);
	}
}

bool CDlgCapturarAbono::fObtenerParametrosEncuesta()
{
	char cLog[500] = { 0 };
	bool bRegresa = false;
	char cSql[210] = { 0 };
	int iStatusAfore = 0;

	sprintf_s(cLog, "FC0200805021522185 - entra - fObtenerParametrosEncuesta");
	grabarLog(cLog);

	sprintf_s(cSql, "SELECT iMinutosPregunta,iOpcionStatusAfore,iDiasEncuestaSolicitud,iMesesEncuestaNoCotiza,cDescMes,iEdadCliente,iOpcInvitacionAforeContado,iOpcInvitacionesAforeCliente FROM fun_obtenerparametrosencuestas()");
	CParametros ObtenerParametrosEncuesta(&odbc);

	if (!ObtenerParametrosEncuesta.Exec(cSql))
	{
		AfxMessageBox("Error al ejecutar la función fun_obtenerparametrosencuestas");
		ObtenerParametrosEncuesta.Error();
		bRegresa = false;
	}
	else
	{
		ObtenerParametrosEncuesta.activarCols();
		if (ObtenerParametrosEncuesta.Leer())
		{
			iStatusAfore = ObtenerParametrosEncuesta.iopcionstatusafore;
			if (iStatusAfore == 1)
			{
				bRegresa = true;
			}
		}
	}
	return bRegresa;
}

bool CDlgCapturarAbono::fun_obtenerdescripcionestatus()
{
	char cLog[500] = { 0 };
	bool bRegresa = true;
	CString sMensaje;
	char cSql[70] = { 0 };

	sprintf_s(cLog, "FC0200805021522189 - entra - fun_obtenerdescripcionestatus");
	grabarLog(cLog);

	sprintf_s(cSql, "SELECT cMensaje FROM fun_obtenerdescripcionestatus('%d','1')", iStatusAfore);
	CDescripcion Descripcion(&odbc);

	if (!Descripcion.Exec(cSql))
	{
		AfxMessageBox("Error al ejecutar la función fun_obtenerpreguntaafore");
		Descripcion.Error();
		bRegresa = false;
	}
	else
	{
		Descripcion.activarCols();
		if (Descripcion.leer())
		{
			sMensaje.Format("%s", Descripcion.cmensaje);
			sMensaje.Trim();
			AfxMessageBox(sMensaje, MB_ICONINFORMATION);
		}
	}
	return bRegresa;
}

bool CDlgCapturarAbono::validarTieneSitEspCliente()
{
	char cLog[500] = { 0 };
	bool bRegresa = false;
	char cSql[100] = { 0 };

	sprintf_s(cLog, "FC0200805021522193 - entra - validarTieneSitEspCliente");
	grabarLog(cLog);

	sprintf_s(cSql, "SELECT COUNT(fun_traermaesituacioncliente) FROM fun_traermaesituacioncliente(%ld);", m_grid.lCliente);

	CMaximo SitEsp(&odbc_1);
	if (SitEsp.Exec(cSql))
	{
		SitEsp.activarCols();
		if (SitEsp.leer())
		{
			if (SitEsp.Total > 0)
			{
				bRegresa = true;
			}
		}
	}
	else
	{
		SitEsp.odbc->GetLastError(SitEsp.GetHstmt());
		grabarMensajeError("C", m_grid.iCaja, (LPTSTR)(LPCTSTR)odbc.m_strServer, "CA0030", "CDlgCapturarAbono", "ValidarTieneSitEspCliente", cSql, lEmpleadoDlg, "ERROR AL consultar la funcion fun_traermaesituacioncliente()", &odbc, iMuestraMsg);
	}
	return bRegresa;
}

void CDlgCapturarAbono::consultarMensaje(short iMensaje, char *cMensaje)
{
	char cLog[500] = { 0 };
	char cSql[80] = { 0 };

	sprintf_s(cLog, "FC0200805021522197 - entra - consultarMensaje");
	grabarLog(cLog);

	CConsultarMensajeSeguro mensaje(&odbc);

	sprintf_s(cSql, "SELECT TRIM(des_mensaje) FROM cat_mensajes WHERE idu_tipomensaje = %d", iMensaje);

	if (mensaje.Exec(cSql))
	{
		mensaje.activarCols();
		if (mensaje.leer())
		{
			sprintf(cMensaje, mensaje.des_mensaje);
		}
	}
	else
	{
		mensaje.odbc->GetLastError(mensaje.GetHstmt());
		grabarMensajeError("C", iCajaDlg, (LPTSTR)(LPCTSTR)odbc.m_strServer, "CA0030", "CDlgCapturarAbono", "consultarMensaje", cSql, lEmpleadoDlg, "ERROR EN LA CONSULTA", mensaje.odbc, iMuestraMsg);
	}
}

void CDlgCapturarAbono::ModificarClienteLocalizar()
{
	char cLog[500] = { 0 };
	char cSql[50] = { 0 };

	sprintf_s(cLog, "FC0200805021522201 - entra - ModificarClienteLocalizar");
	grabarLog(cLog);

	sprintf_s(cSql, "SELECT gnbuscaclientelocalizar('%ld')", m_grid.lCliente);

	CMaximo actualizarTienda(&odbc); //conexión a tienda.nnnn

	grabarLog(cSql);

	if (!actualizarTienda.Exec(cSql))
	{
		char cMensaje[1024] = { 0 };
		actualizarTienda.odbc->GetLastError(actualizarTienda.GetHstmt());
		sprintf_s(cMensaje, "ModificarClienteLocalizar::Error Cliente = %ld %s", m_grid.lCliente, actualizarTienda.odbc->LastErrStr());
		grabarLog(cMensaje);
	}
}

///metodo que consulta el estatus de domiciliaicon de la cuenta.
void CDlgCapturarAbono::ObtenerEstatusDomiciliacionCuenta(CCuentaWeb *pCuentaCliente)
{
	char cLog[500] = { 0 };
	C_ODBC odbcDomiciliacion;

	int iResultadoDll = 0;
	char cCadena[21 * MAX_INDEX] = { 0 }, cIpServidorDomiciliacion[17] = { 0 };
	char cSql[255] = { 0 };
	char cXML[140] = { 0 };
	std::string sSql, sXML;
	CString sDato;

	sprintf_s(cLog, "FC0200805021522205 - entra - ObtenerEstatusDomiciliacionCuenta");
	grabarLog(cLog);

	memset(CuentasDomiciliadas, 0, sizeof(CuentasDomiciliadas));

	if (consultarIpServidor(&odbc, cIpServidorDomiciliacion, SERV_DOMICILIACION, cSql))
	{
		if (abrirConexionBD(&odbcDomiciliacion, cIpServidorDomiciliacion, cIpServidorDomiciliacion, CONECTA_DOMICILIACION, m_grid.iTienda))
		{
			grabarLog("CDlgCapturarAbono::ObtenerEstatusDomiciliacionCuenta: Abrio conexion domiciliacion");

			sXML.append("<ROOT xmlns=\"http://coppel.com.domiciliacion/xml/cuenta\">");
			for (int i = 0; i < iTotalCuentas; ++i)
			{
				sprintf_s(cXML, "<Cuenta><TipoCuenta>%d</TipoCuenta><NumeroCliente>%ld</NumeroCliente><Factura>%ld</Factura></Cuenta>",
					pCuentaCliente->pCuenta[i].iTipoDeCuenta,
					m_grid.lCliente,
					pCuentaCliente->pCuenta[i].lFactura);
				sXML.append(cXML);
			}
			sXML.append("</ROOT>");

			sSql.append("SELECT fun_consultaestatuscuentascliente('");
			sSql.append(sXML);
			sSql.append("'::xml)::CHARACTER VARYING AS dato;");
			CConsultarCuentaDomiciliada ConsultarDomiciliada(&odbcDomiciliacion);
			if (ConsultarDomiciliada.Exec(sSql.c_str()))
			{
				ConsultarDomiciliada.activarCols();
				if (ConsultarDomiciliada.leer())
				{
					sDato.Format("%s", ConsultarDomiciliada.dato);
					iResultadoDll = 1;
				}
				else
				{
					iResultadoDll = -1;
				}
			}

			strcat_s(cCadena, sDato);

			sSql.clear();
			sXML.clear();
		}

		odbcDomiciliacion.Close();

		grabarLog("CDlgCapturarAbono::ObtenerEstatusDomiciliacionCuenta: Cierra conexion domiciliacion");
	}

	switch (iResultadoDll)
	{
	case -1: AfxMessageBox("Error al consultar las cuentas domiciliadas", MB_ICONERROR);
		break;
	case 1: strcat_s(CuentasDomiciliadas, cCadena);
		break;
	default: AfxMessageBox("Error al consultar las cuentas domiciliadas", MB_ICONERROR);
		break;
	}
}

///Imprime en la pantalla el estatus de domiciliacion de la cuenta
void CDlgCapturarAbono::ImprimirEstatusDomiciliacion(int iColumna, int iRegistro)
{
	char cLog[500] = { 0 };
	char cDescripcion[11] = { 0 };

	sprintf_s(cLog, "FC0200805021522209 - entra - ImprimirEstatusDomiciliacion");
	grabarLog(cLog);

	for (int i = 0; i < 10; ++i)
	{
		cDescripcion[i] += CuentasDomiciliadas[10 * iRegistro + i];
	}
	cDescripcion[10] = NULL;
	for (int i = 0; i < 10; ++i)
	{
		if (cDescripcion[i] == '_')
		{
			cDescripcion[i] = ' ';
		}
	}
	if (memcmp(cDescripcion, "          ", 10) != 0)
	{
		m_grid.QuickSetText(iColumna, 4, cDescripcion);
		m_grid.QuickSetAlignment(iColumna, 4, UG_ALIGNLEFT);
	}
}

//Carga el menu de domiciliacion de cuentas Coppel
void CDlgCapturarAbono::CargarMenuDomiciliacion()
{
	char cLog[500] = { 0 };
	struct SEntrada
	{
		int iTipoConsulta;
		int iTienda;
		char cServidor[20];
	};
	InfoEmpleado infoEmpleado5;
	char cMsjCadena[1024] = { 0 }, cSql[255] = { 0 }, cInParam1[1024] = { 0 }, cInParam2[1024] = { 0 }, cOutParam1[1024] = { 0 }, cOutParam2[1024] = { 0 }, cNombreProyecto[100] = { 0 }, cNombreFuncionDLL[10] = { 0 };
	int puestoEmp = 0, iResultado = 0;

	sprintf_s(cLog, "FC0200805021522213 - entra - CargarMenuDomiciliacion");
	grabarLog(cLog);

	memset(&infoEmpleado5, 0, sizeof(infoEmpleado5));

	buscarEmpleadoPuesto_Opc5(&odbc, infoEmpleado5, m_grid.lEmpleado, puestoEmp, cMsjCadena, cSql);

	nombreArchivo("CA0195.DLL", cNombreProyecto, DIRECTORIO_CA);
	sprintf_s(cNombreFuncionDLL, "CA0195");

	SEntrada sEntrada;
	memset(&sEntrada, 0, sizeof(SEntrada));

	sEntrada.iTipoConsulta = 2;
	sEntrada.iTienda = m_grid.iTienda;
	sprintf_s(sEntrada.cServidor, "%s", m_grid.sServer);
	sprintf_s(cInParam2, "%d", puestoEmp);

	memcpy(cInParam1, &sEntrada, sizeof(SEntrada));
	CargarDLL cargarDll(cNombreProyecto, cNombreFuncionDLL, cInParam1, cInParam2, cOutParam1, cOutParam2);

	iResultado = cargarDll.getResultado();

	if (iResultado > 0)
	{
		int iResultadoWs = 0;
		iResultadoWs = atoi(cOutParam1);
		switch (iResultadoWs)
		{
		case 1:
			{
				char cDato[80] = { 0 }, cTienda[6] = { 0 }, cEmpleado[10] = { 0 }, cCliente[12] = { 0 }, cCaja[5] = { 0 }, cArea[3] = { 0 };

				sprintf_s(cTienda, "%d", m_grid.iTienda);
				sprintf_s(cEmpleado, "%ld", m_grid.lEmpleado);
				sprintf_s(cCliente, "%ld", m_grid.lCliente);
				sprintf_s(cCaja, "%d", m_grid.iCaja);
				sprintf_s(cArea, "%c", m_grid.cArea);
				sprintf_s(cSql, "SELECT url FROM urlswebservice WHERE tipo = 11");

				CConsultarWS ConsultarUrl(&odbc);
				if (ConsultarUrl.Exec(cSql))
				{
					ConsultarUrl.activarCols();
					if (ConsultarUrl.leer())
					{
						sprintf_s(cDato, "http://%s", CString(ConsultarUrl.url).Trim());
					}
				}

				CargarDLLCS cargarDllCS;
				cargarDllCS.addParam((LPTSTR)(LPCTSTR)m_grid.sServer);
				cargarDllCS.addParam(cTienda);
				cargarDllCS.addParam("C:\\SYS\\PROGX\\CA\\CA0196.DLL");
				cargarDllCS.addParam("GenerarAltaBajaDomiciliacionCtaCoppel.Vista.Proceso");
				cargarDllCS.addParam(cDato);
				cargarDllCS.addParam(cEmpleado);
				cargarDllCS.addParam(cArea);
				cargarDllCS.addParam(cCaja);
				cargarDllCS.addParam(cCliente);

				cargarDllCS.cargarDllCS("C:\\SYS\\PROGX\\CA\\CA0196.DLL", "GenerarAltaBajaDomiciliacionCtaCoppel.Vista.Proceso");
			}
			break;
		case 0:
			if (iResultado == 2)
			{
				AfxMessageBox("OCURRIO UN ERROR AL CONSUMIR EL SERVICIO DE DOMICILIACION");
			}
			else
			{
				AfxMessageBox("EL CAJERO NO TIENE PERMISOS");
			}
			break;
		default:
			AfxMessageBox("OCURRIO UN ERROR AL CONSUMIR EL SERVICIO DE DOMICILIACION");
			break;
		}
	}
	else
	{
		AfxMessageBox("OCURRIO UN ERROR AL CARGAR EL DLL CA0195");
	}
}

int CDlgCapturarAbono::obtenerOrigenSeguro()
{
	char cLog[500] = { 0 };
	CString sSql;
	char cClaveOrigenSeguro;
	int empresa = 1;

	sprintf_s(cLog, "FC0200805021522218 - entra - obtenerOrigenSeguro");
	grabarLog(cLog);

	sSql.Format("SELECT CASE WHEN TRIM(clv_origenseguro)=''THEN 'C' ELSE clv_origenseguro END::CHAR(1) AS clv_origenseguro  FROM FUN_CRCONSULTARSEGUROS('%ld','0') WHERE tiposeguro IN ('0','1') LIMIT 1;", m_grid.lCliente);

	COrigenSeguro origenSeguro(&odbc_1);
	if (origenSeguro.Exec(sSql))
	{
		origenSeguro.activarCols();
		if (origenSeguro.Leer())
		{
			cClaveOrigenSeguro = origenSeguro.clv_origenseguro[0];
		}
		else
		{
			cClaveOrigenSeguro = 'C';
		}

		if (cClaveOrigenSeguro == 'B')
		{
			empresa = 2;
		}
	}
	else
	{
		origenSeguro.odbc->GetLastError(origenSeguro.GetHstmt());
		sSql.Trim();
		grabarMensajeError("C", m_grid.iCaja, (LPTSTR)(LPCTSTR)odbc.m_strServer, "CA0030", "CDlgCapturarAbono", "obtenerOrigenSeguro", "", lEmpleadoDlg, "ERROR AL EJECUTAR LA FUNCION FUN_CRCONSULTARSEGUROS", origenSeguro.odbc, iMuestraMsg);
	}
	return empresa;
}

int CDlgCapturarAbono::llamarModuloMigracion(long lFolioSegAMigrar)
{
	char cLog[500] = { 0 };
	int iResp = 0;
	long lFolioAux = 0l;
	char cStatusSeguro = 0, cTipoCan = 0, cClaveNoOfrecer = 0, cMensajeSeguimiento[150] = { 0 };
	CString cTiendaCS = "", cEmpleadoCS = "", cCajaCS = "", cSistemaCS = "", cClienteCS = "", cFolioSegCS = "", sTexto = "";

	sprintf_s(cLog, "FC0200805021522222 - entra - llamarModuloMigracion");
	grabarLog(cLog);

	cTiendaCS.Format("%d", m_grid.iTienda);
	cEmpleadoCS.Format("%ld", m_grid.lEmpleado);
	cCajaCS.Format("%d", m_grid.iCaja);
	cSistemaCS.Format("%d", iSistema);
	cClienteCS.Format("%d", m_grid.lCliente);
	cFolioSegCS.Format("%ld", lFolioSegAMigrar);

	grabarLog("llamarModuloMigracion: F7   Migración de Seguros");

	iResp = (int)_spawnl(P_WAIT, "C:\\SYS\\PROGS\\PuenteToCSharp.EXE", "C:\\SYS\\PROGS\\PuenteToCSharp.exe.EXE", cIPServidorTiendaNumero, cTiendaCS, "C:\\SYS\\PROGX\\CA\\CA0192.dll", "MigrarClubProteccionFamiliarCS.frmMigracion", cSistemaCS, cCajaCS, cEmpleadoCS, cClienteCS, cFolioSegCS, NULL);

	grabarLog("Metodo TieneSeguroClub 16");

	if (tieneSeguroClub(cStatusSeguro, cTipoCan, cClaveNoOfrecer, lFolioAux, bCteSeguro))
	{
		sprintf_s(cMensajeSeguimiento, "llamarModuloMigracion: lFolioAux = %ld, iFoliosSegurosActual[0] = %d", lFolioAux, iFoliosSegurosActual[0]);
		grabarLog(cMensajeSeguimiento);

		if (lFolioAux != iFoliosSegurosActual[0])
		{
			sTexto.Format("%ld", lFolioAux);
			m_grid.QuickSetText(iColumnaClub, 1, sTexto);
			m_grid.QuickSetAlignment(iColumnaClub, 1, UG_ALIGNRIGHT);
			iFoliosSegurosActual[0] = lFolioAux;
			borrarTemporalesSeguroAdicional(true);
			grabarTmpCacarMovSeguros();
		}
	}
	return iResp;
}

int CDlgCapturarAbono::llamarModuloReimpresionPolizasSeguros()
{
	char cLog[500] = { 0 };
	int iResp = 0;
	char cInputParam1[1024] = { 0 }, cInputParam2[1024] = { 0 }, cOutputParam1[1024] = { 0 }, cOutputParam2[1024] = { 0 },
		cNombreProyecto[100] = { 0 }, cNombreFuncionDLL[10] = { 0 };

	sprintf_s(cLog, "FC0200805021522226 - entra - llamarModuloReimpresionPolizasSeguros");
	grabarLog(cLog);

	SParametros parametros;
	memset(&parametros, 0, sizeof(SParametros));

	grabarLog("CDlgCapturarAbono::llamarModuloReimpresionPolizasSeguros --> cargando modulo CA0189");

	parametros.iLink = generarLink();
	sprintf_s(parametros.sServer, "%s", m_grid.sServer);
	parametros.iTienda = m_grid.iTienda;
	//parametros.lEmpleado=m_grid.lEmpleado;
	parametros.iCajaActual = m_grid.iCaja;
	parametros.iMuestraMsg = m_grid.iMuestraMsg;

	parametros.iNumSistema = SISTEMA_CAJAS; //SISTEMA_CAJAS ó SISTEMA_CLIENTESNUEVOS
	parametros.lCliente = m_grid.lCliente; //Número de cliente al que se le va a vender seguro club
	//parametros.iFlagGeneral = 1;
	memcpy(cInputParam1, &parametros, sizeof(SParametros));

	sprintf_s(cNombreProyecto, "");
	// Ruta del archivo DLL a ejecutar
	nombreArchivo("CA0189.DLL", cNombreProyecto, DIRECTORIO_CA);

	// Nombre de la función principal en el DLL
	sprintf_s(cNombreFuncionDLL, "CA0189");

	CargarDLL cargarDll(cNombreProyecto, cNombreFuncionDLL, cInputParam1, cInputParam2, cOutputParam1, cOutputParam2);
	iResp = cargarDll.getResultado();

	if (iResp <= 0)
	{
		AfxMessageBox("Error al cargar el programa CA0189.DLL", MB_ICONERROR);
	}
	return iResp;
}

int CDlgCapturarAbono::llamarModuloPagoApoyoAdicional()
{
	char cLog[500] = { 0 };
	int iResp = 0;
	char cTiendaCS[6] = { 0 }, cEmpleadoCS[12] = { 0 }, cCajaCS[5] = { 0 }, cSistemaCS[5] = { 0 }, cClienteCS[12] = { 0 };

	sprintf_s(cLog, "FC0200805021522230 - entra - llamarModuloPagoApoyoAdicional");
	grabarLog(cLog);

	grabarLog("CDlgCapturarAbono::llamarModuloPagoApoyoAdicional --> cargando modulo CA0190");

	CargarDLLCS cargarDllCS;

	sprintf_s(cTiendaCS, "%d", m_grid.iTienda);
	sprintf_s(cEmpleadoCS, "%ld", m_grid.lEmpleado);
	sprintf_s(cCajaCS, "%d", m_grid.iCaja);
	sprintf_s(cSistemaCS, "%d", iSistema);
	sprintf_s(cClienteCS, "%ld", m_grid.lCliente);

	cargarDllCS.addParam(cIPServidorTiendaNumero);
	cargarDllCS.addParam(cTiendaCS);
	cargarDllCS.addParam("C:\\SYS\\PROGX\\CA\\CA0190.DLL");
	cargarDllCS.addParam("CapturarPagoApoyoAdicionalCS.frmConsulta");
	cargarDllCS.addParam(cSistemaCS);
	cargarDllCS.addParam(cCajaCS);
	cargarDllCS.addParam(cEmpleadoCS);
	cargarDllCS.addParam(cClienteCS);
	cargarDllCS.addParam("1");

	//iResp = (int)_spawnl(P_WAIT,"C:\\SYS\\PROGS\\PuenteToCSharp.EXE", "C:\\SYS\\PROGS\\PuenteToCSharp.exe.EXE", cIPServidorTiendaNumero, cTiendaCS, "C:\\SYS\\PROGX\\CA\\CA0190.DLL", "CapturarPagoApoyoAdicionalCS.frmConsulta", cSistemaCS, cCajaCS, cEmpleadoCS, cClienteCS, "1", NULL);

	iResp = cargarDllCS.cargarDllCS("C:\\SYS\\PROGX\\CA\\CA0190.DLL", "CapturarPagoApoyoAdicionalCS.frmConsulta");

	return iResp;
}

bool CDlgCapturarAbono::realizarProcesoCambioPolizaSeguro(long lPolizaAnterior, long lPolizaNueva)
{
	char cLog[500] = { 0 };
	bool bRegresa = false;
	char cTextoAux[1600] = { 0 }, cXml[1300] = { 0 }, cSql[1500] = { 0 };

	sprintf_s(cLog, "FC0200805021522234 - entra - realizarProcesoCambioPolizaSeguro");
	grabarLog(cLog);

	sprintf_s(cTextoAux, "%s", "Entró realizarProcesoCambioPolizaSeguro");
	grabarLog(cTextoAux);

	generarXMLBeneficiarios(lPolizaNueva, cXml);

	sprintf_s(cSql, "SELECT istatus, 0 AS iRegistrosAfectados, smensaje FROM fun_crcambiarfoliopolizaseguro(%ld,%ld,%ld,'%d','%d','%d',%ld,'%04d-%02d-%02d','%s',%ld)",
		m_grid.lCliente, lPolizaAnterior, lPolizaNueva, m_grid.iTienda, m_grid.iCaja, iCiudadGnDominio, m_grid.lEmpleado, iAnioActual, iMesActual, iDiaActual, cXml, lNumeroRecibo);

	sprintf_s(cTextoAux, "realizarProcesoCambioPolizaSeguro: %s", cSql);
	grabarLog(cTextoAux);

	cEjecutarFuncionPgSQL procesoCambio(&odbc_1);
	if (procesoCambio.Exec(cSql))
	{
		procesoCambio.activarCols();
		if (procesoCambio.leer())
		{
			if (procesoCambio.istatus == 0)
			{
				bRegresa = true;
				grabarLog("Se ejecuto correctamente la funcion fun_crcambiarfoliopolizaseguro");
			}
			else
			{
				sprintf_s(cTextoAux, "realizarProcesoCambioPolizaSeguro: Error: %.1024s", procesoCambio.smensaje);
				grabarLog(cTextoAux);
			}
		}
	}
	else
	{
		procesoCambio.odbc->GetLastError(procesoCambio.GetHstmt());
		grabarMensajeError("C", m_grid.iCaja, (LPTSTR)(LPCTSTR)odbc.m_strServer, "CA0030", "CDlgCapturarAbono", "realizarProcesoCambioPolizaSeguro", "", lEmpleadoDlg, "ERROR AL EJECUTAR LA FUNCION FUN_CRCAMBIARFOLIOPOLIZASEGURO(BIGINT,INT,INT,SMALLINT,SMALLINT,SMALLINT,BIGINT,XML,INT)", &odbc, iMuestraMsg);
	}
	return bRegresa;
}

void CDlgCapturarAbono::generarXMLBeneficiarios(long lFolio, char *cXml)
{
	char cLog[500] = { 0 };

	sprintf_s(cLog, "FC0200805021522238 - entra - generarXMLBeneficiarios");
	grabarLog(cLog);

	sprintf(cXml, "<Datos>"
		"<numcliente>%ld</numcliente>"
		"<poliza>%ld</poliza>"
		"<fecha>%04d-%02d-%02d</fecha>"
		"<claveseguro>C</claveseguro>"
		"<nombre1>%s</nombre1>"
		"<apellidopaterno1>%s</apellidopaterno1>"
		"<apellidomaterno1>%s</apellidomaterno1>"
		"<parentesco1>%d</parentesco1>"
		"<porcentaje1>%d</porcentaje1>"
		"<nombre2>%s</nombre2>"
		"<apellidopaterno2>%s</apellidopaterno2>"
		"<apellidomaterno2>%s</apellidomaterno2>"
		"<parentesco2>%d</parentesco2>"
		"<porcentaje2>%d</porcentaje2>"
		"<nombre3>%s</nombre3>"
		"<apellidopaterno3>%s</apellidopaterno3>"
		"<apellidomaterno3>%s</apellidomaterno3>"
		"<parentesco3>%d</parentesco3>"
		"<porcentaje3>%d</porcentaje3>"
		"<sucursal>%d</sucursal>"
		"<caja>%d</caja>"
		"<area>C</area>"
		"<empleadoefectuo>%ld</empleadoefectuo>"
		"<ciudad>%d</ciudad>"
		"<tiposeguro>%d</tiposeguro>"
		"<num_telefono1>%I64d</num_telefono1>"
		"<num_telefono2>%I64d</num_telefono2>"
		"<num_telefono3>%I64d</num_telefono3>"
		"<fec_nacimiento1>%04d-%02d-%02d</fec_nacimiento1>"
		"<fec_nacimiento2>%04d-%02d-%02d</fec_nacimiento2>"
		"<fec_nacimiento3>%04d-%02d-%02d</fec_nacimiento3>"
		"</Datos>", m_grid.lCliente, lFolio, iAnioActual, iMesActual, iDiaActual, cNombreBeneficiario1, cApPatBeneficiario1, cApMatBeneficiario1,
		iParentesco1, iPorcentaje1, cNombreBeneficiario2, cApPatBeneficiario2, cApMatBeneficiario2, iParentesco2, iPorcentaje2, cNombreBeneficiario3,
		cApPatBeneficiario3, cApMatBeneficiario3, iParentesco3, iPorcentaje3, m_grid.iTienda, m_grid.iCaja, lEmpleadoDlg, iCiudadGnDominio, iTipoSeguroPF,
		lTelefono1, lTelefono2, lTelefono3, iAnioNacimiento1, iMesNacimiento1, iDiaNacimiento1, iAnioNacimiento2, iMesNacimiento2, iDiaNacimiento2,
		iAnioNacimiento3, iMesNacimiento3, iDiaNacimiento3);
}

bool CDlgCapturarAbono::validarComplementoCliente(short iTipoSeguro, int &iFlagMesRegalado)
{
	char cLog[500] = { 0 };
	bool bRegresa = false;
	char cTextoAux[1100] = { 0 }, cSql[120] = { 0 };

	sprintf_s(cLog, "FC0200805021522242 - entra - validarComplementoCliente");
	grabarLog(cLog);

	sprintf_s(cSql, "SELECT istatus, 0 AS iRegistrosAfectados, smensaje FROM fun_crvalidarcomplementocliente('%ld','%d')", m_grid.lCliente, iTipoSeguro);

	sprintf_s(cTextoAux, "consultarComplementoCliente: %s", cSql);
	grabarLog(cTextoAux);

	cEjecutarFuncionPgSQL validarCompCliente(&odbc_1);
	if (validarCompCliente.Exec(cSql))
	{
		validarCompCliente.activarCols();
		if (validarCompCliente.leer())
		{
			if (validarCompCliente.istatus == 0)
			{
				bRegresa = true;
				iFlagMesRegalado = 1;
			}
			else if (validarCompCliente.istatus < 0)
			{
				sprintf_s(cTextoAux, "consultarComplementoCliente: Error: %.1024s", validarCompCliente.smensaje);
				grabarLog(cTextoAux);
			}
			else
			{
				iFlagMesRegalado = 0;
			}
		}
	}
	else
	{
		validarCompCliente.odbc->GetLastError(validarCompCliente.GetHstmt());
		grabarMensajeError("C", m_grid.iCaja, (LPTSTR)(LPCTSTR)odbc.m_strServer, "CA0030", "CDlgCapturarAbono", "validarComplementoCliente", "", lEmpleadoDlg, "ERROR AL EJECUTAR LA FUNCION FUN_CRVALIDARCOMPLEMENTOCLIENTE(BIGINT,SMALLINT,SMALLINT,DATE)", &odbc, iMuestraMsg);
	}
	return bRegresa;
}

int CDlgCapturarAbono::CargarMensajesInvitacion()
{
	char cLog[500] = { 0 };
	int iResp = 0;
	char cInputParam1[1024] = { 0 }, cInputParam2[1024] = { 0 }, cOutputParam1[1024] = { 0 }, cOutputParam2[1024] = { 0 },
		cNombreProyecto[100] = { 0 }, cNombreFuncionDLL[10] = { 0 };

	sprintf_s(cLog, "FC0200805021522246 - entra - CargarMensajesInvitacion");
	grabarLog(cLog);

	SParametros parametros;
	memset(&parametros, 0, sizeof(SParametros));

	sprintf_s(parametros.sServer, "%s", m_grid.sServer);
	parametros.iTienda = m_grid.iTienda;
	parametros.lEmpleado = m_grid.lEmpleado;
	parametros.iCajaActual = m_grid.iCaja;
	parametros.iMuestraMsg = m_grid.iMuestraMsg;
	parametros.iNumSistema = iSistema; //SISTEMA_CAJAS ó SISTEMA_CLIENTESNUEVOS
	parametros.lCliente = m_grid.lCliente; //Número de cliente al que se le va a vender seguro club
	memcpy(cInputParam1, &parametros, sizeof(SParametros));

	sprintf_s(cNombreProyecto, "");
	// Ruta del archivo DLL a ejecutar
	nombreArchivo("GN0229.DLL", cNombreProyecto, DIRECTORIO_GN);

	// Nombre de la función principal en el DLL
	sprintf_s(cNombreFuncionDLL, "GN0229");

	CargarDLL cargarDll(cNombreProyecto, cNombreFuncionDLL, cInputParam1, cInputParam2, cOutputParam1, cOutputParam2);
	iResp = cargarDll.getResultado();

	if (iResp <= 0)
	{
		AfxMessageBox("Error al cargar el programa GN0229.DLL", MB_ICONERROR);
	}
	return iResp;
}

bool CDlgCapturarAbono::ValidarHabilitarCambioBeneficiarioSeguro()
{
	char cLog[500] = { 0 };
	bool bRegresa = true;
	char cSql[220] = { 0 };
	long lFolioSeguro = 0L;
	bool bContinuar = true;
	char cStatusSeguro = ' ', cTipoCan = ' ', cClaveNoOfrecer = ' ', cTexto[10] = { 0 }, cTexto2[10] = { 0 }, cMensajeSeguimiento[50] = { 0 };;

	sprintf_s(cLog, "FC0200805021522250 - entra - ValidarHabilitarCambioBeneficiarioSeguro");
	grabarLog(cLog);

	sprintf_s(cMensajeSeguimiento, "Metodo TieneSeguroClub 17");
	grabarLog(cMensajeSeguimiento);

	if (tieneSeguroClub(cStatusSeguro, cTipoCan, cClaveNoOfrecer, lFolioSeguro, bCteSeguro))
	{
		bRegresa = false;
		sprintf_s(cSql, "SELECT COALESCE(EXTRACT(DAYS FROM ('%04d-%02d-%02d'::TIMESTAMP - (SELECT fechaafiliacion FROM  FUN_CRCONSULTARSEGUROS('%ld','0') WHERE tiposeguro=0 OR tiposeguro=1 LIMIT 1)::TIMESTAMP )),0)::INT AS Total;",
			iAnioActual, iMesActual, iDiaActual, m_grid.lCliente);

		CMaximo xValidarCambioBeneficiario(&odbc_1);
		if (xValidarCambioBeneficiario.Exec(cSql))
		{
			xValidarCambioBeneficiario.activarCols();
			if (xValidarCambioBeneficiario.leer())
			{
				if (xValidarCambioBeneficiario.Total > 0)
				{
					bRegresa = true;
				}
			}
		}
		else
		{
			xValidarCambioBeneficiario.odbc->GetLastError(xValidarCambioBeneficiario.GetHstmt());
			grabarMensajeError("C", m_grid.iCaja, (LPTSTR)(LPCTSTR)odbc.m_strServer, "CA0030", "CDlgCapturarAbono", "ValidarHabilitarCambioBeneficiarioSeguro", "", lEmpleadoDlg, "ERROR AL CONSULTAR LA FUNCION FUN_CRCONSULTARSEGUROS(INT,INT)", xValidarCambioBeneficiario.odbc, iMuestraMsg);
		}
	}
	return bRegresa;
}

void CDlgCapturarAbono::ConsultarCatalogoMensajeTienda(int iNumeroMensaje, char *cMensajeConsulta)
{
	char cLog[500] = { 0 };
	char cSql[100] = { 0 };

	sprintf_s(cLog, "FC0200805021522254 - entra - ConsultarCatalogoMensajeTienda");
	grabarLog(cLog);

	CConsultarMensajeSeguro xMensaje(&odbc);

	sprintf_s(cSql, "SELECT TRIM(fun_consultarcatmensajes) AS des_mensaje FROM FUN_CONSULTARCATMENSAJES('%d')", iNumeroMensaje);
	if (xMensaje.Exec(cSql))
	{
		xMensaje.activarCols();
		if (xMensaje.leer())
		{
			sprintf(cMensajeConsulta, xMensaje.des_mensaje);
		}
	}
	else
	{
		xMensaje.odbc->GetLastError(xMensaje.GetHstmt());
		grabarMensajeError("C", iCajaDlg, (LPTSTR)(LPCTSTR)odbc.m_strServer, "CA0030", "CDlgCapturarAbono", "ConsultarCatalogoMensajeTienda", cSql, lEmpleadoDlg, "ERROR EN LA CONSULTA", xMensaje.odbc, iMuestraMsg);
	}
}

bool CDlgCapturarAbono::obtenerDistrubuccionAbonoRopa(long lSaldoTotal, long lTotalIntereses, long lTotalAbono, long lBonificacion)
{
	char cLog[500] = { 0 };
	char cSql[255] = { 0 };
	bool bResultado = true;

	sprintf_s(cLog, "FC0200805021522258 - entra - obtenerDistrubuccionAbonoRopa");
	grabarLog(cLog);

	lAbonoRopa = lAbonoTasa0 = lAbonoInteresesRopa = lAbonoInteresesTasa0 = lBonificacionRopa = lBonificacionTasa0 = 0;

	grabarLog("obtenerDistrubuccionAbonoRopa obteniendo distrubuccion del abono");
	CObtenerDetalleAbonoRopa detalleAbono(&odbc);

	sprintf_s(cSql, "SELECT lAbonoRopa,labonotasa0,lAbonointeresRopa,lAbonointeresTasa0,lBonificacionRopa,lBonificacionTasa0 FROM fun_consultarventadetalleropa(%ld,%ld,%ld,%ld,%ld,%ld,%ld,%ld)", lSaldoTotal, lTotalIntereses, lTotalAbono, lSaldoRopa, lSaldoTasa0, lInteresesRopa, lInteresesTasa0, lBonificacion);
	grabarLog(cSql);
	if (detalleAbono.Exec(cSql))
	{
		detalleAbono.activarCols();
		if (detalleAbono.leer())
		{
			lAbonoRopa = detalleAbono.abonoRopa;
			lAbonoTasa0 = detalleAbono.abonoTasa0;
			lAbonoInteresesRopa = detalleAbono.abonoInteresRopa;
			lAbonoInteresesTasa0 = detalleAbono.abonoInteresTasa0;
			lBonificacionRopa = detalleAbono.bonificacionRopa;
			lBonificacionTasa0 = detalleAbono.bonificacionTasa0;
		}
	}
	else
	{
		detalleAbono.odbc->GetLastError(detalleAbono.GetHstmt());
		grabarMensajeError("C", iCajaDlg, (LPTSTR)(LPCTSTR)odbc.m_strServer, "CA0030", "CDlgCapturarAbono", "consultarMensaje", "", lEmpleadoDlg, "ERROR EN LA CONSULTA fun_consultarventadetalleropa", detalleAbono.odbc, iMuestraMsg);
		bResultado = false;
	}
	return bResultado;
}

bool CDlgCapturarAbono::grabarTmpCarteraRopaDetalle(long lSuPago, long lAbonoRopa, long lAbonoTasa0, char *cStatus, long lBonificacionRopa, long lBonificacionTasa0, long lAbonoInteresesRopa, long lAbonoInteresesTasa0, long lSaldaCon)
{
	char cLog[500] = { 0 };
	int iFlag = 0, iCuentasDetalle = 0;
	CString sConsulta;
	bool bContinuar = true, bGraboRopa = false;
	long lAbonoCuenta = 0L, lBonificacion = 0L, lAbonoInteres = 0L;

	sprintf_s(cLog, "FC0200805021522262 - entra - grabarTmpCarteraRopaDetalle");
	grabarLog(cLog);

	grabarLog("grabarTmpCarteraRopaDetalle::Grabando ropadetalle en tabla temporal tmp_carteraropadetalle");

	CGrabarTmpAbonoCrCropaDetalle tmpCrCropaDetalle(&odbc_1); // conexión a la B.D cartera
	{
		tmpCrCropaDetalle.num_cliente = m_grid.lCliente;

		if (lSuPago > 0L)
		{
			iFlag = 1;
		}
		else if (lSuPago < 0L)
		{
			if (iFlagMovimiento == 0) // si es 0 es cargo
			{
				//Se trata de un Cargo
				iFlag = 1;
			}
		}

		if (iFlag == 1)
		{
			while (iCuentasDetalle <= iTotalCuentasDetalle && bContinuar == true)
			{
				if (cStatus[0] == '1')
				{
					//tasa 0
					if (iTipoDeduccionRopa == 0 && !bGraboRopa)
					{
						lAbonoCuenta = lAbonoRopa;
						lBonificacion = lBonificacionRopa;
						lAbonoInteres = lAbonoInteresesRopa;
						iCuentasDetalle = 1;
						bGraboRopa = true;
						tmpCrCropaDetalle.idu_tipodeduccion = iTipoDeduccionRopa;
					}
					else if (iTipoDeduccionTasa0 == 2)
					{
						lAbonoCuenta = lAbonoTasa0;
						lBonificacion = lBonificacionTasa0;
						lAbonoInteres = lAbonoInteresesTasa0;
						iCuentasDetalle = 2;
						tmpCrCropaDetalle.idu_tipodeduccion = iTipoDeduccionTasa0;
					}
					if (lSuPago >= lSaldaCon)
					{
						tmpCrCropaDetalle.imp_saldo = lAbonoCuenta + lBonificacion;
					}
					else
					{
						tmpCrCropaDetalle.imp_saldo = lAbonoCuenta;
					}
					tmpCrCropaDetalle.imp_interesadicional = lAbonoInteres;
					tmpCrCropaDetalle.fec_ultimomovto.ponerFecha(iDiaActual, iMesActual, iAnioActual);
				}
				tmpCrCropaDetalle.num_sistema = (short)iSistema;
				tmpCrCropaDetalle.num_caja = (short)m_grid.iCaja;
				tmpCrCropaDetalle.num_tienda = (short)m_grid.iTienda;

				tmpCrCropaDetalle.prepararInsert("tmp_carteraropadetalle");
				if (tmpCrCropaDetalle.Insert())
				{
					tmpCrCropaDetalle.Commit();
					iFlagCrRopa = 1;
					iCuentasDetalle++;
				}
				else
				{
					sConsulta.Format("Error al Insertar en la Tabla tmp_carteraropadetalle");
					tmpCrCropaDetalle.odbc->GetLastError(tmpCrCropaDetalle.GetHstmt());
					grabarMensajeError("C", m_grid.iCaja, (LPTSTR)(LPCTSTR)m_grid.sServer, "CapturarAbono", "CDlgCapturarAbono", "grabarTmpCarteraRopaDetalle", (LPTSTR)(LPCTSTR)sConsulta, m_grid.lEmpleado, "ERROR EN LA CONSULTA(grabarTmpCarteraRopaDetalle)", tmpCrCropaDetalle.odbc, m_grid.iMuestraMsg);
					bContinuar = false;
				}
			}
		}
	}
	return bContinuar;
}

bool CDlgCapturarAbono::grabarTmpCrCropaDetalle()
{
	char cLog[500] = { 0 };
	bool bResultado = false;
	char cSql[80] = { 0 };
	sprintf_s(cLog, "FC0200805021522267 - entra - grabarTmpCrCropaDetalle");
	grabarLog(cLog);
	grabarLog("grabarTmpCrCropadetalle::grabando cuenta de ropa en cartera");
	sprintf_s(cSql, "SELECT fun_grabartmpcarteraropadetalle('%d','%d','%d','%d')", iFlagCrRopa, m_grid.iCaja, iSistema, m_grid.iTienda);
	grabarLog(cSql);

	CMaximo flagCoppel(&odbc_1, false);
	if (flagCoppel.Exec(cSql))
	{
		flagCoppel.activarCols();
		if (flagCoppel.Leer())
		{
			bResultado = true;
		}
	}
	else
	{
		//Se obtiene el error
		flagCoppel.odbc->GetLastError(flagCoppel.GetHstmt());
		grabarMensajeError("C", m_grid.iCaja, (LPTSTR)(LPCTSTR)m_grid.sServer, "CapturarAbono", "CDlgCapturarAbono", "grabarTmpCrCropadetalle", (LPTSTR)(LPCTSTR)cSql, m_grid.lEmpleado, "ERROR EN LA CONSULTA(fun_grabartmpcarteraropadetalle)", flagCoppel.odbc, m_grid.iMuestraMsg);
	}
	return  bResultado;
}

short CDlgCapturarAbono::validaFlagPrestamoCteN(long lNumCliente)
{
	char cLog[500] = { 0 };
	/*
	* En la tabla cat_crparametros en TIENDAS CLIENTES NUEVOS con
	* id 212 debe existir la tienda en el campo des_valor
	*/

	short lValidacion = 0L;
	char cSql[80] = { 0 };

	sprintf_s(cLog, "FC0200805021522271 - entra - validaFlagPrestamoCteN");
	grabarLog(cLog);

	if (abrirConexionBD(&odbc_1, cIpServidorCartera, cIpServidorCartera, CONECTA_CARTERA, m_grid.iTienda))
	{
		CMaximo obtenerFlagPrestamoClienteNuevo(&odbc_1);
		sprintf_s(cSql, "SELECT ivalido FROM fun_validaflagprestamosctesn(%ld,'%d')", lNumCliente, m_grid.iTienda);

		if (!obtenerFlagPrestamoClienteNuevo.Exec(cSql))
		{
			//Se obtiene el error
			obtenerFlagPrestamoClienteNuevo.odbc->GetLastError(obtenerFlagPrestamoClienteNuevo.GetHstmt());
			grabarMensajeError("C", m_grid.iCaja, (LPTSTR)(LPCTSTR)m_grid.sServer, "CapturarAbono", "CDlgCapturarAbono", "obtenerFlagPrestamoClienteNuevo", cSql, m_grid.lEmpleado, "ERROR EN LA CONSULTA(validaFlagPrestamoCteN)", obtenerFlagPrestamoClienteNuevo.odbc, m_grid.iMuestraMsg);
		}
		else
		{
			obtenerFlagPrestamoClienteNuevo.activarCols();
			while (obtenerFlagPrestamoClienteNuevo.Leer())
			{
				lValidacion = (short)obtenerFlagPrestamoClienteNuevo.Total;
			}
		}
	}
	else
	{
		AfxMessageBox("Error al abrir conexión BD CONECTA_CARTERA");
	}
	cerrarConexionBD(&odbc_1);
	return lValidacion;
}
//12612 Seguros vida
int CDlgCapturarAbono::llamarModuloSegurosVida()
{
	char cLog[500] = { 0 };
	int iResp = 0;
	char cSqlTxt[255] = { 0 }, cInputParam1[1024] = { 0 };

	sprintf_s(cLog, "FC0200805021522275 - entra - llamarModuloSegurosVida");
	grabarLog(cLog);

	grabarLog("CDlgCapturarAbono::llamarModuloSegurosVida --> cargando modulo ConsultaSegurosDeVida.exe");

	if (consultarIpServidor(&odbc, cIpServidorControl, SERV_CONTROLTIENDAS, cSqlTxt))
	{
		sprintf_s(cInputParam1, "%ld %s", m_grid.lCliente, cIpServidorControl);
	}
	else
	{
		AfxMessageBox("El Servidor de control tiendas no esta disponible", MB_ICONERROR);
	}

	iResp = (int)_spawnl(P_WAIT, "c:\\sys\\progs\\ConsultaSegurosDeVida.exe", "c:\\sys\\progs\\ConsultaSegurosDeVida.exe", cInputParam1, NULL);
	if (iResp < 0)
	{
		AfxMessageBox("Error al cargar el sistema Consulta de seguros de vida.exe", MB_ICONERROR);
	}
	return iResp;
}

void CDlgCapturarAbono::GuardaHit(long lAbono)
{
	char cLog[500] = { 0 };
	char cTextoAux[2048] = { 0 };

	sprintf_s(cLog, "FC0200805021522277 - entra - GuardaHit");
	grabarLog(cLog);

	if (!bFlag_GuardoHit && bMostrarReestructura && iTestigo == 0)
	{
		sprintf_s(cTextoAux, "CDlgCapturarAbono::GuardaHit: Guardando Hit.");
		grabarLog(cTextoAux);
		CReestructuracion oRestructura(m_grid.lCliente);
		sprintf_s(cTextoAux, "CDlgCapturarAbono::GuardaHit: OPC no finaliza: %d", iFlag_Reestructuracion);
		grabarLog(cTextoAux);
		oRestructura.GuardaHitReestructura(m_grid.iTienda, m_grid.iCaja, m_grid.lEmpleado, lAbono, iFlag_Reestructuracion);
	}

	if (bMostrarReestructura && !bFormalizo)
	{
		bMostrarReestructura = false;
		cJsonParams.Replace("'OrigenLlamada':3", "'OrigenLlamada':5");
		cJsonParams.Replace("'OrigenLlamada':1", "'OrigenLlamada':5");
		_spawnl(P_NOWAIT, PATH_PUENTETOCS, PATH_PUENTETOCS, m_grid.sServer, inoTienda, PATH_REESTTRUCTURA_DLL, NOMBRE_FUNCION_INICIAL, cJsonParams, NULL);
	}
}

void CDlgCapturarAbono::MensajeReestructura()
{
	char cLog[500] = { 0 };
	char cTextoAux[2048] = { 0 };
	iTestigo = 1;
	cFechaNacimientoCliente.Format("%04d-%02d-%02d", iAnioNacimiento,  static_cast<int>(iMesNacimiento), iDiaNacimiento);
	inoTienda.Format("%d", m_grid.iTienda);
	iFlag_Reestructuracion = 0;

	sprintf_s(cLog, "FC0200805021522279 - entra - MensajeReestructura");
	grabarLog(cLog);

	if (!bClienteReestructurado)
	{
		CReestructuracion oRestructura(m_grid.lCliente, candidatoReestructura.lVencidoTotal, candidatoReestructura.lBaseTotal, candidatoReestructura.cPuntualidad, candidatoReestructura.cSituacionEspecial, candidatoReestructura.iCiudadCliente);
		if (oRestructura.VerificarCanditado())
		{
			if (oRestructura.bEsCanditado)
			{
				sprintf_s(cTextoAux, "CDlgCapturarAbono::MensajeReestructura: Cliente: %ld es candidato a reestructura en tienda", m_grid.lCliente);
				grabarLog(cTextoAux);
				CCuentaWeb *oCCuenta = new CCuentaWeb();
				oCCuenta->iniciarCCuenta(m_grid.lCliente, cFechaTienda, (short)m_grid.iTienda, (short)iCiudadGnDominio, cIpServidorCartera, cIpServidorCCuentaWeb, (short)iFlagTimeOutCCuenta);
				oCCuenta->simularReestructuracion();
				bFlag_GuardoHit = true;
				if (oCCuenta->sInfoReestructura.iEsCandidato)
				{
					int iAbono = 0;
					short iTipoCliente = 0;
					char cMensajeRestructura[256] = { 0 };
					sprintf_s(cTextoAux, "CDlgCapturarAbono::MensajeReestructura: Cliente: %ld es candidato a reestructura.", m_grid.lCliente);
					grabarLog(cTextoAux);

					if (oCCuenta->sInfoReestructura.iProductoReestructura != 2)
					{
						candidatoReestructura.lSaldoTotal = candidatoReestructura.lSaldaConTotal;
					}

					iTipoCliente = oRestructura.ValidaTestigoReestructura(m_grid.lCliente);

					sprintf_s(cTextoAux, "CDlgCapturarAbono::MensajeReestructura: Tipo Cliente = %d", iTipoCliente);
					grabarLog(cTextoAux);

					if (iTipoCliente == 0 || iTipoCliente == 1)
					{
						bMostrarReestructura = true;
					}

					if (iTipoCliente == 0)
					{
						sprintf_s(cTextoAux, "CDlgCapturarAbono::MensajeReestructura: Cliente Piloto.");
						grabarLog(cTextoAux);
						iTestigo = 0;
						bFlag_GuardoHit = false;
						int iAbono;
						if (oCCuenta->sInfoReestructura.lImp_saldo24 != 0)
						{
							iAbono = oCCuenta->sInfoReestructura.lImp_abonobase24;
						}
						else if (oCCuenta->sInfoReestructura.lImp_saldo18 != 0)
						{
							iAbono = oCCuenta->sInfoReestructura.lImp_abonobase18;
						}
						else
						{
							iAbono = oCCuenta->sInfoReestructura.lImp_abonobase12;
						}

						cJsonConfiguracion.Format("{'ServidorCartera':'%s','Tienda':{'ServidorTienda':'%s','Numero':%d},'OrigenLlamada':%d,'Cajero':%d,'Ciudad':%d,'Caja':%d,'CajaOriginal':%d, 'Area': '%c'}", cIpServidorCartera, m_grid.sServer, m_grid.iTienda, 1, m_grid.lEmpleado, candidatoReestructura.iCiudad, iCajaActual, iCajaOriginal, m_grid.cArea);
						cJsonReestructura.Format("{'Producto':{'NumeroProducto':%d,'ImporteFinanciamiento':%d,'ImporteSaldo':%d,'InteresMoratorio':%d,'EsPorcentaje':%d,'NumeroAbonos':%d,'ListadoPlazo':[{'Seleccionado':false,'Descripcion':'%s','Meses':%d,'ImporteSaldo':%d,'ImporteAbonoBase':%d},{'Seleccionado':false,'Descripcion':'%s','Meses':%d,'ImporteSaldo':%d,'ImporteAbonoBase':%d},{'Seleccionado':false,'Descripcion':'%s','Meses':%d,'ImporteSaldo':%d,'ImporteAbonoBase':%d}]},'Hit':{'Formaliza':%d,'AbonoAnterior':%d,'AbonoNuevo':%d,'Abono':%d,'NoFinaliza':%d},'Cliente':{'IduCliente':%d,'Nombre':'%s','ApellidoPaterno':'%s','ApellidoMaterno':'%s','Sexo':'%s','CiudadCliente':%d,'FechaNacimiento':'%s','Puntualidad':'%s','SituacionEspecial':'%s','Moras':%d, 'Edad':%d, 'IdMotivoSituacion':%d,'Testigo':%d, 'Cuenta':{'Saldo':%d,'AbonoMensual':%d,'Tienda':%d,'Descripcion':'%s','SaldoVencido':%d,'SaldoFinanciar':%d,'InteresMoratorio':%d}}}", oCCuenta->sInfoReestructura.iProductoReestructura, oCCuenta->sInfoReestructura.lImp_saldofinanciado, candidatoReestructura.lSaldoTotal, candidatoReestructura.lInteresAdicional, oCCuenta->sInfoReestructura.iTienePorcentaje, oCCuenta->sInfoReestructura.iAbonosDesbloqueo, "plazo 12 meses", 12, oCCuenta->sInfoReestructura.lImp_saldo12, oCCuenta->sInfoReestructura.lImp_abonobase12, "plazo 18 meses", 18, oCCuenta->sInfoReestructura.lImp_saldo18, oCCuenta->sInfoReestructura.lImp_abonobase18, "plazo 24 meses", 24, oCCuenta->sInfoReestructura.lImp_saldo24, oCCuenta->sInfoReestructura.lImp_abonobase24, 0, candidatoReestructura.lBaseTotal, 0, 0, 0, m_grid.lCliente, cNombre, cApellidoPaterno, cApellidoMaterno, candidatoReestructura.cSexo, candidatoReestructura.iCiudadCliente, cFechaNacimientoCliente, candidatoReestructura.cPuntualidad, candidatoReestructura.cSituacionEspecial, oRestructura.iMoras, iEdadCliente, iIdSituacionEspecial, iTestigo, candidatoReestructura.lSaldoTotal, candidatoReestructura.lBaseTotal, m_grid.iTienda, "Capturar Abono", candidatoReestructura.lVencidoTotal, oCCuenta->sInfoReestructura.lImp_saldofinanciado, candidatoReestructura.lInteresAdicional);
						cJsonConfiguracion.Replace(' ', '_');
						cJsonReestructura.Replace(' ', '_');
						cJsonParams.Format("%s %s", cJsonConfiguracion, cJsonReestructura);
						m_msgCandidatoReestructura.SetWindowText("CANDIDATO PLAN PAGA MÁS FÁCIL");
						sprintf_s(cMensajeRestructura, "Usted presenta un saldo vencido. Para que pueda cumplir con su abono mensual puntualmente, "
							"\n puede disminuir su abono de $ %ld.00 a un nuevo abono de $ %ld.00", candidatoReestructura.lBaseTotal, iAbono);
						sprintf_s(cTextoAux, "CDlgCapturarAbono::MensajeReestructura: %s", (LPCTSTR)cJsonConfiguracion);
						grabarLog(cTextoAux);
						sprintf_s(cTextoAux, "CDlgCapturarAbono::MensajeReestructura: %s", (LPCTSTR)cJsonReestructura);
						grabarLog(cTextoAux);
						CDlgReestructuracion dlgReestructura;
						dlgReestructura.jsonParams = cJsonParams;
						dlgReestructura.sTienda.Format("%d", m_grid.iTienda);
						dlgReestructura.sServidorIP = m_grid.sServer;
						dlgReestructura.m_mensajerest = CString(cMensajeRestructura);
						dlgReestructura.DoModal();
						iFlag_Reestructuracion = dlgReestructura.iFlag_Reestructura;
						if (iFlag_Reestructuracion != 0 && iFlag_Reestructuracion != 1)
							iFlag_Reestructuracion = 0;
						sprintf_s(cTextoAux, "CDlgCapturarAbono::MensajeReestructura: OPC FINALIZA: %d", iFlag_Reestructuracion);
						grabarLog(cTextoAux);
						if (oRestructura.ValidaFormalizoReestructura() == 1)
						{
							sprintf_s(cTextoAux, "CDlgCapturarAbono::MensajeReestructura: Reestructura Formalizada");
							grabarLog(cTextoAux);
							bFormalizo = true;
							inicializar();
							inicializarCaptura();
						}
					}
					else if (iTipoCliente == 1)
					{
						sprintf_s(cTextoAux, "CDlgCapturarAbono::MensajeReestructura: Cliente Testigo");
						grabarLog(cTextoAux);
						cJsonConfiguracion.Format("{'ServidorCartera':'%s','Tienda':{'ServidorTienda':'%s','Numero':%d},'OrigenLlamada':%d,'Cajero':%d,'Ciudad':%d,'Caja':%d,'CajaOriginal':%d,'Area': '%c'}", cIpServidorCartera, m_grid.sServer, m_grid.iTienda, 1, m_grid.lEmpleado, candidatoReestructura.iCiudad, iCajaActual, iCajaOriginal, m_grid.cArea);
						cJsonReestructura.Format("{'Producto':{'NumeroProducto':%d,'ImporteFinanciamiento':%d,'ImporteSaldo':%d,'InteresMoratorio':%d,'EsPorcentaje':%d,'NumeroAbonos':%d,'ListadoPlazo':[{'Seleccionado':false,'Descripcion':'%s','Meses':%d,'ImporteSaldo':%d,'ImporteAbonoBase':%d},{'Seleccionado':false,'Descripcion':'%s','Meses':%d,'ImporteSaldo':%d,'ImporteAbonoBase':%d},{'Seleccionado':false,'Descripcion':'%s','Meses':%d,'ImporteSaldo':%d,'ImporteAbonoBase':%d}]},'Hit':{'Formaliza':%d,'AbonoAnterior':%d,'AbonoNuevo':%d,'Abono':%d,'NoFinaliza':%d},'Cliente':{'IduCliente':%d,'Nombre':'%s','ApellidoPaterno':'%s','ApellidoMaterno':'%s','Sexo':'%s','CiudadCliente':%d,'FechaNacimiento':'%s','Puntualidad':'%s','SituacionEspecial':'%s','Moras':%d, 'Edad':%d, 'IdMotivoSituacion':%d,'Testigo':%d, 'Cuenta':{'Saldo':%d,'AbonoMensual':%d,'Tienda':%d,'Descripcion':'%s','SaldoVencido':%d,'SaldoFinanciar':%d,'InteresMoratorio':%d}}}", oCCuenta->sInfoReestructura.iProductoReestructura, oCCuenta->sInfoReestructura.lImp_saldofinanciado, candidatoReestructura.lSaldoTotal, candidatoReestructura.lInteresAdicional, oCCuenta->sInfoReestructura.iTienePorcentaje, oCCuenta->sInfoReestructura.iAbonosDesbloqueo, "plazo 12 meses", 12, oCCuenta->sInfoReestructura.lImp_saldo12, oCCuenta->sInfoReestructura.lImp_abonobase12, "plazo 18 meses", 18, oCCuenta->sInfoReestructura.lImp_saldo18, oCCuenta->sInfoReestructura.lImp_abonobase18, "plazo 24 meses", 24, oCCuenta->sInfoReestructura.lImp_saldo24, oCCuenta->sInfoReestructura.lImp_abonobase24, 0, candidatoReestructura.lBaseTotal, 0, 0, 0, m_grid.lCliente, cNombre, cApellidoPaterno, cApellidoMaterno, candidatoReestructura.cSexo, candidatoReestructura.iCiudadCliente, cFechaNacimientoCliente, candidatoReestructura.cPuntualidad, candidatoReestructura.cSituacionEspecial, oRestructura.iMoras, iEdadCliente, iIdSituacionEspecial, iTestigo, candidatoReestructura.lSaldoTotal, candidatoReestructura.lBaseTotal, m_grid.iTienda, "Capturar Abono", candidatoReestructura.lVencidoTotal, oCCuenta->sInfoReestructura.lImp_saldofinanciado, candidatoReestructura.lInteresAdicional);
						cJsonConfiguracion.Replace(' ', '_');
						cJsonReestructura.Replace(' ', '_');
						cJsonParams.Format("%s %s", cJsonConfiguracion, cJsonReestructura);
						sprintf_s(cTextoAux, "CDlgCapturarAbono::MensajeReestructura: %s", (LPCTSTR)cJsonReestructura);
						grabarLog(cTextoAux);
					}
				}
				else
				{
					sprintf_s(cTextoAux, "CDlgCapturarAbono::MensajeReestructura: Cliente: %ld no es candidato en cCuenta.", m_grid.lCliente);
					grabarLog(cTextoAux);
				}

				delete oCCuenta;
			}
		}
		else
		{
			grabarMensajeError("C", m_grid.iCaja, (LPTSTR)(LPCTSTR)m_grid.sServer, "CapturarAbono", "CDlgCapturarAbono", "MensajeReestructura", (LPTSTR)(LPCTSTR)odbc.m_strSqlCmd, m_grid.lEmpleado, "ERROR EN LA CONSULTA(fun_esCandidatoReestructura)", &odbc, m_grid.iMuestraMsg);
		}
	}
}

void CDlgCapturarAbono::capturarDatosClientesIlocalizables()
{
	char cLog[500] = { 0 };
	char cRutaDLL[100] = { 0 }, cInput1[1024] = { 0 }, cInput2[1024] = { 0 }, cOutput1[1024] = { 0 }, cOutput2[1024] = { 0 };
	SParametros parametros;
	memset(&parametros, 0, sizeof(SParametros));

	sprintf_s(cLog, "FC0200805021522286 - entra - capturarDatosClientesIlocalizables");
	grabarLog(cLog);

	parametros.iLink = generarLink();

	parametros.iTienda = m_grid.iTienda;
	parametros.lCliente = m_grid.lCliente;
	parametros.lEmpleado = m_grid.lEmpleado;
	parametros.iCajaActual = m_grid.iCaja;
	parametros.iNumSistema = iSistema;
	parametros.iMuestraMsg = iMuestraMsg;
	sprintf_s(parametros.sModo, "COMMIT");
	parametros.iTipo = GetIdSuborigen(CDlgCapturarAbono::iScGN0214, iSistema);
	sprintf_s(parametros.sServer, "%s", cIPServidorTiendaNumero);

	memcpy(cInput1, &parametros, sizeof(SParametros));
	nombreArchivo("GN0214.DLL", cRutaDLL, DIRECTORIO_GN);
	CargarDLL cargarDll(cRutaDLL, "GN0214", cInput1, cInput2, cOutput1, cOutput2);
}

void CDlgCapturarAbono::consultarInfoEmpleadoOperacion(long lnumeroEmpleadoOperador, long &centroEmpleado)
{
	char cLog[500] = { 0 };
	char  cMensaje[100] = { 0 };
	char  cSQL[300] = { 0 };
	InfoEmpleado infocliente;

	sprintf_s(cLog, "FC0200805021522290 - entra - consultarInfoEmpleadoOperacion");
	grabarLog(cLog);

	memset(&infocliente, 0, sizeof(InfoEmpleado));
	buscarEmpleado_Opc5(&odbc, infocliente, lnumeroEmpleadoOperador, cMensaje, cSQL, false);
	centroEmpleado = infocliente.lCentro;
}

void CDlgCapturarAbono::validaCandidato(int &iprocesocomprobante, int &iNumAdicional_, int iNumSistema, 
										int &iImprimeComprobantes, long &lnota, long &LImporte, long lCentro)
{
	char cLog[500] = { 0 };
	//captura de datos

	char cTexto[256] = { 0 };

	CString sRuta = "";

	sprintf_s(cLog, "FC0200805021522294 - entra - validaCandidato");
	grabarLog(cLog);

	grabarLog("CDlgCapturarAbono::validaCandidato --> cargando modulo GN0210");

	sRuta = "C:\\\\sys\\\\progx\\\\gn\\\\GN0210.DLL";

	CString ClaseConstructor = "ConsultarCorreoDeClientes.Correos";
	CString sMetodo = ""; sMetodo = "cargarPantalla";
	CStringArray bArgsConstructor;
	bArgsConstructor.Add("");
	int iFlagImprimir = 0;
	long origen = 0L;
	long suborigen = 0L;
	CStringArray sArgsMetodo;
	CString jsonValidaCandidato = "";
	int iTipoCliente = 0;//validacion con huella
	long lClienteCorreo = 0L;
	CString nombreCompletoCliente = "";
	CString sPuntualidad = "0";
	CString sSexoCliente = "";

	consultarOrigenSubOrigen(origen, suborigen);

	if (iNumAdicional_ == 0)
	{
		iTipoCliente = 2;

		iprocesocomprobante = 26;
		lClienteCorreo = atol(sCliente);
		nombreCompletoCliente.Format("%s %s %s", cNombre, cApellidoPaterno, cApellidoMaterno);
		sPuntualidad.Format("%s", m_grid.cPuntualidad);
		sSexoCliente.Format("%s", cSexoCliente);
		if (iFlagDescuentoEspecial == 1 || iFlagDescuentoEspecial == 2)
		{
			iprocesocomprobante = 73;
			iTipoCliente = 4;
		}
	}
	if (iNumAdicional_ > 0)
	{
		iTipoCliente = 3;
		iprocesocomprobante = 26;
		lClienteCorreo = atol(sCliente);
		nombreCompletoCliente.Format("%s %s %s", cNombre, cApellidoPaterno, cApellidoMaterno);
		sPuntualidad.Format("%s", m_grid.cPuntualidad);
		sSexoCliente.Format("%s", cSexoCliente);

		if (iFlagDescuentoEspecial == 1 || iFlagDescuentoEspecial == 2)
		{
			iprocesocomprobante = 73;
			iTipoCliente = 4;
		}

	}
	if (iNumAdicional_ == -1)
	{
		iTipoCliente = 1;
		iNumAdicional_ = 0;
		lClienteCorreo = 90001;
		iprocesocomprobante = 25;
		nombreCompletoCliente = "";
	}

	jsonValidaCandidato.Format("{sEmpleado:\"%ld\",sNumeroCliente:\"%ld\",sClaveDivicion:\"0\",sClaveRegion:\"0\",sMontoCompra:\"%ld\",sNumAdicional:\"%d\",sCaja:\"%d\",sNumeroCentro:\"%ld\",sNumeroZona:\"0\",sOrigen:\"%ld\",sSubOrigen:\"%ld\",sTipoCliente:\"%d\",sArea:\"%d\"}",
		m_grid.lEmpleado
		, lClienteCorreo
		, (LImporte / 100)
		, iNumAdicional_
		, m_grid.iCaja
		, lCentro
		, origen
		, suborigen
		, iTipoCliente
		, iNumSistema);

	CString sAux = "";
	sAux.Format("%d", m_grid.iTienda);
	sArgsMetodo.Add(sAux);
	sArgsMetodo.Add(m_grid.sServer);

	sAux.Format("%d", m_grid.iCaja);
	sArgsMetodo.Add(sAux);

	sAux.Format("%ld", m_grid.lEmpleado);
	sArgsMetodo.Add(sAux);

	sAux.Format("%ld", lClienteCorreo);
	sArgsMetodo.Add(sAux);

	sArgsMetodo.Add(nombreCompletoCliente);
	sArgsMetodo.Add(sPuntualidad);
	sArgsMetodo.Add(sSexoCliente);

	sAux.Format("%d", iNumAdicional_);
	sArgsMetodo.Add(sAux);
	sAux.Format("%d", iNumSistema);
	sArgsMetodo.Add(sAux);
	sAux.Format("%d", m_grid.iMuestraMsg);
	sArgsMetodo.Add(sAux);

	sArgsMetodo.Add("0");
	sArgsMetodo.Add("0");

	sAux.Format("%ld", lnota);
	sArgsMetodo.Add(sAux);

	sArgsMetodo.Add("0");

	sArgsMetodo.Add(jsonValidaCandidato);

	grabarLog("grabarAbono:: Cargar GN0210.DLL");

	::CoInitialize(NULL);

	CCargaDllCSharp *objCargaDll = new CCargaDllCSharp();
	objCargaDll->CargarDllCSharp(sRuta, ClaseConstructor, METODO_INT, sMetodo, bArgsConstructor, sArgsMetodo);
	objCargaDll->getRespuesta(iFlagImprimir);

	iImprimeComprobantes = iFlagImprimir;

	sprintf_s(cTexto, "grabarAbono:: Respuesta GN0210.DLL [Respuesta: %d]", iFlagImprimir);
	grabarLog(cTexto);

	delete objCargaDll;

	::CoUninitialize();
}

void CDlgCapturarAbono::consultarOrigenSubOrigen(long &Origen, long &subOrigen)
{
	char cLog[500] = { 0 };
	CString sQuery = "";

	sprintf_s(cLog, "FC0200805021522299 - entra - consultarOrigenSubOrigen");
	grabarLog(cLog);

	sQuery.Format("select iorigen, isuborigen from fun_consultarorigensuborigencorreo('6');");
	CConsultarOrigen consultar(&odbc);

	if (consultar.Exec(sQuery))
	{
		consultar.activarCols();
		if (consultar.leer())
		{
			Origen = consultar.iorigen;
			subOrigen = consultar.isuborigen;
		}
	}
}

void CDlgCapturarAbono::imprimirConfirmacionCorreo(char *cArea, long &lFactura, int iNumSistema, CString &opcionImpresion, int &iTipoProcesoComprobante, CString &sNumCliente)
{
	char cLog[500] = { 0 };

	sprintf_s(cLog, "FC0200805021522307 - entra - imprimirConfirmacionCorreo");
	grabarLog(cLog);

	CString sRuta = "";
	sRuta = "C:\\\\sys\\\\progx\\\\gn\\\\GN0215.DLL";
	CString ClaseConstructor = ""; ClaseConstructor = "ImprimirComprobanteCapturaCorreo.Impresion";
	CString sMetodo = "";
	CStringArray sDatosConstructor;
	CStringArray sDatosMetodo;
	sDatosMetodo.Add("");
	CString sAux = "";
	sAux.Format("%d", m_grid.iTienda);
	sDatosConstructor.Add(sAux);

	sAux.Format("%d", m_grid.iCaja);
	sDatosConstructor.Add(sAux);

	sDatosConstructor.Add(cArea);

	sDatosConstructor.Add(cIPServidorTiendaNumero);

	sAux.Format("%ld", lFactura);
	sDatosConstructor.Add(sAux);

	sAux.Format("%d", iNumSistema);
	sDatosConstructor.Add(sAux);

	sDatosConstructor.Add(sNumCliente);
	sDatosConstructor.Add(opcionImpresion);

	sAux.Format("%d", iTipoProcesoComprobante);
	sDatosConstructor.Add(sAux);

	grabarLog("grabarAbono:: Cargar GN0215.DLL");

	::CoInitialize(NULL);

	CCargaDllCSharp *objCargaDll = new CCargaDllCSharp();
	objCargaDll->CargarDllCSharp(sRuta, ClaseConstructor, CONSTRUCTOR, sMetodo, sDatosConstructor, sDatosMetodo);

	grabarLog("grabarAbono:: Regresa de GN0215.DLL");

	delete objCargaDll;

	::CoUninitialize();
}

void CDlgCapturarAbono::capturaDeDatosEcommerce(bool &bGrabo, bool &bSorteoEncontrado, int &iTipoProcesoComprobante, 
												int &iImprimeComprobantes)
{    
	char cLog[500] = { 0 };
	bool bProcesoHuella = false;
	sprintf_s(cLog, "FC0200805021522311 - entra - capturaDeDatosEcommerce");
	grabarLog(cLog);

	///REALIZAR LLAMADO DE SERVICIO DE CORREOS

	long lCentroEmpleado = 0L;
	short iflagCorreo = '0';
	int iOpcionDatos = 24;
	if(iFlagTiendaLocal != 1)
	{
		if (bGrabo && !bSorteoEncontrado)
		{
			bProcesoHuella = 
				GetSetTipoBiometrizado(VALIDACION_HUELLA_CORREOS) == VALIDACION_BIOMETRIZADA_ADICIONAL 
				|| GetSetTipoBiometrizado(VALIDACION_HUELLA_CORREOS) == VALIDACION_BIOMETRIZADA_TITULAR;
			if (bProcesoHuella)
			{
				sCliente.Format("%ld", m_grid.lCliente);
			}
			else
			{
				this->iNumeroAdicional = -1;
				sCliente = "90001";
			}

			if (iFlagConsultaSC3 == 1 && (bProcesoHuella || sCliente == "90001"))
			{
				grabarLog("grabarAbono::Entra a consultarInfoEmpleadoOperacion");
				consultarInfoEmpleadoOperacion(m_grid.lEmpleado, lCentroEmpleado);
				long importe = lTotalAPagar;
				if (iSistema != SISTEMA_CAJERA_CAPTURISTA)
				{
					grabarLog("grabarAbono::Entra a validaCandidato");
					validaCandidato(iTipoProcesoComprobante, this->iNumeroAdicional, SISTEMA_CAJAS, iImprimeComprobantes,
						lNumeroRecibo, lTotalAPagar, lCentroEmpleado);
					grabarLog("grabarAbono::FINALIZA LLAMADO DE SERVICIO DE CORREOS");
				}

			}
		}
		else
		{
			grabarLog("82f356bf0c9b - if (bGrabo && !bSorteoEncontrado){..} <-- no cumplió");
		}
	}
	else
	{
		grabarLog("72e88df6b4c4 - ...::capturaDeDatosEcommerce(...) <- ignorado por iFlagTiendaLocal=1");
	}
	//FINALIZA LLAMADO DE SERVICIO DE CORREOS
}

//3858 
void CDlgCapturarAbono::menuClubDeProteccionSalud()
{
	char cLog[500] = { 0 };
	long lCuotaTemporalPS = 0L, lCuotaAdicionalesPS = 0L, lCuotaPS = 0L;
	int fontID = 0;
	char cTexto[120] = { 0 };
	CString sDato = "";

	sprintf_s(cLog, "FC0200805021522316 - entra - menuClubDeProteccionSalud");
	grabarLog(cLog);

	CargarDLLCS cargarDllCS;

	cargarDllCS.addParam(cIPServidorTiendaNumero);

	sprintf_s(cTexto, "%d", m_grid.iTienda);
	cargarDllCS.addParam(cTexto);
	memset(cTexto, 0, sizeof(cTexto));

	sprintf_s(cTexto, "%d", m_grid.iSistema);
	cargarDllCS.addParam(cTexto);
	memset(cTexto, 0, sizeof(cTexto));

	sprintf_s(cTexto, "%d", iCiudadGnDominio);
	cargarDllCS.addParam(cTexto); //Ciudad
	memset(cTexto, 0, sizeof(cTexto));

	sprintf_s(cTexto, "%c", m_grid.cArea);
	cargarDllCS.addParam(cTexto);
	memset(cTexto, 0, sizeof(cTexto));

	sprintf_s(cTexto, "%d", m_grid.iCaja);
	cargarDllCS.addParam(cTexto);
	memset(cTexto, 0, sizeof(cTexto));

	sprintf_s(cTexto, "%ld", m_grid.lEmpleado);
	cargarDllCS.addParam(cTexto);
	memset(cTexto, 0, sizeof(cTexto));

	sprintf_s(cTexto, "%ld", m_grid.lCliente);
	cargarDllCS.addParam(cTexto);
	memset(cTexto, 0, sizeof(cTexto));

	cargarDllCS.addParam("4"); // tipo de seguro
	cargarDllCS.addParam("1"); //tipo de cliente

	cargarDllCS.cargarDllCS("C:\\SYS\\PROGX\\CA\\CA0219.DLL", "MenuClubDeProteccionSalud.frmPrincipal");

	iPlanAdicionales = 0;
	CCuentaWeb *pCuentaCliente = new CCuentaWeb();
	pCuentaCliente->iniciarCCuenta(m_grid.lCliente, cFechaTienda, (short)m_grid.iTienda, (short)iCiudadGnDominio, cIpServidorCartera, cIpServidorCCuentaWeb, (short)iFlagTimeOutCCuenta);
	pCuentaCliente->leerCliente();

	// se encontro al cliente en la cartera
	if (pCuentaCliente->bClienteValido)
	{
		memset(&candidatoReestructura, 0, sizeof(SCandidatoReestructura));
		pCuentaCliente->leerTienda01();

		for (int i = 0; i < pCuentaCliente->iCuentas; i++)
		{
			if (pCuentaCliente->pCuenta[i].iTipoDeCuenta == CUENTA_PLANSALUD) //Cuenta de Plan de Salud
			{
				if (pCuentaCliente->pCuenta[i].cStatusSeguro == 'C') // poliza cancelada
				{
					continue;
				}

				if (pCuentaCliente->pCuenta[i].i64IduAdicional > 0)
				{
					iPlanAdicionales++;

					iFlagTienePlanAdicional = 1; //Tiene Plan Adicional

					// obtener importe de acuerdo al plan del adicional
					lCuotaTemporalPS = 0;
					consultarPrecioPlanSalud(lCuotaTemporalPS, lCuotaTemporalPS, lCuotaTemporalPS, pCuentaCliente->pCuenta[i].iCantidadSeguros, 4);
					lCuotaAdicionalesPS += lCuotaTemporalPS;
					lCuotaPS += lCuotaTemporalPS;

					sDato.Format("ADIC %d", iPlanAdicionales);
					m_grid.QuickSetText(iColumnaPlan, 5, sDato);
					m_grid.QuickSetAlignment(iColumnaPlan, 5, UG_ALIGNCENTER);

					usingx("###,###", cTexto, (double)lCuotaPS);
					m_grid.QuickSetText(iColumnaPlan, 16, cTexto);
					m_grid.QuickSetAlignment(iColumnaPlan, 16, UG_ALIGNCENTER);

					continue;
				}

				// titulo columna
				m_grid.QuickSetText(iColumnaPlan, -1, "P.SALUD");

				// poliza
				sDato.Format("%I64d", pCuentaCliente->pCuenta[i].i64Poliza);
				m_grid.QuickSetText(iColumnaPlan, 1, sDato);
				m_grid.QuickSetAlignment(iColumnaPlan, 1, UG_ALIGNRIGHT);

				sprintf_s(cTexto, "%04d%02d%02d", iAnioActual, iMesActual, iDiaActual);
				if (pCuentaCliente->pCuenta[i].tFechaFinVigencia.ano() != 1900)
				{
					iDiasVencidosPS = diasTranscurridos(cTexto, (short)pCuentaCliente->pCuenta[i].tFechaFinVigencia.dia(), (short)pCuentaCliente->pCuenta[i].tFechaFinVigencia.mes(), (short)pCuentaCliente->pCuenta[i].tFechaFinVigencia.ano());
				}
				else
				{
					iDiasVencidosPS = 0;
				}

				if ((pCuentaCliente->pCuenta[i].tFechaFinVigencia.ano() == 1900 && (bCandidatoPSVenta || bCandidatoPSAbono)) /*|| (bBanderaTienePlan && iDiasVencidosPS > 90)*/)
				{
					// leyenda AFILIAR para cliente candidato
					m_grid.QuickSetText(iColumnaPlan, 2, " AFILIAR  "); // renglon FECHA COMPRA
					m_grid.QuickSetAlignment(iColumnaPlan, 2, UG_ALIGNCENTER);

					// limpiar celda de la poliza pues no tiene plan 
					m_grid.QuickSetText(iColumnaPlan, 1, "         ");
					m_grid.QuickSetAlignment(iColumnaPlan, 1, UG_ALIGNRIGHT);
				}
				else
				{
					// leyenda AFILIADO para cliente con plan
					m_grid.QuickSetText(iColumnaPlan, 2, " AFILIADO  "); // renglon FECHA COMPRA
					m_grid.QuickSetAlignment(iColumnaPlan, 2, UG_ALIGNCENTER);

					// fecha vencimiento
					miniFecha(cTexto, pCuentaCliente->pCuenta[i].tFechaFinVigencia.dia(), pCuentaCliente->pCuenta[i].tFechaFinVigencia.mes(), pCuentaCliente->pCuenta[i].tFechaFinVigencia.ano());
					m_grid.QuickSetText(iColumnaPlan, 4, cTexto);
					m_grid.QuickSetAlignment(iColumnaPlan, 4, UG_ALIGNCENTER);
				}

				// si solo tiene un adicional y se hizo cancelacion del adicional limpiar la etiqueta en el grid
				m_grid.QuickSetText(iColumnaPlan, 5, "");

				// leyenda P. SALUD
				fontID = m_grid.AddFont("Lucida Console Bold", 14, 600);
				m_grid.QuickSetFont(iColumnaPlan, 3, fontID);
				m_grid.QuickSetText(iColumnaPlan, 3, " P. SALUD ");
				m_grid.QuickSetAlignment(iColumnaPlan, 3, UG_ALIGNCENTER);

				// nombre del plan
				consultarNombrePlan(cTexto, pCuentaCliente->pCuenta[i].iCantidadSeguros, 4); // 4 plan salud
				m_grid.QuickSetText(iColumnaPlan, 12, cTexto);
				m_grid.QuickSetAlignment(iColumnaPlan, 12, UG_ALIGNCENTER);

				// cuota
				m_grid.QuickSetText(iColumnaPlan, 15, "CUOTA");
				m_grid.QuickSetAlignment(iColumnaPlan, 15, UG_ALIGNCENTER);

				// importe cuota titular
				consultarPrecioPlanSalud(lCuotaTemporalPS, lCuotaTemporalPS, lCuotaTemporalPS, pCuentaCliente->pCuenta[i].iCantidadSeguros, 4);
				lCuotaPS += lCuotaTemporalPS;
				usingx("###,###", cTexto, (double)lCuotaPS);
				m_grid.QuickSetText(iColumnaPlan, 16, cTexto);
				m_grid.QuickSetAlignment(iColumnaPlan, 16, UG_ALIGNCENTER);

				iSumaAseguradaPlan = consultarSumaAseguradaPlanSalud(pCuentaCliente->pCuenta[i].iCantidadSeguros, 4); // 4 Tipo seguro plan salud

				sDato.Format("%02d%02d%02d", pCuentaCliente->pCuenta[i].tFechaFinVigencia.dia(), pCuentaCliente->pCuenta[i].tFechaFinVigencia.mes(), (pCuentaCliente->pCuenta[i].tFechaFinVigencia.ano() - 2000));
				m_grid.QuickSetText(iColumnaPlan, 25, sDato); // renglon no visible para obtener la fecha vigencia despues

				if (iDiasVencidosPS > 0) // tiene vencido
				{
					bTieneVencidoPlan = true;
					bCandidatoPSAbono = true;
					m_grid.QuickSetText(iColumnaPlan, 2, " P. SALUD "); // renglon FECHA COMPRA
					m_grid.QuickSetAlignment(iColumnaPlan, 2, UG_ALIGNCENTER);

					m_grid.QuickSetText(iColumnaPlan, 3, "VENCIO EL");
					m_grid.QuickSetAlignment(iColumnaPlan, 3, UG_ALIGNCENTER);
				}
			}
		}
	}
	delete pCuentaCliente;
}

void CDlgCapturarAbono::sumarDias(short iDiasASumar, short &iDia, short &iMes, short &iAnio)
{
	char cLog[500] = { 0 };
	short iDiaLocal, iMesLocal, iAnioLocal;
	short iDiasDelMes[] = { 0,31,28,31,30,31,30,31,31,30,31,30,31,31 };

	if ((iAnio % 4) == 0)
	{
		iDiasDelMes[2] = 29;
	}

	iDiaLocal = iDia;
	iMesLocal = iMes;
	iAnioLocal = iAnio;

	iDiaLocal += iDiasASumar;

	if (iDiaLocal < 1)
	{
		if (iMesLocal == 1)
		{
			iMesLocal = 12;
			iAnioLocal--;
		}
		else
		{
			iMesLocal--;
		}

		iDiaLocal = iDiasDelMes[iMesLocal] + iDiaLocal;
	}

	if (iDiaLocal > iDiasDelMes[iMesLocal])
	{
		iDiaLocal = iDiaLocal - iDiasDelMes[iMesLocal];
		iMesLocal++;
		if (iMesLocal > 12)
		{
			iMesLocal = 1;
			iAnioLocal++;
		}
	}

	iDia = iDiaLocal;
	iMes = iMesLocal;
	iAnio = iAnioLocal;
}

int CDlgCapturarAbono::diasTranscurridos(char *cFechaActual, short iDia, short iMes, short iAnio)
{
	char cLog[500] = { 0 };
	int iDiasTranscurridos = 0;
	char cAux[10] = { 0 };

	sprintf_s(cLog, "FC0200805021522326 - entra - diasTranscurridos");
	grabarLog(cLog);

	sprintf_s(cAux, "%04d%02d%02d", iAnio, iMes, iDia);
	while (atoi(cFechaActual) > atoi(cAux))
	{
		iDiasTranscurridos++;
		sumarDias(1, iDia, iMes, iAnio);
		sprintf_s(cAux, "%04d%02d%02d", iAnio, iMes, iDia);
	}
	return iDiasTranscurridos;
}

void CDlgCapturarAbono::obtenerIduConexion()
{
	char cLog[500] = { 0 };
	CString sTexto = "";

	sprintf_s(cLog, "FC0200805021522330 - entra - obtenerIduConexion");
	grabarLog(cLog);

	sTexto.Format("SELECT idu_conexion FROM fun_tdobtneriduconexion('%d');", m_grid.iCaja);
	CConsultarMensajeSeguro obtenerConexion(&odbc); // se reutiliza clase que regresa una cadena

	if (!obtenerConexion.Exec(sTexto))
	{
		//Se obtiene el error
		obtenerConexion.odbc->GetLastError(obtenerConexion.GetHstmt());
		grabarMensajeError("C", m_grid.iCaja, (LPTSTR)(LPCTSTR)m_grid.sServer, "CapturarAbono", "CDlgCapturarAbono", "obtenerFlagPrestamoClienteNuevo", (LPTSTR)(LPCTSTR)sTexto, m_grid.lEmpleado, "ERROR EN LA CONSULTA(fun_tdobtneriduconexion)", obtenerConexion.odbc, m_grid.iMuestraMsg);
	}
	else
	{
		obtenerConexion.activarCols();
		if (obtenerConexion.Leer())
		{
			sprintf_s(cConexion, obtenerConexion.des_mensaje);
			grabarLog(cConexion);
		}
	}
}

void CDlgCapturarAbono::cargarVentaSegurosGenerales(int iTipoForma)
{
	char cLog[500] = { 0 };
	char cTexto[120] = { 0 }, cOutPut[2048] = { 0 };
	CargarDLLCS cargarDllCS;
	long lCuotaTemporalPS = 0L, lCuotaAdicionalesPS = 0L, lCuotaPS = 0L;
	int fontID = 0, iCantidadSegurosPS = 0, iGraboVenta = 0;
	CString sDato = "";

	sprintf_s(cLog, "FC0200805021522333 - entra - cargarVentaSegurosGenerales");
	grabarLog(cLog);

	grabarLog("cargarVentaSegurosGenerales::se manda llamar CA0220 para venta de plan");

	cargarDllCS.addParam(cIPServidorTiendaNumero);

	sprintf_s(cTexto, "%d", m_grid.iTienda);
	cargarDllCS.addParam(cTexto);
	memset(cTexto, 0, sizeof(cTexto));

	sprintf_s(cTexto, "%d", m_grid.iSistema);
	cargarDllCS.addParam(cTexto);
	memset(cTexto, 0, sizeof(cTexto));

	sprintf_s(cTexto, "%d", iCiudadGnDominio);
	cargarDllCS.addParam(cTexto); //Ciudad
	memset(cTexto, 0, sizeof(cTexto));

	sprintf_s(cTexto, "%c", m_grid.cArea);
	cargarDllCS.addParam(cTexto);
	memset(cTexto, 0, sizeof(cTexto));

	sprintf_s(cTexto, "%d", m_grid.iCaja);
	cargarDllCS.addParam(cTexto);
	memset(cTexto, 0, sizeof(cTexto));

	sprintf_s(cTexto, "%ld", m_grid.lEmpleado);
	cargarDllCS.addParam(cTexto);
	memset(cTexto, 0, sizeof(cTexto));

	sprintf_s(cTexto, "%ld", m_grid.lCliente);
	cargarDllCS.addParam(cTexto);
	memset(cTexto, 0, sizeof(cTexto));

	cargarDllCS.addParam("C"); // clave origen(C coppel, B bancoppel)

	cargarDllCS.addParam("4"); // tipo de seguro

	sprintf_s(cTexto, "%ld", iTipoForma);
	cargarDllCS.addParam(cTexto); //tipo forma(1 titular, 2 adicional)
	memset(cTexto, 0, sizeof(cTexto));

	cargarDllCS.cargarDllCS("C:\\SYS\\PROGX\\CA\\CA0220.DLL", "SegurosGeneralesVenta.frmSegurosGeneralesVenta", cOutPut);

	if (atoi(cOutPut) == 1) // grabo venta plan
	{
		grabarLog("cargarVentaSegurosGenerales::se hizo venta de plan");
		iPlanAdicionales = 0;
		bCandidatoPSVenta = false;
		bBanderaTienePlan = true;
		CCuentaWeb *pCuentaCliente = new CCuentaWeb();
		pCuentaCliente->iniciarCCuenta(m_grid.lCliente, cFechaTienda, (short)m_grid.iTienda, (short)iCiudadGnDominio, cIpServidorCartera, cIpServidorCCuentaWeb, (short)iFlagTimeOutCCuenta);
		pCuentaCliente->leerCliente();

		// se encontro al cliente en la cartera
		if (pCuentaCliente->bClienteValido)
		{
			memset(&candidatoReestructura, 0, sizeof(SCandidatoReestructura));
			pCuentaCliente->leerTienda01();

			for (int i = 0; i < pCuentaCliente->iCuentas; i++)
			{
				if (pCuentaCliente->pCuenta[i].iTipoDeCuenta == CUENTA_PLANSALUD) //Cuenta de Plan de Salud
				{
					if (pCuentaCliente->pCuenta[i].cStatusSeguro == 'C') // poliza cancelada
					{
						continue;
					}

					if (pCuentaCliente->pCuenta[i].i64IduAdicional > 0)
					{
						iPlanAdicionales++;

						iFlagTienePlanAdicional = 1; //Tiene Plan Adicional

						// obtener importe de acuerdo al plan del adicional
						lCuotaTemporalPS = 0;
						consultarPrecioPlanSalud(lCuotaTemporalPS, lCuotaTemporalPS, lCuotaTemporalPS, pCuentaCliente->pCuenta[i].iCantidadSeguros, 4);
						lCuotaAdicionalesPS += lCuotaTemporalPS;
						lCuotaPS += lCuotaTemporalPS;

						sDato.Format("ADIC %d", iPlanAdicionales);
						m_grid.QuickSetText(iColumnaPlan, 5, sDato);
						m_grid.QuickSetAlignment(iColumnaPlan, 5, UG_ALIGNCENTER);

						usingx("###,###", cTexto, (double)lCuotaPS);
						m_grid.QuickSetText(iColumnaPlan, 16, cTexto);
						m_grid.QuickSetAlignment(iColumnaPlan, 16, UG_ALIGNCENTER);

						continue;
					}

					// titulo columna
					m_grid.QuickSetText(iColumnaPlan, -1, "P.SALUD");

					// poliza
					sDato.Format("%I64d", pCuentaCliente->pCuenta[i].i64Poliza);
					m_grid.QuickSetText(iColumnaPlan, 1, sDato);
					m_grid.QuickSetAlignment(iColumnaPlan, 1, UG_ALIGNRIGHT);

					// leyenda AFILIADO para cliente con plan activo o con menos de 90 dias de vencido
					m_grid.QuickSetText(iColumnaPlan, 2, " AFILIADO  "); // renglon FECHA COMPRA
					m_grid.QuickSetAlignment(iColumnaPlan, 2, UG_ALIGNCENTER);

					// fecha vencimiento
					miniFecha(cTexto, pCuentaCliente->pCuenta[i].tFechaFinVigencia.dia(), pCuentaCliente->pCuenta[i].tFechaFinVigencia.mes(), pCuentaCliente->pCuenta[i].tFechaFinVigencia.ano());
					m_grid.QuickSetText(iColumnaPlan, 4, cTexto);
					m_grid.QuickSetAlignment(iColumnaPlan, 4, UG_ALIGNCENTER);

					// leyenda P. SALUD
					fontID = m_grid.AddFont("Lucida Console Bold", 14, 600);
					m_grid.QuickSetFont(iColumnaPlan, 3, fontID);
					m_grid.QuickSetText(iColumnaPlan, 3, " P. SALUD ");
					m_grid.QuickSetAlignment(iColumnaPlan, 3, UG_ALIGNCENTER);

					// nombre del plan
					consultarNombrePlan(cTexto, pCuentaCliente->pCuenta[i].iCantidadSeguros, 4); // 4 plan salud
					m_grid.QuickSetText(iColumnaPlan, 12, cTexto);
					m_grid.QuickSetAlignment(iColumnaPlan, 12, UG_ALIGNCENTER);

					// cuota
					m_grid.QuickSetText(iColumnaPlan, 15, "CUOTA");
					m_grid.QuickSetAlignment(iColumnaPlan, 15, UG_ALIGNCENTER);

					// importe cuota titular
					consultarPrecioPlanSalud(lCuotaTemporalPS, lCuotaTemporalPS, lCuotaTemporalPS, pCuentaCliente->pCuenta[i].iCantidadSeguros, 4);
					lCuotaPS += lCuotaTemporalPS;
					usingx("###,###", cTexto, (double)lCuotaPS);
					m_grid.QuickSetText(iColumnaPlan, 16, cTexto);
					m_grid.QuickSetAlignment(iColumnaPlan, 16, UG_ALIGNCENTER);

					iSumaAseguradaPlan = consultarSumaAseguradaPlanSalud(pCuentaCliente->pCuenta[i].iCantidadSeguros, 4); // 4 Tipo seguro plan salud

					sDato.Format("%02d%02d%02d", pCuentaCliente->pCuenta[i].tFechaFinVigencia.dia(), pCuentaCliente->pCuenta[i].tFechaFinVigencia.mes(), (pCuentaCliente->pCuenta[i].tFechaFinVigencia.ano() - 2000));
					m_grid.QuickSetText(iColumnaPlan, 25, sDato); // renglon no visible para obtener la fecha vigencia despues
				}
			}
		}
		delete pCuentaCliente;
	}
}

void CDlgCapturarAbono::cargarAbonosCambiosDePlanSegurosGenerales()
{
	char cLog[500] = { 0 };
	bool bContinar = false, bCrearEstructura = true;
	int iImportePlan = 0, iIduPlan = 0, iIduAdicional = 0, iNumMeses = 0, iFolioPoliza = 0, iFolioPolizaAnterior = 0,
		iDiaVig = 0, iMesVig = 0, iAnioVig = 0, fontID = 0, iImporteTitular = 0, iImportePlanIndividual = 0, iContadorCambioPlan = 0, iSumaAseguradaIndividual = 0,
		iCuota1Mes = 0, iNumMesesIndividual = 0;
	char cFechaNuevaVigencia[15] = { 0 }, cTexto[120] = { 0 };
	CString sSql = "", sTexto = "";

	sprintf_s(cLog, "FC0200805021522340 - entra - cargarAbonosCambiosDePlanSegurosGenerales");
	grabarLog(cLog);

	CargarDLLCS cargarDllCS;

	grabarLog("cargarAbonosCambiosDePlanSegurosGenerales::se manda llamar CA0224 para abonos y cambios de plan");

	cargarDllCS.addParam(cIPServidorTiendaNumero);

	sprintf_s(cTexto, "%d", m_grid.iTienda);
	cargarDllCS.addParam(cTexto);
	memset(cTexto, 0, sizeof(cTexto));

	sprintf_s(cTexto, "%c", m_grid.cArea);
	cargarDllCS.addParam(cTexto);
	memset(cTexto, 0, sizeof(cTexto));

	sprintf_s(cTexto, "%d", m_grid.iCaja);
	cargarDllCS.addParam(cTexto);
	memset(cTexto, 0, sizeof(cTexto));

	sprintf_s(cTexto, "%ld", m_grid.lEmpleado);
	cargarDllCS.addParam(cTexto);
	memset(cTexto, 0, sizeof(cTexto));

	sprintf_s(cTexto, "%ld", m_grid.lCliente);
	cargarDllCS.addParam(cTexto);
	memset(cTexto, 0, sizeof(cTexto));

	cargarDllCS.addParam("4"); // tipo de seguro

	cargarDllCS.addParam("1"); // tipo cliente (1 coppel)

	cargarDllCS.addParam(cConexion);

	sprintf_s(cTexto, "%ld", lNumeroRecibo);
	cargarDllCS.addParam(cTexto);
	memset(cTexto, 0, sizeof(cTexto));

	cargarDllCS.cargarDllCS("C:\\SYS\\PROGX\\CA\\CA0224.DLL", "SegurosGeneralesAbonosCambioDePlan.frmPrincipal");

	// capturar datos plan salud
	sSql.Format("SELECT importe,cantidadmeses,fechavencimiento,fol_sucursal,cantidadseguros,folio, factura, fechaabonoajuste FROM mov_cacarmovtemporal WHERE num_cliente = %ld AND cajaoriginal = %d AND idu_conexion = '%s' AND num_movimiento in (25,27) ORDER BY fol_sucursal",
		m_grid.lCliente, m_grid.iCaja, cConexion);

	CObtenerDatosCacarmovTemporal obtenerDatosCacarmovTemporal(&odbc);
	if (obtenerDatosCacarmovTemporal.Exec(sSql))
	{
		obtenerDatosCacarmovTemporal.activarCols();
		while (obtenerDatosCacarmovTemporal.Leer())
		{
			bContinar = true;
			bTieneDatosEnTemporales = true;
			bTieneVencidoPlan = false;
			bCandidatoPSAbono = false;
			iIduAdicional = (int)obtenerDatosCacarmovTemporal.fol_sucursal;
			iImportePlanIndividual = obtenerDatosCacarmovTemporal.importe;
			iImportePlan += iImportePlanIndividual;
			iNumMesesIndividual = obtenerDatosCacarmovTemporal.cantidadmeses;
			iCuota1Mes += (iImportePlanIndividual / iNumMesesIndividual);
			if (iIduAdicional == 0)// titular
			{
				iImporteTitular = obtenerDatosCacarmovTemporal.importe;
				iNumMeses = obtenerDatosCacarmovTemporal.cantidadmeses;
				iFolioPolizaAnterior = obtenerDatosCacarmovTemporal.factura; // si es > 0, hizo cambio de plan
				iDiaVig = obtenerDatosCacarmovTemporal.fechavencimiento.dia();
				iMesVig = obtenerDatosCacarmovTemporal.fechavencimiento.mes();
				iAnioVig = obtenerDatosCacarmovTemporal.fechavencimiento.ano();
				sprintf_s(cFechaNuevaVigencia, "%04d-%02d-%02d", iAnioVig, iMesVig, iDiaVig);

				iIduPlan = obtenerDatosCacarmovTemporal.cantidadseguros;
				iFolioPoliza = obtenerDatosCacarmovTemporal.folio;

				iSumaAseguradaPlan = consultarSumaAseguradaPlanSalud((short)iIduPlan, (short)4);
			}

			iSumaAseguradaIndividual = consultarSumaAseguradaPlanSalud(obtenerDatosCacarmovTemporal.cantidadseguros, 4);

			if (obtenerDatosCacarmovTemporal.factura > 0) // si es cambio de plan, llenar datos para impresion de las polizas
			{
				iCambiosDePlan++;
				if (bCrearEstructura)
				{
					bCrearEstructura = false;
					stCambioPlanes = new STCambioPlanes[iMaxAdicionales];
					for (int i = 0; i < iMaxAdicionales; i++)
					{
						memset(&stCambioPlanes[i], 0, sizeof(STCambioPlanes));
					}
				}

				stCambioPlanes[iContadorCambioPlan].lFolioPoliza = obtenerDatosCacarmovTemporal.folio;
				stCambioPlanes[iContadorCambioPlan].iIduAdicional = iIduAdicional;
				stCambioPlanes[iContadorCambioPlan].iIduPlan = obtenerDatosCacarmovTemporal.cantidadseguros;
				stCambioPlanes[iContadorCambioPlan].lSumaAsegurada = iSumaAseguradaIndividual;
				stCambioPlanes[iContadorCambioPlan].lImporte = iImportePlanIndividual / 100;
				sprintf_s(stCambioPlanes[iContadorCambioPlan].cFechaInicial, "%04d%02d%02d", obtenerDatosCacarmovTemporal.fechaabonoajuste.ano(), obtenerDatosCacarmovTemporal.fechaabonoajuste.mes(), obtenerDatosCacarmovTemporal.fechaabonoajuste.dia());
				sprintf_s(stCambioPlanes[iContadorCambioPlan].cFechaFinal, "%04d%02d%02d", obtenerDatosCacarmovTemporal.fechavencimiento.ano(), obtenerDatosCacarmovTemporal.fechavencimiento.mes(), obtenerDatosCacarmovTemporal.fechavencimiento.dia());
				stCambioPlanes[iContadorCambioPlan].lRecibo = lNumeroRecibo;
				stCambioPlanes[iContadorCambioPlan].lFolioPolizaAnterior = obtenerDatosCacarmovTemporal.factura;
				iContadorCambioPlan++;
			}
		}
	}
	else
	{
		obtenerDatosCacarmovTemporal.odbc->GetLastError(obtenerDatosCacarmovTemporal.GetHstmt());
		grabarMensajeError("C", m_grid.iCaja, (LPTSTR)(LPCTSTR)m_grid.sServer, "CA0030", "CDlgCapturarAbono", "cargarAbonosCambiosDePlanSegurosGenerales", (LPTSTR)(LPCTSTR)sSql, m_grid.lEmpleado, "ERROR", obtenerDatosCacarmovTemporal.odbc, m_grid.iMuestraMsg);
	}

	if (bContinar)
	{
		grabarLog("cargarAbonosCambiosDePlanSegurosGenerales::se hizo abono o cambio de plan");
		iColumnaPlan = (short)m_grid.GetCurrentCol();

		if (iFolioPolizaAnterior > 0) // hizo cambio de plan
		{
			if (iFolioPoliza > 0)
			{
				sTexto.Format("%ld", iFolioPoliza);
				m_grid.QuickSetText(iColumnaPlan, 1, sTexto);
				m_grid.QuickSetAlignment(iColumnaPlan, 1, UG_ALIGNRIGHT);
			}
		}

		if (!bBanderaTienePlan || (bBanderaTienePlan && iDiasVencidosPS > 90) || (iDiasVencidosPS > 0 && iDiasVencidosPS <= 90)) // no tiene plan o tiene vencido
		{
			m_grid.QuickSetText(iColumnaPlan, 2, " AFILIADO  "); // renglon FECHA COMPRA
			m_grid.QuickSetAlignment(iColumnaPlan, 2, UG_ALIGNCENTER);

			fontID = m_grid.AddFont("Lucida Console Bold", 14, 600);
			m_grid.QuickSetFont(iColumnaPlan, 3, fontID);
			m_grid.QuickSetText(iColumnaPlan, 3, " P. SALUD "); // renglon IMPORTE
			m_grid.QuickSetAlignment(iColumnaPlan, 3, UG_ALIGNCENTER);

			// cuota de todos los seguros activos
			usingx("###,###", cTexto, (double)iCuota1Mes / 100);
			m_grid.QuickSetText(iColumnaPlan, 16, cTexto);
			m_grid.QuickSetAlignment(iColumnaPlan, 16, UG_ALIGNCENTER);
		}

		miniFecha(cTexto, iDiaVig, iMesVig, iAnioVig); // fecha nueva vigencia
		m_grid.QuickSetText(iColumnaPlan, 4, cTexto); // renglon despues de IMPORTE
		m_grid.QuickSetAlignment(iColumnaPlan, 4, UG_ALIGNCENTER);

		// nombre del plan
		consultarNombrePlan(cTexto, (short)iIduPlan, (short)4); // 4 plan salud
		m_grid.QuickSetText(iColumnaPlan, 12, cTexto);
		m_grid.QuickSetAlignment(iColumnaPlan, 12, UG_ALIGNCENTER);

		sTexto.Format("# MESES %d", iNumMeses);
		m_grid.QuickSetText(iColumnaPlan, 13, sTexto); // renglon INTERESES ADIC
		m_grid.QuickSetAlignment(iColumnaPlan, 13, UG_ALIGNCENTER);

		sTexto.Format("%ld", iImportePlan / 100);
		m_grid.QuickSetText(iColumnaPlan, 21, sTexto); // renglon SU PAGO
		m_grid.QuickSetAlignment(iColumnaPlan, 21, UG_ALIGNRIGHT);

		sTexto.Format("%02d%02d%02d", iDiaVig, iMesVig, (iAnioVig - 2000));
		m_grid.QuickSetText(iColumnaPlan, 25, sTexto); // renglon no visible para obtener la fecha vigencia despues

		m_grid.RedrawAll();
	}
}

bool CDlgCapturarAbono::grabarCacarmovPlan()
{
	char cLog[500] = { 0 };
	bool bRegresa = true;
	char cSql[200] = { 0 };
	CString sXml = "";

	sprintf_s(cLog, "FC0200805021522346 - entra - grabarCacarmovPlan");
	grabarLog(cLog);

	if (bTieneDatosEnTemporales)
	{
		grabarLog("grabarCacarmovPlan::grabando cacarmov de plan");

		sXml.Format("<Datos>"
			"<TipoGrabado>3</TipoGrabado>"
			"<idu_conexion>%s</idu_conexion>"
			"</Datos>", cConexion);

		sprintf_s(cSql, "SELECT status FROM fun_tdgrabarcacarmov('%s');", (LPCTSTR)sXml);

		CMaximo cacarmovPlan(&odbc, false);

		if (cacarmovPlan.Exec(cSql))
		{
			cacarmovPlan.activarCols();
			if (cacarmovPlan.Leer())
			{
				if (cacarmovPlan.Total != 0)
				{
					bRegresa = false;
					cacarmovPlan.odbc->GetLastError(cacarmovPlan.GetHstmt());
					grabarMensajeError("C", m_grid.iCaja, (LPTSTR)(LPCTSTR)m_grid.sServer, "CapturarAbono", "CDlgCapturarAbono", "grabarCacarmovPlan", cSql, m_grid.lEmpleado, "ERROR EN LA CONSULTA(fun_tdgrabarcacarmov)", cacarmovPlan.odbc, m_grid.iMuestraMsg);
				}
			}
		}
		else
		{
			bRegresa = false;
			cacarmovPlan.odbc->GetLastError(cacarmovPlan.GetHstmt());
			grabarMensajeError("C", m_grid.iCaja, (LPTSTR)(LPCTSTR)m_grid.sServer, "CapturarAbono", "CDlgCapturarAbono", "grabarCacarmovPlan", cSql, m_grid.lEmpleado, "ERROR AL EJECUTAR(fun_tdgrabarcacarmov)", cacarmovPlan.odbc, m_grid.iMuestraMsg);
		}
	}
	return  bRegresa;
}

bool CDlgCapturarAbono::grabarTdBeneficiariosPlan()
{
	char cLog[500] = { 0 };
	bool bRegresa = true, bError = false;
	char cSql[180] = { 0 };
	int iRespuesta = 0;

	sprintf_s(cLog, "FC0200805021522349 - entra - grabarTdBeneficiariosPlan");
	grabarLog(cLog);

	if (bTieneDatosEnTemporales)
	{
		grabarLog("grabarMaeBeneficiariosSeguro::grabando beneficiarios plan en cartera");

		CMaximo tdBeneficiariosPlan(&odbc, false);

		sprintf_s(cSql, "SELECT fun_TdGrabarBeneficiarios FROM fun_TdGrabarBeneficiarios(3,0,'0',0,0,'','','','1900-01-01','0','0','0',0,'1900-01-01','0','0','0',0,'%s');", cConexion);

		if (!tdBeneficiariosPlan.Exec(cSql))
		{
			bRegresa = false;
			tdBeneficiariosPlan.odbc->GetLastError(tdBeneficiariosPlan.GetHstmt());
			grabarMensajeError("C", m_grid.iCaja, (LPTSTR)(LPCTSTR)m_grid.sServer, "CapturarAbono", "CDlgCapturarAbono", "grabarTdBeneficiariosPlan", cSql, m_grid.lEmpleado, "ERROR EN LA CONSULTA(fun_TdGrabarBeneficiarios)", tdBeneficiariosPlan.odbc, m_grid.iMuestraMsg);
		}
	}
	return bRegresa;
}

bool CDlgCapturarAbono::grabarCarmovxPlan()
{
	char cLog[500] = { 0 };
	bool bRegresa = true;
	char cSql[1100] = { 0 };
	CString sXml = "", sXmlBeneficiarios = "";
	int iRespuesta = 0, icontador = 0;

	sprintf_s(cLog, "FC0200805021522353 - entra - grabarCarmovxPlan");
	grabarLog(cLog);

	if (bTieneDatosEnTemporales || iAplicoDescuento)
	{
		grabarLog("grabarCarmovxPlan::grabando abonos de plan en carmovx");

		CGrabarCrCarmovX consultarCaCarmov(&odbc, false);
		CConsultarBeneficiariosSeguroTemp beneficiariosSeguro(&odbc, false);
		CMaximo carmovxPlan(&odbc_1, false);

		sprintf_s(cSql, "SELECT clave, tipomovimiento, tienda, ciudad, cliente, clienteetp, caja, recibo, factura, importe, saldoinicial, saldofinal, saldocuenta,"
			"vencidoinicial, minimoinicial, base, fechasaldacon, importesaldacon, tipoconvenio, subtipoconvenio, plazoconvenio, ejercicio, clavetdaocob,"
			"grabacartera, anexo, clavelocal, clientelocalizar, tiposeguro, flagseguroconyugal, movtoseguro, flagmontoseguro, statusseguro, causabaja,"
			"cantidadseguros, cantidadsegurosanterior, cantidadmeses, bonificacion, mesesvencidos, fechanacimiento, edad, sexo, areaajuste,"
			"fechaabonoajuste, claveajuste, ajuste, tiendaorigen, numerocontrol, comision, clienteremitente, tipogastoviaje, centro, flagincluyerecibo,"
			"ruta, folio, cuenta, iva, telefono, compania, contrato, credito, fechavencimiento, fechavencimientoanterior, fecha, efectuo, cajaoriginal,"
			"foliotienda, rpu, flagmovtosupervisor, interes, importeventa, folioanterior, digito, sac, ipcarteracliente,"
			"fol_sucursal, num_cliente, num_movimiento, clv_statusmovimiento, fechadocumento "
			"FROM cacarmov WHERE recibo = %ld and caja = %d and clave = '2'", lNumeroRecibo, iCajaActual);

		if (!consultarCaCarmov.Exec(cSql))
		{
			bRegresa = false;
			consultarCaCarmov.odbc->GetLastError(consultarCaCarmov.GetHstmt());
			grabarMensajeError("C", m_grid.iCaja, (LPTSTR)(LPCTSTR)m_grid.sServer, "CapturarAbono", "CDlgCapturarAbono", "GrabarCarmovx", cSql, m_grid.lEmpleado, "ERROR EN LA CONSULTA(GrabarCarmovx)", consultarCaCarmov.odbc, m_grid.iMuestraMsg);
		}
		else
		{
			consultarCaCarmov.activarCols();
			while (consultarCaCarmov.leer())
			{
				if (consultarCaCarmov.num_movimiento == 31 ||
					consultarCaCarmov.num_movimiento == 32 ||
					consultarCaCarmov.num_movimiento == 33 ||
					consultarCaCarmov.num_movimiento == 34 ||
					consultarCaCarmov.num_movimiento == 35)
				{
					sXml.Format("<Datos>"
						"<clave>%c</clave>"
						"<tipomovimiento></tipomovimiento>"
						"<cliente>%ld</cliente>"
						"<folio>%ld</folio>" // numero del recibo
						"<importe>%ld</importe>"
						"<fecha>%04d-%02d-%02d</fecha>" // fecha tienda
						"<factura>%ld</factura>" // folio de la poliza
						"<tienda>%d</tienda>"
						"<ciudadtiendamov>%d</ciudadtiendamov>" // ciudad
						"<diapago>4</diapago>" // idu_seguro(4)
						"<plazoconvenio>%d</plazoconvenio>" // tipo cliente(1 coppel 2 prospecto)
						"<efectuo>%ld</efectuo>"
						"<fechavencimiento>%04d-%02d-%02d</fechavencimiento>"
						"<cantidadseguros>%d</cantidadseguros>" // idu_plan(1,2,3)
						"<movtoseguro>C</movtoseguro>" // origen(C coppel B bancoppel)
						"<caja>%d</caja>"
						"<cajaoriginal>0</cajaoriginal>" // 0
						"<area>3</area>" // origen(C coppel B bancoppel)
						"<num_cliente>%I64d</num_cliente>" // cliente
						"<fol_recibo>%I64d</fol_recibo>" // idu_adicional
						"<num_movimiento>%d</num_movimiento>"
						"<clv_statusmovimiento>%d</clv_statusmovimiento>"
						"<tipoconvenio>%ld</tipoconvenio>"
						"<vencidoinicial>%ld</vencidoinicial>"
						"<saldoinicial>%ld</saldoinicial>"
						"<fechasaldacon>%04d%02d%02d</fechasaldacon>"
						"<saldocuenta>%ld</saldocuenta>", // 1
						consultarCaCarmov.clave[0], m_grid.lCliente, consultarCaCarmov.recibo, consultarCaCarmov.importe / 100, consultarCaCarmov.fecha.ano(), consultarCaCarmov.fecha.mes(), consultarCaCarmov.fecha.dia(),
						consultarCaCarmov.factura, consultarCaCarmov.tienda, consultarCaCarmov.ciudad, consultarCaCarmov.plazoconvenio, consultarCaCarmov.efectuo,
						consultarCaCarmov.fechavencimiento.ano(), consultarCaCarmov.fechavencimiento.mes(), consultarCaCarmov.fechavencimiento.dia(), consultarCaCarmov.cantidadseguros, consultarCaCarmov.caja,
						consultarCaCarmov.num_cliente, consultarCaCarmov.fol_sucursal, consultarCaCarmov.num_movimiento, consultarCaCarmov.clv_statusmovimiento, consultarCaCarmov.iva, consultarCaCarmov.vencidoinicial, consultarCaCarmov.saldoinicial,
						consultarCaCarmov.fechasaldacon.ano(), consultarCaCarmov.fechasaldacon.mes(), consultarCaCarmov.fechasaldacon.dia(), consultarCaCarmov.saldocuenta
						);
				}
				else
				{
					sXml.Format("<Datos>"
						"<clave>%c</clave>"
						"<tipomovimiento></tipomovimiento>"
						"<cliente>%ld</cliente>"
						"<folio>%ld</folio>" // numero del recibo
						"<importe>%ld</importe>"
						"<fecha>%04d-%02d-%02d</fecha>" // fecha tienda
						"<factura>%ld</factura>" // folio de la poliza
						"<tienda>%d</tienda>"
						"<ciudadtiendamov>%d</ciudadtiendamov>" // ciudad
						"<diapago>4</diapago>" // idu_seguro(4)
						"<plazoconvenio>%d</plazoconvenio>" // tipo cliente(1 coppel 2 prospecto)
						"<efectuo>%ld</efectuo>"
						"<fechavencimiento>%04d-%02d-%02d</fechavencimiento>"
						"<cantidadseguros>%d</cantidadseguros>" // idu_plan(1,2,3)
						"<movtoseguro>C</movtoseguro>" // origen(C coppel B bancoppel)
						"<caja>%d</caja>"
						"<cajaoriginal>0</cajaoriginal>" // 0
						"<area>C</area>" // origen(C coppel B bancoppel)
						"<num_cliente>%I64d</num_cliente>" // cliente
						"<fol_recibo>%I64d</fol_recibo>" // idu_adicional
						"<num_movimiento>%d</num_movimiento>"
						"<clv_statusmovimiento>%d</clv_statusmovimiento>", // 1
						consultarCaCarmov.clave[0], m_grid.lCliente, consultarCaCarmov.recibo, consultarCaCarmov.importe / 100, consultarCaCarmov.fecha.ano(), consultarCaCarmov.fecha.mes(), consultarCaCarmov.fecha.dia(),
						consultarCaCarmov.folio, consultarCaCarmov.tienda, consultarCaCarmov.ciudad, consultarCaCarmov.digito, consultarCaCarmov.efectuo,
						consultarCaCarmov.fechavencimiento.ano(), consultarCaCarmov.fechavencimiento.mes(), consultarCaCarmov.fechavencimiento.dia(), consultarCaCarmov.cantidadseguros, consultarCaCarmov.caja,
						consultarCaCarmov.num_cliente, consultarCaCarmov.fol_sucursal, consultarCaCarmov.num_movimiento, consultarCaCarmov.clv_statusmovimiento
						);
				}



				if (consultarCaCarmov.num_movimiento == 27) // cambio de plan
				{
					sXml.AppendFormat(
						"<devolucionfactura>%ld</devolucionfactura>" // folio poliza anterior
						"<abono>%d</abono>" // meses pagados
						"<fechasaldacon>%04d-%02d-%02d</fechasaldacon>" // fecha inicio vigencia
						"<fechanacimiento>%04d-%02d-%02d</fechanacimiento>", // fecha afiliacion
						consultarCaCarmov.factura, consultarCaCarmov.cantidadmeses,
						consultarCaCarmov.fechaabonoajuste.ano(), consultarCaCarmov.fechaabonoajuste.mes(), consultarCaCarmov.fechaabonoajuste.dia(),
						consultarCaCarmov.fechadocumento.ano(), consultarCaCarmov.fechadocumento.mes(), consultarCaCarmov.fechadocumento.dia()
						);
				}

				if (consultarCaCarmov.num_movimiento == 30) // alta/cambio de beneficiario
				{
					sprintf_s(cSql, "SELECT idu_seguro, fol_ultimapoliza, idu_adicional, nom_beneficiario, nom_apellidopaterno, nom_apellidomaterno, fec_nacimiento, idu_parentesco, num_orden, "
						"clv_sexo, num_telefono, prc_asignado, fec_altabeneficiario, num_movimiento, num_tienda, num_caja, num_recibo "
						"FROM mov_tdbeneficiarios WHERE num_caja = %d AND num_cliente = %ld AND idu_seguro = 4 AND fol_ultimapoliza = %ld AND idu_adicional = %I64d;",
						iCajaActual, m_grid.lCliente, consultarCaCarmov.folio, consultarCaCarmov.fol_sucursal);

					if (!beneficiariosSeguro.Exec(cSql))
					{
						bRegresa = false;
						beneficiariosSeguro.odbc->GetLastError(beneficiariosSeguro.GetHstmt());
						grabarMensajeError("C", m_grid.iCaja, (LPTSTR)(LPCTSTR)m_grid.sServer, "CapturarAbono", "CDlgCapturarAbono", "grabarCarmovxPlan", cSql, m_grid.lEmpleado, "ERROR EN LA CONSULTA(mov_tdbeneficiarios)", beneficiariosSeguro.odbc, m_grid.iMuestraMsg);
					}
					else
					{
						beneficiariosSeguro.activarCols();
						while (beneficiariosSeguro.leer())
						{
							sXmlBeneficiarios = sXml;
							sXmlBeneficiarios.AppendFormat(
								"<devolucionfactura>%ld</devolucionfactura>" // folio poliza anterior
								"<abono>%ld</abono>" // origen de cambio de beneficiario(27 cambio de plan)
								"<plazo>%d</plazo>" // orden captura beneficiario
								"<nombre>%s</nombre>"
								"<apellidopaterno>%s</apellidopaterno>"
								"<apellidomaterno>%s</apellidomaterno>"
								"<num_parentesco1>%d</num_parentesco1>"
								"<num_porcentaje1>%d</num_porcentaje1>"
								"<fec_nacimiento1>%04d-%02d-%02d</fec_nacimiento1>"
								"<num_telefono1>%I64d</num_telefono1>"
								"</Datos>",
								consultarCaCarmov.factura, consultarCaCarmov.iva, beneficiariosSeguro.num_orden, beneficiariosSeguro.nom_beneficiario, beneficiariosSeguro.nom_apellidopaterno, beneficiariosSeguro.nom_apellidomaterno,
								beneficiariosSeguro.idu_parentesco, beneficiariosSeguro.prc_asignado, beneficiariosSeguro.fec_nacimiento.ano(), beneficiariosSeguro.fec_nacimiento.mes(),
								beneficiariosSeguro.fec_nacimiento.dia(), beneficiariosSeguro.num_telefono
								);

							memset(cSql, 0, sizeof(cSql));
							sprintf_s(cSql, "SELECT status FROM fun_crgrabarcarmovx('%s');", (LPCTSTR)sXmlBeneficiarios);

							if (carmovxPlan.Exec(cSql))
							{
								carmovxPlan.activarCols();
								if (carmovxPlan.Leer())
								{
									if (carmovxPlan.Total != 0) // 0 es OK
									{
										bRegresa = false;
										break;
									}
								}
							}
							else
							{
								bRegresa = false;
								carmovxPlan.odbc->GetLastError(carmovxPlan.GetHstmt());
								grabarMensajeError("C", m_grid.iCaja, (LPTSTR)(LPCTSTR)m_grid.sServer, "CapturarAbono", "CDlgCapturarAbono", "grabarCarmovxPlan", cSql, m_grid.lEmpleado, "ERROR EN LA CONSULTA(fun_crgrabarcarmovx)", carmovxPlan.odbc, m_grid.iMuestraMsg);
								break;
							}

							carmovxPlan.ClearResults();
							carmovxPlan.ClearStatement();
						}

						beneficiariosSeguro.ClearResults();
						beneficiariosSeguro.ClearStatement();
					}
				}
				else
				{

					sXml.AppendFormat("</Datos>");

					memset(cSql, 0, sizeof(cSql));
					sprintf_s(cSql, "SELECT status FROM fun_crgrabarcarmovx('%s');", (LPCTSTR)sXml);

					carmovxPlan.ClearResults();
					carmovxPlan.ClearStatement();

					if (carmovxPlan.Exec(cSql))
					{
						carmovxPlan.activarCols();
						if (carmovxPlan.Leer())
						{
							if (carmovxPlan.Total != 0) // 0 es OK
							{
								bRegresa = false;
								break;
							}
						}
					}
					else
					{
						bRegresa = false;
						carmovxPlan.odbc->GetLastError(carmovxPlan.GetHstmt());
						grabarMensajeError("C", m_grid.iCaja, (LPTSTR)(LPCTSTR)m_grid.sServer, "CapturarAbono", "CDlgCapturarAbono", "grabarCarmovxPlan", cSql, m_grid.lEmpleado, "ERROR EN LA CONSULTA(fun_crgrabarcarmovx)", carmovxPlan.odbc, m_grid.iMuestraMsg);
						break;
					}

					carmovxPlan.ClearResults();
					carmovxPlan.ClearStatement();
				}
				if (iAplicoDescuento == 1 && icontador == 0)
				{

					sXml.Format("<Datos>"
						"<clave>%c</clave>"
						"<tipomovimiento></tipomovimiento>"
						"<cliente>%ld</cliente>"
						"<folio>%ld</folio>" // numero del recibo
						"<importe>1</importe>"
						"<fecha>%s</fecha>" // fecha tienda
						"<tienda>%d</tienda>"
						"<ciudadtiendamov>%d</ciudadtiendamov>" // ciudad
						"<efectuo>%ld</efectuo>"
						"<caja>%d</caja>"
						"<cajaoriginal>0</cajaoriginal>" // 0
						"<area>3</area>" // origen(C coppel B bancoppel)
						"<num_movimiento>36</num_movimiento>"
						"<clv_statusmovimiento>1</clv_statusmovimiento>"
						"</Datos>", '2', m_grid.lCliente, consultarCaCarmov.recibo, cFechaTienda, m_grid.iTienda, iCiudadGnDominio, m_grid.lEmpleado, m_grid.iCaja);

					memset(cSql, 0, sizeof(cSql));
					sprintf_s(cSql, "SELECT status FROM fun_crgrabarcarmovx('%s');", (LPCTSTR)sXml);

					if (carmovxPlan.Exec(cSql))
					{
						carmovxPlan.activarCols();
						if (carmovxPlan.Leer())
						{
							icontador++;
							if (carmovxPlan.Total != 0) // 0 es OK
							{
								bRegresa = false;

							}
						}
					}
					else
					{
						bRegresa = false;
						carmovxPlan.odbc->GetLastError(carmovxPlan.GetHstmt());
						grabarMensajeError("C", m_grid.iCaja, (LPTSTR)(LPCTSTR)m_grid.sServer, "CapturarAbono", "CDlgCapturarAbono", "grabarCarmovxPlan", cSql, m_grid.lEmpleado, "ERROR EN LA CONSULTA(fun_crgrabarcarmovx)", carmovxPlan.odbc, m_grid.iMuestraMsg);

					}

					carmovxPlan.ClearResults();
					carmovxPlan.ClearStatement();
				}
			}
		}
	}
	return bRegresa;
}

bool CDlgCapturarAbono::grabarMaeCrSeguros()
{
	char cLog[500] = { 0 };
	bool bRegresa = true, bError = false;
	char cSql[1120] = { 0 };
	int iRespuesta = 0;

	sprintf_s(cLog, "FC0200805021522361 - entra - grabarMaeCrSeguros");
	grabarLog(cLog);

	if (bTieneDatosEnTemporales)
	{
		grabarLog("CDlgCapturarAbono::grabarMaeCrSeguros::grabando abonos en carmovx");

		CGrabarCrCarmovX consultarCaCarmov(&odbc, false);
		CMaximo maeCrSeguros(&odbc_1, false);

		sprintf_s(cSql, "SELECT clave, tipomovimiento, tienda, ciudad, cliente, clienteetp, caja, recibo, factura, importe, saldoinicial, saldofinal, saldocuenta,"
			"vencidoinicial, minimoinicial, base, fechasaldacon, importesaldacon, tipoconvenio, subtipoconvenio, plazoconvenio, ejercicio, clavetdaocob,"
			"grabacartera, anexo, clavelocal, clientelocalizar, tiposeguro, flagseguroconyugal, movtoseguro, flagmontoseguro, statusseguro, causabaja,"
			"cantidadseguros, cantidadsegurosanterior, cantidadmeses, bonificacion, mesesvencidos, fechanacimiento, edad, sexo, areaajuste,"
			"fechaabonoajuste, claveajuste, ajuste, tiendaorigen, numerocontrol, comision, clienteremitente, tipogastoviaje, centro, flagincluyerecibo,"
			"ruta, folio, cuenta, iva, telefono, compania, contrato, credito, fechavencimiento, fechavencimientoanterior, fecha, efectuo, cajaoriginal,"
			"foliotienda, rpu, flagmovtosupervisor, interes, importeventa, folioanterior, digito, sac, ipcarteracliente,"
			"fol_sucursal, num_cliente, num_movimiento, clv_statusmovimiento, fechadocumento "
			"FROM cacarmov WHERE recibo = %ld and caja = %d and clave = '2' and num_movimiento in (25,27)", lNumeroRecibo, iCajaActual);

		if (!consultarCaCarmov.Exec(cSql))
		{
			bRegresa = false;
			consultarCaCarmov.odbc->GetLastError(consultarCaCarmov.GetHstmt());
			grabarMensajeError("C", m_grid.iCaja, (LPTSTR)(LPCTSTR)m_grid.sServer, "CapturarAbono", "CDlgCapturarAbono", "grabarMaeCrSeguros", cSql, m_grid.lEmpleado, "ERROR EN LA CONSULTA(cacarmov)", consultarCaCarmov.odbc, m_grid.iMuestraMsg);
		}
		else
		{
			consultarCaCarmov.activarCols();
			while (consultarCaCarmov.leer())
			{
				memset(cSql, 0, sizeof(cSql));

				if (consultarCaCarmov.num_movimiento == 25) // abono
				{
					sprintf_s(cSql, "SELECT iStatus FROM fun_crgrabarmaecrseguroscambioplan(%I64d,'4',%ld,%I64d,'%d','A','C','1','1900-01-01','1900-01-01','%04d-%02d-%02d','%04d-%02d-%02d','1900-01-01','%d','1900-01-01','1',0);",
						consultarCaCarmov.num_cliente, consultarCaCarmov.folio, consultarCaCarmov.fol_sucursal, consultarCaCarmov.cantidadseguros,
						consultarCaCarmov.fechavencimiento.ano(), consultarCaCarmov.fechavencimiento.mes(), consultarCaCarmov.fechavencimiento.dia(),
						iAnioActual, iMesActual, iDiaActual, consultarCaCarmov.tienda
						);

					if (maeCrSeguros.Exec(cSql))
					{
						maeCrSeguros.activarCols();
						if (maeCrSeguros.Leer())
						{
							if (maeCrSeguros.Total != 1) // 1 es OK
							{
								bRegresa = false;
								break;
							}
						}
					}
					else
					{
						bError = true;
					}
				}
				else if (consultarCaCarmov.num_movimiento == 27) // cambio de plan debe actuaizar actual e insertar nuevo
				{
					// insertar registro con nuevo folio
					sprintf_s(cSql, "SELECT iStatus FROM fun_crgrabarmaecrseguroscambioplan(%I64d,'4',%ld,%I64d,'%d','A','C','1','1900-01-01','%04d-%02d-%02d','%04d-%02d-%02d','%04d-%02d-%02d','1900-01-01','%d','%04d-%02d-%02d','3',%ld);",
						consultarCaCarmov.num_cliente, consultarCaCarmov.folio, consultarCaCarmov.fol_sucursal, consultarCaCarmov.cantidadseguros,
						consultarCaCarmov.fechaabonoajuste.ano(), consultarCaCarmov.fechaabonoajuste.mes(), consultarCaCarmov.fechaabonoajuste.dia(),
						consultarCaCarmov.fechavencimiento.ano(), consultarCaCarmov.fechavencimiento.mes(), consultarCaCarmov.fechavencimiento.dia(),
						iAnioActual, iMesActual, iDiaActual, consultarCaCarmov.tienda, iAnioActual, iMesActual, iDiaActual, consultarCaCarmov.factura
						);

					if (maeCrSeguros.Exec(cSql))
					{
						maeCrSeguros.activarCols();
						if (maeCrSeguros.Leer())
						{
							if (maeCrSeguros.Total != 1) // 1 es OK
							{
								bRegresa = false;
								break;
							}
						}
					}
					else
					{
						bError = true;
					}

					maeCrSeguros.ClearResults();
					maeCrSeguros.ClearStatement();

					// cancelar registro con folio anterior
					sprintf_s(cSql, "SELECT iStatus FROM fun_crgrabarmaecrseguroscambioplan(%I64d,'4',%ld,%I64d,'%d','C','C','1','1900-01-01','1900-01-01','1900-01-01','1900-01-01','%04d-%02d-%02d','%d','1900-01-01','2',%ld);",
						consultarCaCarmov.num_cliente, consultarCaCarmov.folio, consultarCaCarmov.fol_sucursal, consultarCaCarmov.cantidadseguros,
						iAnioActual, iMesActual, iDiaActual, consultarCaCarmov.tienda, consultarCaCarmov.factura
						);

					if (maeCrSeguros.Exec(cSql))
					{
						maeCrSeguros.activarCols();
						if (maeCrSeguros.Leer())
						{
							if (maeCrSeguros.Total != 1) // 1 es OK
							{
								bRegresa = false;
								break;
							}
						}
					}
					else
					{
						bError = true;
					}
				}

				if (bError)
				{
					bRegresa = false;
					maeCrSeguros.odbc->GetLastError(maeCrSeguros.GetHstmt());
					grabarMensajeError("C", m_grid.iCaja, (LPTSTR)(LPCTSTR)m_grid.sServer, "CapturarAbono", "CDlgCapturarAbono", "grabarMaeCrSeguros", cSql, m_grid.lEmpleado, "ERROR EN LA CONSULTA(fun_crgrabarmaecrseguroscambioplan)", maeCrSeguros.odbc, m_grid.iMuestraMsg);
					sprintf_s(cMensaje, "CDlgCapturarAbono::grabarMaeCrSeguros::Error fun_crgrabarmaecrseguroscambioplan--> bError = true");
					grabarLog(cMensaje);
					grabarLog(cSql);
					break;
				}

				maeCrSeguros.ClearResults();
				maeCrSeguros.ClearStatement();
			}

			if (!bRegresa && !bError)
			{
				maeCrSeguros.odbc->GetLastError(maeCrSeguros.GetHstmt());
				grabarMensajeError("C", m_grid.iCaja, (LPTSTR)(LPCTSTR)m_grid.sServer, "CA0030", "CDlgCapturarAbono", "grabarMaeCrSeguros", cSql, m_grid.lEmpleado, "ERROR EN LA CONSULTA(fun_crgrabarmaecrseguroscambioplan)", maeCrSeguros.odbc, m_grid.iMuestraMsg);
				sprintf_s(cMensaje, "CDlgCapturarAbono::grabarMaeCrSeguros::Error fun_crgrabarmaecrseguroscambioplan--> bError = false");
				grabarLog(cMensaje);
				grabarLog(cSql);
			}
		}
	}
	return bRegresa;
}

bool CDlgCapturarAbono::grabarMaeBeneficiariosSeguro()
{
	char cLog[500] = { 0 };
	bool bRegresa = true, bError = false;
	char cSql[1100] = { 0 };
	int iRespuesta = 0;
	long lPolizaAnterior = 0L;

	sprintf_s(cLog, "FC0200805021522367 - entra - grabarMaeBeneficiariosSeguro");
	grabarLog(cLog);

	if (bTieneDatosEnTemporales)
	{
		grabarLog("grabarMaeBeneficiariosSeguro::grabando beneficiarios plan en cartera");

		CConsultarBeneficiariosSeguroTemp beneficiariosSeguroTemp(&odbc, false);
		CMaximo grabarMaeBenefSeguro(&odbc_1, false);

		sprintf_s(cSql, "SELECT idu_seguro, fol_ultimapoliza, idu_adicional, nom_beneficiario, nom_apellidopaterno, nom_apellidomaterno, fec_nacimiento, idu_parentesco, num_orden, "
			"clv_sexo, num_telefono, prc_asignado, fec_altabeneficiario, num_movimiento, num_tienda, num_caja, num_recibo  "
			"FROM mov_tdbeneficiarios WHERE num_recibo = %ld AND num_caja = %d AND num_cliente = %ld;", lNumeroRecibo, iCajaActual, m_grid.lCliente);

		if (!beneficiariosSeguroTemp.Exec(cSql))
		{
			bRegresa = false;
			beneficiariosSeguroTemp.odbc->GetLastError(beneficiariosSeguroTemp.GetHstmt());
			grabarMensajeError("C", m_grid.iCaja, (LPTSTR)(LPCTSTR)m_grid.sServer, "CapturarAbono", "CDlgCapturarAbono", "grabarMaeBeneficiariosSeguro", cSql, m_grid.lEmpleado, "ERROR EN LA CONSULTA(mov_tdbeneficiarios)", beneficiariosSeguroTemp.odbc, m_grid.iMuestraMsg);
		}
		else
		{
			beneficiariosSeguroTemp.activarCols();
			while (beneficiariosSeguroTemp.leer())
			{
				memset(cSql, 0, sizeof(cSql));

				for (int i = 0; i < iCambiosDePlan; i++)
				{
					if (stCambioPlanes[i].iIduAdicional == beneficiariosSeguroTemp.idu_adicional)
					{
						lPolizaAnterior = stCambioPlanes[i].lFolioPolizaAnterior;
						break;
					}
				}

				sprintf_s(cSql, "SELECT iStatus FROM fun_crgrabarmaestrobeneficiarios(%ld, '%d', %I64d, %I64d, '%s', '%s', '%s', '%04d-%02d-%02d', '%d', '%d', '%c', %I64d, '%d', '%04d-%02d-%02d', '%d', '%d', %ld);",
					m_grid.lCliente, beneficiariosSeguroTemp.idu_seguro, beneficiariosSeguroTemp.fol_ultimapoliza, beneficiariosSeguroTemp.idu_adicional,
					beneficiariosSeguroTemp.nom_beneficiario, beneficiariosSeguroTemp.nom_apellidopaterno, beneficiariosSeguroTemp.nom_apellidomaterno,
					beneficiariosSeguroTemp.fec_nacimiento.ano(), beneficiariosSeguroTemp.fec_nacimiento.mes(), beneficiariosSeguroTemp.fec_nacimiento.dia(),
					beneficiariosSeguroTemp.idu_parentesco, beneficiariosSeguroTemp.num_orden, beneficiariosSeguroTemp.clv_sexo[0], beneficiariosSeguroTemp.num_telefono,
					beneficiariosSeguroTemp.prc_asignado, beneficiariosSeguroTemp.fec_altabeneficiario.ano(), beneficiariosSeguroTemp.fec_altabeneficiario.mes(),
					beneficiariosSeguroTemp.fec_altabeneficiario.dia(), beneficiariosSeguroTemp.num_movimiento, m_grid.iTienda, lPolizaAnterior
					);

				if (grabarMaeBenefSeguro.Exec(cSql))
				{
					grabarMaeBenefSeguro.activarCols();
					if (grabarMaeBenefSeguro.Leer())
					{
						if (grabarMaeBenefSeguro.Total != 1) // 1 es OK
						{
							bRegresa = false;
							break;
						}
					}
				}
				else
				{
					bRegresa = false;
					grabarMaeBenefSeguro.odbc->GetLastError(grabarMaeBenefSeguro.GetHstmt());
					grabarMensajeError("C", m_grid.iCaja, (LPTSTR)(LPCTSTR)m_grid.sServer, "CapturarAbono", "CDlgCapturarAbono", "grabarMaeBeneficiariosSeguro", cSql, m_grid.lEmpleado, "ERROR EN LA CONSULTA(fun_crgrabarmaestrobeneficiarios)", grabarMaeBenefSeguro.odbc, m_grid.iMuestraMsg);
					break;
				}

				grabarMaeBenefSeguro.ClearResults();
				grabarMaeBenefSeguro.ClearStatement();
			}
		}
	}
	return bRegresa;
}

int CDlgCapturarAbono::imprimirPolizaCambioPlan(int indice)
{
	char cLog[500] = { 0 };
	int iRespuesta = 0;
	char cInputParam1[1024] = { 0 }, cInputParam2[1024] = { 0 }, cOutputParam1[1024] = { 0 }, cOutputParam2[1024] = { 0 },
		cNombreProyecto[100] = { 0 }, cNombreFuncionDLL[10] = { 0 };
	SParametros parametros;
	CString sPago = "";

	sprintf_s(cLog, "FC0200805021522372 - entra - imprimirPolizaCambioPlan");
	grabarLog(cLog);

	grabarLog("imprimirPolizaCambioPlan::se manda llamar CA0221 para imprimir poliza de plan");

	m_grid.QuickGetText(iColumnaPlan, 21, &sPago);

	memset(&parametros, 0, sizeof(SParametros));

	sprintf_s(parametros.sServer, "%s", (LPCTSTR)m_grid.sServer);
	parametros.iTienda = m_grid.iTienda;
	parametros.lEmpleado = m_grid.lEmpleado;
	parametros.iCajaActual = m_grid.iCaja;
	parametros.sArea[0] = m_grid.cArea;
	parametros.lCliente = m_grid.lCliente;
	parametros.lFolioSeguro = stCambioPlanes[indice].lFolioPoliza; // folio poliza
	parametros.iFlagGeneral = stCambioPlanes[indice].iIduAdicional;  // idu adicional 
	parametros.iSensor = stCambioPlanes[indice].iIduPlan; // idu_plan
	parametros.lMontoMinimoPlazo18 = stCambioPlanes[indice].lSumaAsegurada; // suma asegurada
	parametros.lCantidad = stCambioPlanes[indice].lImporte * 100; // importe * 100
	parametros.lCodigo1 = atol(sPago.Trim()) * 100; // su pago * 100
	parametros.lCodigo2 = 0; // cambio pago
	parametros.lFactura = stCambioPlanes[indice].lRecibo; // recibo
	parametros.iTipo = 2;   // PROCESO IMPRESION (1 = recibo de  venta CPS, 2 = poliza CPS cambio plan)
	parametros.iFlagEtiqueta = 1;   // TIPO DE IMPRESION
	sprintf_s(parametros.sFechaDesde, "%s", stCambioPlanes[indice].cFechaInicial);   //FECHAINICIAL
	sprintf_s(parametros.sFechaHasta, "%s", stCambioPlanes[indice].cFechaFinal);   //FECHAFINAL
	sprintf_s(parametros.sTipoImpresion, "1");

	memcpy(cInputParam1, &parametros, sizeof(SParametros));

	nombreArchivo("CA0221.DLL", cNombreProyecto, DIRECTORIO_CA);
	sprintf_s(cNombreFuncionDLL, "CA0221");

	CargarDLL cargarDll(cNombreProyecto, cNombreFuncionDLL, cInputParam1, cInputParam2, cOutputParam1, cOutputParam2);
	iRespuesta = cargarDll.getResultado();

	if (iRespuesta <= 0)
	{
		AfxMessageBox("Error al cargar el programa CA0221.DLL", MB_ICONERROR);
	}
	return iRespuesta;
}

bool CDlgCapturarAbono::grabarCandidatoPlan()
{
	char cLog[500] = { 0 };
	bool bResultado = true;
	char sSqlGrabarAbo[360] = { 0 };
	int iCandidato = 0;
	iCandidato = bCandidatoPSVenta ? 1 : bCandidatoPSAbono ? 2 : 0;

	sprintf_s(cLog, "FC0200805021522376 - entra - grabarCandidatoPlan");
	grabarLog(cLog);

	sprintf_s(sSqlGrabarAbo, "UPDATE cacarmov SET opc_candidatocps=%d WHERE recibo=%ld AND cliente='%d' AND fecha = '%04d-%02d-%02d'", iCandidato, lNumeroRecibo, m_grid.lCliente, iAnioActual, iMesActual, iDiaActual);
	CMaximo flagCoppel(&odbc, false);
	if (!flagCoppel.Exec(sSqlGrabarAbo))
	{
		bResultado = false;
		flagCoppel.odbc->GetLastError(flagCoppel.GetHstmt());
		grabarMensajeError("C", m_grid.iCaja, (LPTSTR)(LPCTSTR)m_grid.sServer, "CapturarAbono", "CDlgCapturarAbono", "grabarCandidatoPlan", sSqlGrabarAbo, m_grid.lEmpleado, "ERROR EN LA CONSULTA(grabarCandidatoPlan)", flagCoppel.odbc, m_grid.iMuestraMsg);
	}
	return bResultado;
}

int CDlgCapturarAbono::VerificarCuentaBcpl(char *cadena, char *subcadena)
{
	char cLog[500] = { 0 };
	// busca una subcadena en otra cadena.
	int i, j;
	int l_cadena = strlen(cadena);
	int l_subcadena = strlen(subcadena);

	sprintf_s(cLog, "FC0200805021522380 - entra - VerificarCuentaBcpl");
	grabarLog(cLog);

	if (l_cadena < l_subcadena)
		return 0;
	if (cadena[0] == NULL && subcadena[0] == NULL)
		return 1;

	for (i = 0; i < l_cadena; i++)
		if (cadena[i] == subcadena[0])
		{
			if (l_cadena - i < l_subcadena)
				return 0;

			for (j = 0; j < l_subcadena; j++)
				if (cadena[i + j] != subcadena[j])
					break;

			if (j == l_subcadena)
				return 1;
		}
		return 0;
}

void CDlgCapturarAbono::MostrarControlesPlanLealtad()
{
	char cLog[500] = { 0 };
	CString sCorreo;
	CString sTel;

	sprintf_s(cLog, "FC0200805021522384 - entra - MostrarControlesPlanLealtad");
	grabarLog(cLog);

	if (iFlagCampoInteligentePL > 0
		&& (iSistema == SISTEMA_CAJAS
		|| iSistema == SISTEMA_ROPA
		|| iSistema == SISTEMA_MUEBLES))
	{
		if (sClientePL.iNumCliente > 0 && sClientePL.iNumCliente != 90001)
		{
			sClientePL = objPlanDeLealtad->obtenerDatosCliente();
			sCorreo.Format("%s", sClientePL.cCorreo);
			sTel.Format("%s", sClientePL.cCelular);
			if (bProvieneDatos_OtraArea)
			{
				if (!sCorreo.IsEmpty() && sCorreo != "@.")
				{
					m_correo.SetWindowTextA(objPlanDeLealtad->enmascararCorreo(sCorreo));
				}
				sTel.Format("%s", sClientePL.cCelular);
				if (!sTel.IsEmpty() && sTel != "0")
				{
					m_celular.SetWindowTextA(objPlanDeLealtad->enmascararCelular(sTel));
				}
			}
			if (!sCorreo.IsEmpty() && sCorreo != "@." || !sTel.IsEmpty() && sTel != "0")
			{
				m_lblCorreo.ShowWindow(true);
				m_correo.ShowWindow(true);
				m_lblCelular.ShowWindow(true);
				m_celular.ShowWindow(true);
			}
		}
	}
	else
	{
		m_lblCorreo.ShowWindow(false);
		m_correo.ShowWindow(false);
		m_lblCelular.ShowWindow(false);
		m_celular.ShowWindow(false);
	}
}

void CDlgCapturarAbono::OnEnChangeCliente()
{
	char cLog[500] = { 0 };
	CString sDato = "";
	char cCaracter[3] = { 0 };
	bool bRemover = false;

	sprintf_s(cLog, "FC0200805021522388 - entra - OnEnChangeCliente");
	grabarLog(cLog);

	memset(cCaracter, 0, sizeof(cCaracter));
	m_cliente.GetWindowText(sDato);
	sprintf_s(cCaracter, "%s", (LPCTSTR)sDato.Right(1));

	if (sDato.GetLength() > 0)
	{
		if (iFlagCampoInteligentePL == 0 && !bProvieneDatos_OtraArea) //Permitir solo numeros
		{
			if (!isdigit(cCaracter[0]) && (strcmp(&cCaracter[0], "*") != 0))
			{
				bRemover = true;
			}
		}
		else //Permitir caracteres PL
		{
			ValidarCaracteresCI();
		}

		if (bRemover)
		{
			sDato.Remove(cCaracter[0]);
			m_cliente.SetWindowText(sDato.Trim());
			m_cliente.SetSel(sDato.GetLength(), sDato.GetLength());
		}
	}
}

bool CDlgCapturarAbono::validarLevantarSC3()
{
	char cLog[500] = { 0 };
	bool bLevantarSC3 = true;

	sprintf_s(cLog, "FC0200805021522392 - entra - validarLevantarSC3 - sistema = %d", iSistema);
	grabarLog(cLog);

	if ((iFlagCampoInteligentePL > 0 || iFlagRegistroPL > 0) && iSistema == SISTEMA_CAJAS)
	{
		if (objPlanDeLealtad != NULL)
		{
			bLevantarSC3 = objPlanDeLealtad->validarLevantarSC3();
			grabarLog(" Levanta el GN0263 para validar  validarLevantarSC3  ");
		}
	}

	sprintf_s(cLog, "FC0200805021522394 - fin - validarLevantarSC3 - bLevantarSC3=%s", bLevantarSC3 ? "VERDADERO" : "FALSO");
	grabarLog(cLog);
	return bLevantarSC3;
}
bool CDlgCapturarAbono::validarNumeroPL(CString sDato)
{
	char cLog[500] = { 0 };
	char cText[321] = { 0 };
	int i = 0;
	bool bRegresa = true;
	CString sText;

	sprintf_s(cLog, "FC0200805021522396 - entra - validarNumeroPL");
	grabarLog(cLog);

	m_cliente.GetWindowText(sText);

	sprintf_s(cText, "%.320s", (LPCTSTR)sText.Trim());
	while (cText[i] != 0)
	{
		if (!isdigit(cText[i]))
		{
			bRegresa = false;
			return false;
		}

		i++;
	}
	return bRegresa;
}
void CDlgCapturarAbono::ValidarCaracteresCI()
{
	char cLog[500] = { 0 };
	char cText[325] = { 0 };
	int i = 0;

	CString sText;

	sprintf_s(cLog, "FC0200805021522400 - entra - ValidarCaracteresCI");
	grabarLog(cLog);

	m_cliente.GetWindowText(sText);
	sprintf_s(cText, "%.320s", (LPCTSTR)sText.Trim());

	while (cText[i] != 0)
	{
		if (cText[i] == 43)
		{
			m_cliente.SetSel(i, i + 1);
			m_cliente.ReplaceSel("@");
		}
		else if (!caracteresNoPermitidos(_T(cText[i])))
		{
			m_cliente.SetSel(i, i + 1);
			m_cliente.ReplaceSel("");
		}

		i++;
	}
}
bool CDlgCapturarAbono::caracteresNoPermitidos(unsigned char cChar)
{
	char cLog[500] = { 0 };
	bool bRegresa = true;

	sprintf_s(cLog, "FC0200805021522404 - entra - caracteresNoPermitidos");
	grabarLog(cLog);

	if ((cChar >= 192 && cChar <= 255)
		|| (cChar >= 143 && cChar <= 149)
		|| (cChar >= 97 && cChar <= 122)
		|| cChar == (47) || cChar == (60)
		|| cChar == (62) || cChar == (92)
		|| cChar == (34) || cChar == (96)
		|| cChar == (35) || cChar == (39)
		|| cChar == (130) || cChar == (152)
		|| cChar == (168) || cChar == (180))
	{
		bRegresa = false;
	}
	return bRegresa;
}

bool CDlgCapturarAbono::grabartmpClienteCandidatomoratorio(char *cJsonPostLocal, int Opcion, char *cMetodo)
{
	char cLog[500] = { 0 };
	bool bRegresa = true;
	ErrorToken=false; // 37569					   
	int iResult = 0, iPuerto = 0, i = 0, iFacturaCuenta = 0, pagomin = 0, imp_descuento = 0, igrabo = 0;
	CString sAux = "", sContenido = "", sUrl = "", sMensaje = "";
	CString sTexto;
	char cIpWSSitEsp[17] = { 0 }, cIpWSSitEspAlterno[17] = { 0 }, cConcepto[30] = { 0 }, cFacturaCuenta[25] = { 0 }, cDesFactura[30] = { 0 };
	char ConsultaUrl[128] = { 0 };
	char *file;
	CUT_HTTPClient clienteHttp;
	iMaxInteresValido = 0;

	sprintf_s(cLog, "FC0200805021522408 - entra - grabartmpClienteCandidatomoratorio");
	grabarLog(cLog);

	clienteHttp.AddSendHeaderTag("Content-Type: application/json; charset=utf-8");
	clienteHttp.AddSendHeaderTag("Authorization: " + sToken);// 37569 se agrega token a la solicitud
	bErrorWS = false;

	SRecibeDatosWSDescuentoMora sRespuestaWSdescuento;
	memset(&sRespuestaWSdescuento, 0, sizeof(sRespuestaWSdescuento));

	obtenerurlService(51, urlservice);

	file = (LPTSTR)(LPCTSTR)cJsonPostLocal;
	char *cFormUrlencoded = new char[strlen(file) + 12];
	sprintf(cFormUrlencoded, file);
	CUT_BufferDataSource ds(cFormUrlencoded, _tcslen(cFormUrlencoded));

	sUrl.Format("http://%s/wsdescuentomoratorio/descuentoMoratorio/%s", urlservice, cMetodo);
	sprintf_s(ConsultaUrl, "%s", sUrl.Trim());
	iResult = clienteHttp.POST((LPSTR)ConsultaUrl, ds);
	long status = clienteHttp.GetStatusCode();// 37569 obtener el status del servicio 

	if (iResult == UTE_SUCCESS)
	{
		LPCSTR line;

		for (int i = 0; i < clienteHttp.GetBodyLineCount(); i++)
		{
			line = clienteHttp.GetBodyLine(i);
			if (line != NULL)
			{
				sContenido.AppendFormat("%s\r\n", line);
			}
		}
	}
	else
	{
		sAux.Format("ERROR \n %s", CUT_ERR::GetErrorString(iResult));
		sprintf_s(cMensaje, "%s", sAux);
		bErrorWS = true;
		bRegresa = false;
	}
	// 37569 mostrar mensaje si devuelve 401
	if (status==401)
	{
		sprintf_s(cLog, "FC020080502286524 - Token incorrecto");
		AfxMessageBox("Advertencia:\nError al validar token de autenticación. Favor\nde comunicarse a mesa de servicio.");
		bErrorWS = true;
		bRegresa = true;
		ErrorToken=true;
	}

	if (bRegresa)
	{
		char *json = new char[sContenido.GetLength() + 12];
		sprintf(json, "%s", sContenido);

		StaticJsonBuffer<100000> jsonBuffer;
		switch (Opcion)
		{
		case 1:
			{
				JsonObject& root = jsonBuffer.parseObject(json); //se accede a la raiz del json
				if (!root.success())
				{
					//Indica que la estructura del json no es correcta
					sAux.Format("parseObject() root failed"); //Dejar log del error
					sprintf_s(cMensaje, "%s", (LPCTSTR)sAux);
					bErrorWS = true;
					bRegresa = false;
				}
				else
				{
					iMaxInteresValido = sRespuestaWSdescuento.iImporteinteresmsj = root["iImporteinteresmsj"];
					sRespuestaWSdescuento.clv_Error = root["clv_Error"];
					if (sRespuestaWSdescuento.clv_Error == 1)
					{
						AfxMessageBox("ERROR DE OPCIONES DE PAGO, FAVOR DE COMUNICARSE A MESA DE AYUDA,", MB_OK | MB_ICONERROR);
						iCandidatoAprobado = 0;
					}
				}
			}
			break;
		case 2:
			{
				JsonArray& root = jsonBuffer.parseArray(json, sContenido.GetLength() + 2); //se accede a la raiz del json
				if (!root.success())
				{
					//Indica que la estructura del json no es correcta
					sAux.Format("parseObject() root failed"); //Dejar log del error
					sprintf_s(cMensaje, "%s", (LPCTSTR)sAux);
					bErrorWS = true;
					bRegresa = false;
				}
				else
				{
					int j = 0;
					prc_descuento = imp_totaldescuento = 0;
					for (i = 0; i < iTotalCuentas; i++)//Se hace un ciclo para recorrer todas las cuentas que tenga el cliente
					{
						m_grid.QuickGetText(i, -1, &sTexto);
						sTexto.Trim();
						sprintf_s(cConcepto, "%s", (LPCTSTR)sTexto);

						m_grid.QuickGetText(i, 1, &sTexto);
						sTexto.Trim();
						sprintf_s(cFacturaCuenta, "%s", (LPCTSTR)sTexto);

						iFacturaCuenta = atoi(cFacturaCuenta);
						sTexto = root[j]["des_factura"];
						sTexto.Trim();
						sprintf_s(cDesFactura, "%s", (LPCTSTR)sTexto);
						if (iFacturaCuenta == root[j]["fol_Factura"] && memcmp(cConcepto, cDesFactura, strlen(cConcepto)) == 0)
						{
							imp_totaldescuento = root[j]["imp_Descuentototal"];
							prc_descuento = root[j]["prc_descuento"];
							idu_huellamora = root[j]["idu_HuellaAutoriza"];
							num_gerentemora = root[j]["num_Gerente"];

							pagomin = root[j]["imp_Pagominimo"];
							sTexto.Format("%d", pagomin);
							m_grid.QuickSetText(i, 21, sTexto);
							m_grid.RedrawAll();

							imp_descuento = root[j]["imp_Descuento"];
							sTexto.Format("%d", imp_descuento);
							m_grid.QuickSetText(i, 32, sTexto);
							m_grid.RedrawAll();
							j++;
						}
					}

				}

			}
			break;
		case 3:
			{
				JsonObject& root = jsonBuffer.parseObject(json); //se accede a la raiz del json
				if (!root.success())
				{
					//Indica que la estructura del json no es correcta
					sAux.Format("parseObject() root failed"); //Dejar log del error
					sprintf_s(cMensaje, "%s", (LPCTSTR)sAux);
					bErrorWS = true;
					bRegresa = false;
				}
				else
				{
					igrabo = sRespuestaWSdescuento.Grabocacarmov = root["grabo"];
					bRegresa = true;
				}
			}
			break;
		case 4:
			{
				JsonObject& root = jsonBuffer.parseObject(json); //se accede a la raiz del json
				if (!root.success())
				{
					//Indica que la estructura del json no es correcta
					sAux.Format("parseObject() root failed"); //Dejar log del error
					sprintf_s(cMensaje, "%s", (LPCTSTR)sAux);
					bErrorWS = true;
					bRegresa = false;
				}
				else
				{
					bRegresa = true;
				}
			}
			break;
		}
		delete[]json;
	}
	delete[]cFormUrlencoded;
	return bRegresa;
}
void CDlgCapturarAbono::CargarCA0230()
{
	char cLog[500] = { 0 };

	sprintf_s(cLog, "FC0200805021522413 - entra - CargarCA0230");
	grabarLog(cLog);

	if (iCandidatoAprobado == 1)
	{
		grabarLog("DescuentoMoratorio:: cliente es candidato a descuento moratorio");
		m_cliente.SetReadOnly(true);
		int i = 0, iFacturaCuenta = 0;
		char  cTexto[50] = { 0 }, cOutPut[2048] = { 0 };
		CString sTexto;
		char  cTokenChar[1000] = { 0 };//37569								
		CargarDLLCS cargarDllCS;
		iAplicoDescuento = 0;

		memset(cJsonPostDescuentos, 0, sizeof(cJsonPostDescuentos));

		sprintf_s(cTexto, "%ld", m_grid.lCliente);
		cargarDllCS.addParam(cTexto);
		memset(cTexto, 0, sizeof(cTexto));

		sprintf_s(cTexto, "%d", m_grid.iTienda);
		cargarDllCS.addParam(cTexto);
		memset(cTexto, 0, sizeof(cTexto));

		sprintf_s(cTexto, "%c", m_grid.cArea);
		cargarDllCS.addParam(cTexto);
		memset(cTexto, 0, sizeof(cTexto));

		sprintf_s(cTexto, "%d", m_grid.iCaja);
		cargarDllCS.addParam(cTexto);
		memset(cTexto, 0, sizeof(cTexto));

		sprintf_s(cTexto, "%s", m_grid.sServer);
		cargarDllCS.addParam(cTexto);

		sprintf_s(cTexto, "%s", odbc_1.m_strServer);
		cargarDllCS.addParam(cTexto);

		cargarDllCS.addParam(urlservice);       

		//37569 se agrega nuevo parametro
		sprintf_s(cTokenChar, "%s", (LPCTSTR)sToken);//37569
		cargarDllCS.addParam(cTokenChar); 

		sprintf_s(cLog, "descuentoMoratorio-->Parametros para ca0230 cliente[%ld], tienda [%d], area [%c], caja [%d], servidor tienda[%s], servidor cartera[%s], urlservicio[%s]",
			m_grid.lCliente, m_grid.iTienda, m_grid.cArea, m_grid.iCaja, m_grid.sServer, odbc_1.m_strServer, urlservice);
		grabarLog(cLog);

		cargarDllCS.cargarDllCS("C:\\SYS\\PROGX\\CA\\CA0230.DLL", "DescuentoMoratorio.DescuentoMoraVista", cOutPut);
		if (atoi(cOutPut) == 1)
		{
			sprintf_s(cJsonPostDescuentos, "{\"caja\":%d,\"area\":\"%c\",\"numCliente\":%ld,\"numTienda\":%d,\"ipTienda\":\"%s\"}", m_grid.iCaja, m_grid.cArea, m_grid.lCliente, m_grid.iTienda, odbc.m_strServer);

			if (grabartmpClienteCandidatomoratorio(cJsonPostDescuentos, 2, "consultarTmpBitacoraInteres"))
			{
				iAplicoDescuento = 1;
				m_grid.obtenerTotalAbono();
				pedirPago();
				iContador++;
				m_cliente.SetWindowText("");
				m_cliente.SetReadOnly(false);
				bFormalizo = true;

			}
		}
		else
		{
			grabarLog("DescuentoMoratorio:: no acepto descuento");
			iAplicoDescuento = 0;

			sTexto.Format("%d", 0);
			m_grid.QuickSetText(i, 21, sTexto);
			m_grid.RedrawAll();

		}

		//m_cliente.EnableWindow(true);
		///UpdateWindow();
	}
}
void  CDlgCapturarAbono::grabarMovimientoDescuentoMoratorio()
{
	char cLog[500] = { 0 };
	char cSql[600] = { 0 };
	bool bResultadoGrabar = true, bGraboRopa = false;;
	int iNumMovimiento = 0, saldofinal = 0, iSaldocuenta = 0, iEfectuo = 0, iTipoProductoMora = 0, iPlazoConv = 0, num_recibo = 0,
		importe = 0, iCuentasDetalle = 0, iva = 0, icalcular = 0, saldoinicial = 0, iDiaVenta = 0, iMesVenta = 0, iAnioVenta = 0, saldosinininteres = 0;
	long lAbonoCuenta = 0, lAbonoInteres = 0, lSaldoDetalle = 0L, lSaldoNuevoInteres = 0, lFechaSaldaCon = 0;
	char cEjercicio[5] = { 0 }, cFechaMvto[15] = { 0 }, cFlagmovtosupervisor[3] = { 0 }, cNombreCompleto[50] = { 0 }, cTxt[20] = { 50 }, fechasaldacon[15] = { 0 };
	double importeropa = 0, importeropa0 = 0, diferenciaintropa = 0, parteEntera0 = 0, parteEntera = 0, decimalropa0 = 0, decimalropa = 0;
	int iMesSaldaCon = 0, iDiaSaldaCon = 0, iAnioSaldaCon = 0;
	CString sTexto;

	sprintf_s(cLog, "FC0200805021522417 - entra - grabarMovimientoDescuentoMoratorio");
	grabarLog(cLog);

	sprintf_s(cSql, "SELECT clave,conceptocuenta,tienda,factura,fechacompra,importe,diapago,fechavencimiento,fechaultimomovimiento,fechasaldacon,fechaconvenio,empleadoconvenio,plazoconvenio,importeconvenio,saldo,interesadicional,base,vencido,minimo,saldacon,bonificacion,supago,numeroseguros,numeromeses,flagconyugal,fechavencimientoanterior,saldaconanteriormuebles,tipoconvenio,flagcapturoconvenio,status,cantidadanteriorseguros,subtipoconvenio,interesprimermes, tipoproducto, minimototal,saldototal,vencidototal,minimototalfinal,saldototalfinal,vencidototalfinal, flagcuentaperdida, descuento FROM tmpcagrabarabono");
	CTmpCaGrabarAbono tmpCaGrabarAbono(&odbc);
	iContadorRegistros = 0;
	if (tmpCaGrabarAbono.Exec(cSql))
	{ //bandera2
		tmpCaGrabarAbono.activarCols();
		while (tmpCaGrabarAbono.Leer() && bResultadoGrabar == true)
		{
			iCuentasDetalle = 0;
			if (tmpCaGrabarAbono.clave[0] == 'R' || tmpCaGrabarAbono.clave[0] == 'M' || tmpCaGrabarAbono.clave[0] == 'P' || tmpCaGrabarAbono.clave[0] == 'T' || tmpCaGrabarAbono.clave[0] == 'V')
			{
				if (tmpCaGrabarAbono.descuento > 0)
				{
					while (iCuentasDetalle <= iTotalCuentasDetalle)
					{
						calcularAbonoInteres(lAbonoCuenta, lAbonoInteres, tmpCaGrabarAbono.supago, tmpCaGrabarAbono.interesadicional);
						iPlazoConv = 0;
						switch (tmpCaGrabarAbono.clave[0])
						{
						case 'R'://Ropamie  
							iNumMovimiento = 31;
							cEjercicio[0] = '3';
							iPlazoConv = iPlazoRopa;
							sTexto.Format("%04d%02d%02d", tmpCaGrabarAbono.fechasaldacon.ano(), tmpCaGrabarAbono.fechasaldacon.mes(), tmpCaGrabarAbono.fechasaldacon.dia());
							lFechaSaldaCon = atol(sTexto);
							break;
						case 'M'://Muebles
							iNumMovimiento = 32;
							sprintf_s(cEjercicio, "%c", (char)(calcularEjercicio(tmpCaGrabarAbono.fechacompra.ano()) + '0'));
							iDiaVenta = tmpCaGrabarAbono.fechacompra.dia();
							iMesVenta = tmpCaGrabarAbono.fechacompra.mes();
							iAnioVenta = tmpCaGrabarAbono.fechacompra.ano();
							lFechaSaldaCon = obtenerFechaSaldaCon(tmpCaGrabarAbono.factura, iDiaVenta, iMesVenta, iAnioVenta);
							break;
						case 'T':// Tiempo aire
							iNumMovimiento = 34;
							cEjercicio[0] = '3';
							sTexto.Format("%04d%02d%02d", tmpCaGrabarAbono.fechasaldacon.ano(), tmpCaGrabarAbono.fechasaldacon.mes(), tmpCaGrabarAbono.fechasaldacon.dia());
							lFechaSaldaCon = atol(sTexto);
							break;
						case 'P'://Pretamo
							iNumMovimiento = 33;
							sprintf_s(cEjercicio, "%c", (char)(calcularEjercicio(tmpCaGrabarAbono.fechacompra.ano()) + '0'));
							iDiaVenta = tmpCaGrabarAbono.fechacompra.dia();
							iMesVenta = tmpCaGrabarAbono.fechacompra.mes();
							iAnioVenta = tmpCaGrabarAbono.fechacompra.ano();
							lFechaSaldaCon = obtenerFechaSaldaCon(tmpCaGrabarAbono.factura, iDiaVenta, iMesVenta, iAnioVenta);
							break;

						case 'V'://Revolvente
							iNumMovimiento = 35;
							sprintf_s(cEjercicio, "%c", (char)(calcularEjercicio(tmpCaGrabarAbono.fechacompra.ano()) + '0'));
							sTexto.Format("%04d%02d%02d", tmpCaGrabarAbono.fechasaldacon.ano(), tmpCaGrabarAbono.fechasaldacon.mes(), tmpCaGrabarAbono.fechasaldacon.dia());
							lFechaSaldaCon = atol(sTexto);
							break;
						default:
							break;
						}
						saldofinal = tmpCaGrabarAbono.saldo - lAbonoInteres;
						iSaldocuenta = (tmpCaGrabarAbono.interesadicional - lAbonoInteres);
						importe = tmpCaGrabarAbono.descuento * 100;
						sprintf_s(cFechaMvto, "%04d-%02d-%02d", iAnioActual, iMesActual, iDiaActual);


						if (iFlagSupervisor != 1)
						{
							cFlagmovtosupervisor[0] = '0'; //cajero
							iEfectuo = m_grid.lEmpleado;
						}
						else
						{
							cFlagmovtosupervisor[0] = '1';
							iEfectuo = lEmpleadoSupervisor;
						}

						if (tmpCaGrabarAbono.clave[0] == 'R')
						{
							if (icalcular == 0)
							{
								saldosinininteres = tmpCaGrabarAbono.saldo - tmpCaGrabarAbono.interesadicional;
								lAbonoInteres = lAbonoInteres - tmpCaGrabarAbono.descuento;
								importeropa0 = (double)((double)(lSaldoTasa0) / (double)(saldosinininteres));
								importeropa0 = (int)((importeropa0)* tmpCaGrabarAbono.descuento);

								importeropa = (double)((double)(lSaldoRopa) / (double)(saldosinininteres));
								importeropa = (int)((importeropa)* tmpCaGrabarAbono.descuento);

								lSaldoNuevoInteres = (long)(tmpCaGrabarAbono.interesadicional - (importeropa0 + importeropa) - lAbonoInteres);

								/*decimalropa0 = modf(importeropa0, &parteEntera0);
								decimalropa = modf(importeropa, &parteEntera);*/

								diferenciaintropa = tmpCaGrabarAbono.descuento - (importeropa0 + importeropa);

								if ((lInteresesRopa - importeropa) > 0)
								{
									importeropa += diferenciaintropa;
								}
								else
								{
									importeropa0 += diferenciaintropa;
								}
								icalcular++;
							}
							if (iTipoDeduccionRopa == 0 && !bGraboRopa)
							{
								importe = (int)((int)(importeropa) * 100);
								iCuentasDetalle = 1;
								bGraboRopa = true;
								iva = (short)iTipoDeduccionRopa;
								lSaldoDetalle = lSaldoDetalladoRopa;
							}
							else if (iTipoDeduccionTasa0 == 2)
							{
								importe = (int)((int)(importeropa0) * 100);
								iCuentasDetalle = 2;
								iva = (short)iTipoDeduccionTasa0;
								lSaldoDetalle = lSaldoDetalladoTasa0;
							}


							if (lAbonoCuenta != 0L)
							{
								saldoinicial = lSaldoDetalle;
								saldofinal = lSaldoDetalle - lAbonoInteres;

							}
							else
							{
								saldoinicial = tmpCaGrabarAbono.interesadicional;
								saldofinal = lSaldoNuevoInteres;

							}
						}
						else
						{
							if (lAbonoCuenta != 0L)
							{
								saldoinicial = tmpCaGrabarAbono.saldo;
								saldofinal = tmpCaGrabarAbono.saldo - lAbonoInteres;

							}
							else
							{
								saldoinicial = tmpCaGrabarAbono.interesadicional;
								saldofinal = lSaldoNuevoInteres;

							}
							iCuentasDetalle = 2;
						}
						sprintf_s(cTxt, "%08ld", lFechaSaldaCon);
						iMesSaldaCon = valor_campo(&cTxt[4], 2);
						iDiaSaldaCon = valor_campo(&cTxt[6], 2);
						iAnioSaldaCon = valor_campo(&cTxt[0], 4);

						if (iMesSaldaCon > 0L && iDiaSaldaCon > 0L && iAnioSaldaCon > 0L)
						{
							sprintf_s(fechasaldacon, "%04d-%02d-%02d", iAnioSaldaCon, iMesSaldaCon, iDiaSaldaCon);
						}
						else
						{

							sprintf_s(fechasaldacon, "1900-01-01");
						}


						sprintf_s(cNombreCompleto, "%s %s %s", sNombreCliente, sApellidoPaterno, sApellidoMaterno);
						sprintf_s(cJsonPostDescuentos, "{\"clave\":2,\"tipoMovimiento\":\"0\",\"tienda\":%d,\"ciudadGnDominio\": %d,\"cliente\": %ld,\"caja\": %d,\"numeroRecibo\": %d,\"folioFactura\":%ld,\"importe\": %d,\"saldoInicial\":%d,\"saldoFinal\":%d,"
							"\"saldoCuenta\":%d,\"flagMovtoSupervisor\":\"%s\",\"vencidoInicial\":%d,\"minimoInicial\":%d,\"ejercicio\":\"%s\",\"fechaMvto\":\"%s\",\"efectuo\":%d,\"clienteEdad\":%d,\"cajaOriginalMora\":%d,\"ipCarteraCliente\":\"%s\",\"base\":%d,"
							"\"nombreCompleto\":\"%s\",\"minimoTotalMora\":%d,\"saldoTotalMora\":%d,\"vencidoTotalMora\":%d,\"minimoTotalFinalMora\":%d,\"saldoTotalFinalMora\":%d,\"vencidoTotalFinalMora\":%d,\"plazoConv\":%d,\"numMovimiento\":%d,"
							"\"statusMovimiento\":\"1\",\"ipTienda\":\"%s\",\"iva\": %d,\"fechaSaldaCon\":\"%s\",\"idu_transaccion\": 0}"
							, m_grid.iTienda, iCiudadGnDominio, m_grid.lCliente, iCajaActual, lNumeroRecibo, tmpCaGrabarAbono.factura, importe, saldoinicial, saldofinal, lSaldoNuevoInteres, cFlagmovtosupervisor, tmpCaGrabarAbono.vencido, tmpCaGrabarAbono.minimo, cEjercicio, cFechaMvto, iEfectuo, iEdadCliente, (short)iCajaOriginal, cIpServidorCartera, tmpCaGrabarAbono.interesprimermes,
							cNombreCompleto, tmpCaGrabarAbono.minimototal, tmpCaGrabarAbono.saldototal, tmpCaGrabarAbono.vencidototal, tmpCaGrabarAbono.minimototalfinal, tmpCaGrabarAbono.saldototalfinal, tmpCaGrabarAbono.vencidototalfinal, iPlazoConv, iNumMovimiento, odbc.m_strServer, iva, fechasaldacon);

						grabartmpClienteCandidatomoratorio(cJsonPostDescuentos, 3, "guardarEliminarCaCarmov");
						iCuentasDetalle++;
					}
				}
			}
		}
	}
}
bool CDlgCapturarAbono::GrabarTdAutorizacionHuellas03()
{
	char cLog[500] = { 0 };
	bool bContinuar = true;
	char  cSql[255] = { 0 };
	int iTipoMovimiento = 0, iIdentificador = 0, iNumCliente = 0;
	CMaximo CAutorizaHuella(&odbc);
	CString sTipoIdentificacion = " ", sIdentificacionCte = " ";

	sprintf_s(cLog, "FC0200805021522424 - entra - GrabarTdAutorizacionHuellas03");
	grabarLog(cLog);

	if (idu_huellamora == 0 && m_grid.cArea == 'C')
	{
		iTipoMovimiento = 52;
	}
	else if (idu_huellamora == 0 && m_grid.cArea == 'M')
	{
		iTipoMovimiento = 53;
	}
	else if (idu_huellamora == 0 && m_grid.cArea == 'R')
	{
		iTipoMovimiento = 54;
	}

	else if (idu_huellamora == 1 || idu_huellamora == 2 && m_grid.cArea == 'C')
	{
		iTipoMovimiento = 55;
	}
	else if (idu_huellamora == 1 || idu_huellamora == 2 && m_grid.cArea == 'M')
	{
		iTipoMovimiento = 56;
	}
	else if (idu_huellamora == 1 || idu_huellamora == 2 && m_grid.cArea == 'R')
	{
		iTipoMovimiento = 57;
	}

	sprintf_s(cSql, "SELECT FUN_GRABARAUTORIZACIONHUELLA03('%d','%d','%ld','%ld','%s','%ld','%d','%d','%s','%d');", iTipoMovimiento, iSistema, lNumeroRecibo, m_grid.lCliente, sTipoIdentificacion, m_grid.lEmpleado, num_gerentemora, iIdentificador, sIdentificacionCte, iNumCliente);// se obtiene el interes maximo

	if (!CAutorizaHuella.Exec(cSql))
	{
		AfxMessageBox("Error al ejecutar la función fun_grabarautorizacionhuella03");
		CAutorizaHuella.Error();
		bContinuar = false;
	}
	return bContinuar;
}
void  CDlgCapturarAbono::MensajeReestructuraDescuentoMora()
{
	char cLog[500] = { 0 };
	int iOpcion = 0;
	bMostrarReestructura = false;
	iflag_descuentomoracliente = 0;

	sprintf_s(cLog, "FC0200805021522428 - entra - MensajeReestructuraDescuentoMora");
	grabarLog(cLog);

	if (iSistema == SISTEMA_CAJAS /*&& iFlagTiendaLocal == 0*/ && iFlagMovimiento == 1)
	{
		obtenerFlag('C', FLAGC_MENSAJEDESCUENTOMORATORIO, iFlagPrioridadMSJ);
	}
	if (iFlagPrioridadMSJ == 1 && iSumaInteresMoratorio >= iMaxInteresValido && iCandidatoAprobado == 1 && ErrorToken == false)// 37569 se agrega la condicion para que valide que si marco error de en la validacion del token
	{
		if (iCandidatoConvenioMora == 0)
		{
			consultarMensaje(1144, cMensaje);
			iOpcion = AfxMessageBox(cMensaje, MB_YESNO | MB_ICONQUESTION);
			if (iOpcion == IDYES)
			{
				iflag_descuentomoracliente = 1;
			}
			mostroMensajeMora = 1;

		}
		else if (iCandidatoConvenioMora == 1)
		{
			consultarMensaje(1145, cMensaje);
			iOpcion = AfxMessageBox(cMensaje, MB_YESNO | MB_ICONQUESTION);
			if (iOpcion == IDYES)
			{
				iflag_descuentomoracliente = 1;
			}
			mostroMensajeMora = 1;
		}


	}
	else
	{
		if (iFlagReestructuraDisponible == 1)
		{
			MensajeReestructura();
		}
	}
	if (iflag_descuentomoracliente == 0 && mostroMensajeMora == 1)
	{
		if (iFlagReestructuraDisponible == 1)
		{
			MensajeReestructura();
		}
	}
	else
	{
		if (iFlag_Reestructuracion == 0)
		{
			if (iSumaInteresMoratorio >= iMaxInteresValido && iCandidatoAprobado == 1 && mostroMensajeMora == 0 && ErrorToken == false)// 37569 se agrega la condicion para que valide que si marco error de en la validacion del token
			{
				if (iCandidatoConvenioMora == 0)
				{
					consultarMensaje(1144, cMensaje);
					iOpcion = AfxMessageBox(cMensaje, MB_YESNO | MB_ICONQUESTION);
					if (iOpcion == IDYES)
					{
						iflag_descuentomoracliente = 1;
					}
					mostroMensajeMora = 1;

				}
				else if (iCandidatoConvenioMora == 1)
				{
					consultarMensaje(1145, cMensaje);
					iOpcion = AfxMessageBox(cMensaje, MB_YESNO | MB_ICONQUESTION);
					if (iOpcion == IDYES)
					{
						iflag_descuentomoracliente = 1;
					}
					mostroMensajeMora = 1;
				}
			}
		}
	}

	if (bMostrarReestructura == false && iSumaInteresMoratorio >= iMaxInteresValido && iCandidatoAprobado == 1)
	{
		if (iCandidatoConvenioMora == 0)
		{
			consultarMensaje(1144, cMensaje);
			if (iOpcion == IDYES)
			{
				iflag_descuentomoracliente = 1;
			}
			mostroMensajeMora = 1;
		}
		else
		{
			consultarMensaje(1145, cMensaje);
			if (iOpcion == IDYES)
			{
				iflag_descuentomoracliente = 1;
			}
			mostroMensajeMora = 1;

		}

	}
	if (iflag_descuentomoracliente == 1)
	{
		iContador++;
		CargarCA0230();
	}
}
bool CDlgCapturarAbono::obtenerurlService(int iTipo, char *curl)
{
	char cLog[500] = { 0 };
	bool bRetorna = false;
	char cSql[45] = { 0 };

	sprintf_s(cLog, "FC0200805021522433 - entra - obtenerurlService");
	grabarLog(cLog);

	sprintf_s(cSql, "select * from fun_urlswebservice('%d')", iTipo);

	cObtenerMensajeAbono urlservice(&odbc);
	if (urlservice.Exec(cSql))
	{
		urlservice.activarCols();
		if (urlservice.Leer())
		{
			sprintf(curl, urlservice.msg1);
			bRetorna = true;
		}
	}
	else
	{
		//Se obtiene el error
		urlservice.odbc->GetLastError(urlservice.GetHstmt());
		grabarMensajeError("C", m_grid.iCaja, (LPTSTR)(LPCTSTR)m_grid.sServer, "capturarabono", "CDlgCapturarAbono", "obtenerFlag", cSql, m_grid.lEmpleado, "ERROR EN LA CONSULTA(obtenerurl)", urlservice.odbc, m_grid.iMuestraMsg);
	}
	return bRetorna;
}

void CDlgCapturarAbono::IniciarContactabilidad()
{
	char cLog[500] = { 0 };
	int iTipoAdicional = 0;
	long iFlagCausa = 0;
	long iFlagCausa2 = 0;
	bool bProcesoHuella = false;
	int iOpcionDatos = 24;
	int iOpcion = 0;
	long lFlagHuella = 0;
	int iFlagRecaptura = 0;
	CUtil util;
	CEntorno entorno;
	sprintf_s(cLog, "FC0200805021522437 - entra - IniciarContactabilidad");
	grabarLog(cLog);
	entorno.lCliente = m_grid.lCliente;
	entorno.iCaja = m_grid.iCaja;
	entorno.iSistema = m_grid.iSistema;
	entorno.iTienda = m_grid.iTienda;
	entorno.lEmpleado = m_grid.lEmpleado;
	entorno.sIpTienda = m_grid.sServer;
	entorno.sIpTienda.Trim();
	entorno.iSuborigen = GetIdSuborigen(CDlgCapturarAbono::iScCA0030, iSistema);
	entorno.sAppName.Append("capvaltelefonos");
	CContactabilidad contactabilidad(&entorno);

	util.GrabarLog("FC0200805103819982 - Instancia de CContactabilidad creada");
	if (GetSetTipoBiometrizado(VALIDACION_HUELLA_CONTACTABILIDAD) == VALIDACION_BIOMETRIZADA_TITULAR)
	{
		util.GrabarLog("a408706c5601 - Identificado como titular en contactabilidad");
		if (contactabilidad.GetEsActiva())
		{
			util.GrabarLog("FC0200805103819963 - Se ejecuta lógica activa");
			if (contactabilidad.GetEsSolicitable())
			{                
				contactabilidad.EjecutarAppCapturaValidacion();
			}
		}
	}
	else
	{
		util.GrabarLog("9ae1a179a44b - lógica de contactabilidad ignorada por no ser titular");
	}
	sprintf_s(cLog, "FC0200805021522439 - fin - IniciarContactabilidad");
	grabarLog(cLog);
}

void CDlgCapturarAbono::EjecutarProcesoSituacionesEspeciales()
{
	char cLog[500] = { 0 };

	int iFlagClienteIlocalizable = 0;
	int iSysFlagPedirCorreoSorteo = 0;
	bool bimprimio = false;
	bool bClienteEsEmpleado = false;
	char cSexoHM[2] = { 0 };

	int iTipoAdicional = 0;
	long iFlagCausa = 0;
	long iFlagCausa2 = 0;
	char cSql[256] = { 0 };
	bool bProcesoHuella = false;
	int iOpcionDatos = 24;
	int iFlagRecaptura = 0;

	lClienteDlg = m_grid.lCliente;
	iTiendaDlg = m_grid.iTienda;
	iCajaDlg = m_grid.iCaja;
	lEmpleadoDlg = m_grid.lEmpleado;

	sprintf_s(cLog, "FC0200805021522441 - entra - EjecutarProcesoSituacionesEspeciales()");
	grabarLog(cLog);

	ModificarClienteLocalizar();

	iProceso = CAPTURA_ABONO;
	iRegla = INCLUIRCLIENTEILOCALIZABLEPARACAPTURA;
	if (ValidarSituacionEspecial(m_grid.lCliente, iRegla, iProceso, 3))
	{
		obtenerFlag('C', FLAGC_PROCESO_CLIENTEILOCALIZABLE, iFlagClienteIlocalizable);

		sprintf_s(cMensaje, "grabarAbono::Flag Cliente ILocalizable = %d", iFlagClienteIlocalizable);
		grabarLog(cMensaje);

		if (GetSetCuestionTitular() != RESPUESTA_CUESTION_POSITIVA)
		{
			grabarLog("grabarAbono::No es cliente titular");

			if (iFlagClienteIlocalizable)
			{
				//gnwSuplirHuellaGerente.cpp
				validarHuellaEmpleadoGte01(&odbc, lGteHuella, 2, 0, 0L, m_grid.iTienda, 3, m_grid.iCaja, "CA0030");

				if (lGteHuella >= 0 && lGteHuella != -1)
				{
					if (lGteHuella < 90000000)
					{
						this->iBiometrizadoGerente = VALIDACION_BIOMETRIZADA_NO_AUTORIZADA;
						pintarMensajesErrorPasstda(lGteHuella);
					}
					else
					{
						this->iBiometrizadoGerente = VALIDACION_BIOMETRIZADA_GERENTE;
						grabarLog("grabarAbono:ImprimirMensajeActualizarDatos: Inicio");
						ImprimirMensajeActualizarDatos();
						bimprimio = true;
						grabarLog("grabarAbono:ImprimirMensajeActualizarDatos: Fin");
					}
				}
				else
				{
					this->iBiometrizadoGerente = VALIDACION_BIOMETRIZADA_NO_AUTORIZADA;
					AfxMessageBox("LA HUELLA CAPTURADA NO ES DE GERENTE ");
					lGteHuella = 0;
				}
			}
		}
		else
		{
			grabarLog("grabarAbono::Es cliente titular");
			iRegla = INCLUIRCLIENTE_VICITACAMBIO;
			if (!ValidarSituacionEspecial(m_grid.lCliente, iRegla, iProceso, 3))
			{
				lFlagHuella = GetSetTipoBiometrizado(
					VALIDACION_HUELLA_SITUACIONES_ESPECIALES) == VALIDACION_BIOMETRIZADA_TITULAR? 1 : -1;

				sprintf_s(cMensaje, "grabarAbono::lFlagHuella = %ld", lFlagHuella);
				grabarLog(cMensaje);

				if (lFlagHuella != 1)
				{
					if (iFlagClienteIlocalizable)
					{
						//gnwSuplirHuellaGerente.cpp
						validarHuellaEmpleadoGte01(&odbc, lGteHuella, 2, 0, 0L, m_grid.iTienda, 3, m_grid.iCaja, "CA0030");
						sprintf_s(cMensaje, "grabarAbono::lGteHuella = %ld", lGteHuella);
						grabarLog(cMensaje);

						if (lGteHuella >= 0 && lGteHuella != -1)
						{
							if (lGteHuella < 90000000)
							{
								this->iBiometrizadoGerente = VALIDACION_BIOMETRIZADA_NO_AUTORIZADA;
								pintarMensajesErrorPasstda(lGteHuella);
							}
							else
							{
								this->iBiometrizadoGerente = VALIDACION_BIOMETRIZADA_GERENTE;
								capturarDatosClientesIlocalizables();
							}
						}
						else
						{
							this->iBiometrizadoGerente = VALIDACION_BIOMETRIZADA_NO_AUTORIZADA;
							AfxMessageBox("LA HUELLA CAPTURADA NO ES DE GERENTE ");
							lGteHuella = 0;
						}
					}
				}
				else
				{
					capturarDatosClientesIlocalizables();
				}
			}
		}
	}

	if (!(lClienteDlg >= 90000000 && lClienteDlg < 100000000)
		&& iFlagDescuentoEspecial == 0
		&& iSistema != SISTEMA_CAJERA_CAPTURISTA)
	{
		if (validarSituacionEspecialEmpleados(bClienteEsEmpleado))
		{
			if (!bClienteEsEmpleado)
			{
				if (consultarFlag(&odbc, cSql, '0', FLAG_TIENDALOCAL, iFlagTiendaLocal) &&
					consultarFlag(&odbc, cSql, '0', FLAG_SORTEO_BOLETOS_PREMIOS, iFlagSorteoBoletoPremios) &&
					consultarFlag(&odbc, cSql, '0', FLAG_PEDIRTELEFONOSORTEO, iSysFlagPedirCorreoSorteo))
				{
					if (iFlagTiendaLocal != 1 && iFlagSorteoBoletoPremios != 1 && iSysFlagPedirCorreoSorteo == 1)
					{
						if (GetSetCuestionTitular() != RESPUESTA_CUESTION_POSITIVA)
						{
							lFlagHuella = 0;
						}
						else
						{
							lFlagHuella = GetSetTipoBiometrizado(
								VALIDACION_HUELLA_SITUACIONES_ESPECIALES) == VALIDACION_BIOMETRIZADA_TITULAR ? 1 : -1;
						}
						bCargaDatosSorteo = true;
					}
				}
			}
		}
	}

	sprintf_s(cLog, "FC0200805021522444 - fin - EjecutarProcesoSituacionesEspeciales()");
	grabarLog(cLog);
}

int CDlgCapturarAbono::GetIdSuborigen(short iComponente, int iNumSistemaSubOrigen)
{
	char cLog[500] = { 0 };

	int iIdSuborigen = 1;//default

	sprintf_s(cLog, "FC0200805021522454 - entra - GetIdSuborigen(short iComponente, int iNumSistemaSubOrigen)");
	grabarLog(cLog);

	if (iNumSistemaSubOrigen == SISTEMA_MUEBLES)
	{
		if (iComponente == CDlgCapturarAbono::iScCA0030)
		{
			iIdSuborigen = 43;
		}
		else if (iComponente == CDlgCapturarAbono::iScGN0214)
		{
			iIdSuborigen = 38;
		}
	}
	else if (iNumSistemaSubOrigen == SISTEMA_ROPA)
	{
		if (iComponente == CDlgCapturarAbono::iScCA0030)
		{
			iIdSuborigen = 24;
		}
		else if (iComponente == CDlgCapturarAbono::iScGN0214)
		{
			iIdSuborigen = 26;
		}
	}
	else if (iNumSistemaSubOrigen == SISTEMA_CAJAS && iComponente == CDlgCapturarAbono::iScGN0214)
	{
		iIdSuborigen = 19;
	}

	sprintf_s(cLog, "FC0200805021522456 - Determinado iIdSuborigen = %d", iIdSuborigen);
	grabarLog(cLog);

	return iIdSuborigen;
}

/// <summary>
/// Establece y retorna el resultado de la pregunta que se le hace al cliente. Si no se ha ejecutado por primera vez,
/// se levanta el AfxMessageBox, de lo contrario retorna el último valor obtenido.
/// </summary>
/// <returns>Resultante de la evaluación y establecimiento del mismo a nivel clase</returns>
short CDlgCapturarAbono::GetSetCuestionTitular()
{
	char cLog[500] = { 0 };
	int afxResponse = 0;
	CString sValores = "";

	sprintf_s(cLog, "c0d84e482829 - entra - GetSetCuestionTitular()");
	grabarLog(cLog);

	if (this->iTipoCuestion == RESPUESTA_CUESTION_INDEFINIDA)
	{
		sprintf_s(cLog, "2a0f2b240f3e - Se muestra: El cliente es titular?");
		grabarLog(cLog);
		while (!(afxResponse == IDYES || afxResponse == IDNO))
		{
			afxResponse = AfxMessageBox("¿Usted es titular o adicional de la cuenta?", 
				MB_YESNO | MB_ICONQUESTION | MB_TOPMOST | MB_APPLMODAL);
			this->iTipoCuestion = afxResponse == IDYES ? RESPUESTA_CUESTION_POSITIVA : RESPUESTA_CUESTION_NEGATIVA;
		}
	}
	else
	{
		sprintf_s(cLog, "19a76e1a8b5b - pregunta previamente respondida");
		grabarLog(cLog);
	}

	sprintf_s(cLog, "89f88e02f69c - this->iTipoCuestion=%d, this->iBiometrizadoCliente=%d, afxResponse=%d",
		this->iTipoCuestion, this->iBiometrizadoCliente, afxResponse);
	grabarLog(cLog);

	return this->iTipoCuestion;
}

/// <summary>
/// Establece y retorna el resultado de toma de huellas del CHW. Si no se ha ejecutado por primera vez,
/// se levanta la captura de huellas, de lo contrario retorna el último valor obtenido.
/// </summary>
/// <param name="iProcesoEjecutor">Nemónico y valor del proceso que realiza la invocación</param> 
/// <returns>Resultante de la evaluación y establecimiento del mismo a nivel clase</returns>
short CDlgCapturarAbono::GetSetTipoBiometrizado(int iProcesoEjecutor)
{
	char cLog[500] = { 0 };
	long iFlagCausa = 0;
	long iFlagCausa2 = 0;
	char cSql[256] = { 0 };
	bool bProcesoHuella = false;
	int iOpcionDatos = 24;
	int iFlagRecaptura = 0;

	sprintf_s(cLog, "FC0200805021522446 - entra - GetSetTipoBiometrizado(%d)", iProcesoEjecutor);
	grabarLog(cLog);

	if (GetSetCuestionTitular() == RESPUESTA_CUESTION_NEGATIVA)//se asegura de no pasar chw sin preguntar primero
	{
		this->iBiometrizadoCliente = VALIDACION_BIOMETRIZADA_NO_AUTORIZADA;
		this->iNumeroAdicional = 0;
	}

	if (this->iBiometrizadoCliente == VALIDACION_BIOMETRIZADA_INDEFINIDA)
	{//si no se ha levantado el sensor con anterioridad:
		validarChWClienteOAdicional(iOpcionDatos, m_grid.lCliente, m_grid.iTienda, iProcesoEjecutor, m_grid.iCaja,
			SISTEMA_CAJAS, cNombre, cApellidoPaterno, cApellidoMaterno, cSexo, &odbc, cSql, bProcesoHuella,
			m_grid.lCliente, iFlagCausa, iFlagCausa2, m_grid.lEmpleado, iFlagRecaptura, this->iNumeroAdicional);

		if (bProcesoHuella)
		{
			if (this->iNumeroAdicional == 0)
			{
				this->iBiometrizadoCliente = VALIDACION_BIOMETRIZADA_TITULAR;
				this->iTipoCuestion = RESPUESTA_CUESTION_POSITIVA;
			}
			else if (this->iNumeroAdicional > 0)
			{
				this->iBiometrizadoCliente = VALIDACION_BIOMETRIZADA_ADICIONAL;
				this->iTipoCuestion = RESPUESTA_CUESTION_POSITIVA;
			}
			else
			{
				this->iBiometrizadoCliente = VALIDACION_BIOMETRIZADA_NO_AUTORIZADA;
			}
		}
		else
		{
			this->iTipoCuestion = RESPUESTA_CUESTION_NEGATIVA;
			this->iBiometrizadoCliente = VALIDACION_BIOMETRIZADA_NO_AUTORIZADA;
			AfxMessageBox("No se puede leer la huella del cliente.", MB_ICONWARNING | MB_TOPMOST | MB_APPLMODAL);
			sprintf_s(cLog, "FC0200805021522448 - Muestra mensaje: No se puede leer la huella del cliente. ");
			grabarLog(cLog);
		}
	}
	else
	{
		sprintf_s(cLog, "8f56118d95a9 - Valor de la huella previamente establecido");
		grabarLog(cLog);
	}

	sprintf_s(cLog, "FC0200805021522450 - determinado iBiometrizadoCliente=%d", this->iBiometrizadoCliente);
	grabarLog(cLog);

	sprintf_s(cLog, "FC0200805021522452 - fin - SetTipoBiometrizado()");
	grabarLog(cLog);
	return this->iBiometrizadoCliente;
}

/** --------------------------------------------------------------------------------
@verbatim
Consultar hora de la micro
@endverbatim

@return: 

@date 20200923
@author Alejandro Garcia

@note Repositorio del proyecto: 
svn://10.44.15.239/sysx/st2005Dlls/Muebles/CapturarFactura
--------------------------------------------------------------------------------
**/
void CDlgCapturarAbono::iniciarMovimientoOperacion()
{
	//Puente
	CString sRuta = "", sClaseConstructor = "", sAux = "", sMetodo = "";
	CStringArray sArgsConstructor, sArgsMetodo;
	char cMensajeSeguimiento[ 200 ] = { 0 };

	sRuta = "C:\\SYS\\PROGX\\GN\\GN0269.DLL"; //Modulo
	sClaseConstructor = "RegistrarMovimientosOperaciones.Principal"; //Clase con el constructor
	sMetodo = "Lanzar"; //Metodo a invocar

	sAux.Format("%s", "1");
	sArgsMetodo.Add(sAux);

	sAux.Format("%d", m_grid.iTienda);
	sArgsMetodo.Add(sAux);

	sAux.Format("%s", cIPServidorTiendaNumero);
	sArgsMetodo.Add(sAux);

	sAux.Format("%d", m_grid.iCaja); 
	sArgsMetodo.Add(sAux);

	sAux.Format("%c", m_grid.cArea);
	sArgsMetodo.Add(sAux);

	sAux.Format("%ld", m_grid.lEmpleado); 
	sArgsMetodo.Add(sAux);

	sAux.Format("%s", "0");
	sArgsMetodo.Add(sAux);

	sAux.Format("%s", "");
	sArgsMetodo.Add(sAux);

	sAux.Format("%s", "0");
	sArgsMetodo.Add(sAux);

	sAux.Format("%ld", "0");
	sArgsMetodo.Add(sAux);

	sArgsConstructor.Add("");

	CFileFind finder;
	bool bFound = false;
	bFound = finder.FindFile(sRuta);

	if(bFound == true)
	{
		if( sFechaHoraInicioOperacion.IsEmpty() )
		{
			::CoInitialize(NULL);

			CCargaDllCSharp *objCargaDll = new CCargaDllCSharp();
			objCargaDll->CargarDllCSharp( sRuta, sClaseConstructor, METODO_STRING, sMetodo, sArgsConstructor, sArgsMetodo );
			objCargaDll->getRespuesta( sFechaHoraInicioOperacion );

			delete objCargaDll;

			::CoUninitialize();

			memset(cMensajeSeguimiento, 0, sizeof(cMensajeSeguimiento));
			sprintf(cMensajeSeguimiento, "-- Inicia movimiento ABONO --");
			grabarLog(cMensajeSeguimiento);
		}
	}
}

/** --------------------------------------------------------------------------------
@verbatim
Metodo encargado de grabar el final de una operacion
@endverbatim

@return: 

@date 20200923
@author Alejandro Garcia

@note Repositorio del proyecto: 
svn://10.44.15.239/sysx/st2005Dlls/Muebles/CapturarFactura
--------------------------------------------------------------------------------
**/
void CDlgCapturarAbono::terminarMovimientoOperacion()
{
	//Puente
	CString sRuta = "", sClaseConstructor = "", sAux = "", sMetodo = "";
	CStringArray sArgsConstructor, sArgsMetodo;
	char cMensajeSeguimiento[ 200 ] = { 0 };
	CString sRespuesta = "";

	sRuta = "C:\\SYS\\PROGX\\GN\\GN0269.DLL"; //Modulo
	sClaseConstructor = "RegistrarMovimientosOperaciones.Principal"; //Clase con el constructor
	sMetodo = "Lanzar"; //Metodo a invocar

	sAux.Format("%s", "5");
	sArgsMetodo.Add(sAux);

	sAux.Format("%d", m_grid.iTienda);
	sArgsMetodo.Add(sAux);

	sAux.Format("%s", cIPServidorTiendaNumero);
	sArgsMetodo.Add(sAux);

	sAux.Format("%d", m_grid.iCaja); 
	sArgsMetodo.Add(sAux);

	sAux.Format("%c", m_grid.cArea);
	sArgsMetodo.Add(sAux);

	sAux.Format("%ld", m_grid.lEmpleado); 
	sArgsMetodo.Add(sAux);

	sAux.Format("%s", "14");
	sArgsMetodo.Add(sAux);

	sAux.Format("%s", sFechaHoraInicioOperacion);
	sArgsMetodo.Add(sAux);

	sAux.Format("%s", "12");
	sArgsMetodo.Add(sAux);

	sAux.Format("%ld", lNumeroRecibo);
	sArgsMetodo.Add(sAux);

	sArgsConstructor.Add("");

	CFileFind finder;
	bool bFound = false;
	bFound = finder.FindFile(sRuta);

	if(bFound == true)
	{
		::CoInitialize(NULL);

		CCargaDllCSharp *objCargaDll = new CCargaDllCSharp();
		objCargaDll->CargarDllCSharp( sRuta, sClaseConstructor, METODO_STRING, sMetodo, sArgsConstructor, sArgsMetodo );
		objCargaDll->getRespuesta( sRespuesta );

		delete objCargaDll;

		::CoUninitialize();

		sFechaHoraInicioOperacion.Empty();

		memset(cMensajeSeguimiento, 0, sizeof(cMensajeSeguimiento));
		sprintf(cMensajeSeguimiento, "-- Termina movimiento ABONO --");
		grabarLog(cMensajeSeguimiento);
	}
}
void CDlgCapturarAbono::inviteMensajeAfore()
{
	int iFlagMsgAfore = 0;
	int iFlagTiendaLoc = 0;
	char cInput1[1024] = { 0 }, cInput2[1024] = { 0 }, cRegion[15] = {0}, cLog[500] = { 0 },sFecha[15], sSexo[10],sArea[10], cTexto[80] = {0};
	sprintf_s(cLog, "CDlgCapturarAbono - inviteMensajeAfore");
	grabarLog(cLog);
	sprintf_s(sFecha,"%s", cFechaNacimientoCliente);
	sprintf_s(sSexo, "%s", cSexoCliente);

	if( iSistema == 3 )
	{	
		sprintf_s(cLog, "CDlgCapturarAbono - valida flag msjafore");
		grabarLog(cLog);
		obtenerFlag( '0', FLAG_TIENDALOCAL, iFlagTiendaLoc);
		obtenerFlag( '0', FLAG_PROSPECTOS_AFORE, iFlagMsgAfore);

		if( iFlagMsgAfore == 1 && esEmpleado(m_grid.lCliente) != 1 )
		{

			SParametros parametros;
			memset( &parametros, 0, sizeof( SParametros ) );
			parametros.iTienda = m_grid.iTienda;
			if(this->iBiometrizadoCliente == VALIDACION_BIOMETRIZADA_TITULAR)
			{
				parametros.iBodega = 1;  // aqui se enviara si se autentico cte 1   
			}else
			{
				parametros.iBodega = 0; // aqui se enviara si se autentico cte 1   
			}
			parametros.iLink = generarLink();
			parametros.lEmpleado = m_grid.lEmpleado;
			parametros.lCliente = m_grid.lCliente;
			sprintf_s(cLog, "CDlgCapturarAbono - obtenerregion");
			grabarLog(cLog);
			obtenerRegion(cRegion); // obtenemos la region
			sprintf( parametros.sIpCredito1, "%.15s", cRegion );  // aqui se enviara region tienda CULIACAN, TIJUANA, ETC
			sprintf( parametros.sIpCredito2, "%s", "ABONOS" );  //AQUI SE ENVIARA EL SISTEMA DONDE SE REALIZO MOVIMIENTO
			sprintf( parametros.sServer, "%.20s", cIPServidorTiendaNumero );
			sprintf_s(parametros.cNombre, "%.20s",cNombre);
			sprintf_s(parametros.cApellidoPaterno,"%.20s",cApellidoPaterno);
			sprintf_s(parametros.cApellidoMaterno,"%.20s",cApellidoMaterno);
			sprintf_s(parametros.sModo, "%.10s",cSexoCliente);
			sprintf_s(parametros.sIpCartera1,"%.20s",cFechaNacimientoCliente);			

			memcpy( cInput1, &parametros, sizeof( SParametros ) );
			sprintf_s(cLog, "CDlgCapturarAbono - levanta dll GN0299");
			grabarLog(cLog);
			CargarDLL cargarDll( "C:\\SYS\\PROGX\\GN\\GN0299", "GN0299", cInput1, cInput2);
			sprintf_s(cLog, "CDlgCapturarAbono - termina dll GN0299");
			grabarLog(cLog);
			//iResultado = cargarDll.getResultado();


		}

	} 

}
void CDlgCapturarAbono::obtenerRegion( char *cRegion )
{

	char cSql[128] = {0};

	sprintf( cSql, "SELECT bodegamueblesnacional FROM gndominio;");

	CConsultarRegion consultarRegionSQL( &odbc );

	if ( !consultarRegionSQL.Exec( cSql ) )
	{
		consultarRegionSQL.odbc->GetLastError( consultarRegionSQL.GetHstmt() );
	}
	else
	{
		consultarRegionSQL.activarCols();
		if ( consultarRegionSQL.leer() )
		{
			sprintf( cRegion, "%.15s", consultarRegionSQL.bodegamueblesnacional );

		}
	}


}

bool CDlgCapturarAbono::ConsultaClienteCoppelRecompensaTuPuntualidad()
{
	ConsultarValorAbonosPuntuales(iValorAbonosPuntuales);
	bool bRegresa = true;
	int iResult = 0, iStatus = 0;
	CString sAux = "", sContenido = "", sUrl = "", sStatus = "";
	char file[512] = {0}, cLog[500] = { 0 }, cJson[2024] = {0}, cResultado[1024] = {0};
	CUT_HTTPClient clienteHttp;
	Json::Value root2;
	Json::Reader reader;

	sprintf_s(cLog, "Entra - ConsultaClienteCoppelRecompensaTuPuntualidad()");
	grabarLog(cLog);

	clienteHttp.AddSendHeaderTag("Content-Type: application/json; charset=utf-8");
	bErrorWS = false;

	if(obtenerurlService(42, urlservice))
	{

		CUT_BufferDataSource ds(file, _tcslen(file));

		sUrl.Format("http://%s/coppelRecompensa/Cliente?numCliente=%ld", urlservice, m_grid.lCliente);

		iResult = clienteHttp.GET(sUrl.GetBuffer(sUrl.GetLength()));

		if (iResult == UTE_SUCCESS)
		{
			LPCSTR line;

			for (int i = 0; i < clienteHttp.GetBodyLineCount(); i++)
			{
				line = clienteHttp.GetBodyLine(i);
				if (line != NULL)
				{
					sContenido.AppendFormat("%s\r\n", line);
				}
			}
		}
		else
		{
			sAux.Format("ERROR \n %s", CUT_ERR::GetErrorString(iResult));
			sprintf_s(cMensaje, "%s", (LPCTSTR)sAux);
			grabarLog(cMensaje);
			bErrorWS = true;
			bRegresa = false;
		}

		//Extraer "x" datos del JSON
		if (bRegresa)
		{			
			sprintf(cJson, "%s", (LPCTSTR)sContenido);
			StaticJsonBuffer<100000> jsonBuffer;
			JsonObject& root = jsonBuffer.parseObject(cJson);//se accede a la raiz del json

			if(root.success())
			{
				auto cjsondata= root["data"];	 
				sprintf_s(cJson, cjsondata);
				sprintf_s(cResultado, "json:%s", cJson, 1024);
				grabarLog(cResultado);
				iStatus = root["status"];
				sprintf_s(cResultado ,"%d",iStatus);
				grabarLog(cResultado);
			}


			bool parsingSuccessful2 = reader.parse( cJson, root2 );

			if (!root.success())
			{
				//Indica que la estructura del json no es correcta
				sAux.Format("parseObject() root failed"); //Dejar log del error
				sprintf_s(cMensaje, "%s", sAux);
				grabarLog(cMensaje);
				bErrorWS = true;
				bRegresa = false;
			}
			else if(parsingSuccessful2)
			{
				if(sStatus == 1)
				{
					iCorteActual = 0;
					sprintf_s(cResultado ,"Abonos Puntuales - %d",iCorteActual);	
					grabarLog(cResultado);

					iCorteLogica = iValorAbonosPuntuales;
					sprintf_s(cResultado ,"Abonos Solicitados - %d",iCorteLogica);	
					grabarLog(cResultado);
				}
				else
				{
					iCorteActual = root2["corteActual"].asInt();
					sprintf_s(cResultado ,"Abonos Puntuales - %d",iCorteActual);
					grabarLog(cResultado);

					iCorteLogica = root2["cortesLogica"].asInt();
					sprintf_s(cResultado ,"Abonos Solicitados - %d",iCorteLogica);	
					grabarLog(cResultado);
				}
			}

		}
	}

	sprintf_s(cLog, "Finaliza - ConsultaClienteCoppelRecompensaTuPuntualidad()");
	grabarLog(cLog);
	return bRegresa;
}

bool CDlgCapturarAbono::ConsultarSaldoDineroElectronicoCliente(bool iRefreshDineroElectronico)
{
	bool bRegresa = true;
	bool bMostrarDineroElectronico = false;
	int iResult = 0;
	CString sAux = "", sContenido = "", sUrl = "", sStatus = "", sDineroElectronico = "";
	char file[512] = {0}, cLog[500] = { 0 }, cJson[2024] = {0}, cJsonData[2024] = {0}, cResultado[1024] = {0}, cDineroElectronico[50] = {0};
	CUT_HTTPClient clienteHttp;

	sprintf_s(cLog, "Entra - ConsultarSaldoDineroElectronicoCliente()");
	grabarLog(cLog);

	clienteHttp.AddSendHeaderTag("Content-Type: application/json; charset=utf-8");
	bErrorWS = false;


	if(iflagNuevoMonederoElectronico != 1)
	{
		if(iRefreshDineroElectronico)
		{
			CCuentaWeb *pCuentaClienteAbonosPuntuales = new CCuentaWeb();
			pCuentaClienteAbonosPuntuales->iniciarCCuenta(m_grid.lCliente, cFechaTienda, (short)m_grid.iTienda, (short)iCiudadGnDominio, cIpServidorCartera, cIpServidorCCuentaWeb, (short)iFlagTimeOutCCuenta);
			pCuentaClienteAbonosPuntuales->leerCuenta01("8");

			for (int i = 0; i < pCuentaClienteAbonosPuntuales->iCuentas; i++)
			{
				if (pCuentaClienteAbonosPuntuales->pCuenta[i].iTipoDeCuenta == CUENTA_DINEROELECTRONICO)
				{
					iSaldoDineroElectronicoCuenta = pCuentaClienteAbonosPuntuales->pCuenta[i].lDineroElectronico ;
					break;
				}
			}
			iDineroElectronico = iSaldoDineroElectronicoCuenta;
			bMostrarDineroElectronico = true;
			grabarLog("CDlgCapturarAbono Liberar --> pCuentaClienteAbonosPuntuales 34351 Cambio Softtek");
			delete pCuentaClienteAbonosPuntuales;
			grabarLog("CDlgCapturarAbono  Se Libera --> pCuentaClienteAbonosPuntuales 34351 Cambio Softtek");

		}
	} 
	else if(obtenerurlService(102, urlservice))
	{

		CUT_BufferDataSource ds(file, _tcslen(file));

		sUrl.Format("%s/api/v1/saldos/%ld/empresa/1/", urlservice, m_grid.lCliente);

		iResult = clienteHttp.GET(sUrl.GetBuffer(sUrl.GetLength()));

		if (iResult == UTE_SUCCESS)
		{
			LPCSTR line;

			for (int i = 0; i < clienteHttp.GetBodyLineCount(); i++)
			{
				line = clienteHttp.GetBodyLine(i);
				if (line != NULL)
				{
					sContenido.AppendFormat("%s\r\n", line);
				}
			}
		}
		else
		{
			sAux.Format("ERROR \n %s", CUT_ERR::GetErrorString(iResult));
			sprintf_s(cMensaje, "%s", sAux);
			grabarLog(cMensaje);
			bErrorWS = true;
			bRegresa = false;
		}

		//Extraer "x" datos del JSON
		if (bRegresa)
		{			
			sprintf(cJson, "%s", (LPCTSTR)sContenido);
			StaticJsonBuffer<100000> jsonBuffer;
			JsonObject& root = jsonBuffer.parseObject(cJson);	//se accede a la raiz del json

			if (!root.success())
			{
				//Indica que la estructura del json no es correcta
				sAux.Format("parseObject() root failed"); //Dejar log del error
				sprintf_s(cMensaje, "%s", (LPCTSTR)sAux);
				grabarLog(cMensaje);
				bErrorWS = true;
				bRegresa = false;
			}
			else
			{
				sStatus = root["data"]["status"];
				sprintf(cResultado, "Status Consulta Cliente DE - %s", (LPCTSTR)sStatus);
				grabarLog(cResultado);

				if(sStatus == "500")
				{
					iDineroElectronico = 0;
					sprintf_s(cResultado ,"Dinero Electronico - %d",iDineroElectronico);	 
					grabarLog(cResultado);
					bMostrarDineroElectronico = true;
				}
				else
				{
					iDineroElectronico = root["data"]["datos"]["saldo"];
					sprintf_s(cResultado ,"Dinero Electronico - %d",iDineroElectronico);	 
					grabarLog(cResultado);
					bMostrarDineroElectronico = true;
				}
			}
		}
	}
	if(bMostrarDineroElectronico && iflagDineroElectronico == 1)
	{
		if(iDineroElectronico < 0)
		{
			iDineroElectronico = 0;
		}

		usingx("#,###,###", cDineroElectronico, (double)iDineroElectronico);
		sDineroElectronico.Format("%s", cDineroElectronico);
		sDineroElectronico.Trim();
		m_dineroElectronico.SetWindowText("$" + sDineroElectronico);
		GetDlgItem(IDC_MSGDINEROELECTRONICO)->ShowWindow(true); 
		GetDlgItem(IDC_DINEROELECTRONICO)->ShowWindow(true); 
		iSaldoDineroElectronicoCuenta = 0;
	}

	sprintf_s(cLog, "Finaliza - ConsultarSaldoDineroElectronicoCliente()");
	grabarLog(cLog);
	return bRegresa;
}

void CDlgCapturarAbono::ConsultarValorAbonosPuntuales(short &iValorAbonosPuntuales)
{
	char cLog[500] = { 0 };
	char cSql[250] = { 0 };
	char cResultado[1024] = {0};
	int iTipoOperacion = 471;

	sprintf_s(cLog, "Entra - ConsultarValorAbonosPuntuales()");
	grabarLog(cLog);

	sprintf_s(cSql, "select idu_valorconfiguracion from ctl_configuracionoperaciones where num_tipooperacion = %d", iTipoOperacion);
	//Obtener el valor de los abonos puntuales
	CMaximo valorAbonosPuntuales(&odbc, false);
	if (valorAbonosPuntuales.Exec(cSql))
	{
		valorAbonosPuntuales.activarCols();
		if(valorAbonosPuntuales.Leer())
		{
			iValorAbonosPuntuales = valorAbonosPuntuales.Total;
		}
		sprintf_s(cResultado ,"Valor Abonos Puntuales - %d",iValorAbonosPuntuales);	
		grabarLog(cResultado);
	}
	else
	{
		//Se obtiene el error
		valorAbonosPuntuales.odbc->GetLastError(valorAbonosPuntuales.GetHstmt());
		grabarMensajeError("C", m_grid.iCaja, (LPTSTR)(LPCTSTR)m_grid.sServer, "CapturarAbono", "CDlgCapturarAbono", "ConsultarValorAbonosPuntuales", cSql, m_grid.lEmpleado, "ERROR EN LA CONSULTA(ConsultarValorAbonosPuntuales)", valorAbonosPuntuales.odbc, m_grid.iMuestraMsg);
	}

	sprintf_s(cLog, "Finaliza - ConsultarValorAbonosPuntuales()");
	grabarLog(cLog);
}
bool CDlgCapturarAbono::leerCandidatoPrestamoBRM(long lCliente)
{	
	grabarLog("CDlgCapturarAbono::leerCandidatoPrestamoBRM. Entró a leerCandidatoPrestamoBRM(long lCliente)" );
	bool bRegresa = false;
	CString sUrl = "", sContenido = "", sAux = "",  sAutorizacion="";
	int iResult = 0;
	long lCount = 0;
	long lcanalorigen = 1; 
	long lcanalconsulta = 1;
	char ConsultaUrl[512] = {0};
	char cUrl[255] ={0}, cSql[255]={0}, cMensaje[1024] = {0};
	char cMetodoServicio[255] = "/consulta/";
	CUT_HTTPClient clienteHttp;
	Json::Value root;
	Json::Reader reader;   
	int iRetorno = 0;
	bool bRetorno = false;
	char cAreaX = 'C';

	iEstatusApi = 0;
	long montoMaximo = 0;

	try
	{
		//30130
		if(obtenerurlService(URL_APIPRESTAMOSPERSONALES, cUrl))
		{
			//usando un get
			sUrl.Format("%s%s%ld/%ld/%ld/%ld/%ld/%d/%s/%s/%c",cUrl,cMetodoServicio,lCliente,lcanalorigen,lcanalconsulta,iCiudadCliente,iTiendaDlg,iCajaActual,cIpServidorCartera,cIpServidorCCuentaWeb,cAreaX);
			iRetorno = sprintf_s(ConsultaUrl,"%s", (LPCTSTR)sUrl.Trim());
			if(iRetorno >=0){
				bRetorno = true;
			}

			//Restreb
			bool bRespuesta = true ;
			_bstr_t bsData ="<empty>";
			char sMensaje[350]= {0};
			CString* sData = NULL;
			CString sRespuesta = "";
			_bstr_t sTokenAutentificacion = sToken;

			_bstr_t sConsulta= sUrl;    

			try
			{		 
				grabarLog( "CDlgCapturarAbono::leerCandidatoPrestamoBRM. Inicia Restreb" );
				CoInitialize(NULL);        
				RESTREB::IRestREbPtr rest;    
				rest.CreateInstance(__uuidof( RESTREB::REbRest));       
				bsData = rest->Get_2(sConsulta,sTokenAutentificacion);    
				CoUninitialize();

				sData = new CString(bsData.GetBSTR());

				sRespuesta = sData->GetString();
				bRegresa=true;
				grabarLog("CDlgCapturarAbono Liberar --> sData 34538 Cambio Softtek");
				delete sData;
				grabarLog("CDlgCapturarAbono Se Libera --> sData 34538 Cambio Softtek");

				grabarLog( "CDlgCapturarAbono:: Finalizó Restreb" );
			}
			catch(...)
			{				
				iRetorno = sprintf_s(sMensaje, sizeof(sMensaje), "%s", "ERROR CDlgCapturarAbono::leerCandidatoPrestamoBRM()"); //Dangerous Functions
				grabarLog( sMensaje );      
				bRegresa=false;
				AfxMessageBox("No se pudo obtener información del BRM.");

			}

			if (bRegresa)
			{         
				bRegresa = false;
				std::string sValue = sRespuesta;              
				bool bParsedSuccess = reader.parse(sValue, root, false);

				if(bParsedSuccess)
				{
					iEstatusApi = root["meta"]["statusCode"].asInt(); 

					if(iEstatusApi == 200)
					{
						consumoBRM.impMaxPrestar_p12 = root["data"]["montomaxprestar_p12"].asInt();
						consumoBRM.impMaxPrestar_p18 = root["data"]["montomaxprestar_p18"].asInt();
						consumoBRM.impMaxPrestar_p24 = root["data"]["montomaxprestar_p24"].asInt();
						consumoBRM.des_estatus = root["data"]["estatus"].asCString();

						if(consumoBRM.des_estatus == "CONTINUA")
						{
							bRegresa = true;
							grabarLog("CDlgCapturarAbono::leerCandidatoPrestamoBRM. Cliente candidato a un prestamo por servicio BRM." );

							if (consumoBRM.impMaxPrestar_p12 > consumoBRM.impMaxPrestar_p18)
							{
								if (consumoBRM.impMaxPrestar_p12  > consumoBRM.impMaxPrestar_p24)
								{
									montoMaximo = consumoBRM.impMaxPrestar_p12;
									iRetorno = sprintf_s( cMensaje,"CDlgCapturarAbono::leerCandidatoPrestamoBRM. El plazo con la cantidad maxima a prestar es a 12 meses:  [%d].", consumoBRM.impMaxPrestar_p12 );
									grabarLog( cMensaje );
								}
								else
								{
									montoMaximo =  consumoBRM.impMaxPrestar_p24;
									iRetorno = sprintf_s( cMensaje,"CDlgCapturarAbono::leerCandidatoPrestamoBRM. El plazo con la cantidad maxima a prestar es a 24 meses: [%d].", consumoBRM.impMaxPrestar_p24 );
									grabarLog( cMensaje );
								}
							}
							else if (consumoBRM.impMaxPrestar_p18 > consumoBRM.impMaxPrestar_p24)
							{
								montoMaximo = consumoBRM.impMaxPrestar_p18;
								iRetorno = sprintf_s( cMensaje,"CDlgCapturarAbono::El plazo con la cantidad maxima a prestar es a 18 meses: [%d].", consumoBRM.impMaxPrestar_p18 );
								grabarLog( cMensaje );
							}
							else
							{
								montoMaximo = consumoBRM.impMaxPrestar_p24;
								iRetorno = sprintf_s( cMensaje,"CDlgCapturarAbono::leerCandidatoPrestamoBRM. El plazo con la cantidad maxima a prestar es a 24 meses: [%d].", consumoBRM.impMaxPrestar_p24 );
								grabarLog( cMensaje );
							}
						}
						else
						{
							bRegresa = false;
							grabarLog("CDlgCapturarAbono::leerCandidatoPrestamoBRM. Cliente no candidato a un prestamo por servicio BRM." );

						}
					}
					if(iEstatusApi == 409)
					{

						bRegresa = false;
						iRetorno = sprintf_s( cMensaje,"CDlgCapturarAbono::leerCandidatoPrestamoBRM. Estatus: Error en BRM." );
						grabarLog( cMensaje );
					}
				}
				else
				{
					bRegresa = false;
					iRetorno = sprintf_s( cMensaje, "CDlgCapturarAbono::leerCandidatoPrestamoBRM: Json viene vacio: bRregresa [%s], parsedSucces [%s]", 
						bRegresa?"true":"false", bParsedSuccess?"true":"false" );
					grabarLog( cMensaje );
					AfxMessageBox("Ha ocurrido un problema al consultar al cliente mediante el BRM. Favor de comunicarse con Mesa de Ayuda.");
				}
			}
		}
		else
		{
			bRegresa = false;
			iRetorno = sprintf_s( cMensaje, "CDlgCapturarAbono::leerCandidatoPrestamoBRM: Error en consultarUrlWebService: bRregresa [%s]",
				bRegresa?"true":"false" );
			grabarLog(cMensaje );

			AfxMessageBox("Ha ocurrido un problema al consultar al cliente mediante el BRM. Favor de comunicarse con Mesa de Ayuda.");
		}
		iRetorno = sprintf_s( cMensaje, "CDlgCapturarAbono::leerCandidatoPrestamoBRM: bRregresa [%s], Sale del metodo", bRegresa?"true":"false" );
		grabarLog(cMensaje ); 

	}
	catch(...)
	{  
		if (iEstatusApi != 410)
		{
			bRegresa = false;
			AfxMessageBox("Ha ocurrido un problema al consultar al cliente mediante el BRM. Favor de comunicarse con Mesa de Ayuda.");
		} 
	}
	grabarLog("CDlgCapturarAbono:: Salió de leerCandidatoPrestamoBRM(long lCliente)" );
	return bRegresa; 
}
long CDlgCapturarAbono::leerCandidatoPrestamoCCuenta(CString sServer, int iTienda, long lEmpleado, int iCaja, int iMuestra, long lCliente, int iSistema)
{
	char cDll[64] = { 0 }, cArgvIN1[1024] = { 0 }, cArgvIN2[1024] = { 0 }, cArgvOUT1[1024] = { 0 }, cArgvOUT2[1024] = { 0 };
	long importe = 0;
	SParametros parametros;
	memset(&parametros, 0, sizeof(parametros));
	parametros.iLink = generarLink();
	sprintf_s(parametros.sServer, "%s", (LPCTSTR)sServer);
	parametros.iTienda = iTienda;
	parametros.lEmpleado = lEmpleado;
	parametros.iCajaActual = iCaja;
	parametros.iMuestraMsg = iMuestra;
	parametros.lCliente = lCliente;
	parametros.iNumSistema = iSistema;

	memcpy(cArgvIN1, &parametros, sizeof(parametros));

	nombreArchivo("GN0105", cDll, DIRECTORIO_GN);

	CargarDLL dll(cDll, "GN0105", cArgvIN1, cArgvIN2, cArgvOUT1, cArgvOUT2);

	if (dll.getResultado() == 1)
	{
		importe = atol(cArgvOUT1);
		grabarLog("CDlgCapturarAbono::leerCandidatoPrestamoCCuenta. Exito al ejecutar GN0105.DLL" );
	}
	else
	{
		grabarLog("CDlgCapturarAbono::leerCandidatoPrestamoCCuenta. Estado diferente a 1 ");
	}
	return importe;
}

//***** 6267707 Cajas/Legado no hay registro en tdcheques ni en SOA *****
//Metodos modificados y agregados para realizar el reverso de cobro por tarjeta cuando
//se presenta error en el abono
void CDlgCapturarAbono::limpiarFolioRezagado(bool bTipoEjecucion)
{
	char sSql [3000] = "";
	char sSqlCondicion [3000] = "";
	char cMensajeSeguimiento[100] = {0};
	__int64 sesionTemp = 0;
	CString sCliente= "";
	char cSql[3000] = { 0 };
	char cEstadoError[4] = "S01";
	char cEstadoErrorRecupera[4] = "";
	int iNumeroRegistros = 0; 
	int iMesajeExiteCobro = 1;

	grabarLog ( "**-Grabar TDCHEQUES registro negativo funcion limpiarFolioRezagado");

   sprintf (cMensajeSeguimiento,"Caja: %d ",m_grid.iCaja);
   grabarLog ( cMensajeSeguimiento );
   sprintf ( cMensajeSeguimiento,"Sistema: %d ",m_grid.iSistema);
   grabarLog ( cMensajeSeguimiento );

   sprintf(sSql, "SELECT factura AS factura_temp, sesion AS sesion_temp, monto AS monto_temp, banco AS banco_temp, localforaneo AS localforaneo_temp, numerocheque AS numerocheque_temp, codautorizacionbanco AS codautorizacionbanco_temp,  tipotarjeta AS tipotarjeta_temp, idu_banco AS idu_banco_temp, cliente AS cliente_temp FROM muFacturaSesiontmp   WHERE   ((cargo_soap = 1 AND cargo_estado = '000' AND cargo_transaccion = '00') OR (recupera_soap = 1 AND recupera_estado = '000' AND recupera_transaccion = '00')) AND caja = %d ORDER BY sesion;", m_grid.iCaja);	
   grabarLog(sSql);
   
	CConsultaFacturaSesionTemp consulta(&odbc);
	
	if (consulta.Exec(sSql)) {
		grabarLog("Entra a if 1");

		consulta.activarCols();

		grabarLog("Entra activar cols");

		while (consulta.leer())
		{
			grabarLog("Entra a while 1");

			if (consulta.sesion_temp>0) {
				
				grabarLog("Entra a if 2");

				sesionTemp =  consulta.sesion_temp;
				sprintf(sSql, "SELECT  COUNT(transaccionnumero) AS captura FROM (SELECT transaccionnumero FROM tdCheques WHERE transaccionnumero = %I64d UNION SELECT transaccionnumero FROM tdchequeshistorial WHERE transaccionnumero = %I64d ) AS tabla", sesionTemp, sesionTemp);

				grabarLog(sSql);

				CConsultatdchequesesion consultaTdCheques(&odbc);
					if (consultaTdCheques.Exec(sSql)) {
						
						grabarLog("Entra a if 3");

						consultaTdCheques.activarCols();
						if (consultaTdCheques.leer()) {

							grabarLog("Entra a if 4");

							if (consultaTdCheques.captura == 0) {

								grabarLog("Entra a if 5");

								if (iMesajeExiteCobro==1) {
                                  grabarLog("Entra a if 6");

								  AfxMessageBox("ES NECESARIO QUE PASES A CANCELAR EL O LOS VOUCHERS A CONSULTAR/CANCELAR PAGO CON TARJETAS", MB_ICONERROR); 
								  iMesajeExiteCobro=2;
								}
								
								sCliente.Format("%d",consulta.cliente_temp);
								sprintf(cMensajeSeguimiento,"Cliente: %ld",sCliente);
                                grabarLog(cMensajeSeguimiento);

								sprintf(cSql, "SELECT fun_proceso_tdcheques04('%d','%d','%d','%d','%s','%d','%s','%s','%ld','%d','%I64d','%d','%s','%I64d','%d','%s','0','0','%d','%d');", 
								1, m_grid.iSistema, m_grid.iCaja,2, sCliente, consulta.monto_temp, consulta.banco_temp,consulta.localforaneo_temp, m_grid.lEmpleado, 0,consulta.numerocheque_temp,0,consulta.codautorizacionbanco_temp,
								consulta.sesion_temp, consulta.factura_temp * -1,consulta.tipotarjeta_temp,consulta.idu_banco_temp,0);
								grabarLog(cSql);

								CMaximo actualizaTdCheque(&odbc);
								if (actualizaTdCheque.Exec(cSql)) {
									sprintf( cMensajeSeguimiento, "Se almacenan los datos en la tdCheques donde si existe número de sesion  %I64d  " , consulta.sesion_temp);
									grabarLog(cMensajeSeguimiento);
								}
								else {
									sprintf( cMensajeSeguimiento, "Error en almacenar los datos en la tdCheques donde si existe número de sesion  %I64d  " , consulta.sesion_temp);
									grabarLog(cMensajeSeguimiento);
								}
						} 
					}
				}
			}
		}
	}
	grabarLog ( "**-Termina TDCHEQUES registro negativo funcion limpiarFolioRezagado");
	
}

void CDlgCapturarAbono::eliminarRegistroTemporalSesionTarjetaIniciarProcesoFacturacion()
{
    CString sSql = "";
    char cMensajeSeguimiento[100] = {0};
	char msgbuferror[2000];
	
	strcpy(msgbuferror, "Insert into his_respuestapagotarjeta ");
	strcat(msgbuferror, "(factura,sesion,monto,banco,localforaneo,numerocheque," );
	strcat(msgbuferror, " codautorizacionbanco,tipotarjeta,idu_banco,cargo_soap,cargo_estado," );
	strcat(msgbuferror, " cargo_transaccion,cargo_mensaje,recupera_soap,recupera_estado,recupera_transaccion,recupera_mensaje, caja, cliente, recuperacargo, area, clavemovimiento, dllactivo)");
	strcat(msgbuferror, " Select factura,sesion,monto,banco,localforaneo,numerocheque, ");
	strcat(msgbuferror, " codautorizacionbanco,tipotarjeta,idu_banco,cargo_soap,cargo_estado, ");
	strcat(msgbuferror, " cargo_transaccion,cargo_mensaje,recupera_soap,recupera_estado,recupera_transaccion,recupera_mensaje, caja, cliente, recuperacargo, area, clavemovimiento, dllactivo ");
	strcat(msgbuferror, " From muFacturaSesiontmp WHERE caja = %d;"); 

    sSql.Format( msgbuferror, m_grid.iCaja);
    CMaximo respaldoTarjeta(&odbc);
    if (respaldoTarjeta.Exec(sSql)) {
        grabarLog ( "***** CI 6267707 *****" );
        sprintf ( cMensajeSeguimiento,"Se respalda los datos del pago con tarjeta al iniciar proceso de facturacion caja %d ", m_grid.iCaja);
        grabarLog (cMensajeSeguimiento );
        grabarLog ( "***** CI 6267707 *****");
	}
	else {
        grabarLog ( "***** CI 6267707 *****");
        sprintf ( cMensajeSeguimiento,"No se realizo el respaldo de datos del pago con tarjeta al iniciar proceso de facturacion caja %d  ", m_grid.iCaja);
        grabarLog (cMensajeSeguimiento);
        grabarLog ( "***** CI 6267707 *****");
	}

    sSql.Format("DELETE FROM muFacturaSesiontmp WHERE caja = %d;", m_grid.iCaja);
    CMaximo consulta(&odbc);
    if (consulta.Exec(sSql)) {
        grabarLog ( "***** CI 6267707 *****");
        sprintf ( cMensajeSeguimiento,"Se elimino la sesion de tarjeta en temporal al iniciar proceso de facturacion caja %d ", m_grid.iCaja);
        grabarLog (cMensajeSeguimiento );
        grabarLog ( "***** CI 6267707 *****");
    }
    else {
        grabarLog ( "***** CI 6267707 *****");
        sprintf ( cMensajeSeguimiento,"No se elimino la sesion de tarjeta en temporal al iniciar proceso de facturacion caja %d  ", m_grid.iCaja);
        grabarLog (cMensajeSeguimiento);
        grabarLog ( "***** CI 6267707 *****");
    }
	
}
//**** 6267707 Cajas/Legado no hay registro en tdcheques ni en SOA *****

// TEMPAPSESTRATCOB005 - Valida si es candidato a sana tu deuda y muestra el mensaje.
void CDlgCapturarAbono::ValidarClienteSanaTuDeuda()
{
	grabarLog("Inicio - ValidarClienteSanaTuDeuda()");
	bool bMostrarMensaje = false;
	char cLog[1024] = { 0 };

	if (sprintf_s(cLog, "Flag iFlagSanaTuDeuda [%d]", iFlagSanaTuDeuda)) { ; }
	grabarLog(cLog);

	if (iFlagSanaTuDeuda != 1)
	{
		grabarLog("Flag para validación de cliente candidato a Sana Tu Deuda apagada.");
		return;
	}

	if (!obtenerurlService(URL_WSSANATUDEUDA, cUrlSanaTuDeuda))
	{
		grabarLog("Error al consultar el url tipo URL_WSSANATUDEUDA.");
		return;
	}

	char mensajeSanaTuDeuda[1024] = { 0 };
	if (sprintf_s(cLog, "urlSanaTuDeuda: %s", cUrlSanaTuDeuda)) { ; }
	grabarLog(cLog);

	sParametrosSanaTuDeuda.bEsClienteZ = iFlagDespliegaDatosZ == 1;
	sParametrosSanaTuDeuda.bExisteCuentaSolex = bExisteCuentaSolex;
	sParametrosSanaTuDeuda.sUrl = CString(cUrlSanaTuDeuda).Trim();
	sParametrosSanaTuDeuda.lNumeroCliente = m_grid.lCliente;
	apiSanaTuDeuda.SetData(sParametrosSanaTuDeuda);

	if (!apiSanaTuDeuda.GetApiSanaTuDeuda())
	{
		grabarLog("ApiSanaTuDeuda: El cliente no es candidato.");
		grabarLog("Fin - ValidarClienteSanaTuDeuda()");
		return;
	}

	if (bExisteCuentaSolex && iFlagDespliegaDatosZ != 1)
	{
		grabarLog("Se consulta el mensaje para candidatos con cuentas SOLEX.");
		consultarMensaje(MENSAJE_CUENTA_SOLEX, mensajeSanaTuDeuda);
	}
	else if (iFlagDespliegaDatosZ == 1)
	{
		grabarLog("Se consulta el mensaje para candidatos con puntualidad Z.");
		consultarMensaje(MENSAJE_CLIENTE_Z, mensajeSanaTuDeuda);
	}

	if (sprintf_s(cLog, "mensajeSanaTuDeuda: %s", mensajeSanaTuDeuda)) { ; }
	grabarLog(cLog);

	AfxMessageBox(mensajeSanaTuDeuda, MB_ICONASTERISK);

	grabarLog("Fin - ValidarClienteSanaTuDeuda()");
}